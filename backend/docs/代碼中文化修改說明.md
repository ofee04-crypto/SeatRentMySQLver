# 工單模組代碼中文化修改說明

## 📋 修改檔案清單

### 1. 共用配置層（單一真實來源）

- **`src/composables/maintenance/useTicketConfig.js`**
  - ✅ 新增 `resultConfig`（結案結果映射）
  - ✅ 新增 `getResultText(code)` getter
  - ✅ 新增 `getResultIcon(code)` getter
  - ✅ 將新函數加入 `useTicketConfig()` export

### 2. 工單歷程元件（Timeline）

- **`src/components/maintenance/TicketTimeline.vue`**
  - ✅ 引入 `getPriorityText`, `getStatusText`, `getResultText`
  - ✅ 新增 `formatLogComment(comment)` 函數
  - ✅ 套用 regex 替換：優先權/狀態/結果代碼 → 中文
  - ✅ 模板使用 `{{ formatLogComment(log.comment) }}`

### 3. 工單列表頁（List）

- **`src/views/maintenance/MtifList.vue`**
  - ✅ 引入所有 getter（包含 `getResultText`, `getResultIcon`）
  - ✅ `getEditTooltip()` 使用 `getStatusText()` 取代物件索引
  - ✅ `viewTicketDetail()` 使用 getter 取代 `priorityText[code]`
  - ✅ `submitResolve()` 使用共用 `resultConfig` 取代 inline 物件
  - ✅ Resolve Dialog 使用 `v-for="(config, key) in resultConfig"`

### 4. 工單表單頁（Form）

- **`src/views/maintenance/MtifForm.vue`**
  - ✅ 已使用 `priorityConfig` 顯示中文（無需修改）
  - ✅ v-model 綁定英文代碼（NORMAL/HIGH...），顯示用 config.text

---

## 🔍 關鍵 Diff（核心修改）

### A) useTicketConfig.js - 新增結案結果映射

```javascript
// ==================== 結案結果配置 ====================
export const resultConfig = {
  NO_ISSUE: {
    text: '未發現問題',
    icon: '✔️',
    color: '#909399',
    desc: '檢查後未發現異常',
  },
  FIXED: {
    text: '已修復',
    icon: '✅',
    color: '#67c23a',
    desc: '問題已成功修復',
  },
  REPLACED: {
    text: '已更換',
    icon: '🔄',
    color: '#409eff',
    desc: '已更換損壞零件',
  },
  NOT_FIXABLE: {
    text: '無法修復',
    icon: '❌',
    color: '#f56c6c',
    desc: '問題無法修復，需更換設備',
  },
  OTHER: {
    text: '其他',
    icon: '📋',
    color: '#e6a23c',
    desc: '其他情況',
  },
}

// 新增 getter
export const getResultText = (resultType) => {
  if (!resultType) return '-'
  return resultConfig[resultType]?.text || resultType
}

export const getResultIcon = (resultType) => {
  return resultConfig[resultType]?.icon || '❓'
}

// 更新 useTicketConfig hook
export function useTicketConfig() {
  return {
    priorityConfig,
    statusConfig,
    resultConfig, // ← 新增
    issueTypeOptions,
    getPriorityTag,
    getStatusTag,
    getPriorityText,
    getStatusText,
    getPriorityIcon,
    getStatusIcon,
    getResultText, // ← 新增
    getResultIcon, // ← 新增
  }
}
```

---

### B) TicketTimeline.vue - 新增格式化函數

```vue
<script setup>
import {
  getPriorityText,
  getStatusText,
  getResultText,
} from '@/composables/maintenance/useTicketConfig'

/**
 * 格式化歷程 comment，將代碼轉換為中文
 */
const formatLogComment = (comment) => {
  if (!comment) return '-'

  let formatted = comment

  // 替換「優先權: CODE」為「優先權: 中文」
  formatted = formatted.replace(/優先權:\s*([A-Z_]+)/g, (match, code) => {
    return `優先權: ${getPriorityText(code)}`
  })

  // 替換「狀態: CODE」為「狀態: 中文」
  formatted = formatted.replace(/狀態:\s*([A-Z_]+)/g, (match, code) => {
    return `狀態: ${getStatusText(code)}`
  })

  // 替換「結果: CODE」為「結果: 中文」
  formatted = formatted.replace(/結果:\s*([A-Z_]+)/g, (match, code) => {
    return `結果: ${getResultText(code)}`
  })

  return formatted
}
</script>

<template>
  <!-- 使用格式化函數 -->
  <div v-if="log.comment" class="comment">
    <i class="fas fa-comment-dots"></i>
    {{ formatLogComment(log.comment) }}
  </div>
</template>
```

**測試範例：**

- 輸入：`"建立工單 | 類型: 椅子損壞 | 優先權: NORMAL"`
- 輸出：`"建立工單 | 類型: 椅子損壞 | 優先權: 普通"`

---

### C) MtifList.vue - 套用共用 getter

```vue
<script setup>
// 引入所有 getter
const {
  priorityConfig,
  statusConfig,
  resultConfig,
  getPriorityTag,
  getStatusTag,
  getPriorityText,
  getStatusText,
  getPriorityIcon,
  getStatusIcon,
  getResultText,
  getResultIcon
} = useTicketConfig()

// 修改 1: getEditTooltip 使用 getter
const getEditTooltip = (row) => {
  if (canEdit(row)) {
    return '編輯工單'
  }
  const statusName = getStatusText(row.issueStatus)  // ← 使用 getter
  return `狀態為「${statusName}」不可編輯（僅 REPORTED/ASSIGNED 可編輯）`
}

// 修改 2: viewTicketDetail 使用 getter
const viewTicketDetail = (row) => {
  Swal.fire({
    html: `
      <p style="margin: 0; font-size: 20px;">
        ${getPriorityIcon(row.issuePriority)} ${getPriorityText(row.issuePriority)}
      </p>
      <p style="margin: 0; font-size: 20px;">
        ${getStatusIcon(row.issueStatus)} ${getStatusText(row.issueStatus)}
      </p>
    `
  })
}

// 修改 3: submitResolve 使用共用 resultConfig
const submitResolve = async () => {
  // 移除 inline 的 resultConfig 物件定義
  const config = resultConfig[resolveForm.resultType]  // ← 使用共用
  await Swal.fire({
    html: `<p>結案結果：<b>${config.text}</b></p>`
  })
}
</script>

<template>
  <!-- 修改 4: Resolve Dialog 使用共用 resultConfig -->
  <el-form-item label="維修結果">
    <div class="result-cards">
      <div
        v-for="(config, key) in resultConfig"  <!-- ← 使用共用 -->
        :key="key"
        class="result-card"
        @click="resolveForm.resultType = key"
      >
        <span class="result-icon">{{ config.icon }}</span>
        <span class="result-text">{{ config.text }}</span>
      </div>
    </div>
  </el-form-item>
</template>
```

---

## ✅ 手動測試流程

### 測試 1：工單列表 - 優先權/狀態顯示中文

1. 開啟瀏覽器 → 前往 `/admin/mtif-list`
2. 檢查列表欄位：
   - ✅ 優先級欄位顯示：`🟢 普通` / `🔴 緊急` 等中文
   - ✅ 狀態欄位顯示：`📋 已通報` / `🔧 維修中` 等中文
3. 開啟瀏覽器 DevTools → Network
4. 確認 API response 仍回傳英文代碼：`issuePriority: "NORMAL"`, `issueStatus: "REPORTED"`

**預期結果：**

- 畫面顯示中文
- Network payload 顯示英文代碼

---

### 測試 2：工單詳情彈窗 - 中文顯示

1. 在列表點擊「查看詳情」按鈕（眼睛圖示）
2. 檢查 SweetAlert 彈窗內容：
   - ✅ 優先級區塊：`🟠 高優先` （不是 HIGH）
   - ✅ 狀態區塊：`✅ 已完成` （不是 RESOLVED）

**預期結果：**

- 彈窗內所有代碼欄位顯示中文

---

### 測試 3：工單歷程 - comment 代碼轉中文

1. 在列表點擊「查看歷程」按鈕（時鐘圖示）
2. 檢查 Timeline 內容：
   - ✅ 原始 comment: `"優先權: NORMAL"` → 顯示為 `"優先權: 普通"`
   - ✅ 原始 comment: `"結果: NO_ISSUE"` → 顯示為 `"結果: 未發現問題"`
   - ✅ 原始 comment: `"狀態: UNDER_MAINTENANCE"` → 顯示為 `"狀態: 維修中"`
3. 開啟 DevTools → Network → 查看 `/api/maintenance/tickets/{id}/logs`
4. 確認 API response 的 comment 欄位仍是原始英文代碼

**預期結果：**

- 畫面顯示中文
- API 回傳原始英文代碼

---

### 測試 4：結案對話框 - 結果選項中文

1. 在列表找到「維修中」的工單 → 點擊「結案」按鈕（綠色打勾）
2. 檢查結案對話框：
   - ✅ 結果選項顯示：`✅ 已修復` / `❌ 無法修復` / `✔️ 未發現問題` / `📋 其他`
3. 選擇任一結果 → 點擊「確認結案」
4. 開啟 DevTools → Network → 查看 PATCH request body
5. 確認送出 payload 為：`resultType: "FIXED"` （英文代碼）

**預期結果：**

- 對話框顯示中文選項
- API 送出英文代碼

---

### 測試 5：新增工單表單 - 優先級中文

1. 前往 `/admin/mtif-form` （新增工單）
2. 檢查「優先級」區塊：
   - ✅ 四個卡片顯示：`🔵 低優先` / `🟢 普通` / `🟠 高優先` / `🔴 緊急`
3. 選擇「緊急」→ 填寫其他欄位 → 點擊「送出」
4. 開啟 DevTools → Network → 查看 POST request body
5. 確認送出 payload 為：`issuePriority: "URGENT"` （英文代碼）

**預期結果：**

- 表單顯示中文選項
- API 送出英文代碼

---

### 測試 6：編輯按鈕 Tooltip - 狀態中文

1. 在列表找到「已完成」或「維修中」的工單
2. 將滑鼠移到「編輯」按鈕上方（應為 disabled 狀態）
3. 檢查 Tooltip 文字：
   - ✅ `「狀態為「已完成」不可編輯（僅 REPORTED/ASSIGNED 可編輯）」`
   - ❌ 不應顯示：`「狀態為「RESOLVED」不可編輯」`

**預期結果：**

- Tooltip 顯示中文狀態名稱

---

## 🔒 安全檢查（驗證未破壞原有功能）

### ✅ 後端完全不變

- DB schema 無修改
- API endpoint 無修改
- API request/response 格式無修改
- 所有欄位值仍為英文代碼（NORMAL、FIXED...）

### ✅ 前端向後相容

- 保留原有 `priorityText` / `statusText` 變數（供模板使用）
- 新增 getter 為額外選項，未移除舊有訪問方式
- 未知代碼會降級顯示原始值（不會報錯）

### ✅ 未引入新套件

- 只使用原生 JavaScript String.replace + Regex
- 無額外依賴

---

## 🎯 驗收標準（全部通過 = 成功）

| #   | 驗收項目          | 測試方法                           | 通過標準                        |
| --- | ----------------- | ---------------------------------- | ------------------------------- |
| 1   | 列表優先權中文    | 查看列表 Priority tag              | 顯示「普通」「緊急」不是 NORMAL |
| 2   | 列表狀態中文      | 查看列表 Status tag                | 顯示「已通報」不是 REPORTED     |
| 3   | 詳情彈窗中文      | 點擊「查看詳情」                   | 彈窗內顯示中文                  |
| 4   | 歷程 comment 中文 | 點擊「查看歷程」                   | Timeline 顯示「優先權: 普通」   |
| 5   | 結案結果中文      | 開啟結案對話框                     | 選項顯示「已修復」「無法修復」  |
| 6   | 表單優先級中文    | 新增工單頁面                       | 卡片顯示中文                    |
| 7   | Tooltip 狀態中文  | 滑鼠移到 disabled 編輯按鈕         | Tooltip 顯示「已完成」          |
| 8   | API 送出英文代碼  | Network tab 檢查 POST/PATCH        | `issuePriority: "URGENT"`       |
| 9   | API 回傳英文代碼  | Network tab 檢查 GET response      | `issueStatus: "RESOLVED"`       |
| 10  | 未知代碼降級      | 手動修改 API response 為 `UNKNOWN` | 顯示 "UNKNOWN" 不報錯           |

---

## 📝 技術細節摘要

### 映射規則

**優先權 (Priority):**

```
LOW    → 低優先
NORMAL → 普通
HIGH   → 高優先
URGENT → 緊急
```

**狀態 (Status):**

```
REPORTED          → 已通報
ASSIGNED          → 已指派
UNDER_MAINTENANCE → 維修中
RESOLVED          → 已完成
CANCELLED         → 已取消
```

**結案結果 (Result):**

```
NO_ISSUE   → 未發現問題
FIXED      → 已修復
REPLACED   → 已更換
NOT_FIXABLE → 無法修復
OTHER      → 其他
```

### Regex 說明

```javascript
// 匹配「優先權: <英文代碼>」模式
;/優先權:\s*([A-Z_]+)/g

// [A-Z_]+ = 大寫字母或底線組成的代碼
// \s* = 允許冒號後有空格
// () = 捕獲 CODE 部分用於替換
```

### 降級策略

```javascript
// 若代碼不在 config 中，回傳原始代碼
getPriorityText(code) {
  return priorityConfig[code]?.text || code  // ← 安全降級
}
```

---

## ✨ 完成狀態

- ✅ 所有檔案修改完成
- ✅ 編譯無錯誤（僅有未使用變數警告，可忽略）
- ✅ 代碼審查通過
- ⏳ 待用戶進行手動測試驗證

---

**修改日期：** 2026-01-19  
**修改人員：** GitHub Copilot  
**影響範圍：** 前端工單模組顯示層（不影響後端與 DB）
