This file is a merged representation of a subset of the codebase, containing specifically included files and files not matching ignore patterns, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Only files matching these patterns are included: backend/**, backend/pom.xml
- Files matching these patterns are excluded: **/*.map, **/*.min.js, **/*.min.css, **/node_modules/**, **/dist/**, **/target/**, **/vendor/**, **/public/vendor/**, **/logs/**, **/*.log, **/*.svg, **/*.png, **/*.jpg, **/*.ico, AI_good/**, backend/db/**
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
backend/.gitattributes
backend/.mvn/wrapper/maven-wrapper.properties
backend/docs/ä»£ç¢¼ä¸­æ–‡åŒ–ä¿®æ”¹èªªæ˜.md
backend/docs/åœ–ç‰‡é™„ä»¶åŠŸèƒ½èªªæ˜.md
backend/docs/AI_CONTEXT.md
backend/docs/COZE_BOOTSTRAP_TEST.md
backend/docs/COZE_INTEGRATION_REPORT.md
backend/docs/COZE_README.md
backend/docs/COZE_SDK_SETUP.md
backend/docs/COZE_TESTING_GUIDE.md
backend/docs/COZE_TROUBLESHOOTING.md
backend/docs/diagnose-coze.ps1
backend/docs/PROJECT_MAP.md
backend/docs/setup-coze.ps1
backend/docs/test-attachment-api.md
backend/mvnw
backend/mvnw.cmd
backend/pom.xml
backend/src/main/java/com/example/backend/BackendApplication.java
backend/src/main/java/com/example/backend/config/ProjectionValidConfig.java
backend/src/main/java/com/example/backend/config/SecurityConfig.java
backend/src/main/java/com/example/backend/config/WebConfig.java
backend/src/main/java/com/example/backend/controller/game/GameController.java
backend/src/main/java/com/example/backend/controller/maintenance/AssetStatsController.java
backend/src/main/java/com/example/backend/controller/maintenance/MaintenanceController.java
backend/src/main/java/com/example/backend/controller/maintenance/MaintenanceScheduleController.java
backend/src/main/java/com/example/backend/controller/member/AdminController.java
backend/src/main/java/com/example/backend/controller/member/AdminForgotPasswordController.java
backend/src/main/java/com/example/backend/controller/member/AuthController.java
backend/src/main/java/com/example/backend/controller/member/ForgotPasswordController.java
backend/src/main/java/com/example/backend/controller/member/LoginAdminController.java
backend/src/main/java/com/example/backend/controller/member/LoginMemberController.java
backend/src/main/java/com/example/backend/controller/member/MemberController.java
backend/src/main/java/com/example/backend/controller/member/MemberProfileController.java
backend/src/main/java/com/example/backend/controller/merchantAndCoupon/DiscountController.java
backend/src/main/java/com/example/backend/controller/merchantAndCoupon/MerchantController.java
backend/src/main/java/com/example/backend/controller/payment/PaymentApiController.java
backend/src/main/java/com/example/backend/controller/rec/AnalyzeController.java
backend/src/main/java/com/example/backend/controller/rec/RecRentController.java
backend/src/main/java/com/example/backend/controller/rec/RentDetailsController.java
backend/src/main/java/com/example/backend/controller/spot/RentalSpotController.java
backend/src/main/java/com/example/backend/controller/spot/SeatController.java
backend/src/main/java/com/example/backend/controller/support/SupportCozeController.java
backend/src/main/java/com/example/backend/dto/maintenance/AssetStatsResponseDto.java
backend/src/main/java/com/example/backend/dto/maintenance/AttachmentResponseDto.java
backend/src/main/java/com/example/backend/dto/maintenance/MaintenanceLogResponseDto.java
backend/src/main/java/com/example/backend/dto/maintenance/MaintenanceScheduleResponseDto.java
backend/src/main/java/com/example/backend/dto/maintenance/MaintenanceStaffResponseDto.java
backend/src/main/java/com/example/backend/dto/maintenance/SpotOptionDto.java
backend/src/main/java/com/example/backend/dto/rec/DailyOrderCountDTO.java
backend/src/main/java/com/example/backend/dto/rec/HourlyOrderCountDTO.java
backend/src/main/java/com/example/backend/dto/rec/MonthlyOrderCountDTO.java
backend/src/main/java/com/example/backend/dto/rec/OrderStatusStatsDTO.java
backend/src/main/java/com/example/backend/dto/rec/RentalDurationDTO.java
backend/src/main/java/com/example/backend/dto/rec/RentalDurationStatsDTO.java
backend/src/main/java/com/example/backend/dto/RedemptionLogDTO.java
backend/src/main/java/com/example/backend/dto/spot/SeatUpdateRequest.java
backend/src/main/java/com/example/backend/dto/spot/SpotUpdateRequest.java
backend/src/main/java/com/example/backend/dto/support/CozeBootstrapResponseDto.java
backend/src/main/java/com/example/backend/exception/GlobalExceptionHandler.java
backend/src/main/java/com/example/backend/file/FileController.java
backend/src/main/java/com/example/backend/file/FileStorageService.java
backend/src/main/java/com/example/backend/integration/èªªæ˜.txt
backend/src/main/java/com/example/backend/model/maintenance/MaintenanceInformation.java
backend/src/main/java/com/example/backend/model/maintenance/MaintenanceLog.java
backend/src/main/java/com/example/backend/model/maintenance/MaintenanceSchedule.java
backend/src/main/java/com/example/backend/model/maintenance/MaintenanceStaff.java
backend/src/main/java/com/example/backend/model/maintenance/MaintenanceTicketAttachment.java
backend/src/main/java/com/example/backend/model/member/Admin.java
backend/src/main/java/com/example/backend/model/member/Member.java
backend/src/main/java/com/example/backend/model/merchantAndCoupon/DiscountBean.java
backend/src/main/java/com/example/backend/model/merchantAndCoupon/MerchantBean.java
backend/src/main/java/com/example/backend/model/merchantAndCoupon/RedemptionLog.java
backend/src/main/java/com/example/backend/model/merchantAndCoupon/Result.java
backend/src/main/java/com/example/backend/model/merchantAndCoupon/SponsorshipRecord.java
backend/src/main/java/com/example/backend/model/rec/RecRent.java
backend/src/main/java/com/example/backend/model/rec/RentDetails.java
backend/src/main/java/com/example/backend/model/spot/RentalSpot.java
backend/src/main/java/com/example/backend/model/spot/Seat.java
backend/src/main/java/com/example/backend/repository/maintenance/MaintenanceInformationRepository.java
backend/src/main/java/com/example/backend/repository/maintenance/MaintenanceLogRepository.java
backend/src/main/java/com/example/backend/repository/maintenance/MaintenanceScheduleRepository.java
backend/src/main/java/com/example/backend/repository/maintenance/MaintenanceStaffRepository.java
backend/src/main/java/com/example/backend/repository/maintenance/MaintenanceTicketAttachmentRepository.java
backend/src/main/java/com/example/backend/repository/member/AdminRepository.java
backend/src/main/java/com/example/backend/repository/member/CustomOAuth2UserService.java
backend/src/main/java/com/example/backend/repository/member/MemberRepository.java
backend/src/main/java/com/example/backend/repository/merchantAndCoupon/DiscountRepository.java
backend/src/main/java/com/example/backend/repository/merchantAndCoupon/MerchantRepository.java
backend/src/main/java/com/example/backend/repository/merchantAndCoupon/RedemptionLogRepository.java
backend/src/main/java/com/example/backend/repository/merchantAndCoupon/SponsorshipRepository.java
backend/src/main/java/com/example/backend/repository/projection/AnalyzeProjections.java
backend/src/main/java/com/example/backend/repository/projection/readme.txt
backend/src/main/java/com/example/backend/repository/rec/RecRentAnalyzeRepository.java
backend/src/main/java/com/example/backend/repository/rec/RecRentRepository.java
backend/src/main/java/com/example/backend/repository/rec/RentDetailsRepository.java
backend/src/main/java/com/example/backend/repository/rec/RentDetailsSpecs.java
backend/src/main/java/com/example/backend/repository/spot/RentalSpotRepository.java
backend/src/main/java/com/example/backend/repository/spot/SeatRepository.java
backend/src/main/java/com/example/backend/service/maintenance/AssetStatsService.java
backend/src/main/java/com/example/backend/service/maintenance/AttachmentService.java
backend/src/main/java/com/example/backend/service/maintenance/MaintenanceInformationService.java
backend/src/main/java/com/example/backend/service/maintenance/MaintenanceJobScheduler.java
backend/src/main/java/com/example/backend/service/maintenance/MaintenanceScheduleService.java
backend/src/main/java/com/example/backend/service/maintenance/MaintenanceStaffService.java
backend/src/main/java/com/example/backend/service/member/AdminService.java
backend/src/main/java/com/example/backend/service/member/MemberService.java
backend/src/main/java/com/example/backend/service/merchantAndCoupon/DiscountService.java
backend/src/main/java/com/example/backend/service/merchantAndCoupon/MerchantService.java
backend/src/main/java/com/example/backend/service/merchantAndCoupon/PaymentService.java
backend/src/main/java/com/example/backend/service/merchantAndCoupon/RedemptionService.java
backend/src/main/java/com/example/backend/service/rec/AnalyzeService.java
backend/src/main/java/com/example/backend/service/rec/RecDetailMgnService.java
backend/src/main/java/com/example/backend/service/rec/RecDetailUserService.java
backend/src/main/java/com/example/backend/service/spot/IRentalSpotService.java
backend/src/main/java/com/example/backend/service/spot/ISeatService.java
backend/src/main/java/com/example/backend/service/spot/RentalSpotService.java
backend/src/main/java/com/example/backend/service/spot/SeatService.java
backend/src/main/java/com/example/backend/utils/DbPrintRunner.java
backend/src/main/java/com/example/backend/utils/EcpayUtils.java
backend/src/main/java/com/example/backend/utils/HibernateUtil.java
backend/src/main/resources/application.properties
backend/src/main/resources/application.yml
backend/src/test/java/com/example/backend/BackendApplicationTests.java
backend/src/test/java/com/example/backend/DbSmokeTest.java
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="backend/.gitattributes">
/mvnw text eol=lf
*.cmd text eol=crlf
</file>

<file path="backend/.mvn/wrapper/maven-wrapper.properties">
wrapperVersion=3.3.4
distributionType=only-script
distributionUrl=https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/3.9.11/apache-maven-3.9.11-bin.zip
</file>

<file path="backend/docs/ä»£ç¢¼ä¸­æ–‡åŒ–ä¿®æ”¹èªªæ˜.md">
# å·¥å–®æ¨¡çµ„ä»£ç¢¼ä¸­æ–‡åŒ–ä¿®æ”¹èªªæ˜

## ğŸ“‹ ä¿®æ”¹æª”æ¡ˆæ¸…å–®

### 1. å…±ç”¨é…ç½®å±¤ï¼ˆå–®ä¸€çœŸå¯¦ä¾†æºï¼‰

- **`src/composables/maintenance/useTicketConfig.js`**
  - âœ… æ–°å¢ `resultConfig`ï¼ˆçµæ¡ˆçµæœæ˜ å°„ï¼‰
  - âœ… æ–°å¢ `getResultText(code)` getter
  - âœ… æ–°å¢ `getResultIcon(code)` getter
  - âœ… å°‡æ–°å‡½æ•¸åŠ å…¥ `useTicketConfig()` export

### 2. å·¥å–®æ­·ç¨‹å…ƒä»¶ï¼ˆTimelineï¼‰

- **`src/components/maintenance/TicketTimeline.vue`**
  - âœ… å¼•å…¥ `getPriorityText`, `getStatusText`, `getResultText`
  - âœ… æ–°å¢ `formatLogComment(comment)` å‡½æ•¸
  - âœ… å¥—ç”¨ regex æ›¿æ›ï¼šå„ªå…ˆæ¬Š/ç‹€æ…‹/çµæœä»£ç¢¼ â†’ ä¸­æ–‡
  - âœ… æ¨¡æ¿ä½¿ç”¨ `{{ formatLogComment(log.comment) }}`

### 3. å·¥å–®åˆ—è¡¨é ï¼ˆListï¼‰

- **`src/views/maintenance/MtifList.vue`**
  - âœ… å¼•å…¥æ‰€æœ‰ getterï¼ˆåŒ…å« `getResultText`, `getResultIcon`ï¼‰
  - âœ… `getEditTooltip()` ä½¿ç”¨ `getStatusText()` å–ä»£ç‰©ä»¶ç´¢å¼•
  - âœ… `viewTicketDetail()` ä½¿ç”¨ getter å–ä»£ `priorityText[code]`
  - âœ… `submitResolve()` ä½¿ç”¨å…±ç”¨ `resultConfig` å–ä»£ inline ç‰©ä»¶
  - âœ… Resolve Dialog ä½¿ç”¨ `v-for="(config, key) in resultConfig"`

### 4. å·¥å–®è¡¨å–®é ï¼ˆFormï¼‰

- **`src/views/maintenance/MtifForm.vue`**
  - âœ… å·²ä½¿ç”¨ `priorityConfig` é¡¯ç¤ºä¸­æ–‡ï¼ˆç„¡éœ€ä¿®æ”¹ï¼‰
  - âœ… v-model ç¶å®šè‹±æ–‡ä»£ç¢¼ï¼ˆNORMAL/HIGH...ï¼‰ï¼Œé¡¯ç¤ºç”¨ config.text

---

## ğŸ” é—œéµ Diffï¼ˆæ ¸å¿ƒä¿®æ”¹ï¼‰

### A) useTicketConfig.js - æ–°å¢çµæ¡ˆçµæœæ˜ å°„

```javascript
// ==================== çµæ¡ˆçµæœé…ç½® ====================
export const resultConfig = {
  NO_ISSUE: {
    text: 'æœªç™¼ç¾å•é¡Œ',
    icon: 'âœ”ï¸',
    color: '#909399',
    desc: 'æª¢æŸ¥å¾Œæœªç™¼ç¾ç•°å¸¸',
  },
  FIXED: {
    text: 'å·²ä¿®å¾©',
    icon: 'âœ…',
    color: '#67c23a',
    desc: 'å•é¡Œå·²æˆåŠŸä¿®å¾©',
  },
  REPLACED: {
    text: 'å·²æ›´æ›',
    icon: 'ğŸ”„',
    color: '#409eff',
    desc: 'å·²æ›´æ›æå£é›¶ä»¶',
  },
  NOT_FIXABLE: {
    text: 'ç„¡æ³•ä¿®å¾©',
    icon: 'âŒ',
    color: '#f56c6c',
    desc: 'å•é¡Œç„¡æ³•ä¿®å¾©ï¼Œéœ€æ›´æ›è¨­å‚™',
  },
  OTHER: {
    text: 'å…¶ä»–',
    icon: 'ğŸ“‹',
    color: '#e6a23c',
    desc: 'å…¶ä»–æƒ…æ³',
  },
}

// æ–°å¢ getter
export const getResultText = (resultType) => {
  if (!resultType) return '-'
  return resultConfig[resultType]?.text || resultType
}

export const getResultIcon = (resultType) => {
  return resultConfig[resultType]?.icon || 'â“'
}

// æ›´æ–° useTicketConfig hook
export function useTicketConfig() {
  return {
    priorityConfig,
    statusConfig,
    resultConfig, // â† æ–°å¢
    issueTypeOptions,
    getPriorityTag,
    getStatusTag,
    getPriorityText,
    getStatusText,
    getPriorityIcon,
    getStatusIcon,
    getResultText, // â† æ–°å¢
    getResultIcon, // â† æ–°å¢
  }
}
```

---

### B) TicketTimeline.vue - æ–°å¢æ ¼å¼åŒ–å‡½æ•¸

```vue
<script setup>
import {
  getPriorityText,
  getStatusText,
  getResultText,
} from '@/composables/maintenance/useTicketConfig'

/**
 * æ ¼å¼åŒ–æ­·ç¨‹ commentï¼Œå°‡ä»£ç¢¼è½‰æ›ç‚ºä¸­æ–‡
 */
const formatLogComment = (comment) => {
  if (!comment) return '-'

  let formatted = comment

  // æ›¿æ›ã€Œå„ªå…ˆæ¬Š: CODEã€ç‚ºã€Œå„ªå…ˆæ¬Š: ä¸­æ–‡ã€
  formatted = formatted.replace(/å„ªå…ˆæ¬Š:\s*([A-Z_]+)/g, (match, code) => {
    return `å„ªå…ˆæ¬Š: ${getPriorityText(code)}`
  })

  // æ›¿æ›ã€Œç‹€æ…‹: CODEã€ç‚ºã€Œç‹€æ…‹: ä¸­æ–‡ã€
  formatted = formatted.replace(/ç‹€æ…‹:\s*([A-Z_]+)/g, (match, code) => {
    return `ç‹€æ…‹: ${getStatusText(code)}`
  })

  // æ›¿æ›ã€Œçµæœ: CODEã€ç‚ºã€Œçµæœ: ä¸­æ–‡ã€
  formatted = formatted.replace(/çµæœ:\s*([A-Z_]+)/g, (match, code) => {
    return `çµæœ: ${getResultText(code)}`
  })

  return formatted
}
</script>

<template>
  <!-- ä½¿ç”¨æ ¼å¼åŒ–å‡½æ•¸ -->
  <div v-if="log.comment" class="comment">
    <i class="fas fa-comment-dots"></i>
    {{ formatLogComment(log.comment) }}
  </div>
</template>
```

**æ¸¬è©¦ç¯„ä¾‹ï¼š**

- è¼¸å…¥ï¼š`"å»ºç«‹å·¥å–® | é¡å‹: æ¤…å­æå£ | å„ªå…ˆæ¬Š: NORMAL"`
- è¼¸å‡ºï¼š`"å»ºç«‹å·¥å–® | é¡å‹: æ¤…å­æå£ | å„ªå…ˆæ¬Š: æ™®é€š"`

---

### C) MtifList.vue - å¥—ç”¨å…±ç”¨ getter

```vue
<script setup>
// å¼•å…¥æ‰€æœ‰ getter
const {
  priorityConfig,
  statusConfig,
  resultConfig,
  getPriorityTag,
  getStatusTag,
  getPriorityText,
  getStatusText,
  getPriorityIcon,
  getStatusIcon,
  getResultText,
  getResultIcon
} = useTicketConfig()

// ä¿®æ”¹ 1: getEditTooltip ä½¿ç”¨ getter
const getEditTooltip = (row) => {
  if (canEdit(row)) {
    return 'ç·¨è¼¯å·¥å–®'
  }
  const statusName = getStatusText(row.issueStatus)  // â† ä½¿ç”¨ getter
  return `ç‹€æ…‹ç‚ºã€Œ${statusName}ã€ä¸å¯ç·¨è¼¯ï¼ˆåƒ… REPORTED/ASSIGNED å¯ç·¨è¼¯ï¼‰`
}

// ä¿®æ”¹ 2: viewTicketDetail ä½¿ç”¨ getter
const viewTicketDetail = (row) => {
  Swal.fire({
    html: `
      <p style="margin: 0; font-size: 20px;">
        ${getPriorityIcon(row.issuePriority)} ${getPriorityText(row.issuePriority)}
      </p>
      <p style="margin: 0; font-size: 20px;">
        ${getStatusIcon(row.issueStatus)} ${getStatusText(row.issueStatus)}
      </p>
    `
  })
}

// ä¿®æ”¹ 3: submitResolve ä½¿ç”¨å…±ç”¨ resultConfig
const submitResolve = async () => {
  // ç§»é™¤ inline çš„ resultConfig ç‰©ä»¶å®šç¾©
  const config = resultConfig[resolveForm.resultType]  // â† ä½¿ç”¨å…±ç”¨
  await Swal.fire({
    html: `<p>çµæ¡ˆçµæœï¼š<b>${config.text}</b></p>`
  })
}
</script>

<template>
  <!-- ä¿®æ”¹ 4: Resolve Dialog ä½¿ç”¨å…±ç”¨ resultConfig -->
  <el-form-item label="ç¶­ä¿®çµæœ">
    <div class="result-cards">
      <div
        v-for="(config, key) in resultConfig"  <!-- â† ä½¿ç”¨å…±ç”¨ -->
        :key="key"
        class="result-card"
        @click="resolveForm.resultType = key"
      >
        <span class="result-icon">{{ config.icon }}</span>
        <span class="result-text">{{ config.text }}</span>
      </div>
    </div>
  </el-form-item>
</template>
```

---

## âœ… æ‰‹å‹•æ¸¬è©¦æµç¨‹

### æ¸¬è©¦ 1ï¼šå·¥å–®åˆ—è¡¨ - å„ªå…ˆæ¬Š/ç‹€æ…‹é¡¯ç¤ºä¸­æ–‡

1. é–‹å•Ÿç€è¦½å™¨ â†’ å‰å¾€ `/admin/mtif-list`
2. æª¢æŸ¥åˆ—è¡¨æ¬„ä½ï¼š
   - âœ… å„ªå…ˆç´šæ¬„ä½é¡¯ç¤ºï¼š`ğŸŸ¢ æ™®é€š` / `ğŸ”´ ç·Šæ€¥` ç­‰ä¸­æ–‡
   - âœ… ç‹€æ…‹æ¬„ä½é¡¯ç¤ºï¼š`ğŸ“‹ å·²é€šå ±` / `ğŸ”§ ç¶­ä¿®ä¸­` ç­‰ä¸­æ–‡
3. é–‹å•Ÿç€è¦½å™¨ DevTools â†’ Network
4. ç¢ºèª API response ä»å›å‚³è‹±æ–‡ä»£ç¢¼ï¼š`issuePriority: "NORMAL"`, `issueStatus: "REPORTED"`

**é æœŸçµæœï¼š**

- ç•«é¢é¡¯ç¤ºä¸­æ–‡
- Network payload é¡¯ç¤ºè‹±æ–‡ä»£ç¢¼

---

### æ¸¬è©¦ 2ï¼šå·¥å–®è©³æƒ…å½ˆçª— - ä¸­æ–‡é¡¯ç¤º

1. åœ¨åˆ—è¡¨é»æ“Šã€ŒæŸ¥çœ‹è©³æƒ…ã€æŒ‰éˆ•ï¼ˆçœ¼ç›åœ–ç¤ºï¼‰
2. æª¢æŸ¥ SweetAlert å½ˆçª—å…§å®¹ï¼š
   - âœ… å„ªå…ˆç´šå€å¡Šï¼š`ğŸŸ  é«˜å„ªå…ˆ` ï¼ˆä¸æ˜¯ HIGHï¼‰
   - âœ… ç‹€æ…‹å€å¡Šï¼š`âœ… å·²å®Œæˆ` ï¼ˆä¸æ˜¯ RESOLVEDï¼‰

**é æœŸçµæœï¼š**

- å½ˆçª—å…§æ‰€æœ‰ä»£ç¢¼æ¬„ä½é¡¯ç¤ºä¸­æ–‡

---

### æ¸¬è©¦ 3ï¼šå·¥å–®æ­·ç¨‹ - comment ä»£ç¢¼è½‰ä¸­æ–‡

1. åœ¨åˆ—è¡¨é»æ“Šã€ŒæŸ¥çœ‹æ­·ç¨‹ã€æŒ‰éˆ•ï¼ˆæ™‚é˜åœ–ç¤ºï¼‰
2. æª¢æŸ¥ Timeline å…§å®¹ï¼š
   - âœ… åŸå§‹ comment: `"å„ªå…ˆæ¬Š: NORMAL"` â†’ é¡¯ç¤ºç‚º `"å„ªå…ˆæ¬Š: æ™®é€š"`
   - âœ… åŸå§‹ comment: `"çµæœ: NO_ISSUE"` â†’ é¡¯ç¤ºç‚º `"çµæœ: æœªç™¼ç¾å•é¡Œ"`
   - âœ… åŸå§‹ comment: `"ç‹€æ…‹: UNDER_MAINTENANCE"` â†’ é¡¯ç¤ºç‚º `"ç‹€æ…‹: ç¶­ä¿®ä¸­"`
3. é–‹å•Ÿ DevTools â†’ Network â†’ æŸ¥çœ‹ `/api/maintenance/tickets/{id}/logs`
4. ç¢ºèª API response çš„ comment æ¬„ä½ä»æ˜¯åŸå§‹è‹±æ–‡ä»£ç¢¼

**é æœŸçµæœï¼š**

- ç•«é¢é¡¯ç¤ºä¸­æ–‡
- API å›å‚³åŸå§‹è‹±æ–‡ä»£ç¢¼

---

### æ¸¬è©¦ 4ï¼šçµæ¡ˆå°è©±æ¡† - çµæœé¸é …ä¸­æ–‡

1. åœ¨åˆ—è¡¨æ‰¾åˆ°ã€Œç¶­ä¿®ä¸­ã€çš„å·¥å–® â†’ é»æ“Šã€Œçµæ¡ˆã€æŒ‰éˆ•ï¼ˆç¶ è‰²æ‰“å‹¾ï¼‰
2. æª¢æŸ¥çµæ¡ˆå°è©±æ¡†ï¼š
   - âœ… çµæœé¸é …é¡¯ç¤ºï¼š`âœ… å·²ä¿®å¾©` / `âŒ ç„¡æ³•ä¿®å¾©` / `âœ”ï¸ æœªç™¼ç¾å•é¡Œ` / `ğŸ“‹ å…¶ä»–`
3. é¸æ“‡ä»»ä¸€çµæœ â†’ é»æ“Šã€Œç¢ºèªçµæ¡ˆã€
4. é–‹å•Ÿ DevTools â†’ Network â†’ æŸ¥çœ‹ PATCH request body
5. ç¢ºèªé€å‡º payload ç‚ºï¼š`resultType: "FIXED"` ï¼ˆè‹±æ–‡ä»£ç¢¼ï¼‰

**é æœŸçµæœï¼š**

- å°è©±æ¡†é¡¯ç¤ºä¸­æ–‡é¸é …
- API é€å‡ºè‹±æ–‡ä»£ç¢¼

---

### æ¸¬è©¦ 5ï¼šæ–°å¢å·¥å–®è¡¨å–® - å„ªå…ˆç´šä¸­æ–‡

1. å‰å¾€ `/admin/mtif-form` ï¼ˆæ–°å¢å·¥å–®ï¼‰
2. æª¢æŸ¥ã€Œå„ªå…ˆç´šã€å€å¡Šï¼š
   - âœ… å››å€‹å¡ç‰‡é¡¯ç¤ºï¼š`ğŸ”µ ä½å„ªå…ˆ` / `ğŸŸ¢ æ™®é€š` / `ğŸŸ  é«˜å„ªå…ˆ` / `ğŸ”´ ç·Šæ€¥`
3. é¸æ“‡ã€Œç·Šæ€¥ã€â†’ å¡«å¯«å…¶ä»–æ¬„ä½ â†’ é»æ“Šã€Œé€å‡ºã€
4. é–‹å•Ÿ DevTools â†’ Network â†’ æŸ¥çœ‹ POST request body
5. ç¢ºèªé€å‡º payload ç‚ºï¼š`issuePriority: "URGENT"` ï¼ˆè‹±æ–‡ä»£ç¢¼ï¼‰

**é æœŸçµæœï¼š**

- è¡¨å–®é¡¯ç¤ºä¸­æ–‡é¸é …
- API é€å‡ºè‹±æ–‡ä»£ç¢¼

---

### æ¸¬è©¦ 6ï¼šç·¨è¼¯æŒ‰éˆ• Tooltip - ç‹€æ…‹ä¸­æ–‡

1. åœ¨åˆ—è¡¨æ‰¾åˆ°ã€Œå·²å®Œæˆã€æˆ–ã€Œç¶­ä¿®ä¸­ã€çš„å·¥å–®
2. å°‡æ»‘é¼ ç§»åˆ°ã€Œç·¨è¼¯ã€æŒ‰éˆ•ä¸Šæ–¹ï¼ˆæ‡‰ç‚º disabled ç‹€æ…‹ï¼‰
3. æª¢æŸ¥ Tooltip æ–‡å­—ï¼š
   - âœ… `ã€Œç‹€æ…‹ç‚ºã€Œå·²å®Œæˆã€ä¸å¯ç·¨è¼¯ï¼ˆåƒ… REPORTED/ASSIGNED å¯ç·¨è¼¯ï¼‰ã€`
   - âŒ ä¸æ‡‰é¡¯ç¤ºï¼š`ã€Œç‹€æ…‹ç‚ºã€ŒRESOLVEDã€ä¸å¯ç·¨è¼¯ã€`

**é æœŸçµæœï¼š**

- Tooltip é¡¯ç¤ºä¸­æ–‡ç‹€æ…‹åç¨±

---

## ğŸ”’ å®‰å…¨æª¢æŸ¥ï¼ˆé©—è­‰æœªç ´å£åŸæœ‰åŠŸèƒ½ï¼‰

### âœ… å¾Œç«¯å®Œå…¨ä¸è®Š

- DB schema ç„¡ä¿®æ”¹
- API endpoint ç„¡ä¿®æ”¹
- API request/response æ ¼å¼ç„¡ä¿®æ”¹
- æ‰€æœ‰æ¬„ä½å€¼ä»ç‚ºè‹±æ–‡ä»£ç¢¼ï¼ˆNORMALã€FIXED...ï¼‰

### âœ… å‰ç«¯å‘å¾Œç›¸å®¹

- ä¿ç•™åŸæœ‰ `priorityText` / `statusText` è®Šæ•¸ï¼ˆä¾›æ¨¡æ¿ä½¿ç”¨ï¼‰
- æ–°å¢ getter ç‚ºé¡å¤–é¸é …ï¼Œæœªç§»é™¤èˆŠæœ‰è¨ªå•æ–¹å¼
- æœªçŸ¥ä»£ç¢¼æœƒé™ç´šé¡¯ç¤ºåŸå§‹å€¼ï¼ˆä¸æœƒå ±éŒ¯ï¼‰

### âœ… æœªå¼•å…¥æ–°å¥—ä»¶

- åªä½¿ç”¨åŸç”Ÿ JavaScript String.replace + Regex
- ç„¡é¡å¤–ä¾è³´

---

## ğŸ¯ é©—æ”¶æ¨™æº–ï¼ˆå…¨éƒ¨é€šé = æˆåŠŸï¼‰

| #   | é©—æ”¶é …ç›®          | æ¸¬è©¦æ–¹æ³•                           | é€šéæ¨™æº–                        |
| --- | ----------------- | ---------------------------------- | ------------------------------- |
| 1   | åˆ—è¡¨å„ªå…ˆæ¬Šä¸­æ–‡    | æŸ¥çœ‹åˆ—è¡¨ Priority tag              | é¡¯ç¤ºã€Œæ™®é€šã€ã€Œç·Šæ€¥ã€ä¸æ˜¯ NORMAL |
| 2   | åˆ—è¡¨ç‹€æ…‹ä¸­æ–‡      | æŸ¥çœ‹åˆ—è¡¨ Status tag                | é¡¯ç¤ºã€Œå·²é€šå ±ã€ä¸æ˜¯ REPORTED     |
| 3   | è©³æƒ…å½ˆçª—ä¸­æ–‡      | é»æ“Šã€ŒæŸ¥çœ‹è©³æƒ…ã€                   | å½ˆçª—å…§é¡¯ç¤ºä¸­æ–‡                  |
| 4   | æ­·ç¨‹ comment ä¸­æ–‡ | é»æ“Šã€ŒæŸ¥çœ‹æ­·ç¨‹ã€                   | Timeline é¡¯ç¤ºã€Œå„ªå…ˆæ¬Š: æ™®é€šã€   |
| 5   | çµæ¡ˆçµæœä¸­æ–‡      | é–‹å•Ÿçµæ¡ˆå°è©±æ¡†                     | é¸é …é¡¯ç¤ºã€Œå·²ä¿®å¾©ã€ã€Œç„¡æ³•ä¿®å¾©ã€  |
| 6   | è¡¨å–®å„ªå…ˆç´šä¸­æ–‡    | æ–°å¢å·¥å–®é é¢                       | å¡ç‰‡é¡¯ç¤ºä¸­æ–‡                    |
| 7   | Tooltip ç‹€æ…‹ä¸­æ–‡  | æ»‘é¼ ç§»åˆ° disabled ç·¨è¼¯æŒ‰éˆ•         | Tooltip é¡¯ç¤ºã€Œå·²å®Œæˆã€          |
| 8   | API é€å‡ºè‹±æ–‡ä»£ç¢¼  | Network tab æª¢æŸ¥ POST/PATCH        | `issuePriority: "URGENT"`       |
| 9   | API å›å‚³è‹±æ–‡ä»£ç¢¼  | Network tab æª¢æŸ¥ GET response      | `issueStatus: "RESOLVED"`       |
| 10  | æœªçŸ¥ä»£ç¢¼é™ç´š      | æ‰‹å‹•ä¿®æ”¹ API response ç‚º `UNKNOWN` | é¡¯ç¤º "UNKNOWN" ä¸å ±éŒ¯           |

---

## ğŸ“ æŠ€è¡“ç´°ç¯€æ‘˜è¦

### æ˜ å°„è¦å‰‡

**å„ªå…ˆæ¬Š (Priority):**

```
LOW    â†’ ä½å„ªå…ˆ
NORMAL â†’ æ™®é€š
HIGH   â†’ é«˜å„ªå…ˆ
URGENT â†’ ç·Šæ€¥
```

**ç‹€æ…‹ (Status):**

```
REPORTED          â†’ å·²é€šå ±
ASSIGNED          â†’ å·²æŒ‡æ´¾
UNDER_MAINTENANCE â†’ ç¶­ä¿®ä¸­
RESOLVED          â†’ å·²å®Œæˆ
CANCELLED         â†’ å·²å–æ¶ˆ
```

**çµæ¡ˆçµæœ (Result):**

```
NO_ISSUE   â†’ æœªç™¼ç¾å•é¡Œ
FIXED      â†’ å·²ä¿®å¾©
REPLACED   â†’ å·²æ›´æ›
NOT_FIXABLE â†’ ç„¡æ³•ä¿®å¾©
OTHER      â†’ å…¶ä»–
```

### Regex èªªæ˜

```javascript
// åŒ¹é…ã€Œå„ªå…ˆæ¬Š: <è‹±æ–‡ä»£ç¢¼>ã€æ¨¡å¼
;/å„ªå…ˆæ¬Š:\s*([A-Z_]+)/g

// [A-Z_]+ = å¤§å¯«å­—æ¯æˆ–åº•ç·šçµ„æˆçš„ä»£ç¢¼
// \s* = å…è¨±å†’è™Ÿå¾Œæœ‰ç©ºæ ¼
// () = æ•ç² CODE éƒ¨åˆ†ç”¨æ–¼æ›¿æ›
```

### é™ç´šç­–ç•¥

```javascript
// è‹¥ä»£ç¢¼ä¸åœ¨ config ä¸­ï¼Œå›å‚³åŸå§‹ä»£ç¢¼
getPriorityText(code) {
  return priorityConfig[code]?.text || code  // â† å®‰å…¨é™ç´š
}
```

---

## âœ¨ å®Œæˆç‹€æ…‹

- âœ… æ‰€æœ‰æª”æ¡ˆä¿®æ”¹å®Œæˆ
- âœ… ç·¨è­¯ç„¡éŒ¯èª¤ï¼ˆåƒ…æœ‰æœªä½¿ç”¨è®Šæ•¸è­¦å‘Šï¼Œå¯å¿½ç•¥ï¼‰
- âœ… ä»£ç¢¼å¯©æŸ¥é€šé
- â³ å¾…ç”¨æˆ¶é€²è¡Œæ‰‹å‹•æ¸¬è©¦é©—è­‰

---

**ä¿®æ”¹æ—¥æœŸï¼š** 2026-01-19  
**ä¿®æ”¹äººå“¡ï¼š** GitHub Copilot  
**å½±éŸ¿ç¯„åœï¼š** å‰ç«¯å·¥å–®æ¨¡çµ„é¡¯ç¤ºå±¤ï¼ˆä¸å½±éŸ¿å¾Œç«¯èˆ‡ DBï¼‰
</file>

<file path="backend/docs/åœ–ç‰‡é™„ä»¶åŠŸèƒ½èªªæ˜.md">
# å·¥å–®åœ–ç‰‡é™„ä»¶åŠŸèƒ½ - å‰ç«¯å¯¦ä½œèªªæ˜

## ğŸ“‹ ä¿®æ”¹/æ–°å¢æª”æ¡ˆæ¸…å–®

### âœ… ä¿®æ”¹æª”æ¡ˆï¼ˆ2 å€‹ï¼‰

1. **frontend/src/api/modules/maintenance.js**
   - æ–°å¢ `uploadTicketAttachments(ticketId, files, note)` - ä¸Šå‚³é™„ä»¶
   - æ–°å¢ `getTicketAttachments(ticketId)` - æŸ¥è©¢é™„ä»¶æ¸…å–®
   - æ–°å¢ `deleteTicketAttachment(attachmentId)` - åˆªé™¤é™„ä»¶
   - ä¸¦åœ¨ default export ä¸­åŠ å…¥é€™ä¸‰å€‹å‡½æ•¸

2. **frontend/src/views/maintenance/MtifForm.vue**
   - æ–°å¢åœ–ç‰‡é™„ä»¶ä¸Šå‚³å€å¡Šï¼ˆel-uploadï¼‰
   - æ–°å¢é™„ä»¶æ¸…å–®é¡¯ç¤ºèˆ‡ç®¡ç†åŠŸèƒ½
   - æ”¯æ´æ–°å¢/ç·¨è¼¯å…©ç¨®æ¨¡å¼çš„ä¸åŒæµç¨‹

---

## ğŸ¯ åŠŸèƒ½èªªæ˜

### A. API å°è£ï¼ˆmaintenance.jsï¼‰

#### 1. uploadTicketAttachments
```javascript
// ä¸Šå‚³å·¥å–®é™„ä»¶
uploadTicketAttachments(ticketId, files, note)
```
- **ticketId**: å·¥å–® ID
- **files**: File[] é™£åˆ—ï¼ˆå¾ input[type=file] å–å¾—ï¼‰
- **note**: å‚™è¨»ï¼ˆå¯é¸ï¼‰
- **å›å‚³**: Promise<{ data: AttachmentResponseDto[] }>

#### 2. getTicketAttachments
```javascript
// å–å¾—å·¥å–®çš„æ‰€æœ‰é™„ä»¶
getTicketAttachments(ticketId)
```
- **ticketId**: å·¥å–® ID
- **å›å‚³**: Promise<{ data: AttachmentResponseDto[] }>

#### 3. deleteTicketAttachment
```javascript
// åˆªé™¤é™„ä»¶ï¼ˆè»Ÿåˆªé™¤ï¼‰
deleteTicketAttachment(attachmentId)
```
- **attachmentId**: é™„ä»¶ ID
- **å›å‚³**: Promise<{ data: AttachmentResponseDto }>

---

### B. å‰ç«¯ UI åŠŸèƒ½ï¼ˆMtifForm.vueï¼‰

#### ğŸ“Œ æ–°å¢æ¨¡å¼æµç¨‹
1. ä½¿ç”¨è€…å¡«å¯«å·¥å–®è³‡è¨Š
2. **å¯é¸**ï¼šé¸æ“‡åœ–ç‰‡æª”æ¡ˆï¼ˆæš«å­˜æ–¼ `fileList`ï¼‰
3. å¡«å¯«å‚™è¨»ï¼ˆå¥—ç”¨åˆ°æ‰€æœ‰åœ–ç‰‡ï¼‰
4. é»æ“Šã€Œå»ºç«‹å·¥å–®ã€æŒ‰éˆ•
5. å¾Œç«¯å»ºç«‹å·¥å–®æˆåŠŸï¼Œå–å¾— `ticketId`
6. è‹¥æœ‰é¸æ“‡åœ–ç‰‡ï¼Œè‡ªå‹•å‘¼å« `uploadTicketAttachments` ä¸Šå‚³
7. è·³è½‰å›å·¥å–®åˆ—è¡¨é 

#### ğŸ“Œ ç·¨è¼¯æ¨¡å¼æµç¨‹
1. é€²å…¥ç·¨è¼¯é é¢ï¼Œè‡ªå‹•è¼‰å…¥æ—¢æœ‰é™„ä»¶æ¸…å–®
2. é¡¯ç¤ºå·²ä¸Šå‚³çš„é™„ä»¶ç¸®åœ–ã€æª”åã€æ™‚é–“ã€å¤§å°
3. **å¯è¿½åŠ ä¸Šå‚³**ï¼š
   - é¸æ“‡åœ–ç‰‡æª”æ¡ˆ
   - å¡«å¯«å‚™è¨»ï¼ˆå¯é¸ï¼‰
   - é»æ“Šã€Œç«‹å³ä¸Šå‚³ã€æŒ‰éˆ•
   - ä¸Šå‚³æˆåŠŸå¾Œè‡ªå‹•åˆ·æ–°æ¸…å–®
4. **å¯åˆªé™¤é™„ä»¶**ï¼š
   - é»æ“Šé™„ä»¶å³ä¸Šè§’çš„åˆªé™¤æŒ‰éˆ•
   - ç¢ºèªåˆªé™¤å¾Œï¼Œå¾Œç«¯è»Ÿåˆªé™¤ï¼ˆisActive=0ï¼‰
   - è‡ªå‹•åˆ·æ–°æ¸…å–®
5. **å¯é è¦½åœ–ç‰‡**ï¼š
   - é»æ“Šç¸®åœ–ï¼Œå½ˆå‡º Swal åœ–ç‰‡é è¦½è¦–çª—

---

## ğŸ”’ å‰ç«¯é©—è­‰è¦å‰‡

### æª”æ¡ˆé¡å‹é™åˆ¶
```javascript
const ALLOWED_IMAGE_TYPES = ['image/jpeg', 'image/png', 'image/webp']
```
- åªå…è¨± JPGã€PNGã€WEBP æ ¼å¼
- ä¸ç¬¦åˆæ ¼å¼æœƒå½ˆå‡º `ElMessage.error` æç¤º

### æª”æ¡ˆå¤§å°é™åˆ¶
```javascript
const MAX_FILE_SIZE = 5 * 1024 * 1024 // 5MB
```
- å–®å¼µåœ–ç‰‡æœ€å¤§ 5MB
- è¶…éæœƒå½ˆå‡ºéŒ¯èª¤æç¤º

### æ•¸é‡é™åˆ¶
```javascript
const MAX_FILE_COUNT = 5
```
- æ¯å€‹å·¥å–®æœ€å¤šä¸Šå‚³ 5 å¼µåœ–ç‰‡
- è¶…éæœƒå½ˆå‡ºéŒ¯èª¤æç¤º

---

## ğŸ¨ UI ç‰¹è‰²

### 1. Element Plus el-upload çµ„ä»¶
- `list-type="picture-card"` - å¡ç‰‡å¼é è¦½
- `accept="image/jpeg,image/png,image/webp"` - é™åˆ¶æª”æ¡ˆé¸æ“‡å™¨
- `:limit="5"` - æœ€å¤š 5 å¼µ
- `:auto-upload="false"` - æ‰‹å‹•ä¸Šå‚³ï¼ˆé¿å…è‡ªå‹•è§¸ç™¼ï¼‰

### 2. é™„ä»¶æ¸…å–®ï¼ˆGrid ä½ˆå±€ï¼‰
- **éŸ¿æ‡‰å¼ç¶²æ ¼**ï¼š`grid-template-columns: repeat(auto-fill, minmax(280px, 1fr))`
- **Hover æ•ˆæœ**ï¼šæ»‘é¼ ç§»å…¥æ™‚åœ–ç‰‡æ”¾å¤§ã€é¡¯ç¤ºåˆªé™¤æŒ‰éˆ•
- **åœ–ç‰‡é è¦½**ï¼šé»æ“Šç¸®åœ–å½ˆå‡º Swal å¤§åœ–é è¦½

### 3. çµ±ä¸€ä½¿ç”¨ Swal æç¤º
- **æˆåŠŸ**ï¼š`Swal.fire({ icon: 'success', ... })`
- **éŒ¯èª¤**ï¼š`Swal.fire('éŒ¯èª¤', errorMsg, 'error')`
- **ç¢ºèª**ï¼š`Swal.fire({ icon: 'warning', showCancelButton: true, ... })`
- **åœ–ç‰‡é è¦½**ï¼š`Swal.fire({ imageUrl: ..., showConfirmButton: false })`

### 4. ElMessage å³æ™‚æç¤º
- æª”æ¡ˆé©—è­‰å¤±æ•—ï¼š`ElMessage.error(...)`
- ä¸Šå‚³æˆåŠŸï¼š`ElMessage.success(...)`
- åˆªé™¤æˆåŠŸï¼š`ElMessage.success(...)`

---

## ğŸ§ª æ¸¬è©¦æ­¥é©Ÿ

### æ¸¬è©¦ 1ï¼šæ–°å¢æ¨¡å¼ä¸Šå‚³é™„ä»¶

1. å•Ÿå‹•å‰ç«¯èˆ‡å¾Œç«¯
```bash
# å¾Œç«¯
cd d:\SeatRentSys_VScode\backend
.\mvnw.cmd spring-boot:run

# å‰ç«¯
cd d:\SeatRentSys_VScode\frontend
npm run dev
```

2. ç€è¦½å™¨é–‹å•Ÿ `http://localhost:5173/maintenance/tickets/new`
3. å¡«å¯«å·¥å–®è³‡è¨Š
4. æ²å‹•åˆ°ã€Œåœ–ç‰‡é™„ä»¶ã€å€å¡Šï¼Œé»æ“Šã€Œé¸æ“‡åœ–ç‰‡ã€
5. é¸æ“‡ 1~5 å¼µåœ–ç‰‡ï¼ˆJPG/PNG/WEBPï¼‰
6. å¡«å¯«å‚™è¨»ï¼ˆå¯é¸ï¼‰
7. é»æ“Šã€Œå»ºç«‹å·¥å–®ã€
8. æª¢æŸ¥æ˜¯å¦æˆåŠŸå»ºç«‹å·¥å–®ä¸¦ä¸Šå‚³åœ–ç‰‡

**é æœŸçµæœ**ï¼š
- âœ… å·¥å–®å»ºç«‹æˆåŠŸ
- âœ… é™„ä»¶ä¸Šå‚³æˆåŠŸï¼ˆå¦‚æœæœ‰é¸æ“‡åœ–ç‰‡ï¼‰
- âœ… è·³è½‰å›å·¥å–®åˆ—è¡¨é 

---

### æ¸¬è©¦ 2ï¼šç·¨è¼¯æ¨¡å¼ç®¡ç†é™„ä»¶

1. é€²å…¥å·¥å–®åˆ—è¡¨é  `http://localhost:5173/maintenance/tickets`
2. é»æ“Šä»»ä¸€å·¥å–®çš„ã€Œç·¨è¼¯ã€æŒ‰éˆ•
3. æ²å‹•åˆ°ã€Œåœ–ç‰‡é™„ä»¶ã€å€å¡Š
4. æ‡‰è©²çœ‹åˆ°ã€Œå·²ä¸Šå‚³é™„ä»¶ (N)ã€æ¸…å–®ï¼ˆå¦‚æœä¹‹å‰æœ‰ä¸Šå‚³ï¼‰
5. æ¸¬è©¦è¿½åŠ ä¸Šå‚³ï¼š
   - é»æ“Šã€Œé¸æ“‡åœ–ç‰‡ã€ï¼Œé¸æ“‡æ–°åœ–ç‰‡
   - å¡«å¯«å‚™è¨»ï¼ˆå¯é¸ï¼‰
   - é»æ“Šã€Œç«‹å³ä¸Šå‚³ã€
   - æª¢æŸ¥æ˜¯å¦æˆåŠŸä¸Šå‚³ä¸¦åˆ·æ–°æ¸…å–®
6. æ¸¬è©¦é è¦½åœ–ç‰‡ï¼š
   - é»æ“Šä»»ä¸€ç¸®åœ–
   - æ‡‰è©²å½ˆå‡º Swal å¤§åœ–é è¦½è¦–çª—
7. æ¸¬è©¦åˆªé™¤é™„ä»¶ï¼š
   - æ»‘é¼ ç§»åˆ°é™„ä»¶å¡ç‰‡ä¸Š
   - å³ä¸Šè§’æœƒå‡ºç¾ç´…è‰²åˆªé™¤æŒ‰éˆ•
   - é»æ“Šåˆªé™¤ï¼Œç¢ºèªåˆªé™¤
   - æª¢æŸ¥æ˜¯å¦å¾æ¸…å–®ä¸­ç§»é™¤

**é æœŸçµæœ**ï¼š
- âœ… è¼‰å…¥æ—¢æœ‰é™„ä»¶æ¸…å–®
- âœ… å¯è¿½åŠ ä¸Šå‚³æ–°é™„ä»¶
- âœ… å¯é è¦½åœ–ç‰‡
- âœ… å¯åˆªé™¤é™„ä»¶
- âœ… æ“ä½œå¾Œè‡ªå‹•åˆ·æ–°æ¸…å–®

---

### æ¸¬è©¦ 3ï¼šé©—è­‰è¦å‰‡

1. å˜—è©¦ä¸Šå‚³éåœ–ç‰‡æª”æ¡ˆï¼ˆå¦‚ PDFã€Wordï¼‰
   - **é æœŸ**ï¼š`ElMessage.error` æç¤ºä¸æ”¯æ´çš„æ ¼å¼

2. å˜—è©¦ä¸Šå‚³è¶…é 5MB çš„åœ–ç‰‡
   - **é æœŸ**ï¼š`ElMessage.error` æç¤ºæª”æ¡ˆéå¤§

3. å˜—è©¦ä¸Šå‚³è¶…é 5 å¼µåœ–ç‰‡
   - **é æœŸ**ï¼š`ElMessage.error` æç¤ºæ•¸é‡é™åˆ¶

4. ä¸é¸æ“‡åœ–ç‰‡ç›´æ¥å»ºç«‹å·¥å–®
   - **é æœŸ**ï¼šæ­£å¸¸å»ºç«‹å·¥å–®ï¼Œä¸ä¸Šå‚³é™„ä»¶

---

## ğŸ“¸ UI æˆªåœ–èªªæ˜

### æ–°å¢æ¨¡å¼
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åœ–ç‰‡é™„ä»¶ [é¸å¡«]                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”                 â”‚
â”‚  â”‚ + â”‚ â”‚åœ–1â”‚ â”‚åœ–2â”‚                 â”‚
â”‚  â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜                 â”‚
â”‚  é¸æ“‡åœ–ç‰‡                            â”‚
â”‚                                     â”‚
â”‚  æ”¯æ´ JPGã€PNGã€WEBP æ ¼å¼...         â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ é¸å¡«ï¼šç‚ºé€™æ‰¹åœ–ç‰‡åŠ ä¸Šå‚™è¨»...    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç·¨è¼¯æ¨¡å¼ï¼ˆæœ‰é™„ä»¶ï¼‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åœ–ç‰‡é™„ä»¶ [é¸å¡«]                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä¸Šå‚³å€ï¼ˆåŒä¸Šï¼‰                        â”‚
â”‚                                     â”‚
â”‚  â”€â”€â”€ å·²ä¸Šå‚³é™„ä»¶ (3) â”€â”€â”€              â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  [åœ–1]  â”‚ â”‚  [åœ–2]  â”‚          â”‚
â”‚  â”‚ photo.jpgâ”‚ â”‚ fix.png â”‚          â”‚
â”‚  â”‚ 2026-01-31â”‚ â”‚ 2026-01-31â”‚        â”‚
â”‚  â”‚ 1.2 MB  â”‚ â”‚ 850 KB  â”‚          â”‚
â”‚  â”‚ ğŸ“ ç¾å ´ç…§ç‰‡â”‚ â”‚ ğŸ“ ç¶­ä¿®å¾Œ â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚     [ğŸ—‘ï¸]        [ğŸ—‘ï¸]                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ é—œéµå¯¦ä½œç´°ç¯€

### 1. FormData ä¸Šå‚³
```javascript
const formData = new FormData()
files.forEach(file => {
  formData.append('files', file)
})
if (note) {
  formData.append('note', note)
}
```

### 2. åœ–ç‰‡é è¦½ URL
```javascript
// å¾Œç«¯ publicUrl: /images/maintenance/tickets/{ticketId}/{storedName}
// å‰ç«¯é¡¯ç¤º: http://localhost:8080${attachment.publicUrl}
```

### 3. æ–°å¢æ¨¡å¼å»¶é²ä¸Šå‚³
```javascript
// 1. å»ºç«‹å·¥å–®
const createRes = await maintenanceApi.createTicket(submitData)
const newTicketId = createRes.data?.ticketId

// 2. å¦‚æœæœ‰é¸æ“‡åœ–ç‰‡ï¼Œä¸Šå‚³é™„ä»¶
if (fileList.value.length > 0 && newTicketId) {
  const files = fileList.value.map(f => f.raw)
  await maintenanceApi.uploadTicketAttachments(newTicketId, files, note)
}
```

### 4. ç·¨è¼¯æ¨¡å¼å³æ™‚ä¸Šå‚³
```javascript
// é¸æ“‡æª”æ¡ˆå¾Œç›´æ¥ä¸Šå‚³
const handleFileChange = (file, uploadFileList) => {
  if (isEdit.value) {
    uploadAttachmentsToServer([file.raw])
  } else {
    fileList.value = uploadFileList
  }
}
```

---

## âš ï¸ æ³¨æ„äº‹é …

### 1. CORS è¨­å®š
ç¢ºä¿å¾Œç«¯å…è¨± `multipart/form-data` è«‹æ±‚ï¼š
```java
@CrossOrigin(origins = "http://localhost:5173")
```

### 2. åœ–ç‰‡è·¯å¾‘
- å¾Œç«¯å„²å­˜ï¼š`uploads/maintenance/tickets/{ticketId}/`
- å‰ç«¯å­˜å–ï¼š`http://localhost:8080/images/maintenance/tickets/{ticketId}/`
- ç¢ºä¿ WebConfig æœ‰æ­£ç¢ºæ˜ å°„ `/images/**`

### 3. éŒ¯èª¤è™•ç†
- å‰ç«¯å…ˆé©—è­‰ï¼ˆæ ¼å¼ã€å¤§å°ã€æ•¸é‡ï¼‰
- å¾Œç«¯å†é©—è­‰ï¼ˆé˜²æ­¢ç¹éå‰ç«¯æª¢æŸ¥ï¼‰
- çµ±ä¸€ä½¿ç”¨ Swal / ElMessage é¡¯ç¤ºéŒ¯èª¤

### 4. æ–°å¢æ¨¡å¼çš„æª”æ¡ˆæš«å­˜
- ä½¿ç”¨ `fileList.value` æš«å­˜é¸æ“‡çš„æª”æ¡ˆ
- å»ºç«‹å·¥å–®æˆåŠŸå¾Œæ‰ä¸Šå‚³
- é¿å…ä½¿ç”¨è€…ã€Œé¸äº†æª”æ¡ˆä½†æ²’å»ºå–®ã€é€ æˆæ··æ·†

---

## ğŸ‰ åŠŸèƒ½å®Œæˆæª¢æŸ¥æ¸…å–®

- âœ… API å°è£å®Œæˆï¼ˆ3 å€‹å‡½æ•¸ï¼‰
- âœ… å‰ç«¯ UI å¯¦ä½œå®Œæˆ
- âœ… æ–°å¢æ¨¡å¼æ”¯æ´
- âœ… ç·¨è¼¯æ¨¡å¼æ”¯æ´
- âœ… æª”æ¡ˆé©—è­‰ï¼ˆæ ¼å¼ã€å¤§å°ã€æ•¸é‡ï¼‰
- âœ… é™„ä»¶æ¸…å–®é¡¯ç¤º
- âœ… åœ–ç‰‡é è¦½åŠŸèƒ½
- âœ… é™„ä»¶åˆªé™¤åŠŸèƒ½
- âœ… éŒ¯èª¤æç¤ºçµ±ä¸€ä½¿ç”¨ Swal / ElMessage
- âœ… ä¸ç ´å£æ—¢æœ‰å·¥å–® CRUD é‚è¼¯
- âœ… ç¶­æŒ maintenance æ¨¡çµ„é¢¨æ ¼

---

## ğŸ“ æœªä¾†å¯å„ªåŒ–é …ç›®

1. **åœ–ç‰‡å£“ç¸®**ï¼šå‰ç«¯ä¸Šå‚³å‰å£“ç¸®åœ–ç‰‡ï¼Œæ¸›å°‘æµé‡
2. **æ‹–æ›³ä¸Šå‚³**ï¼šæ”¯æ´æ‹–æ›³æª”æ¡ˆåˆ°ä¸Šå‚³å€
3. **æ‰¹é‡åˆªé™¤**ï¼šæ”¯æ´ä¸€æ¬¡é¸æ“‡å¤šå¼µåœ–ç‰‡åˆªé™¤
4. **æ’åºèª¿æ•´**ï¼šæ”¯æ´æ‹–æ›³èª¿æ•´åœ–ç‰‡é †åºï¼ˆä¿®æ”¹ sortOrderï¼‰
5. **æµ®æ°´å°**ï¼šä¸Šå‚³æ™‚è‡ªå‹•åŠ ä¸Šå·¥å–®ç·¨è™Ÿæµ®æ°´å°
6. **é›²ç«¯å„²å­˜**ï¼šæ•´åˆ Azure Blob Storage æˆ– AWS S3

---

## ğŸš€ éƒ¨ç½²æ³¨æ„äº‹é …

### ç”Ÿç”¢ç’°å¢ƒ
1. ä¿®æ”¹åœ–ç‰‡ URL å‰ç¶´ï¼š
```javascript
// é–‹ç™¼ç’°å¢ƒ
:src="`http://localhost:8080${att.publicUrl}`"

// ç”Ÿç”¢ç’°å¢ƒï¼ˆæ”¹ç‚ºç›¸å°è·¯å¾‘æˆ–ç’°å¢ƒè®Šæ•¸ï¼‰
:src="`${import.meta.env.VITE_API_BASE_URL}${att.publicUrl}`"
```

2. è¨­å®šç’°å¢ƒè®Šæ•¸ï¼ˆ.env.productionï¼‰ï¼š
```
VITE_API_BASE_URL=https://your-api-domain.com
```

3. ç¢ºä¿ç”Ÿç”¢ç’°å¢ƒçš„ uploads ç›®éŒ„æœ‰æ­£ç¢ºæ¬Šé™

---

**å®Œæˆæ™‚é–“**: 2026-01-31  
**æ¸¬è©¦ç‹€æ…‹**: âœ… å¾…æ¸¬è©¦ï¼ˆè«‹ä¾ç…§ä¸Šè¿°æ­¥é©Ÿé€²è¡Œå®Œæ•´æ¸¬è©¦ï¼‰
</file>

<file path="backend/docs/AI_CONTEXT.md">
# ğŸ¤– AI Context - ç¨‹å¼ç¢¼ç´¢å¼•èˆ‡å¿«é€Ÿå®šä½

> ä¾› Code Review èˆ‡ AI è¼”åŠ©é–‹ç™¼ä½¿ç”¨çš„æª”æ¡ˆç´¢å¼•

---

## ğŸ“‚ å¾Œç«¯ Controller ç´¢å¼•

### æœƒå“¡æ¨¡çµ„ (Member)

| Controller                                                                                         | è·¯å¾‘                 | API å‰ç¶´   |
| -------------------------------------------------------------------------------------------------- | -------------------- | ---------- |
| [`MemberController`](../src/main/java/com/example/backend/controller/member/MemberController.java) | `controller/member/` | `/members` |

**ä¸»è¦æ–¹æ³•**:

- `findAll()` â†’ GET `/members`
- `findOne()` â†’ GET `/members/find`
- `insert()` â†’ POST `/members`
- `update()` â†’ POST `/members/update`
- `delete()` â†’ GET `/members/delete`

---

### æ“šé»æ¨¡çµ„ (Spot)

| Controller                                                                                               | è·¯å¾‘               | API å‰ç¶´ |
| -------------------------------------------------------------------------------------------------------- | ------------------ | -------- |
| [`SpotListServ`](../src/main/java/com/example/backend/controller/spot/SpotListServ.java)                 | `controller/spot/` | `/spot`  |
| [`RentalSpotController`](../src/main/java/com/example/backend/controller/spot/RentalSpotController.java) | `controller/spot/` | `/spot`  |

---

### åº§ä½æ¨¡çµ„ (Seat)

| Controller                                                                                   | è·¯å¾‘               | API å‰ç¶´ |
| -------------------------------------------------------------------------------------------- | ------------------ | -------- |
| [`SeatListServ`](../src/main/java/com/example/backend/controller/spot/SeatListServ.java)     | `controller/spot/` | `/seat`  |
| [`SeatController`](../src/main/java/com/example/backend/controller/spot/SeatController.java) | `controller/spot/` | `/seat`  |

---

### ç¶­ä¿®æ¨¡çµ„ (Maintenance)

| Controller                                                                                                        | è·¯å¾‘                      | API å‰ç¶´           |
| ----------------------------------------------------------------------------------------------------------------- | ------------------------- | ------------------ |
| [`MaintenanceController`](../src/main/java/com/example/backend/controller/maintenance/MaintenanceController.java) | `controller/maintenance/` | `/api/maintenance` |

**å·¥å–®ç‹€æ…‹æµè½‰ API**:

- `POST /api/maintenance/tickets/{id}/assign` - æŒ‡æ´¾äººå“¡
- `POST /api/maintenance/tickets/{id}/start` - é–‹å§‹ç¶­ä¿®
- `POST /api/maintenance/tickets/{id}/resolve` - çµæ¡ˆ
- `POST /api/maintenance/tickets/{id}/cancel` - å–æ¶ˆ

---

### ç§Ÿå€Ÿè¨‚å–®æ¨¡çµ„ (Rec)

| Controller                                                                                                | è·¯å¾‘              | API å‰ç¶´            |
| --------------------------------------------------------------------------------------------------------- | ----------------- | ------------------- |
| [`RecRentController`](../src/main/java/com/example/backend/controller/rec/RecRentController.java)         | `controller/rec/` | `/api/rec-rents`    |
| [`RentDetailsController`](../src/main/java/com/example/backend/controller/rec/RentDetailsController.java) | `controller/rec/` | `/api/rent-details` |

---

### å•†å®¶èˆ‡å„ªæƒ åˆ¸æ¨¡çµ„ (MerchantAndCoupon)

| Controller                                                                                                        | è·¯å¾‘                            | API å‰ç¶´         |
| ----------------------------------------------------------------------------------------------------------------- | ------------------------------- | ---------------- |
| [`MerchantController`](../src/main/java/com/example/backend/controller/merchantAndCoupon/MerchantController.java) | `controller/merchantAndCoupon/` | `/api/merchants` |
| [`DiscountController`](../src/main/java/com/example/backend/controller/merchantAndCoupon/DiscountController.java) | `controller/merchantAndCoupon/` | `/api/discounts` |

---

## ğŸ“‚ å¾Œç«¯ Entity ç´¢å¼•

| Entity                                                                                                         | è·¯å¾‘                       | å°æ‡‰è³‡æ–™è¡¨               |
| -------------------------------------------------------------------------------------------------------------- | -------------------------- | ------------------------ |
| [`Member`](../src/main/java/com/example/backend/model/member/Member.java)                                      | `model/member/`            | `member`                 |
| [`Admin`](../src/main/java/com/example/backend/model/member/Admin.java)                                        | `model/member/`            | `admin`                  |
| [`RentalSpot`](../src/main/java/com/example/backend/model/spot/RentalSpot.java)                                | `model/spot/`              | `renting_Spot`           |
| [`Seat`](../src/main/java/com/example/backend/model/spot/Seat.java)                                            | `model/spot/`              | `seats`                  |
| [`RecRent`](../src/main/java/com/example/backend/model/rec/RecRent.java)                                       | `model/rec/`               | `recRent`                |
| [`RentDetails`](../src/main/java/com/example/backend/model/rec/RentDetails.java)                               | `model/rec/`               | (View)                   |
| [`Merchant`](../src/main/java/com/example/backend/model/merchantAndCoupon/Merchant.java)                       | `model/merchantAndCoupon/` | `merchant`               |
| [`Discount`](../src/main/java/com/example/backend/model/merchantAndCoupon/Discount.java)                       | `model/merchantAndCoupon/` | `discount`               |
| [`MaintenanceStaff`](../src/main/java/com/example/backend/model/maintenance/MaintenanceStaff.java)             | `model/maintenance/`       | `maintenanceStaff`       |
| [`MaintenanceInformation`](../src/main/java/com/example/backend/model/maintenance/MaintenanceInformation.java) | `model/maintenance/`       | `maintenanceInformation` |

---

## ğŸ“‚ å¾Œç«¯ Service ç´¢å¼•

| Service                                                                                                                        | è·¯å¾‘                   | å°æ‡‰ Controller       |
| ------------------------------------------------------------------------------------------------------------------------------ | ---------------------- | --------------------- |
| [`MemberService`](../src/main/java/com/example/backend/service/member/MemberService.java)                                      | `service/member/`      | MemberController      |
| [`RentalSpotService`](../src/main/java/com/example/backend/service/spot/RentalSpotService.java)                                | `service/spot/`        | SpotListServ          |
| [`SeatService`](../src/main/java/com/example/backend/service/spot/SeatService.java)                                            | `service/spot/`        | SeatListServ          |
| [`MaintenanceInformationService`](../src/main/java/com/example/backend/service/maintenance/MaintenanceInformationService.java) | `service/maintenance/` | MaintenanceController |
| [`MaintenanceStaffService`](../src/main/java/com/example/backend/service/maintenance/MaintenanceStaffService.java)             | `service/maintenance/` | MaintenanceController |

---

## ğŸ“‚ å¾Œç«¯ Repository ç´¢å¼•

| Repository                                                                                                                              | è·¯å¾‘                      |
| --------------------------------------------------------------------------------------------------------------------------------------- | ------------------------- |
| [`MemberRepository`](../src/main/java/com/example/backend/repository/member/MemberRepository.java)                                      | `repository/member/`      |
| [`RentalSpotRepository`](../src/main/java/com/example/backend/repository/spot/RentalSpotRepository.java)                                | `repository/spot/`        |
| [`SeatRepository`](../src/main/java/com/example/backend/repository/spot/SeatRepository.java)                                            | `repository/spot/`        |
| [`RecRentRepository`](../src/main/java/com/example/backend/repository/rec/RecRentRepository.java)                                       | `repository/rec/`         |
| [`RentDetailsRepository`](../src/main/java/com/example/backend/repository/rec/RentDetailsRepository.java)                               | `repository/rec/`         |
| [`MaintenanceInformationRepository`](../src/main/java/com/example/backend/repository/maintenance/MaintenanceInformationRepository.java) | `repository/maintenance/` |
| [`MaintenanceStaffRepository`](../src/main/java/com/example/backend/repository/maintenance/MaintenanceStaffRepository.java)             | `repository/maintenance/` |

---

## ğŸ“‚ å¾Œç«¯è¨­å®šæª”ç´¢å¼•

| æª”æ¡ˆ                                                                             | è·¯å¾‘      | èªªæ˜                     |
| -------------------------------------------------------------------------------- | --------- | ------------------------ |
| [`WebConfig`](../src/main/java/com/example/backend/config/WebConfig.java)        | `config/` | CORSã€éœæ…‹è³‡æºã€å¥åº·æª¢æŸ¥ |
| [`DbPrintRunner`](../src/main/java/com/example/backend/utils/DbPrintRunner.java) | `utils/`  | è³‡æ–™åº«åˆ—å°å·¥å…· (é–‹ç™¼ç”¨)  |

---

## ğŸ“‚ å‰ç«¯ Router ç´¢å¼•

> æª”æ¡ˆä½ç½®: [`frontend/src/router/index.js`](../../frontend/src/router/index.js)

### å…¬é–‹è·¯ç”±

| Path     | Name | Component         |
| -------- | ---- | ----------------- |
| `/login` | -    | `LoginView.vue`   |
| `/`      | -    | é‡å°å‘è‡³ `/login` |

### å¾Œå°è·¯ç”± (`/admin/*`)

| Path                      | Name            | Component                     | èªªæ˜       |
| ------------------------- | --------------- | ----------------------------- | ---------- |
| `/admin`                  | `admin-home`    | `AdminHomeView.vue`           | å¾Œå°é¦–é    |
| `/admin/spot/list`        | `spot-list`     | `SpotList.vue`                | æ“šé»åˆ—è¡¨   |
| `/admin/spot/add`         | `spot-add`      | `SpotForm.vue`                | æ–°å¢æ“šé»   |
| `/admin/spot/edit/:id`    | `spot-edit`     | `SpotForm.vue`                | ç·¨è¼¯æ“šé»   |
| `/admin/seat/list`        | `seat-list`     | `SeatList.vue`                | åº§ä½åˆ—è¡¨   |
| `/admin/seat/insert`      | `seat-insert`   | `SeatInsert.vue`              | æ–°å¢åº§ä½   |
| `/admin/seat/edit/:id`    | `seat-edit`     | `SeatUpdate.vue`              | ç·¨è¼¯åº§ä½   |
| `/admin/seat/view/:id`    | `seat-view`     | `SeatOne.vue`                 | åº§ä½è©³æƒ…   |
| `/admin/seat/search`      | `seat-search`   | `SeatSearch.vue`              | åº§ä½æŸ¥è©¢   |
| `/admin/seat/result`      | `seat-result`   | `SeatResult.vue`              | æŸ¥è©¢çµæœ   |
| `/admin/merchants`        | `merchants`     | `MerchantList.vue`            | å•†å®¶ç®¡ç†   |
| `/admin/discounts`        | `discounts`     | `DiscountList.vue`            | å„ªæƒ åˆ¸ç®¡ç† |
| `/admin/members`          | `member-list`   | `MemberListView.vue`          | æœƒå“¡åˆ—è¡¨   |
| `/admin/members/edit/:id` | `member-edit`   | `MemberEditView.vue`          | ç·¨è¼¯æœƒå“¡   |
| `/admin/members/create`   | `member-create` | `MemberCreateView.vue`        | æ–°å¢æœƒå“¡   |
| `/admin/rec-rent`         | `rec-rent`      | `RecRentManagement.vue`       | ç§Ÿå€Ÿè¨‚å–®   |
| `/admin/staff-list`       | `staff-list`    | `MaintenanceStaffList.vue`    | ç¶­è­·äººå“¡   |
| `/admin/staff-form/:id?`  | `staff-form`    | `MaintenanceStaffForm.vue`    | äººå“¡è¡¨å–®   |
| `/admin/staff-history`    | `staff-history` | `MaintenanceStaffHistory.vue` | äººå“¡ç´€éŒ„   |
| `/admin/mtif-list`        | `mtif-list`     | `MtifList.vue`                | å·¥å–®åˆ—è¡¨   |
| `/admin/mtif-history`     | `mtif-history`  | `MtifList.vue`                | å·¥å–®æ­·å²   |
| `/admin/mtif-form/:id?`   | `mtif-form`     | `MtifForm.vue`                | å·¥å–®è¡¨å–®   |

---

## ğŸ“‚ å‰ç«¯ Views ç´¢å¼•

### æœƒå“¡æ¨¡çµ„ (`views/member/`)

| æª”æ¡ˆ                                                                           | èªªæ˜                |
| ------------------------------------------------------------------------------ | ------------------- |
| [`AdminLayout.vue`](../../frontend/src/views/member/AdminLayout.vue)           | AdminLTE 3 å¾Œå°æ¡†æ¶ |
| [`AdminHomeView.vue`](../../frontend/src/views/member/AdminHomeView.vue)       | å¾Œå°é¦–é å„€è¡¨æ¿      |
| [`LoginView.vue`](../../frontend/src/views/member/LoginView.vue)               | ç™»å…¥é é¢            |
| [`MemberListView.vue`](../../frontend/src/views/member/MemberListView.vue)     | æœƒå“¡åˆ—è¡¨            |
| [`MemberEditView.vue`](../../frontend/src/views/member/MemberEditView.vue)     | ç·¨è¼¯æœƒå“¡            |
| [`MemberCreateView.vue`](../../frontend/src/views/member/MemberCreateView.vue) | æ–°å¢æœƒå“¡            |

### æ“šé»æ¨¡çµ„ (`views/spot/`)

| æª”æ¡ˆ                                                             | èªªæ˜                 |
| ---------------------------------------------------------------- | -------------------- |
| [`SpotList.vue`](../../frontend/src/views/spot/SpotList.vue)     | æ“šé»åˆ—è¡¨             |
| [`SpotForm.vue`](../../frontend/src/views/spot/SpotForm.vue)     | æ“šé»è¡¨å–® (æ–°å¢/ç·¨è¼¯) |
| [`SpotOne.vue`](../../frontend/src/views/spot/SpotOne.vue)       | æ“šé»è©³æƒ…             |
| [`SeatList.vue`](../../frontend/src/views/spot/SeatList.vue)     | åº§ä½åˆ—è¡¨             |
| [`SeatInsert.vue`](../../frontend/src/views/spot/SeatInsert.vue) | æ–°å¢åº§ä½             |
| [`SeatUpdate.vue`](../../frontend/src/views/spot/SeatUpdate.vue) | ç·¨è¼¯åº§ä½             |
| [`SeatOne.vue`](../../frontend/src/views/spot/SeatOne.vue)       | åº§ä½è©³æƒ…             |
| [`SeatSearch.vue`](../../frontend/src/views/spot/SeatSearch.vue) | åº§ä½æŸ¥è©¢             |
| [`SeatResult.vue`](../../frontend/src/views/spot/SeatResult.vue) | æŸ¥è©¢çµæœ             |

### ç¶­ä¿®æ¨¡çµ„ (`views/maintenance/`)

| æª”æ¡ˆ                                                                                              | èªªæ˜                    |
| ------------------------------------------------------------------------------------------------- | ----------------------- |
| [`MtifList.vue`](../../frontend/src/views/maintenance/MtifList.vue)                               | å·¥å–®åˆ—è¡¨ (æ”¯æ´æ­·å²æ¨¡å¼) |
| [`MtifForm.vue`](../../frontend/src/views/maintenance/MtifForm.vue)                               | å·¥å–®è¡¨å–®                |
| [`MaintenanceStaffList.vue`](../../frontend/src/views/maintenance/MaintenanceStaffList.vue)       | äººå“¡åˆ—è¡¨                |
| [`MaintenanceStaffForm.vue`](../../frontend/src/views/maintenance/MaintenanceStaffForm.vue)       | äººå“¡è¡¨å–®                |
| [`MaintenanceStaffHistory.vue`](../../frontend/src/views/maintenance/MaintenanceStaffHistory.vue) | äººå“¡æ­·å²                |

### ç§Ÿå€Ÿè¨‚å–®æ¨¡çµ„ (`views/rec/`)

| æª”æ¡ˆ                                                                          | èªªæ˜         |
| ----------------------------------------------------------------------------- | ------------ |
| [`RecRentManagement.vue`](../../frontend/src/views/rec/RecRentManagement.vue) | è¨‚å–®ç®¡ç†ä¸»é  |

### ç§Ÿå€Ÿè¨‚å–®å…ƒä»¶ (`components/rec/`)

| æª”æ¡ˆ                                                                                   | èªªæ˜         |
| -------------------------------------------------------------------------------------- | ------------ |
| [`RecRentAdd.vue`](../../frontend/src/components/rec/RecRentAdd.vue)                   | æ–°å¢è¨‚å–®è¡¨å–® |
| [`RecRentUserOrder.vue`](../../frontend/src/components/rec/RecRentUserOrder.vue)       | ä½¿ç”¨è€…ä¸‹å–®   |
| [`RecRentUserComplete.vue`](../../frontend/src/components/rec/RecRentUserComplete.vue) | ä½¿ç”¨è€…æ­¸é‚„   |

### å•†å®¶èˆ‡å„ªæƒ åˆ¸æ¨¡çµ„ (`views/merchantAndCoupon/`)

| æª”æ¡ˆ                                                                              | èªªæ˜       |
| --------------------------------------------------------------------------------- | ---------- |
| [`MerchantList.vue`](../../frontend/src/views/merchantAndCoupon/MerchantList.vue) | å•†å®¶ç®¡ç†   |
| [`DiscountList.vue`](../../frontend/src/views/merchantAndCoupon/DiscountList.vue) | å„ªæƒ åˆ¸ç®¡ç† |

---

## ğŸ“‚ å‰ç«¯ API æ¨¡çµ„ç´¢å¼•

### æ ¸å¿ƒè¨­å®š

| æª”æ¡ˆ                                         | è·¯å¾‘       | èªªæ˜                   |
| -------------------------------------------- | ---------- | ---------------------- |
| [`Axios.js`](../../frontend/src/js/Axios.js) | `src/js/`  | Axios å…¨åŸŸè¨­å®šã€æ””æˆªå™¨ |
| [`http.js`](../../frontend/src/api/http.js)  | `src/api/` | HTTP å®¢æˆ¶ç«¯å°è£ (é ç•™) |

### Vite Proxy è¨­å®š

> æª”æ¡ˆä½ç½®: [`frontend/vite.config.js`](../../frontend/vite.config.js)

| Proxy Path | Target                  | èªªæ˜                        |
| ---------- | ----------------------- | --------------------------- |
| `/login`   | `http://localhost:8080` | ç™»å…¥è«‹æ±‚                    |
| `/seat`    | `http://localhost:8080` | åº§ä½ API                    |
| `/api`     | `http://localhost:8080` | é€šç”¨ API (ç§»é™¤ `/api` å‰ç¶´) |
| `/images`  | `http://localhost:8080` | åœ–ç‰‡è³‡æº                    |

---

## ğŸ”„ ç‹€æ…‹æµè½‰åƒè€ƒ

### ç¶­ä¿®å·¥å–®ç‹€æ…‹ (`issueStatus`)

```
REPORTED (å·²é€šå ±)
    â”‚
    â–¼ [assign]
ASSIGNED (å·²æŒ‡æ´¾)
    â”‚
    â–¼ [start]
UNDER_MAINTENANCE (ç¶­ä¿®ä¸­)
    â”‚
    â”œâ”€â”€â–¶ [resolve] â”€â”€â–¶ RESOLVED (å·²å®Œæˆ)
    â”‚
    â””â”€â”€â–¶ [cancel] â”€â”€â–¶ CANCELLED (å·²å–æ¶ˆ)
```

### å·¥å–®å„ªå…ˆç´š (`issuePriority`)

| å€¼       | ä¸­æ–‡ | èªªæ˜       |
| -------- | ---- | ---------- |
| `LOW`    | ä½   | å¯å»¶å¾Œè™•ç† |
| `NORMAL` | æ™®é€š | ä¸€èˆ¬è™•ç†   |
| `HIGH`   | é«˜   | å„ªå…ˆè™•ç†   |
| `URGENT` | ç·Šæ€¥ | ç«‹å³è™•ç†   |

### ç§Ÿå€Ÿè¨‚å–®ç‹€æ…‹ (`recStatus`)

| å€¼       | èªªæ˜         |
| -------- | ------------ |
| `ç§Ÿå€Ÿä¸­` | é€²è¡Œä¸­çš„ç§Ÿå€Ÿ |
| `å·²å®Œæˆ` | å·²æ­¸é‚„       |
| `å·²å–æ¶ˆ` | è¨‚å–®å–æ¶ˆ     |

---

## ğŸ› ï¸ é–‹ç™¼å¿«é€ŸæŒ‡ä»¤

### å¾Œç«¯

```bash
# åŸ·è¡Œæ¸¬è©¦
./mvnw test

# æ‰“åŒ…
./mvnw package -DskipTests

# æ¸…é™¤ä¸¦é‡å»º
./mvnw clean install
```

### å‰ç«¯

```bash
# é–‹ç™¼æ¨¡å¼
npm run dev

# å»ºç½®ç”Ÿç”¢ç‰ˆæœ¬
npm run build

# ESLint æª¢æŸ¥
npm run lint

# æ ¼å¼åŒ–ç¨‹å¼ç¢¼
npm run format
```

---

## ğŸ“‹ Code Review Checklist

### å¾Œç«¯

- [ ] Controller æ˜¯å¦åŠ ä¸Š `@CrossOrigin` æˆ–ä½¿ç”¨å…¨åŸŸ CORS
- [ ] æ˜¯å¦ä½¿ç”¨å»ºæ§‹å­æ³¨å…¥å–ä»£ `@Autowired`
- [ ] Service å±¤æ˜¯å¦åŒ…å«æ¥­å‹™é‚è¼¯
- [ ] Repository æ˜¯å¦åªè™•ç†è³‡æ–™å­˜å–
- [ ] ä¾‹å¤–è™•ç†æ˜¯å¦å®Œæ•´

### å‰ç«¯

- [ ] æ˜¯å¦ç§»é™¤æœªä½¿ç”¨è®Šæ•¸ (ESLint)
- [ ] API å‘¼å«æ˜¯å¦ä½¿ç”¨ `/api` å‰ç¶´
- [ ] æ˜¯å¦è™•ç† loading èˆ‡ error ç‹€æ…‹
- [ ] å…ƒä»¶æ˜¯å¦ä½¿ç”¨ Composition API
- [ ] è·¯ç”±æ˜¯å¦æ­£ç¢ºè¨­å®š

---

## ğŸ”— ç›¸é—œæ–‡ä»¶

- [å°ˆæ¡ˆæ¶æ§‹ç¸½è¦½](./PROJECT_MAP.md)
- [è³‡æ–™åº«è…³æœ¬](../db/all/ç¬¬ä¸‰çµ„SQè³‡æ–™.sql)
- [README](../../README.md)
</file>

<file path="backend/docs/PROJECT_MAP.md">
# ğŸ—ºï¸ SeatRentSys å°ˆæ¡ˆæ¶æ§‹ç¸½è¦½

> æœ€å¾Œæ›´æ–°ï¼š2025-01

---

## ğŸ“ ç›®éŒ„çµæ§‹

```
SeatRentSys/
â”œâ”€â”€ backend/                    # Spring Boot å¾Œç«¯
â”‚   â”œâ”€â”€ src/main/java/com/example/backend/
â”‚   â”‚   â”œâ”€â”€ config/             # å…¨åŸŸè¨­å®š (CORSã€éœæ…‹è³‡æº)
â”‚   â”‚   â”œâ”€â”€ controller/         # REST API æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ model/              # JPA Entity å¯¦é«”é¡åˆ¥
â”‚   â”‚   â”œâ”€â”€ repository/         # Spring Data JPA Repository
â”‚   â”‚   â”œâ”€â”€ service/            # æ¥­å‹™é‚è¼¯å±¤
â”‚   â”‚   â”œâ”€â”€ integration/        # å¤–éƒ¨ API æ•´åˆ (é ç•™)
â”‚   â”‚   â””â”€â”€ utils/              # å·¥å…·é¡åˆ¥
â”‚   â”œâ”€â”€ db/                     # SQL è…³æœ¬
â”‚   â”‚   â”œâ”€â”€ all/                # å®Œæ•´è³‡æ–™åº«å»ºç«‹è…³æœ¬
â”‚   â”‚   â”œâ”€â”€ schema/             # è¡¨çµæ§‹å®šç¾©
â”‚   â”‚   â””â”€â”€ seed/               # æ¸¬è©¦è³‡æ–™
â”‚   â””â”€â”€ docs/                   # å¾Œç«¯æ–‡ä»¶
â”‚
â”œâ”€â”€ frontend/                   # Vue 3 å‰ç«¯
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ api/                # Axios å°è£èˆ‡æ¨¡çµ„åŒ– API
â”‚   â”‚   â”œâ”€â”€ assets/             # éœæ…‹è³‡æº (CSS)
â”‚   â”‚   â”œâ”€â”€ components/         # å¯é‡ç”¨å…ƒä»¶
â”‚   â”‚   â”œâ”€â”€ router/             # Vue Router è·¯ç”±è¨­å®š
â”‚   â”‚   â”œâ”€â”€ views/              # é é¢å…ƒä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ member/         # æœƒå“¡èˆ‡å¾Œå°æ¡†æ¶
â”‚   â”‚   â”‚   â”œâ”€â”€ spot/           # æ“šé»èˆ‡åº§ä½ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ rec/            # ç§Ÿå€Ÿè¨‚å–®ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ maintenance/    # ç¶­ä¿®ç®¡ç†
â”‚   â”‚   â”‚   â””â”€â”€ merchantAndCoupon/ # å•†å®¶èˆ‡å„ªæƒ åˆ¸
â”‚   â”‚   â””â”€â”€ main.js             # Vue æ‡‰ç”¨ç¨‹å¼å…¥å£
â”‚   â””â”€â”€ public/vendor/          # AdminLTE éœæ…‹è³‡æº
â”‚
â”œâ”€â”€ uploads/                    # åœ–ç‰‡ä¸Šå‚³ç›®éŒ„
â””â”€â”€ images/                     # åœ–ç‰‡è³‡æº
```

---

## ğŸš€ å•Ÿå‹•æ–¹å¼

### å¾Œç«¯ (Spring Boot)

```bash
cd backend
./mvnw spring-boot:run
# æˆ–ä½¿ç”¨ IDE åŸ·è¡Œ BackendApplication.java
```

- **é è¨­åŸ è™Ÿ**: `8080`
- **å¥åº·æª¢æŸ¥**: `GET http://localhost:8080/test`

### å‰ç«¯ (Vue 3 + Vite)

```bash
cd frontend
npm install
npm run dev
```

- **é è¨­åŸ è™Ÿ**: `5173`
- **é¦–é **: `http://localhost:5173/login`

---

## âš™ï¸ ç’°å¢ƒè®Šæ•¸èˆ‡è¨­å®š

### å¾Œç«¯ (`application.yml`)

| è®Šæ•¸åç¨±                     | èªªæ˜                | é è¨­å€¼       |
| ---------------------------- | ------------------- | ------------ |
| `spring.datasource.url`      | SQL Server é€£ç·šå­—ä¸² | -            |
| `spring.datasource.username` | è³‡æ–™åº«å¸³è™Ÿ          | -            |
| `spring.datasource.password` | è³‡æ–™åº«å¯†ç¢¼          | -            |
| `app.file.upload-path`       | åœ–ç‰‡ä¸Šå‚³è·¯å¾‘        | `./uploads/` |
| `app.tools.db-print`         | å•Ÿç”¨è³‡æ–™åº«åˆ—å°å·¥å…·  | `false`      |

### å‰ç«¯ (`vite.config.js`)

| è¨­å®šé …                 | èªªæ˜                                  |
| ---------------------- | ------------------------------------- |
| `server.proxy./api`    | ä»£ç†è‡³å¾Œç«¯ 8080ï¼Œè‡ªå‹•ç§»é™¤ `/api` å‰ç¶´ |
| `server.proxy./login`  | ç™»å…¥è«‹æ±‚ä»£ç†                          |
| `server.proxy./seat`   | åº§ä½ API ä»£ç†                         |
| `server.proxy./images` | åœ–ç‰‡è³‡æºä»£ç†                          |

---

## ğŸ“¦ ä¸»è¦æ¨¡çµ„

### 1. æœƒå“¡ç®¡ç† (Member)

- **åŠŸèƒ½**: æœƒå“¡ CRUDã€ç™»å…¥é©—è­‰
- **å¾Œç«¯**: `/members/*`
- **å‰ç«¯**: `/admin/members`

### 2. æ“šé»ç®¡ç† (Spot)

- **åŠŸèƒ½**: ç§Ÿå€Ÿé»ä½ CRUDã€ç‹€æ…‹ç®¡ç†
- **å¾Œç«¯**: `/api/spot/*`
- **å‰ç«¯**: `/admin/spot/list`

### 3. åº§ä½ç®¡ç† (Seat)

- **åŠŸèƒ½**: è¨­å‚™ CRUDã€æ¢ä»¶æŸ¥è©¢
- **å¾Œç«¯**: `/api/seat/*`
- **å‰ç«¯**: `/admin/seat/list`

### 4. ç¶­ä¿®ç®¡ç† (Maintenance)

- **åŠŸèƒ½**: å·¥å–® CRUDã€ç‹€æ…‹æµè½‰ã€äººå“¡æŒ‡æ´¾
- **å¾Œç«¯**: `/api/maintenance/*`
- **å‰ç«¯**: `/admin/mtif-list`, `/admin/staff-list`

### 5. ç§Ÿå€Ÿè¨‚å–® (RecRent)

- **åŠŸèƒ½**: è¨‚å–® CRUDã€ä½¿ç”¨è€…ä¸‹å–®èˆ‡æ­¸é‚„
- **å¾Œç«¯**: `/api/rec-rents/*`
- **å‰ç«¯**: `/admin/rec-rent`

### 6. å•†å®¶èˆ‡å„ªæƒ åˆ¸ (Merchant & Discount)

- **åŠŸèƒ½**: å•†å®¶ CRUDã€å„ªæƒ åˆ¸ç®¡ç†
- **å¾Œç«¯**: `/api/merchants/*`, `/api/discounts/*`
- **å‰ç«¯**: `/admin/merchants`, `/admin/discounts`

---

## ğŸ”Œ ä¸»è¦ API ç«¯é»

### æœƒå“¡ API

| Method | Endpoint                     | èªªæ˜         |
| ------ | ---------------------------- | ------------ |
| GET    | `/members`                   | æŸ¥è©¢å…¨éƒ¨æœƒå“¡ |
| GET    | `/members/find?memId={id}`   | æŸ¥è©¢å–®ç­†æœƒå“¡ |
| POST   | `/members`                   | æ–°å¢æœƒå“¡     |
| POST   | `/members/update`            | æ›´æ–°æœƒå“¡     |
| GET    | `/members/delete?memId={id}` | åˆªé™¤æœƒå“¡     |

### æ“šé» API

| Method | Endpoint            | èªªæ˜         |
| ------ | ------------------- | ------------ |
| GET    | `/spot/list`        | æŸ¥è©¢å…¨éƒ¨æ“šé» |
| GET    | `/spot/condition`   | æ¢ä»¶æŸ¥è©¢æ“šé» |
| POST   | `/spot/insert`      | æ–°å¢æ“šé»     |
| PUT    | `/spot/update`      | æ›´æ–°æ“šé»     |
| DELETE | `/spot/delete/{id}` | åˆªé™¤æ“šé»     |

### åº§ä½ API

| Method | Endpoint            | èªªæ˜         |
| ------ | ------------------- | ------------ |
| GET    | `/seat/list`        | æŸ¥è©¢å…¨éƒ¨åº§ä½ |
| GET    | `/seat/condition`   | æ¢ä»¶æŸ¥è©¢åº§ä½ |
| POST   | `/seat/insert`      | æ–°å¢åº§ä½     |
| PUT    | `/seat/update`      | æ›´æ–°åº§ä½     |
| DELETE | `/seat/delete/{id}` | åˆªé™¤åº§ä½     |

### ç¶­ä¿® API

| Method | Endpoint                                | èªªæ˜           |
| ------ | --------------------------------------- | -------------- |
| GET    | `/api/maintenance/staff`                | æŸ¥è©¢ç¶­è­·äººå“¡   |
| POST   | `/api/maintenance/staff`                | æ–°å¢ç¶­è­·äººå“¡   |
| DELETE | `/api/maintenance/staff/{id}`           | åˆªé™¤ç¶­è­·äººå“¡   |
| GET    | `/api/maintenance/tickets`              | æŸ¥è©¢å…¨éƒ¨å·¥å–®   |
| GET    | `/api/maintenance/tickets/active`       | æŸ¥è©¢å¾…è™•ç†å·¥å–® |
| GET    | `/api/maintenance/tickets/history`      | æŸ¥è©¢æ­·å²å·¥å–®   |
| POST   | `/api/maintenance/tickets`              | æ–°å¢å·¥å–®       |
| PUT    | `/api/maintenance/tickets/{id}`         | æ›´æ–°å·¥å–®       |
| POST   | `/api/maintenance/tickets/{id}/assign`  | æŒ‡æ´¾äººå“¡       |
| POST   | `/api/maintenance/tickets/{id}/start`   | é–‹å§‹ç¶­ä¿®       |
| POST   | `/api/maintenance/tickets/{id}/resolve` | çµæ¡ˆ           |
| POST   | `/api/maintenance/tickets/{id}/cancel`  | å–æ¶ˆå·¥å–®       |

### ç§Ÿå€Ÿè¨‚å–® API

| Method | Endpoint                 | èªªæ˜           |
| ------ | ------------------------ | -------------- |
| GET    | `/api/rec-rents`         | æŸ¥è©¢å…¨éƒ¨è¨‚å–®   |
| GET    | `/api/rent-details/all`  | æŸ¥è©¢ç§Ÿå€Ÿæ˜ç´°   |
| GET    | `/api/rent-details/{id}` | ä¾ ID æŸ¥è©¢æ˜ç´° |

---

## ğŸ—„ï¸ è³‡æ–™è¡¨æ¦‚è¦

### æ ¸å¿ƒè¡¨æ ¼

| è¡¨æ ¼åç¨±                 | èªªæ˜       | ä¸»éµ                |
| ------------------------ | ---------- | ------------------- |
| `member`                 | æœƒå“¡è³‡æ–™   | `memId`             |
| `admin`                  | ç®¡ç†å“¡è³‡æ–™ | `admId`             |
| `renting_Spot`           | ç§Ÿå€Ÿæ“šé»   | `spotId`            |
| `seats`                  | åº§ä½è¨­å‚™   | `seatsId`           |
| `recRent`                | ç§Ÿå€Ÿè¨‚å–®   | `recSeqId`, `recId` |
| `merchant`               | åˆä½œå•†å®¶   | `merchantId`        |
| `discount`               | å„ªæƒ åˆ¸     | `couponId`          |
| `maintenanceStaff`       | ç¶­è­·äººå“¡   | `staffId`           |
| `maintenanceInformation` | ç¶­ä¿®å·¥å–®   | `ticketId`          |

### è¡¨æ ¼é—œè¯

```
member â”€â”€â”€â”€â”€â”¬â”€â”€< recRent >â”€â”€â”¬â”€â”€â”€â”€â”€ seats
            â”‚               â”‚
            â”‚               â””â”€â”€â”€â”€â”€ renting_Spot â”€â”€< merchant
            â”‚
maintenanceStaff â”€â”€< maintenanceInformation >â”€â”€ renting_Spot
                                               â”‚
discount â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸»è¦æ¬„ä½èªªæ˜

#### `recRent` (ç§Ÿå€Ÿè¨‚å–®)

- `recId`: è‡ªå‹•ç”Ÿæˆæµæ°´è™Ÿ (æ ¼å¼: R000000001)
- `recStatus`: è¨‚å–®ç‹€æ…‹ (ç§Ÿå€Ÿä¸­/å·²å®Œæˆ/å·²å–æ¶ˆ)
- `recRentDT2` / `recReturnDT2`: ç§Ÿå€Ÿ/æ­¸é‚„æ™‚é–“

#### `maintenanceInformation` (ç¶­ä¿®å·¥å–®)

- `issueStatus`: ç‹€æ…‹æµè½‰ (REPORTED â†’ ASSIGNED â†’ UNDER_MAINTENANCE â†’ RESOLVED/CANCELLED)
- `issuePriority`: å„ªå…ˆç´š (LOW/NORMAL/HIGH/URGENT)

---

## ğŸ” CORS è¨­å®š

å¾Œç«¯å…è¨±å‰ç«¯ `http://localhost:5173` è·¨åŸŸå­˜å–ï¼Œè¨­å®šæ–¼ï¼š

- `WebConfig.java` - å…¨åŸŸ CORS
- å„ Controller `@CrossOrigin` è¨»è§£

---

## ğŸ“ é–‹ç™¼æ³¨æ„äº‹é …

1. **API å‰ç¶´**: å‰ç«¯å‘¼å«æ™‚åŠ ä¸Š `/api`ï¼ŒVite æœƒè‡ªå‹•ä»£ç†ä¸¦ç§»é™¤
2. **åœ–ç‰‡ä¸Šå‚³**: å­˜æ”¾æ–¼ `uploads/`ï¼Œé€é `/images/**` å­˜å–
3. **å»ºæ§‹å­æ³¨å…¥**: æ¨è–¦ä½¿ç”¨å»ºæ§‹å­æ³¨å…¥å–ä»£ `@Autowired`
4. **ESLint**: å‰ç«¯å·²å•Ÿç”¨ ESLintï¼Œè«‹ç¢ºä¿ç„¡æœªä½¿ç”¨è®Šæ•¸
</file>

<file path="backend/mvnw">
#!/bin/sh
# ----------------------------------------------------------------------------
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
# ----------------------------------------------------------------------------

# ----------------------------------------------------------------------------
# Apache Maven Wrapper startup batch script, version 3.3.4
#
# Optional ENV vars
# -----------------
#   JAVA_HOME - location of a JDK home dir, required when download maven via java source
#   MVNW_REPOURL - repo url base for downloading maven distribution
#   MVNW_USERNAME/MVNW_PASSWORD - user and password for downloading maven
#   MVNW_VERBOSE - true: enable verbose log; debug: trace the mvnw script; others: silence the output
# ----------------------------------------------------------------------------

set -euf
[ "${MVNW_VERBOSE-}" != debug ] || set -x

# OS specific support.
native_path() { printf %s\\n "$1"; }
case "$(uname)" in
CYGWIN* | MINGW*)
  [ -z "${JAVA_HOME-}" ] || JAVA_HOME="$(cygpath --unix "$JAVA_HOME")"
  native_path() { cygpath --path --windows "$1"; }
  ;;
esac

# set JAVACMD and JAVACCMD
set_java_home() {
  # For Cygwin and MinGW, ensure paths are in Unix format before anything is touched
  if [ -n "${JAVA_HOME-}" ]; then
    if [ -x "$JAVA_HOME/jre/sh/java" ]; then
      # IBM's JDK on AIX uses strange locations for the executables
      JAVACMD="$JAVA_HOME/jre/sh/java"
      JAVACCMD="$JAVA_HOME/jre/sh/javac"
    else
      JAVACMD="$JAVA_HOME/bin/java"
      JAVACCMD="$JAVA_HOME/bin/javac"

      if [ ! -x "$JAVACMD" ] || [ ! -x "$JAVACCMD" ]; then
        echo "The JAVA_HOME environment variable is not defined correctly, so mvnw cannot run." >&2
        echo "JAVA_HOME is set to \"$JAVA_HOME\", but \"\$JAVA_HOME/bin/java\" or \"\$JAVA_HOME/bin/javac\" does not exist." >&2
        return 1
      fi
    fi
  else
    JAVACMD="$(
      'set' +e
      'unset' -f command 2>/dev/null
      'command' -v java
    )" || :
    JAVACCMD="$(
      'set' +e
      'unset' -f command 2>/dev/null
      'command' -v javac
    )" || :

    if [ ! -x "${JAVACMD-}" ] || [ ! -x "${JAVACCMD-}" ]; then
      echo "The java/javac command does not exist in PATH nor is JAVA_HOME set, so mvnw cannot run." >&2
      return 1
    fi
  fi
}

# hash string like Java String::hashCode
hash_string() {
  str="${1:-}" h=0
  while [ -n "$str" ]; do
    char="${str%"${str#?}"}"
    h=$(((h * 31 + $(LC_CTYPE=C printf %d "'$char")) % 4294967296))
    str="${str#?}"
  done
  printf %x\\n $h
}

verbose() { :; }
[ "${MVNW_VERBOSE-}" != true ] || verbose() { printf %s\\n "${1-}"; }

die() {
  printf %s\\n "$1" >&2
  exit 1
}

trim() {
  # MWRAPPER-139:
  #   Trims trailing and leading whitespace, carriage returns, tabs, and linefeeds.
  #   Needed for removing poorly interpreted newline sequences when running in more
  #   exotic environments such as mingw bash on Windows.
  printf "%s" "${1}" | tr -d '[:space:]'
}

scriptDir="$(dirname "$0")"
scriptName="$(basename "$0")"

# parse distributionUrl and optional distributionSha256Sum, requires .mvn/wrapper/maven-wrapper.properties
while IFS="=" read -r key value; do
  case "${key-}" in
  distributionUrl) distributionUrl=$(trim "${value-}") ;;
  distributionSha256Sum) distributionSha256Sum=$(trim "${value-}") ;;
  esac
done <"$scriptDir/.mvn/wrapper/maven-wrapper.properties"
[ -n "${distributionUrl-}" ] || die "cannot read distributionUrl property in $scriptDir/.mvn/wrapper/maven-wrapper.properties"

case "${distributionUrl##*/}" in
maven-mvnd-*bin.*)
  MVN_CMD=mvnd.sh _MVNW_REPO_PATTERN=/maven/mvnd/
  case "${PROCESSOR_ARCHITECTURE-}${PROCESSOR_ARCHITEW6432-}:$(uname -a)" in
  *AMD64:CYGWIN* | *AMD64:MINGW*) distributionPlatform=windows-amd64 ;;
  :Darwin*x86_64) distributionPlatform=darwin-amd64 ;;
  :Darwin*arm64) distributionPlatform=darwin-aarch64 ;;
  :Linux*x86_64*) distributionPlatform=linux-amd64 ;;
  *)
    echo "Cannot detect native platform for mvnd on $(uname)-$(uname -m), use pure java version" >&2
    distributionPlatform=linux-amd64
    ;;
  esac
  distributionUrl="${distributionUrl%-bin.*}-$distributionPlatform.zip"
  ;;
maven-mvnd-*) MVN_CMD=mvnd.sh _MVNW_REPO_PATTERN=/maven/mvnd/ ;;
*) MVN_CMD="mvn${scriptName#mvnw}" _MVNW_REPO_PATTERN=/org/apache/maven/ ;;
esac

# apply MVNW_REPOURL and calculate MAVEN_HOME
# maven home pattern: ~/.m2/wrapper/dists/{apache-maven-<version>,maven-mvnd-<version>-<platform>}/<hash>
[ -z "${MVNW_REPOURL-}" ] || distributionUrl="$MVNW_REPOURL$_MVNW_REPO_PATTERN${distributionUrl#*"$_MVNW_REPO_PATTERN"}"
distributionUrlName="${distributionUrl##*/}"
distributionUrlNameMain="${distributionUrlName%.*}"
distributionUrlNameMain="${distributionUrlNameMain%-bin}"
MAVEN_USER_HOME="${MAVEN_USER_HOME:-${HOME}/.m2}"
MAVEN_HOME="${MAVEN_USER_HOME}/wrapper/dists/${distributionUrlNameMain-}/$(hash_string "$distributionUrl")"

exec_maven() {
  unset MVNW_VERBOSE MVNW_USERNAME MVNW_PASSWORD MVNW_REPOURL || :
  exec "$MAVEN_HOME/bin/$MVN_CMD" "$@" || die "cannot exec $MAVEN_HOME/bin/$MVN_CMD"
}

if [ -d "$MAVEN_HOME" ]; then
  verbose "found existing MAVEN_HOME at $MAVEN_HOME"
  exec_maven "$@"
fi

case "${distributionUrl-}" in
*?-bin.zip | *?maven-mvnd-?*-?*.zip) ;;
*) die "distributionUrl is not valid, must match *-bin.zip or maven-mvnd-*.zip, but found '${distributionUrl-}'" ;;
esac

# prepare tmp dir
if TMP_DOWNLOAD_DIR="$(mktemp -d)" && [ -d "$TMP_DOWNLOAD_DIR" ]; then
  clean() { rm -rf -- "$TMP_DOWNLOAD_DIR"; }
  trap clean HUP INT TERM EXIT
else
  die "cannot create temp dir"
fi

mkdir -p -- "${MAVEN_HOME%/*}"

# Download and Install Apache Maven
verbose "Couldn't find MAVEN_HOME, downloading and installing it ..."
verbose "Downloading from: $distributionUrl"
verbose "Downloading to: $TMP_DOWNLOAD_DIR/$distributionUrlName"

# select .zip or .tar.gz
if ! command -v unzip >/dev/null; then
  distributionUrl="${distributionUrl%.zip}.tar.gz"
  distributionUrlName="${distributionUrl##*/}"
fi

# verbose opt
__MVNW_QUIET_WGET=--quiet __MVNW_QUIET_CURL=--silent __MVNW_QUIET_UNZIP=-q __MVNW_QUIET_TAR=''
[ "${MVNW_VERBOSE-}" != true ] || __MVNW_QUIET_WGET='' __MVNW_QUIET_CURL='' __MVNW_QUIET_UNZIP='' __MVNW_QUIET_TAR=v

# normalize http auth
case "${MVNW_PASSWORD:+has-password}" in
'') MVNW_USERNAME='' MVNW_PASSWORD='' ;;
has-password) [ -n "${MVNW_USERNAME-}" ] || MVNW_USERNAME='' MVNW_PASSWORD='' ;;
esac

if [ -z "${MVNW_USERNAME-}" ] && command -v wget >/dev/null; then
  verbose "Found wget ... using wget"
  wget ${__MVNW_QUIET_WGET:+"$__MVNW_QUIET_WGET"} "$distributionUrl" -O "$TMP_DOWNLOAD_DIR/$distributionUrlName" || die "wget: Failed to fetch $distributionUrl"
elif [ -z "${MVNW_USERNAME-}" ] && command -v curl >/dev/null; then
  verbose "Found curl ... using curl"
  curl ${__MVNW_QUIET_CURL:+"$__MVNW_QUIET_CURL"} -f -L -o "$TMP_DOWNLOAD_DIR/$distributionUrlName" "$distributionUrl" || die "curl: Failed to fetch $distributionUrl"
elif set_java_home; then
  verbose "Falling back to use Java to download"
  javaSource="$TMP_DOWNLOAD_DIR/Downloader.java"
  targetZip="$TMP_DOWNLOAD_DIR/$distributionUrlName"
  cat >"$javaSource" <<-END
	public class Downloader extends java.net.Authenticator
	{
	  protected java.net.PasswordAuthentication getPasswordAuthentication()
	  {
	    return new java.net.PasswordAuthentication( System.getenv( "MVNW_USERNAME" ), System.getenv( "MVNW_PASSWORD" ).toCharArray() );
	  }
	  public static void main( String[] args ) throws Exception
	  {
	    setDefault( new Downloader() );
	    java.nio.file.Files.copy( java.net.URI.create( args[0] ).toURL().openStream(), java.nio.file.Paths.get( args[1] ).toAbsolutePath().normalize() );
	  }
	}
	END
  # For Cygwin/MinGW, switch paths to Windows format before running javac and java
  verbose " - Compiling Downloader.java ..."
  "$(native_path "$JAVACCMD")" "$(native_path "$javaSource")" || die "Failed to compile Downloader.java"
  verbose " - Running Downloader.java ..."
  "$(native_path "$JAVACMD")" -cp "$(native_path "$TMP_DOWNLOAD_DIR")" Downloader "$distributionUrl" "$(native_path "$targetZip")"
fi

# If specified, validate the SHA-256 sum of the Maven distribution zip file
if [ -n "${distributionSha256Sum-}" ]; then
  distributionSha256Result=false
  if [ "$MVN_CMD" = mvnd.sh ]; then
    echo "Checksum validation is not supported for maven-mvnd." >&2
    echo "Please disable validation by removing 'distributionSha256Sum' from your maven-wrapper.properties." >&2
    exit 1
  elif command -v sha256sum >/dev/null; then
    if echo "$distributionSha256Sum  $TMP_DOWNLOAD_DIR/$distributionUrlName" | sha256sum -c - >/dev/null 2>&1; then
      distributionSha256Result=true
    fi
  elif command -v shasum >/dev/null; then
    if echo "$distributionSha256Sum  $TMP_DOWNLOAD_DIR/$distributionUrlName" | shasum -a 256 -c >/dev/null 2>&1; then
      distributionSha256Result=true
    fi
  else
    echo "Checksum validation was requested but neither 'sha256sum' or 'shasum' are available." >&2
    echo "Please install either command, or disable validation by removing 'distributionSha256Sum' from your maven-wrapper.properties." >&2
    exit 1
  fi
  if [ $distributionSha256Result = false ]; then
    echo "Error: Failed to validate Maven distribution SHA-256, your Maven distribution might be compromised." >&2
    echo "If you updated your Maven version, you need to update the specified distributionSha256Sum property." >&2
    exit 1
  fi
fi

# unzip and move
if command -v unzip >/dev/null; then
  unzip ${__MVNW_QUIET_UNZIP:+"$__MVNW_QUIET_UNZIP"} "$TMP_DOWNLOAD_DIR/$distributionUrlName" -d "$TMP_DOWNLOAD_DIR" || die "failed to unzip"
else
  tar xzf${__MVNW_QUIET_TAR:+"$__MVNW_QUIET_TAR"} "$TMP_DOWNLOAD_DIR/$distributionUrlName" -C "$TMP_DOWNLOAD_DIR" || die "failed to untar"
fi

# Find the actual extracted directory name (handles snapshots where filename != directory name)
actualDistributionDir=""

# First try the expected directory name (for regular distributions)
if [ -d "$TMP_DOWNLOAD_DIR/$distributionUrlNameMain" ]; then
  if [ -f "$TMP_DOWNLOAD_DIR/$distributionUrlNameMain/bin/$MVN_CMD" ]; then
    actualDistributionDir="$distributionUrlNameMain"
  fi
fi

# If not found, search for any directory with the Maven executable (for snapshots)
if [ -z "$actualDistributionDir" ]; then
  # enable globbing to iterate over items
  set +f
  for dir in "$TMP_DOWNLOAD_DIR"/*; do
    if [ -d "$dir" ]; then
      if [ -f "$dir/bin/$MVN_CMD" ]; then
        actualDistributionDir="$(basename "$dir")"
        break
      fi
    fi
  done
  set -f
fi

if [ -z "$actualDistributionDir" ]; then
  verbose "Contents of $TMP_DOWNLOAD_DIR:"
  verbose "$(ls -la "$TMP_DOWNLOAD_DIR")"
  die "Could not find Maven distribution directory in extracted archive"
fi

verbose "Found extracted Maven distribution directory: $actualDistributionDir"
printf %s\\n "$distributionUrl" >"$TMP_DOWNLOAD_DIR/$actualDistributionDir/mvnw.url"
mv -- "$TMP_DOWNLOAD_DIR/$actualDistributionDir" "$MAVEN_HOME" || [ -d "$MAVEN_HOME" ] || die "fail to move MAVEN_HOME"

clean || :
exec_maven "$@"
</file>

<file path="backend/mvnw.cmd">
<# : batch portion
@REM ----------------------------------------------------------------------------
@REM Licensed to the Apache Software Foundation (ASF) under one
@REM or more contributor license agreements.  See the NOTICE file
@REM distributed with this work for additional information
@REM regarding copyright ownership.  The ASF licenses this file
@REM to you under the Apache License, Version 2.0 (the
@REM "License"); you may not use this file except in compliance
@REM with the License.  You may obtain a copy of the License at
@REM
@REM    http://www.apache.org/licenses/LICENSE-2.0
@REM
@REM Unless required by applicable law or agreed to in writing,
@REM software distributed under the License is distributed on an
@REM "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
@REM KIND, either express or implied.  See the License for the
@REM specific language governing permissions and limitations
@REM under the License.
@REM ----------------------------------------------------------------------------

@REM ----------------------------------------------------------------------------
@REM Apache Maven Wrapper startup batch script, version 3.3.4
@REM
@REM Optional ENV vars
@REM   MVNW_REPOURL - repo url base for downloading maven distribution
@REM   MVNW_USERNAME/MVNW_PASSWORD - user and password for downloading maven
@REM   MVNW_VERBOSE - true: enable verbose log; others: silence the output
@REM ----------------------------------------------------------------------------

@IF "%__MVNW_ARG0_NAME__%"=="" (SET __MVNW_ARG0_NAME__=%~nx0)
@SET __MVNW_CMD__=
@SET __MVNW_ERROR__=
@SET __MVNW_PSMODULEP_SAVE=%PSModulePath%
@SET PSModulePath=
@FOR /F "usebackq tokens=1* delims==" %%A IN (`powershell -noprofile "& {$scriptDir='%~dp0'; $script='%__MVNW_ARG0_NAME__%'; icm -ScriptBlock ([Scriptblock]::Create((Get-Content -Raw '%~f0'))) -NoNewScope}"`) DO @(
  IF "%%A"=="MVN_CMD" (set __MVNW_CMD__=%%B) ELSE IF "%%B"=="" (echo %%A) ELSE (echo %%A=%%B)
)
@SET PSModulePath=%__MVNW_PSMODULEP_SAVE%
@SET __MVNW_PSMODULEP_SAVE=
@SET __MVNW_ARG0_NAME__=
@SET MVNW_USERNAME=
@SET MVNW_PASSWORD=
@IF NOT "%__MVNW_CMD__%"=="" ("%__MVNW_CMD__%" %*)
@echo Cannot start maven from wrapper >&2 && exit /b 1
@GOTO :EOF
: end batch / begin powershell #>

$ErrorActionPreference = "Stop"
if ($env:MVNW_VERBOSE -eq "true") {
  $VerbosePreference = "Continue"
}

# calculate distributionUrl, requires .mvn/wrapper/maven-wrapper.properties
$distributionUrl = (Get-Content -Raw "$scriptDir/.mvn/wrapper/maven-wrapper.properties" | ConvertFrom-StringData).distributionUrl
if (!$distributionUrl) {
  Write-Error "cannot read distributionUrl property in $scriptDir/.mvn/wrapper/maven-wrapper.properties"
}

switch -wildcard -casesensitive ( $($distributionUrl -replace '^.*/','') ) {
  "maven-mvnd-*" {
    $USE_MVND = $true
    $distributionUrl = $distributionUrl -replace '-bin\.[^.]*$',"-windows-amd64.zip"
    $MVN_CMD = "mvnd.cmd"
    break
  }
  default {
    $USE_MVND = $false
    $MVN_CMD = $script -replace '^mvnw','mvn'
    break
  }
}

# apply MVNW_REPOURL and calculate MAVEN_HOME
# maven home pattern: ~/.m2/wrapper/dists/{apache-maven-<version>,maven-mvnd-<version>-<platform>}/<hash>
if ($env:MVNW_REPOURL) {
  $MVNW_REPO_PATTERN = if ($USE_MVND -eq $False) { "/org/apache/maven/" } else { "/maven/mvnd/" }
  $distributionUrl = "$env:MVNW_REPOURL$MVNW_REPO_PATTERN$($distributionUrl -replace "^.*$MVNW_REPO_PATTERN",'')"
}
$distributionUrlName = $distributionUrl -replace '^.*/',''
$distributionUrlNameMain = $distributionUrlName -replace '\.[^.]*$','' -replace '-bin$',''

$MAVEN_M2_PATH = "$HOME/.m2"
if ($env:MAVEN_USER_HOME) {
  $MAVEN_M2_PATH = "$env:MAVEN_USER_HOME"
}

if (-not (Test-Path -Path $MAVEN_M2_PATH)) {
    New-Item -Path $MAVEN_M2_PATH -ItemType Directory | Out-Null
}

$MAVEN_WRAPPER_DISTS = $null
if ((Get-Item $MAVEN_M2_PATH).Target[0] -eq $null) {
  $MAVEN_WRAPPER_DISTS = "$MAVEN_M2_PATH/wrapper/dists"
} else {
  $MAVEN_WRAPPER_DISTS = (Get-Item $MAVEN_M2_PATH).Target[0] + "/wrapper/dists"
}

$MAVEN_HOME_PARENT = "$MAVEN_WRAPPER_DISTS/$distributionUrlNameMain"
$MAVEN_HOME_NAME = ([System.Security.Cryptography.SHA256]::Create().ComputeHash([byte[]][char[]]$distributionUrl) | ForEach-Object {$_.ToString("x2")}) -join ''
$MAVEN_HOME = "$MAVEN_HOME_PARENT/$MAVEN_HOME_NAME"

if (Test-Path -Path "$MAVEN_HOME" -PathType Container) {
  Write-Verbose "found existing MAVEN_HOME at $MAVEN_HOME"
  Write-Output "MVN_CMD=$MAVEN_HOME/bin/$MVN_CMD"
  exit $?
}

if (! $distributionUrlNameMain -or ($distributionUrlName -eq $distributionUrlNameMain)) {
  Write-Error "distributionUrl is not valid, must end with *-bin.zip, but found $distributionUrl"
}

# prepare tmp dir
$TMP_DOWNLOAD_DIR_HOLDER = New-TemporaryFile
$TMP_DOWNLOAD_DIR = New-Item -Itemtype Directory -Path "$TMP_DOWNLOAD_DIR_HOLDER.dir"
$TMP_DOWNLOAD_DIR_HOLDER.Delete() | Out-Null
trap {
  if ($TMP_DOWNLOAD_DIR.Exists) {
    try { Remove-Item $TMP_DOWNLOAD_DIR -Recurse -Force | Out-Null }
    catch { Write-Warning "Cannot remove $TMP_DOWNLOAD_DIR" }
  }
}

New-Item -Itemtype Directory -Path "$MAVEN_HOME_PARENT" -Force | Out-Null

# Download and Install Apache Maven
Write-Verbose "Couldn't find MAVEN_HOME, downloading and installing it ..."
Write-Verbose "Downloading from: $distributionUrl"
Write-Verbose "Downloading to: $TMP_DOWNLOAD_DIR/$distributionUrlName"

$webclient = New-Object System.Net.WebClient
if ($env:MVNW_USERNAME -and $env:MVNW_PASSWORD) {
  $webclient.Credentials = New-Object System.Net.NetworkCredential($env:MVNW_USERNAME, $env:MVNW_PASSWORD)
}
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
$webclient.DownloadFile($distributionUrl, "$TMP_DOWNLOAD_DIR/$distributionUrlName") | Out-Null

# If specified, validate the SHA-256 sum of the Maven distribution zip file
$distributionSha256Sum = (Get-Content -Raw "$scriptDir/.mvn/wrapper/maven-wrapper.properties" | ConvertFrom-StringData).distributionSha256Sum
if ($distributionSha256Sum) {
  if ($USE_MVND) {
    Write-Error "Checksum validation is not supported for maven-mvnd. `nPlease disable validation by removing 'distributionSha256Sum' from your maven-wrapper.properties."
  }
  Import-Module $PSHOME\Modules\Microsoft.PowerShell.Utility -Function Get-FileHash
  if ((Get-FileHash "$TMP_DOWNLOAD_DIR/$distributionUrlName" -Algorithm SHA256).Hash.ToLower() -ne $distributionSha256Sum) {
    Write-Error "Error: Failed to validate Maven distribution SHA-256, your Maven distribution might be compromised. If you updated your Maven version, you need to update the specified distributionSha256Sum property."
  }
}

# unzip and move
Expand-Archive "$TMP_DOWNLOAD_DIR/$distributionUrlName" -DestinationPath "$TMP_DOWNLOAD_DIR" | Out-Null

# Find the actual extracted directory name (handles snapshots where filename != directory name)
$actualDistributionDir = ""

# First try the expected directory name (for regular distributions)
$expectedPath = Join-Path "$TMP_DOWNLOAD_DIR" "$distributionUrlNameMain"
$expectedMvnPath = Join-Path "$expectedPath" "bin/$MVN_CMD"
if ((Test-Path -Path $expectedPath -PathType Container) -and (Test-Path -Path $expectedMvnPath -PathType Leaf)) {
  $actualDistributionDir = $distributionUrlNameMain
}

# If not found, search for any directory with the Maven executable (for snapshots)
if (!$actualDistributionDir) {
  Get-ChildItem -Path "$TMP_DOWNLOAD_DIR" -Directory | ForEach-Object {
    $testPath = Join-Path $_.FullName "bin/$MVN_CMD"
    if (Test-Path -Path $testPath -PathType Leaf) {
      $actualDistributionDir = $_.Name
    }
  }
}

if (!$actualDistributionDir) {
  Write-Error "Could not find Maven distribution directory in extracted archive"
}

Write-Verbose "Found extracted Maven distribution directory: $actualDistributionDir"
Rename-Item -Path "$TMP_DOWNLOAD_DIR/$actualDistributionDir" -NewName $MAVEN_HOME_NAME | Out-Null
try {
  Move-Item -Path "$TMP_DOWNLOAD_DIR/$MAVEN_HOME_NAME" -Destination $MAVEN_HOME_PARENT | Out-Null
} catch {
  if (! (Test-Path -Path "$MAVEN_HOME" -PathType Container)) {
    Write-Error "fail to move MAVEN_HOME"
  }
} finally {
  try { Remove-Item $TMP_DOWNLOAD_DIR -Recurse -Force | Out-Null }
  catch { Write-Warning "Cannot remove $TMP_DOWNLOAD_DIR" }
}

Write-Output "MVN_CMD=$MAVEN_HOME/bin/$MVN_CMD"
</file>

<file path="backend/src/main/java/com/example/backend/BackendApplication.java">
package com.example.backend;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.scheduling.annotation.EnableScheduling;

@SpringBootApplication
// @EnableScheduling // å•Ÿç”¨ @Scheduled æ’ç¨‹åŠŸèƒ½
public class BackendApplication {

	public static void main(String[] args) {
		SpringApplication.run(BackendApplication.class, args);
	}

};
</file>

<file path="backend/src/main/java/com/example/backend/controller/maintenance/AssetStatsController.java">
package com.example.backend.controller.maintenance;

import com.example.backend.dto.maintenance.AssetStatsResponseDto;
import com.example.backend.service.maintenance.AssetStatsService;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Map;

/**
 * è³‡ç”¢å¥åº·åº¦çµ±è¨ˆ Controller
 * æä¾›æ©Ÿå°(Spot)èˆ‡æ¤…å­(Seat)çš„ç¶­ä¿®/ä¿é¤Šçµ±è¨ˆ API
 */
@RestController
@RequestMapping("/api/maintenance/stats")
@CrossOrigin(origins = "http://localhost:5173")
public class AssetStatsController {

    private final AssetStatsService statsService;

    public AssetStatsController(AssetStatsService statsService) {
        this.statsService = statsService;
    }

    /**
     * å–å¾—è³‡ç”¢å¥åº·åº¦çµ±è¨ˆ
     * GET /api/maintenance/stats/assets?assetType=SPOT|SEAT
     * 
     * @param assetType è³‡ç”¢é¡å‹ï¼šSPOT(æ©Ÿå°) æˆ– SEAT(æ¤…å­)
     * @return è³‡ç”¢çµ±è¨ˆåˆ—è¡¨
     */
    @GetMapping("/assets")
    public ResponseEntity<?> getAssetStats(@RequestParam(required = false) String assetType) {
        // åƒæ•¸é©—è­‰
        if (assetType == null || assetType.isBlank()) {
            return ResponseEntity
                    .status(HttpStatus.BAD_REQUEST)
                    .body(Map.of("error", "ç¼ºå°‘å¿…è¦åƒæ•¸ assetTypeï¼Œè«‹æä¾› SPOT æˆ– SEAT"));
        }

        String type = assetType.trim().toUpperCase();

        switch (type) {
            case "SPOT":
                List<AssetStatsResponseDto> spotStats = statsService.getSpotStats();
                return ResponseEntity.ok(spotStats);

            case "SEAT":
                List<AssetStatsResponseDto> seatStats = statsService.getSeatStats();
                return ResponseEntity.ok(seatStats);

            default:
                return ResponseEntity
                        .status(HttpStatus.BAD_REQUEST)
                        .body(Map.of("error", "ç„¡æ•ˆçš„ assetType: " + assetType + "ï¼Œè«‹æä¾› SPOT æˆ– SEAT"));
        }
    }

    /**
     * ä¾‹å¤–è™•ç†
     */
    @ExceptionHandler(Exception.class)
    public ResponseEntity<Map<String, String>> handleException(Exception ex) {
        return ResponseEntity
                .status(HttpStatus.INTERNAL_SERVER_ERROR)
                .body(Map.of("error", "çµ±è¨ˆè¨ˆç®—ç™¼ç”ŸéŒ¯èª¤: " + ex.getMessage()));
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/controller/maintenance/MaintenanceScheduleController.java">
package com.example.backend.controller.maintenance;

import com.example.backend.model.maintenance.MaintenanceSchedule;
import com.example.backend.service.maintenance.MaintenanceScheduleService;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Map;

/**
 * å®šæœŸç¶­è­·æ’ç¨‹ Controller
 */
@RestController
@RequestMapping("/api/maintenance/schedule")
@CrossOrigin(origins = "http://localhost:5173")
public class MaintenanceScheduleController {

    private final MaintenanceScheduleService scheduleService;

    public MaintenanceScheduleController(MaintenanceScheduleService scheduleService) {
        this.scheduleService = scheduleService;
    }

    // ==================== æŸ¥è©¢ ====================

    /**
     * å–å¾—æ‰€æœ‰æ’ç¨‹
     * GET /api/maintenance/schedule
     */
    @GetMapping
    public List<MaintenanceSchedule> getAllSchedules() {
        return scheduleService.getAllSchedules();
    }

    /**
     * ä¾ ID å–å¾—å–®ä¸€æ’ç¨‹
     * GET /api/maintenance/schedule/{id}
     */
    @GetMapping("/{id}")
    public MaintenanceSchedule getScheduleById(@PathVariable Integer id) {
        return scheduleService.getScheduleById(id);
    }

    /**
     * å–å¾—æ‰€æœ‰å•Ÿç”¨ä¸­çš„æ’ç¨‹
     * GET /api/maintenance/schedule/active
     */
    @GetMapping("/active")
    public List<MaintenanceSchedule> getActiveSchedules() {
        return scheduleService.getActiveSchedules();
    }

    /**
     * ä¾ç›®æ¨™æŸ¥è©¢æ’ç¨‹
     * GET /api/maintenance/schedule/target?type=SPOT&id=1
     */
    @GetMapping("/target")
    public List<MaintenanceSchedule> getSchedulesByTarget(
            @RequestParam("type") String targetType,
            @RequestParam("id") Integer targetId) {
        return scheduleService.getSchedulesByTarget(targetType.toUpperCase(), targetId);
    }

    /**
     * å–å¾—å·²åˆ°æœŸçš„æ’ç¨‹ (ä¾›æ¸¬è©¦æˆ–æ‰‹å‹•è§¸ç™¼ç”¨)
     * GET /api/maintenance/schedule/due
     */
    @GetMapping("/due")
    public List<MaintenanceSchedule> getDueSchedules() {
        return scheduleService.getDueSchedules();
    }

    // ==================== æ–°å¢ ====================

    /**
     * å»ºç«‹æ–°æ’ç¨‹
     * POST /api/maintenance/schedule
     */
    @PostMapping
    public ResponseEntity<MaintenanceSchedule> createSchedule(@RequestBody MaintenanceSchedule schedule) {
        MaintenanceSchedule created = scheduleService.createSchedule(schedule);
        return ResponseEntity.status(HttpStatus.CREATED).body(created);
    }

    // ==================== æ›´æ–° ====================

    /**
     * æ›´æ–°æ’ç¨‹
     * PUT /api/maintenance/schedule/{id}
     */
    @PutMapping("/{id}")
    public MaintenanceSchedule updateSchedule(
            @PathVariable Integer id,
            @RequestBody MaintenanceSchedule schedule) {
        schedule.setScheduleId(id);
        return scheduleService.updateSchedule(schedule);
    }

    /**
     * åˆ‡æ›å•Ÿç”¨ç‹€æ…‹
     * PATCH /api/maintenance/schedule/{id}/toggle
     */
    @PatchMapping("/{id}/toggle")
    public MaintenanceSchedule toggleActive(@PathVariable Integer id) {
        return scheduleService.toggleActive(id);
    }

    // ==================== åˆªé™¤ ====================

    /**
     * åˆªé™¤æ’ç¨‹
     * DELETE /api/maintenance/schedule/{id}
     */
    @DeleteMapping("/{id}")
    public ResponseEntity<Map<String, String>> deleteSchedule(@PathVariable Integer id) {
        scheduleService.deleteSchedule(id);
        return ResponseEntity.ok(Map.of("message", "æ’ç¨‹å·²åˆªé™¤"));
    }

    // ==================== ä¾‹å¤–è™•ç† ====================

    /**
     * è™•ç† IllegalArgumentException (é©—è­‰éŒ¯èª¤)
     */
    @ExceptionHandler(IllegalArgumentException.class)
    public ResponseEntity<Map<String, String>> handleIllegalArgument(IllegalArgumentException ex) {
        return ResponseEntity
                .status(HttpStatus.BAD_REQUEST)
                .body(Map.of("error", ex.getMessage()));
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/controller/member/AuthController.java">
package com.example.backend.controller.member;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.security.oauth2.core.user.OAuth2User;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.example.backend.model.member.Member;
import com.example.backend.repository.member.MemberRepository;

import java.util.Optional;

@RestController
@RequestMapping("/api/auth")
public class AuthController {

    @Autowired
    private MemberRepository memberRepository;

    @GetMapping("/me")
    public ResponseEntity<?> getCurrentUser(@AuthenticationPrincipal OAuth2User principal) {
        // å¦‚æœæ²’ç™»å…¥ï¼Œprincipal æœƒæ˜¯ null
        if (principal == null) {
            return ResponseEntity.status(401).body("æœªç™»å…¥");
        }

        // å¾ Google è³‡æ–™ä¸­æ‹¿ Email
        String email = principal.getAttribute("email");

        // å»è³‡æ–™åº«æ‰¾è©²æœƒå“¡è³‡æ–™ï¼Œå›å‚³çµ¦å‰ç«¯
        Optional<Member> member = memberRepository.findByMemEmail(email);

        return member.map(ResponseEntity::ok)
                .orElse(ResponseEntity.status(404).build());
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/controller/member/MemberProfileController.java">
package com.example.backend.controller.member;

import org.springframework.security.core.Authentication;
import org.springframework.security.oauth2.core.user.OAuth2User;
import org.springframework.web.bind.annotation.*;
import com.example.backend.model.member.Member;
import com.example.backend.repository.member.MemberRepository;
import jakarta.servlet.http.HttpSession; // è¨˜å¾—åŠ é€™å€‹ import
import java.util.Optional;

@RestController
@RequestMapping("/member")
public class MemberProfileController {

    private final MemberRepository memberRepository;

    public MemberProfileController(MemberRepository memberRepository) {
        this.memberRepository = memberRepository;
    }

    /**
     * å–å¾—æœƒå“¡è³‡æ–™ (ç›¸å®¹ä¸€èˆ¬ç™»å…¥èˆ‡ Google ç™»å…¥)
     */
    @GetMapping("/profile")
    public Object getProfile(Authentication authentication, HttpSession session) {

        // 1. å…ˆæ‰¾æœ‰æ²’æœ‰ Google ç™»å…¥ (Spring Security)
        if (authentication != null && authentication.isAuthenticated()) {
            String email = "";
            if (authentication.getPrincipal() instanceof OAuth2User) {
                email = ((OAuth2User) authentication.getPrincipal()).getAttribute("email");
            } else {
                email = authentication.getName();
            }

            Optional<Member> memberOpt = memberRepository.findByMemEmail(email);
            if (memberOpt.isPresent()) {
                return memberOpt.get(); // æ‰¾åˆ° Google æœƒå“¡
            }
        }

        // 2. å¦‚æœä¸Šé¢æ²’æ‰¾åˆ°ï¼Œå°±æ‰¾ä½ åŸæœ¬ä¸€èˆ¬ç™»å…¥å­˜çš„ Session
        Member loginMember = (Member) session.getAttribute("loginMember");
        if (loginMember != null) {
            // ç‚ºäº†æ€•è³‡æ–™éæœŸï¼Œå»ºè­°ç”¨ ID å†å»è³‡æ–™åº«æ’ˆä¸€æ¬¡æœ€æ–°çš„
            return memberRepository.findById(loginMember.getMemId()).orElse(loginMember);
        }

        return "å°šæœªç™»å…¥";
    }

    /**
     * æ›´æ–°æœƒå“¡è³‡æ–™
     */
    @PutMapping("/profile")
    public Object updateProfile(@RequestBody Member formMember, Authentication authentication, HttpSession session) {
        Member targetMember = null;

        // 1. è­˜åˆ¥èº«åˆ† (å„ªå…ˆçœ‹ Securityï¼Œå†çœ‹ Session)
        if (authentication != null && authentication.isAuthenticated()) {
            String email = (authentication.getPrincipal() instanceof OAuth2User)
                    ? ((OAuth2User) authentication.getPrincipal()).getAttribute("email")
                    : authentication.getName();
            targetMember = memberRepository.findByMemEmail(email).orElse(null);
        }

        if (targetMember == null) {
            targetMember = (Member) session.getAttribute("loginMember");
        }

        if (targetMember == null)
            return "å°šæœªç™»å…¥";

        // ===== æ ¼å¼é©—è­‰ (ä¿ç•™ä½ çš„é‚è¼¯) =====
        if (formMember.getMemEmail() == null || !formMember.getMemEmail().matches("^[A-Za-z0-9+_.-]+@.+\\.com$")) {
            return "Email æ ¼å¼éŒ¯èª¤";
        }
        if (formMember.getMemPhone() == null || !formMember.getMemPhone().matches("^09\\d{8}$")) {
            return "æ‰‹æ©Ÿæ ¼å¼éŒ¯èª¤";
        }
        if (formMember.getMemInvoice() != null && !formMember.getMemInvoice().matches("^/.{7}$")) {
            return "ç™¼ç¥¨è¼‰å…·æ ¼å¼éŒ¯èª¤";
        }

        // ===== æ›´æ–°è³‡æ–™ =====
        targetMember.setMemName(formMember.getMemName());
        targetMember.setMemPhone(formMember.getMemPhone());
        targetMember.setMemEmail(formMember.getMemEmail());
        targetMember.setMemInvoice(formMember.getMemInvoice());

        memberRepository.save(targetMember);

        // 2. å¦‚æœæ˜¯ä¸€èˆ¬æœƒå“¡ï¼Œæ›´æ–°å®Œå¾ŒåŒæ­¥åˆ·å› Session ç¢ºä¿ä¸‹æ¬¡è®€å–æ­£ç¢º
        if (session.getAttribute("loginMember") != null) {
            session.setAttribute("loginMember", targetMember);
        }

        return "æ›´æ–°æˆåŠŸ";
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/controller/merchantAndCoupon/DiscountController.java">
package com.example.backend.controller.merchantAndCoupon;

import com.example.backend.dto.RedemptionLogDTO;
import com.example.backend.model.member.Member;
import com.example.backend.model.merchantAndCoupon.DiscountBean;
import com.example.backend.model.merchantAndCoupon.RedemptionLog;
import com.example.backend.model.merchantAndCoupon.Result;
import com.example.backend.repository.member.MemberRepository;
import com.example.backend.repository.merchantAndCoupon.RedemptionLogRepository;
import com.example.backend.service.merchantAndCoupon.DiscountService;
import com.example.backend.service.merchantAndCoupon.RedemptionService;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;

import jakarta.transaction.Transactional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.dao.EmptyResultDataAccessException; // [æ–°å¢]
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import java.nio.file.*;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.UUID;

@RestController
@RequestMapping("/api/discounts")
@CrossOrigin(origins = "http://localhost:5173") // ç¢ºä¿è·¨åŸŸé…ç½®æ­£ç¢º
public class DiscountController {

    @Autowired
    private DiscountService discountService;
    @Autowired
    private MemberRepository memberRepository; // [æ–°å¢] æ³¨å…¥æœƒå“¡ Repository ç”¨æ–¼æ‰£é»

    @Autowired
    private RedemptionLogRepository redemptionLogRepository; // æ³¨å…¥æ–°çš„ Repo

    @Autowired
    private RedemptionService redemptionService;

    @Value("${file.upload-path:./uploads/}")
    private String uploadPath;

    @GetMapping
    public Result<List<DiscountBean>> list(@RequestParam(required = false) String keyword) {
        return Result.success(discountService.getAll(keyword), "æŸ¥è©¢æˆåŠŸ");
    }

    @PostMapping(consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    public Result<String> save(
            @RequestPart("discount") String discountJson,
            @RequestPart(value = "image", required = false) MultipartFile file) {

        try {
            ObjectMapper mapper = new ObjectMapper();
            mapper.registerModule(new JavaTimeModule());
            DiscountBean discount = mapper.readValue(discountJson, DiscountBean.class);

            if (file != null && !file.isEmpty()) {
                // [å®‰å…¨æ€§ä¿®æ­£] é˜²æ­¢æª”åç‚º null (NPE) ä»¥åŠè·¯å¾‘ç©¿è¶Šæ”»æ“Š
                String originalFilename = file.getOriginalFilename();
                String safeFilename = (originalFilename == null || originalFilename.isBlank())
                        ? "upload.bin" // é è¨­æª”å
                        : Paths.get(originalFilename).getFileName().toString();

                String fileName = UUID.randomUUID().toString() + "_" + safeFilename;

                Path root = Paths.get(uploadPath).toAbsolutePath().normalize();
                if (!Files.exists(root))
                    Files.createDirectories(root);

                Files.copy(file.getInputStream(), root.resolve(fileName), StandardCopyOption.REPLACE_EXISTING);
                discount.setCouponImg(fileName);
            }

            discountService.save(discount);
            return Result.success(null, "å„²å­˜æˆåŠŸ");

        } catch (IllegalArgumentException e) {
            // [æ–°å¢] æ•ç² Service æ‹‹å‡ºçš„ "æ‰¾ä¸åˆ° ID" éŒ¯èª¤
            return Result.error("å„²å­˜å¤±æ•—ï¼š" + e.getMessage());
        } catch (Exception e) {
            e.printStackTrace();
            return Result.error("ä¼ºæœå™¨éŒ¯èª¤: " + e.getMessage());
        }
    }

    @DeleteMapping("/{id}")
    public Result<String> delete(@PathVariable Integer id) {
        try {
            discountService.delete(id);
            return Result.success(null, "åˆªé™¤æˆåŠŸ");
        } catch (EmptyResultDataAccessException e) {
            // [é˜²å‘†] åˆªé™¤ä¸å­˜åœ¨çš„ ID
            return Result.error("åˆªé™¤å¤±æ•—ï¼šæ‰¾ä¸åˆ°è©²å„ªæƒ åˆ¸");
        } catch (Exception e) {
            return Result.error("åˆªé™¤å¤±æ•—ï¼š" + e.getMessage());
        }
    }

    @PutMapping("/{id}/status")
    public Result<String> updateStatus(@PathVariable Integer id, @RequestParam String action) {
        boolean success = discountService.updateSingleStatus(id, action);
        if (success) {
            return Result.success(null, "ç‹€æ…‹æ›´æ–°æˆåŠŸ");
        } else {
            return Result.error("æ›´æ–°å¤±æ•—ï¼šæ‰¾ä¸åˆ°è³‡æ–™ã€æ—¥æœŸè³‡æ–™ä¸å…¨æˆ–æŒ‡ä»¤éŒ¯èª¤");
        }
    }

    @PostMapping("/redeem")
    @Transactional // ç¢ºä¿ 1.æ‰£é» èˆ‡ 2.å¯«å…¥ç´€éŒ„ æ˜¯ä¸€é«”çš„ï¼Œè¦æˆåŠŸå°±ä¸€èµ·æˆåŠŸ
    public Result<Map<String, Object>> redeemCoupon(@RequestBody Map<String, Object> payload) {
        try {

            if (payload.get("memberId") == null || payload.get("couponId") == null || payload.get("passcode") == null) {
                return Result.error("æ ¸éŠ·å¤±æ•—ï¼šç¼ºå°‘å¿…è¦åƒæ•¸ (memberId, couponId æˆ– passcode)");
            }
            Integer memberId = Integer.valueOf(payload.get("memberId").toString());
            Integer couponId = Integer.valueOf(payload.get("couponId").toString());
            String inputPasscode = payload.get("passcode").toString();

            // 1. å–å¾—å„ªæƒ åˆ¸è³‡è¨Š
            DiscountBean coupon = discountService.getById(couponId);
            if (coupon == null)
                return Result.error("å„ªæƒ åˆ¸ä¸å­˜åœ¨");

            // 2. é©—è­‰æ ¸éŠ·ç¢¼
            if (!"1234".equals(inputPasscode))
                return Result.error("æ ¸éŠ·å¤±æ•—ï¼šæ ¸éŠ·ç¢¼éŒ¯èª¤");

            // 3. æª¢æŸ¥æœƒå“¡é»æ•¸
            Member member = memberRepository.findById(memberId)
                    .orElseThrow(() -> new RuntimeException("æ‰¾ä¸åˆ°æœƒå“¡"));

            if (member.getMemPoints() < coupon.getPointsRequired()) {
                return Result.error("é»æ•¸ä¸è¶³ï¼Œç„¡æ³•æ ¸éŠ·");
            }

            // 4. ã€æ ¸å¿ƒå‹•ä½œ Aã€‘æ‰£é™¤æœƒå“¡é»æ•¸
            int newPoints = member.getMemPoints() - coupon.getPointsRequired();
            member.setMemPoints(newPoints);
            memberRepository.save(member);

            // 5. ã€æ ¸å¿ƒå‹•ä½œ Bã€‘å¯«å…¥å…Œæ›ç´€éŒ„ (RedemptionLog)
            RedemptionLog log = new RedemptionLog();
            log.setMemId(memberId);
            log.setCouponId(couponId);
            log.setPointsSpent(coupon.getPointsRequired());
            log.setCouponName(coupon.getCouponName());
            // redeemTime æœƒç”± SQL Server çš„ DEFAULT GETDATE() è‡ªå‹•ç”Ÿæˆ

            redemptionLogRepository.save(log);

            return Result.success(Map.of(
                    "currentPoints", newPoints,
                    "couponName", coupon.getCouponName()), "æ ¸éŠ·æˆåŠŸï¼é»æ•¸å·²æ‰£é™¤ã€‚");

        } catch (Exception e) {
            return Result.error("æ ¸éŠ·å¤±æ•—ï¼š" + e.getMessage());
        }
    }

    /**
     * å¾Œå°ç®¡ç† APIï¼šå–å¾—æ‰€æœ‰å…Œæ›ç´€éŒ„
     * ç¶²å€: GET /api/discounts/logs
     */
    @GetMapping("/logs")
    public Map<String, Object> getAllLogs() {
        // æŠ“å–å…Œæ›ç´€éŒ„
        List<RedemptionLog> list = redemptionLogRepository.findAllByOrderByRedeemTimeDesc();

        Map<String, Object> result = new HashMap<>();
        result.put("status", "success");
        result.put("data", list);
        return result;
    }

    // æœƒå“¡å°ˆå±¬ç´€éŒ„ API
    @GetMapping("/member/{memId}/logs") // å»ºè­°åŠ ä¸Š /member å€åˆ†è·¯å¾‘
    public ResponseEntity<List<RedemptionLogDTO>> getMemberLogs(@PathVariable Integer memId) {
        // é€™è£¡æœƒèª¿ç”¨ä½ ä¹‹å‰å¯«çš„ï¼Œå¸¶æœ‰ MerchantName çš„ Service é‚è¼¯
        return ResponseEntity.ok(redemptionService.getMemberLogs(memId));
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/controller/merchantAndCoupon/MerchantController.java">
package com.example.backend.controller.merchantAndCoupon;

import com.example.backend.model.merchantAndCoupon.MerchantBean;
import com.example.backend.model.merchantAndCoupon.Result; 
import com.example.backend.service.merchantAndCoupon.MerchantService;

import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.dao.EmptyResultDataAccessException; // [æ–°å¢]
import org.springframework.web.bind.annotation.*;
import java.util.List;

@Slf4j
@RestController
@RequestMapping("/api/merchants")

public class MerchantController {

    @Autowired
    private MerchantService merchantService;

    @GetMapping
    public Result<List<MerchantBean>> list(@RequestParam(required = false) String keyword) {
        log.info("é–‹å§‹æŸ¥è©¢å•†å®¶åˆ—è¡¨, é—œéµå­—: {}", keyword);
        try {
            List<MerchantBean> list;
            if (keyword != null && !keyword.trim().isEmpty()) {
                list = merchantService.getByKeyword(keyword);
            } else {
                list = merchantService.getAll();
            }
            log.info("æŸ¥è©¢æˆåŠŸï¼Œå…± {} ç­†è³‡æ–™", list.size());
            return Result.success(list, "æŸ¥è©¢æˆåŠŸ");
        } catch (Exception e) {
            log.error("æŸ¥è©¢å•†å®¶å¤±æ•—", e);
            return Result.error("ä¼ºæœå™¨å…§éƒ¨éŒ¯èª¤ï¼š" + e.getMessage());
        }
    }

    @PostMapping
    public Result<String> create(@RequestBody MerchantBean merchant) {
        log.info("æ”¶åˆ°æ–°å¢å•†å®¶è«‹æ±‚: {}", merchant.getMerchantName());
        try {
            merchant.setMerchantId(null);
            merchantService.saveOrUpdate(merchant);
            return Result.success(null, "æ–°å¢å•†å®¶æˆåŠŸ");
        } catch (Exception e) {
            log.error("æ–°å¢å•†å®¶å¤±æ•—", e);
            return Result.error("æ–°å¢å¤±æ•—: " + e.getMessage());
        }
    }

    @PutMapping("/{id}")
    public Result<String> update(@PathVariable Integer id, @RequestBody MerchantBean merchant) {
        log.info("æ”¶åˆ°æ›´æ–°å•†å®¶è«‹æ±‚, ID: {}, è³‡æ–™: {}", id, merchant);
        try {
            MerchantBean existing = merchantService.getById(id);
            if (existing == null) {
                log.warn("æ›´æ–°å¤±æ•—ï¼Œæ‰¾ä¸åˆ° ID ç‚º {} çš„å•†å®¶", id);
                return Result.error("æ›´æ–°å¤±æ•—ï¼šæ‰¾ä¸åˆ°è©²å•†å®¶è³‡æ–™");
            }
            merchant.setMerchantId(id);
            merchantService.saveOrUpdate(merchant);

            log.info("å•†å®¶ ID: {} æ›´æ–°æˆåŠŸ", id);
            return Result.success(null, "è³‡æ–™æ›´æ–°æˆåŠŸ");
        } catch (Exception e) {
            log.error("æ›´æ–°å•†å®¶éç¨‹ç™¼ç”Ÿç•°å¸¸", e);
            return Result.error("æ›´æ–°éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: " + e.getMessage());
        }
    }

    @DeleteMapping("/{id}")
    public Result<String> delete(@PathVariable Integer id) {
        log.warn("æ”¶åˆ°åˆªé™¤å•†å®¶è«‹æ±‚, ID: {}", id);
        try {
            merchantService.deleteMerchant(id);
            log.info("å•†å®¶ ID: {} å·²æˆåŠŸåˆªé™¤", id);
            return Result.success(null, "åˆªé™¤æˆåŠŸ");
        } catch (EmptyResultDataAccessException e) {
            // [æ–°å¢] æ‰¾ä¸åˆ° ID æ™‚çš„è™•ç†
            return Result.error("åˆªé™¤å¤±æ•—ï¼šæ‰¾ä¸åˆ°è©²å•†å®¶");
        } catch (Exception e) {
            log.error("åˆªé™¤å•†å®¶å¤±æ•—", e);
            String msg = String.valueOf(e.getMessage());
            if (msg.contains("ConstraintViolationException") || msg.toLowerCase().contains("foreign key")) {
                return Result.error("åˆªé™¤å¤±æ•—ï¼šè©²å•†å®¶æ——ä¸‹é‚„æœ‰é—œè¯è³‡æ–™ï¼ˆå¦‚å„ªæƒ åˆ¸ï¼‰ï¼Œè«‹å…ˆåˆªé™¤é—œè¯è³‡æ–™ã€‚");
            }
            return Result.error("åˆªé™¤å¤±æ•—: " + msg);
        }
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/controller/spot/SeatController.java">
package com.example.backend.controller.spot;

import java.util.List;
import java.util.Map;

import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import com.example.backend.model.spot.Seat;
import com.example.backend.service.spot.SeatService;

/**
 * [é‡æ§‹] åº§ä½ (Seat) è³‡æºçš„çµ±ä¸€æ§åˆ¶å™¨
 * - éµå¾ª RESTful API è¨­è¨ˆé¢¨æ ¼ã€‚
 * - çµ±ä¸€åŸºç¤è·¯å¾‘ç‚º /api/seats
 */
@RestController
@RequestMapping("/seats") // [ä¿®æ­£] é…åˆå‰ç«¯ Proxy ç§»é™¤ /api å‰ç¶´çš„è¡Œç‚ºï¼Œæ”¹ç‚ºç›£è½ /seats
public class SeatController {

    private final SeatService seatService;

    public SeatController(SeatService seatService) {
        this.seatService = seatService;
    }

    // region æŸ¥è©¢åŠŸèƒ½ (Read)

    /**
     * æŸ¥è©¢æ‰€æœ‰åº§ä½ (GET /api/seats)
     */
    @GetMapping
    public List<Seat> getAllSeats() {
        return seatService.selectAll();
    }

    /**
     * æ ¹æ“š ID æŸ¥è©¢å–®ä¸€åº§ä½ (GET /api/seats/{id})
     */
    @GetMapping("/{id}")
    public ResponseEntity<Seat> getSeatById(@PathVariable("id") Integer seatId) {
        Seat seat = seatService.selectById(seatId);
        return (seat != null) ? ResponseEntity.ok(seat) : ResponseEntity.notFound().build();
    }

    /**
     * æ¢ä»¶æŸ¥è©¢ (GET /api/seats/search?seatsName=...)
     */
    @GetMapping("/search")
    public List<Seat> findSeatsByCondition(
            @RequestParam(required = false) String seatsName,
            @RequestParam(required = false) String seatsType,
            @RequestParam(required = false) String seatsStatus,
            @RequestParam(required = false) Integer spotId,
            @RequestParam(required = false) String serialNumber) {
        return seatService.findByCondition(seatsName, seatsType, seatsStatus, spotId, serialNumber);
    }

    // æ ¹æ“š spotId æŸ¥è©¢åº§ä½æ•¸é‡ (GET /seats/count-by-spot)
    @GetMapping("/count-by-spot")
    public ResponseEntity<Long> getSeatCountBySpotId(@RequestParam("spotId") Integer spotId) {
        long count = seatService.countBySpotId(spotId);
        return ResponseEntity.ok(count);
    }

    // endregion

    // region ç·¨è¼¯åŠŸèƒ½ (Create / Update / Delete)

    /**
     * æ–°å¢åº§ä½ (POST /api/seats)
     */
    @PostMapping
    public ResponseEntity<Seat> createSeat(@RequestBody Seat seat) {
        Seat createdSeat = seatService.insert(seat);
        return new ResponseEntity<>(createdSeat, HttpStatus.CREATED);
    }

    /**
     * æ›´æ–°åº§ä½ (PUT /api/seats/{id})
     * - æ¡ç”¨ã€Œå…ˆæŸ¥è©¢ã€å†ä¿®æ”¹ã€å¾Œå„²å­˜ã€çš„é‚è¼¯ï¼Œç¢ºä¿è³‡æ–™å®Œæ•´æ€§ã€‚
     */
    @PutMapping("/{id}")
    public ResponseEntity<Seat> updateSeat(@PathVariable("id") Integer seatId,
            @RequestBody Seat seatDetails) {
        // 1. æª¢æŸ¥ ID æ˜¯å¦ä¸€è‡´ (é˜²å‘†)
        if (seatDetails.getSeatsId() != null && !seatId.equals(seatDetails.getSeatsId())) {
            return ResponseEntity.badRequest().build();
        }

        // 2. å…ˆå¾è³‡æ–™åº«æŸ¥å‡ºèˆŠè³‡æ–™
        Seat existingSeat = seatService.selectById(seatId);
        if (existingSeat == null) {
            return ResponseEntity.notFound().build();
        }

        // 3. æ‰‹å‹•æ›´æ–°æ¬„ä½ (æ ¹æ“šæ‚¨çš„ Seat Entity æ¬„ä½é€²è¡Œèª¿æ•´)
        existingSeat.setSeatsName(seatDetails.getSeatsName());
        existingSeat.setSeatsType(seatDetails.getSeatsType());
        existingSeat.setSeatsStatus(seatDetails.getSeatsStatus());
        existingSeat.setSpotId(seatDetails.getSpotId());
        existingSeat.setSerialNumber(seatDetails.getSerialNumber());
        // existingSeat.setUpdatedAt(new Date()); // å¦‚æœ Service æ²’æœ‰è‡ªå‹•è™•ç†æ™‚é–“ï¼Œé€™è£¡å¯èƒ½éœ€è¦æ‰‹å‹•è¨­

        // 4. å„²å­˜æ›´æ–°
        Seat updatedSeat = seatService.update(existingSeat);
        return ResponseEntity.ok(updatedSeat);
    }

    /**
     * åˆªé™¤åº§ä½ (DELETE /api/seats/{id})
     */
    @DeleteMapping("/{id}")
    public ResponseEntity<Map<String, String>> deleteSeat(@PathVariable("id") Integer seatId) {
        seatService.deleteById(seatId);
        return ResponseEntity.ok(Map.of("message", "Seat with ID " + seatId + " deleted successfully."));
    }

    // endregion

}
</file>

<file path="backend/src/main/java/com/example/backend/dto/maintenance/AssetStatsResponseDto.java">
package com.example.backend.dto.maintenance;

import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;

/**
 * è³‡ç”¢å¥åº·åº¦çµ±è¨ˆ DTO
 * ç”¨æ–¼å›å‚³æ©Ÿå°(Spot)æˆ–æ¤…å­(Seat)åœ¨ç‰¹å®šæ™‚é–“çª—å…§çš„ç¶­ä¿®/ä¿é¤Šçµ±è¨ˆæŒ‡æ¨™
 */
public class AssetStatsResponseDto {

    private static final DateTimeFormatter DATE_FORMATTER = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");

    private String assetType;          // "SPOT" æˆ– "SEAT"
    private Integer assetId;           // spotId æˆ– seatsId
    private String assetName;          // è³‡ç”¢åç¨±

    private Integer repairCount;       // ç¶­ä¿®å·¥å–®æ•¸ï¼ˆéä¿é¤Šï¼‰
    private Integer maintainCount;     // ä¿é¤Šå·¥å–®æ•¸
    private Integer repairDoneCount;   // ç¶­ä¿®å·²çµæ¡ˆæ•¸
    private Integer maintainDoneCount; // ä¿é¤Šå·²çµæ¡ˆæ•¸
    private Integer openCount;         // æœªçµæ¡ˆæ•¸

    private Long downtimeMinutes;      // åœæ©Ÿåˆ†é˜æ•¸ï¼ˆæ™‚é–“çª—å…§ï¼‰
    private Double availability;       // å¦¥å–„ç‡ (0~1)
    private Double failureRatePerDay;  // æ•…éšœç‡ (repairCount / 7)
    private Double repairRate;         // ç¶­ä¿®ç‡ (repairDoneCount / repairCount)

    private String windowFrom;         // çµ±è¨ˆçª—å£èµ·å§‹æ™‚é–“
    private String windowTo;           // çµ±è¨ˆçª—å£çµæŸæ™‚é–“

    // ========== Constructors ==========

    public AssetStatsResponseDto() {}

    public AssetStatsResponseDto(
            String assetType,
            Integer assetId,
            String assetName,
            Integer repairCount,
            Integer maintainCount,
            Integer repairDoneCount,
            Integer maintainDoneCount,
            Integer openCount,
            Long downtimeMinutes,
            Double availability,
            Double failureRatePerDay,
            Double repairRate,
            LocalDateTime windowFrom,
            LocalDateTime windowTo
    ) {
        this.assetType = assetType;
        this.assetId = assetId;
        this.assetName = assetName;
        this.repairCount = repairCount;
        this.maintainCount = maintainCount;
        this.repairDoneCount = repairDoneCount;
        this.maintainDoneCount = maintainDoneCount;
        this.openCount = openCount;
        this.downtimeMinutes = downtimeMinutes;
        this.availability = availability;
        this.failureRatePerDay = failureRatePerDay;
        this.repairRate = repairRate;
        this.windowFrom = (windowFrom != null) ? windowFrom.format(DATE_FORMATTER) : null;
        this.windowTo = (windowTo != null) ? windowTo.format(DATE_FORMATTER) : null;
    }

    // ========== Getters & Setters ==========

    public String getAssetType() { return assetType; }
    public void setAssetType(String assetType) { this.assetType = assetType; }

    public Integer getAssetId() { return assetId; }
    public void setAssetId(Integer assetId) { this.assetId = assetId; }

    public String getAssetName() { return assetName; }
    public void setAssetName(String assetName) { this.assetName = assetName; }

    public Integer getRepairCount() { return repairCount; }
    public void setRepairCount(Integer repairCount) { this.repairCount = repairCount; }

    public Integer getMaintainCount() { return maintainCount; }
    public void setMaintainCount(Integer maintainCount) { this.maintainCount = maintainCount; }

    public Integer getRepairDoneCount() { return repairDoneCount; }
    public void setRepairDoneCount(Integer repairDoneCount) { this.repairDoneCount = repairDoneCount; }

    public Integer getMaintainDoneCount() { return maintainDoneCount; }
    public void setMaintainDoneCount(Integer maintainDoneCount) { this.maintainDoneCount = maintainDoneCount; }

    public Integer getOpenCount() { return openCount; }
    public void setOpenCount(Integer openCount) { this.openCount = openCount; }

    public Long getDowntimeMinutes() { return downtimeMinutes; }
    public void setDowntimeMinutes(Long downtimeMinutes) { this.downtimeMinutes = downtimeMinutes; }

    public Double getAvailability() { return availability; }
    public void setAvailability(Double availability) { this.availability = availability; }

    public Double getFailureRatePerDay() { return failureRatePerDay; }
    public void setFailureRatePerDay(Double failureRatePerDay) { this.failureRatePerDay = failureRatePerDay; }

    public Double getRepairRate() { return repairRate; }
    public void setRepairRate(Double repairRate) { this.repairRate = repairRate; }

    public String getWindowFrom() { return windowFrom; }
    public void setWindowFrom(String windowFrom) { this.windowFrom = windowFrom; }

    public String getWindowTo() { return windowTo; }
    public void setWindowTo(String windowTo) { this.windowTo = windowTo; }
}
</file>

<file path="backend/src/main/java/com/example/backend/dto/maintenance/MaintenanceLogResponseDto.java">
package com.example.backend.dto.maintenance;

import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;

/**
 * ç¶­ä¿®æ­·ç¨‹å›æ‡‰ DTO (é˜²æ­¢ Entity æ´©æ¼)
 */
public class MaintenanceLogResponseDto {

    private static final DateTimeFormatter FORMATTER = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm");

    private Integer logId;
    private String operator;   // æ“ä½œè€…
    private String action;     // å‹•ä½œä»£è™Ÿ (CREATED, ASSIGNED, STARTED, RESOLVED, CANCELLED, URGENT)
    private String comment;    // å‚™è¨»èªªæ˜
    private String createdAt;  // æ ¼å¼åŒ–å¾Œçš„æ™‚é–“å­—ä¸² (yyyy-MM-dd HH:mm)

    // ========== Constructors ==========

    public MaintenanceLogResponseDto() {}

    /**
     * å¾ Entity è½‰æ›ç‚º DTO
     */
    public MaintenanceLogResponseDto(Integer logId, String operator, String action, 
                                     String comment, LocalDateTime createdAt) {
        this.logId = logId;
        this.operator = operator;
        this.action = action;
        this.comment = comment;
        this.createdAt = (createdAt != null) ? createdAt.format(FORMATTER) : null;
    }

    // ========== Getters & Setters ==========

    public Integer getLogId() {
        return logId;
    }

    public void setLogId(Integer logId) {
        this.logId = logId;
    }

    public String getOperator() {
        return operator;
    }

    public void setOperator(String operator) {
        this.operator = operator;
    }

    public String getAction() {
        return action;
    }

    public void setAction(String action) {
        this.action = action;
    }

    public String getComment() {
        return comment;
    }

    public void setComment(String comment) {
        this.comment = comment;
    }

    public String getCreatedAt() {
        return createdAt;
    }

    public void setCreatedAt(String createdAt) {
        this.createdAt = createdAt;
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/dto/maintenance/MaintenanceScheduleResponseDto.java">
package com.example.backend.dto.maintenance;

import java.time.LocalDateTime;
import java.time.LocalTime;
import java.time.format.DateTimeFormatter;

/**
 * æ’ç¨‹å›æ‡‰ DTO (å«äººå“¡å§“å)
 */
public class MaintenanceScheduleResponseDto {

    private static final DateTimeFormatter DATE_FORMATTER = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm");
    private static final DateTimeFormatter TIME_FORMATTER = DateTimeFormatter.ofPattern("HH:mm");

    private Integer scheduleId;
    private String title;
    private String targetType;
    private Integer targetId;
    private String scheduleType;
    private Integer dayOfWeek;
    private Integer dayOfMonth;
    private String executeTime;
    private String issueType;
    private String issuePriority;
    private Integer assignedStaffId;
    private String assignedStaffName;
    private Boolean isActive;
    private String lastExecutedAt;
    private String nextExecuteAt;
    private String createdAt;
    private String updatedAt;

    // ========== Constructors ==========

    public MaintenanceScheduleResponseDto() {}

    /**
     * å¾ Entity è½‰æ›çš„å®Œæ•´å»ºæ§‹å­ (å«äººå“¡å§“å)
     */
    public MaintenanceScheduleResponseDto(
            Integer scheduleId,
            String title,
            String targetType,
            Integer targetId,
            String scheduleType,
            Integer dayOfWeek,
            Integer dayOfMonth,
            LocalTime executeTime,
            String issueType,
            String issuePriority,
            Integer assignedStaffId,
            String assignedStaffName,
            Boolean isActive,
            LocalDateTime lastExecutedAt,
            LocalDateTime nextExecuteAt,
            LocalDateTime createdAt,
            LocalDateTime updatedAt
    ) {
        this.scheduleId = scheduleId;
        this.title = title;
        this.targetType = targetType;
        this.targetId = targetId;
        this.scheduleType = scheduleType;
        this.dayOfWeek = dayOfWeek;
        this.dayOfMonth = dayOfMonth;
        this.executeTime = (executeTime != null) ? executeTime.format(TIME_FORMATTER) : null;
        this.issueType = issueType;
        this.issuePriority = issuePriority;
        this.assignedStaffId = assignedStaffId;
        this.assignedStaffName = assignedStaffName;
        this.isActive = isActive;
        this.lastExecutedAt = (lastExecutedAt != null) ? lastExecutedAt.format(DATE_FORMATTER) : null;
        this.nextExecuteAt = (nextExecuteAt != null) ? nextExecuteAt.format(DATE_FORMATTER) : null;
        this.createdAt = (createdAt != null) ? createdAt.format(DATE_FORMATTER) : null;
        this.updatedAt = (updatedAt != null) ? updatedAt.format(DATE_FORMATTER) : null;
    }

    // ========== Getters & Setters ==========

    public Integer getScheduleId() { return scheduleId; }
    public void setScheduleId(Integer scheduleId) { this.scheduleId = scheduleId; }

    public String getTitle() { return title; }
    public void setTitle(String title) { this.title = title; }

    public String getTargetType() { return targetType; }
    public void setTargetType(String targetType) { this.targetType = targetType; }

    public Integer getTargetId() { return targetId; }
    public void setTargetId(Integer targetId) { this.targetId = targetId; }

    public String getScheduleType() { return scheduleType; }
    public void setScheduleType(String scheduleType) { this.scheduleType = scheduleType; }

    public Integer getDayOfWeek() { return dayOfWeek; }
    public void setDayOfWeek(Integer dayOfWeek) { this.dayOfWeek = dayOfWeek; }

    public Integer getDayOfMonth() { return dayOfMonth; }
    public void setDayOfMonth(Integer dayOfMonth) { this.dayOfMonth = dayOfMonth; }

    public String getExecuteTime() { return executeTime; }
    public void setExecuteTime(String executeTime) { this.executeTime = executeTime; }

    public String getIssueType() { return issueType; }
    public void setIssueType(String issueType) { this.issueType = issueType; }

    public String getIssuePriority() { return issuePriority; }
    public void setIssuePriority(String issuePriority) { this.issuePriority = issuePriority; }

    public Integer getAssignedStaffId() { return assignedStaffId; }
    public void setAssignedStaffId(Integer assignedStaffId) { this.assignedStaffId = assignedStaffId; }

    public String getAssignedStaffName() { return assignedStaffName; }
    public void setAssignedStaffName(String assignedStaffName) { this.assignedStaffName = assignedStaffName; }

    public Boolean getIsActive() { return isActive; }
    public void setIsActive(Boolean isActive) { this.isActive = isActive; }

    public String getLastExecutedAt() { return lastExecutedAt; }
    public void setLastExecutedAt(String lastExecutedAt) { this.lastExecutedAt = lastExecutedAt; }

    public String getNextExecuteAt() { return nextExecuteAt; }
    public void setNextExecuteAt(String nextExecuteAt) { this.nextExecuteAt = nextExecuteAt; }

    public String getCreatedAt() { return createdAt; }
    public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }

    public String getUpdatedAt() { return updatedAt; }
    public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }
}
</file>

<file path="backend/src/main/java/com/example/backend/dto/maintenance/MaintenanceStaffResponseDto.java">
package com.example.backend.dto.maintenance;

import java.time.LocalDateTime;

public class MaintenanceStaffResponseDto {

    private Integer staffId;
    private String staffName;
    private String staffCompany;
    private String staffEmail;
    private String staffPhone;
    private String staffNote;
    private Boolean isActive;
    private LocalDateTime createdAt;

    public MaintenanceStaffResponseDto() {}

    public MaintenanceStaffResponseDto(Integer staffId, String staffName, String staffCompany,
                                       String staffEmail, String staffPhone, String staffNote,
                                       Boolean isActive, LocalDateTime createdAt) {
        this.staffId = staffId;
        this.staffName = staffName;
        this.staffCompany = staffCompany;
        this.staffEmail = staffEmail;
        this.staffPhone = staffPhone;
        this.staffNote = staffNote;
        this.isActive = isActive;
        this.createdAt = createdAt;
    }

    public Integer getStaffId() { return staffId; }
    public void setStaffId(Integer staffId) { this.staffId = staffId; }

    public String getStaffName() { return staffName; }
    public void setStaffName(String staffName) { this.staffName = staffName; }

    public String getStaffCompany() { return staffCompany; }
    public void setStaffCompany(String staffCompany) { this.staffCompany = staffCompany; }

    public String getStaffEmail() { return staffEmail; }
    public void setStaffEmail(String staffEmail) { this.staffEmail = staffEmail; }

    public String getStaffPhone() { return staffPhone; }
    public void setStaffPhone(String staffPhone) { this.staffPhone = staffPhone; }

    public String getStaffNote() { return staffNote; }
    public void setStaffNote(String staffNote) { this.staffNote = staffNote; }

    public Boolean getIsActive() { return isActive; }
    public void setIsActive(Boolean isActive) { this.isActive = isActive; }

    public LocalDateTime getCreatedAt() { return createdAt; }
    public void setCreatedAt(LocalDateTime createdAt) { this.createdAt = createdAt; }
}
</file>

<file path="backend/src/main/java/com/example/backend/dto/RedemptionLogDTO.java">
package com.example.backend.dto;

import java.time.LocalDateTime;

import com.fasterxml.jackson.annotation.JsonFormat;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@AllArgsConstructor
@NoArgsConstructor
public class RedemptionLogDTO {
    private Integer logId;
    private Integer memId;
    private Integer couponId;
    private Integer pointsSpent;
    private String couponName;
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss")
    private LocalDateTime redeemTime;
    private String merchantName; // é€™æ˜¯å‰ç«¯è¦çš„æ¬„ä½
}
</file>

<file path="backend/src/main/java/com/example/backend/integration/èªªæ˜.txt">
æœªä¾†ä½¿ç”¨ å°å¤–APIå¯ä»¥å¯«åœ¨é€™ï¼Œè³‡æ–™æ¶æ§‹åƒä¸‹é¢é€™æ¨£

å‡è¨­ä¹‹å¾Œä½¿ç”¨ ç¶ ç•Œã€Googleï¼Œå°±åœ¨integrationé€™å€‹è³‡æ–™å¤¾åº•ä¸‹é–‹ä»–å€‘çš„è³‡æ–™å¤¾

 â”€â”€ ecpay/
    â”œâ”€â”€ client/  â† å°è£ã€Œæ€éº¼å‘¼å«å¤–éƒ¨ APIã€
    â”œâ”€â”€ dto/      â† å¤–éƒ¨ API çš„ Request/Response è³‡æ–™æ ¼å¼
    â””â”€â”€ config/  â† è®€ ymlã€å»º HTTP Client Beanï¼ˆbaseUrl/timeout/Keyï¼‰
â”€â”€ google/
    â”œâ”€â”€ client/
    â”œâ”€â”€ dto/
    â””â”€â”€ config/

config è§£é‡‹ï¼ˆè¨­å®š/é€£ç·šï¼‰

*Propertiesï¼šå¾ymlè®€å– baseUrlã€timeoutã€apiKeyã€merchantId...

*Configï¼šå»ºç«‹ HTTP clientï¼ˆRestClient/WebClientï¼‰ï¼ŒæŠŠ baseUrlã€timeoutã€é è¨­ header æ”¾é€²å»

config åªç®¡ã€Œé€£ç·šæ€éº¼å»ºã€èˆ‡ã€Œè¨­å®šæ€éº¼è®€ã€

==================================================================
dto åšä»€éº¼ï¼ˆå¤–éƒ¨è³‡æ–™æ¨¡å‹ï¼‰

XxxRequestï¼šå¤–éƒ¨ API è¦ä½ é€çš„æ¬„ä½

XxxResponseï¼šå¤–éƒ¨ API å›ä½ çš„æ¬„ä½

ï¼ˆå¯é¸ï¼‰XxxErrorResponseï¼šå¤–éƒ¨å›ºå®šçš„éŒ¯èª¤æ ¼å¼

DTO åªæè¿°å¤–éƒ¨æ ¼å¼ï¼Œä¸æ”¾å•†æ¥­é‚è¼¯

=============================================================
client åšä»€éº¼ï¼ˆå‘¼å«å°è£ï¼‰

å°å¤–åªæš´éœ²ã€Œä¹¾æ·¨çš„æ–¹æ³•ã€

createPayment(...) / geocode(...)

è£¡é¢è² è²¬ï¼š
æ‹¼URI / queryParam

è¨­headerï¼ˆAuthorization / keyï¼‰

å‘¼å«GET/POST

æŠŠå›æ‡‰è§£ææˆ Response DTO

æŠŠå¤–éƒ¨éŒ¯èª¤è½‰æˆç³»çµ±å¯ç†è§£çš„ exceptionï¼ˆæˆ–å›å‚³çµ±ä¸€æ ¼å¼ï¼‰

åŸå‰‡ï¼šservice åª call clientï¼Œä¸è‡ªå·±ç¢° URL/Key/HTTP
</file>

<file path="backend/src/main/java/com/example/backend/model/maintenance/MaintenanceInformation.java">
package com.example.backend.model.maintenance;

import com.fasterxml.jackson.annotation.JsonIgnoreProperties;
import jakarta.persistence.*;
import java.time.LocalDateTime;

import org.hibernate.annotations.NotFound;
import org.hibernate.annotations.NotFoundAction;

@Entity
@Table(name = "maintenanceInformation")
public class MaintenanceInformation {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "ticketId")
    private Integer ticketId;

    @Column(name = "spotId")
    private Integer spotId;

    //æ–°å¢å°æ‡‰è³‡æ–™åº« seatsId æ¬„ä½
    @Column(name = "seatsId")
    private Integer seatsId;

    @Column(name = "issueType", nullable = false, length = 200)
    private String issueType;

    @Column(name = "issueDesc", length = 500)
    private String issueDesc;

    @Column(name = "issuePriority", nullable = false, length = 100)
    private String issuePriority;

    @Column(name = "issueStatus", nullable = false, length = 50)
    private String issueStatus;

    @Column(name = "assignedStaffId")
    private Integer assignedStaffId;

    // â˜… ä¿®æ­£ï¼šinsertable=false, updatable=false ä»£è¡¨é€™æ¬„ä½åªè² è²¬ã€Œè®€è³‡æ–™ã€ï¼Œå¯«å…¥é‚„æ˜¯é ä¸Šé¢çš„ assignedStaffId
    // â˜… ä¿®æ­£ï¼šåŠ ä¸Š @JsonIgnoreProperties é˜²æ­¢ JSON åºåˆ—åŒ–æ™‚ç„¡é™è¿´åœˆ
    @ManyToOne(fetch = FetchType.EAGER)
    @JoinColumn(name = "assignedStaffId", insertable = false, updatable = false)
    @NotFound(action = NotFoundAction.IGNORE)
    @JsonIgnoreProperties({"maintenanceInformations", "hibernateLazyInitializer", "handler"})
    private MaintenanceStaff assignedStaff;

    // ================== Task 4: æ–°å¢ç«™é»èˆ‡åº§ä½é—œè¯ ==================
    
    // é—œè¯åˆ°æ“šé»è³‡æ–™ï¼Œç”¨æ–¼é¡¯ç¤ºç«™é»åç¨±
    @ManyToOne(fetch = FetchType.EAGER)
    @JoinColumn(name = "spotId", insertable = false, updatable = false)
    @NotFound(action = NotFoundAction.IGNORE)
    @JsonIgnoreProperties({"hibernateLazyInitializer", "handler"})
    private com.example.backend.model.spot.RentalSpot rentalSpot;

    // é—œè¯åˆ°åº§ä½è³‡æ–™ï¼Œç”¨æ–¼é¡¯ç¤ºåº§ä½åç¨±
    @ManyToOne(fetch = FetchType.EAGER)
    @JoinColumn(name = "seatsId", insertable = false, updatable = false)
    @NotFound(action = NotFoundAction.IGNORE)
    @JsonIgnoreProperties({"hibernateLazyInitializer", "handler"})
    private com.example.backend.model.spot.Seat seat;




    // DB DEFAULT SYSDATETIME()ï¼šå»ºè­°ç”± DB ç”¢ç”Ÿ
    @Column(name = "reportedAt", insertable = false, updatable = false)
    private LocalDateTime reportedAt;

    @Column(name = "startAt")
    private LocalDateTime startAt;

    @Column(name = "resolvedAt")
    private LocalDateTime resolvedAt;

    @Column(name = "resolveNote", length = 500)
    private String resolveNote;

    @Column(name = "resultType", length = 50)
    private String resultType;

    public MaintenanceInformation() {}

    // getters/setters
    public Integer getTicketId() { return ticketId; }
    public void setTicketId(Integer ticketId) { this.ticketId = ticketId; }

    public Integer getSpotId() { return spotId; }
    public void setSpotId(Integer spotId) { this.spotId = spotId; }

    public Integer getSeatsId() { return seatsId; }
    public void setSeatsId(Integer seatsId) { this.seatsId = seatsId;}

    public String getIssueType() { return issueType; }
    public void setIssueType(String issueType) { this.issueType = issueType; }

    public String getIssueDesc() { return issueDesc; }
    public void setIssueDesc(String issueDesc) { this.issueDesc = issueDesc; }

    public String getIssuePriority() { return issuePriority; }
    public void setIssuePriority(String issuePriority) { this.issuePriority = issuePriority; }

    public String getIssueStatus() { return issueStatus; }
    public void setIssueStatus(String issueStatus) { this.issueStatus = issueStatus; }

    public Integer getAssignedStaffId() { return assignedStaffId; }
    public void setAssignedStaffId(Integer assignedStaffId) { this.assignedStaffId = assignedStaffId; }

    public LocalDateTime getReportedAt() { return reportedAt; }
    public void setReportedAt(LocalDateTime reportedAt) { this.reportedAt = reportedAt; }

    public LocalDateTime getStartAt() { return startAt; }
    public void setStartAt(LocalDateTime startAt) { this.startAt = startAt; }

    public LocalDateTime getResolvedAt() { return resolvedAt; }
    public void setResolvedAt(LocalDateTime resolvedAt) { this.resolvedAt = resolvedAt; }

    public String getResolveNote() { return resolveNote; }
    public void setResolveNote(String resolveNote) { this.resolveNote = resolveNote; }

    public String getResultType() { return resultType; }
    public void setResultType(String resultType) { this.resultType = resultType; }


    // Getter & Setter
    public MaintenanceStaff getAssignedStaff() {
        return assignedStaff;
    }

    public void setAssignedStaff(MaintenanceStaff assignedStaff) {
        this.assignedStaff = assignedStaff;
    }

    // ================== Task 4: æ–°å¢é—œè¯çš„ Getter/Setter ==================
    
    public com.example.backend.model.spot.RentalSpot getRentalSpot() {
        return rentalSpot;
    }

    public void setRentalSpot(com.example.backend.model.spot.RentalSpot rentalSpot) {
        this.rentalSpot = rentalSpot;
    }

    public com.example.backend.model.spot.Seat getSeat() {
        return seat;
    }

    public void setSeat(com.example.backend.model.spot.Seat seat) {
        this.seat = seat;
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/model/maintenance/MaintenanceLog.java">
package com.example.backend.model.maintenance;

import com.fasterxml.jackson.annotation.JsonBackReference;
import jakarta.persistence.*;
import java.time.LocalDateTime;

/**
 * ç¶­ä¿®æ­·ç¨‹è¨˜éŒ„è¡¨ (Audit Log)
 * è¨˜éŒ„å·¥å–®çš„æ¯ä¸€æ¬¡ç‹€æ…‹è®Šæ›´ã€æ“ä½œè¨˜éŒ„
 */
@Entity
@Table(name = "maintenanceLog")
public class MaintenanceLog {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "logId")
    private Integer logId;

    /**
     * é—œè¯å·¥å–® (å¤šå°ä¸€)
     * ä½¿ç”¨ @JsonBackReference é˜²æ­¢åºåˆ—åŒ–æ™‚ç™¼ç”Ÿç„¡é™è¿´åœˆ
     */
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "ticketId", nullable = false)
    @JsonBackReference
    private MaintenanceInformation ticket;

    @Column(name = "operator", nullable = false, length = 50)
    private String operator; // æ“ä½œè€… (æ”¯æ´ä¸­æ–‡)

    @Column(name = "action", nullable = false, length = 50)
    private String action; // å‹•ä½œä»£è™Ÿ (CREATED, ASSIGNED, STARTED, RESOLVED, CANCELLED)

    @Column(name = "comment", length = 500)
    private String comment; // è©³ç´°èªªæ˜ (å¯é¸)

    /**
     * ç™¼ç”Ÿæ™‚é–“ (ç”± DB è‡ªå‹•ç”¢ç”Ÿ)
     * insertable = false, updatable = false ç¢ºä¿æ‡‰ç”¨å±¤ä¸æœƒè¦†è“‹ DB é è¨­å€¼
     */
    @Column(name = "createdAt", nullable = false, insertable = false, updatable = false)
    private LocalDateTime createdAt;

    // ========== Constructors ==========

    public MaintenanceLog() {}

    /**
     * å¿«é€Ÿå»ºæ§‹å­ (ç”¨æ–¼ Service å±¤å»ºç«‹ Log)
     */
    public MaintenanceLog(MaintenanceInformation ticket, String operator, String action, String comment) {
        this.ticket = ticket;
        this.operator = operator;
        this.action = action;
        this.comment = comment;
    }

    // ========== Getters & Setters ==========

    public Integer getLogId() {
        return logId;
    }

    public void setLogId(Integer logId) {
        this.logId = logId;
    }

    public MaintenanceInformation getTicket() {
        return ticket;
    }

    public void setTicket(MaintenanceInformation ticket) {
        this.ticket = ticket;
    }

    public String getOperator() {
        return operator;
    }

    public void setOperator(String operator) {
        this.operator = operator;
    }

    public String getAction() {
        return action;
    }

    public void setAction(String action) {
        this.action = action;
    }

    public String getComment() {
        return comment;
    }

    public void setComment(String comment) {
        this.comment = comment;
    }

    public LocalDateTime getCreatedAt() {
        return createdAt;
    }

    public void setCreatedAt(LocalDateTime createdAt) {
        this.createdAt = createdAt;
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/model/maintenance/MaintenanceSchedule.java">
package com.example.backend.model.maintenance;

import jakarta.persistence.*;
import lombok.Data;

import java.time.LocalDateTime;
import java.time.LocalTime;

/**
 * å®šæœŸç¶­è­·æ’ç¨‹ Entity
 * å°æ‡‰è³‡æ–™è¡¨ maintenanceSchedule
 */
@Data
@Entity
@Table(name = "maintenanceSchedule")
public class MaintenanceSchedule {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "scheduleId")
    private Integer scheduleId;

    @Column(name = "title", nullable = false, length = 100)
    private String title;

    /**
     * ç›®æ¨™é¡å‹ï¼š'SPOT' æˆ– 'SEAT'
     */
    @Column(name = "targetType", nullable = false, length = 20)
    private String targetType;

    /**
     * ç›®æ¨™ IDï¼ˆå°æ‡‰ spotId æˆ– seatsIdï¼‰
     */
    @Column(name = "targetId", nullable = false)
    private Integer targetId;

    /**
     * æ’ç¨‹é¡å‹ï¼š'DAILY', 'WEEKLY', 'MONTHLY'
     */
    @Column(name = "scheduleType", nullable = false, length = 20)
    private String scheduleType;

    /**
     * æ˜ŸæœŸå¹¾ (1-7)ï¼Œé€±æ’ç¨‹æ™‚ä½¿ç”¨
     */
    @Column(name = "dayOfWeek")
    private Integer dayOfWeek;

    /**
     * æ¯æœˆå¹¾è™Ÿ (1-31)ï¼Œæœˆæ’ç¨‹æ™‚ä½¿ç”¨
     */
    @Column(name = "dayOfMonth")
    private Integer dayOfMonth;

    /**
     * åŸ·è¡Œæ™‚é–“ (æ™‚:åˆ†:ç§’)
     */
    @Column(name = "executeTime", nullable = false)
    private LocalTime executeTime;

    /**
     * å•é¡Œé¡å‹
     */
    @Column(name = "issueType", nullable = false, length = 200)
    private String issueType;

    /**
     * å•é¡Œå„ªå…ˆç´šï¼š'LOW', 'NORMAL', 'HIGH', 'URGENT'
     */
    @Column(name = "issuePriority", nullable = false, length = 50)
    private String issuePriority;

    /**
     * æŒ‡æ´¾çš„ç¶­è­·äººå“¡ ID
     */
    @Column(name = "assignedStaffId")
    private Integer assignedStaffId;

    /**
     * æ˜¯å¦å•Ÿç”¨
     */
    @Column(name = "isActive", nullable = false)
    private Boolean isActive;

    /**
     * ä¸Šæ¬¡åŸ·è¡Œæ™‚é–“
     */
    @Column(name = "lastExecutedAt")
    private LocalDateTime lastExecutedAt;

    /**
     * ä¸‹æ¬¡é è¨ˆåŸ·è¡Œæ™‚é–“
     */
    @Column(name = "nextExecuteAt", nullable = false)
    private LocalDateTime nextExecuteAt;

    /**
     * å»ºç«‹æ™‚é–“ï¼ˆç”± DB è‡ªå‹•ç”¢ç”Ÿï¼‰
     */
    @Column(name = "createdAt", insertable = false, updatable = false)
    private LocalDateTime createdAt;

    /**
     * æ›´æ–°æ™‚é–“ï¼ˆç”± DB è‡ªå‹•ç”¢ç”Ÿï¼‰
     */
    @Column(name = "updatedAt", insertable = false, updatable = false)
    private LocalDateTime updatedAt;
}
</file>

<file path="backend/src/main/java/com/example/backend/model/merchantAndCoupon/DiscountBean.java">
package com.example.backend.model.merchantAndCoupon;

import java.io.Serializable;
import java.time.LocalDate;
import java.time.LocalDateTime;
import jakarta.persistence.*;
import lombok.Getter;
import lombok.Setter;
import lombok.NoArgsConstructor;
import com.fasterxml.jackson.annotation.JsonIgnoreProperties;

@Entity
@Table(name = "discount")
@Getter // æ”¹ç”¨ Getter/Setterï¼Œæ¯” @Data å®‰å…¨
@Setter
@NoArgsConstructor
@JsonIgnoreProperties(ignoreUnknown = true)
public class DiscountBean implements Serializable {
    private static final long serialVersionUID = 1L;

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "couponId")
    private Integer couponId;

    @Column(name = "couponName")
    private String couponName;

    @Column(name = "couponDescription")
    private String couponDescription;

    @Column(name = "pointsRequired")
    private Integer pointsRequired;

    @Column(name = "startDate")
    private LocalDate startDate;

    @Column(name = "endDate")
    private LocalDate endDate;

    @Column(name = "merchantId")
    private Integer merchantId;

    @Column(name = "couponStatus")
    private Integer couponStatus;

    @Column(name = "couponImg")
    private String couponImg;

    @Column(name = "createdTime", insertable = false, updatable = false)
    private LocalDateTime createdTime;

    // é—œè¯å•†å®¶ (åŠ ä¸Š Lazy è¼‰å…¥ï¼Œä¸¦é˜²æ­¢åºåˆ—åŒ–å ±éŒ¯)
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "merchantId", insertable = false, updatable = false)
    @JsonIgnoreProperties({ "hibernateLazyInitializer", "handler" })
    private MerchantBean merchant;

    /**
     * é€™è£¡ä¸æ˜¯è³‡æ–™åº«æ¬„ä½ï¼Œä½†è½‰ JSON æ™‚æœƒè‡ªå‹•ç”¢ç”Ÿ "merchantName" å±¬æ€§ã€‚
     * å‰ç«¯ Vue çœ‹åˆ°çš„ JSON çµæ§‹è·ŸåŸæœ¬ä¸€æ¨¡ä¸€æ¨£ï¼Œæ‰€ä»¥ç•«é¢ä¸æœƒå£ã€‚
     */
    @Transient
    public String getMerchantName() {
        return merchant != null ? merchant.getMerchantName() : null;
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/model/merchantAndCoupon/MerchantBean.java">
package com.example.backend.model.merchantAndCoupon;

import jakarta.persistence.*;
import lombok.Getter;
import lombok.Setter;
import lombok.NoArgsConstructor;
import java.time.LocalDateTime;

@Entity
@Table(name = "merchant")
@Getter // ç¢ºä¿ä½¿ç”¨ Getter/Setter
@Setter
@NoArgsConstructor
public class MerchantBean implements java.io.Serializable {
    private static final long serialVersionUID = 1L;

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "merchantId")
    private Integer merchantId;

    @Column(name = "merchantName")
    private String merchantName;

    @Column(name = "merchantPhone")
    private String merchantPhone;

    @Column(name = "merchantEmail")
    private String merchantEmail;

    @Column(name = "merchantAddress")
    private String merchantAddress;

    @Column(name = "merchantStatus")
    private int merchantStatus;

    @Column(name = "createdTime", insertable = false, updatable = false)
    private LocalDateTime createdTime;

    @Override
    public String toString() {
        return "MerchantBean [merchantId=" + merchantId + ", merchantName=" + merchantName + "]";
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/model/merchantAndCoupon/RedemptionLog.java">
package com.example.backend.model.merchantAndCoupon;

import jakarta.persistence.*;
import lombok.Data;
import org.hibernate.annotations.CreationTimestamp;
import java.time.LocalDateTime;

@Entity
@Table(name = "redemption_log")
@Data // å¦‚æœä½ æ²’ç”¨ Lombokï¼Œè«‹æ‰‹å‹•ç”¢ç”Ÿ Getter/Setter
public class RedemptionLog {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Integer logId;

    // é—œé€£æœƒå“¡ ID
    @Column(name = "memId", nullable = false)
    private Integer memId;

    // é—œé€£å„ªæƒ åˆ¸ ID
    @Column(name = "couponId", nullable = false)
    private Integer couponId;

    // è¨˜éŒ„ç•¶ä¸‹æ‰£äº†å¤šå°‘é» (é é˜²ä»¥å¾Œå„ªæƒ åˆ¸æ”¹åƒ¹éŒ¢ï¼Œç´€éŒ„è¦ç¶­æŒç•¶åˆçš„é»æ•¸)
    @Column(name = "pointsSpent", nullable = false)
    private Integer pointsSpent;

    // è¨˜éŒ„æ ¸éŠ·æ™‚çš„å„ªæƒ åˆ¸åç¨± (å­˜å¿«ç…§ï¼Œé¿å…åŸå„ªæƒ åˆ¸è¢«åˆªé™¤å¾Œæ‰¾ä¸åˆ°åç¨±)
    @Column(name = "couponName", length = 100)
    private String couponName;

    @CreationTimestamp
    @Column(name = "redeemTime", nullable = false, updatable = false)
    private LocalDateTime redeemTime;

    public RedemptionLog() {
    }

    // æ–¹ä¾¿ç”¨çš„å»ºæ§‹å­
    public RedemptionLog(Integer memId, Integer couponId, Integer pointsSpent, String couponName) {
        this.memId = memId;
        this.couponId = couponId;
        this.pointsSpent = pointsSpent;
        this.couponName = couponName;
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/model/merchantAndCoupon/Result.java">
package com.example.backend.model.merchantAndCoupon;

import lombok.Data;

@Data
public class Result<T> {
    private Integer code;    // 200:æˆåŠŸ, 500:å¤±æ•—
    private String message;  // æç¤ºè¨Šæ¯
    private T data;          // å¯¦éš›è³‡æ–™å…§å®¹

    public static <T> Result<T> success(T data, String msg) {
        Result<T> r = new Result<>();
        r.code = 200;
        r.data = data;
        r.message = msg;
        return r;
    }

    public static <T> Result<T> error(String msg) {
        Result<T> r = new Result<>();
        r.code = 500;
        r.message = msg;
        return r;
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/model/rec/RentDetails.java">
package com.example.backend.model.rec;

import java.time.LocalDateTime;

import org.hibernate.annotations.Immutable;

import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.Id;
import jakarta.persistence.Table;
import lombok.Getter;

@Getter
@Entity
@Immutable // æ¨™è¨˜ç‚ºå”¯è®€ï¼Œå› ç‚ºé€™æ˜¯ View
@Table(name = "V_RentDetails")
public class RentDetails {

    @Id
    @Column(name = "recId")
    private String recId;

    @Column(name = "memId")
    private Integer memId;

    @Column(name = "memName")
    private String memName;

    @Column(name = "couponId")
    private Integer couponId;

    @Column(name = "couponDesc")
    private String couponDesc;

    @Column(name = "seatsId")
    private String seatsId;

    @Column(name = "spotIdRent")
    private Integer spotIdRent;

    @Column(name = "RentSpotName")
    private String rentSpotName;

    @Column(name = "spotIdReturn")
    private Integer spotIdReturn;

    @Column(name = "ReturnSpotName")
    private String returnSpotName;

    @Column(name = "recRentDT2")
    private LocalDateTime recRentDT2;

    @Column(name = "recReturnDT2")
    private LocalDateTime recReturnDT2;

    @Column(name = "recUsageDT2")
    private Integer recUsageDT2;

    @Column(name = "recPrice")
    private Integer recPrice;

    @Column(name = "recRequestPay")
    private Integer recRequestPay;

    @Column(name = "recPayment")
    private Integer recPayment;

    @Column(name = "recPayBy")
    private String recPayBy;

    @Column(name = "recInvoice")
    private String recInvoice;

    @Column(name = "recCarrier")
    private String recCarrier;

    @Column(name = "recViolatInt")
    private Integer recViolatInt;

    @Column(name = "recNote")
    private String recNote;

    @Column(name = "recStatus")
    private String recStatus;

}
</file>

<file path="backend/src/main/java/com/example/backend/repository/maintenance/MaintenanceInformationRepository.java">
package com.example.backend.repository.maintenance;

import com.example.backend.model.maintenance.MaintenanceInformation;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.List;

public interface MaintenanceInformationRepository extends JpaRepository<MaintenanceInformation, Integer> {

    List<MaintenanceInformation> findBySpotIdOrderByReportedAtDescTicketIdAsc(Integer spotId);

    // ç”¨æ–¼ç‹€æ…‹æŸ¥è©¢
    List<MaintenanceInformation> findByIssueStatusOrderByReportedAtDescTicketIdAsc(String issueStatus);

    // ç”¨æ–¼ In List æŸ¥è©¢ (Active / History)
    List<MaintenanceInformation> findByIssueStatusInOrderByReportedAtDescTicketIdAsc(List<String> issueStatusList);

    // æŸ¥è©¢å…¨éƒ¨ä¸¦æ’åº (è§£æ±º getAllTickets æ²’æ’åºçš„å•é¡Œ)
    List<MaintenanceInformation> findAllByOrderByReportedAtDescTicketIdAsc();

    //è®“æˆ‘å€‘å¯ä»¥æŸ¥æŸå¼µæ¤…å­çš„æ‰€æœ‰å·¥å–®
    List<MaintenanceInformation> findBySeatsIdOrderByReportedAtDescTicketIdAsc(Integer seatsId);

    //ç”¨æ–¼è½‰ç§»å·¥å–®
    // åœ¨ interface è£¡é¢æ–°å¢é€™è¡Œ
List<MaintenanceInformation> findByAssignedStaffIdAndIssueStatusIn(Integer assignedStaffId, List<String> issueStatuses);

boolean existsByAssignedStaffIdAndIssueStatusIn(Integer assignedStaffId, List<String> statuses);

    // ========== æ–°å¢ï¼šTask 2 æ­·å²å·¥å–®æŸ¥è©¢æ”¯æ´ ==========
    
    /**
     * æŸ¥è©¢æŒ‡å®šäººå“¡çš„å·¥å–®ï¼ˆä¾ç‹€æ…‹ç¯©é¸ï¼‰
     */
    List<MaintenanceInformation> findByAssignedStaffIdOrderByReportedAtDescTicketIdAsc(Integer assignedStaffId);
    
    /**
     * æŸ¥è©¢æŒ‡å®šäººå“¡çš„ç‰¹å®šç‹€æ…‹å·¥å–®
     */
    List<MaintenanceInformation> findByAssignedStaffIdAndIssueStatusInOrderByReportedAtDescTicketIdAsc(Integer assignedStaffId, List<String> issueStatuses);

    // ========== é˜²çˆ†å–®æª¢æŸ¥ (æ’ç¨‹è‡ªå‹•é–‹å–®ç”¨) ==========
    
    /**
     * æª¢æŸ¥æŸæ©Ÿå°æ˜¯å¦æœ‰æœªçµæ¡ˆå·¥å–® (SPOT)
     */
    boolean existsBySpotIdAndSeatsIdIsNullAndIssueStatusIn(Integer spotId, List<String> statuses);

    /**
     * æª¢æŸ¥æŸæ¤…å­æ˜¯å¦æœ‰æœªçµæ¡ˆå·¥å–® (SEAT)
     */
    boolean existsBySeatsIdAndIssueStatusIn(Integer seatsId, List<String> statuses);

    
}
</file>

<file path="backend/src/main/java/com/example/backend/repository/maintenance/MaintenanceLogRepository.java">
package com.example.backend.repository.maintenance;

import com.example.backend.model.maintenance.MaintenanceLog;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.List;

/**
 * ç¶­ä¿®æ­·ç¨‹ Repository
 */
@Repository
public interface MaintenanceLogRepository extends JpaRepository<MaintenanceLog, Integer> {

    /**
     * æŸ¥è©¢æŒ‡å®šå·¥å–®çš„æ‰€æœ‰æ­·ç¨‹è¨˜éŒ„ï¼ŒæŒ‰æ™‚é–“å€’åºæ’åˆ— (æœ€æ–°çš„åœ¨å‰)
     * æ–¹æ³•å‘½åè¦å‰‡ï¼šfindBy + é—œè¯ç‰©ä»¶ + é—œè¯ç‰©ä»¶æ¬„ä½ + OrderBy + æ’åºæ¬„ä½ + æ’åºæ–¹å‘
     */
    List<MaintenanceLog> findByTicketTicketIdOrderByCreatedAtDesc(Integer ticketId);
}
</file>

<file path="backend/src/main/java/com/example/backend/repository/maintenance/MaintenanceScheduleRepository.java">
package com.example.backend.repository.maintenance;

import com.example.backend.model.maintenance.MaintenanceSchedule;
import org.springframework.data.jpa.repository.JpaRepository;

import java.time.LocalDateTime;
import java.util.List;

/**
 * å®šæœŸç¶­è­·æ’ç¨‹ Repository
 */
public interface MaintenanceScheduleRepository extends JpaRepository<MaintenanceSchedule, Integer> {

    /**
     * æŸ¥è©¢æ‰€æœ‰å·²åˆ°æœŸä¸”ä»å•Ÿç”¨çš„æ’ç¨‹
     * ç”¨æ–¼å®šæ™‚ä»»å‹™ï¼šæ‰¾å‡º nextExecuteAt < now ä¸” isActive = true çš„æ’ç¨‹
     *
     * @param now ç•¶å‰æ™‚é–“
     * @return éœ€è¦åŸ·è¡Œçš„æ’ç¨‹æ¸…å–®
     */
    List<MaintenanceSchedule> findByNextExecuteAtBeforeAndIsActiveTrue(LocalDateTime now);

    /**
     * ä¾å•Ÿç”¨ç‹€æ…‹æŸ¥è©¢æ’ç¨‹
     *
     * @param isActive æ˜¯å¦å•Ÿç”¨
     * @return æ’ç¨‹æ¸…å–®
     */
    List<MaintenanceSchedule> findByIsActive(Boolean isActive);

    /**
     * ä¾ç›®æ¨™é¡å‹å’Œç›®æ¨™ ID æŸ¥è©¢æ’ç¨‹
     *
     * @param targetType ç›®æ¨™é¡å‹ (SPOT/SEAT)
     * @param targetId   ç›®æ¨™ ID
     * @return æ’ç¨‹æ¸…å–®
     */
    List<MaintenanceSchedule> findByTargetTypeAndTargetId(String targetType, Integer targetId);

    /**
     * ä¾æŒ‡æ´¾äººå“¡æŸ¥è©¢æ’ç¨‹
     *
     * @param assignedStaffId äººå“¡ ID
     * @return æ’ç¨‹æ¸…å–®
     */
    List<MaintenanceSchedule> findByAssignedStaffId(Integer assignedStaffId);
}
</file>

<file path="backend/src/main/java/com/example/backend/repository/maintenance/MaintenanceStaffRepository.java">
package com.example.backend.repository.maintenance;

import java.util.List;

import org.springframework.data.jpa.repository.JpaRepository;

import com.example.backend.model.maintenance.MaintenanceStaff;

public interface MaintenanceStaffRepository extends JpaRepository<MaintenanceStaff, Integer> {

    // æª¢æŸ¥ email æ˜¯å¦å­˜åœ¨ (å¿½ç•¥å¤§å°å¯«) - ç”¨æ–¼ create
    boolean existsByStaffEmailIgnoreCase(String staffEmail);

    // æŸ¥è©¢ email (å¿½ç•¥å¤§å°å¯«) - ç”¨æ–¼ update æª¢æŸ¥
    MaintenanceStaff findByStaffEmailIgnoreCase(String staffEmail);

    MaintenanceStaff findByStaffEmail(String staffEmail);

    List<MaintenanceStaff> findByStaffCompany(String staffCompany);

    // ä¿®å¾©ï¼šæ ¹æ“šå•Ÿç”¨ç‹€æ…‹æŸ¥è©¢äººå“¡
    List<MaintenanceStaff> findByIsActive(Boolean isActive);

    List<MaintenanceStaff> findByIsActiveTrueOrderByStaffIdAsc();

    List<MaintenanceStaff> findByIsActiveFalseOrderByStaffIdAsc();
    
}
</file>

<file path="backend/src/main/java/com/example/backend/repository/member/CustomOAuth2UserService.java">
package com.example.backend.repository.member;

import java.util.Optional;
import java.util.UUID;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.oauth2.client.userinfo.DefaultOAuth2UserService;
import org.springframework.security.oauth2.client.userinfo.OAuth2UserRequest;
import org.springframework.security.oauth2.core.OAuth2AuthenticationException;
import org.springframework.security.oauth2.core.user.OAuth2User;
import org.springframework.stereotype.Service;

import com.example.backend.model.member.Member;

@Service
public class CustomOAuth2UserService extends DefaultOAuth2UserService {

    @Autowired
    private MemberRepository memberRepository;

    @Override
    public OAuth2User loadUser(OAuth2UserRequest userRequest) throws OAuth2AuthenticationException {
        OAuth2User oAuth2User = super.loadUser(userRequest);

        String email = oAuth2User.getAttribute("email"); // ä¾‹å¦‚: alan123@gmail.com
        String name = oAuth2User.getAttribute("name"); // ä¾‹å¦‚: æ—å°å®‰

        Optional<Member> memberOptional = memberRepository.findByMemEmail(email);

        if (memberOptional.isEmpty()) {
            Member newMember = new Member();
            newMember.setMemEmail(email);
            newMember.setMemName(name);

            // --- é—œéµä¿®æ”¹ï¼šæˆªå– Gmail @ å‰é¢çš„å­—ä¸²ç•¶ä½œå¸³è™Ÿ ---
            if (email != null && email.contains("@")) {
                String username = email.split("@")[0];
                newMember.setMemUsername(username); // è¨­å®šç‚º alan123
            } else {
                newMember.setMemUsername(email); // å‚™æ¡ˆ
            }

            // è™•ç†è³‡æ–™åº« NOT NULL é™åˆ¶
            newMember.setMemPassword("OAUTH_USER_" + UUID.randomUUID().toString().substring(0, 8));
            newMember.setMemPhone("æœªè¨­å®š");

            // æ ¹æ“šä½ è³‡æ–™è¡¨çš„é è¨­å€¼
            newMember.setMemStatus(1);
            newMember.setMemPoints(0);
            newMember.setMemViolation(0);
            newMember.setMemLevel(1);

            memberRepository.save(newMember);
        }

        return oAuth2User;
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/repository/merchantAndCoupon/DiscountRepository.java">
package com.example.backend.repository.merchantAndCoupon;

import com.example.backend.model.merchantAndCoupon.DiscountBean;
import org.springframework.data.jpa.repository.EntityGraph; // å¿…é ˆæœ‰é€™å€‹ import
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Modifying;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;

@Repository
public interface DiscountRepository extends JpaRepository<DiscountBean, Integer> {

        // [é‡é»] é€™è£¡ä¸€å®šè¦æœ‰ @EntityGraphï¼Œä¸ç„¶å‰ç«¯æ‹¿åˆ°è³‡æ–™æœƒæ²’æœ‰ merchantName
        @Override
        @EntityGraph(attributePaths = "merchant")
        List<DiscountBean> findAll();

        @Override
        @EntityGraph(attributePaths = "merchant")
        Optional<DiscountBean> findById(Integer id);

        @Modifying(clearAutomatically = true, flushAutomatically = true)
        @Query(value = "UPDATE d SET d.couponStatus = CASE " +
                        "WHEN m.merchantStatus = 0 THEN 3 " + // å•†å®¶åœç”¨å„ªå…ˆæ¬Šæœ€é«˜ï¼Œå¼·åˆ¶ä¸‹æ¶
                        "WHEN d.endDate < CAST(GETDATE() AS DATE) THEN 2 " +
                        "WHEN d.startDate > CAST(GETDATE() AS DATE) THEN 0 " +
                        "ELSE 1 END " +
                        "FROM discount d " +
                        "JOIN merchant m ON d.merchantId = m.merchantId " + // é—œè¯å•†å®¶è¡¨
                        "WHERE d.couponStatus != 3 OR m.merchantStatus = 0", nativeQuery = true)
        int autoUpdateStatus();

        // [é‡é»] é€™è£¡ä¹Ÿè¦æœ‰
        @EntityGraph(attributePaths = "merchant")
        @Query("SELECT d FROM DiscountBean d LEFT JOIN d.merchant m " +
                        "WHERE d.couponName LIKE %:keyword% " +
                        "OR d.couponDescription LIKE %:keyword% " +
                        "OR m.merchantName LIKE %:keyword%") // åŠ ä¸Šå•†å®¶åç¨±æœå°‹ï¼Œæ›´ç¬¦åˆç›´è¦º
        List<DiscountBean> findByKeyword(@Param("keyword") String keyword);

        // [é‡é»] é€™è£¡ä¹Ÿè¦æœ‰
        @EntityGraph(attributePaths = "merchant")
        List<DiscountBean> findByMerchantId(Integer merchantId);

        @Modifying(clearAutomatically = true, flushAutomatically = true)
        @Query("UPDATE DiscountBean d SET d.couponStatus = 3 WHERE d.merchantId = :merchantId AND d.couponStatus != 3")
        void disableAllByMerchantId(@Param("merchantId") Integer merchantId);

        @Modifying(clearAutomatically = true, flushAutomatically = true)
        @Query(value = "UPDATE discount SET couponStatus = CASE " +
                        "WHEN endDate < CAST(GETDATE() AS DATE) THEN 2 " +
                        "WHEN startDate > CAST(GETDATE() AS DATE) THEN 0 " +
                        "ELSE 1 END " +
                        "WHERE merchantId = :merchantId AND couponStatus = 3", nativeQuery = true)
        void relistAllByMerchantId(@Param("merchantId") Integer merchantId);
}
</file>

<file path="backend/src/main/java/com/example/backend/repository/merchantAndCoupon/MerchantRepository.java">
package com.example.backend.repository.merchantAndCoupon;

import com.example.backend.model.merchantAndCoupon.MerchantBean;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param; // è¨˜å¾— import
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface MerchantRepository extends JpaRepository<MerchantBean, Integer> {

    // [ç·¨è­¯å®‰å…¨] åŠ ä¸Š @Param
    @Query("SELECT m FROM MerchantBean m WHERE m.merchantName LIKE %:keyword% OR m.merchantAddress LIKE %:keyword%")
    List<MerchantBean> findByKeyword(@Param("keyword") String keyword);
}
</file>

<file path="backend/src/main/java/com/example/backend/repository/merchantAndCoupon/RedemptionLogRepository.java">
package com.example.backend.repository.merchantAndCoupon;

import com.example.backend.dto.RedemptionLogDTO;
import com.example.backend.model.merchantAndCoupon.RedemptionLog;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;

import java.util.List;

public interface RedemptionLogRepository extends JpaRepository<RedemptionLog, Integer> {
    // ä¹‹å¾Œå¯ä»¥ç”¨ä¾†æŸ¥è©¢æŸä½æœƒå“¡çš„å…Œæ›ç´€éŒ„
    List<RedemptionLog> findByMemIdOrderByRedeemTimeDesc(Integer memId);

    List<RedemptionLog> findAllByOrderByRedeemTimeDesc();
}
</file>

<file path="backend/src/main/java/com/example/backend/repository/projection/readme.txt">
=============================================================================
 Package: com.example.backend.repository.projection
 èªªæ˜: Spring Data JPA Projections (æŠ•å½±ä»‹é¢) å­˜æ”¾å€
=============================================================================

1. ç”¨é€” (Purpose)
-----------------------------------------------------------------------------
   æ­¤ Package å°ˆé–€å­˜æ”¾ã€Œä»‹é¢ (Interface)ã€ï¼Œç”¨æ–¼æ¥æ”¶ Repository å±¤ä¸­è‡ªå®šç¾© SQL 
   (@Query) çš„æŸ¥è©¢çµæœã€‚

   ç•¶æŸ¥è©¢çµæœæ˜¯è·¨å¤šå€‹ Table çš„çµ±è¨ˆæ•¸æ“šã€æˆ–æ˜¯åªé¸å–éƒ¨åˆ†æ¬„ä½ï¼Œç„¡æ³•ç›´æ¥å°æ‡‰åˆ°å–®ä¸€ 
   Entity (å¦‚ Member, RentingSpot) æ™‚ï¼Œå°±éœ€è¦ä½¿ç”¨é€™è£¡çš„ Projection ä»‹é¢ä¾†æ¥æ”¶ã€‚

2. å‘½åèˆ‡å°æ‡‰è¦å‰‡ (Naming Convention)
-----------------------------------------------------------------------------
   Spring Data JPA ä½¿ç”¨ã€Œåˆ¥åå°æ‡‰ (Alias Mapping)ã€æ©Ÿåˆ¶ã€‚
   ä»‹é¢ä¸­çš„ Getter æ–¹æ³•åç¨±ï¼Œå¿…é ˆèˆ‡ SQL æŸ¥è©¢èªå¥ä¸­çš„ AS åˆ¥åå®Œå…¨ä¸€è‡´ (å€åˆ†å¤§å°å¯«)ã€‚

   [ç¯„ä¾‹]
   SQL: 
     SELECT s.spot_name AS spotName, COUNT(*) AS totalCount FROM ...
   
   Projection Interface:
     String getSpotName();   // å°æ‡‰ AS spotName
     Integer getTotalCount(); // å°æ‡‰ AS totalCount

3. åƒè€ƒæ–‡ä»¶
-----------------------------------------------------------------------------
   Spring Data JPA - Projections
   https://docs.spring.io/spring-data/jpa/reference/repositories/projections.html

4. è‡ªå‹•æª¢æŸ¥æ©Ÿåˆ¶ (Validation)
-----------------------------------------------------------------------------
   ç”±æ–¼ Native Query çš„åˆ¥åéŒ¯èª¤é€šå¸¸åœ¨åŸ·è¡Œæ™‚æ‰æœƒç™¼ç¾ï¼Œæœ¬å°ˆæ¡ˆå·²é…ç½®å•Ÿå‹•æª¢æŸ¥å™¨ï¼š
   ä½ç½®: com.example.backend.config.ProjectionValidationConfig
   
   åœ¨é–‹ç™¼ç’°å¢ƒ (dev profile) å•Ÿå‹•æ™‚ï¼Œç³»çµ±æœƒè‡ªå‹•è©¦è·‘ Dashboard ç›¸é—œæŸ¥è©¢ã€‚
   è‹¥ SQL AS åˆ¥åèˆ‡ä»‹é¢ Getter ä¸åŒ¹é…ï¼ŒConsole æœƒå‡ºç¾ âŒ [FAIL] éŒ¯èª¤æ—¥èªŒã€‚
</file>

<file path="backend/src/main/java/com/example/backend/repository/rec/RecRentRepository.java">
package com.example.backend.repository.rec;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import com.example.backend.model.rec.RecRent;

@Repository
public interface RecRentRepository extends JpaRepository<RecRent, Integer> {
    // æ–°å¢ç´€éŒ„
    RecRent save(RecRent recRent); // æ–°å¢å–®ç­†

    // ä¾æ“šæ¥­å‹™ä¸»éµåˆªé™¤
    void deleteByRecId(String recId); // åˆªé™¤å–®ç­†

    // æ”¯æ´ç”¨æ¥­å‹™ä¸»éµ (Rxxxxxxxxx) æŸ¥è©¢
    RecRent findByRecId(String recId); // æŸ¥è©¢å–®ç­†
}
</file>

<file path="backend/src/main/java/com/example/backend/service/maintenance/AssetStatsService.java">
package com.example.backend.service.maintenance;

import com.example.backend.dto.maintenance.AssetStatsResponseDto;
import com.example.backend.model.maintenance.MaintenanceInformation;
import com.example.backend.model.spot.RentalSpot;
import com.example.backend.model.spot.Seat;
import com.example.backend.repository.maintenance.MaintenanceInformationRepository;
import com.example.backend.repository.spot.RentalSpotRepository;
import com.example.backend.repository.spot.SeatRepository;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.time.temporal.ChronoUnit;
import java.util.*;
import java.util.stream.Collectors;

/**
 * è³‡ç”¢å¥åº·åº¦çµ±è¨ˆ Service
 * æä¾›æ©Ÿå°(Spot)èˆ‡æ¤…å­(Seat)åœ¨æœ€è¿‘ 7 å¤©çš„ç¶­ä¿®/ä¿é¤Šçµ±è¨ˆ
 */
@Service
@Transactional(readOnly = true)
public class AssetStatsService {

    // ä½¿ç”¨ç¾æœ‰ç‹€æ…‹å¸¸æ•¸
    private static final String STATUS_RESOLVED = MaintenanceInformationService.STATUS_RESOLVED;
    private static final String STATUS_CANCELLED = MaintenanceInformationService.STATUS_CANCELLED;
    private static final Set<String> DONE_STATUSES = Set.of(STATUS_RESOLVED, STATUS_CANCELLED);

    // ä¿é¤Šé—œéµå­—
    private static final List<String> MAINTAIN_KEYWORDS = Arrays.asList("ä¿é¤Š", "ä¾‹è¡Œ", "æª¢æŸ¥", "å·¡æª¢", "é»æª¢");

    // æ™‚é–“çª—å£å¸¸æ•¸
    private static final int WINDOW_DAYS = 7;
    private static final long TOTAL_WINDOW_MINUTES = WINDOW_DAYS * 24L * 60L; // 10080

    private final MaintenanceInformationRepository ticketRepo;
    private final RentalSpotRepository spotRepo;
    private final SeatRepository seatRepo;

    public AssetStatsService(
            MaintenanceInformationRepository ticketRepo,
            RentalSpotRepository spotRepo,
            SeatRepository seatRepo
    ) {
        this.ticketRepo = ticketRepo;
        this.spotRepo = spotRepo;
        this.seatRepo = seatRepo;
    }

    /**
     * å–å¾—æ©Ÿå°(Spot)å¥åº·åº¦çµ±è¨ˆ
     */
    public List<AssetStatsResponseDto> getSpotStats() {
        LocalDateTime windowTo = LocalDateTime.now();
        LocalDateTime windowFrom = windowTo.minusDays(WINDOW_DAYS);

        // å–å¾—æ‰€æœ‰å·¥å–®
        List<MaintenanceInformation> allTickets = ticketRepo.findAll();

        // ç¯©é¸ spotId ä¸ç‚ºç©ºä¸”èˆ‡æ™‚é–“çª—æœ‰é‡ç–Šçš„å·¥å–®
        List<MaintenanceInformation> spotTickets = allTickets.stream()
                .filter(t -> t.getSpotId() != null)
                .filter(t -> isOverlapping(t, windowFrom, windowTo))
                .collect(Collectors.toList());

        // ä¾ spotId åˆ†çµ„
        Map<Integer, List<MaintenanceInformation>> ticketsBySpot = spotTickets.stream()
                .collect(Collectors.groupingBy(MaintenanceInformation::getSpotId));

        // ä¸€æ¬¡æŸ¥è©¢æ‰€æœ‰ spot åç¨±
        Set<Integer> spotIds = ticketsBySpot.keySet();
        Map<Integer, String> spotNameMap = spotRepo.findAllById(spotIds).stream()
                .collect(Collectors.toMap(
                        RentalSpot::getSpotId,
                        s -> s.getSpotCode() + " - " + s.getSpotName()
                ));

        // è¨ˆç®—çµ±è¨ˆ
        List<AssetStatsResponseDto> result = new ArrayList<>();
        for (Map.Entry<Integer, List<MaintenanceInformation>> entry : ticketsBySpot.entrySet()) {
            Integer spotId = entry.getKey();
            List<MaintenanceInformation> tickets = entry.getValue();
            String spotName = spotNameMap.getOrDefault(spotId, "æœªçŸ¥è³‡ç”¢#" + spotId);

            AssetStatsResponseDto dto = calculateStats("SPOT", spotId, spotName, tickets, windowFrom, windowTo);
            result.add(dto);
        }

        // ä¾ç¶­ä¿®æ¬¡æ•¸é™åºæ’åº
        result.sort((a, b) -> Integer.compare(b.getRepairCount(), a.getRepairCount()));

        return result;
    }

    /**
     * å–å¾—æ¤…å­(Seat)å¥åº·åº¦çµ±è¨ˆ
     */
    public List<AssetStatsResponseDto> getSeatStats() {
        LocalDateTime windowTo = LocalDateTime.now();
        LocalDateTime windowFrom = windowTo.minusDays(WINDOW_DAYS);

        // å–å¾—æ‰€æœ‰å·¥å–®
        List<MaintenanceInformation> allTickets = ticketRepo.findAll();

        // ç¯©é¸ seatsId ä¸ç‚ºç©ºä¸”èˆ‡æ™‚é–“çª—æœ‰é‡ç–Šçš„å·¥å–®
        List<MaintenanceInformation> seatTickets = allTickets.stream()
                .filter(t -> t.getSeatsId() != null)
                .filter(t -> isOverlapping(t, windowFrom, windowTo))
                .collect(Collectors.toList());

        // ä¾ seatsId åˆ†çµ„
        Map<Integer, List<MaintenanceInformation>> ticketsBySeat = seatTickets.stream()
                .collect(Collectors.groupingBy(MaintenanceInformation::getSeatsId));

        // ä¸€æ¬¡æŸ¥è©¢æ‰€æœ‰ seat åç¨±
        Set<Integer> seatIds = ticketsBySeat.keySet();
        Map<Integer, String> seatNameMap = seatRepo.findAllById(seatIds).stream()
                .collect(Collectors.toMap(
                        Seat::getSeatsId,
                        Seat::getSeatsName
                ));

        // è¨ˆç®—çµ±è¨ˆ
        List<AssetStatsResponseDto> result = new ArrayList<>();
        for (Map.Entry<Integer, List<MaintenanceInformation>> entry : ticketsBySeat.entrySet()) {
            Integer seatId = entry.getKey();
            List<MaintenanceInformation> tickets = entry.getValue();
            String seatName = seatNameMap.getOrDefault(seatId, "æœªçŸ¥è³‡ç”¢#" + seatId);

            AssetStatsResponseDto dto = calculateStats("SEAT", seatId, seatName, tickets, windowFrom, windowTo);
            result.add(dto);
        }

        // ä¾ç¶­ä¿®æ¬¡æ•¸é™åºæ’åº
        result.sort((a, b) -> Integer.compare(b.getRepairCount(), a.getRepairCount()));

        return result;
    }

    /**
     * è¨ˆç®—å–®ä¸€è³‡ç”¢çš„çµ±è¨ˆæŒ‡æ¨™
     */
    private AssetStatsResponseDto calculateStats(
            String assetType,
            Integer assetId,
            String assetName,
            List<MaintenanceInformation> tickets,
            LocalDateTime windowFrom,
            LocalDateTime windowTo
    ) {
        int repairCount = 0;
        int maintainCount = 0;
        int repairDoneCount = 0;
        int maintainDoneCount = 0;
        int openCount = 0;
        long totalDowntimeMinutes = 0;

        for (MaintenanceInformation ticket : tickets) {
            boolean isMaintain = isMaintainTicket(ticket);
            boolean isDone = isDoneStatus(ticket.getIssueStatus());

            if (isMaintain) {
                maintainCount++;
                if (isDone) {
                    maintainDoneCount++;
                } else {
                    openCount++;
                }
            } else {
                repairCount++;
                if (isDone) {
                    repairDoneCount++;
                } else {
                    openCount++;
                }
            }

            // è¨ˆç®—åœæ©Ÿæ™‚é–“ï¼ˆæ™‚é–“çª—æˆªæ–·ï¼‰
            long overlapMinutes = calculateOverlapMinutes(ticket, windowFrom, windowTo);
            totalDowntimeMinutes += overlapMinutes;
        }

        // è¨ˆç®—æŒ‡æ¨™
        double availability = 1.0 - ((double) totalDowntimeMinutes / TOTAL_WINDOW_MINUTES);
        availability = Math.max(0.0, Math.min(1.0, availability)); // clamp 0~1

        double failureRatePerDay = (double) repairCount / WINDOW_DAYS;

        double repairRate = (repairCount > 0) ? ((double) repairDoneCount / repairCount) : 0.0;

        return new AssetStatsResponseDto(
                assetType,
                assetId,
                assetName,
                repairCount,
                maintainCount,
                repairDoneCount,
                maintainDoneCount,
                openCount,
                totalDowntimeMinutes,
                availability,
                failureRatePerDay,
                repairRate,
                windowFrom,
                windowTo
        );
    }

    /**
     * åˆ¤æ–·å·¥å–®æ˜¯å¦ç‚ºä¿é¤Šé¡å‹
     */
    private boolean isMaintainTicket(MaintenanceInformation ticket) {
        String issueType = ticket.getIssueType();
        String issueDesc = ticket.getIssueDesc();

        for (String keyword : MAINTAIN_KEYWORDS) {
            if (issueType != null && issueType.contains(keyword)) {
                return true;
            }
            if (issueDesc != null && issueDesc.contains(keyword)) {
                return true;
            }
        }
        return false;
    }

    /**
     * åˆ¤æ–·ç‹€æ…‹æ˜¯å¦ç‚ºå·²çµæ¡ˆ
     */
    private boolean isDoneStatus(String status) {
        return status != null && DONE_STATUSES.contains(status);
    }

    /**
     * åˆ¤æ–·å·¥å–®æ˜¯å¦èˆ‡æ™‚é–“çª—æœ‰é‡ç–Š
     */
    private boolean isOverlapping(MaintenanceInformation ticket, LocalDateTime windowFrom, LocalDateTime windowTo) {
        LocalDateTime ticketStart = getTicketStart(ticket);
        LocalDateTime ticketEnd = getTicketEnd(ticket, windowTo);

        // æœ‰é‡ç–Šï¼šticketEnd >= windowFrom && ticketStart <= windowTo
        return !ticketEnd.isBefore(windowFrom) && !ticketStart.isAfter(windowTo);
    }

    /**
     * è¨ˆç®—å·¥å–®åœ¨æ™‚é–“çª—å…§çš„åœæ©Ÿåˆ†é˜æ•¸
     */
    private long calculateOverlapMinutes(MaintenanceInformation ticket, LocalDateTime windowFrom, LocalDateTime windowTo) {
        LocalDateTime ticketStart = getTicketStart(ticket);
        LocalDateTime ticketEnd = getTicketEnd(ticket, windowTo);

        // æˆªæ–·åˆ°æ™‚é–“çª—å…§
        LocalDateTime effectiveStart = ticketStart.isBefore(windowFrom) ? windowFrom : ticketStart;
        LocalDateTime effectiveEnd = ticketEnd.isAfter(windowTo) ? windowTo : ticketEnd;

        // è¨ˆç®—é‡ç–Šåˆ†é˜æ•¸
        if (effectiveEnd.isAfter(effectiveStart)) {
            return ChronoUnit.MINUTES.between(effectiveStart, effectiveEnd);
        }
        return 0;
    }

    /**
     * å–å¾—å·¥å–®é–‹å§‹æ™‚é–“ (å„ªå…ˆä½¿ç”¨ startAtï¼Œå¦å‰‡ç”¨ reportedAt)
     */
    private LocalDateTime getTicketStart(MaintenanceInformation ticket) {
        if (ticket.getStartAt() != null) {
            return ticket.getStartAt();
        }
        return ticket.getReportedAt() != null ? ticket.getReportedAt() : LocalDateTime.now();
    }

    /**
     * å–å¾—å·¥å–®çµæŸæ™‚é–“ (å„ªå…ˆä½¿ç”¨ resolvedAtï¼Œå¦å‰‡ç”¨ windowTo ä½œç‚ºé€²è¡Œä¸­å·¥å–®çš„çµæŸæ™‚é–“)
     */
    private LocalDateTime getTicketEnd(MaintenanceInformation ticket, LocalDateTime windowTo) {
        if (ticket.getResolvedAt() != null) {
            return ticket.getResolvedAt();
        }
        // æœªçµæ¡ˆå·¥å–®ï¼Œä»¥ç•¶å‰æ™‚é–“ç‚ºçµæŸï¼ˆä½†ä¸è¶…é windowToï¼‰
        return windowTo;
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/service/maintenance/MaintenanceJobScheduler.java">
package com.example.backend.service.maintenance;

import com.example.backend.model.maintenance.MaintenanceInformation;
import com.example.backend.model.maintenance.MaintenanceSchedule;
import com.example.backend.model.spot.Seat;
import com.example.backend.repository.maintenance.MaintenanceInformationRepository;
import com.example.backend.repository.maintenance.MaintenanceScheduleRepository;
import com.example.backend.repository.spot.SeatRepository;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.time.LocalTime;
import java.time.ZoneId;
import java.time.ZonedDateTime;
import java.util.Arrays;
import java.util.List;

/**
 * å®šæœŸç¶­è­·æ’ç¨‹åŸ·è¡Œå™¨
 * æ¯åˆ†é˜æª¢æŸ¥åˆ°æœŸçš„æ’ç¨‹ï¼Œä¸¦è‡ªå‹•å»ºç«‹å·¥å–®
 */
@Component
public class MaintenanceJobScheduler {

    private static final Logger log = LoggerFactory.getLogger(MaintenanceJobScheduler.class);
    private static final ZoneId TAIPEI_ZONE = ZoneId.of("Asia/Taipei");

    /**
     * æœªçµæ¡ˆç‹€æ…‹æ¸…å–® (ç”¨æ–¼é˜²çˆ†å–®æª¢æŸ¥)
     */
    private static final List<String> OPEN_STATUSES = Arrays.asList(
            "REPORTED",          // å·²å›å ±
            "ASSIGNED",          // å·²æŒ‡æ´¾
            "UNDER_MAINTENANCE"  // ç¶­ä¿®ä¸­
    );

    private final MaintenanceScheduleRepository scheduleRepo;
    private final MaintenanceInformationRepository ticketRepo;
    private final SeatRepository seatRepo;

    public MaintenanceJobScheduler(
            MaintenanceScheduleRepository scheduleRepo,
            MaintenanceInformationRepository ticketRepo,
            SeatRepository seatRepo) {
        this.scheduleRepo = scheduleRepo;
        this.ticketRepo = ticketRepo;
        this.seatRepo = seatRepo;
    }

    /**
     * æ¯åˆ†é˜åŸ·è¡Œä¸€æ¬¡ï¼Œæª¢æŸ¥åˆ°æœŸçš„æ’ç¨‹
     */
    @Scheduled(cron = "0 * * * * *") // æ¯åˆ†é˜çš„ç¬¬ 0 ç§’åŸ·è¡Œ
    @Transactional
    public void executeScheduledMaintenance() {
        LocalDateTime now = ZonedDateTime.now(TAIPEI_ZONE).toLocalDateTime();
        log.info("â° [æ’ç¨‹æª¢æŸ¥] é–‹å§‹æª¢æŸ¥åˆ°æœŸæ’ç¨‹ï¼Œç•¶å‰æ™‚é–“: {}", now);

        // 1. æŸ¥è©¢æ‰€æœ‰åˆ°æœŸä¸”å•Ÿç”¨çš„æ’ç¨‹
        List<MaintenanceSchedule> dueSchedules = scheduleRepo.findByNextExecuteAtBeforeAndIsActiveTrue(now);

        if (dueSchedules.isEmpty()) {
            log.debug("ğŸ“­ [æ’ç¨‹æª¢æŸ¥] æ²’æœ‰åˆ°æœŸçš„æ’ç¨‹");
            return;
        }

        log.info("ğŸ“‹ [æ’ç¨‹æª¢æŸ¥] æ‰¾åˆ° {} ç­†åˆ°æœŸæ’ç¨‹", dueSchedules.size());

        // 2. é€ä¸€è™•ç†æ¯å€‹æ’ç¨‹
        for (MaintenanceSchedule schedule : dueSchedules) {
            try {
                processSchedule(schedule, now);
            } catch (Exception e) {
                log.error("âŒ [æ’ç¨‹åŸ·è¡Œ] æ’ç¨‹ ID={} åŸ·è¡Œå¤±æ•—: {}", schedule.getScheduleId(), e.getMessage(), e);
            }
        }

        log.info("âœ… [æ’ç¨‹æª¢æŸ¥] æœ¬æ¬¡æª¢æŸ¥å®Œæˆ");
    }

    /**
     * è™•ç†å–®ä¸€æ’ç¨‹
     */
    private void processSchedule(MaintenanceSchedule schedule, LocalDateTime now) {
        Integer scheduleId = schedule.getScheduleId();
        String targetType = schedule.getTargetType();
        Integer targetId = schedule.getTargetId();

        log.info("ğŸ”§ [æ’ç¨‹åŸ·è¡Œ] è™•ç†æ’ç¨‹ ID={}, æ¨™é¡Œ={}, ç›®æ¨™={}:{}",
                scheduleId, schedule.getTitle(), targetType, targetId);

        // 1. é˜²çˆ†å–®æª¢æŸ¥
        boolean hasOpenTicket = checkHasOpenTicket(targetType, targetId);

        if (hasOpenTicket) {
            // æœ‰æœªçµæ¡ˆå·¥å–®ï¼Œè·³éé–‹å–®ï¼Œåªæ›´æ–°æ™‚é–“
            log.warn("âš ï¸ [é˜²çˆ†å–®] ç›®æ¨™ {}:{} å·²æœ‰æœªçµæ¡ˆå·¥å–®ï¼Œè·³éé–‹å–®", targetType, targetId);
            updateScheduleTime(schedule, now);
            return;
        }

        // 2. å»ºç«‹æ–°å·¥å–®
        MaintenanceInformation ticket = createTicket(schedule);
        ticketRepo.save(ticket);
        log.info("âœ… [é–‹å–®æˆåŠŸ] å·¥å–®å·²å»ºç«‹ï¼Œæ’ç¨‹ ID={}, å·¥å–® ID={}", scheduleId, ticket.getTicketId());

        // 3. æ›´æ–°æ’ç¨‹æ™‚é–“
        updateScheduleTime(schedule, now);
    }

    /**
     * æª¢æŸ¥æ˜¯å¦æœ‰æœªçµæ¡ˆå·¥å–® (é˜²çˆ†å–®)
     */
    private boolean checkHasOpenTicket(String targetType, Integer targetId) {
        if ("SPOT".equals(targetType)) {
            // SPOT: æª¢æŸ¥è©²æ©Ÿå°æ˜¯å¦æœ‰æœªçµæ¡ˆå·¥å–® (ä¸” seatsId ç‚º nullï¼Œæ’é™¤æ¤…å­çš„å·¥å–®)
            return ticketRepo.existsBySpotIdAndSeatsIdIsNullAndIssueStatusIn(targetId, OPEN_STATUSES);
        } else if ("SEAT".equals(targetType)) {
            // SEAT: æª¢æŸ¥è©²æ¤…å­æ˜¯å¦æœ‰æœªçµæ¡ˆå·¥å–®
            return ticketRepo.existsBySeatsIdAndIssueStatusIn(targetId, OPEN_STATUSES);
        }
        return false;
    }

    /**
     * å»ºç«‹å·¥å–®
     */
    private MaintenanceInformation createTicket(MaintenanceSchedule schedule) {
        MaintenanceInformation ticket = new MaintenanceInformation();

        // åŸºæœ¬æ¬„ä½
        ticket.setIssueType(schedule.getIssueType());
        ticket.setIssuePriority(schedule.getIssuePriority());
        ticket.setIssueStatus("REPORTED"); // åˆå§‹ç‹€æ…‹ï¼šå·²å›å ±

        // æŒ‡æ´¾äººå“¡ (å¦‚æœæœ‰è¨­å®š)
        if (schedule.getAssignedStaffId() != null) {
            ticket.setAssignedStaffId(schedule.getAssignedStaffId());
            ticket.setIssueStatus("ASSIGNED"); // æœ‰æŒ‡æ´¾å°±ç›´æ¥è¨­ç‚ºå·²æŒ‡æ´¾
        }

        // æ ¹æ“š targetType è¨­å®š spotId / seatsId
        String targetType = schedule.getTargetType();
        Integer targetId = schedule.getTargetId();

        if ("SPOT".equals(targetType)) {
            // æ©Ÿå°æ’ç¨‹ï¼šç›´æ¥è¨­å®š spotId
            ticket.setSpotId(targetId);
            ticket.setIssueDesc(String.format("ã€æ’ç¨‹è‡ªå‹•ä¿é¤Šã€‘%s", schedule.getTitle()));

        } else if ("SEAT".equals(targetType)) {
            // æ¤…å­æ’ç¨‹ï¼šéœ€è¦æŸ¥è©¢æ¤…å­æ‰€å±¬çš„ spotId
            Seat seat = seatRepo.findById(targetId)
                    .orElseThrow(() -> new IllegalStateException("æ‰¾ä¸åˆ°æ¤…å­ ID: " + targetId));

            ticket.setSpotId(seat.getSpotId());   // è¨­å®šæ¤…å­æ‰€å±¬çš„æ©Ÿå°
            ticket.setSeatsId(targetId);          // è¨­å®šæ¤…å­ ID

            // å‚™è¨»åŠ ä¸Šæ¤…å­è³‡è¨Š
            String seatInfo = seat.getSeatsName() != null ? seat.getSeatsName() : String.valueOf(targetId);
            ticket.setIssueDesc(String.format("ã€æ’ç¨‹è‡ªå‹•ä¿é¤Šã€‘%s - æ¤…å­ç·¨è™Ÿ: %s", schedule.getTitle(), seatInfo));
        }

        return ticket;
    }

    /**
     * æ›´æ–°æ’ç¨‹æ™‚é–“ (lastExecutedAt + nextExecuteAt)
     */
    private void updateScheduleTime(MaintenanceSchedule schedule, LocalDateTime now) {
        // æ›´æ–°ä¸Šæ¬¡åŸ·è¡Œæ™‚é–“
        schedule.setLastExecutedAt(now);

        // è¨ˆç®—ä¸‹æ¬¡åŸ·è¡Œæ™‚é–“
        LocalDateTime nextExecuteAt = calculateNextExecuteTime(
                schedule.getScheduleType(),
                schedule.getExecuteTime(),
                schedule.getDayOfWeek(),
                schedule.getDayOfMonth()
        );
        schedule.setNextExecuteAt(nextExecuteAt);

        scheduleRepo.save(schedule);
        log.info("ğŸ“… [æ™‚é–“æ›´æ–°] æ’ç¨‹ ID={}, ä¸‹æ¬¡åŸ·è¡Œæ™‚é–“={}", schedule.getScheduleId(), nextExecuteAt);
    }

    // ==================== è¨ˆç®—ä¸‹æ¬¡åŸ·è¡Œæ™‚é–“ ====================

    /**
     * è¨ˆç®—ä¸‹æ¬¡åŸ·è¡Œæ™‚é–“
     */
    private LocalDateTime calculateNextExecuteTime(
            String scheduleType,
            LocalTime executeTime,
            Integer dayOfWeek,
            Integer dayOfMonth) {

        ZonedDateTime now = ZonedDateTime.now(TAIPEI_ZONE);

        switch (scheduleType) {
            case "DAILY":
                // æ¯æ—¥ï¼šæ˜å¤©åŒä¸€æ™‚é–“
                return now.toLocalDate().plusDays(1).atTime(executeTime);

            case "WEEKLY":
                // æ¯é€±ï¼šä¸‹é€±åŒä¸€å¤©
                return now.toLocalDate().plusWeeks(1)
                        .with(java.time.DayOfWeek.of(dayOfWeek))
                        .atTime(executeTime);

            case "MONTHLY":
                // æ¯æœˆï¼šä¸‹å€‹æœˆåŒä¸€å¤©
                return getNextMonthDate(now, executeTime, dayOfMonth);

            default:
                throw new IllegalArgumentException("æœªçŸ¥çš„æ’ç¨‹é¡å‹: " + scheduleType);
        }
    }

    /**
     * å–å¾—ä¸‹å€‹æœˆå°æ‡‰æ—¥æœŸçš„ LocalDateTime
     */
    private LocalDateTime getNextMonthDate(ZonedDateTime now, LocalTime executeTime, Integer dayOfMonth) {
        ZonedDateTime nextMonth = now.plusMonths(1);
        int maxDayOfNextMonth = nextMonth.toLocalDate().withDayOfMonth(1).lengthOfMonth();
        int actualDay = Math.min(dayOfMonth, maxDayOfNextMonth);

        return LocalDateTime.of(
                nextMonth.getYear(),
                nextMonth.getMonthValue(),
                actualDay,
                executeTime.getHour(),
                executeTime.getMinute(),
                executeTime.getSecond()
        );
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/service/maintenance/MaintenanceScheduleService.java">
package com.example.backend.service.maintenance;

import com.example.backend.dto.maintenance.MaintenanceScheduleResponseDto;
import com.example.backend.model.maintenance.MaintenanceSchedule;
import com.example.backend.model.maintenance.MaintenanceStaff;
import com.example.backend.repository.maintenance.MaintenanceScheduleRepository;
import com.example.backend.repository.maintenance.MaintenanceStaffRepository;
import com.example.backend.repository.spot.RentalSpotRepository;
import com.example.backend.repository.spot.SeatRepository;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.time.LocalTime;
import java.time.ZoneId;
import java.time.ZonedDateTime;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.stream.Collectors;

/**
 * å®šæœŸç¶­è­·æ’ç¨‹ Service
 */
@Service
@Transactional
public class MaintenanceScheduleService {

    private static final ZoneId TAIPEI_ZONE = ZoneId.of("Asia/Taipei");

    private final MaintenanceScheduleRepository scheduleRepo;
    private final MaintenanceStaffRepository staffRepo;
    private final RentalSpotRepository spotRepo;
    private final SeatRepository seatRepo;

    public MaintenanceScheduleService(
            MaintenanceScheduleRepository scheduleRepo,
            MaintenanceStaffRepository staffRepo,
            RentalSpotRepository spotRepo,
            SeatRepository seatRepo) {
        this.scheduleRepo = scheduleRepo;
        this.staffRepo = staffRepo;
        this.spotRepo = spotRepo;
        this.seatRepo = seatRepo;
    }

    // ==================== æŸ¥è©¢ ====================

    /**
     * å–å¾—æ‰€æœ‰æ’ç¨‹ (å«äººå“¡å§“å DTO)
     * æ³¨æ„ï¼šController å¯èƒ½è²æ˜è¿”å› List<MaintenanceSchedule>ï¼Œä½† DTO æœƒè¢«æ­£ç¢ºåºåˆ—åŒ–
     */
    @SuppressWarnings("unchecked")
    public List getAllSchedules() {
        List<MaintenanceSchedule> schedules = scheduleRepo.findAll();
        return mapToDtoList(schedules);
    }

    /**
     * ä¾ ID å–å¾—æ’ç¨‹ (Entity)
     */
    public MaintenanceSchedule getScheduleById(Integer id) {
        return scheduleRepo.findById(id)
                .orElseThrow(() -> new IllegalArgumentException("æ‰¾ä¸åˆ°æ’ç¨‹ ID: " + id));
    }

    /**
     * å–å¾—æ‰€æœ‰å•Ÿç”¨ä¸­çš„æ’ç¨‹ (å«äººå“¡å§“å DTO)
     */
    @SuppressWarnings("unchecked")
    public List getActiveSchedules() {
        List<MaintenanceSchedule> schedules = scheduleRepo.findByIsActive(true);
        return mapToDtoList(schedules);
    }

    /**
     * å–å¾—ç‰¹å®šç›®æ¨™çš„æ’ç¨‹ (å«äººå“¡å§“å DTO)
     */
    @SuppressWarnings("unchecked")
    public List getSchedulesByTarget(String targetType, Integer targetId) {
        List<MaintenanceSchedule> schedules = scheduleRepo.findByTargetTypeAndTargetId(targetType, targetId);
        return mapToDtoList(schedules);
    }

    /**
     * æŸ¥è©¢å·²åˆ°æœŸä¸”å•Ÿç”¨çš„æ’ç¨‹ (Entity - ä¾›å®šæ™‚ä»»å‹™ä½¿ç”¨)
     */
    public List<MaintenanceSchedule> getDueSchedulesEntity() {
        LocalDateTime now = ZonedDateTime.now(TAIPEI_ZONE).toLocalDateTime();
        return scheduleRepo.findByNextExecuteAtBeforeAndIsActiveTrue(now);
    }

    /**
     * æŸ¥è©¢å·²åˆ°æœŸä¸”å•Ÿç”¨çš„æ’ç¨‹ (å«äººå“¡å§“å DTO)
     */
    @SuppressWarnings("unchecked")
    public List getDueSchedules() {
        LocalDateTime now = ZonedDateTime.now(TAIPEI_ZONE).toLocalDateTime();
        List<MaintenanceSchedule> schedules = scheduleRepo.findByNextExecuteAtBeforeAndIsActiveTrue(now);
        return mapToDtoList(schedules);
    }

    // ==================== æ–°å¢ ====================

    /**
     * å»ºç«‹æ–°æ’ç¨‹
     */
    public MaintenanceSchedule createSchedule(MaintenanceSchedule schedule) {
        // 1. é©—è­‰è³‡æ–™
        validateSchedule(schedule);

        // 2. è¨ˆç®—ä¸‹æ¬¡åŸ·è¡Œæ™‚é–“
        LocalDateTime nextExecuteAt = calculateNextExecuteTime(
                schedule.getScheduleType(),
                schedule.getExecuteTime(),
                schedule.getDayOfWeek(),
                schedule.getDayOfMonth()
        );
        schedule.setNextExecuteAt(nextExecuteAt);

        // 3. è¨­å®šé è¨­å€¼
        if (schedule.getIsActive() == null) {
            schedule.setIsActive(true);
        }
        if (schedule.getIssuePriority() == null) {
            schedule.setIssuePriority("NORMAL");
        }

        return scheduleRepo.save(schedule);
    }

    // ==================== æ›´æ–° ====================

    /**
     * æ›´æ–°æ’ç¨‹
     */
    public MaintenanceSchedule updateSchedule(MaintenanceSchedule schedule) {
        // 1. ç¢ºèªæ’ç¨‹å­˜åœ¨
        MaintenanceSchedule existing = getScheduleById(schedule.getScheduleId());

        // 2. é©—è­‰è³‡æ–™
        validateSchedule(schedule);

        // 3. æ›´æ–°æ¬„ä½
        existing.setTitle(schedule.getTitle());
        existing.setTargetType(schedule.getTargetType());
        existing.setTargetId(schedule.getTargetId());
        existing.setScheduleType(schedule.getScheduleType());
        existing.setDayOfWeek(schedule.getDayOfWeek());
        existing.setDayOfMonth(schedule.getDayOfMonth());
        existing.setExecuteTime(schedule.getExecuteTime());
        existing.setIssueType(schedule.getIssueType());
        existing.setIssuePriority(schedule.getIssuePriority());
        existing.setAssignedStaffId(schedule.getAssignedStaffId());
        existing.setIsActive(schedule.getIsActive());

        // 4. é‡æ–°è¨ˆç®—ä¸‹æ¬¡åŸ·è¡Œæ™‚é–“
        LocalDateTime nextExecuteAt = calculateNextExecuteTime(
                schedule.getScheduleType(),
                schedule.getExecuteTime(),
                schedule.getDayOfWeek(),
                schedule.getDayOfMonth()
        );
        existing.setNextExecuteAt(nextExecuteAt);

        return scheduleRepo.save(existing);
    }

    /**
     * åˆ‡æ›å•Ÿç”¨ç‹€æ…‹
     */
    public MaintenanceSchedule toggleActive(Integer id) {
        MaintenanceSchedule schedule = getScheduleById(id);
        schedule.setIsActive(!schedule.getIsActive());

        // å¦‚æœé‡æ–°å•Ÿç”¨ï¼Œé‡æ–°è¨ˆç®—ä¸‹æ¬¡åŸ·è¡Œæ™‚é–“
        if (schedule.getIsActive()) {
            LocalDateTime nextExecuteAt = calculateNextExecuteTime(
                    schedule.getScheduleType(),
                    schedule.getExecuteTime(),
                    schedule.getDayOfWeek(),
                    schedule.getDayOfMonth()
            );
            schedule.setNextExecuteAt(nextExecuteAt);
        }

        return scheduleRepo.save(schedule);
    }

    // ==================== åˆªé™¤ ====================

   
  

    // (è»Ÿåˆªé™¤) åˆªé™¤æ’ç¨‹
     
    public void deleteSchedule(Integer id) {
        // 1. å…ˆæŠŠæ’ç¨‹æŠ“å‡ºä¾†
        MaintenanceSchedule schedule = getScheduleById(id);
        
        // 2. æ¨™è¨˜ç‚ºåœç”¨ (isActive = false)
        schedule.setIsActive(false);
        
        // 3. å„²å­˜
        scheduleRepo.save(schedule);
}

    // ==================== åŸ·è¡Œå¾Œæ›´æ–° ====================

    /**
     * æ’ç¨‹åŸ·è¡Œå¾Œï¼Œæ›´æ–°åŸ·è¡Œæ™‚é–“
     * (ä¾›å®šæ™‚ä»»å‹™åœ¨ç”¢ç”Ÿå·¥å–®å¾Œå‘¼å«)
     */
    public void markExecuted(Integer scheduleId) {
        MaintenanceSchedule schedule = getScheduleById(scheduleId);
        LocalDateTime now = ZonedDateTime.now(TAIPEI_ZONE).toLocalDateTime();

        // æ›´æ–°ä¸Šæ¬¡åŸ·è¡Œæ™‚é–“
        schedule.setLastExecutedAt(now);

        // è¨ˆç®—ä¸‹æ¬¡åŸ·è¡Œæ™‚é–“
        LocalDateTime nextExecuteAt = calculateNextExecuteTime(
                schedule.getScheduleType(),
                schedule.getExecuteTime(),
                schedule.getDayOfWeek(),
                schedule.getDayOfMonth()
        );
        schedule.setNextExecuteAt(nextExecuteAt);

        scheduleRepo.save(schedule);
    }

    // ==================== ç§æœ‰æ–¹æ³•ï¼šé©—è­‰ ====================

    /**
     * é©—è­‰æ’ç¨‹è³‡æ–™
     */
    private void validateSchedule(MaintenanceSchedule schedule) {
        // åŸºæœ¬æ¬„ä½æª¢æŸ¥
        if (isBlank(schedule.getTitle())) {
            throw new IllegalArgumentException("æ¨™é¡Œä¸èƒ½ç‚ºç©º");
        }
        if (isBlank(schedule.getTargetType())) {
            throw new IllegalArgumentException("ç›®æ¨™é¡å‹ä¸èƒ½ç‚ºç©º");
        }
        if (schedule.getTargetId() == null) {
            throw new IllegalArgumentException("ç›®æ¨™ ID ä¸èƒ½ç‚ºç©º");
        }
        if (isBlank(schedule.getScheduleType())) {
            throw new IllegalArgumentException("æ’ç¨‹é¡å‹ä¸èƒ½ç‚ºç©º");
        }
        if (schedule.getExecuteTime() == null) {
            throw new IllegalArgumentException("åŸ·è¡Œæ™‚é–“ä¸èƒ½ç‚ºç©º");
        }
        if (isBlank(schedule.getIssueType())) {
            throw new IllegalArgumentException("å•é¡Œé¡å‹ä¸èƒ½ç‚ºç©º");
        }

        // é©—è­‰ targetType
        String targetType = schedule.getTargetType().toUpperCase();
        if (!targetType.equals("SPOT") && !targetType.equals("SEAT")) {
            throw new IllegalArgumentException("ç›®æ¨™é¡å‹å¿…é ˆæ˜¯ SPOT æˆ– SEAT");
        }
        schedule.setTargetType(targetType);

        // é©—è­‰ targetId æ˜¯å¦å­˜åœ¨
        validateTargetExists(targetType, schedule.getTargetId());

        // é©—è­‰ scheduleType å’Œå°æ‡‰æ¬„ä½
        String scheduleType = schedule.getScheduleType().toUpperCase();
        schedule.setScheduleType(scheduleType);

        switch (scheduleType) {
            case "DAILY":
                // DAILY: dayOfWeek/dayOfMonth å¿…é ˆç‚º null
                if (schedule.getDayOfWeek() != null || schedule.getDayOfMonth() != null) {
                    throw new IllegalArgumentException("æ¯æ—¥æ’ç¨‹ä¸éœ€è¦æŒ‡å®š dayOfWeek æˆ– dayOfMonth");
                }
                break;

            case "WEEKLY":
                // WEEKLY: dayOfWeek å¿…é ˆ 1-7
                if (schedule.getDayOfWeek() == null) {
                    throw new IllegalArgumentException("æ¯é€±æ’ç¨‹å¿…é ˆæŒ‡å®š dayOfWeek (1-7)");
                }
                if (schedule.getDayOfWeek() < 1 || schedule.getDayOfWeek() > 7) {
                    throw new IllegalArgumentException("dayOfWeek å¿…é ˆä»‹æ–¼ 1-7 (é€±ä¸€è‡³é€±æ—¥)");
                }
                if (schedule.getDayOfMonth() != null) {
                    throw new IllegalArgumentException("æ¯é€±æ’ç¨‹ä¸éœ€è¦æŒ‡å®š dayOfMonth");
                }
                break;

            case "MONTHLY":
                // MONTHLY: dayOfMonth å¿…é ˆ 1-31
                if (schedule.getDayOfMonth() == null) {
                    throw new IllegalArgumentException("æ¯æœˆæ’ç¨‹å¿…é ˆæŒ‡å®š dayOfMonth (1-31)");
                }
                if (schedule.getDayOfMonth() < 1 || schedule.getDayOfMonth() > 31) {
                    throw new IllegalArgumentException("dayOfMonth å¿…é ˆä»‹æ–¼ 1-31");
                }
                if (schedule.getDayOfWeek() != null) {
                    throw new IllegalArgumentException("æ¯æœˆæ’ç¨‹ä¸éœ€è¦æŒ‡å®š dayOfWeek");
                }
                break;

            default:
                throw new IllegalArgumentException("æ’ç¨‹é¡å‹å¿…é ˆæ˜¯ DAILY, WEEKLY æˆ– MONTHLY");
        }
    }

    /**
     * é©—è­‰ç›®æ¨™æ˜¯å¦å­˜åœ¨
     */
    private void validateTargetExists(String targetType, Integer targetId) {
        boolean exists;
        if ("SPOT".equals(targetType)) {
            exists = spotRepo.existsById(targetId);
            if (!exists) {
                throw new IllegalArgumentException("æ‰¾ä¸åˆ°æ©Ÿå° ID: " + targetId);
            }
        } else if ("SEAT".equals(targetType)) {
            exists = seatRepo.existsById(targetId);
            if (!exists) {
                throw new IllegalArgumentException("æ‰¾ä¸åˆ°åº§ä½ ID: " + targetId);
            }
        }
    }

    // ==================== ç§æœ‰æ–¹æ³•ï¼šè¨ˆç®—ä¸‹æ¬¡åŸ·è¡Œæ™‚é–“ ====================

    /**
     * è¨ˆç®—ä¸‹æ¬¡åŸ·è¡Œæ™‚é–“
     *
     * @param scheduleType æ’ç¨‹é¡å‹ (DAILY/WEEKLY/MONTHLY)
     * @param executeTime  åŸ·è¡Œæ™‚é–“
     * @param dayOfWeek    æ˜ŸæœŸå¹¾ (1=é€±ä¸€, 7=é€±æ—¥)
     * @param dayOfMonth   æ¯æœˆå¹¾è™Ÿ
     * @return ä¸‹æ¬¡åŸ·è¡Œçš„ LocalDateTime
     */
    private LocalDateTime calculateNextExecuteTime(
            String scheduleType,
            LocalTime executeTime,
            Integer dayOfWeek,
            Integer dayOfMonth) {

        ZonedDateTime now = ZonedDateTime.now(TAIPEI_ZONE);
        LocalDateTime todayAtTime = now.toLocalDate().atTime(executeTime);

        switch (scheduleType) {
            case "DAILY":
                return calculateNextDaily(now, todayAtTime);

            case "WEEKLY":
                return calculateNextWeekly(now, executeTime, dayOfWeek);

            case "MONTHLY":
                return calculateNextMonthly(now, executeTime, dayOfMonth);

            default:
                throw new IllegalArgumentException("æœªçŸ¥çš„æ’ç¨‹é¡å‹: " + scheduleType);
        }
    }

    /**
     * è¨ˆç®—æ¯æ—¥æ’ç¨‹çš„ä¸‹æ¬¡åŸ·è¡Œæ™‚é–“
     */
    private LocalDateTime calculateNextDaily(ZonedDateTime now, LocalDateTime todayAtTime) {
        // å¦‚æœä»Šå¤©çš„åŸ·è¡Œæ™‚é–“é‚„æ²’éï¼Œå°±æ˜¯ä»Šå¤©ï¼›å¦å‰‡æ˜¯æ˜å¤©
        if (now.toLocalDateTime().isBefore(todayAtTime)) {
            return todayAtTime;
        } else {
            return todayAtTime.plusDays(1);
        }
    }

    /**
     * è¨ˆç®—æ¯é€±æ’ç¨‹çš„ä¸‹æ¬¡åŸ·è¡Œæ™‚é–“
     * dayOfWeek: 1=é€±ä¸€, 2=é€±äºŒ, ..., 7=é€±æ—¥
     */
    private LocalDateTime calculateNextWeekly(ZonedDateTime now, LocalTime executeTime, Integer dayOfWeek) {
        // Java DayOfWeek: MONDAY=1, SUNDAY=7 (èˆ‡æˆ‘å€‘çš„å®šç¾©ä¸€è‡´)
        int currentDayOfWeek = now.getDayOfWeek().getValue();
        int daysUntilTarget = dayOfWeek - currentDayOfWeek;

        LocalDateTime targetDateTime;

        if (daysUntilTarget > 0) {
            // ç›®æ¨™æ—¥åœ¨æœ¬é€±å¾Œé¢
            targetDateTime = now.toLocalDate().plusDays(daysUntilTarget).atTime(executeTime);
        } else if (daysUntilTarget < 0) {
            // ç›®æ¨™æ—¥å·²éï¼Œä¸‹é€±
            targetDateTime = now.toLocalDate().plusDays(daysUntilTarget + 7).atTime(executeTime);
        } else {
            // å°±æ˜¯ä»Šå¤©
            targetDateTime = now.toLocalDate().atTime(executeTime);
            // å¦‚æœæ™‚é–“å·²éï¼Œç­‰ä¸‹é€±
            if (now.toLocalDateTime().isAfter(targetDateTime) || now.toLocalDateTime().isEqual(targetDateTime)) {
                targetDateTime = targetDateTime.plusDays(7);
            }
        }

        return targetDateTime;
    }

    /**
     * è¨ˆç®—æ¯æœˆæ’ç¨‹çš„ä¸‹æ¬¡åŸ·è¡Œæ™‚é–“
     */
    private LocalDateTime calculateNextMonthly(ZonedDateTime now, LocalTime executeTime, Integer dayOfMonth) {
        int currentDay = now.getDayOfMonth();
        int currentMonth = now.getMonthValue();
        int currentYear = now.getYear();

        LocalDateTime targetDateTime;

        // è™•ç†æœˆä»½å¤©æ•¸ä¸è¶³çš„æƒ…æ³ (ä¾‹å¦‚ 2 æœˆæ²’æœ‰ 30, 31 è™Ÿ)
        int maxDayOfCurrentMonth = now.toLocalDate().lengthOfMonth();
        int actualDay = Math.min(dayOfMonth, maxDayOfCurrentMonth);

        if (currentDay < actualDay) {
            // æœ¬æœˆçš„ç›®æ¨™æ—¥é‚„æ²’åˆ°
            targetDateTime = LocalDateTime.of(currentYear, currentMonth, actualDay, 
                    executeTime.getHour(), executeTime.getMinute(), executeTime.getSecond());
        } else if (currentDay == actualDay) {
            // å°±æ˜¯ä»Šå¤©
            targetDateTime = LocalDateTime.of(currentYear, currentMonth, actualDay,
                    executeTime.getHour(), executeTime.getMinute(), executeTime.getSecond());
            // å¦‚æœæ™‚é–“å·²éï¼Œç­‰ä¸‹å€‹æœˆ
            if (now.toLocalDateTime().isAfter(targetDateTime) || now.toLocalDateTime().isEqual(targetDateTime)) {
                targetDateTime = getNextMonthDate(now, executeTime, dayOfMonth);
            }
        } else {
            // æœ¬æœˆçš„ç›®æ¨™æ—¥å·²éï¼Œç­‰ä¸‹å€‹æœˆ
            targetDateTime = getNextMonthDate(now, executeTime, dayOfMonth);
        }

        return targetDateTime;
    }

    /**
     * å–å¾—ä¸‹å€‹æœˆå°æ‡‰æ—¥æœŸçš„ LocalDateTime
     */
    private LocalDateTime getNextMonthDate(ZonedDateTime now, LocalTime executeTime, Integer dayOfMonth) {
        // ç§»åˆ°ä¸‹å€‹æœˆ
        ZonedDateTime nextMonth = now.plusMonths(1);
        int maxDayOfNextMonth = nextMonth.toLocalDate().withDayOfMonth(1).lengthOfMonth();
        int actualDay = Math.min(dayOfMonth, maxDayOfNextMonth);

        return LocalDateTime.of(
                nextMonth.getYear(),
                nextMonth.getMonthValue(),
                actualDay,
                executeTime.getHour(),
                executeTime.getMinute(),
                executeTime.getSecond()
        );
    }

    // ==================== DTO è½‰æ›æ–¹æ³• ====================

    /**
     * æ‰¹é‡è½‰æ› Entity ç‚º DTO (é¿å… N+1 æŸ¥è©¢)
     */
    private List<MaintenanceScheduleResponseDto> mapToDtoList(List<MaintenanceSchedule> schedules) {
        if (schedules == null || schedules.isEmpty()) {
            return List.of();
        }

        // æ”¶é›†æ‰€æœ‰ staffId (å»é‡ã€æ’é™¤ null)
        List<Integer> staffIds = schedules.stream()
                .map(MaintenanceSchedule::getAssignedStaffId)
                .filter(Objects::nonNull)
                .distinct()
                .collect(Collectors.toList());

        // ä¸€æ¬¡æŸ¥è©¢æ‰€æœ‰äººå“¡ï¼Œå»ºç«‹ Map<id, name>
        Map<Integer, String> staffNameMap = staffIds.isEmpty() 
                ? Map.of()
                : staffRepo.findAllById(staffIds).stream()
                        .collect(Collectors.toMap(
                                MaintenanceStaff::getStaffId,
                                MaintenanceStaff::getStaffName
                        ));

        // è½‰æ›ç‚º DTO
        return schedules.stream()
                .map(entity -> mapToDto(entity, staffNameMap))
                .collect(Collectors.toList());
    }

    /**
     * å–®ç­†è½‰æ› Entity ç‚º DTO
     */
    private MaintenanceScheduleResponseDto mapToDto(MaintenanceSchedule entity, Map<Integer, String> staffNameMap) {
        String staffName = "æœªæŒ‡å®š";
        if (entity.getAssignedStaffId() != null) {
            staffName = staffNameMap.getOrDefault(entity.getAssignedStaffId(), "æœªæŒ‡å®š");
        }

        return new MaintenanceScheduleResponseDto(
                entity.getScheduleId(),
                entity.getTitle(),
                entity.getTargetType(),
                entity.getTargetId(),
                entity.getScheduleType(),
                entity.getDayOfWeek(),
                entity.getDayOfMonth(),
                entity.getExecuteTime(),
                entity.getIssueType(),
                entity.getIssuePriority(),
                entity.getAssignedStaffId(),
                staffName,
                entity.getIsActive(),
                entity.getLastExecutedAt(),
                entity.getNextExecuteAt(),
                entity.getCreatedAt(),
                entity.getUpdatedAt()
        );
    }

    // ==================== å·¥å…·æ–¹æ³• ====================

    private boolean isBlank(String s) {
        return s == null || s.isBlank();
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/service/maintenance/MaintenanceStaffService.java">
package com.example.backend.service.maintenance;

import com.example.backend.dto.maintenance.MaintenanceStaffResponseDto;
import com.example.backend.model.maintenance.MaintenanceInformation;
import com.example.backend.model.maintenance.MaintenanceStaff;
import com.example.backend.repository.maintenance.MaintenanceInformationRepository;
import com.example.backend.repository.maintenance.MaintenanceStaffRepository;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.Arrays;
import java.util.List;
import java.util.stream.Collectors;

@Service
@Transactional
public class MaintenanceStaffService {

    private final MaintenanceStaffRepository staffRepo;
    private final MaintenanceInformationRepository mtifRepo;
    private final MaintenanceInformationService mtifService;

    public MaintenanceStaffService(MaintenanceStaffRepository staffRepo,
                                   MaintenanceInformationRepository mtifRepo,
                                   MaintenanceInformationService mtifService) {
        this.staffRepo = staffRepo;
        this.mtifRepo = mtifRepo;
        this.mtifService = mtifService;
    }

    /**
     * è½‰ç§»å·¥å–®ä¸¦åˆªé™¤äººå“¡
     * targetStaffId: æ¥æ‰‹çš„äºº
     * deleteStaffId: è¦åœç”¨çš„äºº
     * operator: åŸ·è¡Œæ­¤æ“ä½œçš„ç®¡ç†å“¡åç¨±
     */
    public void transferAndDelete(Integer targetStaffId, Integer deleteStaffId, String operator) {
        if (deleteStaffId == null || targetStaffId == null) {
            throw new IllegalArgumentException("ID ä¸èƒ½ç‚ºç©º");
        }

        MaintenanceStaff targetStaff = getRequiredStaff(targetStaffId);
        MaintenanceStaff deleteStaff = getRequiredStaff(deleteStaffId);

        // â˜… å‘¼å« transferTickets ä¸¦å‚³å…¥æ“ä½œè€…åç¨±
        mtifService.transferTickets(deleteStaffId, targetStaffId, operator);

        deleteStaff.setIsActive(false);
        staffRepo.save(deleteStaff);
    }

    private boolean isBlank(String s) {
        return s == null || s.isBlank();
    }

    // 3. æ–°å¢ç¶­è­·äººå“¡
    public MaintenanceStaffResponseDto createStaff(MaintenanceStaff staff) {
        validateForCreate(staff);
        MaintenanceStaff entity = new MaintenanceStaff();
        entity.setStaffName(staff.getStaffName().trim());
        entity.setStaffCompany(isBlank(staff.getStaffCompany()) ? null : staff.getStaffCompany().trim());
        entity.setStaffEmail(isBlank(staff.getStaffEmail()) ? null : staff.getStaffEmail().trim());
        entity.setStaffPhone(isBlank(staff.getStaffPhone()) ? null : staff.getStaffPhone().trim());
        entity.setStaffNote(isBlank(staff.getStaffNote()) ? null : staff.getStaffNote().trim());
        
        if (staff.getIsActive() != null) {
            entity.setIsActive(staff.getIsActive());
        }

        MaintenanceStaff saved = staffRepo.save(entity);
        return maintenanceStaffResponseDto(saved);
    }

    // æ›´æ–°ç¶­è­·äººå“¡è³‡æ–™
    public MaintenanceStaffResponseDto updateStaff(Integer id, MaintenanceStaff staff) {
        if (id == null) throw new IllegalArgumentException("ID ä¸èƒ½ç‚º null");
        
        staff.setStaffId(id);
        validateForUpdate(staff);

        MaintenanceStaff existing = getRequiredStaff(id);

        existing.setStaffName(staff.getStaffName().trim());
        existing.setStaffCompany(isBlank(staff.getStaffCompany()) ? null : staff.getStaffCompany().trim());
        existing.setStaffPhone(isBlank(staff.getStaffPhone()) ? null : staff.getStaffPhone().trim());
        existing.setStaffNote(isBlank(staff.getStaffNote()) ? null : staff.getStaffNote().trim());
        existing.setStaffEmail(isBlank(staff.getStaffEmail()) ? null : staff.getStaffEmail().trim());
        
        if (staff.getIsActive() != null) {
            existing.setIsActive(staff.getIsActive());
        }

        MaintenanceStaff saved = staffRepo.save(existing);
        return maintenanceStaffResponseDto(saved);
    }

    // å–å¾—å•Ÿç”¨ä¸­çš„äººå“¡ (ä¾›ä¸‹æ‹‰é¸å–®ä½¿ç”¨)
    public List<MaintenanceStaffResponseDto> getActiveStaff() {
        List<MaintenanceStaff> activeStaff = staffRepo.findByIsActive(true);
        return activeStaff.stream()
                .map(this::maintenanceStaffResponseDto)
                .collect(Collectors.toList());
    }

    // è»Ÿåˆªé™¤ (è‹¥ç„¡é—œè¯å·¥å–®)
    public void deleteStaff(int staffId) {
        MaintenanceStaff existing = getRequiredStaff(staffId);
        if (Boolean.FALSE.equals(existing.getIsActive())) {
            return;
        }

        // å®šç¾©é‚£äº›ç‹€æ…‹æ˜¯å·¥ä½œä¸­: å·²æŒ‡æ´¾æˆ–æ˜¯ç¶­ä¿®ä¸­
        List<String> activeStatuses = Arrays.asList("ASSIGNED", "UNDER_MAINTENANCE");
        // æª¢æŸ¥è©²äººå“¡æ˜¯å¦æœ‰å·¥ä½œä¸­çš„å·¥å–®
        boolean hasActiveWork = mtifRepo.existsByAssignedStaffIdAndIssueStatusIn(staffId, activeStatuses);
        
        if (hasActiveWork) {
            throw new IllegalStateException("è©²äººå“¡å°šæœ‰æœªå®Œæˆçš„ç¶­ä¿®å·¥å–®ï¼Œç„¡æ³•åˆªé™¤ï¼è«‹å…ˆè½‰æ´¾å·¥å–®ã€‚");
        }
        
        existing.setIsActive(false);
        staffRepo.save(existing);
    }

    // 2. å–å¾—å–®ä¸€ç¶­è­·äººå“¡
    public MaintenanceStaffResponseDto getStaffById(Integer id) {
        MaintenanceStaff staff = staffRepo.findById(id).orElse(null);
        return maintenanceStaffResponseDto(staff);
    }

    @Transactional(readOnly = true)
    public MaintenanceStaff getRequiredStaff(int staffId) {
        return staffRepo.findById(staffId)
                .orElseThrow(() -> new IllegalArgumentException("æ‰¾ä¸åˆ°æŒ‡å®šçš„ç¶­è­·äººå“¡ï¼ŒstaffId = " + staffId));
    }

    // 1. å–å¾—æ‰€æœ‰ç¶­è­·äººå“¡
    public List<MaintenanceStaffResponseDto> getAllStaff() {
        List<MaintenanceStaff> staffList = staffRepo.findAll();
        return staffList.stream()
                .map(this::maintenanceStaffResponseDto) 
                .collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public List<MaintenanceStaff> getInactiveStaff() {
        return staffRepo.findByIsActiveFalseOrderByStaffIdAsc();
    }

    @Transactional(readOnly = true)
    public List<MaintenanceStaff> getStaffByCompany(String staffCompany) {
        if (isBlank(staffCompany)) throw new IllegalArgumentException("å» å•†åç¨±ä¸èƒ½ç‚ºç©ºç™½");
        return staffRepo.findByStaffCompany(staffCompany.trim());
    }

    private void validateForCreate(MaintenanceStaff staff) {
        if (staff == null) throw new IllegalArgumentException("ç¶­è­·äººå“¡è³‡æ–™ä¸èƒ½ç‚º null");
        if (isBlank(staff.getStaffName())) throw new IllegalArgumentException("ç¶­è­·äººå“¡å§“åå¿…å¡«");

        if (!isBlank(staff.getStaffEmail())) {
            String email = staff.getStaffEmail().trim();
            if (staffRepo.existsByStaffEmailIgnoreCase(email)) {
                throw new IllegalArgumentException("æ­¤ Email å·²è¢«ä½¿ç”¨");
            }
        }
    }

    private void validateForUpdate(MaintenanceStaff staff) {
        if (staff == null) throw new IllegalArgumentException("è³‡æ–™ä¸èƒ½ç‚º null");
        if (staff.getStaffId() == null) throw new IllegalArgumentException("ID ä¸èƒ½ç‚º null");
        if (isBlank(staff.getStaffName())) throw new IllegalArgumentException("å§“åå¿…å¡«");
        
        if (!isBlank(staff.getStaffEmail())) {
            String email = staff.getStaffEmail().trim();
            MaintenanceStaff existing = staffRepo.findByStaffEmailIgnoreCase(email);
            if (existing != null && !existing.getStaffId().equals(staff.getStaffId())) {
                throw new IllegalArgumentException("æ­¤ Email å·²è¢«å…¶ä»–ç¶­è­·äººå“¡ä½¿ç”¨");
            }
        }
    }

    private MaintenanceStaffResponseDto maintenanceStaffResponseDto(MaintenanceStaff staff){
        if(staff == null) return null;
        return new MaintenanceStaffResponseDto(
            staff.getStaffId(),
            staff.getStaffName(),
            staff.getStaffCompany(),
            staff.getStaffEmail(),
            staff.getStaffPhone(),
            staff.getStaffNote(),
            staff.getIsActive(),
            staff.getCreatedAt()
        );
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/service/merchantAndCoupon/DiscountService.java">
package com.example.backend.service.merchantAndCoupon;

import com.example.backend.model.merchantAndCoupon.DiscountBean;
import com.example.backend.model.merchantAndCoupon.RedemptionLog;
import com.example.backend.repository.merchantAndCoupon.DiscountRepository;
import com.example.backend.repository.merchantAndCoupon.RedemptionLogRepository;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDate;
import java.util.List;

@Service
@Transactional
public class DiscountService {

    @Autowired
    private DiscountRepository discountRepository;

    @Autowired
    private RedemptionLogRepository redemptionLogRepository;

    public List<RedemptionLog> getAllRedemptionLogs() {
        // ä¾æ™‚é–“å€’åºæ’åˆ—ï¼Œè®“ç®¡ç†å“¡å…ˆçœ‹åˆ°æœ€æ–°çš„ç´€éŒ„
        return redemptionLogRepository.findAllByOrderByRedeemTimeDesc();
    }

    public List<DiscountBean> getAll(String keyword) {
        discountRepository.autoUpdateStatus();
        if (keyword != null && !keyword.trim().isEmpty()) {
            return discountRepository.findByKeyword(keyword.trim());
        }
        return discountRepository.findAll();
    }

    public DiscountBean getById(Integer id) {
        return discountRepository.findById(id).orElse(null);
    }

    public void save(DiscountBean discount) {
        // [æ–°å¢å®¹éŒ¯] å¦‚æœå‰ç«¯å‚³ä¾† 0ï¼Œè¦–ç‚º null (æ–°å¢æ¨¡å¼)ï¼Œé¿å… "æ‰¾ä¸åˆ° ID=0" çš„éŒ¯èª¤
        if (discount.getCouponId() != null && discount.getCouponId() == 0) {
            discount.setCouponId(null);
        }

        // [é˜²å‘†] å¦‚æœæœ‰å¸¶ ID (ä¸”ä¸æ˜¯0)ï¼Œå¿…é ˆç¢ºä¿è³‡æ–™åº«çœŸçš„æœ‰é€™ç­†è³‡æ–™
        if (discount.getCouponId() != null) {
            if (!discountRepository.existsById(discount.getCouponId())) {
                throw new IllegalArgumentException("æ‰¾ä¸åˆ° couponId=" + discount.getCouponId());
            }

            // æª¢æŸ¥æ˜¯å¦æ²’æœ‰å‚³å…¥æ–°åœ–ç‰‡ï¼Œè‹¥ç„¡å‰‡ä¿ç•™èˆŠåœ–
            if (discount.getCouponImg() == null || discount.getCouponImg().trim().isEmpty()) {
                discountRepository.findById(discount.getCouponId()).ifPresent(existing -> {
                    discount.setCouponImg(existing.getCouponImg());
                });
            }
        }
        discountRepository.save(discount);
    }

    public void delete(Integer id) {
        discountRepository.deleteById(id);
    }

    public boolean updateSingleStatus(Integer id, String action) {
        DiscountBean discount = getById(id);
        if (discount == null)
            return false;

        if ("disable".equalsIgnoreCase(action)) {
            discount.setCouponStatus(3);
        } else if ("relist".equalsIgnoreCase(action)) {
            LocalDate start = discount.getStartDate();
            LocalDate end = discount.getEndDate();

            if (start == null || end == null)
                return false;

            LocalDate today = LocalDate.now();
            if (today.isBefore(start))
                discount.setCouponStatus(0);
            else if (today.isAfter(end))
                discount.setCouponStatus(2);
            else
                discount.setCouponStatus(1);
        } else {
            return false;
        }

        discountRepository.save(discount);
        return true;
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/service/merchantAndCoupon/MerchantService.java">
package com.example.backend.service.merchantAndCoupon;

import com.example.backend.model.merchantAndCoupon.MerchantBean;
import com.example.backend.repository.merchantAndCoupon.DiscountRepository;
import com.example.backend.repository.merchantAndCoupon.MerchantRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

@Service
@Transactional
public class MerchantService {

    @Autowired
    private MerchantRepository merchantRepository;

    @Autowired
    private DiscountRepository discountRepository;

    public void deleteMerchant(int id) {
        merchantRepository.deleteById(id);
    }

    public MerchantBean getById(int id) {
        return merchantRepository.findById(id).orElse(null);
    }

    public List<MerchantBean> getAll() {
        return merchantRepository.findAll();
    }

    public List<MerchantBean> getByKeyword(String kw) {
        // [ä¿®æ­£] æ›´åš´è¬¹çš„åˆ¤æ–·ï¼Œå¦‚æœ kw æ˜¯ null æˆ–ç©ºå­—ä¸²ï¼Œç›´æ¥å›å‚³å…¨éƒ¨ï¼Œé˜²æ­¢å ±éŒ¯
        if (kw == null || kw.trim().isEmpty()) {
            return merchantRepository.findAll();
        }
        return merchantRepository.findByKeyword(kw.trim());
    }

    public void saveOrUpdate(MerchantBean m) {
        // 1. åŸ·è¡Œå•†å®¶å„²å­˜
        merchantRepository.save(m);

        // 2. æ ¸å¿ƒé‚è¼¯ï¼šå¦‚æœå•†å®¶ç‹€æ…‹è¢«è¨­ç‚º 0 (åœç”¨)
        if (m.getMerchantId() != null) {
            if (m.getMerchantStatus() == 0) {
                // å•†å®¶åœç”¨ï¼šå¼·åˆ¶æ‰€æœ‰å„ªæƒ åˆ¸ä¸‹æ¶ (ç‹€æ…‹ 3)
                discountRepository.disableAllByMerchantId(m.getMerchantId());
            } else if (m.getMerchantStatus() == 1) {
                // å•†å®¶å•Ÿç”¨ï¼šè§¸ç™¼è©²å•†å®¶å„ªæƒ åˆ¸çš„ã€Œç‹€æ…‹é‡ç®—ã€
                // é€™æ¨£åŸæœ¬è¢«å¼·åˆ¶ä¸‹æ¶(3)çš„å„ªæƒ åˆ¸ï¼Œè‹¥é‚„åœ¨æœ‰æ•ˆæ—¥æœŸå…§ï¼Œå°±æœƒè®Šå› 1
                discountRepository.relistAllByMerchantId(m.getMerchantId());
            }
        }
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/service/merchantAndCoupon/RedemptionService.java">
package com.example.backend.service.merchantAndCoupon;

import java.util.List;
import java.util.stream.Collectors;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.example.backend.dto.RedemptionLogDTO;
import com.example.backend.model.merchantAndCoupon.RedemptionLog;
import com.example.backend.repository.merchantAndCoupon.DiscountRepository;
import com.example.backend.repository.merchantAndCoupon.RedemptionLogRepository;

@Service
public class RedemptionService {
    @Autowired
    private RedemptionLogRepository redemptionLogRepository;

    // å‡è¨­ä½ æœ‰ CouponRepository ä¾†æŸ¥å•†å®¶è³‡è¨Š
    @Autowired
    private DiscountRepository discountRepository;

    @Transactional(readOnly = true)
    public List<RedemptionLogDTO> getMemberLogs(Integer memId) {
        List<RedemptionLog> logs = redemptionLogRepository.findByMemIdOrderByRedeemTimeDesc(memId);

        return logs.stream().map(log -> {
            // é€é couponId æ‰¾å‡ºå°æ‡‰çš„å•†å®¶åç¨±
            String merchantName = discountRepository.findById(log.getCouponId())
                    .map(d -> d.getMerchant().getMerchantName())
                    .orElse("æœªçŸ¥å•†å®¶");
            return new RedemptionLogDTO(
                    log.getLogId(),
                    log.getMemId(),
                    log.getCouponId(),
                    log.getPointsSpent(),
                    log.getCouponName(),
                    log.getRedeemTime(),
                    merchantName);
        }).collect(Collectors.toList());
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/service/rec/RecDetailUserService.java">
package com.example.backend.service.rec;

import org.springframework.stereotype.Service;

import jakarta.transaction.Transactional;

@Service
@Transactional
public class RecDetailUserService {

}
</file>

<file path="backend/src/main/java/com/example/backend/service/spot/ISeatService.java">
package com.example.backend.service.spot;

import java.util.List;

import com.example.backend.model.spot.Seat;

public interface ISeatService {

    public Seat insert(Seat insertBean);

    public Seat update(Seat updateBean);

    public Seat selectById(Integer seatsId);

    public List<Seat> selectBySpotId(Integer spotId);

    public boolean deleteById(Integer seatsId);

    public List<Seat> selectAll();

    public List<Seat> findByCondition(String seatsName, String seatsType, String seatsStatus, Integer spotId,
            String serialNumber);

    public List<Seat> selectByKeyword(String keyword);

    public long countBySpotId(Integer spotId);

}
</file>

<file path="backend/src/main/java/com/example/backend/utils/DbPrintRunner.java">
package com.example.backend.utils;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.boot.CommandLineRunner;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.stereotype.Component;

import com.example.backend.repository.maintenance.MaintenanceInformationRepository;
import com.example.backend.repository.maintenance.MaintenanceStaffRepository;

@Component
@ConditionalOnProperty(name = "app.tools.db-print", havingValue = "true")
public class DbPrintRunner implements CommandLineRunner {

    private static final Logger log = LoggerFactory.getLogger(DbPrintRunner.class);

    private final MaintenanceStaffRepository staffRepo;
    private final MaintenanceInformationRepository infoRepo;

    public DbPrintRunner(MaintenanceStaffRepository staffRepo,
                         MaintenanceInformationRepository infoRepo) {
        this.staffRepo = staffRepo;
        this.infoRepo = infoRepo;
    }

    @Override
    public void run(String... args) {
        log.info("===== DB PRINT START =====");

        long staffCount = staffRepo.count();
        log.info("staff size={}", staffCount);
        staffRepo.findAll().forEach(s ->
            log.info("staff => id={}, name={}, company={}, phone={}, email={}, active={}",
                s.getStaffId(), s.getStaffName(), s.getStaffCompany(),
                s.getStaffPhone(), s.getStaffEmail(), s.getIsActive())
        );

        long ticketCount = infoRepo.count();
        log.info("ticket size={}", ticketCount);
        infoRepo.findAll().forEach(t ->
            log.info("ticket => id={}, spotId={}, type={}, status={}, priority={}, assignedStaffId={}",
                t.getTicketId(), t.getSpotId(), t.getIssueType(),
                t.getIssueStatus(), t.getIssuePriority(), t.getAssignedStaffId())
        );

        log.info("===== DB PRINT END =====");
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/utils/HibernateUtil.java">
package com.example.backend.utils;

import org.hibernate.SessionFactory;
import org.hibernate.boot.Metadata;
import org.hibernate.boot.MetadataSources;
import org.hibernate.boot.registry.StandardServiceRegistry;
import org.hibernate.boot.registry.StandardServiceRegistryBuilder;

public class HibernateUtil {

    private static final SessionFactory sessionFactory = buildSessionFactory();

    private static SessionFactory buildSessionFactory() {
        try {
            // 1. å»ºç«‹ ServiceRegistryï¼ˆè¼‰å…¥ hibernate.cfg.xml è¨­å®šï¼‰
            StandardServiceRegistry serviceRegistry = new StandardServiceRegistryBuilder()
                    .configure("hibernate.cfg.xml") // é è¨­æœƒæ‰¾ src/main/resources ä¸‹çš„è¨­å®šæª”
                    .build();

            // 2. å»ºç«‹ Metadataï¼ˆè§£æ Entity è¨»è§£ï¼Œå¦‚ä½ çš„ discountBeanï¼‰
            Metadata metadata = new MetadataSources(serviceRegistry)
                    .getMetadataBuilder()
                    .build();

            // 3. ç”¢å‡º SessionFactory
            return metadata.getSessionFactoryBuilder().build();
            
        } catch (Exception e) {
            System.err.println("SessionFactory å»ºç«‹å¤±æ•—ï¼š" + e);
            throw new ExceptionInInitializerError(e);
        }
    }

    // å–å¾— SessionFactory çš„éœæ…‹æ–¹æ³•
    public static SessionFactory getSessionFactory() {
        return sessionFactory;
    }

    // é—œé–‰ SessionFactoryï¼ˆé€šå¸¸åœ¨æ‡‰ç”¨ç¨‹å¼åœæ­¢æ™‚å‘¼å«ï¼‰
    public static void shutdown() {
        if (sessionFactory != null && !sessionFactory.isClosed()) {
            sessionFactory.close();
        }
    }
}
</file>

<file path="backend/src/main/resources/application.properties">
spring.datasource.url=jdbc:mysql://localhost:3306/seatrentsys?useUnicode=true&characterEncoding=utf8&serverTimezone=UTC
spring.datasource.username=tippy
spring.datasource.password=1234
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
</file>

<file path="backend/src/test/java/com/example/backend/BackendApplicationTests.java">
package com.example.backend;


import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;

@SpringBootTest
class BackendApplicationTests {

	@Test
	void contextLoads() {
	}

}
</file>

<file path="backend/src/test/java/com/example/backend/DbSmokeTest.java">
package com.example.backend;

import org.junit.jupiter.api.Test;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;

import com.example.backend.repository.maintenance.MaintenanceInformationRepository;
import com.example.backend.repository.maintenance.MaintenanceStaffRepository;

@SpringBootTest
class DbSmokeTest {

    private static final Logger log = LoggerFactory.getLogger(DbSmokeTest.class);

    @Autowired MaintenanceStaffRepository staffRepo;
    @Autowired MaintenanceInformationRepository infoRepo;

    @Test
    void db_print_all() {
        log.info("staff size={}", staffRepo.count());
        staffRepo.findAll().forEach(s ->
            log.info("staff => id={}, name={}, company={}, phone={}, email={}, active={}",
                s.getStaffId(), s.getStaffName(), s.getStaffCompany(),
                s.getStaffPhone(), s.getStaffEmail(), s.getIsActive()
            )
        );

        log.info("ticket size={}", infoRepo.count());
        infoRepo.findAll().forEach(t ->
            log.info("ticket => id={}, spotId={}, type={}, status={}, priority={}, assignedStaffId={}",
                t.getTicketId(), t.getSpotId(), t.getIssueType(),
                t.getIssueStatus(), t.getIssuePriority(), t.getAssignedStaffId()
            )
        );
    }
}
</file>

<file path="backend/docs/COZE_BOOTSTRAP_TEST.md">
# Coze Bootstrap API é©—æ”¶æ¸¬è©¦

## ğŸ“‹ æ¸¬è©¦å‰æº–å‚™

### 1. è¨­å®šç’°å¢ƒè®Šæ•¸

```bash
# Windows (PowerShell)
$env:COZE_BOT_ID="7469370888888888888"
$env:COZE_PAT="pat_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
$env:COZE_CHAT_SDK_SRC="https://lf-cdn.coze.cn/obj/unpkg/flow-platform/chat-app-sdk/1.0.0-beta.4/libs/oversea/index.js"

# Linux/Mac (Bash)
export COZE_BOT_ID="7469370888888888888"
export COZE_PAT="pat_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
export COZE_CHAT_SDK_SRC="https://lf-cdn.coze.cn/obj/unpkg/flow-platform/chat-app-sdk/1.0.0-beta.4/libs/oversea/index.js"
```

### 2. é‡å•Ÿå¾Œç«¯

```bash
cd backend
./mvnw spring-boot:run
```

---

## âœ… æ¸¬è©¦æ¡ˆä¾‹

### Test Case 1ï¼šæ­£å¸¸æƒ…æ³ï¼ˆæœ‰å®Œæ•´é…ç½®ï¼‰

**è«‹æ±‚ï¼š**
```bash
curl -i http://localhost:8080/api/support/coze/bootstrap
```

**é æœŸå›æ‡‰ï¼š**
```
HTTP/1.1 200 
Content-Type: application/json

{
  "botId": "7469370888888888888",
  "token": "pat_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
  "sdkSrc": "https://lf-cdn.coze.cn/obj/unpkg/flow-platform/chat-app-sdk/1.0.0-beta.4/libs/oversea/index.js",
  "expiresIn": 0,
  "serverTime": "2026-01-31T14:30:00",
  "note": "âš ï¸ PAT Token æé†’ï¼šæ­¤ Token æœ‰éæœŸæ™‚é–“ï¼ŒéæœŸå¾Œéœ€è¦é‡æ–°å»ºç«‹"
}
```

**å¾Œç«¯ Log æ‡‰é¡¯ç¤ºï¼š**
```
âœ… Coze Bootstrap é…ç½®å·²æä¾› - Bot ID: 7469370888888888888, SDK Src: https://lf-cdn.coze.cn/obj/unpkg/...
```

---

### Test Case 2ï¼šç¼ºå°‘ Bot ID

**æº–å‚™ï¼š**
```bash
# Windows
$env:COZE_BOT_ID=""

# Linux/Mac
unset COZE_BOT_ID
```

**è«‹æ±‚ï¼š**
```bash
curl -i http://localhost:8080/api/support/coze/bootstrap
```

**é æœŸå›æ‡‰ï¼š**
```
HTTP/1.1 500 
Content-Type: application/json

{
  "message": "Coze é…ç½®ä¸å®Œæ•´ï¼šç¼ºå°‘ Bot ID",
  "hint": "è«‹åœ¨ application.yml è¨­å®š coze.bot-id æˆ–ç’°å¢ƒè®Šæ•¸ COZE_BOT_ID",
  "status": 500,
  "timestamp": "2026-01-31T14:30:00"
}
```

**å¾Œç«¯ Log æ‡‰é¡¯ç¤ºï¼š**
```
âŒ Coze Bot ID æœªè¨­å®šï¼è«‹åœ¨ application.yml è¨­å®š coze.bot-id æˆ–ç’°å¢ƒè®Šæ•¸ COZE_BOT_ID
```

---

### Test Case 3ï¼šç¼ºå°‘ PAT Token

**æº–å‚™ï¼š**
```bash
# Windows
$env:COZE_PAT=""

# Linux/Mac
unset COZE_PAT
```

**è«‹æ±‚ï¼š**
```bash
curl -i http://localhost:8080/api/support/coze/bootstrap
```

**é æœŸå›æ‡‰ï¼š**
```
HTTP/1.1 500 
Content-Type: application/json

{
  "message": "Coze é…ç½®ä¸å®Œæ•´ï¼šç¼ºå°‘ PAT Token",
  "hint": "è«‹åœ¨ application.yml è¨­å®š coze.pat æˆ–ç’°å¢ƒè®Šæ•¸ COZE_PAT",
  "status": 500,
  "timestamp": "2026-01-31T14:30:00"
}
```

**å¾Œç«¯ Log æ‡‰é¡¯ç¤ºï¼š**
```
âŒ Coze PAT Token æœªè¨­å®šï¼è«‹åœ¨ application.yml è¨­å®š coze.pat æˆ–ç’°å¢ƒè®Šæ•¸ COZE_PAT
```

---

### Test Case 4ï¼šæ¸¬è©¦ 404 éŒ¯èª¤ä¿®æ­£

**è«‹æ±‚ä¸å­˜åœ¨çš„è³‡æºï¼š**
```bash
curl -i http://localhost:8080/api/nonexistent/endpoint
```

**é æœŸå›æ‡‰ï¼š**
```
HTTP/1.1 404 
Content-Type: application/json

{
  "message": "Not Found",
  "path": "/api/nonexistent/endpoint",
  "status": 404,
  "timestamp": "2026-01-31T14:30:00"
}
```

**é‡è¦ï¼šä¸æ‡‰è©²æ˜¯ 500 éŒ¯èª¤ï¼**

---

### Test Case 5ï¼šCORS æ¸¬è©¦ï¼ˆå‰ç«¯å‘¼å«ï¼‰

**å‰ç«¯ Console æ¸¬è©¦ï¼š**
```javascript
// åœ¨ç€è¦½å™¨ Console åŸ·è¡Œ
fetch('http://localhost:8080/api/support/coze/bootstrap')
  .then(res => res.json())
  .then(data => console.log('âœ… CORS æ­£å¸¸:', data))
  .catch(err => console.error('âŒ CORS å¤±æ•—:', err))
```

**é æœŸï¼š**
- ä¸æ‡‰å‡ºç¾ CORS éŒ¯èª¤
- èƒ½æˆåŠŸå–å¾— JSON å›æ‡‰

---

## ğŸ”’ å®‰å…¨æ€§æª¢æŸ¥

### æª¢æŸ¥é» 1ï¼šToken ä¸æ‡‰å‡ºç¾åœ¨ Log

```bash
# æœå°‹å¾Œç«¯ logï¼Œä¸æ‡‰å‡ºç¾å®Œæ•´ token
grep "pat_" backend.log
```

**é æœŸï¼šä¸æ‡‰å‡ºç¾å®Œæ•´çš„ `pat_xxxxx...` å­—ä¸²**

### æª¢æŸ¥é» 2ï¼štoString() é®è”½æ¸¬è©¦

åœ¨ Controller ä¸­æ¸¬è©¦ï¼š
```java
log.info("Response: {}", response.toString());
```

**é æœŸ Logï¼š**
```
Response: CozeBootstrapResponseDto{botId='7469370888888888888', token='pat_xxxxxx...', sdkSrc='...', ...}
```

---

## ğŸ“Š é©—æ”¶é€šéæ¨™æº–

- âœ… Test Case 1-3 å›æ‡‰æ­£ç¢º
- âœ… Test Case 4 å›å‚³ 404 è€Œé 500
- âœ… Test Case 5 ç„¡ CORS éŒ¯èª¤
- âœ… å®‰å…¨æ€§æª¢æŸ¥é€šéï¼ˆLog ä¸å«å®Œæ•´ tokenï¼‰
- âœ… å‰ç«¯å¯æˆåŠŸå‘¼å«ä¸¦å–å¾—é…ç½®
- âœ… Coze æ³¡æ³¡å¯æ­£å¸¸åˆå§‹åŒ–

---

## ğŸ› å¸¸è¦‹å•é¡Œæ’æŸ¥

### å•é¡Œ 1ï¼šä»å‡ºç¾ api/api/support è·¯å¾‘

**åŸå› ï¼š** å‰ç«¯ API è·¯å¾‘éŒ¯èª¤  
**è§£æ±ºï¼š** ç¢ºèª `frontend/src/api/modules/support.js` ä½¿ç”¨ `/support/coze/bootstrap` è€Œé `/api/support/...`

### å•é¡Œ 2ï¼šCORS éŒ¯èª¤

**åŸå› ï¼š** SecurityConfig æœªæ­£ç¢ºé…ç½®  
**è§£æ±ºï¼š** ç¢ºèª `SecurityConfig.java` ä¸­ï¼š
- `/api/**` å·²åœ¨ permitAll()
- CORS é…ç½®åŒ…å« `http://localhost:5173`

### å•é¡Œ 3ï¼š404 è®Šæˆ 500

**åŸå› ï¼š** GlobalExceptionHandler æœªè™•ç† NoResourceFoundException  
**è§£æ±ºï¼š** ç¢ºèªå·²æ–°å¢ `handleNoResourceFoundException()` æ–¹æ³•

### å•é¡Œ 4ï¼šToken å¤–æ´©åœ¨ Log

**åŸå› ï¼š** ä½¿ç”¨äº† `log.info("token: {}", token)`  
**è§£æ±ºï¼š** ç¢ºèªæ‰€æœ‰ log éƒ½ä¸ç›´æ¥å° tokenï¼Œä½¿ç”¨ DTO çš„ toString() è‡ªå‹•é®è”½
</file>

<file path="backend/docs/COZE_INTEGRATION_REPORT.md">
# Coze Web Chat SDK æ•´åˆå®Œæˆå ±å‘Š

## ğŸ“‹ æ•´åˆæ‘˜è¦

**å®Œæˆæ™‚é–“**ï¼š2026-01-31  
**æ•´åˆç¯„åœ**ï¼šå‰å¾Œç«¯å®Œæ•´æ•´åˆ Coze Web Chat SDKï¼Œæä¾› FAQ ç³»çµ±èˆ‡ AI å®¢æœæ³¡æ³¡  
**åŠŸèƒ½ç‹€æ…‹**ï¼šâœ… å·²å®Œæˆä¸¦æ¸¬è©¦é€šé

---

## ğŸ¯ å¯¦ä½œåŠŸèƒ½

### 1. FAQ ç³»çµ±

- âœ… 14 å€‹å¸¸è¦‹å•é¡Œï¼ˆ4 å¤§åˆ†é¡ï¼‰
  - æœƒå“¡ç›¸é—œï¼ˆ4 é¡Œï¼‰
  - å ´åœ°ç›¸é—œï¼ˆ4 é¡Œï¼‰
  - è¨‚ä½ç›¸é—œï¼ˆ4 é¡Œï¼‰
  - å…¶ä»–å•é¡Œï¼ˆ2 é¡Œï¼‰
- âœ… é—œéµå­—æœå°‹ï¼ˆæ¨™é¡Œã€å…§å®¹ã€æ¨™ç±¤ã€é—œéµå­—ï¼‰
- âœ… åˆ†é¡ç¯©é¸åˆ‡æ›
- âœ… æ‰‹é¢¨ç´å±•é–‹/æ”¶åˆ
- âœ… éŸ¿æ‡‰å¼è¨­è¨ˆï¼ˆBootstrap 5ï¼‰

### 2. Coze AI å®¢æœæ³¡æ³¡

- âœ… è‡ªå‹•åˆå§‹åŒ–ï¼ˆé é¢è¼‰å…¥å¾Œ 1 ç§’ï¼‰
- âœ… å‹•æ…‹è¼‰å…¥ SDK Script
- âœ… æœƒå“¡ ID è¾¨è­˜æ©Ÿåˆ¶
  - å·²ç™»å…¥æœƒå“¡ï¼š`member_{memId}`
  - åŒ¿åè¨ªå®¢ï¼šUUIDï¼ˆlocalStorage æŒä¹…åŒ–ï¼‰
- âœ… Token è‡ªå‹•åˆ·æ–°æ©Ÿåˆ¶
- âœ… é˜²æ­¢é‡è¤‡åˆå§‹åŒ–ï¼ˆå…¨åŸŸæ——æ¨™ï¼‰
- âœ… éŒ¯èª¤è™•ç†ï¼ˆä¸å½±éŸ¿ FAQ åŠŸèƒ½ï¼‰

### 3. å•é¡Œå›å ±è¡¨å–®

- âœ… çµæ§‹åŒ–è¡¨å–®ï¼ˆå•é¡Œé¡å‹ã€æè¿°ï¼‰
- âœ… åœ–ç‰‡ä¸Šå‚³åŠŸèƒ½ï¼ˆé è¦½èˆ‡åˆªé™¤ï¼‰
- âœ… è¡¨å–®é©—è­‰
- âœ… å®Œå–„çš„éŒ¯èª¤è™•ç†

### 4. Backend Bootstrap API

- âœ… æä¾›å‰ç«¯åˆå§‹åŒ–æ‰€éœ€é…ç½®
- âœ… ç’°å¢ƒè®Šæ•¸æ³¨å…¥ï¼ˆ@Valueï¼‰
- âœ… é…ç½®é©—è­‰ï¼ˆç¼ºå°‘æ™‚å›å‚³ 500ï¼‰
- âœ… Token å®‰å…¨æ€§ï¼ˆä¸åœ¨ log å°å‡ºï¼‰
- âœ… DTO toString() è‡ªå‹•é®è”½ Token

### 5. è·¯ç”±èˆ‡å…¥å£

- âœ… `/support` - å®¢æœæ”¯æ´ä¸­å¿ƒï¼ˆFAQ + Cozeï¼‰
- âœ… `/support/report` - å•é¡Œå›å ±
- âœ… MainLayout å´é‚Šæ¬„å®¢æœå…¥å£ï¼ˆé›»è©±åœ–ç¤ºï¼‰

---

## ğŸ“ æª”æ¡ˆæ¸…å–®

### ğŸ†• æ–°å¢æª”æ¡ˆ

#### Backendï¼ˆå¾Œç«¯ï¼‰

```
backend/src/main/java/com/example/backend/
â”œâ”€â”€ controller/support/
â”‚   â””â”€â”€ SupportCozeController.java                  âœ… Bootstrap API ç«¯é»
â””â”€â”€ dto/support/
    â””â”€â”€ CozeBootstrapResponseDto.java              âœ… Response DTOï¼ˆToken é®è”½ï¼‰
```

#### Frontendï¼ˆå‰ç«¯ï¼‰

```
frontend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ api/modules/
â”‚   â”‚   â””â”€â”€ support.js                             âœ… Support API æ¨¡çµ„
â”‚   â”œâ”€â”€ data/
â”‚   â”‚   â””â”€â”€ supportFaq.js                          âœ… FAQ è³‡æ–™ï¼ˆ14 é …ï¼‰
â”‚   â””â”€â”€ views/support/
â”‚       â”œâ”€â”€ SupportCenterView.vue                  âœ… FAQ ä¸­å¿ƒ + Coze åˆå§‹åŒ–
â”‚       â””â”€â”€ SupportReportView.vue                  âœ… å•é¡Œå›å ±è¡¨å–®
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ COZE_README.md                             ğŸ“š æ•´åˆç¸½è¦½èˆ‡å¿«é€Ÿé–‹å§‹
â”‚   â”œâ”€â”€ COZE_TESTING_GUIDE.md                      ğŸ“š å®Œæ•´æ¸¬è©¦æŒ‡å—
â”‚   â””â”€â”€ COZE_TROUBLESHOOTING.md                    ğŸ“š ç–‘é›£æ’è§£æŒ‡å—
â””â”€â”€ COZE_README.md                                 ğŸ“š ä¸»è¦èªªæ˜æ–‡ä»¶ï¼ˆæ ¹ç›®éŒ„ï¼‰
```

#### Scriptsï¼ˆè…³æœ¬ï¼‰

```
å°ˆæ¡ˆæ ¹ç›®éŒ„/
â”œâ”€â”€ diagnose-coze.ps1                              ğŸ”§ è‡ªå‹•è¨ºæ–·è…³æœ¬
â””â”€â”€ setup-coze.ps1                                 ğŸ”§ å¿«é€Ÿè¨­å®šè…³æœ¬
```

---

### ğŸ”§ ä¿®æ”¹æª”æ¡ˆ

#### Backendï¼ˆå¾Œç«¯ï¼‰

```
backend/src/main/
â”œâ”€â”€ java/com/example/backend/exception/
â”‚   â””â”€â”€ GlobalExceptionHandler.java                ğŸ”§ æ–°å¢ NoResourceFoundException è™•ç†
â””â”€â”€ resources/
    â””â”€â”€ application.yml                            ğŸ”§ æ–°å¢ coze é…ç½®å€å¡Š
```

#### Frontendï¼ˆå‰ç«¯ï¼‰

```
frontend/src/
â”œâ”€â”€ router/
â”‚   â””â”€â”€ index.js                                   ğŸ”§ æ–°å¢ /support, /support/report è·¯ç”±
â””â”€â”€ layouts/
    â””â”€â”€ MainLayout.vue                             ğŸ”§ æ–°å¢å®¢æœå…¥å£ï¼ˆå·²æœ‰ï¼‰
```

---

## ğŸ” æ ¸å¿ƒæŠ€è¡“ç´°ç¯€

### è·¯å¾‘é…ç½®ï¼ˆé‡è¦ï¼ï¼‰

```javascript
// âœ… æ­£ç¢ºé…ç½®
// http.js
const http = axios.create({
  baseURL: "/api", // â† å¿…é ˆæ˜¯ '/api'
});

// support.js
export const getCozeBootstrap = () => {
  return http.get("/support/coze/bootstrap"); // â† ä¸åŠ  /api å‰ç¶´
};

// æœ€çµ‚è·¯å¾‘æ‹¼æ¥ï¼š
// baseURL('/api') + path('/support/coze/bootstrap')
// = '/api/support/coze/bootstrap'
// â†’ Vite Proxy è½‰ç™¼
// â†’ http://localhost:8080/api/support/coze/bootstrap
```

### Coze åˆå§‹åŒ–æµç¨‹

```javascript
// SupportCenterView.vue
initCozeChat() {
  1. æª¢æŸ¥æ˜¯å¦å·²åˆå§‹åŒ–ï¼ˆwindow.__coze_initedï¼‰
  2. å‘¼å« supportApi.getCozeBootstrap()
  3. é©—è­‰å›æ‡‰ï¼ˆbotId, tokenï¼‰
  4. æ±ºå®š SDK ä¾†æºï¼ˆå¾Œç«¯å„ªå…ˆï¼Œå¦å‰‡ç’°å¢ƒè®Šæ•¸ï¼‰
  5. å‹•æ…‹è¼‰å…¥ SDK Scriptï¼ˆé˜²æ­¢é‡è¤‡æ’å…¥ï¼‰
  6. å»ºç«‹ WebChatClient å¯¦ä¾‹
  7. è¨­å®šä½¿ç”¨è€… IDï¼ˆmember_X / UUIDï¼‰
  8. è¨­å®š Token åˆ·æ–°æ©Ÿåˆ¶ï¼ˆonRefreshTokenï¼‰
  9. è¨­å®šå…¨åŸŸæ——æ¨™ï¼ˆwindow.__coze_inited = trueï¼‰
}
```

### Token å®‰å…¨æ€§

```java
// CozeBootstrapResponseDto.java
@Override
public String toString() {
    return "CozeBootstrapResponseDto{" +
            "botId='" + botId + '\'' +
            ", token='" + (token != null && token.length() > 10
                ? token.substring(0, 10) + "..."
                : "[MASKED]") + '\'' +  // â† è‡ªå‹•é®è”½
            ", sdkSrc='" + sdkSrc + '\'' +
            ", expiresIn=" + expiresIn +
            ", serverTime=" + serverTime +
            ", note='" + note + '\'' +
            '}';
}
```

---

## ğŸš€ å¿«é€Ÿå•Ÿå‹•

### Step 1ï¼šè¨­å®šç’°å¢ƒè®Šæ•¸

```powershell
# æ–¹å¼ 1ï¼šä½¿ç”¨å¿«é€Ÿè¨­å®šè…³æœ¬ï¼ˆæ¨è–¦ï¼‰
.\setup-coze.ps1

# æ–¹å¼ 2ï¼šæ‰‹å‹•è¨­å®š
$env:COZE_BOT_ID="ä½ çš„Bot ID"
$env:COZE_PAT="ä½ çš„Personal Access Token"
$env:COZE_CHAT_SDK_SRC="https://lf-cdn.coze.cn/obj/unpkg/flow-platform/chat-app-sdk/1.0.0-beta.4/libs/oversea/index.js"
```

### Step 2ï¼šå•Ÿå‹•æœå‹™

```bash
# çµ‚ç«¯æ©Ÿ 1ï¼šå¾Œç«¯
cd backend
mvn spring-boot:run

# çµ‚ç«¯æ©Ÿ 2ï¼šå‰ç«¯
cd frontend
npm run dev
```

### Step 3ï¼šé©—è­‰æ•´åˆ

```bash
# æ¸¬è©¦å¾Œç«¯ API
curl http://localhost:8080/api/support/coze/bootstrap

# ç€è¦½å™¨æ¸¬è©¦
# å‰å¾€ http://localhost:5173/support
# æª¢æŸ¥ Console æ˜¯å¦é¡¯ç¤ºï¼š[Coze] åˆå§‹åŒ–å®Œæˆ âœ…
```

### Step 4ï¼šè‡ªå‹•è¨ºæ–·

```powershell
# åŸ·è¡Œè¨ºæ–·è…³æœ¬
.\diagnose-coze.ps1
```

---

## ğŸ“Š æ¸¬è©¦å ±å‘Š

### âœ… å¾Œç«¯æ¸¬è©¦

- âœ… Bootstrap API å›å‚³ 200 OK
- âœ… å›æ‡‰åŒ…å«å®Œæ•´æ¬„ä½ï¼ˆbotId, token, sdkSrc, expiresIn, serverTime, noteï¼‰
- âœ… ç¼ºå°‘ç’°å¢ƒè®Šæ•¸æ™‚å›å‚³ 500 ä¸¦æç¤ºéŒ¯èª¤
- âœ… Token ä¸åœ¨ log å°å‡ºå®Œæ•´å…§å®¹
- âœ… CORS é…ç½®æ­£ç¢º

### âœ… å‰ç«¯æ¸¬è©¦

- âœ… FAQ ç³»çµ±æ­£å¸¸é¡¯ç¤ºï¼ˆ14 å€‹å•é¡Œï¼‰
- âœ… æœå°‹åŠŸèƒ½æ­£å¸¸ï¼ˆæ¨™é¡Œã€å…§å®¹ã€æ¨™ç±¤ã€é—œéµå­—ï¼‰
- âœ… åˆ†é¡ç¯©é¸æ­£å¸¸
- âœ… æ‰‹é¢¨ç´å±•é–‹/æ”¶åˆæ­£å¸¸
- âœ… Bootstrap API å‘¼å«æˆåŠŸï¼ˆ200 OKï¼‰
- âœ… Coze SDK è¼‰å…¥æˆåŠŸ
- âœ… æ³¡æ³¡å‡ºç¾åœ¨å³ä¸‹è§’
- âœ… å¯æ­£å¸¸å‚³é€è¨Šæ¯ä¸¦æ”¶åˆ°å›æ‡‰
- âœ… Token åˆ·æ–°æ©Ÿåˆ¶æ­£å¸¸
- âœ… æœƒå“¡ ID è¾¨è­˜æ­£å¸¸

### âœ… æ•´åˆæ¸¬è©¦

- âœ… è·¯å¾‘ç„¡ api/api é‡è¤‡å•é¡Œ
- âœ… Vite Proxy è½‰ç™¼æ­£å¸¸
- âœ… åŒ¿åè¨ªå®¢ UUID æ­£å¸¸ç”¢ç”Ÿèˆ‡æŒä¹…åŒ–
- âœ… æœƒå“¡ç™»å…¥å¾Œ ID æ­£ç¢ºä½¿ç”¨ member\_{memId}
- âœ… æ³¡æ³¡åˆå§‹åŒ–ä¸å½±éŸ¿ FAQ åŠŸèƒ½
- âœ… éŒ¯èª¤è™•ç†å®Œå–„ï¼ˆ500/404 ä¸å´©æ½°ï¼‰

---

## ğŸ› ï¸ å·¥å…·èˆ‡è…³æœ¬

### 1. diagnose-coze.ps1ï¼ˆè¨ºæ–·è…³æœ¬ï¼‰

**åŠŸèƒ½**ï¼š

- âœ… æª¢æŸ¥ç’°å¢ƒè®Šæ•¸è¨­å®š
- âœ… æ¸¬è©¦å¾Œç«¯ Bootstrap API
- âœ… æª¢æŸ¥å‰ç«¯é…ç½®æª”æ¡ˆï¼ˆhttp.js, support.js, vite.config.jsï¼‰
- âœ… æª¢æŸ¥è·¯ç”±é…ç½®
- âœ… æª¢æŸ¥ MainLayout å…¥å£
- âœ… æä¾›ä¿®æ­£å»ºè­°

**ä½¿ç”¨æ–¹å¼**ï¼š

```powershell
.\diagnose-coze.ps1
```

### 2. setup-coze.ps1ï¼ˆå¿«é€Ÿè¨­å®šè…³æœ¬ï¼‰

**åŠŸèƒ½**ï¼š

- âœ… äº’å‹•å¼è¨­å®šç’°å¢ƒè®Šæ•¸
- âœ… é©—è­‰å¾Œç«¯ API
- âœ… ç”¢ç”Ÿå¯é‡è¤‡ä½¿ç”¨çš„è¨­å®šæª”ï¼ˆcoze-env.ps1ï¼‰
- âœ… æä¾›ä¸‹ä¸€æ­¥æ“ä½œæŒ‡å¼•

**ä½¿ç”¨æ–¹å¼**ï¼š

```powershell
# äº’å‹•å¼
.\setup-coze.ps1

# å‘½ä»¤åˆ—åƒæ•¸
.\setup-coze.ps1 -BotId "ä½ çš„Bot ID" -Pat "ä½ çš„PAT Token"
```

---

## ğŸ“š èªªæ˜æ–‡ä»¶

### 1. COZE_README.md

- ğŸ“Œ æ•´åˆç¸½è¦½
- ğŸ“Œ 5 åˆ†é˜å¿«é€Ÿé–‹å§‹
- ğŸ“Œ å°ˆæ¡ˆçµæ§‹èªªæ˜
- ğŸ“Œ ç’°å¢ƒè®Šæ•¸èªªæ˜
- ğŸ“Œ åŠŸèƒ½ç‰¹è‰²
- ğŸ“Œ è³‡æ–™æµç¨‹åœ–
- ğŸ“Œ å¸¸ç”¨æŒ‡ä»¤
- ğŸ“Œ æª¢æŸ¥æ¸…å–®

### 2. COZE_TESTING_GUIDE.md

- ğŸ“Œ ç³»çµ±æ¶æ§‹ç¸½è¦½
- ğŸ“Œ å®Œæ•´é…ç½®æª¢æŸ¥æ¸…å–®
- ğŸ“Œ æ¸¬è©¦æµç¨‹ï¼ˆStep by Stepï¼‰
- ğŸ“Œ ç€è¦½å™¨ Console/Network æª¢æŸ¥
- ğŸ“Œ è¦–è¦ºé©—è­‰æ¸…å–®
- ğŸ“Œ ç–‘é›£æ’è§£
- ğŸ“Œ æ¸¬è©¦å ±å‘Šç¯„ä¾‹
- ğŸ“Œ ç¶­è­·å»ºè­°

### 3. COZE_TROUBLESHOOTING.md

- ğŸ“Œ ç³»çµ±æ¶æ§‹æª¢æŸ¥æ¸…å–®
- ğŸ“Œ è¨ºæ–·è…³æœ¬ä½¿ç”¨æ–¹å¼
- ğŸ“Œ å¸¸è¦‹éŒ¯èª¤èˆ‡è§£æ±ºæ–¹å¼
- ğŸ“Œ FAQï¼ˆå¸¸è¦‹å•é¡Œï¼‰
- ğŸ“Œ å¿«é€Ÿå•Ÿå‹•æµç¨‹
- ğŸ“Œ ç¶­è­·å»ºè­°

---

## ğŸ”’ å®‰å…¨æ€§æªæ–½

### Backendï¼ˆå¾Œç«¯ï¼‰

- âœ… æ•æ„Ÿè³‡è¨Šä¾†è‡ªç’°å¢ƒè®Šæ•¸ï¼ˆä¸å¯«æ­»åœ¨ç¨‹å¼ç¢¼ï¼‰
- âœ… Token ä¸åœ¨ log å°å‡ºå®Œæ•´å…§å®¹
- âœ… DTO çš„ `toString()` è‡ªå‹•é®è”½ Tokenï¼ˆåªé¡¯ç¤ºå‰ 10 å­—å…ƒï¼‰
- âœ… ç¼ºå°‘é…ç½®æ™‚å›å‚³æ˜ç¢ºéŒ¯èª¤è¨Šæ¯ï¼ˆä¸æ´©æ¼æ•æ„Ÿè³‡è¨Šï¼‰
- âœ… GlobalExceptionHandler çµ±ä¸€è™•ç† 404ï¼ˆä¸å›å‚³ 500ï¼‰

### Frontendï¼ˆå‰ç«¯ï¼‰

- âœ… Token ä¸åœ¨ Console å°å‡º
- âœ… éŒ¯èª¤è™•ç†ä¸æ´©æ¼æ•æ„Ÿè³‡è¨Š
- âœ… åŒ¿åè¨ªå®¢ä½¿ç”¨ UUIDï¼ˆcrypto.randomUUIDï¼‰
- âœ… æœƒå“¡ä½¿ç”¨ `member_{memId}`ï¼ˆè¾¨è­˜åº¦é«˜ï¼Œä¸æ´©æ¼å€‹è³‡ï¼‰
- âœ… Token åˆ·æ–°æ©Ÿåˆ¶ï¼ˆonRefreshToken è‡ªå‹•è™•ç†ï¼‰

---

## ğŸ“ ç¶­è­·å»ºè­°

### å®šæœŸæª¢æŸ¥

- [ ] **æ¯ 90 å¤©**ï¼šæ›´æ› Coze PAT Token
- [ ] **æ¯æœˆ**ï¼šæª¢æŸ¥ Coze SDK ç‰ˆæœ¬æ›´æ–°
- [ ] **æ¯é€±**ï¼šç›£æ§ Bootstrap API å‘¼å«é »ç‡
- [ ] **æ¯æ—¥**ï¼šæª¢æŸ¥å¾Œç«¯ log æ˜¯å¦æœ‰ç•°å¸¸

### ç›£æ§æŒ‡æ¨™

- Bootstrap API æˆåŠŸç‡ï¼ˆç›®æ¨™ï¼š>99%ï¼‰
- åˆå§‹åŒ–å¤±æ•—ç‡ï¼ˆç›®æ¨™ï¼š<1%ï¼‰
- Token åˆ·æ–°é »ç‡
- ä½¿ç”¨è€…æ»¿æ„åº¦ï¼ˆChat ä½¿ç”¨ç‡ï¼‰

### å‚™ä»½è¨ˆç•«

- [ ] å®šæœŸå‚™ä»½ FAQ è³‡æ–™
- [ ] ä¿ç•™èˆŠç‰ˆ PAT Tokenï¼ˆç›´åˆ°ç¢ºèªæ–° Token æ­£å¸¸ï¼‰
- [ ] è¨˜éŒ„ SDK ç‰ˆæœ¬è®Šæ›´æ­·å²
- [ ] å®šæœŸæª¢æŸ¥ Coze å®˜æ–¹æ–‡ä»¶æ›´æ–°

---

## ğŸ“ ä½¿ç”¨æŒ‡å—

### å°æ–¼é–‹ç™¼è€…

1. é–±è®€ [COZE_README.md](COZE_README.md) äº†è§£æ•´åˆæ¶æ§‹
2. åŸ·è¡Œ `setup-coze.ps1` å¿«é€Ÿè¨­å®šç’°å¢ƒ
3. é–±è®€ [COZE_TESTING_GUIDE.md](COZE_TESTING_GUIDE.md) å­¸ç¿’æ¸¬è©¦æµç¨‹
4. é‡åˆ°å•é¡Œæ™‚æŸ¥é–± [COZE_TROUBLESHOOTING.md](COZE_TROUBLESHOOTING.md)

### å°æ–¼æ¸¬è©¦äººå“¡

1. åŸ·è¡Œ `diagnose-coze.ps1` æª¢æŸ¥é…ç½®
2. ä¾ç…§ [COZE_TESTING_GUIDE.md](COZE_TESTING_GUIDE.md) åŸ·è¡Œæ¸¬è©¦
3. è¨˜éŒ„æ¸¬è©¦çµæœï¼ˆåƒè€ƒæ–‡ä»¶ä¸­çš„æ¸¬è©¦å ±å‘Šç¯„ä¾‹ï¼‰

### å°æ–¼ç¶­é‹äººå“¡

1. å®šæœŸåŸ·è¡Œ `diagnose-coze.ps1` æª¢æŸ¥ç³»çµ±ç‹€æ…‹
2. ç›£æ§ Token éæœŸæ™‚é–“
3. å®šæœŸæ›´æ–° FAQ å…§å®¹
4. æª¢æŸ¥ä½¿ç”¨è€…å›é¥‹ä¸¦å„ªåŒ– FAQ

---

## ğŸ“ æ”¯æ´è³‡æº

### å®˜æ–¹æ–‡ä»¶

- [Coze å¹³å°](https://www.coze.com/)
- [Coze Web Chat SDK æ–‡ä»¶](https://www.coze.com/docs/developer_guides/web_chat_sdk)

### å°ˆæ¡ˆæ–‡ä»¶

- [æ•´åˆç¸½è¦½](frontend/COZE_README.md)
- [æ¸¬è©¦æŒ‡å—](frontend/COZE_TESTING_GUIDE.md)
- [ç–‘é›£æ’è§£](frontend/COZE_TROUBLESHOOTING.md)

### è¯çµ¡è³‡è¨Š

- é–‹ç™¼åœ˜éšŠï¼šTake@Seat é–‹ç™¼åœ˜éšŠ
- æœ€å¾Œæ›´æ–°ï¼š2026-01-31

---

## âœ… é©—æ”¶æ¨™æº–

### åŠŸèƒ½é©—æ”¶

- [x] FAQ ç³»çµ±å®Œæ•´é¡¯ç¤ºï¼ˆ14 å€‹å•é¡Œï¼‰
- [x] æœå°‹åŠŸèƒ½æ­£å¸¸é‹ä½œ
- [x] åˆ†é¡ç¯©é¸æ­£å¸¸é‹ä½œ
- [x] Coze æ³¡æ³¡æˆåŠŸå‡ºç¾
- [x] å¯æ­£å¸¸å‚³é€è¨Šæ¯ä¸¦æ”¶åˆ°å›æ‡‰
- [x] å•é¡Œå›å ±è¡¨å–®æ­£å¸¸é‹ä½œ
- [x] MainLayout æœ‰å®¢æœå…¥å£

### æŠ€è¡“é©—æ”¶

- [x] Backend Bootstrap API æ­£å¸¸é‹ä½œ
- [x] è·¯å¾‘é…ç½®æ­£ç¢ºï¼ˆç„¡ api/api é‡è¤‡ï¼‰
- [x] Token å®‰å…¨æ€§æªæ–½å®Œå–„
- [x] éŒ¯èª¤è™•ç†å®Œå–„
- [x] æœƒå“¡ ID è¾¨è­˜æ­£å¸¸
- [x] Token åˆ·æ–°æ©Ÿåˆ¶æ­£å¸¸

### æ–‡ä»¶é©—æ”¶

- [x] å®Œæ•´çš„è¨­å®šæŒ‡å—
- [x] å®Œæ•´çš„æ¸¬è©¦æŒ‡å—
- [x] å®Œæ•´çš„ç–‘é›£æ’è§£æŒ‡å—
- [x] è‡ªå‹•è¨ºæ–·è…³æœ¬
- [x] å¿«é€Ÿè¨­å®šè…³æœ¬

---

## ğŸ‰ ç¸½çµ

âœ… **Coze Web Chat SDK æ•´åˆå®Œæˆï¼**

æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å·²å¯¦ä½œä¸¦æ¸¬è©¦é€šéï¼š

- âœ… FAQ ç³»çµ±ï¼ˆ14 å€‹å•é¡Œï¼Œ4 å¤§åˆ†é¡ï¼‰
- âœ… Coze AI å®¢æœæ³¡æ³¡ï¼ˆè‡ªå‹•åˆå§‹åŒ–ã€Token åˆ·æ–°ï¼‰
- âœ… å•é¡Œå›å ±è¡¨å–®ï¼ˆåœ–ç‰‡ä¸Šå‚³ã€è¡¨å–®é©—è­‰ï¼‰
- âœ… Backend Bootstrap APIï¼ˆç’°å¢ƒè®Šæ•¸ã€å®‰å…¨æ€§ï¼‰
- âœ… å®Œæ•´çš„æ¸¬è©¦èˆ‡è¨ºæ–·å·¥å…·
- âœ… å®Œå–„çš„èªªæ˜æ–‡ä»¶

**ä¸‹ä¸€æ­¥**ï¼š

1. åŸ·è¡Œ `setup-coze.ps1` è¨­å®šç’°å¢ƒè®Šæ•¸
2. å•Ÿå‹•å‰å¾Œç«¯æœå‹™
3. åŸ·è¡Œ `diagnose-coze.ps1` é©—è­‰é…ç½®
4. å‰å¾€ `http://localhost:5173/support` æ¸¬è©¦åŠŸèƒ½

**é‡åˆ°å•é¡Œï¼Ÿ**

- æŸ¥é–± [COZE_TROUBLESHOOTING.md](frontend/COZE_TROUBLESHOOTING.md)
- åŸ·è¡Œ `.\diagnose-coze.ps1` è‡ªå‹•è¨ºæ–·

---

**ç¶­è­·è€…**ï¼šTake@Seat é–‹ç™¼åœ˜éšŠ  
**å®Œæˆæ™‚é–“**ï¼š2026-01-31  
**ç‰ˆæœ¬**ï¼š1.0.0
</file>

<file path="backend/docs/COZE_README.md">
# Coze Web Chat SDK æ•´åˆæŒ‡å—

## ğŸ“š æ–‡ä»¶ç´¢å¼•

| æ–‡ä»¶åç¨± | ç”¨é€” | é©ç”¨å°è±¡ |
|---------|------|---------|
| [COZE_SETUP.md](COZE_SETUP.md) | å®Œæ•´è¨­å®šæŒ‡å— | **é¦–æ¬¡è¨­å®šå¿…è®€** |
| [COZE_TESTING_GUIDE.md](COZE_TESTING_GUIDE.md) | æ¸¬è©¦æµç¨‹èˆ‡æª¢æŸ¥æ¸…å–® | æ¸¬è©¦äººå“¡ã€é–‹ç™¼è€… |
| [COZE_TROUBLESHOOTING.md](COZE_TROUBLESHOOTING.md) | ç–‘é›£æ’è§£æŒ‡å— | é‡åˆ°å•é¡Œæ™‚æŸ¥é–± |
| [diagnose-coze.ps1](../diagnose-coze.ps1) | è‡ªå‹•è¨ºæ–·è…³æœ¬ | å¿«é€Ÿæª¢æŸ¥é…ç½® |
| [setup-coze.ps1](../setup-coze.ps1) | å¿«é€Ÿè¨­å®šè…³æœ¬ | å¿«é€Ÿè¨­å®šç’°å¢ƒè®Šæ•¸ |

---

## ğŸš€ 5 åˆ†é˜å¿«é€Ÿé–‹å§‹

### Step 1ï¼šè¨­å®šç’°å¢ƒè®Šæ•¸ï¼ˆ3 åˆ†é˜ï¼‰

#### æ–¹å¼ 1ï¼šä½¿ç”¨å¿«é€Ÿè¨­å®šè…³æœ¬ï¼ˆæ¨è–¦ï¼‰
```powershell
# åœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„åŸ·è¡Œ
.\setup-coze.ps1
```

è…³æœ¬æœƒè‡ªå‹•ï¼š
1. è©¢å•ä¸¦è¨­å®šç’°å¢ƒè®Šæ•¸
2. é©—è­‰å¾Œç«¯ API
3. ç”¢ç”Ÿå¯é‡è¤‡ä½¿ç”¨çš„è¨­å®šæª” `coze-env.ps1`

#### æ–¹å¼ 2ï¼šæ‰‹å‹•è¨­å®š
```powershell
# Windows PowerShell
$env:COZE_BOT_ID="ä½ çš„Bot ID"
$env:COZE_PAT="ä½ çš„Personal Access Token"
$env:COZE_CHAT_SDK_SRC="https://lf-cdn.coze.cn/obj/unpkg/flow-platform/chat-app-sdk/1.0.0-beta.4/libs/oversea/index.js"
```

---

### Step 2ï¼šå•Ÿå‹•æœå‹™ï¼ˆ2 åˆ†é˜ï¼‰

#### çµ‚ç«¯æ©Ÿ 1ï¼šå•Ÿå‹•å¾Œç«¯
```bash
cd backend
mvn spring-boot:run
```

#### çµ‚ç«¯æ©Ÿ 2ï¼šå•Ÿå‹•å‰ç«¯
```bash
cd frontend
npm run dev
```

---

### Step 3ï¼šé©—è­‰æ•´åˆï¼ˆ1 åˆ†é˜ï¼‰

1. é–‹å•Ÿç€è¦½å™¨ï¼š`http://localhost:5173/support`
2. é–‹å•Ÿ Chrome DevToolsï¼ˆF12ï¼‰
3. æª¢æŸ¥ Console æ˜¯å¦é¡¯ç¤ºï¼š

```
[Coze] é–‹å§‹è¼‰å…¥ Bootstrap é…ç½®...
[Coze] Bootstrap é…ç½®è¼‰å…¥æˆåŠŸ
[Coze] SDK è¼‰å…¥æˆåŠŸ
[Coze] åˆå§‹åŒ–å®Œæˆ âœ…
```

4. æª¢æŸ¥é é¢å³ä¸‹è§’æ˜¯å¦å‡ºç¾ Coze èŠå¤©æ³¡æ³¡

âœ… **æˆåŠŸï¼** å¦‚æœçœ‹åˆ°æ³¡æ³¡ï¼Œæ•´åˆå®Œæˆï¼

âŒ **å¤±æ•—ï¼Ÿ** åŸ·è¡Œè¨ºæ–·è…³æœ¬ï¼š
```powershell
.\diagnose-coze.ps1
```

---

## ğŸ“ å°ˆæ¡ˆçµæ§‹

### Backendï¼ˆå¾Œç«¯ï¼‰
```
backend/
â”œâ”€â”€ src/main/
â”‚   â”œâ”€â”€ java/com/example/backend/
â”‚   â”‚   â”œâ”€â”€ controller/
â”‚   â”‚   â”‚   â””â”€â”€ support/
â”‚   â”‚   â”‚       â””â”€â”€ SupportCozeController.java      ğŸ“Œ Bootstrap API
â”‚   â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”‚   â””â”€â”€ support/
â”‚   â”‚   â”‚       â””â”€â”€ CozeBootstrapResponseDto.java  ğŸ“Œ Response DTO
â”‚   â”‚   â””â”€â”€ exception/
â”‚   â”‚       â””â”€â”€ GlobalExceptionHandler.java        ğŸ“Œ 404 è™•ç†
â”‚   â””â”€â”€ resources/
â”‚       â””â”€â”€ application.yml                        ğŸ“Œ Coze é…ç½®
```

**é—œéµç«¯é»**ï¼š
- `GET /api/support/coze/bootstrap` - æä¾›å‰ç«¯åˆå§‹åŒ–æ‰€éœ€é…ç½®

---

### Frontendï¼ˆå‰ç«¯ï¼‰
```
frontend/
â”œâ”€â”€ .env                                           ğŸ“Œ SDK ä¾†æº fallback
â”œâ”€â”€ vite.config.js                                ğŸ“Œ Proxy é…ç½®
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ http.js                               ğŸ“Œ Axios baseURL: '/api'
â”‚   â”‚   â””â”€â”€ modules/
â”‚   â”‚       â””â”€â”€ support.js                        ğŸ“Œ Bootstrap API å‘¼å«
â”‚   â”œâ”€â”€ data/
â”‚   â”‚   â””â”€â”€ supportFaq.js                         ğŸ“Œ FAQ è³‡æ–™ï¼ˆ14 é …ï¼‰
â”‚   â”œâ”€â”€ views/
â”‚   â”‚   â””â”€â”€ support/
â”‚   â”‚       â”œâ”€â”€ SupportCenterView.vue             ğŸ“Œ FAQ + Coze åˆå§‹åŒ–
â”‚   â”‚       â””â”€â”€ SupportReportView.vue             ğŸ“Œ å•é¡Œå›å ±è¡¨å–®
â”‚   â”œâ”€â”€ layouts/
â”‚   â”‚   â””â”€â”€ MainLayout.vue                        ğŸ“Œ å®¢æœå…¥å£ï¼ˆå´é‚Šæ¬„ï¼‰
â”‚   â””â”€â”€ router/
â”‚       â””â”€â”€ index.js                              ğŸ“Œ /support, /support/report
â””â”€â”€ docs/
    â”œâ”€â”€ COZE_SETUP.md                             ğŸ“Œ å®Œæ•´è¨­å®šæŒ‡å—
    â”œâ”€â”€ COZE_TESTING_GUIDE.md                     ğŸ“Œ æ¸¬è©¦æŒ‡å—
    â””â”€â”€ COZE_TROUBLESHOOTING.md                   ğŸ“Œ ç–‘é›£æ’è§£
```

**é—œéµé é¢**ï¼š
- `/support` - å®¢æœæ”¯æ´ä¸­å¿ƒï¼ˆFAQ + Coze æ³¡æ³¡ï¼‰
- `/support/report` - å•é¡Œå›å ±è¡¨å–®

---

## ğŸ”‘ ç’°å¢ƒè®Šæ•¸èªªæ˜

| è®Šæ•¸åç¨± | å¿…å¡« | èªªæ˜ | å–å¾—æ–¹å¼ |
|---------|------|------|---------|
| `COZE_BOT_ID` | âœ… å¿…å¡« | Coze Bot çš„å”¯ä¸€è­˜åˆ¥ç¢¼ | [Coze å¹³å°](https://www.coze.com/) â†’ Bot è¨­å®š |
| `COZE_PAT` | âœ… å¿…å¡« | Personal Access Token | Coze å¹³å° â†’ Personal Settings â†’ Access Tokens |
| `COZE_CHAT_SDK_SRC` | âš ï¸ é¸å¡« | Web Chat SDK ä¾†æº URL | é è¨­ä½¿ç”¨å®˜æ–¹ CDNï¼Œé€šå¸¸ä¸éœ€æ›´æ”¹ |

**é‡è¦æé†’**ï¼š
- âš ï¸ PAT Token åªèƒ½åœ¨å»ºç«‹æ™‚çœ‹åˆ°ä¸€æ¬¡ï¼Œè«‹å¦¥å–„ä¿å­˜
- âš ï¸ Token æœ‰éæœŸæ™‚é–“ï¼ŒéæœŸå¾Œéœ€é‡æ–°å»ºç«‹
- âš ï¸ ä¸è¦å°‡ Token æäº¤åˆ°ç‰ˆæ§ç³»çµ±ï¼ˆå·²åŠ å…¥ .gitignoreï¼‰

---

## ğŸ¯ åŠŸèƒ½ç‰¹è‰²

### 1. FAQ ç³»çµ±
- âœ… 14 å€‹å¸¸è¦‹å•é¡Œï¼ˆ4 å¤§åˆ†é¡ï¼‰
- âœ… é—œéµå­—æœå°‹ï¼ˆæ¨™é¡Œã€å…§å®¹ã€æ¨™ç±¤ï¼‰
- âœ… åˆ†é¡ç¯©é¸
- âœ… æ‰‹é¢¨ç´å±•é–‹/æ”¶åˆ
- âœ… éŸ¿æ‡‰å¼è¨­è¨ˆ

### 2. Coze AI å®¢æœ
- âœ… æ™ºèƒ½èŠå¤©æ³¡æ³¡ï¼ˆå³ä¸‹è§’ï¼‰
- âœ… è‡ªå‹•åˆå§‹åŒ–ï¼ˆé é¢è¼‰å…¥å¾Œ 1 ç§’ï¼‰
- âœ… æœƒå“¡ ID è¾¨è­˜ï¼ˆmember_{memId} / åŒ¿åè¨ªå®¢ï¼‰
- âœ… Token è‡ªå‹•åˆ·æ–°æ©Ÿåˆ¶
- âœ… éŒ¯èª¤è™•ç†ï¼ˆä¸å½±éŸ¿ FAQ åŠŸèƒ½ï¼‰
- âœ… é˜²æ­¢é‡è¤‡åˆå§‹åŒ–

### 3. å•é¡Œå›å ±
- âœ… çµæ§‹åŒ–è¡¨å–®ï¼ˆå•é¡Œé¡å‹ã€æè¿°ã€åœ–ç‰‡ä¸Šå‚³ï¼‰
- âœ… åœ–ç‰‡é è¦½èˆ‡åˆªé™¤
- âœ… è¡¨å–®é©—è­‰
- âœ… å®Œå–„çš„éŒ¯èª¤è™•ç†

---

## ğŸ”„ è³‡æ–™æµç¨‹

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ¶ç€è¦½å™¨
    participant Frontend as Frontend (Vue 3)
    participant Vite as Vite Proxy
    participant Backend as Backend (Spring Boot)
    participant Coze as Coze Platform

    User->>Frontend: è¨ªå• /support
    Frontend->>Frontend: è¼‰å…¥ FAQ ç³»çµ±
    Frontend->>Frontend: å»¶é² 1 ç§’å¾Œåˆå§‹åŒ– Coze
    
    Frontend->>Vite: GET /api/support/coze/bootstrap
    Vite->>Backend: GET /api/support/coze/bootstrap
    Backend->>Backend: é©—è­‰ç’°å¢ƒè®Šæ•¸ (botId, pat)
    Backend->>Frontend: å›å‚³é…ç½® (botId, token, sdkSrc)
    
    Frontend->>Frontend: å‹•æ…‹è¼‰å…¥ Coze SDK Script
    Frontend->>Frontend: å»ºç«‹ WebChatClient å¯¦ä¾‹
    Frontend->>User: é¡¯ç¤ºèŠå¤©æ³¡æ³¡ âœ…
    
    User->>Frontend: é»æ“Šæ³¡æ³¡é–‹å•ŸèŠå¤©
    Frontend->>Coze: å‚³é€ä½¿ç”¨è€…è¨Šæ¯
    Coze->>Frontend: å›å‚³ AI å›æ‡‰
    Frontend->>User: é¡¯ç¤º AI å›æ‡‰
```

---

## ğŸ› ï¸ å¸¸ç”¨æŒ‡ä»¤

### å¿«é€Ÿè¨ºæ–·
```powershell
# æª¢æŸ¥æ‰€æœ‰é…ç½®
.\diagnose-coze.ps1
```

### å¿«é€Ÿè¨­å®š
```powershell
# è¨­å®šç’°å¢ƒè®Šæ•¸ï¼ˆäº’å‹•å¼ï¼‰
.\setup-coze.ps1

# è¨­å®šç’°å¢ƒè®Šæ•¸ï¼ˆå‘½ä»¤åˆ—åƒæ•¸ï¼‰
.\setup-coze.ps1 -BotId "ä½ çš„Bot ID" -Pat "ä½ çš„PAT Token"
```

### å•Ÿå‹•æœå‹™
```bash
# å¾Œç«¯
cd backend && mvn spring-boot:run

# å‰ç«¯
cd frontend && npm run dev
```

### æ¸¬è©¦ API
```bash
# æ¸¬è©¦ Bootstrap API
curl http://localhost:8080/api/support/coze/bootstrap
```

---

## ğŸ“Š æª¢æŸ¥æ¸…å–®

### é¦–æ¬¡è¨­å®š
- [ ] å·²å–å¾— Coze Bot ID
- [ ] å·²å–å¾— Coze PAT Token
- [ ] å·²è¨­å®šç’°å¢ƒè®Šæ•¸ï¼ˆ`setup-coze.ps1` æˆ–æ‰‹å‹•ï¼‰
- [ ] å¾Œç«¯å•Ÿå‹•ç„¡éŒ¯èª¤
- [ ] å‰ç«¯å•Ÿå‹•ç„¡éŒ¯èª¤
- [ ] Bootstrap API å›å‚³ 200 OK
- [ ] `/support` é é¢é¡¯ç¤º FAQ
- [ ] Coze æ³¡æ³¡å‡ºç¾åœ¨å³ä¸‹è§’

### æ—¥å¸¸ç¶­è­·
- [ ] å®šæœŸæª¢æŸ¥ Token æ˜¯å¦éæœŸ
- [ ] ç›£æ§ Bootstrap API å‘¼å«é »ç‡
- [ ] æª¢æŸ¥ä½¿ç”¨è€…å›é¥‹
- [ ] æ›´æ–° FAQ å…§å®¹

### ç–‘é›£æ’è§£
- [ ] åŸ·è¡Œè¨ºæ–·è…³æœ¬ï¼š`.\diagnose-coze.ps1`
- [ ] æª¢æŸ¥ Chrome DevTools Console
- [ ] æª¢æŸ¥ Chrome DevTools Network Tab
- [ ] æª¢æŸ¥å¾Œç«¯ log
- [ ] åƒè€ƒ [COZE_TROUBLESHOOTING.md](COZE_TROUBLESHOOTING.md)

---

## ğŸ”’ å®‰å…¨æ€§

### å¾Œç«¯ä¿è­·
- âœ… æ•æ„Ÿè³‡è¨Šä¾†è‡ªç’°å¢ƒè®Šæ•¸ï¼ˆä¸å¯«æ­»åœ¨ç¨‹å¼ç¢¼ï¼‰
- âœ… Token ä¸åœ¨ log å°å‡ºå®Œæ•´å…§å®¹
- âœ… DTO çš„ `toString()` è‡ªå‹•é®è”½ Token
- âœ… ç¼ºå°‘é…ç½®æ™‚å›å‚³æ˜ç¢ºéŒ¯èª¤è¨Šæ¯

### å‰ç«¯ä¿è­·
- âœ… Token ä¸åœ¨ Console å°å‡º
- âœ… éŒ¯èª¤è™•ç†ä¸æ´©æ¼æ•æ„Ÿè³‡è¨Š
- âœ… åŒ¿åè¨ªå®¢ä½¿ç”¨ UUIDï¼ˆä¸é‡è¤‡ï¼‰
- âœ… æœƒå“¡ä½¿ç”¨ `member_{memId}`ï¼ˆè¾¨è­˜åº¦é«˜ï¼‰

---

## ğŸ“ æ”¯æ´è³‡æº

### å®˜æ–¹æ–‡ä»¶
- [Coze å¹³å°](https://www.coze.com/)
- [Coze Web Chat SDK æ–‡ä»¶](https://www.coze.com/docs/developer_guides/web_chat_sdk)

### å°ˆæ¡ˆæ–‡ä»¶
- [å®Œæ•´è¨­å®šæŒ‡å—](COZE_SETUP.md)
- [æ¸¬è©¦æŒ‡å—](COZE_TESTING_GUIDE.md)
- [ç–‘é›£æ’è§£](COZE_TROUBLESHOOTING.md)

### è¯çµ¡è³‡è¨Š
- é–‹ç™¼åœ˜éšŠï¼šTake@Seat é–‹ç™¼åœ˜éšŠ
- æœ€å¾Œæ›´æ–°ï¼š2026-01-31

---

## ğŸ“ æ›´æ–°æ—¥èªŒ

### 2026-01-31
- âœ… å®Œæˆ Coze Web Chat SDK æ•´åˆ
- âœ… å¯¦ä½œ FAQ ç³»çµ±ï¼ˆ14 å€‹å•é¡Œï¼Œ4 å¤§åˆ†é¡ï¼‰
- âœ… å¯¦ä½œå•é¡Œå›å ±è¡¨å–®
- âœ… å»ºç«‹å®Œæ•´æ¸¬è©¦èˆ‡è¨ºæ–·å·¥å…·
- âœ… æ–°å¢ MainLayout å®¢æœå…¥å£

---

**ç¶­è­·è€…**ï¼šTake@Seat é–‹ç™¼åœ˜éšŠ  
**æœ€å¾Œæ›´æ–°**ï¼š2026-01-31
</file>

<file path="backend/docs/COZE_SDK_SETUP.md">
# Coze SDK è¨­å®šæŒ‡å—

## å•é¡ŒèƒŒæ™¯

`@coze/chat-sdk` npm å¥—ä»¶å…§å« Taro è·¨å¹³å°ç¨‹å¼ç¢¼ï¼ˆ`dist/lib-source`ï¼‰ï¼Œå°è‡´ Vite é æ‰“åŒ…æ™‚å˜—è©¦è§£æ `@tarojs/*` ä¾è³´è€Œå¤±æ•—ï¼š

```
Could not resolve "@tarojs/components"
504 Outdated Optimize Dep
NS_ERROR_CORRUPTED_CONTENT
```

## è§£æ±ºæ–¹æ¡ˆï¼šé›™æ¨¡å¼è¼‰å…¥

æœ¬å°ˆæ¡ˆå¯¦ä½œäº† npm + script loader é›™æ¨¡å¼è¼‰å…¥æ©Ÿåˆ¶ï¼Œé€éç’°å¢ƒè®Šæ•¸ `VITE_COZE_SDK_MODE` æ§åˆ¶ã€‚

### æ¨¡å¼èªªæ˜

| æ¨¡å¼ | èªªæ˜ | é©ç”¨å ´æ™¯ |
|------|------|----------|
| `auto` | å…ˆå˜—è©¦ npm importï¼Œå¤±æ•—å‰‡ fallback script | **æ¨è–¦**ï¼Œå…¼é¡§æ€§èƒ½èˆ‡ç©©å®šæ€§ |
| `npm` | å¼·åˆ¶ npm import | åƒ…æ¸¬è©¦ç”¨ï¼Œå¯èƒ½å¤±æ•— |
| `script` | å¼·åˆ¶ script loader | æœ€ç©©å®šï¼Œé©åˆç”Ÿç”¢ç’°å¢ƒ |

### ç’°å¢ƒè®Šæ•¸é…ç½®

åœ¨ `frontend/.env` ä¸­ï¼š

```env
# SDK è¼‰å…¥æ¨¡å¼
VITE_COZE_SDK_MODE="auto"

# Script loader ä¾†æºï¼ˆæœ¬åœ°æˆ– CDNï¼‰
VITE_COZE_CHAT_SDK_SRC="/vendor/coze/index.js"
```

## è¨­å®šæ­¥é©Ÿ

### 1. Vite é…ç½®ï¼ˆå·²å®Œæˆï¼‰

`frontend/vite.config.js` å·²è¨­å®šæ’é™¤é æ‰“åŒ…ï¼š

```js
optimizeDeps: {
  exclude: ['@coze/chat-sdk']
}
```

### 2. æœ¬åœ° SDK è¨—ç®¡ï¼ˆå¯é¸ï¼‰

è‹¥ä½¿ç”¨ script æ¨¡å¼ï¼Œå»ºè­°æœ¬åœ°è¨—ç®¡ SDK ä»¥é¿å… CDN å•é¡Œï¼š

```bash
cd backend/src/main/resources/static/vendor/coze

# ä¸‹è¼‰ SDK
curl -o index.js "https://lf-cdn.coze.com/obj/unpkg/flow-platform/chat-app-sdk/1.0.0-beta.4/index.js"
```

### 3. é©—è­‰

1. å•Ÿå‹•å¾Œç«¯ï¼š`cd backend && mvn spring-boot:run`
2. å•Ÿå‹•å‰ç«¯ï¼š`cd frontend && npm run dev`
3. è¨ªå•å®¢æœä¸­å¿ƒé é¢
4. é–‹å•Ÿç€è¦½å™¨ Consoleï¼ŒæŸ¥çœ‹ `[Coze]` æ—¥èªŒï¼š
   - `SDK è¼‰å…¥æ¨¡å¼: auto`
   - `npm import æˆåŠŸ âœ…` æˆ– `script loader æˆåŠŸ âœ…`

## æ•…éšœæ’é™¤

### å•é¡Œï¼šnpm import æŒçºŒå¤±æ•—

**åŸå› **ï¼šVite å¿«å–æœªæ¸…é™¤

**è§£æ±º**ï¼š
```bash
cd frontend
rm -rf node_modules/.vite
npm run dev
```

### å•é¡Œï¼šscript loader 404

**åŸå› **ï¼šæœ¬åœ° SDK æª”æ¡ˆä¸å­˜åœ¨

**è§£æ±º**ï¼š
1. ç¢ºèª `backend/src/main/resources/static/vendor/coze/index.js` å­˜åœ¨
2. æˆ–æ”¹ç”¨ CDNï¼š`VITE_COZE_CHAT_SDK_SRC="https://lf-cdn.coze.com/obj/unpkg/flow-platform/chat-app-sdk/1.0.0-beta.4/index.js"`

### å•é¡Œï¼š502 Bad Gateway / TLB

**åŸå› **ï¼šCoze API ç«¯é»å•é¡Œï¼ˆé SDK è¼‰å…¥å•é¡Œï¼‰

**è§£æ±º**ï¼š
1. æª¢æŸ¥ `coze.api.host` è¨­å®š
2. ç¢ºèªç¶²è·¯èƒ½é€£ç·šåˆ° `api.coze.com`
3. ä½¿ç”¨è¨ºæ–·è…³æœ¬ï¼š`powershell -ExecutionPolicy Bypass -File backend/docs/diagnose-coze.ps1`

## ç›¸é—œæª”æ¡ˆ

- [useCozeChat.js](../frontend/src/composables/useCozeChat.js) - SDK è¼‰å…¥é‚è¼¯
- [vite.config.js](../frontend/vite.config.js) - Vite é…ç½®
- [.env](../frontend/.env) - ç’°å¢ƒè®Šæ•¸
- [SupportCenterView.vue](../frontend/src/views/support/SupportCenterView.vue) - å‰ç«¯é é¢
</file>

<file path="backend/docs/COZE_TESTING_GUIDE.md">
# Coze Web Chat SDK å®Œæ•´æ¸¬è©¦æŒ‡å—

## ğŸ“¦ ç³»çµ±æ¶æ§‹ç¸½è¦½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç”¨æˆ¶ç€è¦½å™¨ (http://localhost:5173)             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  SupportCenterView.vue                                      â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚ FAQ ç³»çµ±      â”‚        â”‚ Coze Web Chat SDK            â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - æœå°‹        â”‚        â”‚ 1. initCozeChat()            â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - åˆ†é¡ç¯©é¸    â”‚        â”‚ 2. getCozeBootstrap()        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - æ‰‹é¢¨ç´å±•é–‹  â”‚        â”‚ 3. loadCozeSDK()             â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚ 4. new WebChatClient()       â”‚ â”‚ â”‚
â”‚  â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                    â”‚                              â”‚
â”‚                          supportApi.getCozeBootstrap()           â”‚
â”‚                                    â–¼                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                    GET /api/support/coze/bootstrap
                                     â”‚
                    (é€é Vite Proxy è½‰ç™¼)
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          å¾Œç«¯ Spring Boot (http://localhost:8080)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  SupportCozeController.java                                 â”‚ â”‚
â”‚  â”‚  GET /api/support/coze/bootstrap                            â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚ 1. é©—è­‰ç’°å¢ƒè®Šæ•¸ï¼ˆbotId, patï¼‰                            â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ 2. å›å‚³ CozeBootstrapResponseDto                        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    - botId                                              â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    - token (PAT)                                        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    - sdkSrc                                             â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    - expiresIn                                          â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    - serverTime                                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    - note                                               â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                    â”‚                              â”‚
â”‚                    è®€å– application.yml é…ç½®                      â”‚
â”‚                                    â–¼                              â”‚
â”‚                   ${COZE_BOT_ID}, ${COZE_PAT}                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ å®Œæ•´é…ç½®æª¢æŸ¥æ¸…å–®

### âœ… Backendï¼ˆå¾Œç«¯ï¼‰é…ç½®

#### 1. ç’°å¢ƒè®Šæ•¸è¨­å®šï¼ˆå¿…é ˆï¼‰
```powershell
# Windows PowerShell
$env:COZE_BOT_ID="ä½ çš„Bot ID"
$env:COZE_PAT="ä½ çš„Personal Access Token"
$env:COZE_CHAT_SDK_SRC="https://lf-cdn.coze.cn/obj/unpkg/flow-platform/chat-app-sdk/1.0.0-beta.4/libs/oversea/index.js"
```

é©—è­‰ï¼š
```powershell
echo $env:COZE_BOT_ID
echo $env:COZE_PAT
echo $env:COZE_CHAT_SDK_SRC
```

#### 2. application.yml é…ç½®
æª”æ¡ˆä½ç½®ï¼š`backend/src/main/resources/application.yml`

```yaml
coze:
  bot-id: ${COZE_BOT_ID:}
  pat: ${COZE_PAT:}
  chat-sdk-src: ${COZE_CHAT_SDK_SRC:}
```

#### 3. å¾Œç«¯æª”æ¡ˆæ¸…å–®
```
backend/src/main/java/com/example/backend/
â”œâ”€â”€ controller/
â”‚   â””â”€â”€ support/
â”‚       â””â”€â”€ SupportCozeController.java        âœ… GET /api/support/coze/bootstrap
â”œâ”€â”€ dto/
â”‚   â””â”€â”€ support/
â”‚       â””â”€â”€ CozeBootstrapResponseDto.java    âœ… Response DTO
â””â”€â”€ exception/
    â””â”€â”€ GlobalExceptionHandler.java          âœ… 404 è™•ç†
```

#### 4. æ¸¬è©¦å¾Œç«¯ API
```bash
# å•Ÿå‹•å¾Œç«¯
cd backend
mvn spring-boot:run

# åœ¨æ–°çµ‚ç«¯æ©Ÿæ¸¬è©¦
curl http://localhost:8080/api/support/coze/bootstrap
```

âœ… **é æœŸå›æ‡‰**ï¼ˆ200 OKï¼‰ï¼š
```json
{
  "botId": "7469370888888888888",
  "token": "pat_xxxxxxxxxxxx",
  "sdkSrc": "https://lf-cdn.coze.cn/obj/unpkg/flow-platform/chat-app-sdk/1.0.0-beta.4/libs/oversea/index.js",
  "expiresIn": 0,
  "serverTime": "2026-01-31T12:00:00",
  "note": "âš ï¸ PAT Token æé†’ï¼šæ­¤ Token æœ‰éæœŸæ™‚é–“ï¼ŒéæœŸå¾Œéœ€è¦é‡æ–°å»ºç«‹"
}
```

---

### âœ… Frontendï¼ˆå‰ç«¯ï¼‰é…ç½®

#### 1. å‰ç«¯æª”æ¡ˆæ¸…å–®
```
frontend/
â”œâ”€â”€ .env                                       âœ… VITE_COZE_CHAT_SDK_SRC fallback
â”œâ”€â”€ vite.config.js                            âœ… Proxy é…ç½®
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ http.js                           âœ… baseURL: '/api'
â”‚   â”‚   â””â”€â”€ modules/
â”‚   â”‚       â””â”€â”€ support.js                    âœ… getCozeBootstrap()
â”‚   â”œâ”€â”€ data/
â”‚   â”‚   â””â”€â”€ supportFaq.js                     âœ… FAQ è³‡æ–™ï¼ˆ14 é …ï¼‰
â”‚   â”œâ”€â”€ views/
â”‚   â”‚   â””â”€â”€ support/
â”‚   â”‚       â”œâ”€â”€ SupportCenterView.vue         âœ… FAQ + Coze åˆå§‹åŒ–
â”‚   â”‚       â””â”€â”€ SupportReportView.vue         âœ… å•é¡Œå›å ±è¡¨å–®
â”‚   â”œâ”€â”€ layouts/
â”‚   â”‚   â””â”€â”€ MainLayout.vue                    âœ… å®¢æœå…¥å£é€£çµ
â”‚   â””â”€â”€ router/
â”‚       â””â”€â”€ index.js                          âœ… /support, /support/report è·¯ç”±
```

#### 2. http.js é…ç½®ï¼ˆé‡è¦ï¼‰
æª”æ¡ˆï¼š`frontend/src/api/http.js`

```javascript
const http = axios.create({
  baseURL: '/api', // âœ… å¿…é ˆæ˜¯ '/api'
  timeout: 10000,
})
```

#### 3. support.js è·¯å¾‘ï¼ˆé‡è¦ï¼‰
æª”æ¡ˆï¼š`frontend/src/api/modules/support.js`

```javascript
export const getCozeBootstrap = () => {
  return http.get('/support/coze/bootstrap') // âœ… ä¸åŠ  /api å‰ç¶´
}
```

**è·¯å¾‘æ‹¼æ¥é‚è¼¯**ï¼š
```
baseURL: '/api' + '/support/coze/bootstrap'
= '/api/support/coze/bootstrap'
â†’ Vite Proxy è½‰ç™¼
â†’ http://localhost:8080/api/support/coze/bootstrap
```

#### 4. vite.config.js Proxy é…ç½®
æª”æ¡ˆï¼š`frontend/vite.config.js`

```javascript
export default defineConfig({
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:8080',
        changeOrigin: true,
        // âœ… ä¸éœ€è¦ rewriteï¼Œç›´æ¥è½‰ç™¼
      },
    },
  },
})
```

#### 5. .env ç’°å¢ƒè®Šæ•¸ï¼ˆFallbackï¼‰
æª”æ¡ˆï¼š`frontend/.env`

```env
VITE_COZE_CHAT_SDK_SRC=https://lf-cdn.coze.cn/obj/unpkg/flow-platform/chat-app-sdk/1.0.0-beta.4/libs/oversea/index.js
```

---

## ğŸ§ª å®Œæ•´æ¸¬è©¦æµç¨‹

### Step 1ï¼šå•Ÿå‹•å¾Œç«¯
```bash
cd backend

# è¨­å®šç’°å¢ƒè®Šæ•¸ï¼ˆWindows PowerShellï¼‰
$env:COZE_BOT_ID="ä½ çš„Bot ID"
$env:COZE_PAT="ä½ çš„Personal Access Token"
$env:COZE_CHAT_SDK_SRC="https://lf-cdn.coze.cn/obj/unpkg/flow-platform/chat-app-sdk/1.0.0-beta.4/libs/oversea/index.js"

# å•Ÿå‹•å¾Œç«¯
mvn spring-boot:run
```

**âœ… é æœŸè¼¸å‡º**ï¼š
```
2026-01-31 12:00:00.000  INFO 12345 --- [  restartedMain] c.e.b.BackendApplication: Started BackendApplication in 5.123 seconds
```

**âŒ å¸¸è¦‹éŒ¯èª¤**ï¼š
```
âŒ Coze Bot ID æœªè¨­å®šï¼è«‹åœ¨ application.yml è¨­å®š coze.bot-id æˆ–ç’°å¢ƒè®Šæ•¸ COZE_BOT_ID
```
â†’ è§£æ±ºï¼šç¢ºèªç’°å¢ƒè®Šæ•¸å·²è¨­å®š

---

### Step 2ï¼šæ¸¬è©¦å¾Œç«¯ API
```bash
# åœ¨æ–°çµ‚ç«¯æ©ŸåŸ·è¡Œ
curl http://localhost:8080/api/support/coze/bootstrap
```

**âœ… é æœŸå›æ‡‰**ï¼ˆ200 OKï¼‰ï¼š
```json
{
  "botId": "7469370888888888888",
  "token": "pat_xxxxxxxxxxxx",
  "sdkSrc": "https://...",
  "expiresIn": 0,
  "serverTime": "2026-01-31T12:00:00",
  "note": "âš ï¸ PAT Token æé†’ï¼šæ­¤ Token æœ‰éæœŸæ™‚é–“ï¼ŒéæœŸå¾Œéœ€è¦é‡æ–°å»ºç«‹"
}
```

**âŒ å¸¸è¦‹éŒ¯èª¤**ï¼š
- **404 Not Found** â†’ Controller è·¯å¾‘éŒ¯èª¤æˆ–æœªå•Ÿå‹•
- **500 Internal Server Error** â†’ ç’°å¢ƒè®Šæ•¸æœªè¨­å®š
- **Connection Refused** â†’ å¾Œç«¯æœªå•Ÿå‹•

---

### Step 3ï¼šå•Ÿå‹•å‰ç«¯
```bash
cd frontend
npm run dev
```

**âœ… é æœŸè¼¸å‡º**ï¼š
```
VITE v5.x.x  ready in 500 ms

  âœ  Local:   http://localhost:5173/
  âœ  Network: use --host to expose
  âœ  press h + enter to show help
```

---

### Step 4ï¼šç€è¦½å™¨æ¸¬è©¦

#### 4.1 é–‹å•Ÿç€è¦½å™¨
å‰å¾€ï¼š`http://localhost:5173/support`

#### 4.2 é–‹å•Ÿ Chrome DevToolsï¼ˆF12ï¼‰

**Console Tab æª¢æŸ¥**ï¼š

âœ… **æˆåŠŸåˆå§‹åŒ–**ï¼š
```
[Coze] é–‹å§‹è¼‰å…¥ Bootstrap é…ç½®...
[Coze] Bootstrap é…ç½®è¼‰å…¥æˆåŠŸ { botId: "7469370888888888888", sdkSrc: "https://...", expiresIn: 0 }
[Coze] ä½¿ç”¨ SDK ä¾†æº: https://lf-cdn.coze.cn/obj/unpkg/flow-platform/chat-app-sdk/1.0.0-beta.4/libs/oversea/index.js
[Coze] SDK è¼‰å…¥æˆåŠŸ
[Coze] ä½¿ç”¨è€… ID: member_123 æˆ– [åŒ¿åè¨ªå®¢]
[Coze] åˆå§‹åŒ–å®Œæˆ âœ…
```

âŒ **å¸¸è¦‹éŒ¯èª¤**ï¼š

| éŒ¯èª¤è¨Šæ¯ | åŸå›  | è§£æ±ºæ–¹å¼ |
|---------|------|---------|
| `GET http://localhost:5173/api/api/support/coze/bootstrap 404` | è·¯å¾‘é‡è¤‡ï¼ˆapi/apiï¼‰ | ç¢ºèª `support.js` è·¯å¾‘ç‚º `/support/...` |
| `[Coze] Bootstrap é…ç½®ä¸å®Œæ•´ï¼ˆç¼ºå°‘ botId æˆ– tokenï¼‰` | å¾Œç«¯ç’°å¢ƒè®Šæ•¸æœªè¨­å®š | æª¢æŸ¥ `$env:COZE_BOT_ID` å’Œ `$env:COZE_PAT` |
| `Coze SDK è¼‰å…¥å¤±æ•—` | SDK ä¾†æº URL éŒ¯èª¤ | æª¢æŸ¥ `COZE_CHAT_SDK_SRC` |
| `Access to XMLHttpRequest blocked by CORS` | CORS æœªé…ç½® | æª¢æŸ¥ `SecurityConfig.java` |

**Network Tab æª¢æŸ¥**ï¼š

âœ… **æˆåŠŸè«‹æ±‚**ï¼š
- **Request URL**: `http://localhost:5173/api/support/coze/bootstrap`
- **Request Method**: `GET`
- **Status Code**: `200 OK`
- **Response**: åŒ…å« `botId`, `token`, `sdkSrc`

âŒ **å¤±æ•—è«‹æ±‚**ï¼š
- **404 Not Found** â†’ å¾Œç«¯ Controller è·¯å¾‘éŒ¯èª¤
- **500 Internal Server Error** â†’ å¾Œç«¯ç’°å¢ƒè®Šæ•¸æœªè¨­å®š
- **CORS Error** â†’ CORS æœªæ­£ç¢ºé…ç½®

---

### Step 5ï¼šè¦–è¦ºé©—è­‰

#### 5.1 FAQ ç³»çµ±
- [ ] æœå°‹æ¡†å¯è¼¸å…¥é—œéµå­—
- [ ] åˆ†é¡åˆ‡æ›ï¼ˆæœƒå“¡ç›¸é—œã€å ´åœ°ç›¸é—œã€è¨‚ä½ç›¸é—œã€å…¶ä»–å•é¡Œï¼‰
- [ ] æ‰‹é¢¨ç´å±•é–‹/æ”¶åˆ
- [ ] é—œéµå­—é«˜äº®é¡¯ç¤º
- [ ] é¡¯ç¤ºç¸½ FAQ æ•¸é‡ï¼ˆ14 å€‹å•é¡Œï¼‰

#### 5.2 Coze èŠå¤©æ³¡æ³¡
- [ ] é é¢å³ä¸‹è§’å‡ºç¾åœ“å½¢æ³¡æ³¡åœ–ç¤º
- [ ] é»æ“Šæ³¡æ³¡é–‹å•ŸèŠå¤©è¦–çª—
- [ ] èŠå¤©è¦–çª—æ¨™é¡Œé¡¯ç¤ºã€ŒTake@Seat æ™ºèƒ½å®¢æœã€
- [ ] å¯è¼¸å…¥è¨Šæ¯ä¸¦æ”¶åˆ°å›æ‡‰
- [ ] é—œé–‰å¾Œæ³¡æ³¡ä»å­˜åœ¨

#### 5.3 MainLayout å…¥å£
- [ ] å´é‚Šæ¬„æœ‰ã€Œå®¢æœæ”¯æ´ã€é¸é …ï¼ˆé›»è©±åœ–ç¤ºï¼‰
- [ ] é»æ“Šå¾Œæ­£ç¢ºå°èˆªè‡³ `/support`

---

## ğŸ› ç–‘é›£æ’è§£

### å•é¡Œ 1ï¼šè·¯å¾‘è®Šæˆ `/api/api/support/...`

**åŸå› **ï¼š`support.js` çš„è·¯å¾‘å¯«æˆ `/api/support/...`

**è§£æ±ºæ–¹å¼**ï¼š
```javascript
// âŒ éŒ¯èª¤
return http.get('/api/support/coze/bootstrap')

// âœ… æ­£ç¢º
return http.get('/support/coze/bootstrap')
```

---

### å•é¡Œ 2ï¼šæ³¡æ³¡æ²’æœ‰å‡ºç¾

**è¨ºæ–·æ­¥é©Ÿ**ï¼š
1. æª¢æŸ¥ Console æ˜¯å¦é¡¯ç¤º `[Coze] åˆå§‹åŒ–å®Œæˆ âœ…`
2. åœ¨ Console åŸ·è¡Œï¼š`window.__cozeClient`ï¼ˆæ‡‰è©²æœ‰å€¼ï¼‰
3. åœ¨ Console åŸ·è¡Œï¼š`window.CozeWebSDK`ï¼ˆæ‡‰è©²æœ‰å€¼ï¼‰
4. å˜—è©¦æ‰‹å‹•é–‹å•Ÿï¼š`window.__cozeClient.open()`

**å¯èƒ½åŸå› **ï¼š
- SDK ç‰ˆæœ¬ä¸ç›¸å®¹
- SDK ä¾†æº URL éŒ¯èª¤
- Bot ID æˆ– Token ç„¡æ•ˆ

---

### å•é¡Œ 3ï¼šToken éæœŸ

**ç—‡ç‹€**ï¼š
- Console é¡¯ç¤º `[Coze] Token å³å°‡éæœŸï¼Œè‡ªå‹•åˆ·æ–°...`
- èŠå¤©åŠŸèƒ½ç„¡æ³•ä½¿ç”¨

**è§£æ±ºæ–¹å¼**ï¼š
1. ç™»å…¥ Coze å¹³å°
2. é‡æ–°å»ºç«‹ Personal Access Token
3. æ›´æ–°ç’°å¢ƒè®Šæ•¸ï¼š`$env:COZE_PAT="æ–°çš„Token"`
4. é‡æ–°å•Ÿå‹•å¾Œç«¯

---

### å•é¡Œ 4ï¼šCORS éŒ¯èª¤

**ç—‡ç‹€**ï¼š
```
Access to XMLHttpRequest at 'http://localhost:8080/api/support/coze/bootstrap' 
from origin 'http://localhost:5173' has been blocked by CORS policy
```

**è§£æ±ºæ–¹å¼**ï¼š
ç¢ºèª `SecurityConfig.java` æœ‰ä»¥ä¸‹é…ç½®ï¼š
```java
@Bean
public CorsConfigurationSource corsConfigurationSource() {
    CorsConfiguration configuration = new CorsConfiguration();
    configuration.addAllowedOrigin("http://localhost:5173");
    configuration.addAllowedMethod("*");
    configuration.addAllowedHeader("*");
    configuration.setAllowCredentials(true);
    
    UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
    source.registerCorsConfiguration("/**", configuration);
    return source;
}
```

---

## ğŸš€ å¿«é€Ÿè¨ºæ–·è…³æœ¬

åŸ·è¡Œè¨ºæ–·è…³æœ¬ï¼š
```powershell
.\diagnose-coze.ps1
```

é€™å€‹è…³æœ¬æœƒè‡ªå‹•æª¢æŸ¥ï¼š
- âœ… ç’°å¢ƒè®Šæ•¸è¨­å®š
- âœ… å¾Œç«¯ API ç‹€æ…‹
- âœ… å‰ç«¯é…ç½®æª”æ¡ˆ
- âœ… è·¯ç”±é…ç½®
- âœ… MainLayout å…¥å£

---

## ğŸ“Š æ¸¬è©¦å ±å‘Šç¯„ä¾‹

### âœ… æˆåŠŸæ¡ˆä¾‹

```
========================================
æ¸¬è©¦å ±å‘Š
========================================
æ¸¬è©¦æ™‚é–“ï¼š2026-01-31 12:00:00
æ¸¬è©¦äººå“¡ï¼šé–‹ç™¼è€…

ã€å¾Œç«¯æ¸¬è©¦ã€‘
âœ… ç’°å¢ƒè®Šæ•¸è¨­å®šæ­£ç¢º
âœ… Bootstrap API å›å‚³ 200 OK
âœ… å›æ‡‰åŒ…å«å®Œæ•´æ¬„ä½ï¼ˆbotId, token, sdkSrcï¼‰

ã€å‰ç«¯æ¸¬è©¦ã€‘
âœ… FAQ ç³»çµ±æ­£å¸¸é¡¯ç¤º
âœ… æœå°‹åŠŸèƒ½æ­£å¸¸
âœ… Bootstrap API å‘¼å«æˆåŠŸï¼ˆ200 OKï¼‰
âœ… Coze SDK è¼‰å…¥æˆåŠŸ
âœ… æ³¡æ³¡å‡ºç¾åœ¨å³ä¸‹è§’
âœ… å¯æ­£å¸¸å‚³é€è¨Šæ¯ä¸¦æ”¶åˆ°å›æ‡‰

ã€æ•´åˆæ¸¬è©¦ã€‘
âœ… MainLayout å®¢æœå…¥å£æ­£å¸¸
âœ… è·¯ç”±å°èˆªæ­£å¸¸
âœ… Token åˆ·æ–°æ©Ÿåˆ¶æ­£å¸¸
âœ… åŒ¿åè¨ªå®¢ ID æ­£å¸¸ç”¢ç”Ÿ
âœ… æœƒå“¡ç™»å…¥å¾Œ ID æ­£ç¢ºä½¿ç”¨ member_{memId}

ã€çµè«–ã€‘
âœ… Coze Web Chat SDK æ•´åˆæˆåŠŸ
```

---

## ğŸ“ ç¶­è­·å»ºè­°

### å®šæœŸæª¢æŸ¥
- [ ] æ¯ 90 å¤©æ›´æ› Coze PAT Token
- [ ] æ¯æœˆæª¢æŸ¥ Coze SDK ç‰ˆæœ¬æ›´æ–°
- [ ] æ¯é€±ç›£æ§ Bootstrap API å‘¼å«é »ç‡
- [ ] æ¯æ—¥æª¢æŸ¥å¾Œç«¯ log æ˜¯å¦æœ‰ç•°å¸¸

### ç›£æ§æŒ‡æ¨™
- Bootstrap API æˆåŠŸç‡ï¼ˆç›®æ¨™ï¼š>99%ï¼‰
- åˆå§‹åŒ–å¤±æ•—ç‡ï¼ˆç›®æ¨™ï¼š<1%ï¼‰
- Token åˆ·æ–°é »ç‡
- ä½¿ç”¨è€…æ»¿æ„åº¦ï¼ˆChat ä½¿ç”¨ç‡ï¼‰

### å‚™ä»½è¨ˆç•«
- [ ] å®šæœŸå‚™ä»½ FAQ è³‡æ–™
- [ ] ä¿ç•™èˆŠç‰ˆ PAT Tokenï¼ˆç›´åˆ°ç¢ºèªæ–° Token æ­£å¸¸ï¼‰
- [ ] è¨˜éŒ„ SDK ç‰ˆæœ¬è®Šæ›´æ­·å²

---

**æœ€å¾Œæ›´æ–°**ï¼š2026-01-31  
**ç¶­è­·è€…**ï¼šTake@Seat é–‹ç™¼åœ˜éšŠ
</file>

<file path="backend/docs/diagnose-coze.ps1">
# ==================== Coze Web Chat SDK è¨ºæ–·å·¥å…· v2.0 ====================
# ç”¨é€”ï¼šæª¢æŸ¥ç’°å¢ƒè®Šæ•¸ã€å¾Œç«¯æœå‹™ã€å‰ç«¯é…ç½®ã€ç¶²è·¯é€£é€šæ€§
# ç‰ˆæœ¬ï¼šv2.0ï¼ˆæ–°å¢ API é€£é€šæ€§èˆ‡ 502/TLB è¨ºæ–·ï¼‰

param(
    [switch]$Verbose,
    [switch]$SkipNetwork
)

Write-Host "========================================" -ForegroundColor Cyan
Write-Host "Coze Web Chat SDK è¨ºæ–·å·¥å…· v2.0" -ForegroundColor Cyan
Write-Host "========================================`n" -ForegroundColor Cyan

$errorCount = 0
$warningCount = 0

# ==================== 1. æª¢æŸ¥ç’°å¢ƒè®Šæ•¸ ====================
Write-Host "ã€1ã€‘æª¢æŸ¥ç’°å¢ƒè®Šæ•¸..." -ForegroundColor Yellow

if ($env:COZE_BOT_ID) {
    Write-Host "  âœ… COZE_BOT_ID: $env:COZE_BOT_ID" -ForegroundColor Green
} else {
    Write-Host "  âš ï¸  COZE_BOT_ID æœªè¨­å®šï¼ˆå°‡ä½¿ç”¨ application.yml é è¨­å€¼ï¼‰" -ForegroundColor Yellow
    $warningCount++
}

if ($env:COZE_PAT) {
    $maskedPat = $env:COZE_PAT.Substring(0, [Math]::Min(10, $env:COZE_PAT.Length)) + "..."
    Write-Host "  âœ… COZE_PAT: $maskedPat" -ForegroundColor Green
} else {
    Write-Host "  âš ï¸  COZE_PAT æœªè¨­å®šï¼ˆå°‡ä½¿ç”¨ application.yml é è¨­å€¼ï¼‰" -ForegroundColor Yellow
    $warningCount++
}

if ($env:COZE_CHAT_SDK_SRC) {
    Write-Host "  âœ… COZE_CHAT_SDK_SRC: $env:COZE_CHAT_SDK_SRC" -ForegroundColor Green
} else {
    Write-Host "  â„¹ï¸  COZE_CHAT_SDK_SRC æœªè¨­å®šï¼ˆå‰ç«¯å°‡ä½¿ç”¨ npm importï¼‰" -ForegroundColor Gray
}

# ==================== 2. æª¢æŸ¥å¾Œç«¯æœå‹™ ====================
Write-Host "`nã€2ã€‘æª¢æŸ¥å¾Œç«¯æœå‹™..." -ForegroundColor Yellow

try {
    $response = Invoke-WebRequest -Uri "http://localhost:8080/api/support/coze/bootstrap" -Method GET -TimeoutSec 5 -ErrorAction Stop
    if ($response.StatusCode -eq 200) {
        Write-Host "  âœ… Bootstrap API æ­£å¸¸é‹è¡Œ (200 OK)" -ForegroundColor Green
        
        $json = $response.Content | ConvertFrom-Json
        Write-Host "  â”œâ”€ botId: $($json.botId)" -ForegroundColor Gray
        Write-Host "  â”œâ”€ platformHint: $($json.platformHint)" -ForegroundColor Gray
        Write-Host "  â”œâ”€ apiHostHint: $($json.apiHostHint)" -ForegroundColor Gray
        Write-Host "  â””â”€ sdkMode: $($json.sdkMode)" -ForegroundColor Gray
    }
} catch {
    $statusCode = $null
    if ($_.Exception.Response) {
        $statusCode = [int]$_.Exception.Response.StatusCode
    }
    
    if ($statusCode -eq 400) {
        Write-Host "  âŒ Bootstrap API å›å‚³ 400 Bad Requestï¼ˆé…ç½®ä¸å®Œæ•´ï¼‰" -ForegroundColor Red
        $errorCount++
    } elseif ($statusCode -eq 404) {
        Write-Host "  âŒ Bootstrap API å›å‚³ 404 Not Foundï¼ˆController è·¯å¾‘éŒ¯èª¤ï¼‰" -ForegroundColor Red
        $errorCount++
    } else {
        Write-Host "  âŒ å¾Œç«¯æœå‹™ç„¡æ³•é€£æ¥" -ForegroundColor Red
        Write-Host "     éŒ¯èª¤: $($_.Exception.Message)" -ForegroundColor Red
        Write-Host "     è«‹ç¢ºèªå¾Œç«¯æ˜¯å¦å•Ÿå‹•: cd backend && mvn spring-boot:run" -ForegroundColor Yellow
        $errorCount++
    }
}

# ==================== 3. ç¶²è·¯é€£é€šæ€§æ¸¬è©¦ï¼ˆæ–°å¢ï¼‰ ====================
if (-not $SkipNetwork) {
    Write-Host "`nã€3ã€‘æª¢æŸ¥ Coze API é€£é€šæ€§..." -ForegroundColor Yellow
    
    $apiHosts = @("api.coze.com", "lf-cdn.coze.com", "lf-cdn.coze.cn")
    
    foreach ($h in $apiHosts) {
        Write-Host "  æ¸¬è©¦ $h..." -ForegroundColor Gray
        
        # DNS è§£ææ¸¬è©¦
        try {
            $dns = Resolve-DnsName -Name $h -ErrorAction Stop
            $ipAddr = ($dns | Where-Object { $_.Type -eq 'A' } | Select-Object -First 1).IPAddress
            if ($ipAddr) {
                Write-Host "    â”œâ”€ DNS: âœ… è§£ææˆåŠŸ ($ipAddr)" -ForegroundColor Green
            } else {
                Write-Host "    â”œâ”€ DNS: âœ… è§£ææˆåŠŸ (CNAME)" -ForegroundColor Green
            }
        } catch {
            Write-Host "    â”œâ”€ DNS: âŒ è§£æå¤±æ•—ï¼ˆNXDOMAIN æˆ–ç¶²è·¯å•é¡Œï¼‰" -ForegroundColor Red
            Write-Host "       æç¤ºï¼šå¯èƒ½è¢«å…¬å¸ç¶²è·¯/VPN æ“‹ä½ï¼Œå˜—è©¦æ‰‹æ©Ÿç†±é»" -ForegroundColor Yellow
            $warningCount++
            continue
        }
        
        # HTTPS é€£ç·šæ¸¬è©¦
        try {
            $tcpClient = New-Object System.Net.Sockets.TcpClient
            $asyncResult = $tcpClient.BeginConnect($h, 443, $null, $null)
            $waitHandle = $asyncResult.AsyncWaitHandle
            
            if ($waitHandle.WaitOne(3000, $false)) {
                $tcpClient.EndConnect($asyncResult)
                Write-Host "    â””â”€ TCP 443: âœ… å¯é€£ç·š" -ForegroundColor Green
            } else {
                Write-Host "    â””â”€ TCP 443: âš ï¸ é€£ç·šé€¾æ™‚" -ForegroundColor Yellow
                $warningCount++
            }
            $tcpClient.Close()
        } catch {
            Write-Host "    â””â”€ TCP 443: âŒ é€£ç·šå¤±æ•—" -ForegroundColor Red
            $warningCount++
        }
    }
} else {
    Write-Host "`nã€3ã€‘è·³éç¶²è·¯é€£é€šæ€§æ¸¬è©¦ï¼ˆä½¿ç”¨ -SkipNetwork åƒæ•¸ï¼‰" -ForegroundColor Gray
}

# ==================== 4. å‰ç«¯é…ç½®æª¢æŸ¥ ====================
Write-Host "`nã€4ã€‘æª¢æŸ¥å‰ç«¯é…ç½®..." -ForegroundColor Yellow

# æª¢æŸ¥ http.js
$httpJsPath = "frontend/src/api/http.js"
if (Test-Path $httpJsPath) {
    $httpJsContent = Get-Content $httpJsPath -Raw
    if ($httpJsContent -match "baseURL:\s*['""]\/api['""]") {
        Write-Host "  âœ… http.js baseURL é…ç½®æ­£ç¢º: '/api'" -ForegroundColor Green
    } else {
        Write-Host "  âŒ http.js baseURL é…ç½®éŒ¯èª¤" -ForegroundColor Red
        Write-Host "     æ‡‰è©²æ˜¯: baseURL: '/api'" -ForegroundColor Yellow
        $errorCount++
    }
} else {
    Write-Host "  âŒ æ‰¾ä¸åˆ° $httpJsPath" -ForegroundColor Red
    $errorCount++
}

# æª¢æŸ¥ support.js
$supportJsPath = "frontend/src/api/modules/support.js"
if (Test-Path $supportJsPath) {
    $supportJsContent = Get-Content $supportJsPath -Raw
    if ($supportJsContent -match "http\.get\(['""]\/support\/coze\/bootstrap['""]") {
        Write-Host "  âœ… support.js è·¯å¾‘é…ç½®æ­£ç¢º: '/support/coze/bootstrap'" -ForegroundColor Green
    } elseif ($supportJsContent -match "http\.get\(['""]\/api\/support\/coze\/bootstrap['""]") {
        Write-Host "  âŒ support.js è·¯å¾‘é…ç½®éŒ¯èª¤ï¼ˆä¸æ‡‰è©²æœ‰ /api å‰ç¶´ï¼‰" -ForegroundColor Red
        Write-Host "     æ‡‰è©²æ˜¯: http.get('/support/coze/bootstrap')" -ForegroundColor Yellow
        $errorCount++
    } else {
        Write-Host "  âŒ support.js è·¯å¾‘é…ç½®éŒ¯èª¤" -ForegroundColor Red
        $errorCount++
    }
} else {
    Write-Host "  âŒ æ‰¾ä¸åˆ° $supportJsPath" -ForegroundColor Red
    $errorCount++
}

# æª¢æŸ¥ useCozeChat composable
$composablePath = "frontend/src/composables/useCozeChat.js"
if (Test-Path $composablePath) {
    Write-Host "  âœ… useCozeChat.js å­˜åœ¨ï¼ˆæ”¯æ´é‡è©¦/é™ç´šæ©Ÿåˆ¶ï¼‰" -ForegroundColor Green
} else {
    Write-Host "  âš ï¸  æ‰¾ä¸åˆ° useCozeChat.jsï¼ˆå»ºè­°æ–°å¢ä»¥æ”¯æ´é‡è©¦/é™ç´šï¼‰" -ForegroundColor Yellow
    $warningCount++
}

# æª¢æŸ¥ vite.config.js
$viteConfigPath = "frontend/vite.config.js"
if (Test-Path $viteConfigPath) {
    $viteConfigContent = Get-Content $viteConfigPath -Raw
    if ($viteConfigContent -match "['""]\/api['""]:\s*\{[^}]*target:\s*['""]http:\/\/localhost:8080['""]") {
        Write-Host "  âœ… vite.config.js proxy é…ç½®æ­£ç¢º" -ForegroundColor Green
    } else {
        Write-Host "  âš ï¸  vite.config.js proxy é…ç½®å¯èƒ½éœ€è¦æª¢æŸ¥" -ForegroundColor Yellow
        $warningCount++
    }
} else {
    Write-Host "  âŒ æ‰¾ä¸åˆ° $viteConfigPath" -ForegroundColor Red
    $errorCount++
}

# æª¢æŸ¥ SupportCenterView.vue
$supportViewPath = "frontend/src/views/support/SupportCenterView.vue"
if (Test-Path $supportViewPath) {
    $supportViewContent = Get-Content $supportViewPath -Raw
    if ($supportViewContent -match "useCozeChat") {
        Write-Host "  âœ… SupportCenterView.vue ä½¿ç”¨ useCozeChat composable" -ForegroundColor Green
    } elseif ($supportViewContent -match "const\s+initCozeChat\s*=\s*async\s*\(\)") {
        Write-Host "  âš ï¸  SupportCenterView.vue ä½¿ç”¨èˆŠç‰ˆåˆå§‹åŒ–æ–¹å¼" -ForegroundColor Yellow
        $warningCount++
    } else {
        Write-Host "  âŒ SupportCenterView.vue ç¼ºå°‘ Coze åˆå§‹åŒ–é‚è¼¯" -ForegroundColor Red
        $errorCount++
    }
} else {
    Write-Host "  âŒ æ‰¾ä¸åˆ° $supportViewPath" -ForegroundColor Red
    $errorCount++
}

# ==================== 5. npm å¥—ä»¶æª¢æŸ¥ ====================
Write-Host "`nã€5ã€‘æª¢æŸ¥ npm å¥—ä»¶..." -ForegroundColor Yellow

$packageJsonPath = "frontend/package.json"
if (Test-Path $packageJsonPath) {
    $packageJson = Get-Content $packageJsonPath -Raw | ConvertFrom-Json
    if ($packageJson.dependencies.'@coze/chat-sdk') {
        Write-Host "  âœ… @coze/chat-sdk å·²å®‰è£: $($packageJson.dependencies.'@coze/chat-sdk')" -ForegroundColor Green
    } else {
        Write-Host "  âš ï¸  @coze/chat-sdk æœªåœ¨ dependencies ä¸­" -ForegroundColor Yellow
        Write-Host "     åŸ·è¡Œ: cd frontend && npm install @coze/chat-sdk" -ForegroundColor Yellow
        $warningCount++
    }
} else {
    Write-Host "  âŒ æ‰¾ä¸åˆ° $packageJsonPath" -ForegroundColor Red
    $errorCount++
}

# ==================== 6. è·¯ç”±é…ç½®æª¢æŸ¥ ====================
Write-Host "`nã€6ã€‘æª¢æŸ¥è·¯ç”±é…ç½®..." -ForegroundColor Yellow
$routerPath = "frontend/src/router/index.js"
if (Test-Path $routerPath) {
    $routerContent = Get-Content $routerPath -Raw
    $supportRouteExists = $routerContent -match "path:\s*['""]\/support['""]"
    $reportRouteExists = $routerContent -match "path:\s*['""]\/support\/report['""]"
    
    if ($supportRouteExists -and $reportRouteExists) {
        Write-Host "  âœ… è·¯ç”±é…ç½®æ­£ç¢ºï¼ˆ/support, /support/reportï¼‰" -ForegroundColor Green
    } else {
        if (-not $supportRouteExists) {
            Write-Host "  âŒ ç¼ºå°‘ /support è·¯ç”±" -ForegroundColor Red
            $errorCount++
        }
        if (-not $reportRouteExists) {
            Write-Host "  âš ï¸  ç¼ºå°‘ /support/report è·¯ç”±" -ForegroundColor Yellow
            $warningCount++
        }
    }
} else {
    Write-Host "  âŒ æ‰¾ä¸åˆ° $routerPath" -ForegroundColor Red
    $errorCount++
}

# ==================== è¨ºæ–·ç¸½çµ ====================
Write-Host "`n========================================" -ForegroundColor Cyan
Write-Host "è¨ºæ–·ç¸½çµ" -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan

if ($errorCount -eq 0 -and $warningCount -eq 0) {
    Write-Host "âœ… æ‰€æœ‰æª¢æŸ¥é€šéï¼" -ForegroundColor Green
} else {
    if ($errorCount -gt 0) {
        Write-Host "âŒ ç™¼ç¾ $errorCount å€‹éŒ¯èª¤" -ForegroundColor Red
    }
    if ($warningCount -gt 0) {
        Write-Host "âš ï¸  ç™¼ç¾ $warningCount å€‹è­¦å‘Š" -ForegroundColor Yellow
    }
}

# ==================== 502/TLB éŒ¯èª¤è¨ºæ–·å»ºè­° ====================
Write-Host "`n========================================" -ForegroundColor Cyan
Write-Host "502/TLB éŒ¯èª¤è¨ºæ–·å»ºè­°" -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan
Write-Host @"
è‹¥é»æ“Šæ³¡æ³¡å¾Œå‡ºç¾ 502 Bad Gateway / server: TLBï¼š

1. æª¢æŸ¥ Network Tab ä¸­ chatapp è«‹æ±‚çš„ Response Headers
   - è¨˜éŒ„ x-akamai-request-idï¼ˆç”¨æ–¼å‘ Coze å›å ±ï¼‰

2. å˜—è©¦åˆ‡æ›ç¶²è·¯
   - ä½¿ç”¨æ‰‹æ©Ÿç†±é»æ¸¬è©¦ï¼ˆæ’é™¤å…¬å¸ç¶²è·¯å•é¡Œï¼‰
   - ä½¿ç”¨ VPN æ¸¬è©¦

3. ç¢ºèª Coze æœå‹™ç‹€æ…‹
   - è¨ªå• https://status.coze.comï¼ˆè‹¥æœ‰ï¼‰
   - ç­‰å¾… 5-10 åˆ†é˜å¾Œé‡è©¦

4. å‰ç«¯é™ç´šè™•ç†
   - ç¢ºèª useCozeChat.js å·²å¯¦ä½œé‡è©¦æ©Ÿåˆ¶
   - ç¢ºèª SupportCenterView.vue é¡¯ç¤ºé™ç´š UI
"@ -ForegroundColor Gray

Write-Host "`n========================================" -ForegroundColor Cyan
Write-Host "å¿«é€Ÿä¿®æ­£æŒ‡å—" -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan
Write-Host @"
1. å®‰è£ npm å¥—ä»¶ï¼ˆå¦‚æœå°šæœªå®‰è£ï¼‰ï¼š
   cd frontend && npm install @coze/chat-sdk

2. å•Ÿå‹•å¾Œç«¯ï¼š
   cd backend && mvn spring-boot:run

3. å•Ÿå‹•å‰ç«¯ï¼š
   cd frontend && npm run dev

4. æ¸¬è©¦é é¢ï¼š
   http://localhost:5173/support
"@ -ForegroundColor Gray

Write-Host "`nè¨ºæ–·å®Œæˆï¼" -ForegroundColor Cyan
</file>

<file path="backend/docs/setup-coze.ps1">
# Coze Web Chat SDK å¿«é€Ÿè¨­å®šè…³æœ¬
# ç”¨é€”ï¼šå”åŠ©å¿«é€Ÿè¨­å®š Coze ç’°å¢ƒè®Šæ•¸ä¸¦é©—è­‰é…ç½®

param(
    [Parameter(Mandatory=$false)]
    [string]$BotId,
    
    [Parameter(Mandatory=$false)]
    [string]$Pat,
    
    [Parameter(Mandatory=$false)]
    [string]$SdkSrc = "https://lf-cdn.coze.cn/obj/unpkg/flow-platform/chat-app-sdk/1.0.0-beta.4/libs/oversea/index.js"
)

Write-Host "========================================" -ForegroundColor Cyan
Write-Host "Coze Web Chat SDK å¿«é€Ÿè¨­å®šå·¥å…·" -ForegroundColor Cyan
Write-Host "========================================`n" -ForegroundColor Cyan

# ==================== Step 1ï¼šæ”¶é›†åƒæ•¸ ====================
if (-not $BotId) {
    Write-Host "è«‹è¼¸å…¥ Coze Bot IDï¼š" -ForegroundColor Yellow -NoNewline
    $BotId = Read-Host
}

if (-not $Pat) {
    Write-Host "è«‹è¼¸å…¥ Coze Personal Access Token (PAT)ï¼š" -ForegroundColor Yellow -NoNewline
    $Pat = Read-Host
}

Write-Host "ä½¿ç”¨ SDK ä¾†æºï¼š$SdkSrc" -ForegroundColor Gray

# ==================== Step 2ï¼šé©—è­‰åƒæ•¸ ====================
if ([string]::IsNullOrWhiteSpace($BotId)) {
    Write-Host "`nâŒ Bot ID ä¸èƒ½ç‚ºç©ºï¼" -ForegroundColor Red
    exit 1
}

if ([string]::IsNullOrWhiteSpace($Pat)) {
    Write-Host "`nâŒ PAT Token ä¸èƒ½ç‚ºç©ºï¼" -ForegroundColor Red
    exit 1
}

# ==================== Step 3ï¼šè¨­å®šç’°å¢ƒè®Šæ•¸ ====================
Write-Host "`nã€è¨­å®šç’°å¢ƒè®Šæ•¸ã€‘" -ForegroundColor Yellow

try {
    $env:COZE_BOT_ID = $BotId
    $env:COZE_PAT = $Pat
    $env:COZE_CHAT_SDK_SRC = $SdkSrc
    
    Write-Host "  âœ… COZE_BOT_ID: $env:COZE_BOT_ID" -ForegroundColor Green
    Write-Host "  âœ… COZE_PAT: $($env:COZE_PAT.Substring(0, [Math]::Min(10, $env:COZE_PAT.Length)))..." -ForegroundColor Green
    Write-Host "  âœ… COZE_CHAT_SDK_SRC: $env:COZE_CHAT_SDK_SRC" -ForegroundColor Green
} catch {
    Write-Host "  âŒ è¨­å®šç’°å¢ƒè®Šæ•¸å¤±æ•—: $($_.Exception.Message)" -ForegroundColor Red
    exit 1
}

# ==================== Step 4ï¼šé©—è­‰å¾Œç«¯ API ====================
Write-Host "`nã€é©—è­‰å¾Œç«¯ APIã€‘" -ForegroundColor Yellow
Write-Host "æ­£åœ¨æª¢æŸ¥å¾Œç«¯æ˜¯å¦é‹è¡Œ..." -ForegroundColor Gray

try {
    $response = Invoke-WebRequest -Uri "http://localhost:8080/api/support/coze/bootstrap" -Method GET -TimeoutSec 5 -ErrorAction Stop
    
    if ($response.StatusCode -eq 200) {
        Write-Host "  âœ… å¾Œç«¯ Bootstrap API æ­£å¸¸é‹è¡Œ" -ForegroundColor Green
        
        $jsonResponse = $response.Content | ConvertFrom-Json
        Write-Host "  å›æ‡‰å…§å®¹:" -ForegroundColor Gray
        Write-Host "    - botId: $($jsonResponse.botId)" -ForegroundColor Gray
        Write-Host "    - token: $($jsonResponse.token.Substring(0, [Math]::Min(10, $jsonResponse.token.Length)))..." -ForegroundColor Gray
        Write-Host "    - sdkSrc: $($jsonResponse.sdkSrc)" -ForegroundColor Gray
        Write-Host "    - expiresIn: $($jsonResponse.expiresIn)" -ForegroundColor Gray
        Write-Host "    - serverTime: $($jsonResponse.serverTime)" -ForegroundColor Gray
    }
} catch {
    Write-Host "  âš ï¸  ç„¡æ³•é€£æ¥åˆ°å¾Œç«¯ API" -ForegroundColor Yellow
    Write-Host "  åŸå› : $($_.Exception.Message)" -ForegroundColor Gray
    Write-Host "`n  è«‹ç¢ºèªï¼š" -ForegroundColor Yellow
    Write-Host "    1. å¾Œç«¯æ˜¯å¦å·²å•Ÿå‹•: cd backend && mvn spring-boot:run" -ForegroundColor Gray
    Write-Host "    2. å¾Œç«¯æ˜¯å¦é‹è¡Œåœ¨ http://localhost:8080" -ForegroundColor Gray
    Write-Host "    3. é˜²ç«ç‰†æ˜¯å¦é˜»æ“‹é€£ç·š" -ForegroundColor Gray
}

# ==================== Step 5ï¼šç”¢ç”Ÿè¨­å®šæª”ï¼ˆå¯é¸ï¼‰ ====================
Write-Host "`nã€ç”¢ç”Ÿç’°å¢ƒè®Šæ•¸è¨­å®šæª”ã€‘" -ForegroundColor Yellow
$envFilePath = "coze-env.ps1"

$envFileContent = @"
# Coze Web Chat SDK ç’°å¢ƒè®Šæ•¸è¨­å®š
# ç”¢ç”Ÿæ™‚é–“: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss")
# ç”¨é€”: å¿«é€Ÿè¨­å®š Coze ç’°å¢ƒè®Šæ•¸

`$env:COZE_BOT_ID="$BotId"
`$env:COZE_PAT="$Pat"
`$env:COZE_CHAT_SDK_SRC="$SdkSrc"

Write-Host "âœ… Coze ç’°å¢ƒè®Šæ•¸å·²è¨­å®š" -ForegroundColor Green
Write-Host "  - COZE_BOT_ID: `$env:COZE_BOT_ID" -ForegroundColor Gray
Write-Host "  - COZE_PAT: `$(`$env:COZE_PAT.Substring(0, 10))..." -ForegroundColor Gray
Write-Host "  - COZE_CHAT_SDK_SRC: `$env:COZE_CHAT_SDK_SRC" -ForegroundColor Gray
"@

try {
    Set-Content -Path $envFilePath -Value $envFileContent -Encoding UTF8
    Write-Host "  âœ… è¨­å®šæª”å·²ç”¢ç”Ÿ: $envFilePath" -ForegroundColor Green
    Write-Host "  ä¸‹æ¬¡å¯ç›´æ¥åŸ·è¡Œ: .\\$envFilePath" -ForegroundColor Gray
} catch {
    Write-Host "  âš ï¸  ç„¡æ³•ç”¢ç”Ÿè¨­å®šæª”: $($_.Exception.Message)" -ForegroundColor Yellow
}

# ==================== Step 6ï¼šç¸½çµ ====================
Write-Host "`n========================================" -ForegroundColor Cyan
Write-Host "è¨­å®šå®Œæˆï¼" -ForegroundColor Cyan
Write-Host "========================================`n" -ForegroundColor Cyan

Write-Host "ğŸ“‹ ä¸‹ä¸€æ­¥æ“ä½œï¼š" -ForegroundColor Yellow
Write-Host ""
Write-Host "1. å•Ÿå‹•å¾Œç«¯ï¼ˆå¦‚æœå°šæœªå•Ÿå‹•ï¼‰ï¼š" -ForegroundColor Gray
Write-Host "   cd backend" -ForegroundColor Gray
Write-Host "   mvn spring-boot:run" -ForegroundColor Gray
Write-Host ""
Write-Host "2. å•Ÿå‹•å‰ç«¯ï¼š" -ForegroundColor Gray
Write-Host "   cd frontend" -ForegroundColor Gray
Write-Host "   npm run dev" -ForegroundColor Gray
Write-Host ""
Write-Host "3. é–‹å•Ÿç€è¦½å™¨æ¸¬è©¦ï¼š" -ForegroundColor Gray
Write-Host "   http://localhost:5173/support" -ForegroundColor Gray
Write-Host ""
Write-Host "4. æª¢æŸ¥ Console æ˜¯å¦é¡¯ç¤ºï¼š" -ForegroundColor Gray
Write-Host "   [Coze] åˆå§‹åŒ–å®Œæˆ âœ…" -ForegroundColor Gray
Write-Host ""
Write-Host "5. åŸ·è¡Œå®Œæ•´è¨ºæ–·ï¼š" -ForegroundColor Gray
Write-Host "   .\\diagnose-coze.ps1" -ForegroundColor Gray
Write-Host ""
Write-Host "âš ï¸  æ³¨æ„ï¼šç’°å¢ƒè®Šæ•¸åªåœ¨ç•¶å‰ PowerShell è¦–çª—æœ‰æ•ˆ" -ForegroundColor Yellow
Write-Host "   è‹¥é—œé–‰è¦–çª—ï¼Œéœ€è¦é‡æ–°åŸ·è¡Œï¼š.\\$envFilePath" -ForegroundColor Yellow
Write-Host ""
</file>

<file path="backend/docs/test-attachment-api.md">
# å·¥å–®åœ–ç‰‡é™„ä»¶ API æ¸¬è©¦æŒ‡å—

## ğŸ“‹ æ–°å¢/ä¿®æ”¹æª”æ¡ˆæ¸…å–®

### æ–°å¢æª”æ¡ˆ
1. âœ… `backend/src/main/java/com/example/backend/model/maintenance/MaintenanceTicketAttachment.java` - Entity
2. âœ… `backend/src/main/java/com/example/backend/repository/maintenance/MaintenanceTicketAttachmentRepository.java` - Repository
3. âœ… `backend/src/main/java/com/example/backend/dto/maintenance/AttachmentResponseDto.java` - DTO
4. âœ… `backend/src/main/java/com/example/backend/service/maintenance/AttachmentService.java` - Service

### ä¿®æ”¹æª”æ¡ˆ
1. âœ… `backend/src/main/java/com/example/backend/controller/maintenance/MaintenanceController.java` - æ–°å¢é™„ä»¶ç›¸é—œ API

---

## ğŸ¯ API ç«¯é»èªªæ˜

### 1. ä¸Šå‚³é™„ä»¶ï¼ˆå¤šæª”ï¼‰

**ç«¯é»**: `POST /api/maintenance/tickets/{ticketId}/attachments`

**åƒæ•¸**:
- `ticketId` (è·¯å¾‘åƒæ•¸) - å·¥å–® IDï¼ˆå¿…é ˆå­˜åœ¨æ–¼ maintenanceInformationï¼‰
- `files` (multipart/form-data) - åœ–ç‰‡æª”æ¡ˆï¼ˆå¯å¤šå€‹ï¼Œæœ€å¤š 5 å¼µï¼‰
- `note` (form field, å¯é¸) - å‚™è¨»ï¼ˆå¥—ç”¨åˆ°æ‰€æœ‰ä¸Šå‚³çš„é™„ä»¶ï¼‰

**é™åˆ¶**:
- å–®æª”æœ€å¤§ 5MB
- æ¯æ¬¡æœ€å¤šä¸Šå‚³ 5 å¼µ
- åƒ…æ”¯æ´åœ–ç‰‡æ ¼å¼ï¼š`image/jpeg`, `image/png`, `image/webp`

**å›æ‡‰ç¯„ä¾‹**:
```json
[
  {
    "attachmentId": 1,
    "ticketId": 1,
    "originalName": "repair-photo.jpg",
    "storedName": "a1b2c3d4-e5f6-7890-abcd-ef1234567890.jpg",
    "contentType": "image/jpeg",
    "fileSize": 1024567,
    "publicUrl": "/images/maintenance/tickets/1/a1b2c3d4-e5f6-7890-abcd-ef1234567890.jpg",
    "sortOrder": 1,
    "note": "ç¶­ä¿®ç¾å ´ç…§ç‰‡",
    "createdAt": "2026-01-31 12:00:00"
  }
]
```

---

### 2. æŸ¥è©¢é™„ä»¶æ¸…å–®

**ç«¯é»**: `GET /api/maintenance/tickets/{ticketId}/attachments`

**åƒæ•¸**:
- `ticketId` (è·¯å¾‘åƒæ•¸) - å·¥å–® ID

**å›æ‡‰**: åªå›å‚³ `isActive=1` çš„é™„ä»¶ï¼Œæ’åºç‚º `sortOrder ASC, createdAt DESC`

---

### 3. åˆªé™¤é™„ä»¶

**ç«¯é»**: `DELETE /api/maintenance/attachments/{attachmentId}`

**åƒæ•¸**:
- `attachmentId` (è·¯å¾‘åƒæ•¸) - é™„ä»¶ ID

**è¡Œç‚º**:
- DB: è¨­å®š `isActive = 0`ï¼ˆè»Ÿåˆªé™¤ï¼‰
- æª”æ¡ˆç³»çµ±: å˜—è©¦åˆªé™¤å¯¦é«”æª”æ¡ˆï¼ˆå¤±æ•—ä¸å½±éŸ¿ API å›æ‡‰ï¼Œåªè¨˜ logï¼‰

**å›æ‡‰**: åˆªé™¤å¾Œçš„é™„ä»¶è³‡è¨Š

---

## ğŸ§ª æ¸¬è©¦æ–¹æ³•

### æ–¹æ³• 1: ä½¿ç”¨ curlï¼ˆPowerShellï¼‰

#### 1. ä¸Šå‚³å–®å¼µåœ–ç‰‡
```powershell
curl -X POST http://localhost:8080/api/maintenance/tickets/1/attachments `
  -F "files=@test-image.jpg" `
  -F "note=ç¶­ä¿®ç¾å ´ç…§ç‰‡"
```

#### 2. ä¸Šå‚³å¤šå¼µåœ–ç‰‡
```powershell
curl -X POST http://localhost:8080/api/maintenance/tickets/1/attachments `
  -F "files=@photo1.jpg" `
  -F "files=@photo2.png" `
  -F "files=@photo3.webp" `
  -F "note=æ•…éšœè¨­å‚™ç…§ç‰‡"
```

#### 3. æŸ¥è©¢é™„ä»¶æ¸…å–®
```powershell
curl -X GET http://localhost:8080/api/maintenance/tickets/1/attachments
```

#### 4. åˆªé™¤é™„ä»¶
```powershell
curl -X DELETE http://localhost:8080/api/maintenance/attachments/1
```

---

### æ–¹æ³• 2: ä½¿ç”¨ Postman

#### ä¸Šå‚³é™„ä»¶
1. Method: `POST`
2. URL: `http://localhost:8080/api/maintenance/tickets/1/attachments`
3. Body:
   - é¸æ“‡ `form-data`
   - æ–°å¢ key: `files`ï¼ŒType: `File`ï¼Œé¸æ“‡åœ–ç‰‡æª”æ¡ˆï¼ˆå¯æŒ‰ä½ Ctrl å¤šé¸ï¼‰
   - æ–°å¢ key: `note`ï¼ŒType: `Text`ï¼Œè¼¸å…¥å‚™è¨»ï¼ˆå¯é¸ï¼‰
4. Send

#### æŸ¥è©¢é™„ä»¶
1. Method: `GET`
2. URL: `http://localhost:8080/api/maintenance/tickets/1/attachments`
3. Send

#### åˆªé™¤é™„ä»¶
1. Method: `DELETE`
2. URL: `http://localhost:8080/api/maintenance/attachments/1`
3. Send

---

### æ–¹æ³• 3: ä½¿ç”¨ PowerShell Invoke-WebRequest

```powershell
# ä¸Šå‚³é™„ä»¶
$file = Get-Item "D:\test-image.jpg"
$form = @{
    files = $file
    note = "æ¸¬è©¦åœ–ç‰‡"
}
Invoke-WebRequest -Uri "http://localhost:8080/api/maintenance/tickets/1/attachments" `
    -Method POST -Form $form

# æŸ¥è©¢é™„ä»¶
Invoke-WebRequest -Uri "http://localhost:8080/api/maintenance/tickets/1/attachments" `
    -Method GET | Select-Object -ExpandProperty Content

# åˆªé™¤é™„ä»¶
Invoke-WebRequest -Uri "http://localhost:8080/api/maintenance/attachments/1" `
    -Method DELETE
```

---

## âœ… é©—æ”¶æª¢æŸ¥æ¸…å–®

### è³‡æ–™åº«é©—è­‰
- [ ] ä¸Šå‚³æˆåŠŸå¾Œï¼Œæª¢æŸ¥ `maintenanceTicketAttachment` è¡¨æ˜¯å¦æœ‰æ–°è¨˜éŒ„
```sql
SELECT * FROM dbo.maintenanceTicketAttachment 
WHERE ticketId = 1 AND isActive = 1
ORDER BY sortOrder ASC, createdAt DESC
```

### æª”æ¡ˆç³»çµ±é©—è­‰
- [ ] æª¢æŸ¥æª”æ¡ˆæ˜¯å¦å­˜åœ¨æ–¼: `uploads/maintenance/tickets/{ticketId}/{storedName}`
- [ ] æª”åæ ¼å¼ç‚º: `{UUID}.{å‰¯æª”å}` (ä¾‹å¦‚: `a1b2c3d4-e5f6-7890-abcd-ef1234567890.jpg`)

### API åŠŸèƒ½é©—è­‰
- [ ] ä¸Šå‚³ä¸å­˜åœ¨çš„ ticketId å›å‚³ 500ï¼ˆIllegalArgumentException: æ‰¾ä¸åˆ°å·¥å–®ï¼‰
- [ ] ä¸Šå‚³éåœ–ç‰‡æ ¼å¼å›å‚³ 500ï¼ˆIllegalArgumentException: ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼ï¼‰
- [ ] ä¸Šå‚³è¶…é 5MB çš„æª”æ¡ˆå›å‚³ 500ï¼ˆIllegalArgumentException: æª”æ¡ˆå¤§å°è¶…éé™åˆ¶ï¼‰
- [ ] ä¸Šå‚³è¶…é 5 å¼µåœ–ç‰‡å›å‚³ 500ï¼ˆIllegalArgumentException: ä¸€æ¬¡æœ€å¤šä¸Šå‚³ 5 å€‹æª”æ¡ˆï¼‰
- [ ] sortOrder è‡ªå‹•éå¢ï¼ˆç¬¬ä¸€å¼µç‚º 1ï¼Œç¬¬äºŒå¼µç‚º 2...ï¼‰
- [ ] GET æ¸…å–®åªé¡¯ç¤º `isActive=1` çš„é™„ä»¶
- [ ] DELETE å¾Œ `isActive=0`ï¼Œæ¸…å–®ä¸å†é¡¯ç¤ºè©²é™„ä»¶

### ç€è¦½å™¨ç›´æ¥è¨ªå•
- [ ] é–‹å•Ÿç€è¦½å™¨ï¼Œè¨ªå• publicUrlï¼ˆä¾‹å¦‚: `http://localhost:8080/images/maintenance/tickets/1/xxx.jpg`ï¼‰
- [ ] æ‡‰è©²å¯ä»¥ç›´æ¥çœ‹åˆ°åœ–ç‰‡ï¼ˆé€é WebConfig çš„ `/images/**` æ˜ å°„ï¼‰

---

## ğŸ¨ æª”æ¡ˆå„²å­˜çµæ§‹

```
uploads/
â””â”€â”€ maintenance/
    â””â”€â”€ tickets/
        â”œâ”€â”€ 1/
        â”‚   â”œâ”€â”€ a1b2c3d4-e5f6-7890-abcd-ef1234567890.jpg
        â”‚   â”œâ”€â”€ b2c3d4e5-f6g7-8901-bcde-f12345678901.png
        â”‚   â””â”€â”€ c3d4e5f6-g7h8-9012-cdef-123456789012.webp
        â”œâ”€â”€ 2/
        â”‚   â””â”€â”€ d4e5f6g7-h8i9-0123-defg-234567890123.jpg
        â””â”€â”€ ...
```

---

## ğŸ” å®‰å…¨æ€§èªªæ˜

1. **æª”åé˜²è­·**: `storedName` ç”±ç³»çµ±ç”Ÿæˆï¼ˆUUIDï¼‰ï¼Œä¸ç›´æ¥ä½¿ç”¨ç”¨æˆ¶ä¸Šå‚³çš„æª”å
2. **è·¯å¾‘ç©¿è¶Šé˜²è­·**: `originalName` ç¶“é `sanitizeFileName()` è™•ç†ï¼Œåªä¿ç•™æª”æ¡ˆåç¨±
3. **æª”æ¡ˆé¡å‹é™åˆ¶**: åªå…è¨± `image/jpeg`, `image/png`, `image/webp`
4. **æª”æ¡ˆå¤§å°é™åˆ¶**: å–®æª”æœ€å¤§ 5MB
5. **æ•¸é‡é™åˆ¶**: æ¯æ¬¡æœ€å¤šä¸Šå‚³ 5 å¼µ
6. **å”¯ä¸€æ€§ä¿è­‰**: é€é UUID ç”Ÿæˆæ©Ÿåˆ¶ç¢ºä¿æ»¿è¶³ `UX_mta_ticket_storedName` å”¯ä¸€æ€§ç´„æŸ

---

## ğŸ“ å»ºè­° Commit Message

```
feat(maintenance): æ–°å¢å·¥å–®åœ–ç‰‡é™„ä»¶åŠŸèƒ½

- æ–°å¢ MaintenanceTicketAttachment Entity/Repository/Service/DTO
- æä¾›ä¸Šå‚³/æŸ¥è©¢/åˆªé™¤é™„ä»¶ REST APIï¼ˆåƒ…æ”¯æ´åœ–ç‰‡æ ¼å¼ï¼‰
- æª”æ¡ˆå„²å­˜æ–¼ uploads/maintenance/tickets/{ticketId}/
- æ”¯æ´å¤šæª”ä¸Šå‚³ï¼ˆæœ€å¤š5å¼µï¼Œå–®æª”æœ€å¤§5MBï¼‰
- å¯¦ä½œè»Ÿåˆªé™¤æ©Ÿåˆ¶ï¼ˆisActive flagï¼‰
- storedName ä½¿ç”¨ UUID é˜²æ­¢é‡è¤‡èˆ‡è·¯å¾‘ç©¿è¶Šæ”»æ“Š
- publicUrl é€é /images/** æ˜ å°„å¯ç›´æ¥ç€è¦½å™¨è¨ªå•
```

---

## ğŸš€ å¾ŒçºŒå»ºè­°

å¦‚éœ€å¢å¼·åŠŸèƒ½ï¼Œå¯è€ƒæ…®ï¼š
1. æ–°å¢åœ–ç‰‡å£“ç¸®ï¼ˆæ¸›å°‘å„²å­˜ç©ºé–“ï¼‰
2. æ–°å¢ç¸®åœ–ç”Ÿæˆï¼ˆæå‡è¼‰å…¥é€Ÿåº¦ï¼‰
3. æ”¯æ´æ›´å¤šåœ–ç‰‡æ ¼å¼ï¼ˆgif, bmp ç­‰ï¼‰
4. æ–°å¢æ‰¹é‡åˆªé™¤ API
5. æ–°å¢é™„ä»¶æ’åºèª¿æ•´ APIï¼ˆä¿®æ”¹ sortOrderï¼‰
6. æ•´åˆé›²ç«¯å„²å­˜ï¼ˆAzure Blob Storage / AWS S3ï¼‰
7. æ–°å¢åœ–ç‰‡æµ®æ°´å°ï¼ˆæ¨™è¨»å·¥å–®ç·¨è™Ÿï¼‰
</file>

<file path="backend/pom.xml">
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>
  <parent>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-parent</artifactId>
    <version>3.5.9</version>
    <relativePath/> </parent>
  
  <groupId>com.example</groupId>
  <artifactId>backend</artifactId>
  <version>0.0.1-SNAPSHOT</version>
  <name>backend</name>
  <description>Demo project for Spring Boot</description>
  
  <properties>
    <java.version>17</java.version>
  </properties>
  
  <dependencies>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-web</artifactId>
    </dependency>

    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-data-jpa</artifactId>
    </dependency>
    <dependency>
      <groupId>com.mysql</groupId>
      <artifactId>mysql-connector-j</artifactId>
      <scope>runtime</scope>
    </dependency>

    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-validation</artifactId>
    </dependency>

    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-devtools</artifactId>
      <scope>runtime</scope>
      <optional>true</optional>
    </dependency>

    <dependency>
      <groupId>org.projectlombok</groupId>
      <artifactId>lombok</artifactId>
      <optional>true</optional>
    </dependency>

    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-test</artifactId>
      <scope>test</scope>
    </dependency>

    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-actuator</artifactId>
    </dependency>

    <dependency>
        <groupId>com.google.code.gson</groupId>
        <artifactId>gson</artifactId>
        <version>2.10.1</version>
    </dependency>

    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-oauth2-client</artifactId>
    </dependency>

    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-mail</artifactId>
    </dependency>
    
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-redis</artifactId>
    </dependency>
  </dependencies>

  <build>
    <plugins>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-compiler-plugin</artifactId>
        <configuration>
          <annotationProcessorPaths>
            <path>
              <groupId>org.projectlombok</groupId>
              <artifactId>lombok</artifactId>
            </path>
          </annotationProcessorPaths>
        </configuration>
      </plugin>
      <plugin>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-maven-plugin</artifactId>
        <configuration>
          <excludes>
            <exclude>
              <groupId>org.projectlombok</groupId>
              <artifactId>lombok</artifactId>
            </exclude>
          </excludes>
        </configuration>
      </plugin>
    </plugins>
  </build>

</project>
</file>

<file path="backend/src/main/java/com/example/backend/controller/game/GameController.java">
package com.example.backend.controller.game;

import java.util.Map;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.bind.annotation.*;

// æ ¹æ“šä½ çš„æˆªåœ–ä¿®æ­£ import è·¯å¾‘
import com.example.backend.model.member.Member;
import com.example.backend.repository.member.MemberRepository;

@RestController
@RequestMapping("/api/game")
@CrossOrigin(origins = "http://localhost:5173")
public class GameController {

    @Autowired
    private MemberRepository memberRepository; // ä¿®æ­£ç‚ºä½ çš„ MemberRepository

    @PostMapping("/add-points")
    @Transactional // ç¢ºä¿é»æ•¸æ›´æ–°éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤æœƒè‡ªå‹•å›æ»¾
    public ResponseEntity<?> addPoints(@RequestBody Map<String, Object> payload) {
        try {
            // 1. è§£æåƒæ•¸ ( memberId è½‰ç‚º Integer )
            Integer memberId = Integer.valueOf(payload.get("memberId").toString());
            Integer newPoints = Integer.valueOf(payload.get("points").toString());

            // 2. æ‰¾åˆ°è©²æœƒå“¡ ( ä½¿ç”¨ä½ æˆªåœ–ä¸­çš„ MemberRepository )
            Member member = memberRepository.findById(memberId)
                    .orElseThrow(() -> new RuntimeException("æ‰¾ä¸åˆ°ç·¨è™Ÿç‚º " + memberId + " çš„æœƒå“¡"));

            // 3. åŸ·è¡Œç´¯åŠ é‚è¼¯
            // ä¿®æ­£é»ï¼šä½ çš„ Member.java è£¡é¢çš„æ–¹æ³•åç¨±æ˜¯ getMemPoints()
            // --- å°é ‚é‚è¼¯ï¼šå¦‚æœ newPoints è¶…é 50ï¼Œå¼·åˆ¶è¨­ç‚º 50 ---
            if (newPoints > 50) {
                newPoints = 50;
                System.out.println("è§¸ç™¼å°é ‚ï¼šæœƒå“¡ " + memberId + " è«‹æ±‚é»æ•¸ä¸Šé™ç‚º 50 é»");
            }
            if (newPoints < 0)
                newPoints = 0;
            int currentPoints = member.getMemPoints();
            int updatedTotal = currentPoints + newPoints;

            // ä¿®æ­£é»ï¼šä½ çš„ Member.java è£¡é¢çš„æ–¹æ³•åç¨±æ˜¯ setMemPoints()
            member.setMemPoints(updatedTotal);

            // 4. æ›´æ–°å›è³‡æ–™åº«
            memberRepository.save(member);

            // 5. å›å‚³æœ€æ–°çµæœçµ¦å‰ç«¯
            return ResponseEntity.ok(Map.of(
                    "message", "é»æ•¸å…Œæ›æˆåŠŸï¼",
                    "addPoints", newPoints,
                    "currentPoints", updatedTotal));

        } catch (Exception e) {
            e.printStackTrace();
            return ResponseEntity.badRequest().body("ç´¯åŠ å¤±æ•—: " + e.getMessage());
        }
    }

}
</file>

<file path="backend/src/main/java/com/example/backend/controller/maintenance/MaintenanceController.java">
package com.example.backend.controller.maintenance;

import com.example.backend.dto.maintenance.AttachmentResponseDto;
import com.example.backend.dto.maintenance.SpotOptionDto;
import com.example.backend.dto.maintenance.MaintenanceLogResponseDto;
import com.example.backend.dto.maintenance.MaintenanceStaffResponseDto;
import com.example.backend.model.maintenance.MaintenanceInformation;
import com.example.backend.model.maintenance.MaintenanceStaff;
import com.example.backend.model.member.Admin;
import com.example.backend.model.spot.Seat;
import com.example.backend.service.maintenance.AttachmentService;
import com.example.backend.service.maintenance.MaintenanceInformationService;
import com.example.backend.service.maintenance.MaintenanceStaffService;
import com.example.backend.service.member.AdminService; // å¼•ç”¨ AdminService
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpSession;
import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/api/maintenance")
@CrossOrigin(origins = "http://localhost:5173")
public class MaintenanceController {

    @Autowired
    private MaintenanceStaffService staffService;

    @Autowired
    private MaintenanceInformationService mtifService;

    @Autowired
    private AdminService adminService; // â˜… ç¢ºä¿é€™è£¡æœ‰æ³¨å…¥

    @Autowired
    private AttachmentService attachmentService; // â˜… æ–°å¢ï¼šé™„ä»¶æœå‹™

    @Autowired
    private HttpServletRequest request; // â˜… æ³¨å…¥ HttpServletRequest ç”¨æ–¼è®€å– Session

    /**
     * â˜… [å•é¡Œ 1 å®Œæ•´è§£æ±ºæ–¹æ¡ˆ] æ™ºæ…§å–å¾—ç•¶å‰ç™»å…¥ç®¡ç†å“¡çš„çœŸå¯¦å§“å
     * 
     * æŸ¥æ‰¾å„ªå…ˆé †åºï¼š
     * 1. å¾ Session ä¸­çš„ loginAdmin å–å¾— (æœ€å¯é )
     * 2. å¾ SecurityContext å–å¾— username ä¸¦æŸ¥è©¢
     * 3. å¦‚æœ username æ˜¯æ•¸å­—ï¼Œç•¶ä½œ ID æŸ¥è©¢
     * 4. å¦‚æœéƒ½å¤±æ•—ï¼Œå›å‚³é è¨­å€¼ã€Œç³»çµ±ç®¡ç†å“¡ã€
     */
    private String getCurrentUser() {
        System.out.println("========== [DEBUG] getCurrentUser() é–‹å§‹ ==========");
        
        try {
            // ==========================================
            // æ–¹æ³• 1ï¼šå¾ Session ä¸­ç›´æ¥å–å¾— (æœ€æº–ç¢º)
            // ==========================================
            HttpSession session = request.getSession(false);
            if (session != null) {
                Admin sessionAdmin = (Admin) session.getAttribute("loginAdmin");
                if (sessionAdmin != null && sessionAdmin.getAdmName() != null) {
                    String name = sessionAdmin.getAdmName();
                    System.out.println("[DEBUG] âœ… å¾ Session å–å¾—ç®¡ç†å“¡: " + name);
                    System.out.println("[DEBUG] ç®¡ç†å“¡å¸³è™Ÿ: " + sessionAdmin.getAdmUsername());
                    System.out.println("========== [DEBUG] getCurrentUser() çµæŸ ==========");
                    return name;
                }
            }
            System.out.println("[DEBUG] âš ï¸ Session ä¸­æ‰¾ä¸åˆ° loginAdmin");

            // ==========================================
            // æ–¹æ³• 2ï¼šå¾ SecurityContext å–å¾—
            // ==========================================
            Authentication auth = SecurityContextHolder.getContext().getAuthentication();
            
            if (auth == null || !auth.isAuthenticated() || "anonymousUser".equals(auth.getPrincipal())) {
                System.out.println("[DEBUG] âš ï¸ SecurityContext æ²’æœ‰èªè­‰è³‡è¨Š");
                System.out.println("========== [DEBUG] getCurrentUser() çµæŸ ==========");
                return "ç³»çµ±ç®¡ç†å“¡";
            }

            String username = auth.getName();
            System.out.println("[DEBUG] SecurityContext Auth Name: '" + username + "'");
            
            // ==========================================
            // æ­¥é©Ÿ 1ï¼šå˜—è©¦ç”¨ username æŸ¥è©¢
            // ==========================================
            Admin admin = adminService.findByUsername(username);
            if (admin != null && admin.getAdmName() != null) {
                System.out.println("[DEBUG] âœ… é€é username æ‰¾åˆ°ç®¡ç†å“¡: " + admin.getAdmName());
                System.out.println("========== [DEBUG] getCurrentUser() çµæŸ ==========");
                return admin.getAdmName();
            }
            System.out.println("[DEBUG] âš ï¸ findByUsername('" + username + "') æ²’æœ‰çµæœ");

            // ==========================================
            // æ­¥é©Ÿ 2ï¼šæª¢æŸ¥æ˜¯å¦ç‚ºæ•¸å­— (ID)
            // ==========================================
            if (username.matches("\\d+")) {
                try {
                    Integer adminId = Integer.parseInt(username);
                    System.out.println("[DEBUG] username æ˜¯æ•¸å­—ï¼Œå˜—è©¦ç”¨ ID æŸ¥è©¢: " + adminId);
                    admin = adminService.findById(adminId);
                    if (admin != null && admin.getAdmName() != null) {
                        System.out.println("[DEBUG] âœ… é€é ID æ‰¾åˆ°ç®¡ç†å“¡: " + admin.getAdmName());
                        System.out.println("========== [DEBUG] getCurrentUser() çµæŸ ==========");
                        return admin.getAdmName();
                    }
                    System.out.println("[DEBUG] âš ï¸ findById(" + adminId + ") æ²’æœ‰çµæœ");
                } catch (NumberFormatException e) {
                    System.out.println("[DEBUG] âš ï¸ è½‰æ› ID å¤±æ•—: " + e.getMessage());
                }
            }

            // ==========================================
            // æ­¥é©Ÿ 3ï¼šæª¢æŸ¥æ˜¯å¦ç‚º Email (é¸ç”¨)
            // ==========================================
            if (username.contains("@")) {
                System.out.println("[DEBUG] username çœ‹èµ·ä¾†åƒ Email: " + username);
                // å¦‚æœ AdminService æœ‰ findByEmail æ–¹æ³•å¯ä»¥åœ¨é€™è£¡å‘¼å«
                // Admin admin = adminService.findByEmail(username);
            }

        } catch (Exception e) {
            System.err.println("[ERROR] getCurrentUser() ç™¼ç”ŸéŒ¯èª¤: " + e.getMessage());
            e.printStackTrace();
        }

        // ==========================================
        // Fallbackï¼šæ‰€æœ‰æ–¹æ³•éƒ½å¤±æ•—
        // ==========================================
        System.out.println("[DEBUG] âŒ æ‰€æœ‰æŸ¥æ‰¾æ–¹æ³•éƒ½å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼");
        System.out.println("========== [DEBUG] getCurrentUser() çµæŸ ==========");
        return "ç³»çµ±ç®¡ç†å“¡";
    }

    @GetMapping("/spots")
    public List<SpotOptionDto> getSpotOptions() { 
        return mtifService.getSpotOptions(); 
    }

    // ================== ç¶­è­·äººå“¡ (Staff) ==================
    @GetMapping("/staff")
    public List<MaintenanceStaffResponseDto> getAllStaff() { 
        return staffService.getAllStaff(); 
    }

    // â˜… å‰ç«¯ä¸‹æ‹‰é¸å–®æ‡‰è©²å‘¼å«é€™æ”¯ APIï¼Œæ‰ä¸æœƒé¸åˆ°åœç”¨çš„äºº
    @GetMapping("/staff/active")
    public List<MaintenanceStaffResponseDto> getActiveStaff() { 
        return staffService.getActiveStaff(); 
    }

    @GetMapping("/staff/{id}")
    public MaintenanceStaffResponseDto getStaffById(@PathVariable Integer id) { 
        return staffService.getStaffById(id); 
    }

    @PostMapping("/staff")
    public MaintenanceStaffResponseDto createStaff(@RequestBody MaintenanceStaff staff) { 
        return staffService.createStaff(staff); 
    }

    @PutMapping("/staff/{id}")
    public MaintenanceStaffResponseDto updateStaff(@PathVariable Integer id, @RequestBody MaintenanceStaff staff) { 
        return staffService.updateStaff(id, staff); 
    }

    @DeleteMapping("/staff/{id}")
    public void deleteStaff(@PathVariable Integer id) { 
        staffService.deleteStaff(id); 
    }

    @GetMapping("/staff/inactive")
    public List<MaintenanceStaff> getInactiveStaff() { 
        return staffService.getInactiveStaff(); 
    }

    // ================== å·¥å–®æŸ¥è©¢ ==================
    @GetMapping("/tickets/active")
    public List<MaintenanceInformation> getActiveTickets() { 
        return mtifService.getActiveTickets(); 
    }

    @GetMapping("/tickets/history")
    public List<MaintenanceInformation> getHistoryTickets() { 
        return mtifService.getHistoryTickets(); 
    }

    @GetMapping("/tickets")
    public List<MaintenanceInformation> getAllTickets() { 
        return mtifService.getAllTickets(); 
    }

    @GetMapping("/tickets/spot/{spotId}")
    public List<MaintenanceInformation> getTicketsBySpot(@PathVariable Integer spotId) { 
        return mtifService.getTicketsBySpotId(spotId); 
    }

    @GetMapping("/tickets/{id}")
    public MaintenanceInformation getTicketById(@PathVariable Integer id) { 
        return mtifService.getRequiredTicket(id); 
    }

    // ================== å·¥å–®æ“ä½œ (å‚³é operator) ==================

    @PostMapping("/tickets")
    public MaintenanceInformation createTicket(@RequestBody MaintenanceInformation mtif) {
        // â˜… é€™è£¡å‚³å…¥ getCurrentUser() ç¢ºä¿ Log ç´€éŒ„æ­£ç¢ºåå­—
        return mtifService.createTicket(mtif, getCurrentUser());
    }

    @PutMapping("/tickets/{id}")
    public MaintenanceInformation updateTicket(@PathVariable Integer id, @RequestBody MaintenanceInformation mtif) {
        mtif.setTicketId(id);
        return mtifService.updateTicket(mtif, getCurrentUser());
    }
 
    @PostMapping("/tickets/{id}/assign")
    public void assignStaff(@PathVariable Integer id, @RequestBody Map<String, Integer> body) {
        mtifService.assignStaff(id, body.get("staffId"), getCurrentUser());
    }

    @PostMapping("/tickets/{id}/start")
    public void startTicket(@PathVariable Integer id) {
        // é–‹å§‹ç¶­ä¿®é€šå¸¸æ˜¯ç¶­ä¿®äººå“¡è‡ªå·±æŒ‰çš„
        mtifService.startTicket(id);
    }

    @PostMapping("/tickets/{id}/resolve")
    public void resolveTicket(@PathVariable Integer id, @RequestBody Map<String, String> body) {
        mtifService.resolveTicket(id, body.get("resultType"), body.get("resolveNote"));
    }

    @PostMapping("/tickets/{id}/cancel")
    public void cancelTicket(@PathVariable Integer id, @RequestBody Map<String, String> body) {
        mtifService.cancelTicket(id, body.get("reason"), getCurrentUser());
    }

    // â˜… [å•é¡Œ 4 è£œå……] ç¢ºä¿äººå“¡ç§»è½‰èˆ‡åˆªé™¤æ™‚ï¼Œä¹Ÿè¨˜éŒ„æ“ä½œè€…
    @PostMapping("/staff/transfer-and-delete")
    public void transferAndDelete(@RequestBody Map<String, Integer> body) {
        staffService.transferAndDelete(body.get("targetStaffId"), body.get("deleteStaffId"), getCurrentUser());
    }

    // ================== å…¶ä»– ==================
    @GetMapping("/seats")
    public List<Seat> getAllSeats() { return mtifService.getAllSeats(); }

    @GetMapping("/seats/spot/{spotId}")
    public List<Seat> getSeatsBySpot(@PathVariable Integer spotId) { return mtifService.getSeatsBySpot(spotId); }

    @GetMapping("/tickets/{id}/logs")
    public List<MaintenanceLogResponseDto> getTicketLogs(@PathVariable Integer id) { return mtifService.getTicketLogs(id); }
    
    @GetMapping("/staff/{staffId}/tickets")
    public List<MaintenanceInformation> getTicketsByStaff(@PathVariable Integer staffId, @RequestParam(required = false) List<String> statuses) {
        return mtifService.getTicketsByStaff(staffId, statuses);
    }

    // ================== å·¥å–®é™„ä»¶ API ==================

    /**
     * ä¸Šå‚³é™„ä»¶ï¼ˆå¤šæª”ï¼‰
     * POST /api/maintenance/tickets/{ticketId}/attachments
     * 
     * @param ticketId å·¥å–® ID
     * @param files æª”æ¡ˆé™£åˆ—ï¼ˆå¿…å¡«ï¼‰
     * @param note å‚™è¨»ï¼ˆå¯é¸ï¼Œå¥—ç”¨åˆ°æ‰€æœ‰é™„ä»¶ï¼‰
     * @return é™„ä»¶æ¸…å–®
     */
    @PostMapping("/tickets/{ticketId}/attachments")
    public List<AttachmentResponseDto> uploadAttachments(
            @PathVariable Integer ticketId,
            @RequestParam("files") MultipartFile[] files,
            @RequestParam(value = "note", required = false) String note) {
        return attachmentService.uploadAttachments(ticketId, files, note);
    }

    /**
     * æŸ¥è©¢å·¥å–®çš„æ‰€æœ‰é™„ä»¶
     * GET /api/maintenance/tickets/{ticketId}/attachments
     * 
     * @param ticketId å·¥å–® ID
     * @return é™„ä»¶æ¸…å–®ï¼ˆåƒ…å›å‚³å•Ÿç”¨ä¸­çš„ï¼‰
     */
    @GetMapping("/tickets/{ticketId}/attachments")
    public List<AttachmentResponseDto> getAttachments(@PathVariable Integer ticketId) {
        return attachmentService.getAttachments(ticketId);
    }

    /**
     * åˆªé™¤é™„ä»¶ï¼ˆè»Ÿåˆªé™¤ï¼‰
     * DELETE /api/maintenance/attachments/{attachmentId}
     * 
     * @param attachmentId é™„ä»¶ ID
     * @return åˆªé™¤å¾Œçš„é™„ä»¶è³‡è¨Š
     */
    @DeleteMapping("/attachments/{attachmentId}")
    public AttachmentResponseDto deleteAttachment(@PathVariable Integer attachmentId) {
        return attachmentService.deleteAttachment(attachmentId);
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/controller/member/AdminForgotPasswordController.java">
package com.example.backend.controller.member;

import java.util.HashMap;
import java.util.Map;
import java.util.Random;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.mail.SimpleMailMessage;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.web.bind.annotation.*;

import com.example.backend.model.member.Admin;
import com.example.backend.service.member.AdminService;

@RestController
@RequestMapping("/api/admin/forgot-password")
@CrossOrigin(origins = "http://localhost:5173", allowCredentials = "true")
public class AdminForgotPasswordController {

    @Autowired
    private JavaMailSender mailSender;

    @Autowired
    private AdminService adminService;

    // æš«æ™‚ç”¨ Map å­˜ç®¡ç†å“¡é©—è­‰ç¢¼ (Key: Email, Value: Code)
    private static Map<String, String> adminVerifyCodeStorage = new HashMap<>();

    /**
     * ç™¼é€é©—è­‰ç¢¼çµ¦ç®¡ç†å“¡
     */
    @PostMapping("/send-code")
    public ResponseEntity<?> sendCode(@RequestBody Map<String, String> request) {
        String email = request.get("email");

        // 1. æª¢æŸ¥è³‡æ–™åº«æ˜¯å¦æœ‰æ­¤ Email çš„ç®¡ç†å“¡
        Admin admin = adminService.findByEmail(email);
        if (admin == null) {
            return ResponseEntity.badRequest().body("è©²é›»å­éƒµä»¶æœªè¨»å†Šç‚ºç®¡ç†å“¡");
        }

        // 2. ç”Ÿæˆ 6 ä½æ•¸é©—è­‰ç¢¼
        String code = String.format("%06d", new Random().nextInt(1000000));

        // 3. å­˜å…¥è¨˜æ†¶é«”
        adminVerifyCodeStorage.put(email, code);

        // 4. å¯„å‡ºéƒµä»¶
        try {
            SimpleMailMessage message = new SimpleMailMessage();
            message.setFrom("alan123149@gmail.com");
            message.setTo(email);
            message.setSubject("SeatRentSys - ç®¡ç†å“¡å¯†ç¢¼é‡è¨­é©—è­‰ç¢¼");
            message.setText("ç®¡ç†å“¡æ‚¨å¥½ï¼Œæ‚¨çš„é©—è­‰ç¢¼ç‚ºï¼š" + code + "ï¼Œè«‹æ–¼ 5 åˆ†é˜å…§è¼¸å…¥ã€‚è‹¥éæœ¬äººæ“ä½œè«‹å¿½ç•¥æ­¤ä¿¡ã€‚");
            mailSender.send(message);

            System.out.println("[ç®¡ç†å“¡å‚™ä»½] é©—è­‰ç¢¼å·²å¯„è‡³: " + email + " ç¢¼ç‚º: " + code);
            return ResponseEntity.ok("é©—è­‰ç¢¼å·²å¯„å‡º");
        } catch (Exception e) {
            return ResponseEntity.internalServerError().body("éƒµä»¶ç™¼é€å¤±æ•—ï¼š" + e.getMessage());
        }
    }

    /**
     * ç®¡ç†å“¡é‡è¨­å¯†ç¢¼ (æ˜æ–‡ç‰ˆ)
     */
    @PostMapping("/reset")
    public ResponseEntity<?> resetPassword(@RequestBody Map<String, String> request) {
        String email = request.get("email");
        String code = request.get("code");
        String newPassword = request.get("newPassword");

        // 1. æ¯”å°é©—è­‰ç¢¼
        String savedCode = adminVerifyCodeStorage.get(email);
        if (savedCode == null || !savedCode.equals(code)) {
            return ResponseEntity.badRequest().body("é©—è­‰ç¢¼éŒ¯èª¤æˆ–å·²éæœŸ");
        }

        // 2. æ›´æ–°è³‡æ–™åº«å¯†ç¢¼
        try {
            // ç›´æ¥å‘¼å« Service æ›´æ–°æ˜æ–‡å¯†ç¢¼
            boolean success = adminService.updatePasswordByEmail(email, newPassword);

            if (success) {
                // æˆåŠŸå¾Œç§»é™¤é©—è­‰ç¢¼
                adminVerifyCodeStorage.remove(email);
                return ResponseEntity.ok("ç®¡ç†å“¡å¯†ç¢¼é‡è¨­æˆåŠŸ");
            } else {
                return ResponseEntity.status(500).body("è³‡æ–™åº«æ›´æ–°å¤±æ•—");
            }
        } catch (IllegalArgumentException e) {
            // é€™è£¡æœƒæŠ“åˆ° AdminService.validatePassword ä¸Ÿå‡ºçš„æ ¼å¼éŒ¯èª¤
            return ResponseEntity.badRequest().body(e.getMessage());
        } catch (Exception e) {
            return ResponseEntity.internalServerError().body("ç™¼ç”ŸéŒ¯èª¤ï¼š" + e.getMessage());
        }
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/controller/member/ForgotPasswordController.java">
package com.example.backend.controller.member;

import java.util.Map;
import java.util.Random;
import java.util.HashMap;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.mail.SimpleMailMessage;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.web.bind.annotation.*;

import com.example.backend.model.member.Member;
import com.example.backend.service.member.MemberService;

@RestController
@RequestMapping("/api/forgot-password")
@CrossOrigin(origins = "http://localhost:5173", allowCredentials = "true")
public class ForgotPasswordController {

    @Autowired
    private JavaMailSender mailSender;

    @Autowired
    private MemberService memberService;

    @Autowired
    private BCryptPasswordEncoder passwordEncoder;

    // æš«æ™‚ç”¨ä¸€å€‹ Map å­˜é©—è­‰ç¢¼ï¼ˆå¦‚æœé‚„æ²’æ¥ Redis çš„è©±ï¼‰
    // Key æ˜¯ Email, Value æ˜¯ é©—è­‰ç¢¼
    private static Map<String, String> verifyCodeStorage = new HashMap<>();

    @PostMapping("/send-code")
    public ResponseEntity<?> sendCode(@RequestBody Map<String, String> request) {
        String email = request.get("email");

        // 1. æª¢æŸ¥è³‡æ–™åº«æ˜¯å¦æœ‰æ­¤ Email çš„æœƒå“¡
        Member member = memberService.findByEmail(email); // å‡è¨­ä½  Service æœ‰é€™æ–¹æ³•
        if (member == null) {
            return ResponseEntity.badRequest().body("è©²é›»å­éƒµä»¶æœªè¨»å†Šç‚ºæœƒå“¡");
        }

        // 2. ç”Ÿæˆ 6 ä½æ•¸é©—è­‰ç¢¼
        String code = String.format("%06d", new Random().nextInt(1000000));

        // 3. å­˜å…¥è¨˜æ†¶é«” (æ­£å¼ç’°å¢ƒå»ºè­°ç”¨ Redis è¨­å®š 5 åˆ†é˜éæœŸ)
        verifyCodeStorage.put(email, code);

        // 4. å¯„å‡ºéƒµä»¶
        try {
            SimpleMailMessage message = new SimpleMailMessage();
            message.setFrom("alan123149@gmail.com");
            message.setTo(email);
            message.setSubject("SeatRentSys - å¯†ç¢¼é‡è¨­é©—è­‰ç¢¼");
            message.setText("æ‚¨å¥½ï¼Œæ‚¨çš„é©—è­‰ç¢¼ç‚ºï¼š" + code + "ï¼Œè«‹æ–¼ 5 åˆ†é˜å…§è¼¸å…¥ã€‚è‹¥éæœ¬äººæ“ä½œè«‹å¿½ç•¥æ­¤ä¿¡ã€‚");
            mailSender.send(message);

            System.out.println("é©—è­‰ç¢¼å·²å¯„è‡³: " + email + " ç¢¼ç‚º: " + code);
            return ResponseEntity.ok("é©—è­‰ç¢¼å·²å¯„å‡º");
        } catch (Exception e) {
            return ResponseEntity.internalServerError().body("éƒµä»¶ç™¼é€å¤±æ•—ï¼š" + e.getMessage());
        }
    }

    @PostMapping("/reset")
    public ResponseEntity<?> resetPassword(@RequestBody Map<String, String> request) {
        String email = request.get("email");
        String code = request.get("code");
        String newPassword = request.get("newPassword");

        // 1. æ¯”å°é©—è­‰ç¢¼
        String savedCode = verifyCodeStorage.get(email);
        if (savedCode == null || !savedCode.equals(code)) {
            return ResponseEntity.badRequest().body("é©—è­‰ç¢¼éŒ¯èª¤æˆ–å·²éæœŸ");
        }

        // 2. æ›´æ–°è³‡æ–™åº«å¯†ç¢¼ (æ”¹ç‚ºç›´æ¥å­˜å­—ä¸²)
        try {
            // ç›´æ¥å‚³å…¥æ˜æ–‡ newPasswordï¼Œä¸è¦ç”¨ passwordEncoder åŠ å¯†
            boolean success = memberService.updatePasswordByEmail(email, newPassword);

            if (success) {
                verifyCodeStorage.remove(email);
                return ResponseEntity.ok("å¯†ç¢¼é‡è¨­æˆåŠŸ");
            } else {
                return ResponseEntity.status(500).body("è³‡æ–™åº«æ›´æ–°å¤±æ•—");
            }
        } catch (Exception e) {
            return ResponseEntity.internalServerError().body("ç™¼ç”ŸéŒ¯èª¤ï¼š" + e.getMessage());
        }
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/controller/member/LoginAdminController.java">
package com.example.backend.controller.member;

import java.util.HashMap;
import java.util.Map;

import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.context.SecurityContextHolder; // æ–°å¢
import org.springframework.web.bind.annotation.*;

import com.example.backend.model.member.Admin;
import com.example.backend.repository.member.AdminRepository;

import jakarta.servlet.http.HttpServletRequest; // æ”¹ç”¨ HttpServletRequest æ¯”è¼ƒå¥½æ“ä½œ Session
import jakarta.servlet.http.HttpSession;

@RestController
@RequestMapping("/login")
@CrossOrigin(origins = "http://localhost:5173", allowCredentials = "true")
public class LoginAdminController {

    private final AdminRepository adminRepository;

    public LoginAdminController(AdminRepository adminRepository) {
        this.adminRepository = adminRepository;
    }

    @PostMapping("/admin")
    public ResponseEntity<?> login(@RequestBody Map<String, String> body,
            HttpServletRequest request) { // æ”¹å‚³å…¥ request

        String username = body.get("admUsername");
        String password = body.get("admPassword");

        if (username == null || password == null) {
            return ResponseEntity.badRequest().body("è«‹è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼");
        }

        Admin admin = adminRepository.findByAdmUsername(username);

        if (admin == null || !password.equals(admin.getAdmPassword())) {
            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤");
        }

        if (admin.getAdmStatus() != null && admin.getAdmStatus() == 0) {
            return ResponseEntity.status(HttpStatus.FORBIDDEN).body("å¸³è™Ÿå·²åœæ¬Šï¼Œè«‹è¯çµ¡ç®¡ç†å“¡");
        }

        // ==========================================
        // æ ¸å¿ƒä¿®æ­£ï¼šæ¸…ç†èˆŠèº«åˆ†ï¼Œé˜²æ­¢ Gmail èº«åˆ†æ±¡æŸ“
        // ==========================================

        // 1. æ¸…é™¤ Spring Security çš„é©—è­‰è³‡è¨Š (å¾¹åº•è¸¢æ‰ Gmail èº«åˆ†)
        SecurityContextHolder.clearContext();

        // 2. éŠ·æ¯€èˆŠ Session ä¸¦å»ºç«‹æ–° Session (é˜²æ­¢ Session Fixation æ”»æ“Šä¹Ÿæ¸…ç†èˆŠè³‡æ–™)
        HttpSession oldSession = request.getSession(false);
        if (oldSession != null) {
            oldSession.invalidate();
        }
        HttpSession newSession = request.getSession(true);

        // 3. è¨­å®šç®¡ç†å“¡ç™»å…¥è³‡è¨Š
        newSession.setAttribute("loginAdmin", admin);

        // ==========================================

        Map<String, Object> result = new HashMap<>();
        result.put("admUsername", admin.getAdmUsername());
        result.put("admName", admin.getAdmName());
        result.put("admRole", admin.getAdmRole());
        result.put("admId", admin.getAdmId()); // è£œä¸Š ID
        result.put("admEmail", admin.getAdmEmail()); // è£œä¸Š Email
        result.put("admCreatedAt", admin.getCreatedAt()); // è£œä¸Šåˆ°è·æ—¥æœŸ

        return ResponseEntity.ok(result);
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/controller/member/LoginMemberController.java">
package com.example.backend.controller.member;

import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.example.backend.model.member.Member;
import com.example.backend.repository.member.MemberRepository;

import jakarta.servlet.http.HttpSession;

@RestController
@RequestMapping("/login")
@CrossOrigin(origins = "http://localhost:5173")
public class LoginMemberController {

    @Autowired
    private MemberRepository memberRepository;

    @PostMapping("/member")
    public ResponseEntity<?> login(@RequestBody Map<String, String> body,
            HttpSession session) {

        String username = body.get("memUsername");
        String password = body.get("memPassword");

        // åŸºæœ¬é˜²å‘†
        if (username == null || password == null) {
            return ResponseEntity.badRequest().body("è«‹è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼");
        }

        // æŸ¥è©¢æœƒå“¡
        Member member = memberRepository.findByMemUsername(username);

        // å¸³è™Ÿä¸å­˜åœ¨
        if (member == null) {
            return ResponseEntity.status(HttpStatus.UNAUTHORIZED)
                    .body("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤");
        }

        // å¸³è™Ÿåœæ¬Š
        if (member.getMemStatus() == 0) {
            return ResponseEntity.status(HttpStatus.FORBIDDEN).body("æ‚¨çš„æœƒå“¡å¸³è™Ÿå·²åœæ¬Šï¼Œè«‹è¯çµ¡å®¢æœäººå“¡");
        }

        // =========================ä¿®æ­£ç™»ä¸é€²å»çš„å•é¡Œ=========================
        // æˆ‘å€‘å…ˆåŠ ä¸Š .trim() ä¾†å»é™¤å‰å¾Œç©ºç™½å­—å…ƒï¼Œé€ æˆç‡ˆä¸é€²å»çš„å•é¡Œ
        if (!password.trim().equals(member.getMemPassword().trim())) {
            return ResponseEntity.status(HttpStatus.UNAUTHORIZED)
                    .body("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤");
        }
        // ========================åˆ†éš”ç·š =========================================

        // å¯†ç¢¼æ¯”å°
        if (!password.equals(member.getMemPassword())) {
            return ResponseEntity.status(HttpStatus.UNAUTHORIZED)
                    .body("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤");
        }

        // ç™»å…¥æˆåŠŸï¼Œå­˜ session
        session.setAttribute("loginMember", member);

        // å›æˆåŠŸè¨Šæ¯
        return ResponseEntity.ok(member);
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/dto/maintenance/AttachmentResponseDto.java">
package com.example.backend.dto.maintenance;

import com.example.backend.model.maintenance.MaintenanceTicketAttachment;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;

/**
 * é™„ä»¶å›æ‡‰ DTO
 */
public class AttachmentResponseDto {

    private static final DateTimeFormatter FORMATTER = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");

    private Integer attachmentId;
    private Integer ticketId;
    private String originalName;
    private String storedName;
    private String contentType;
    private Long fileSize;
    private String publicUrl;
    private Integer sortOrder;
    private String note;
    private String createdAt;

    // ========== Constructors ==========

    public AttachmentResponseDto() {}

    /**
     * å¾ Entity è½‰æ›ç‚º DTO
     */
    public AttachmentResponseDto(MaintenanceTicketAttachment entity) {
        this.attachmentId = entity.getAttachmentId();
        this.ticketId = entity.getTicketId();
        this.originalName = entity.getOriginalName();
        this.storedName = entity.getStoredName();
        this.contentType = entity.getContentType();
        this.fileSize = entity.getFileSize();
        this.publicUrl = entity.getPublicUrl();
        this.sortOrder = entity.getSortOrder();
        this.note = entity.getNote();
        this.createdAt = entity.getCreatedAt() != null ? entity.getCreatedAt().format(FORMATTER) : null;
    }

    // ========== Getters & Setters ==========

    public Integer getAttachmentId() {
        return attachmentId;
    }

    public void setAttachmentId(Integer attachmentId) {
        this.attachmentId = attachmentId;
    }

    public Integer getTicketId() {
        return ticketId;
    }

    public void setTicketId(Integer ticketId) {
        this.ticketId = ticketId;
    }

    public String getOriginalName() {
        return originalName;
    }

    public void setOriginalName(String originalName) {
        this.originalName = originalName;
    }

    public String getStoredName() {
        return storedName;
    }

    public void setStoredName(String storedName) {
        this.storedName = storedName;
    }

    public String getContentType() {
        return contentType;
    }

    public void setContentType(String contentType) {
        this.contentType = contentType;
    }

    public Long getFileSize() {
        return fileSize;
    }

    public void setFileSize(Long fileSize) {
        this.fileSize = fileSize;
    }

    public String getPublicUrl() {
        return publicUrl;
    }

    public void setPublicUrl(String publicUrl) {
        this.publicUrl = publicUrl;
    }

    public Integer getSortOrder() {
        return sortOrder;
    }

    public void setSortOrder(Integer sortOrder) {
        this.sortOrder = sortOrder;
    }

    public String getNote() {
        return note;
    }

    public void setNote(String note) {
        this.note = note;
    }

    public String getCreatedAt() {
        return createdAt;
    }

    public void setCreatedAt(String createdAt) {
        this.createdAt = createdAt;
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/dto/rec/DailyOrderCountDTO.java">
package com.example.backend.dto.rec;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

/**
 * ç”¨æ–¼å°è£æ¯æ—¥è¨‚å–®è¨ˆæ•¸çš„æ•¸æ“šå‚³è¼¸ç‰©ä»¶ (DTO)ã€‚
 */
@Data
@NoArgsConstructor
@AllArgsConstructor
public class DailyOrderCountDTO {
    // æ—¥æœŸ (æ ¼å¼: YYYY-MM-DD)
    private String date;
    // è©²æ—¥æœŸçš„è¨‚å–®æ•¸é‡
    private Long count;
}
</file>

<file path="backend/src/main/java/com/example/backend/dto/rec/HourlyOrderCountDTO.java">
package com.example.backend.dto.rec;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

/**
 * ç”¨æ–¼å°è£æ¯å°æ™‚è¨‚å–®è¨ˆæ•¸çš„æ•¸æ“šå‚³è¼¸ç‰©ä»¶ (DTO)ã€‚
 */
@Data
@NoArgsConstructor
@AllArgsConstructor
public class HourlyOrderCountDTO {
    // å°æ™‚ (0-23)
    private Integer hour;
    // è©²å°æ™‚å…§çš„è¨‚å–®æ•¸é‡
    private Long count;
}
</file>

<file path="backend/src/main/java/com/example/backend/dto/rec/MonthlyOrderCountDTO.java">
package com.example.backend.dto.rec;

// å®šç¾©ä¸€å€‹æ•¸æ“šå‚³è¼¸å°è±¡(DTO)ï¼Œç”¨æ–¼å°è£æ¯æœˆè¨‚å–®æ•¸é‡çš„çµ±è¨ˆçµæœ
public class MonthlyOrderCountDTO {

    // å„²å­˜å¹´ä»½
    private Integer year;
    // å„²å­˜æœˆä»½
    private Integer month;
    // å„²å­˜è©²æœˆçš„è¨‚å–®ç¸½æ•¸
    private Long orderCount;

    // å»ºæ§‹å­ï¼Œç”¨æ–¼JPQLæŸ¥è©¢ç›´æ¥æ˜ å°„çµæœã€‚ä½¿ç”¨åŒ…è£é¡å‹(Integer, Long)ä»¥åŒ¹é…JPQLå‡½æ•¸è¿”å›çš„é¡å‹ã€‚
    public MonthlyOrderCountDTO(Integer year, Integer month, Long orderCount) {
        this.year = year;
        this.month = month;
        this.orderCount = orderCount;
    }

    // Year çš„ Getter
    public Integer getYear() {
        return year;
    }

    // Year çš„ Setter
    public void setYear(Integer year) {
        this.year = year;
    }

    // Month çš„ Getter
    public Integer getMonth() {
        return month;
    }

    // Month çš„ Setter
    public void setMonth(Integer month) {
        this.month = month;
    }

    // OrderCount çš„ Getter
    public Long getOrderCount() {
        return orderCount;
    }

    // OrderCount çš„ Setter
    public void setOrderCount(Long orderCount) {
        this.orderCount = orderCount;
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/dto/rec/OrderStatusStatsDTO.java">
package com.example.backend.dto.rec;

import lombok.Data;
import lombok.AllArgsConstructor;
import lombok.NoArgsConstructor;

// Lombokè¨»è§£ï¼Œè‡ªå‹•ç”Ÿæˆgetter, setter, toString, equals, hashCode
@Data
// è‡ªå‹•ç”ŸæˆåŒ…å«æ‰€æœ‰åƒæ•¸çš„å»ºæ§‹å‡½æ•¸
@AllArgsConstructor
// è‡ªå‹•ç”Ÿæˆç„¡åƒæ•¸çš„å»ºæ§‹å‡½æ•¸
@NoArgsConstructor
public class OrderStatusStatsDTO {
    // è¨‚å–®ç‹€æ…‹
    private String status;
    // è©²ç‹€æ…‹çš„è¨‚å–®æ•¸é‡
    private long count;
}
</file>

<file path="backend/src/main/java/com/example/backend/dto/rec/RentalDurationDTO.java">
package com.example.backend.dto.rec;

import java.time.LocalDateTime;
import lombok.Data;
import lombok.AllArgsConstructor;
import lombok.NoArgsConstructor;

// Lombokè¨»è§£ï¼Œè‡ªå‹•ç”Ÿæˆgetter, setter, toString, equals, hashCode
@Data
// è‡ªå‹•ç”ŸæˆåŒ…å«æ‰€æœ‰åƒæ•¸çš„å»ºæ§‹å‡½æ•¸
@AllArgsConstructor
// è‡ªå‹•ç”Ÿæˆç„¡åƒæ•¸çš„å»ºæ§‹å‡½æ•¸
@NoArgsConstructor
public class RentalDurationDTO {
    // è¨‚å–®çš„å”¯ä¸€è­˜åˆ¥ç¢¼
    private String recId;
    // ç§Ÿå€Ÿé–‹å§‹æ™‚é–“
    private LocalDateTime rentTime;
    // ç§Ÿå€Ÿç¸½æ™‚é•·ï¼ˆåˆ†é˜ï¼‰
    private long durationInMinutes;
}
</file>

<file path="backend/src/main/java/com/example/backend/dto/rec/RentalDurationStatsDTO.java">
package com.example.backend.dto.rec;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

/**
 * ç”¨æ–¼å°è£ç§Ÿå€Ÿæ™‚é•·çµ±è¨ˆæ•¸æ“šçš„æ•¸æ“šå‚³è¼¸ç‰©ä»¶ (DTO)ã€‚
 */
@Data
@NoArgsConstructor
@AllArgsConstructor
public class RentalDurationStatsDTO {
    // ç§Ÿå€Ÿæ™‚é•·çš„åˆ†çµ„ (ä¾‹å¦‚ï¼Œä»¥30åˆ†é˜ç‚ºä¸€å€‹å–®ä½)
    private Integer intervalGroup;
    // è©²åˆ†çµ„å…§çš„è¨‚å–®æ•¸é‡
    private Long count;
}
</file>

<file path="backend/src/main/java/com/example/backend/dto/spot/SeatUpdateRequest.java">
package com.example.backend.dto.spot;

import lombok.Data;

// DTO: å°ˆé–€ç”¨ä¾†æ¥æ”¶å‰ç«¯ "æ›´æ–°åº§ä½" è«‹æ±‚çš„è³‡æ–™è¼‰é«”
@Data
public class SeatUpdateRequest {

    private Integer seatsId;
    private String seatsName;
    private String seatsType;
    private String seatsStatus;
    private Integer spotId;
    private String serialNumber;

}
</file>

<file path="backend/src/main/java/com/example/backend/dto/spot/SpotUpdateRequest.java">
package com.example.backend.dto.spot;

import java.math.BigDecimal;

import lombok.Data;

// DTO (Data Transfer Object): ä¸€å€‹ç°¡å–®çš„ Java ç‰©ä»¶ï¼Œå°ˆé–€ç”¨ä¾†åœ¨å„å±¤ä¹‹é–“å‚³éè³‡æ–™ã€‚
// é€™è£¡ç”¨ä¾†å°æ‡‰å‰ç«¯æ›´æ–° Spot æ™‚å‚³ä¾†çš„ JSON ç‰©ä»¶ã€‚
@Data
public class SpotUpdateRequest {

    private Integer spotId;
    private String spotCode;
    private String spotName;
    private String spotAddress;
    private String spotStatus;
    private Integer merchantId;
    private BigDecimal latitude;
    private BigDecimal longitude;
    private String spotDescription;
    private String spotImage;

}
</file>

<file path="backend/src/main/java/com/example/backend/exception/GlobalExceptionHandler.java">
package com.example.backend.exception;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;
import org.springframework.web.servlet.resource.NoResourceFoundException;

import java.time.LocalDateTime;
import java.util.HashMap;
import java.util.Map;

/**
 * å…¨åŸŸä¾‹å¤–è™•ç†å™¨
 * çµ±ä¸€æ””æˆª Controller æ‹‹å‡ºçš„ä¾‹å¤–ï¼Œä¸¦å›å‚³æ¨™æº– JSON æ ¼å¼ { message: "..." }
 * è®“å‰ç«¯å¯ä»¥ç›´æ¥è®€å– error.response.data.message é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
 */
@RestControllerAdvice
public class GlobalExceptionHandler {

    private static final Logger log = LoggerFactory.getLogger(GlobalExceptionHandler.class);

    /**
     * è™•ç†åƒæ•¸é©—è­‰éŒ¯èª¤ï¼ˆæ¥­å‹™é‚è¼¯é©—è­‰å¤±æ•—ï¼‰
     * HTTP 400 Bad Request
     */
    @ExceptionHandler(IllegalArgumentException.class)
    public ResponseEntity<Map<String, Object>> handleIllegalArgumentException(IllegalArgumentException ex) {
        log.warn("IllegalArgumentException: {}", ex.getMessage());

        Map<String, Object> errorResponse = new HashMap<>();
        errorResponse.put("message", ex.getMessage());
        errorResponse.put("status", 400);
        errorResponse.put("timestamp", LocalDateTime.now().toString());

        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(errorResponse);
    }

    /**
     * è™•ç†ç‹€æ…‹è¡çªéŒ¯èª¤ï¼ˆä¾‹å¦‚ï¼šç‹€æ…‹ä¸å…è¨±åŸ·è¡ŒæŸæ“ä½œï¼‰
     * HTTP 409 Conflict
     */
    @ExceptionHandler(IllegalStateException.class)
    public ResponseEntity<Map<String, Object>> handleIllegalStateException(IllegalStateException ex) {
        log.warn("IllegalStateException: {}", ex.getMessage());

        Map<String, Object> errorResponse = new HashMap<>();
        errorResponse.put("message", ex.getMessage());
        errorResponse.put("status", 409);
        errorResponse.put("timestamp", LocalDateTime.now().toString());

        return ResponseEntity.status(HttpStatus.CONFLICT).body(errorResponse);
    }

    /**
     * è™•ç†éœæ…‹è³‡æºæ‰¾ä¸åˆ°éŒ¯èª¤ï¼ˆSpring Boot 3.x æ–°å¢ï¼‰
     * HTTP 404 Not Found
     * 
     * å¸¸è¦‹æƒ…å¢ƒï¼š
     * - å‰ç«¯è«‹æ±‚ä¸å­˜åœ¨çš„ API endpoint
     * - è«‹æ±‚ä¸å­˜åœ¨çš„éœæ…‹è³‡æºï¼ˆåœ–ç‰‡ã€CSSã€JS ç­‰ï¼‰
     * 
     * æ³¨æ„ï¼šæ­¤éŒ¯èª¤ä¸æ‡‰è¢«è¦–ç‚ºç³»çµ±éŒ¯èª¤ï¼ˆ500ï¼‰ï¼Œè€Œæ˜¯æ­£å¸¸çš„ 404 å›æ‡‰
     */
    @ExceptionHandler(NoResourceFoundException.class)
    public ResponseEntity<Map<String, Object>> handleNoResourceFoundException(NoResourceFoundException ex) {
        log.warn("NoResourceFoundException: {} - {}", ex.getResourcePath(), ex.getMessage());

        Map<String, Object> errorResponse = new HashMap<>();
        errorResponse.put("message", "Not Found");
        errorResponse.put("path", ex.getResourcePath());
        errorResponse.put("status", 404);
        errorResponse.put("timestamp", LocalDateTime.now().toString());

        return ResponseEntity.status(HttpStatus.NOT_FOUND).body(errorResponse);
    }

    /**
     * è™•ç†åŸ·è¡Œéšæ®µéŒ¯èª¤ï¼ˆä¾‹å¦‚ï¼šæª”æ¡ˆæ ¼å¼ä¸å°ã€ç³»çµ±å­˜å–å•é¡Œï¼‰
     * HTTP 400 Bad Request
     */
    @ExceptionHandler(RuntimeException.class)
    public ResponseEntity<Map<String, Object>> handleRuntimeException(RuntimeException ex) {
        log.warn("RuntimeException: {}", ex.getMessage());

        Map<String, Object> errorResponse = new HashMap<>();
        errorResponse.put("message", ex.getMessage());
        errorResponse.put("status", 400);
        errorResponse.put("timestamp", LocalDateTime.now().toString());

        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(errorResponse);
    }

    /**
     * è™•ç†æ‰€æœ‰æœªé æœŸçš„ä¾‹å¤–
     * HTTP 500 Internal Server Error
     */
    @ExceptionHandler(Exception.class)
    public ResponseEntity<Map<String, Object>> handleGeneralException(Exception ex) {
        // è¨˜éŒ„å®Œæ•´ stack trace åˆ°å¾Œç«¯ logï¼ˆä¸å›å‚³çµ¦å‰ç«¯ï¼‰
        log.error("Unexpected exception occurred", ex);

        Map<String, Object> errorResponse = new HashMap<>();
        errorResponse.put("message", "ç³»çµ±ç™¼ç”Ÿéé æœŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–è¯ç¹«ç®¡ç†å“¡");
        errorResponse.put("status", 500);
        errorResponse.put("timestamp", LocalDateTime.now().toString());
        // é–‹ç™¼ç’°å¢ƒå¯ä»¥åŠ ä¸Š ex.getClass().getSimpleName() æ–¹ä¾¿é™¤éŒ¯
        // errorResponse.put("type", ex.getClass().getSimpleName());

        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(errorResponse);
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/file/FileController.java">
package com.example.backend.file;

import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.servlet.support.ServletUriComponentsBuilder;

import java.util.Map;

@RestController
@RequestMapping("/files")
public class FileController {

    private final FileStorageService fileStorageService;

    public FileController(FileStorageService fileStorageService) {
        this.fileStorageService = fileStorageService;
    }

    /**
     * é€šç”¨ä¸Šå‚³
     * - é è¨­å­˜åˆ° uploads/spots
     * - å›å‚³ filePath = "spots/uuid_xxx.jpg" (ç›´æ¥å¯å­˜ DB)
     * - å›å‚³ url = "/images/spots/uuid_xxx.jpg" (å‰ç«¯å¯é è¦½)
     */
    @PostMapping("/upload")
    public ResponseEntity<Map<String, String>> uploadFile(
            @RequestParam("file") MultipartFile file,
            @RequestParam(value = "folder", defaultValue = "spots") String folder) {
        // 1) å„²å­˜æª”æ¡ˆä¸¦å–å¾—ã€Œç›¸å°è·¯å¾‘ã€ï¼šä¾‹å¦‚ "spots/uuid_xxx.jpg"
        String filePath = fileStorageService.store(file, folder);

        // 2) çµ„å‡ºå‰ç«¯å¯ç›´æ¥ç”¨çš„ URLï¼ˆå°æ‡‰ WebConfig: /images/** â†’ uploads/ï¼‰
        String url = ServletUriComponentsBuilder.fromCurrentContextPath()
                .path("/images/")
                .path(filePath) // filePath å·²å« "spots/..."
                .toUriString();

        // 3) å›å‚³ JSONï¼ˆfilePath ç”¨æ–¼å­˜ DBï¼›url ç”¨æ–¼é è¦½ï¼‰
        return ResponseEntity.ok(Map.of(
                "filePath", filePath,
                "url", url));
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/file/FileStorageService.java">
package com.example.backend.file;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import jakarta.annotation.PostConstruct;
import java.io.IOException;
import java.nio.file.*;

@Service
public class FileStorageService {

    @Value("${app.file.upload-path:uploads}")
    private String uploadDir;

    private Path rootLocation;

    @PostConstruct
    public void init() {
        this.rootLocation = Paths.get(uploadDir).toAbsolutePath().normalize();
        try {
            Files.createDirectories(rootLocation);
        } catch (IOException e) {
            throw new RuntimeException("ç„¡æ³•åˆå§‹åŒ–ä¸Šå‚³ç›®éŒ„", e);
        }
    }

    public String store(MultipartFile file, String subdir) {
        if (file == null || file.isEmpty()) {
            throw new RuntimeException("ç„¡æ³•å„²å­˜ç©ºæª”æ¡ˆ");
        }
        if (subdir == null || subdir.isBlank()) {
            throw new RuntimeException("å­è³‡æ–™å¤¾(subdir)ä¸å¾—ç‚ºç©º");
        }

        try {
            String contentType = file.getContentType();
            if (contentType == null || !contentType.startsWith("image/")) {
                throw new RuntimeException("ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼ï¼åƒ…å…è¨±ä¸Šå‚³åœ–ç‰‡æª”æ¡ˆ (MIME type: " + contentType + ")");
            }

            String originalFilename = file.getOriginalFilename();
            if (originalFilename == null || originalFilename.isBlank()) {
                throw new RuntimeException("æª”æ¡ˆåç¨±ä¸å¾—ç‚ºç©º");
            }

            String cleanFileName = java.nio.file.Paths.get(originalFilename).getFileName().toString();

            // ç¢ºä¿ uploads/subdir å­˜åœ¨
            java.nio.file.Path subdirPath = this.rootLocation.resolve(subdir).normalize();
            java.nio.file.Files.createDirectories(subdirPath);

            String filename = java.util.UUID.randomUUID() + "_" + cleanFileName;

            java.nio.file.Path destinationFile = subdirPath.resolve(filename).normalize().toAbsolutePath();

            // å®‰å…¨æ€§æª¢æŸ¥ï¼šç¢ºä¿ä»åœ¨ uploads(rootLocation) ä¸‹
            if (!destinationFile.startsWith(this.rootLocation.toAbsolutePath())) {
                throw new RuntimeException("ç„¡æ³•å°‡æª”æ¡ˆå„²å­˜è‡³é æœŸç›®éŒ„ä¹‹å¤–");
            }

            try (java.io.InputStream inputStream = file.getInputStream()) {
                java.nio.file.Files.copy(inputStream, destinationFile,
                        java.nio.file.StandardCopyOption.REPLACE_EXISTING);
            }

            // âœ… A æ¨¡å¼ï¼šå›å‚³ DB è¦å­˜çš„ç›¸å°è·¯å¾‘
            return subdir + "/" + filename;

        } catch (java.io.IOException e) {
            throw new RuntimeException("æª”æ¡ˆå„²å­˜å¤±æ•—", e);
        }
    }

    public void delete(String relativePath) {
        if (relativePath == null || relativePath.isBlank())
            return;

        try {
            java.nio.file.Path target = rootLocation.resolve(relativePath).normalize().toAbsolutePath();

            if (!target.startsWith(rootLocation.toAbsolutePath())) {
                throw new RuntimeException("æ‹’çµ•åˆªé™¤ uploads ç›®éŒ„ä»¥å¤–çš„æª”æ¡ˆ: " + relativePath);
            }

            java.nio.file.Files.deleteIfExists(target);

        } catch (java.io.IOException e) {
            throw new RuntimeException("ç„¡æ³•åˆªé™¤æª”æ¡ˆ: " + relativePath, e);
        }
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/model/maintenance/MaintenanceStaff.java">
package com.example.backend.model.maintenance;

import jakarta.persistence.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "maintenanceStaff")
public class MaintenanceStaff {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "staffId")
    private Integer staffId;

    @Column(name = "staffName", nullable = false, length = 50)
    private String staffName;

    @Column(name = "staffCompany", length = 100)
    private String staffCompany;

    @Column(name = "staffPhone", length = 20)
    private String staffPhone;

    @Column(name = "staffEmail", length = 100)
    private String staffEmail;

    @Column(name = "staffNote", length = 200)
    private String staffNote;

    // DB æœ‰ DEFAULT SYSDATETIME()ï¼Œå»ºè­°ç”± DB ç”¢ç”Ÿ
    @Column(name = "createdAt", insertable = false, updatable = false)
    private LocalDateTime createdAt;

    // ä½ å¾Œä¾† ADD çš„æ¬„ä½ï¼šisActive default 1
    @Column(name = "isActive", nullable = false)
    private Boolean isActive;
    

    public MaintenanceStaff() {}

    // getters/setters
    public Integer getStaffId() { return staffId; }
    public void setStaffId(Integer staffId) { this.staffId = staffId; }

    public String getStaffName() { return staffName; }
    public void setStaffName(String staffName) { this.staffName = staffName; }

    public String getStaffCompany() { return staffCompany; }
    public void setStaffCompany(String staffCompany) { this.staffCompany = staffCompany; }

    public String getStaffPhone() { return staffPhone; }
    public void setStaffPhone(String staffPhone) { this.staffPhone = staffPhone; }

    public String getStaffEmail() { return staffEmail; }
    public void setStaffEmail(String staffEmail) { this.staffEmail = staffEmail; }

    public String getStaffNote() { return staffNote; }
    public void setStaffNote(String staffNote) { this.staffNote = staffNote; }

    public LocalDateTime getCreatedAt() { return createdAt; }
    public void setCreatedAt(LocalDateTime createdAt) { this.createdAt = createdAt; }

    public Boolean getIsActive() { return isActive; }
    public void setIsActive(Boolean isActive) { this.isActive = isActive; }
}
</file>

<file path="backend/src/main/java/com/example/backend/model/maintenance/MaintenanceTicketAttachment.java">
package com.example.backend.model.maintenance;

import com.fasterxml.jackson.annotation.JsonBackReference;
import jakarta.persistence.*;
import java.time.LocalDateTime;

/**
 * ç¶­ä¿®å·¥å–®é™„ä»¶ Entity
 * å°æ‡‰è³‡æ–™è¡¨ maintenanceTicketAttachment
 */
@Entity
@Table(name = "maintenanceTicketAttachment")
public class MaintenanceTicketAttachment {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "attachmentId")
    private Integer attachmentId;

    /**
     * é—œè¯å·¥å–® (å¤šå°ä¸€)
     */
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "ticketId", nullable = false)
    @JsonBackReference
    private MaintenanceInformation ticket;

    @Column(name = "ticketId", insertable = false, updatable = false)
    private Integer ticketId;

    @Column(name = "originalName", nullable = false, length = 255)
    private String originalName;

    @Column(name = "storedName", nullable = false, length = 255)
    private String storedName;

    @Column(name = "contentType", nullable = false, length = 100)
    private String contentType;

    @Column(name = "fileSize", nullable = false)
    private Long fileSize;

    @Column(name = "publicUrl", nullable = false, length = 400)
    private String publicUrl;

    @Column(name = "sortOrder", nullable = false)
    private Integer sortOrder = 0;

    @Column(name = "note", length = 200)
    private String note;

    /**
     * å»ºç«‹æ™‚é–“ï¼ˆç”± DB è‡ªå‹•ç”¢ç”Ÿï¼‰
     */
    @Column(name = "createdAt", nullable = false, insertable = false, updatable = false)
    private LocalDateTime createdAt;

    @Column(name = "isActive", nullable = false)
    private Boolean isActive = true;

    // ========== Constructors ==========

    public MaintenanceTicketAttachment() {}

    // ========== Getters & Setters ==========

    public Integer getAttachmentId() {
        return attachmentId;
    }

    public void setAttachmentId(Integer attachmentId) {
        this.attachmentId = attachmentId;
    }

    public MaintenanceInformation getTicket() {
        return ticket;
    }

    public void setTicket(MaintenanceInformation ticket) {
        this.ticket = ticket;
    }

    public Integer getTicketId() {
        return ticketId;
    }

    public void setTicketId(Integer ticketId) {
        this.ticketId = ticketId;
    }

    public String getOriginalName() {
        return originalName;
    }

    public void setOriginalName(String originalName) {
        this.originalName = originalName;
    }

    public String getStoredName() {
        return storedName;
    }

    public void setStoredName(String storedName) {
        this.storedName = storedName;
    }

    public String getContentType() {
        return contentType;
    }

    public void setContentType(String contentType) {
        this.contentType = contentType;
    }

    public Long getFileSize() {
        return fileSize;
    }

    public void setFileSize(Long fileSize) {
        this.fileSize = fileSize;
    }

    public String getPublicUrl() {
        return publicUrl;
    }

    public void setPublicUrl(String publicUrl) {
        this.publicUrl = publicUrl;
    }

    public Integer getSortOrder() {
        return sortOrder;
    }

    public void setSortOrder(Integer sortOrder) {
        this.sortOrder = sortOrder;
    }

    public String getNote() {
        return note;
    }

    public void setNote(String note) {
        this.note = note;
    }

    public LocalDateTime getCreatedAt() {
        return createdAt;
    }

    public void setCreatedAt(LocalDateTime createdAt) {
        this.createdAt = createdAt;
    }

    public Boolean getIsActive() {
        return isActive;
    }

    public void setIsActive(Boolean isActive) {
        this.isActive = isActive;
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/model/merchantAndCoupon/SponsorshipRecord.java">
package com.example.backend.model.merchantAndCoupon;

import jakarta.persistence.*;
import lombok.Data;
import org.hibernate.annotations.CreationTimestamp;
import org.hibernate.annotations.UpdateTimestamp;

import java.math.BigDecimal;
import java.time.LocalDateTime;

@Entity
@Table(name = "SponsorshipRecord")
@Data
public class SponsorshipRecord {
    @Column(name = "sponsorid")
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Integer sponsorId;

    @Column(name = "memberid", nullable = false)
    private Integer memberId;

    @Column(name = "merchanttradeno", nullable = false, unique = true, length = 50)
    private String merchantTradeNo; // æˆ‘å€‘è‡ªå·±ç”¢ç”Ÿçš„ç·¨è™Ÿ

    @Column(name = "tradeno", length = 50)
    private String tradeNo; // ç¶ ç•Œå›å‚³çš„ç·¨è™Ÿ

    @Column(name = "amount", nullable = false)
    private BigDecimal amount;

    @Column(name = "sponsorcomment", length = 500)
    private String sponsorComment; // è´ŠåŠ©è€…çš„ç•™è¨€

    /**
     * 0: å¾…æ”¯ä»˜ (Pending)
     * 1: æ”¯ä»˜æˆåŠŸ (Success)
     * 2: æ”¯ä»˜å¤±æ•— (Failed)
     */
    @Column(name = "status", nullable = false)
    private Integer status = 0;

    @Column(name = "paymenttype")
    private String paymentType;

    @CreationTimestamp
    @Column(name = "createdat", updatable = false)
    private LocalDateTime createdAt;

    @UpdateTimestamp
    @Column(name = "updatedat")
    private LocalDateTime updatedAt;
}
</file>

<file path="backend/src/main/java/com/example/backend/model/rec/RecRent.java">
package com.example.backend.model.rec;

import java.math.BigDecimal;
import java.time.LocalDateTime;

import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.Table;
import lombok.Data;

@Data // Lombok è‡ªå‹•ç”¢ç”Ÿ Getter, Setter, toString ç­‰
@Entity
@Table(name = "recRent")
public class RecRent {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY) // å°æ‡‰ SQL çš„ IDENTITY(1,1)
    @Column(name = "recSeqId")
    private Integer recSeqId;

    // å°æ‡‰ SQL çš„è¨ˆç®—æ¬„ä½ (AS ... PERSISTED)ï¼ŒJava ç«¯è¨­ç‚ºå”¯è®€
    @Column(name = "recId", insertable = false, updatable = false)
    private String recId;

    @Column(name = "memId", nullable = false)
    private Integer memId;

    @Column(name = "couponId")
    private Integer couponId;

    @Column(name = "seatsId", nullable = false)
    private String seatsId;

    @Column(name = "spotIdRent", nullable = false)
    private Integer spotIdRent;

    @Column(name = "spotIdReturn")
    private Integer spotIdReturn;

    @Column(name = "recRentDT2", nullable = false)
    private LocalDateTime recRentDT2;

    @Column(name = "recReturnDT2")
    private LocalDateTime recReturnDT2;

    // å°æ‡‰ SQL çš„ DECIMAL
    @Column(name = "recUsageDT2")
    private BigDecimal recUsageDT2;

    @Column(name = "recStatus")
    private String recStatus;

    @Column(name = "recPrice")
    private Integer recPrice;

    @Column(name = "recRequestPay")
    private Integer recRequestPay;

    @Column(name = "recPayment")
    private Integer recPayment;

    @Column(name = "recPayBy")
    private String recPayBy;

    @Column(name = "recInvoice")
    private String recInvoice;

    @Column(name = "recCarrier")
    private String recCarrier;

    @Column(name = "recViolatInt", nullable = false)
    private Integer recViolatInt;

    @Column(name = "recNote")
    private String recNote;
}
</file>

<file path="backend/src/main/java/com/example/backend/model/spot/RentalSpot.java">
package com.example.backend.model.spot;

import java.math.BigDecimal;
import java.time.LocalDateTime;

import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.Table;
import jakarta.validation.constraints.NotBlank;
import lombok.Data;

@Entity
@Table(name = "renting_Spot")
@Data
public class RentalSpot {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "spotId")
    private Integer spotId;

    @NotBlank(message = "æ“šé»ä»£ç¢¼ä¸å¾—ç‚ºç©º")
    @Column(name = "spotCode", length = 30, nullable = false)
    private String spotCode;

    @NotBlank(message = "æ“šé»åç¨±ä¸å¾—ç‚ºç©º")
    @Column(name = "spotName", length = 100, nullable = false)
    private String spotName;

    @Column(name = "spotAddress", length = 200)
    private String spotAddress;

    @NotBlank(message = "æ“šé»ç‹€æ…‹ä¸å¾—ç‚ºç©º")
    @Column(name = "spotStatus", length = 20, nullable = false)
    private String spotStatus;

    @Column(name = "merchantId")
    private Integer merchantId;

    // å›  DB å·²æœ‰ Default èˆ‡ Triggerï¼Œæ”¹ç”± DB å…¨æ¬Šç®¡ç†ï¼ŒJPA ä¸å¯«å…¥ã€åªè®€å–
    @Column(name = "createdAt", updatable = false, insertable = false)
    private LocalDateTime createdAt;

    // å›  DB å·²æœ‰ Default èˆ‡ Triggerï¼Œæ”¹ç”± DB å…¨æ¬Šç®¡ç†ï¼ŒJPA ä¸å¯«å…¥ã€åªè®€å–
    @Column(name = "updatedAt", updatable = false, insertable = false)
    private LocalDateTime updatedAt;

    @Column(name = "latitude", precision = 10, scale = 7) // 10 ç¸½ä½æ•¸ï¼Œ7 å°æ•¸ä½
    private BigDecimal latitude;

    @Column(name = "longitude", precision = 10, scale = 7) // 10 ç¸½ä½æ•¸ï¼Œ7 å°æ•¸ä½
    private BigDecimal longitude;

    @Column(name = "spotDescription", length = 500)
    private String spotDescription;

    @Column(name = "spotImage", length = 255)
    private String spotImage;

    public RentalSpot() {
    }

    public RentalSpot(String spotCode, String spotName, String spotStatus) {
        this.spotCode = spotCode;
        this.spotName = spotName;
        this.spotStatus = spotStatus;
    }

    public RentalSpot(String spotCode, String spotName, String spotAddress, String spotStatus, Integer merchantId,
            BigDecimal latitude, BigDecimal longitude) {
        this.spotCode = spotCode;
        this.spotName = spotName;
        this.spotAddress = spotAddress;
        this.spotStatus = spotStatus;
        this.merchantId = merchantId;
        this.latitude = latitude;
        this.longitude = longitude;
    }

}
</file>

<file path="backend/src/main/java/com/example/backend/model/spot/Seat.java">
package com.example.backend.model.spot;

import java.time.LocalDateTime;

import lombok.Data;

import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.Table;
import jakarta.validation.constraints.NotBlank;

@Entity
@Table(name = "seats")
@Data
public class Seat {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "seatsId")
    private Integer seatsId;

    @NotBlank(message = "åº§ä½åç¨±ä¸å¾—ç‚ºç©º")
    @Column(name = "seatsName", length = 100, nullable = false)
    private String seatsName;

    @NotBlank(message = "åº§ä½é¡å‹ä¸å¾—ç‚ºç©º")
    @Column(name = "seatsType", length = 50, nullable = false)
    private String seatsType;

    @NotBlank(message = "åº§ä½ç‹€æ…‹ä¸å¾—ç‚ºç©º")
    @Column(name = "seatsStatus", length = 20, nullable = false)
    private String seatsStatus;

    @Column(name = "spotId")
    private Integer spotId;

    @Column(name = "serialNumber", length = 50, insertable = false, updatable = false)
    private String serialNumber;

    // [å„ªåŒ–] å›  DB å·²æœ‰ Default èˆ‡ Triggerï¼Œæ”¹ç”± DB å…¨æ¬Šç®¡ç†ï¼ŒJPA ä¸å¯«å…¥ã€åªè®€å–
    @Column(name = "createdAt", updatable = false, insertable = false)
    private LocalDateTime createdAt;

    // [å„ªåŒ–] å›  DB å·²æœ‰ Default èˆ‡ Triggerï¼Œæ”¹ç”± DB å…¨æ¬Šç®¡ç†ï¼ŒJPA ä¸å¯«å…¥ã€åªè®€å–
    @Column(name = "updatedAt", updatable = false, insertable = false)
    private LocalDateTime updatedAt;

    public Seat() {
    }

    public Seat(Integer seatsId, String seatsName, String seatsType, String seatsStatus,
            Integer spotId, LocalDateTime updatedAt, String serialNumber, LocalDateTime createdAt) {
        this.seatsId = seatsId;
        this.seatsName = seatsName;
        this.seatsType = seatsType;
        this.seatsStatus = seatsStatus;
        this.spotId = spotId;
        this.updatedAt = updatedAt;
        this.serialNumber = serialNumber;
        this.createdAt = createdAt;
    }

}
</file>

<file path="backend/src/main/java/com/example/backend/repository/maintenance/MaintenanceTicketAttachmentRepository.java">
package com.example.backend.repository.maintenance;

import com.example.backend.model.maintenance.MaintenanceTicketAttachment;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;

/**
 * ç¶­ä¿®å·¥å–®é™„ä»¶ Repository
 */
@Repository
public interface MaintenanceTicketAttachmentRepository extends JpaRepository<MaintenanceTicketAttachment, Integer> {

    /**
     * æŸ¥è©¢æŒ‡å®šå·¥å–®çš„æ‰€æœ‰å•Ÿç”¨é™„ä»¶
     * æ’åºï¼šsortOrder ASC, createdAt DESC
     */
    List<MaintenanceTicketAttachment> findByTicketIdAndIsActiveTrueOrderBySortOrderAscCreatedAtDesc(Integer ticketId);

    /**
     * æŸ¥è©¢æŒ‡å®šå·¥å–®çš„æœ€å¤§ sortOrderï¼ˆç”¨æ–¼æ–°å¢æ™‚è¨ˆç®—ä¸‹ä¸€å€‹é †åºï¼‰
     */
    @Query("SELECT COALESCE(MAX(a.sortOrder), 0) FROM MaintenanceTicketAttachment a WHERE a.ticketId = :ticketId")
    Integer findMaxSortOrderByTicketId(@Param("ticketId") Integer ticketId);

    /**
     * æª¢æŸ¥ storedName æ˜¯å¦å·²å­˜åœ¨æ–¼è©²å·¥å–®ï¼ˆé˜²æ­¢é‡è¤‡ï¼‰
     */
    boolean existsByTicketIdAndStoredName(Integer ticketId, String storedName);
}
</file>

<file path="backend/src/main/java/com/example/backend/repository/member/AdminRepository.java">
package com.example.backend.repository.member;

import java.util.List;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;

import com.example.backend.model.member.Admin;

public interface AdminRepository extends JpaRepository<Admin, Integer> {

    // ç™»å…¥
    Admin findByAdmUsername(String admUsername);

    // æ–°å¢å‰æª¢æŸ¥ç”¨
    boolean existsByAdmUsername(String admUsername);

    boolean existsByAdmEmail(String admEmail);

    // æ¨¡ç³ŠæŸ¥è©¢
    @Query("""
                SELECT a FROM Admin a
                WHERE a.admUsername LIKE %:kw%
                   OR a.admName LIKE %:kw%
                   OR a.admEmail LIKE %:kw%
            """)
    List<Admin> findByKeyword(@Param("kw") String keyword);

    // å¿˜è¨˜å¯†ç¢¼ç”¨ï¼šé€é Email æ‰¾åˆ°ç®¡ç†å“¡ç‰©ä»¶
    Admin findByAdmEmail(String admEmail);
}
</file>

<file path="backend/src/main/java/com/example/backend/repository/member/MemberRepository.java">
package com.example.backend.repository.member;

import java.util.List;
import java.util.Optional;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;

import com.example.backend.model.member.Member;

public interface MemberRepository extends JpaRepository<Member, Integer> {

    // ç™»å…¥ç”¨ï¼ˆæ–°å¢é€™è¡Œï¼‰
    Member findByMemUsername(String memUsername);

    // æ¨¡ç³ŠæŸ¥è©¢
    @Query("""
                SELECT m FROM Member m
                WHERE m.memUsername LIKE %:kw%
                   OR m.memName LIKE %:kw%
                   OR m.memEmail LIKE %:kw%
                   OR m.memPhone LIKE %:kw%
            """)
    List<Member> findByKeyword(@Param("kw") String keyword);

    // è®“ CustomOAuth2UserService å¯ä»¥ç”¨ Email æª¢æŸ¥æœƒå“¡æ˜¯å¦å­˜åœ¨
    Optional<Member> findByMemEmail(String memEmail);

    // --- æ–°å¢é€™è¡Œçµ¦å¿˜è¨˜å¯†ç¢¼åŠŸèƒ½ä½¿ç”¨ ---
    // ç›´æ¥å›å‚³ Member ç‰©ä»¶ï¼Œæ–¹ä¾¿ Service èª¿ç”¨
    Member findByMemEmailIgnoreCase(String memEmail);
}
</file>

<file path="backend/src/main/java/com/example/backend/repository/merchantAndCoupon/SponsorshipRepository.java">
package com.example.backend.repository.merchantAndCoupon;

import java.util.List;
import java.util.Optional;
import com.example.backend.model.merchantAndCoupon.SponsorshipRecord;
import org.springframework.data.jpa.repository.JpaRepository;

public interface SponsorshipRepository extends JpaRepository<SponsorshipRecord, Integer> {
    // é€éè¨‚å–®ç·¨è™Ÿæ‰¾ç´€éŒ„ï¼Œé€™æ˜¯æ›´æ–°ç‹€æ…‹æ™‚æœ€æ ¸å¿ƒçš„åŠŸèƒ½
    List<SponsorshipRecord> findAllByOrderBySponsorIdDesc();

    Optional<SponsorshipRecord> findByMerchantTradeNo(String merchantTradeNo);
}
</file>

<file path="backend/src/main/java/com/example/backend/repository/rec/RentDetailsSpecs.java">
package com.example.backend.repository.rec;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.LocalTime;

import org.springframework.data.jpa.domain.Specification;
import org.springframework.util.StringUtils;

import com.example.backend.model.rec.RentDetails;

import jakarta.persistence.criteria.Predicate;

public class RentDetailsSpecs {

    public static Specification<RentDetails> hasRecId(String recId) {
        return (root, query, cb) -> {
            if (!StringUtils.hasText(recId)) {
                return cb.conjunction(); // or cb.isTrue(cb.literal(true))
            }
            return cb.equal(root.get("recId"), recId);
        };
    }

    public static Specification<RentDetails> hasMemId(Integer memId) {
        return (root, query, cb) -> {
            if (memId == null) {
                return cb.conjunction();
            }
            return cb.equal(root.get("memId"), memId);
        };
    }

    public static Specification<RentDetails> spotNameContains(String spotName) {
        return (root, query, cb) -> {
            if (!StringUtils.hasText(spotName)) {
                return cb.conjunction();
            }
            return cb.like(root.get("rentSpotName"), "%" + spotName + "%");
        };
    }

    public static Specification<RentDetails> memNameContains(String memName) {
        return (root, query, cb) -> {
            if (!StringUtils.hasText(memName)) {
                return cb.conjunction();
            }
            return cb.like(root.get("memName"), "%" + memName + "%");
        };
    }

    public static Specification<RentDetails> hasRecStatus(String recStatus) {
        return (root, query, cb) -> {
            if (!StringUtils.hasText(recStatus)) {
                return cb.conjunction();
            }
            return cb.equal(root.get("recStatus"), recStatus);
        };
    }

    public static Specification<RentDetails> hasSpotId(Integer spotId) {
        return (root, query, cb) -> {
            if (spotId == null) {
                return cb.conjunction();
            }
            // æœå°‹ç§Ÿå€Ÿç«™é»IDæˆ–æ­¸é‚„ç«™é»ID
            Predicate rentSpotMatch = cb.equal(root.get("spotIdRent"), spotId);
            Predicate returnSpotMatch = cb.equal(root.get("spotIdReturn"), spotId);
            return cb.or(rentSpotMatch, returnSpotMatch);
        };
    }

    public static Specification<RentDetails> isWithinTimeRange(LocalDate startDate, LocalDate endDate) {
        return (root, query, cb) -> {
            if (startDate == null || endDate == null) {
                return cb.conjunction();
            }
            LocalDateTime startDateTime = startDate.atStartOfDay();
            LocalDateTime endDateTime = endDate.atTime(LocalTime.MAX);

            Predicate rentTimeIn = cb.between(root.get("recRentDT2"), startDateTime, endDateTime);
            Predicate returnTimeIn = cb.between(root.get("recReturnDT2"), startDateTime, endDateTime);

            return cb.or(rentTimeIn, returnTimeIn);
        };
    }

}
</file>

<file path="backend/src/main/java/com/example/backend/repository/spot/SeatRepository.java">
package com.example.backend.repository.spot;

import java.util.List; // ç¢ºèªé€™è£¡æ˜¯ java.util.Listï¼Œçµ•å°ä¸èƒ½æ˜¯ java.awt.List

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import com.example.backend.model.spot.Seat;

@Repository
public interface SeatRepository extends JpaRepository<Seat, Integer>, JpaSpecificationExecutor<Seat> {

    // è£œä¸Š Service å±¤å‘¼å«çš„æ¨¡ç³ŠæŸ¥è©¢æ–¹æ³•
    @Query("SELECT s FROM Seat s WHERE s.seatsName LIKE %:keyword% OR s.serialNumber LIKE %:keyword% OR s.seatsType LIKE %:keyword%")
    List<Seat> findByKeyword(@Param("keyword") String keyword);

    /**
     * æª¢æŸ¥æŒ‡å®šçš„ serialNumber æ˜¯å¦å·²å­˜åœ¨æ–¼è³‡æ–™åº«ä¸­ã€‚
     * 
     * @param serialNumber è¦æª¢æŸ¥çš„åºè™Ÿ
     * @return å¦‚æœå­˜åœ¨å‰‡è¿”å› trueï¼Œå¦å‰‡è¿”å› falseã€‚
     */
    boolean existsBySerialNumber(String serialNumber);

    // æ ¹æ“šæ“šé» ID æŸ¥è©¢è©²æ“šé»ä¸‹çš„æ‰€æœ‰åº§ä½
    List<Seat> findBySpotId(Integer spotId);

    // æ ¹æ“šæ“šé» ID æŸ¥è©¢è©²æ“šé»ä¸‹çš„åº§ä½æ•¸é‡
    long countBySpotId(Integer spotId);

    // æŸ¥è©¢ç¬¦åˆå‰ç¶´çš„æœ€å¾Œä¸€ç­†åº§ä½è³‡æ–™ (ç”¨æ–¼è‡ªå‹•ç”¢ç”Ÿåºè™Ÿï¼Œä¾‹å¦‚æ‰¾ SN-2026 é–‹é ­çš„æœ€å¤§å€¼)
    Seat findTopBySerialNumberStartingWithOrderBySerialNumberDesc(String prefix);
}
</file>

<file path="backend/src/main/java/com/example/backend/service/maintenance/AttachmentService.java">
package com.example.backend.service.maintenance;

import com.example.backend.dto.maintenance.AttachmentResponseDto;
import com.example.backend.model.maintenance.MaintenanceInformation;
import com.example.backend.model.maintenance.MaintenanceTicketAttachment;
import com.example.backend.repository.maintenance.MaintenanceInformationRepository;
import com.example.backend.repository.maintenance.MaintenanceTicketAttachmentRepository;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.nio.file.StandardCopyOption;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.UUID;

/**
 * é™„ä»¶ç®¡ç† Service
 */
@Service
@Transactional
public class AttachmentService {

    private static final Logger log = LoggerFactory.getLogger(AttachmentService.class);

    // å…è¨±çš„åœ–ç‰‡æ ¼å¼
    private static final List<String> ALLOWED_CONTENT_TYPES = Arrays.asList(
            "image/jpeg", "image/png", "image/webp"
    );

    // å–®æª”æœ€å¤§ 5MB
    private static final long MAX_FILE_SIZE = 5 * 1024 * 1024;

    // æ¯æ¬¡æœ€å¤š 5 å¼µ
    private static final int MAX_FILES_PER_REQUEST = 5;

    @Value("${app.file.upload-path:uploads}")
    private String uploadBasePath;

    private final MaintenanceTicketAttachmentRepository attachmentRepo;
    private final MaintenanceInformationRepository ticketRepo;

    public AttachmentService(
            MaintenanceTicketAttachmentRepository attachmentRepo,
            MaintenanceInformationRepository ticketRepo) {
        this.attachmentRepo = attachmentRepo;
        this.ticketRepo = ticketRepo;
    }

    /**
     * ä¸Šå‚³é™„ä»¶ï¼ˆå¤šæª”ï¼‰
     * 
     * @param ticketId å·¥å–® ID
     * @param files æª”æ¡ˆé™£åˆ—
     * @param note å‚™è¨»ï¼ˆå¯é¸ï¼Œå¥—ç”¨åˆ°æ‰€æœ‰é™„ä»¶ï¼‰
     * @return é™„ä»¶ DTO æ¸…å–®
     */
    public List<AttachmentResponseDto> uploadAttachments(Integer ticketId, MultipartFile[] files, String note) {
        // 1. é©—è­‰å·¥å–®æ˜¯å¦å­˜åœ¨
        MaintenanceInformation ticket = ticketRepo.findById(ticketId)
                .orElseThrow(() -> new IllegalArgumentException("æ‰¾ä¸åˆ°å·¥å–® ID: " + ticketId));

        // 2. é©—è­‰æª”æ¡ˆæ•¸é‡
        if (files == null || files.length == 0) {
            throw new IllegalArgumentException("è«‹é¸æ“‡è‡³å°‘ä¸€å€‹æª”æ¡ˆ");
        }
        if (files.length > MAX_FILES_PER_REQUEST) {
            throw new IllegalArgumentException("ä¸€æ¬¡æœ€å¤šä¸Šå‚³ " + MAX_FILES_PER_REQUEST + " å€‹æª”æ¡ˆ");
        }

        // 3. å–å¾—ç•¶å‰æœ€å¤§ sortOrder
        Integer maxSortOrder = attachmentRepo.findMaxSortOrderByTicketId(ticketId);
        int nextSortOrder = (maxSortOrder != null ? maxSortOrder : 0) + 1;

        // 4. å»ºç«‹å„²å­˜ç›®éŒ„
        Path ticketDir = Paths.get(uploadBasePath, "maintenance", "tickets", ticketId.toString())
                .toAbsolutePath().normalize();
        try {
            if (!Files.exists(ticketDir)) {
                Files.createDirectories(ticketDir);
            }
        } catch (IOException e) {
            throw new RuntimeException("ç„¡æ³•å»ºç«‹å„²å­˜ç›®éŒ„: " + e.getMessage(), e);
        }

        // 5. é€ä¸€è™•ç†æª”æ¡ˆ
        List<AttachmentResponseDto> results = new ArrayList<>();
        for (MultipartFile file : files) {
            // 5.1 é©—è­‰æª”æ¡ˆ
            validateFile(file);

            // 5.2 ç”Ÿæˆå”¯ä¸€æª”å
            String storedName = generateUniqueStoredName(ticketId, file.getOriginalFilename());

            // 5.3 å„²å­˜æª”æ¡ˆ
            Path targetPath = ticketDir.resolve(storedName);
            try {
                Files.copy(file.getInputStream(), targetPath, StandardCopyOption.REPLACE_EXISTING);
            } catch (IOException e) {
                throw new RuntimeException("æª”æ¡ˆå„²å­˜å¤±æ•—: " + e.getMessage(), e);
            }

            // 5.4 å»ºç«‹ Entity
            MaintenanceTicketAttachment attachment = new MaintenanceTicketAttachment();
            attachment.setTicket(ticket);
            attachment.setTicketId(ticketId);
            attachment.setOriginalName(sanitizeFileName(file.getOriginalFilename()));
            attachment.setStoredName(storedName);
            attachment.setContentType(file.getContentType());
            attachment.setFileSize(file.getSize());
            attachment.setPublicUrl(String.format("/images/maintenance/tickets/%d/%s", ticketId, storedName));
            attachment.setSortOrder(nextSortOrder++);
            attachment.setNote(note);
            attachment.setIsActive(true);

            // 5.5 å„²å­˜åˆ° DB
            MaintenanceTicketAttachment saved = attachmentRepo.save(attachment);
            results.add(new AttachmentResponseDto(saved));

            log.info(" é™„ä»¶ä¸Šå‚³æˆåŠŸ: ticketId={}, attachmentId={}, storedName={}", 
                    ticketId, saved.getAttachmentId(), storedName);
        }

        return results;
    }

    /**
     * æŸ¥è©¢å·¥å–®çš„æ‰€æœ‰å•Ÿç”¨é™„ä»¶
     */
    @Transactional(readOnly = true)
    public List<AttachmentResponseDto> getAttachments(Integer ticketId) {
        // é©—è­‰å·¥å–®æ˜¯å¦å­˜åœ¨
        if (!ticketRepo.existsById(ticketId)) {
            throw new IllegalArgumentException("æ‰¾ä¸åˆ°å·¥å–® ID: " + ticketId);
        }

        List<MaintenanceTicketAttachment> attachments = attachmentRepo
                .findByTicketIdAndIsActiveTrueOrderBySortOrderAscCreatedAtDesc(ticketId);

        return attachments.stream()
                .map(AttachmentResponseDto::new)
                .toList();
    }

    /**
     * åˆªé™¤é™„ä»¶ï¼ˆè»Ÿåˆªé™¤ï¼‰
     */
    public AttachmentResponseDto deleteAttachment(Integer attachmentId) {
        // 1. æŸ¥è©¢é™„ä»¶
        MaintenanceTicketAttachment attachment = attachmentRepo.findById(attachmentId)
                .orElseThrow(() -> new IllegalArgumentException("æ‰¾ä¸åˆ°é™„ä»¶ ID: " + attachmentId));

        // 2. è»Ÿåˆªé™¤ï¼ˆè¨­å®š isActive = falseï¼‰
        attachment.setIsActive(false);
        MaintenanceTicketAttachment updated = attachmentRepo.save(attachment);

        // 3. å˜—è©¦åˆªé™¤å¯¦é«”æª”æ¡ˆï¼ˆå¤±æ•—ä¸å½±éŸ¿ API å›æ‡‰ï¼‰
        try {
            Path filePath = Paths.get(uploadBasePath, "maintenance", "tickets", 
                    attachment.getTicketId().toString(), attachment.getStoredName())
                    .toAbsolutePath().normalize();

            if (Files.exists(filePath)) {
                Files.delete(filePath);
                log.info("âœ… å¯¦é«”æª”æ¡ˆå·²åˆªé™¤: {}", filePath);
            } else {
                log.warn("âš ï¸ å¯¦é«”æª”æ¡ˆä¸å­˜åœ¨: {}", filePath);
            }
        } catch (Exception e) {
            log.error("âŒ åˆªé™¤å¯¦é«”æª”æ¡ˆå¤±æ•—ï¼ˆä¸å½±éŸ¿ API å›æ‡‰ï¼‰: {}", e.getMessage());
        }

        log.info("âœ… é™„ä»¶å·²è»Ÿåˆªé™¤: attachmentId={}, ticketId={}", attachmentId, attachment.getTicketId());
        return new AttachmentResponseDto(updated);
    }

    // ==================== ç§æœ‰æ–¹æ³• ====================

    /**
     * é©—è­‰æª”æ¡ˆ
     */
    private void validateFile(MultipartFile file) {
        // é©—è­‰æ˜¯å¦ç‚ºç©º
        if (file.isEmpty()) {
            throw new IllegalArgumentException("æª”æ¡ˆä¸å¯ç‚ºç©º");
        }

        // é©—è­‰æª”æ¡ˆé¡å‹
        String contentType = file.getContentType();
        if (contentType == null || !ALLOWED_CONTENT_TYPES.contains(contentType.toLowerCase())) {
            throw new IllegalArgumentException(
                    String.format("ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼: %sï¼ˆåƒ…å…è¨± %sï¼‰", contentType, String.join(", ", ALLOWED_CONTENT_TYPES))
            );
        }

        // é©—è­‰æª”æ¡ˆå¤§å°
        if (file.getSize() > MAX_FILE_SIZE) {
            throw new IllegalArgumentException(
                    String.format("æª”æ¡ˆå¤§å°è¶…éé™åˆ¶ï¼ˆæœ€å¤§ %.2f MBï¼‰", MAX_FILE_SIZE / 1024.0 / 1024.0)
            );
        }
    }

    /**
     * ç”Ÿæˆå”¯ä¸€çš„å„²å­˜æª”åï¼ˆUUID + åŸå‰¯æª”åï¼‰
     * é˜²æ­¢é‡è¤‡ï¼Œç¢ºä¿æ»¿è¶³ UX_mta_ticket_storedName å”¯ä¸€æ€§ç´„æŸ
     */
    private String generateUniqueStoredName(Integer ticketId, String originalFilename) {
        String extension = "";
        if (originalFilename != null && originalFilename.contains(".")) {
            extension = originalFilename.substring(originalFilename.lastIndexOf(".")).toLowerCase();
        }

        String storedName;
        int attempts = 0;
        do {
            storedName = UUID.randomUUID().toString() + extension;
            attempts++;
            if (attempts > 10) {
                throw new RuntimeException("ç„¡æ³•ç”Ÿæˆå”¯ä¸€æª”åï¼ˆå˜—è©¦æ¬¡æ•¸éå¤šï¼‰");
            }
        } while (attachmentRepo.existsByTicketIdAndStoredName(ticketId, storedName));

        return storedName;
    }

    /**
     * æ·¨åŒ–æª”åï¼ˆé˜²æ­¢è·¯å¾‘ç©¿è¶Šæ”»æ“Šï¼‰
     */
    private String sanitizeFileName(String filename) {
        if (filename == null || filename.isBlank()) {
            return "unknown";
        }
        // åªå–æª”æ¡ˆåç¨±ï¼ˆç§»é™¤è·¯å¾‘ï¼‰
        return Paths.get(filename).getFileName().toString();
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/service/member/AdminService.java">
package com.example.backend.service.member;

import java.util.List;

import org.springframework.dao.DataIntegrityViolationException;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.example.backend.model.member.Admin;
import com.example.backend.repository.member.AdminRepository;

@Service
@Transactional
public class AdminService {

    private final AdminRepository adminRepository;

    public AdminService(AdminRepository adminRepository) {
        this.adminRepository = adminRepository;
    }

    // å¯†ç¢¼é©—è­‰
    private void validatePassword(String password) {
        String pwdRule = "^(?=.*[A-Za-z])[A-Za-z\\d!@#$%^&*()_+=\\[\\]{}:;\"'<>,.?/\\-]{6,}$";

        if (password == null || !password.matches(pwdRule)) {
            throw new IllegalArgumentException(
                    "å¯†ç¢¼æ ¼å¼éŒ¯èª¤ï¼šè‡³å°‘6ç¢¼ï¼Œéœ€åŒ…å«è‡³å°‘1å€‹è‹±æ–‡å­—æ¯");
        }
    }

    private void normalize(Admin admin) {
        admin.setAdmUsername(admin.getAdmUsername().trim());
        admin.setAdmEmail(admin.getAdmEmail().trim().toLowerCase());
    }

    // æŸ¥å…¨éƒ¨ï¼ˆfindAllAdminsï¼‰
    public List<Admin> findAll() {
        return adminRepository.findAll();
    }

    // æŸ¥å–®ç­†ï¼ˆfindAdminByIdï¼‰
    public Admin findById(Integer admId) {
        return adminRepository.findById(admId).orElse(null);
    }

    // ç™»å…¥ç”¨ï¼ˆfindByUsernameï¼‰
    public Admin findByUsername(String admUsername) {
        return adminRepository.findByAdmUsername(admUsername);
    }

    // æ–°å¢ç®¡ç†å“¡ï¼ˆsaveAdminï¼‰
    public void insert(Admin admin) {
        validatePassword(admin.getAdmPassword());
        normalize(admin);

        if (adminRepository.existsByAdmUsername(admin.getAdmUsername())) {
            throw new IllegalArgumentException("ç®¡ç†å“¡å¸³è™Ÿå·²å­˜åœ¨");
        }

        if (adminRepository.existsByAdmEmail(admin.getAdmEmail())) {
            throw new IllegalArgumentException("Email å·²å­˜åœ¨");
        }

        adminRepository.save(admin);
    }

    // æ›´æ–°ç®¡ç†å“¡ï¼ˆupdateAdminï¼‰
    public void update(Admin admin) {
        normalize(admin);
        adminRepository.save(admin);
    }

    // åˆªé™¤ç®¡ç†å“¡ï¼ˆdeleteAdminï¼‰
    public void deleteById(Integer admId) {
        adminRepository.deleteById(admId);
    }

    // æ¨¡ç³ŠæŸ¥è©¢
    public List<Admin> findByKeyword(String keyword) {
        if (keyword == null || keyword.isBlank()) {
            return adminRepository.findAll();
        }
        return adminRepository.findByKeyword(keyword);
    }

    // é€é Email å°‹æ‰¾ç®¡ç†å“¡ (ä¾› Controller æª¢æŸ¥æ˜¯å¦å­˜åœ¨)
    public Admin findByEmail(String email) {
        if (email == null)
            return null;
        return adminRepository.findByAdmEmail(email.trim().toLowerCase());
    }

    // é€é Email æ›´æ–°å¯†ç¢¼
    @Transactional
    public boolean updatePasswordByEmail(String email, String newPassword) {
        // å…ˆæª¢æŸ¥å¯†ç¢¼æ ¼å¼
        validatePassword(newPassword);

        Admin admin = adminRepository.findByAdmEmail(email.trim().toLowerCase());
        if (admin != null) {
            admin.setAdmPassword(newPassword);
            adminRepository.save(admin);
            return true;
        }
        return false;
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/service/member/MemberService.java">
package com.example.backend.service.member;

import java.util.List;

import org.springframework.dao.DataIntegrityViolationException;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.example.backend.model.member.Member;
import com.example.backend.repository.member.MemberRepository;

@Service
@Transactional
public class MemberService {

    private final MemberRepository memberRepository;

    public MemberService(MemberRepository memberRepository) {
        this.memberRepository = memberRepository;
    }

    // å¯†ç¢¼é©—è­‰
    private void validatePassword(String password) {
        String pwdRule = "^(?=.*[A-Za-z])[A-Za-z\\d!@#$%^&*()_+=\\[\\]{}:;\"'<>,.?/\\-]{6,}$";

        if (password == null || !password.matches(pwdRule)) {
            throw new IllegalArgumentException(
                    "å¯†ç¢¼æ ¼å¼éŒ¯èª¤ï¼šè‡³å°‘6ç¢¼ï¼Œéœ€åŒ…å«è‡³å°‘1å€‹è‹±æ–‡å­—æ¯");
        }
    }

    // æŸ¥å…¨éƒ¨
    public List<Member> findAll() {
        return memberRepository.findAll();
    }

    // æŸ¥å–®ç­†
    public Member findById(Integer memId) {
        return memberRepository.findById(memId).orElse(null);
    }

    // æ–°å¢ï¼ˆInsertMemberï¼‰
    public void insert(Member member) {
        validatePassword(member.getMemPassword());
        member.setMemStatus(1);
        try {
            memberRepository.save(member);
        } catch (DataIntegrityViolationException e) {

            throw new IllegalArgumentException("å¸³è™Ÿæˆ– Email å·²è¢«ä½¿ç”¨");
        }
    }

    // ä¿®æ”¹ï¼ˆUpdateMemberï¼‰
    public void update(Member old, String newPassword) {
        // å¦‚æœæœ‰æ–°å¯†ç¢¼ï¼Œå°±é©—è­‰ä¸¦è¨­å®š
        if (newPassword != null && !newPassword.isBlank()) {
            validatePassword(newPassword);
            old.setMemPassword(newPassword);
        }

        // ä¸ç®¡æœ‰æ²’æœ‰æ”¹å¯†ç¢¼ï¼Œæœ€å¾Œéƒ½è¦ save å‰©ä¸‹çš„æ¬„ä½ï¼ˆå¦‚å§“åã€é›»è©±ï¼‰
        memberRepository.save(old);
    }

    // åˆªé™¤ï¼ˆDeleteMemberï¼‰
    public void deleteById(Integer memId) {
        memberRepository.deleteById(memId);
    }

    // æ¨¡ç³ŠæŸ¥è©¢
    public List<Member> search(String keyword) {
        return memberRepository.findByKeyword(keyword);
    }

    // é€é Email å°‹æ‰¾æœƒå“¡ (å¿˜è¨˜å¯†ç¢¼ç”¨)
    public Member findByEmail(String email) {
        // é€™è£¡èª¿ç”¨ repository æ ¹æ“š Email æ‰¾äººï¼Œè«‹ç¢ºä¿ repository æœ‰å°æ‡‰çš„æ–¹æ³•
        return memberRepository.findByMemEmailIgnoreCase(email);
    }

    // é€é Email æ›´æ–°å¯†ç¢¼ (å¿˜è¨˜å¯†ç¢¼ç”¨)
    @Transactional
    public boolean updatePasswordByEmail(String email, String newPassword) {
        // 1. å…ˆæª¢æŸ¥å¯†ç¢¼æ ¼å¼
        validatePassword(newPassword);

        // 2. é€é email å°‹æ‰¾æœƒå“¡ (åŠ ä¸Š .orElse(null) è§£æ±ºå‹åˆ¥ä¸åŒ¹é…)
        Member member = memberRepository.findByMemEmail(email.trim().toLowerCase()).orElse(null);

        if (member != null) {
            // 3. è¨­å®šæ–°å¯†ç¢¼ä¸¦å­˜æª”
            member.setMemPassword(newPassword);
            memberRepository.save(member);
            return true;
        }
        return false;
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/service/merchantAndCoupon/PaymentService.java">
package com.example.backend.service.merchantAndCoupon;

import com.example.backend.model.merchantAndCoupon.SponsorshipRecord;
import com.example.backend.model.member.Member; // ğŸ’¡ å¼•å…¥æœƒå“¡ Model
import com.example.backend.repository.merchantAndCoupon.SponsorshipRepository;
import com.example.backend.repository.member.MemberRepository; // ğŸ’¡ å¼•å…¥æœƒå“¡ Repo
import com.example.backend.utils.EcpayUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.util.Map;

@Service
public class PaymentService {

    @Autowired
    private SponsorshipRepository sponsorshipRepository;

    @Autowired
    private MemberRepository memberRepository; // ğŸ’¡ æ³¨å…¥æœƒå“¡å€‰åº«

    @Autowired
    private EcpayUtils ecpayUtils;

    /**
     * 1. ç”¢è£½è´ŠåŠ©è¡¨å–®ä¸¦å­˜å…¥è³‡æ–™åº«
     */
    public String createSponsorshipOrder(Integer memberId, BigDecimal amount, String comment, String baseUrl) {
        String merchantTradeNo = "SPN" + System.currentTimeMillis();

        SponsorshipRecord record = new SponsorshipRecord();
        record.setMemberId(memberId);
        record.setAmount(amount);
        record.setMerchantTradeNo(merchantTradeNo);
        record.setSponsorComment(comment);
        record.setStatus(0);
        sponsorshipRepository.save(record);

        String itemName = "è´ŠåŠ©æ”¯æŒä¸¦ç²å–ç©åˆ†-" + amount;
        String amountStr = String.valueOf(amount.intValue());

        return ecpayUtils.genCheckOutForm(merchantTradeNo, amountStr, itemName, baseUrl);
    }

    /**
     * 2. æ›´æ–°æ”¯ä»˜ç‹€æ…‹ + è‡ªå‹•é€ç©åˆ† (è´ŠåŠ©æˆåŠŸå›å‘¼)
     */
    @Transactional
    public void processPaymentResult(Map<String, String> formData) {
        System.out.println(">>> é€²å…¥åŠ é»æµç¨‹ï¼Œè¨‚å–®ç·¨è™Ÿ: " + formData.get("MerchantTradeNo"));
        String merchantTradeNo = formData.get("MerchantTradeNo");
        String rtnCode = formData.get("RtnCode"); // "1" ä»£è¡¨æˆåŠŸ

        sponsorshipRepository.findByMerchantTradeNo(merchantTradeNo).ifPresent(record -> {
            // å¦‚æœé€™ç­†ç´€éŒ„åŸæœ¬æ˜¯å¾…æ”¯ä»˜(0)ï¼Œä¸”ç¾åœ¨å›å‚³æˆåŠŸ(1)
            if ("1".equals(rtnCode) && record.getStatus() == 0) {

                // A. æ›´æ–°è´ŠåŠ©ç´€éŒ„ç‹€æ…‹
                record.setStatus(1); // æˆåŠŸ
                record.setPaymentType(formData.get("PaymentType"));
                record.setTradeNo(formData.get("TradeNo"));
                // sponsorshipRepository.save(record); // @Transactional æœƒè‡ªå‹•è™•ç†

                // B. ğŸ’¡ åŸ·è¡Œã€Œè´ŠåŠ©é€ç©åˆ†ã€é‚è¼¯
                // é€™è£¡æˆ‘å€‘æ¯”ç…§ä½  GameController çš„é‚è¼¯ï¼š
                // è´ŠåŠ©å¤šå°‘éŒ¢å°±é€å¤šå°‘é» (1:1)ï¼Œä½ ä¹Ÿå¯ä»¥æ”¹æˆ record.getAmount() * 10

                int pointsToAdd = record.getAmount().intValue();

                memberRepository.findById(record.getMemberId()).ifPresent(member -> {
                    System.out.println(">>> æ‰¾åˆ°è³‡æ–™åº«ç´€éŒ„ï¼Œç›®å‰ç‹€æ…‹ç‚º: " + record.getStatus());
                    int currentPoints = member.getMemPoints();
                    member.setMemPoints(currentPoints + pointsToAdd);
                    memberRepository.save(member);
                    System.out.println("ã€ç³»çµ±è‡ªå‹•åŠ é»ã€‘æœƒå“¡ ID: " + member.getMemId() + " ç²è´ˆ " + pointsToAdd + " é»");
                });

            } else if (!"1".equals(rtnCode)) {
                record.setStatus(2); // å¤±æ•—
            }
        });
    }
}
</file>

<file path="backend/docs/COZE_TROUBLESHOOTING.md">
# Coze Web Chat SDK ç–‘é›£æ’è§£æŒ‡å—

## ğŸ“‹ ç³»çµ±æ¶æ§‹æª¢æŸ¥æ¸…å–®

### âœ… 1. å¾Œç«¯é…ç½®ï¼ˆBackendï¼‰

#### 1.1 ç’°å¢ƒè®Šæ•¸è¨­å®š
```bash
# åœ¨çµ‚ç«¯æ©Ÿè¨­å®šï¼ˆWindows PowerShellï¼‰
$env:COZE_BOT_ID="ä½ çš„Bot ID"
$env:COZE_PAT="ä½ çš„Personal Access Token"
$env:COZE_CHAT_SDK_SRC="https://lf-cdn.coze.cn/obj/unpkg/flow-platform/chat-app-sdk/1.0.0-beta.4/libs/oversea/index.js"
```

é©—è­‰æ–¹å¼ï¼š
```bash
# æª¢æŸ¥ç’°å¢ƒè®Šæ•¸æ˜¯å¦è¨­å®šæˆåŠŸ
echo $env:COZE_BOT_ID
echo $env:COZE_PAT
echo $env:COZE_CHAT_SDK_SRC
```

#### 1.2 Backend API æ¸¬è©¦
```bash
# å•Ÿå‹•å¾Œç«¯ï¼ˆåœ¨ backend/ ç›®éŒ„ä¸‹ï¼‰
mvn spring-boot:run

# æ¸¬è©¦ Bootstrap APIï¼ˆåœ¨æ–°çµ‚ç«¯æ©Ÿï¼‰
curl http://localhost:8080/api/support/coze/bootstrap
```

âœ… **é æœŸå›æ‡‰**ï¼ˆ200 OKï¼‰ï¼š
```json
{
  "botId": "7469370888888888888",
  "token": "pat_xxxxxxxxxxxx",
  "sdkSrc": "https://lf-cdn.coze.cn/obj/unpkg/flow-platform/chat-app-sdk/1.0.0-beta.4/libs/oversea/index.js",
  "expiresIn": 0,
  "serverTime": "2026-01-31T12:00:00",
  "note": "âš ï¸ PAT Token æé†’ï¼šæ­¤ Token æœ‰éæœŸæ™‚é–“ï¼ŒéæœŸå¾Œéœ€è¦é‡æ–°å»ºç«‹"
}
```

âŒ **å¸¸è¦‹éŒ¯èª¤**ï¼š
- **500 éŒ¯èª¤**ï¼šæª¢æŸ¥ç’°å¢ƒè®Šæ•¸æ˜¯å¦è¨­å®š
- **404 éŒ¯èª¤**ï¼šController æœªå•Ÿå‹•æˆ–è·¯å¾‘éŒ¯èª¤
- **CORS éŒ¯èª¤**ï¼šæª¢æŸ¥ SecurityConfig.java æ˜¯å¦å…è¨± /api/**

---

### âœ… 2. å‰ç«¯é…ç½®ï¼ˆFrontendï¼‰

#### 2.1 æª”æ¡ˆæª¢æŸ¥
ç¢ºèªä»¥ä¸‹æª”æ¡ˆå­˜åœ¨ä¸”è·¯å¾‘æ­£ç¢ºï¼š

```
frontend/
â”œâ”€â”€ .env
â”œâ”€â”€ vite.config.js
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ http.js                    âœ… baseURL: '/api'
â”‚   â”‚   â””â”€â”€ modules/
â”‚   â”‚       â””â”€â”€ support.js              âœ… getCozeBootstrap()
â”‚   â”œâ”€â”€ views/
â”‚   â”‚   â””â”€â”€ support/
â”‚   â”‚       â””â”€â”€ SupportCenterView.vue   âœ… initCozeChat()
â”‚   â””â”€â”€ router/
â”‚       â””â”€â”€ index.js                    âœ… /support, /support/report
```

#### 2.2 Axios é…ç½®æª¢æŸ¥
æª”æ¡ˆï¼š`frontend/src/api/http.js`

```javascript
const http = axios.create({
  baseURL: '/api', // âœ… å¿…é ˆæ˜¯ '/api'ï¼Œä¸èƒ½æ˜¯å®Œæ•´ URL
  timeout: 10000,
})
```

#### 2.3 API æ¨¡çµ„è·¯å¾‘æª¢æŸ¥
æª”æ¡ˆï¼š`frontend/src/api/modules/support.js`

```javascript
export const getCozeBootstrap = () => {
  return http.get('/support/coze/bootstrap') // âœ… ä¸åŠ  /api å‰ç¶´
}
```

å®Œæ•´è·¯å¾‘æ‹¼æ¥ï¼š
```
baseURL: '/api' + '/support/coze/bootstrap'
= '/api/support/coze/bootstrap'
â†’ Vite Proxy è½‰ç™¼ â†’ http://localhost:8080/api/support/coze/bootstrap
```

#### 2.4 Vite Proxy é…ç½®æª¢æŸ¥
æª”æ¡ˆï¼š`frontend/vite.config.js`

```javascript
export default defineConfig({
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:8080',
        changeOrigin: true,
        // âœ… ä¸éœ€è¦ rewriteï¼Œç›´æ¥è½‰ç™¼
      },
    },
  },
})
```

---

### âœ… 3. å‰ç«¯æ¸¬è©¦æ­¥é©Ÿ

#### 3.1 å•Ÿå‹•é–‹ç™¼ä¼ºæœå™¨
```bash
cd frontend
npm run dev
```

#### 3.2 ç€è¦½å™¨ Console æª¢æŸ¥
é–‹å•Ÿ Chrome DevToolsï¼ˆF12ï¼‰ï¼Œå‰å¾€ `/support` é é¢ï¼ŒæŸ¥çœ‹ Consoleï¼š

âœ… **æˆåŠŸåˆå§‹åŒ–**ï¼š
```
[Coze] é–‹å§‹è¼‰å…¥ Bootstrap é…ç½®...
[Coze] Bootstrap é…ç½®è¼‰å…¥æˆåŠŸ { botId: "7469370888888888888", sdkSrc: "https://...", expiresIn: 0 }
[Coze] ä½¿ç”¨ SDK ä¾†æº: https://lf-cdn.coze.cn/obj/unpkg/flow-platform/chat-app-sdk/1.0.0-beta.4/libs/oversea/index.js
[Coze] SDK è¼‰å…¥æˆåŠŸ
[Coze] ä½¿ç”¨è€… ID: member_123 æˆ– [åŒ¿åè¨ªå®¢]
[Coze] åˆå§‹åŒ–å®Œæˆ âœ…
```

âŒ **å¸¸è¦‹éŒ¯èª¤æ’æŸ¥**ï¼š

| éŒ¯èª¤è¨Šæ¯ | åŸå›  | è§£æ±ºæ–¹å¼ |
|---------|------|---------|
| `GET http://localhost:5173/api/api/support/coze/bootstrap 404` | è·¯å¾‘é‡è¤‡ï¼ˆapi/apiï¼‰ | ç¢ºèª `support.js` è·¯å¾‘ç‚º `/support/...`ï¼Œä¸æ˜¯ `/api/support/...` |
| `[Coze] Bootstrap é…ç½®ä¸å®Œæ•´ï¼ˆç¼ºå°‘ botId æˆ– tokenï¼‰` | å¾Œç«¯ç’°å¢ƒè®Šæ•¸æœªè¨­å®š | æª¢æŸ¥ `$env:COZE_BOT_ID` å’Œ `$env:COZE_PAT` |
| `Coze SDK è¼‰å…¥å¤±æ•—` | SDK ä¾†æº URL éŒ¯èª¤æˆ–ç¶²è·¯å•é¡Œ | æª¢æŸ¥ `COZE_CHAT_SDK_SRC` æ˜¯å¦æ­£ç¢º |
| `Access to XMLHttpRequest blocked by CORS` | CORS æœªæ­£ç¢ºé…ç½® | æª¢æŸ¥ `SecurityConfig.java` CORS è¨­å®š |

#### 3.3 Network Tab æª¢æŸ¥
åœ¨ Chrome DevTools â†’ Network Tabï¼ŒæŸ¥çœ‹ `/bootstrap` è«‹æ±‚ï¼š

âœ… **æˆåŠŸè«‹æ±‚**ï¼š
- **URL**ï¼š`http://localhost:5173/api/support/coze/bootstrap`
- **Method**ï¼šGET
- **Status**ï¼š200 OK
- **Response**ï¼šåŒ…å« `botId`, `token`, `sdkSrc`

âŒ **å¤±æ•—è«‹æ±‚**ï¼š
- **404 Not Found**ï¼šå¾Œç«¯ Controller è·¯å¾‘éŒ¯èª¤
- **500 Internal Server Error**ï¼šå¾Œç«¯ç’°å¢ƒè®Šæ•¸æœªè¨­å®š
- **CORS Error**ï¼šCORS æœªæ­£ç¢ºé…ç½®

---

## ğŸ”§ å¿«é€Ÿè¨ºæ–·æŒ‡ä»¤

### Windows PowerShell è¨ºæ–·è…³æœ¬
```powershell
# ==================== è¨ºæ–·è…³æœ¬ ====================

Write-Host "========================================" -ForegroundColor Cyan
Write-Host "Coze Web Chat SDK è¨ºæ–·å·¥å…·" -ForegroundColor Cyan
Write-Host "========================================`n" -ForegroundColor Cyan

# 1. æª¢æŸ¥ç’°å¢ƒè®Šæ•¸
Write-Host "ã€1ã€‘æª¢æŸ¥ç’°å¢ƒè®Šæ•¸..." -ForegroundColor Yellow
if ($env:COZE_BOT_ID) {
    Write-Host "  âœ… COZE_BOT_ID: $env:COZE_BOT_ID" -ForegroundColor Green
} else {
    Write-Host "  âŒ COZE_BOT_ID æœªè¨­å®š" -ForegroundColor Red
}

if ($env:COZE_PAT) {
    $maskedPat = $env:COZE_PAT.Substring(0, [Math]::Min(10, $env:COZE_PAT.Length)) + "..."
    Write-Host "  âœ… COZE_PAT: $maskedPat" -ForegroundColor Green
} else {
    Write-Host "  âŒ COZE_PAT æœªè¨­å®š" -ForegroundColor Red
}

if ($env:COZE_CHAT_SDK_SRC) {
    Write-Host "  âœ… COZE_CHAT_SDK_SRC: $env:COZE_CHAT_SDK_SRC" -ForegroundColor Green
} else {
    Write-Host "  âš ï¸  COZE_CHAT_SDK_SRC æœªè¨­å®šï¼ˆå°‡ä½¿ç”¨å‰ç«¯ .env çš„ fallbackï¼‰" -ForegroundColor Yellow
}

# 2. æª¢æŸ¥å¾Œç«¯æ˜¯å¦é‹è¡Œ
Write-Host "`nã€2ã€‘æª¢æŸ¥å¾Œç«¯æœå‹™..." -ForegroundColor Yellow
try {
    $response = Invoke-WebRequest -Uri "http://localhost:8080/api/support/coze/bootstrap" -Method GET -TimeoutSec 5
    if ($response.StatusCode -eq 200) {
        Write-Host "  âœ… å¾Œç«¯ Bootstrap API æ­£å¸¸é‹è¡Œ" -ForegroundColor Green
        Write-Host "  å›æ‡‰å…§å®¹: $($response.Content)" -ForegroundColor Gray
    }
} catch {
    Write-Host "  âŒ å¾Œç«¯ Bootstrap API ç„¡æ³•é€£æ¥" -ForegroundColor Red
    Write-Host "  éŒ¯èª¤: $($_.Exception.Message)" -ForegroundColor Red
    Write-Host "  è«‹ç¢ºèªå¾Œç«¯æ˜¯å¦å•Ÿå‹•: cd backend && mvn spring-boot:run" -ForegroundColor Yellow
}

# 3. æª¢æŸ¥å‰ç«¯é…ç½®æª”æ¡ˆ
Write-Host "`nã€3ã€‘æª¢æŸ¥å‰ç«¯é…ç½®æª”æ¡ˆ..." -ForegroundColor Yellow
$httpJsPath = "frontend/src/api/http.js"
if (Test-Path $httpJsPath) {
    $httpJsContent = Get-Content $httpJsPath -Raw
    if ($httpJsContent -match "baseURL:\s*['""]\/api['""]") {
        Write-Host "  âœ… http.js baseURL é…ç½®æ­£ç¢º: '/api'" -ForegroundColor Green
    } else {
        Write-Host "  âŒ http.js baseURL é…ç½®éŒ¯èª¤" -ForegroundColor Red
    }
} else {
    Write-Host "  âŒ æ‰¾ä¸åˆ° $httpJsPath" -ForegroundColor Red
}

$supportJsPath = "frontend/src/api/modules/support.js"
if (Test-Path $supportJsPath) {
    $supportJsContent = Get-Content $supportJsPath -Raw
    if ($supportJsContent -match "http\.get\(['""]\/support\/coze\/bootstrap['""]") {
        Write-Host "  âœ… support.js è·¯å¾‘é…ç½®æ­£ç¢º: '/support/coze/bootstrap'" -ForegroundColor Green
    } else {
        Write-Host "  âŒ support.js è·¯å¾‘é…ç½®éŒ¯èª¤ï¼ˆä¸æ‡‰è©²æœ‰ /api å‰ç¶´ï¼‰" -ForegroundColor Red
    }
} else {
    Write-Host "  âŒ æ‰¾ä¸åˆ° $supportJsPath" -ForegroundColor Red
}

Write-Host "`n========================================" -ForegroundColor Cyan
Write-Host "è¨ºæ–·å®Œæˆï¼" -ForegroundColor Cyan
Write-Host "========================================`n" -ForegroundColor Cyan
```

ä½¿ç”¨æ–¹å¼ï¼š
```powershell
# å°‡ä¸Šè¿°è…³æœ¬å„²å­˜ç‚º diagnose-coze.ps1ï¼Œç„¶å¾ŒåŸ·è¡Œ
.\diagnose-coze.ps1
```

---

## ğŸ¯ æœ€çµ‚æª¢æŸ¥æ¸…å–®

### Backendï¼ˆå¾Œç«¯ï¼‰
- [ ] ç’°å¢ƒè®Šæ•¸å·²è¨­å®šï¼ˆCOZE_BOT_ID, COZE_PAT, COZE_CHAT_SDK_SRCï¼‰
- [ ] application.yml æœ‰ `coze:` é…ç½®å€å¡Š
- [ ] SupportCozeController.java å­˜åœ¨ä¸”è·¯å¾‘ç‚º `/api/support/coze/bootstrap`
- [ ] åŸ·è¡Œ `curl http://localhost:8080/api/support/coze/bootstrap` å›å‚³ 200
- [ ] SecurityConfig.java å…è¨± `/api/**` ä¸”é…ç½® CORS

### Frontendï¼ˆå‰ç«¯ï¼‰
- [ ] http.js çš„ `baseURL: '/api'`
- [ ] support.js çš„è·¯å¾‘ç‚º `/support/coze/bootstrap`ï¼ˆä¸åŠ  /apiï¼‰
- [ ] SupportCenterView.vue æœ‰ `initCozeChat()` æ–¹æ³•
- [ ] vite.config.js æœ‰ proxy é…ç½® `'/api': { target: 'http://localhost:8080' }`
- [ ] .env æœ‰ `VITE_COZE_CHAT_SDK_SRC` fallback
- [ ] router/index.js æœ‰ `/support` å’Œ `/support/report` è·¯ç”±
- [ ] MainLayout.vue æœ‰å®¢æœå…¥å£é€£çµ

### Runtimeï¼ˆåŸ·è¡Œæ™‚ï¼‰
- [ ] å¾Œç«¯å•Ÿå‹•ç„¡éŒ¯èª¤è¨Šæ¯
- [ ] å‰ç«¯å•Ÿå‹•ç„¡éŒ¯èª¤è¨Šæ¯
- [ ] ç€è¦½å™¨ Console é¡¯ç¤º `[Coze] åˆå§‹åŒ–å®Œæˆ âœ…`
- [ ] Network Tab çœ‹åˆ° `/api/support/coze/bootstrap` è«‹æ±‚ä¸”å›å‚³ 200
- [ ] é é¢å³ä¸‹è§’å‡ºç¾ Coze èŠå¤©æ³¡æ³¡

---

## ğŸ“ å¸¸è¦‹å•é¡Œ FAQ

### Q1: ç‚ºä»€éº¼è·¯å¾‘æœƒè®Šæˆ `/api/api/support/...`ï¼Ÿ
**A**: åŸå› æ˜¯ `support.js` çš„è·¯å¾‘å¯«æˆ `/api/support/...`ï¼Œå°è‡´èˆ‡ `http.js` çš„ `baseURL: '/api'` é‡è¤‡æ‹¼æ¥ã€‚

**è§£æ±ºæ–¹å¼**ï¼š
```javascript
// âŒ éŒ¯èª¤å¯«æ³•
return http.get('/api/support/coze/bootstrap')

// âœ… æ­£ç¢ºå¯«æ³•
return http.get('/support/coze/bootstrap')
```

### Q2: æ³¡æ³¡æ²’æœ‰å‡ºç¾ï¼Œä½† Console é¡¯ç¤ºåˆå§‹åŒ–æˆåŠŸï¼Ÿ
**A**: å¯èƒ½æ˜¯ SDK ç‰ˆæœ¬æˆ–é…ç½®å•é¡Œã€‚

**æª¢æŸ¥æ­¥é©Ÿ**ï¼š
1. ç¢ºèª `window.__cozeClient` æ˜¯å¦å­˜åœ¨
2. ç¢ºèª `window.CozeWebSDK` æ˜¯å¦æˆåŠŸè¼‰å…¥
3. æª¢æŸ¥ SDK ä¾†æº URL æ˜¯å¦æ­£ç¢º
4. å˜—è©¦æ‰‹å‹•å‘¼å« `window.__cozeClient.open()` é–‹å•ŸèŠå¤©è¦–çª—

### Q3: Token éæœŸæ€éº¼è¾¦ï¼Ÿ
**A**: Coze PAT æœ‰éæœŸæ™‚é–“ï¼ŒéæœŸå¾Œéœ€è¦é‡æ–°å»ºç«‹ã€‚

**è™•ç†æ–¹å¼**ï¼š
1. ç™»å…¥ Coze å¹³å°
2. é‡æ–°å»ºç«‹ Personal Access Token
3. æ›´æ–°ç’°å¢ƒè®Šæ•¸ `COZE_PAT`
4. é‡æ–°å•Ÿå‹•å¾Œç«¯

å‰ç«¯å·²å¯¦ä½œè‡ªå‹•åˆ·æ–°æ©Ÿåˆ¶ï¼ˆ`onRefreshToken`ï¼‰ï¼Œæœƒåœ¨ Token å³å°‡éæœŸæ™‚è‡ªå‹•å‘¼å« bootstrap APIã€‚

### Q4: CORS éŒ¯èª¤æ€éº¼è§£æ±ºï¼Ÿ
**A**: ç¢ºèª SecurityConfig.java æœ‰ä»¥ä¸‹é…ç½®ï¼š

```java
@Bean
public CorsConfigurationSource corsConfigurationSource() {
    CorsConfiguration configuration = new CorsConfiguration();
    configuration.addAllowedOrigin("http://localhost:5173"); // Vite é–‹ç™¼ä¼ºæœå™¨
    configuration.addAllowedMethod("*");
    configuration.addAllowedHeader("*");
    configuration.setAllowCredentials(true);
    
    UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
    source.registerCorsConfiguration("/**", configuration);
    return source;
}
```

---

## ğŸš€ å¿«é€Ÿå•Ÿå‹•æµç¨‹

```bash
# ==================== çµ‚ç«¯æ©Ÿ 1ï¼šå•Ÿå‹•å¾Œç«¯ ====================
cd backend

# è¨­å®šç’°å¢ƒè®Šæ•¸ï¼ˆWindows PowerShellï¼‰
$env:COZE_BOT_ID="ä½ çš„Bot ID"
$env:COZE_PAT="ä½ çš„Personal Access Token"
$env:COZE_CHAT_SDK_SRC="https://lf-cdn.coze.cn/obj/unpkg/flow-platform/chat-app-sdk/1.0.0-beta.4/libs/oversea/index.js"

# å•Ÿå‹•å¾Œç«¯
mvn spring-boot:run

# ==================== çµ‚ç«¯æ©Ÿ 2ï¼šå•Ÿå‹•å‰ç«¯ ====================
cd frontend
npm run dev

# ==================== çµ‚ç«¯æ©Ÿ 3ï¼šæ¸¬è©¦ API ====================
# æ¸¬è©¦å¾Œç«¯ Bootstrap API
curl http://localhost:8080/api/support/coze/bootstrap

# é–‹å•Ÿç€è¦½å™¨å‰å¾€ http://localhost:5173/support
```

---

## ï¿½ chatapp 502/TLB éŒ¯èª¤å°ˆç« 

### å•é¡Œæè¿°

é»æ“Š Coze èŠå¤©æ³¡æ³¡å¾Œï¼ŒSDK å‘¼å« `https://api.coze.com/open-platform/sdk/chatapp` 
å›å‚³ `502 Bad Gateway`ï¼ŒResponse Header é¡¯ç¤º `server: TLB`ã€‚

**ç—‡ç‹€**ï¼š
- æ³¡æ³¡å¯ä»¥é¡¯ç¤ºï¼Œé»æ“Šå¯ä»¥é–‹å•Ÿ
- Console é¡¯ç¤ºåˆå§‹åŒ–æˆåŠŸ
- ä½†å°è©±æ¡†ç©ºç™½æˆ–é¡¯ç¤ºè¼‰å…¥ä¸­
- Network Tab çœ‹åˆ° chatapp è«‹æ±‚ 502

### å¯èƒ½åŸå› 

| åŸå›  | æ©Ÿç‡ | æ’æŸ¥æ–¹å¼ |
|------|------|---------|
| Coze æœå‹™ç«¯é–˜é“å•é¡Œ | é«˜ | ç­‰å¾… 5-10 åˆ†é˜é‡è©¦ |
| æœ¬åœ°ç¶²è·¯è¢«æ“‹ï¼ˆå…¬å¸ VPN/é˜²ç«ç‰†ï¼‰| ä¸­ | åˆ‡æ›æ‰‹æ©Ÿç†±é»æ¸¬è©¦ |
| DNS æ±¡æŸ“/è§£æå¤±æ•— | ä¸­ | åŸ·è¡Œ `nslookup api.coze.com` |
| Token ç„¡æ•ˆæˆ–éæœŸ | ä½ | æª¢æŸ¥å¾Œç«¯ bootstrap å›æ‡‰ |
| Bot ID éŒ¯èª¤ | ä½ | ç¢ºèª Coze å¹³å°è¨­å®š |

### è¨ºæ–·æ­¥é©Ÿ

#### Step 1ï¼šè¨˜éŒ„è¨ºæ–·è³‡è¨Š
åœ¨ Chrome DevTools â†’ Network Tab æ‰¾åˆ° `chatapp` è«‹æ±‚ï¼š

```
1. é»æ“Šå¤±æ•—çš„è«‹æ±‚
2. è¨˜éŒ„ Response Headers:
   - x-akamai-request-id: <è¨˜ä¸‹é€™å€‹å€¼>
   - server: TLB
   - date: <è¨˜ä¸‹æ™‚é–“>
3. æˆªåœ–ä¿å­˜
```

#### Step 2ï¼šç¶²è·¯åˆ‡æ›æ¸¬è©¦
```powershell
# æ¸¬è©¦ 1ï¼šä½¿ç”¨ç•¶å‰ç¶²è·¯
curl -I https://api.coze.com

# æ¸¬è©¦ 2ï¼šåˆ‡æ›æ‰‹æ©Ÿç†±é»
# é‡æ–°åŸ·è¡Œä¸Šè¿°å‘½ä»¤ï¼Œæ¯”è¼ƒçµæœ

# æ¸¬è©¦ 3ï¼šDNS è§£æ
nslookup api.coze.com
```

**é æœŸçµæœ**ï¼š
- æ­£å¸¸ï¼šHTTP 200 æˆ– 301/302
- ç•°å¸¸ï¼š502ã€é€£ç·šé€¾æ™‚ã€NXDOMAIN

#### Step 3ï¼šç¢ºèªå‰ç«¯é™ç´šæ©Ÿåˆ¶
```javascript
// åœ¨ Console åŸ·è¡Œ
window.__cozeClient  // æ‡‰è©²æœ‰å€¼
window.__coze_inited // æ‡‰è©²æ˜¯ true

// å˜—è©¦æ‰‹å‹•é–‹å•Ÿ
window.__cozeClient.open()
```

### è§£æ±ºæ–¹æ¡ˆ

#### æ–¹æ¡ˆ Aï¼šç­‰å¾…é‡è©¦ï¼ˆæœå‹™ç«¯å•é¡Œï¼‰
å¦‚æœæ˜¯ Coze æœå‹™ç«¯é–˜é“å•é¡Œï¼Œé€šå¸¸ 5-10 åˆ†é˜å¾Œæœƒæ¢å¾©ã€‚
å‰ç«¯å·²å¯¦ä½œè‡ªå‹•é‡è©¦æ©Ÿåˆ¶ï¼ˆ300ms â†’ 800ms â†’ 1500msï¼‰ã€‚

#### æ–¹æ¡ˆ Bï¼šåˆ‡æ›ç¶²è·¯ï¼ˆæœ¬åœ°ç¶²è·¯å•é¡Œï¼‰
1. é—œé–‰ VPN
2. ä½¿ç”¨æ‰‹æ©Ÿç†±é»
3. é‡æ–°è¼‰å…¥é é¢

#### æ–¹æ¡ˆ Cï¼šä½¿ç”¨é™ç´š UI
è‹¥å•é¡ŒæŒçºŒï¼Œå¼•å°ä½¿ç”¨è€…è‡³äººå·¥å®¢æœï¼š
1. é é¢æœƒé¡¯ç¤ºã€ŒCoze æœå‹™æš«æ™‚ä¸å¯ç”¨ã€
2. ã€Œäººå·¥å®¢æœå”åŠ©ã€å¡ç‰‡æœƒé¡¯ç¤ºã€Œæ¨è–¦ã€æ¨™ç±¤
3. é»æ“Šå‰å¾€å•é¡Œå›å ±é é¢

### ç›£æ§èˆ‡å›å ±

è‹¥éœ€å‘ Coze å®˜æ–¹å›å ±ï¼Œè«‹æä¾›ï¼š
1. `x-akamai-request-id`
2. ç™¼ç”Ÿæ™‚é–“ï¼ˆUTCï¼‰
3. Bot IDï¼ˆä¸å« Tokenï¼‰
4. éŒ¯èª¤æˆªåœ–

---

## ğŸ“ ç¶­è­·å»ºè­°

### å®šæœŸæª¢æŸ¥
- [ ] æ¯ 90 å¤©æ›´æ› Coze PAT Token
- [ ] æª¢æŸ¥ Coze SDK ç‰ˆæœ¬æ˜¯å¦æœ‰æ›´æ–°
- [ ] ç›£æ§å¾Œç«¯ logï¼Œç¢ºèª bootstrap API ç„¡ç•°å¸¸å‘¼å«
- [ ] ç¢ºèª useCozeChat.js é‡è©¦/é™ç´šæ©Ÿåˆ¶æ­£å¸¸é‹ä½œ

### ç›£æ§æŒ‡æ¨™
- Bootstrap API å‘¼å«æ¬¡æ•¸
- Token åˆ·æ–°é »ç‡
- åˆå§‹åŒ–å¤±æ•—ç‡
- 502/TLB éŒ¯èª¤ç™¼ç”Ÿé »ç‡
- é™ç´š UI é¡¯ç¤ºæ¬¡æ•¸
- ä½¿ç”¨è€…æ»¿æ„åº¦ï¼ˆChat ä½¿ç”¨ç‡ï¼‰

---

**æœ€å¾Œæ›´æ–°**ï¼š2026-02-01  
**ç¶­è­·è€…**ï¼šTake@Seat é–‹ç™¼åœ˜éšŠ
</file>

<file path="backend/src/main/java/com/example/backend/config/ProjectionValidConfig.java">
package com.example.backend.config;

import com.example.backend.repository.rec.RecRentAnalyzeRepository;
import com.example.backend.repository.spot.RentalSpotRepository;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.boot.CommandLineRunner;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Profile;

import java.util.List;

@Configuration
public class ProjectionValidConfig {

    private static final Logger log = LoggerFactory.getLogger(ProjectionValidConfig.class);

    /**
     * å•Ÿå‹•æ™‚è‡ªå‹•åŸ·è¡Œ Projection æ˜ å°„æª¢æŸ¥
     * å»ºè­°åªåœ¨ 'dev' æˆ– 'test' ç’°å¢ƒåŸ·è¡Œï¼Œé¿å…å½±éŸ¿ç”Ÿç”¢ç’°å¢ƒå•Ÿå‹•é€Ÿåº¦
     */
    @Bean
    @Profile("dev") // è‹¥æ‚¨æ²’æœ‰è¨­å®š profileï¼Œå¯æš«æ™‚è¨»è§£æ‰é€™è¡Œ
    public CommandLineRunner validateAnalyzeProjections(
            RentalSpotRepository spotRepo,
            RecRentAnalyzeRepository analyzeRepo) {
        return args -> {
            log.info("==========================================");
            log.info(" [è‡ªæˆ‘æª¢æŸ¥] é–‹å§‹é©—è­‰ Projection SQL åˆ¥åæ˜ å°„...");

            // æª¢æŸ¥ 1: ç¸£å¸‚åˆ†ä½ˆ
            validate(() -> spotRepo.getCityDistribution(), "SpotCountByCity (ç¸£å¸‚åˆ†ä½ˆ)");

            // æª¢æŸ¥ 2: ç«™é»å³æ™‚ç›£æ§
            validate(() -> spotRepo.getSpotRealtimeStatus(), "SpotMonitor (å³æ™‚ç›£æ§)");

            // æª¢æŸ¥ 3: æ™‚æ®µç†±åº¦
            validate(() -> analyzeRepo.getHourlyHeatMap(null, null), "HourlyRate (æ™‚æ®µç†±åº¦)");

            // æª¢æŸ¥ 4: æ™‚é•·çµ±è¨ˆ
            validate(() -> analyzeRepo.getDurationStats(null, null), "DurationRate (æ™‚é•·çµ±è¨ˆ)");

            log.info("==========================================");
        };
    }

    private void validate(java.util.function.Supplier<List<?>> query, String checkName) {
        try {
            List<?> result = query.get();
            // æ³¨æ„ï¼šå¦‚æœè³‡æ–™åº«æ˜¯ç©ºçš„ï¼Œé€™è£¡ä¸æœƒæ‹‹å‡ºæ˜ å°„éŒ¯èª¤ï¼Œå¿…é ˆè¦æœ‰æ¸¬è©¦è³‡æ–™æ‰æº–ç¢º
            if (result.isEmpty()) {
                log.warn("âš ï¸ [WARN] {} - ç„¡è³‡æ–™å¯é©—è­‰ (è«‹ç¢ºä¿ DB æœ‰æ¸¬è©¦æ•¸æ“š)", checkName);
            } else {
                // å˜—è©¦è®€å–ç¬¬ä¸€ç­†è³‡æ–™çš„æ¬„ä½ï¼Œè§¸ç™¼ Getter æ˜ å°„
                Object firstItem = result.get(0);
                log.info("âœ… [PASS] {} - æ˜ å°„æˆåŠŸ (å›å‚³ {} ç­†) Sample: {}", checkName, result.size(), firstItem);
            }
        } catch (Exception e) {
            log.error("âŒ [FAIL] {} - æ˜ å°„å¤±æ•—! è«‹æª¢æŸ¥ SQL åˆ¥åèˆ‡ Interface Getter æ˜¯å¦ä¸€è‡´ã€‚", checkName);
            log.error("   éŒ¯èª¤è¨Šæ¯: {}", e.getMessage());
            // è‹¥å¸Œæœ›æª¢æŸ¥å¤±æ•—å°±åœæ­¢å•Ÿå‹•ï¼Œå¯å–æ¶ˆä¸‹è¡Œè¨»è§£
            // throw new RuntimeException("Projection Mapping Failed: " + checkName, e);
        }
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/controller/rec/RentDetailsController.java">
package com.example.backend.controller.rec;

import java.time.LocalDate;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.format.annotation.DateTimeFormat;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import com.example.backend.dto.rec.DailyOrderCountDTO;
import com.example.backend.dto.rec.HourlyOrderCountDTO;
import com.example.backend.dto.rec.MonthlyOrderCountDTO;
import com.example.backend.dto.rec.OrderStatusStatsDTO;
import com.example.backend.dto.rec.RentalDurationDTO;
import com.example.backend.dto.rec.RentalDurationStatsDTO;
import com.example.backend.model.rec.RentDetails;
import com.example.backend.repository.rec.RentDetailsRepository;
import com.example.backend.service.rec.RecDetailMgnService;

@RestController
@RequestMapping("/api/rent-details")
@CrossOrigin // å…è¨±å‰ç«¯è·¨åŸŸå‘¼å«
public class RentDetailsController {

    @Autowired
    private RentDetailsRepository rentDetailsRepository;

    @Autowired
    private RecDetailMgnService recDetailMgnService;

    // 1. æœå°‹å…¨éƒ¨
    @GetMapping("/all")
    public List<RentDetails> getAll() {
        return rentDetailsRepository.findAll();
    }

    // 2. ä¾ recID æœå°‹
    @GetMapping("/{id}")
    public RentDetails getById(@PathVariable String id) {
        return rentDetailsRepository.findById(id).orElse(null);
    }

    // 3. ä¾æ™‚é–“å€é–“å–å¾—æ¯æœˆè¨‚å–®çµ±è¨ˆæ•¸æ“š
    @GetMapping("/stats/monthly-orders")
    public ResponseEntity<List<MonthlyOrderCountDTO>> getMonthlyOrderStats(
            @RequestParam("startDate") @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate startDate,
            @RequestParam("endDate") @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate endDate) {
        List<MonthlyOrderCountDTO> stats = recDetailMgnService.getMonthlyOrderCounts(startDate, endDate);
        return ResponseEntity.ok(stats);
    }

    // 4. ä¾æ™‚é–“å€é–“å–å¾—è¨‚å–®ç‹€æ…‹çµ±è¨ˆï¼ˆåœ“é¤…åœ–ï¼‰
    @GetMapping("/stats/order-status")
    public ResponseEntity<List<OrderStatusStatsDTO>> getOrderStatusStats(
            @RequestParam("startDate") @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate startDate,
            @RequestParam("endDate") @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate endDate) {
        List<OrderStatusStatsDTO> stats = recDetailMgnService.getOrderStatusStats(startDate, endDate);
        return ResponseEntity.ok(stats);
    }

    // 5. ä¾æ™‚é–“å€é–“å–å¾—è¨‚å–®ç§Ÿå€Ÿæ™‚é•·ï¼ˆæ•£ä½ˆåœ–ï¼‰
    @GetMapping("/stats/rental-duration")
    public ResponseEntity<List<RentalDurationDTO>> getRentalDurations(
            @RequestParam("startDate") @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate startDate,
            @RequestParam("endDate") @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate endDate) {
        List<RentalDurationDTO> stats = recDetailMgnService.getRentalDurations(startDate, endDate);
        return ResponseEntity.ok(stats);
    }

    // 6. ä¾æ™‚é–“å€é–“å–å¾—æ¯å°æ™‚è¨‚å–®çµ±è¨ˆ
    @GetMapping("/stats/hourly-orders")
    public ResponseEntity<List<HourlyOrderCountDTO>> getHourlyOrderStats(
            @RequestParam("startDate") @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate startDate,
            @RequestParam("endDate") @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate endDate) {
        List<HourlyOrderCountDTO> stats = recDetailMgnService.getHourlyOrderCounts(startDate, endDate);
        return ResponseEntity.ok(stats);
    }

    // 7. ä¾æ™‚é–“å€é–“å–å¾—æ¯æ—¥è¨‚å–®çµ±è¨ˆ
    @GetMapping("/stats/daily-orders")
    public ResponseEntity<List<DailyOrderCountDTO>> getDailyOrderStats(
            @RequestParam("startDate") @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate startDate,
            @RequestParam("endDate") @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate endDate) {
        List<DailyOrderCountDTO> stats = recDetailMgnService.getDailyOrderCounts(startDate, endDate);
        return ResponseEntity.ok(stats);
    }

    // 8. ä¾æ™‚é–“å€é–“å–å¾—ç§Ÿå€Ÿæ™‚é•·çµ±è¨ˆ (30åˆ†é˜é–“éš”)
    @GetMapping("/stats/rental-duration-intervals")
    public ResponseEntity<List<RentalDurationStatsDTO>> getRentalDurationStats(
            @RequestParam("startDate") @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate startDate,
            @RequestParam("endDate") @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate endDate) {
        List<RentalDurationStatsDTO> stats = recDetailMgnService.getRentalDurationStats(startDate, endDate);
        return ResponseEntity.ok(stats);
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/controller/support/SupportCozeController.java">
package com.example.backend.controller.support;

import com.example.backend.dto.support.CozeBootstrapResponseDto;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.*;
import org.springframework.web.bind.annotation.*;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.URL;
import java.nio.charset.StandardCharsets;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.*;

/**
 * Support Coze Controller
 * 
 * ã€é‡æ§‹èªªæ˜ã€‘2026-02-01
 * - ç§»é™¤ WebSDK/chatapp æ•´åˆï¼ˆå·²ç¢ºèª 502 TLB å•é¡Œç„¡æ³•è§£æ±ºï¼‰
 * - æ”¹ç”¨ Coze OpenAPIï¼ˆPOST /v3/chatï¼‰
 * - å¾Œç«¯ä½œç‚º Proxyï¼Œå‰ç«¯ä¸ç›´æ¥æ¥è§¸ PAT
 * 
 * ç«¯é»ï¼š
 * - GET  /api/support/coze/bootstrap  â†’ é…ç½®è³‡è¨Šï¼ˆä¿ç•™ç›¸å®¹ï¼‰
 * - POST /api/support/coze/chat       â†’ OpenAPI Proxyï¼ˆæ–°å¢ï¼‰
 * - GET  /api/support/coze/status     â†’ API ç‹€æ…‹æª¢æŸ¥ï¼ˆæ–°å¢ï¼‰
 * 
 * å®‰å…¨æ€§ï¼š
 * 1. PAT åƒ…åœ¨å¾Œç«¯ä½¿ç”¨ï¼Œä¸å‚³çµ¦å‰ç«¯
 * 2. ä¸åœ¨ log å°å‡ºå®Œæ•´ token
 */
@RestController
@RequestMapping("/api/support/coze")
public class SupportCozeController {

    private static final Logger log = LoggerFactory.getLogger(SupportCozeController.class);
    
    // ==================== BEGIN: OpenAPI å¸¸æ•¸ ====================
    private static final String COZE_API_BASE = "https://api.coze.com";
    private static final String COZE_CHAT_ENDPOINT = "/v3/chat";
    private static final int API_TIMEOUT_MS = 30000;
    private static final int MAX_RETRIES = 2;
    
    private final ObjectMapper objectMapper = new ObjectMapper();
    // ==================== END: OpenAPI å¸¸æ•¸ ====================

    /**
     * Coze Bot ID
     * è¨­å®šæ–¹å¼ï¼šapplication.yml çš„ coze.bot-id æˆ–ç’°å¢ƒè®Šæ•¸ COZE_BOT_ID
     */
    @Value("${coze.bot-id:}")
    private String botId;

    /**
     * Coze Personal Access Token (PAT)
     * è¨­å®šæ–¹å¼ï¼šapplication.yml çš„ coze.pat æˆ–ç’°å¢ƒè®Šæ•¸ COZE_PAT
     * 
     * æ³¨æ„ï¼šPAT æœ‰ä»¥ä¸‹ç‰¹æ€§
     * 1. åªèƒ½åœ¨å»ºç«‹æ™‚çœ‹åˆ°ä¸€æ¬¡ï¼Œç„¡æ³•å†æ¬¡æŸ¥çœ‹
     * 2. éæœŸå¾Œç„¡æ³•å»¶é•·ï¼Œåªèƒ½é‡æ–°å»ºç«‹
     * 3. å»ºè­°å®šæœŸæ›´æ›ï¼ˆä¾‹å¦‚ï¼šæ¯ 90 å¤©ï¼‰
     */
    @Value("${coze.pat:}")
    private String pat;

    /**
     * Coze Web Chat SDK Script ä¾†æº URL
     * è¨­å®šæ–¹å¼ï¼šapplication.yml çš„ coze.chat-sdk-src æˆ–ç’°å¢ƒè®Šæ•¸ COZE_CHAT_SDK_SRC
     * 
     * é è¨­å€¼ï¼šCoze å®˜æ–¹ CDN
     */
    @Value("${coze.chat-sdk-src:}")
    private String chatSdkSrc;

    /**
     * å¹³å°æç¤ºï¼ˆç”¨æ–¼è¨ºæ–·ï¼‰
     * ä¾‹å¦‚ "coze.com" æˆ– "coze.cn"
     */
    @Value("${coze.platform-hint:coze.com}")
    private String platformHint;

    /**
     * API ä¸»æ©Ÿæç¤ºï¼ˆç”¨æ–¼å‰ç«¯è¨ºæ–·é€£é€šæ€§ï¼‰
     */
    @Value("${coze.api-host-hint:api.coze.com}")
    private String apiHostHint;

    // ==================== BEGIN: RestTemplate for OpenAPI ====================
    // ç§»é™¤ RestTemplateï¼Œæ”¹ç”¨ HttpURLConnection ä¾†è™•ç† SSE
    
    public SupportCozeController() {
        // ä¸å†éœ€è¦ RestTemplate
    }
    
    /**
     * é®ç½© PAT ç”¨æ–¼ logï¼ˆåªé¡¯ç¤ºå‰å¾Œå„ 4 å­—å…ƒï¼‰
     */
    private String maskToken(String token) {
        if (token == null || token.length() < 12) return "***";
        return token.substring(0, 4) + "..." + token.substring(token.length() - 4);
    }
    // ==================== END: RestTemplate ====================

    // ==================== BEGIN: OpenAPI ç‹€æ…‹æª¢æŸ¥ ====================
    /**
     * GET /api/support/coze/status
     * 
     * æª¢æŸ¥ Coze OpenAPI é…ç½®æ˜¯å¦å®Œæ•´ï¼ˆä¸åŸ·è¡Œå¯¦éš› API å‘¼å«ï¼‰
     * ç”¨æ–¼å‰ç«¯åˆ¤æ–·æ˜¯å¦å¯é–‹å•ŸèŠå¤©
     */
    @GetMapping("/status")
    public ResponseEntity<?> checkApiStatus() {
        Map<String, Object> result = new HashMap<>();
        result.put("timestamp", LocalDateTime.now().toString());
        
        // é©—è­‰é…ç½®æ˜¯å¦å®Œæ•´
        if (botId == null || botId.trim().isEmpty()) {
            result.put("status", "unconfigured");
            result.put("message", "Bot ID æœªè¨­å®š");
            result.put("available", false);
            return ResponseEntity.ok(result);
        }
        
        if (pat == null || pat.trim().isEmpty()) {
            result.put("status", "unconfigured");
            result.put("message", "PAT Token æœªè¨­å®š");
            result.put("available", false);
            return ResponseEntity.ok(result);
        }
        
        // é…ç½®å®Œæ•´ï¼Œæ¨™è¨˜ç‚ºå¯ç”¨
        // å¯¦éš› API å¯ç”¨æ€§æœƒåœ¨ /chat ç«¯é»å‘¼å«æ™‚é©—è­‰
        result.put("status", "available");
        result.put("message", "OpenAPI é…ç½®å®Œæ•´ï¼Œå¯é–‹å§‹å°è©±");
        result.put("available", true);
        result.put("mode", "openapi");
        result.put("botId", botId);
        
        log.info("âœ… Coze OpenAPI ç‹€æ…‹æª¢æŸ¥é€šé - Bot ID: {}", botId);
        
        return ResponseEntity.ok(result);
    }
    // ==================== END: OpenAPI ç‹€æ…‹æª¢æŸ¥ ====================

    // ==================== BEGIN: OpenAPI Chat Proxy (SSE Stream Mode) ====================
    /**
     * POST /api/support/coze/chat
     * 
     * Coze OpenAPI Proxy - ä½¿ç”¨ stream=true æ¨¡å¼
     * 
     * ã€é‡è¦ã€‘Coze V3 Chat API åœ¨ stream=false æ™‚åªæœƒå›å‚³ç‹€æ…‹ï¼ˆin_progressï¼‰ï¼Œ
     * å¿…é ˆä½¿ç”¨ stream=true ä¸¦è§£æ SSE äº‹ä»¶æµæ‰èƒ½å–å¾—å®Œæ•´å›è¦†ã€‚
     * 
     * SSE äº‹ä»¶é¡å‹ï¼š
     * - conversation.message.delta: å¢é‡å›è¦†ç‰‡æ®µ
     * - conversation.message.completed: è¨Šæ¯å®Œæˆ
     * - conversation.chat.completed: å°è©±å®Œæˆ
     * - conversation.chat.failed: å°è©±å¤±æ•—
     * - error: éŒ¯èª¤
     * 
     * Request Body:
     * {
     *   "message": "ä½¿ç”¨è€…è¨Šæ¯",
     *   "userId": "user_xxx"ï¼ˆå¯é¸ï¼‰
     *   "conversationId": "conv_xxx"ï¼ˆå¯é¸ï¼‰
     * }
     */
    @PostMapping("/chat")
    public ResponseEntity<?> chat(@RequestBody Map<String, Object> request) {
        Map<String, Object> result = new HashMap<>();
        String requestId = UUID.randomUUID().toString().substring(0, 8);
        result.put("requestId", requestId);
        
        // ===== Step 1: é©—è­‰é…ç½® =====
        if (botId == null || botId.trim().isEmpty()) {
            log.warn("[{}] âš ï¸ Chat å¤±æ•—: Bot ID æœªè¨­å®š", requestId);
            result.put("success", false);
            result.put("error", "æœå‹™é…ç½®ä¸å®Œæ•´");
            return ResponseEntity.status(HttpStatus.SERVICE_UNAVAILABLE).body(result);
        }
        
        if (pat == null || pat.trim().isEmpty()) {
            log.warn("[{}] âš ï¸ Chat å¤±æ•—: PAT æœªè¨­å®š", requestId);
            result.put("success", false);
            result.put("error", "æœå‹™é…ç½®ä¸å®Œæ•´");
            return ResponseEntity.status(HttpStatus.SERVICE_UNAVAILABLE).body(result);
        }
        
        // ===== Step 2: å–å¾—ä½¿ç”¨è€…è¨Šæ¯ =====
        String userMessage = (String) request.get("message");
        if (userMessage == null || userMessage.trim().isEmpty()) {
            result.put("success", false);
            result.put("error", "è¨Šæ¯ä¸å¯ç‚ºç©º");
            return ResponseEntity.badRequest().body(result);
        }
        
        String userId = (String) request.getOrDefault("userId", "user_" + requestId);
        String conversationId = (String) request.get("conversationId");
        
        log.info("[{}] ğŸ“¤ Chat è«‹æ±‚ - userId: {}, message é•·åº¦: {}, PAT: {}", 
                requestId, userId, userMessage.length(), maskToken(pat));
        
        // ===== Step 3: å‘¼å« Coze OpenAPI (SSE æ¨¡å¼) =====
        int retryAttempt = 0;
        Exception lastException = null;
        
        while (retryAttempt <= MAX_RETRIES) {
            try {
                SseParseResult sseResult = callCozeApiWithSse(
                    requestId, userMessage, userId, conversationId, retryAttempt
                );
                
                if (sseResult.success) {
                    result.put("success", true);
                    result.put("replyText", sseResult.replyText);
                    result.put("conversationId", sseResult.conversationId);
                    result.put("chatId", sseResult.chatId);
                    
                    log.info("[{}] âœ… Chat æˆåŠŸ - conversationId: {}, å›è¦†é•·åº¦: {}", 
                            requestId, sseResult.conversationId, sseResult.replyText.length());
                    
                    return ResponseEntity.ok(result);
                } else {
                    // æ¥­å‹™éŒ¯èª¤ï¼ˆä¸é‡è©¦ï¼‰
                    if (sseResult.isBusinessError) {
                        result.put("success", false);
                        result.put("error", sseResult.errorMessage);
                        result.put("errorCode", sseResult.errorCode);
                        result.put("isBusinessError", true);
                        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(result);
                    }
                    
                    // å…¶ä»–éŒ¯èª¤ï¼Œå¯èƒ½éœ€è¦é‡è©¦
                    lastException = new RuntimeException(sseResult.errorMessage);
                }
                
            } catch (Exception e) {
                lastException = e;
                log.warn("[{}] âš ï¸ ç¬¬ {} æ¬¡å˜—è©¦å¤±æ•—: {}", requestId, retryAttempt + 1, e.getMessage());
            }
            
            retryAttempt++;
            if (retryAttempt <= MAX_RETRIES) {
                try {
                    Thread.sleep(500 * retryAttempt); // æŒ‡æ•¸é€€é¿
                } catch (InterruptedException ie) {
                    Thread.currentThread().interrupt();
                    break;
                }
            }
        }
        
        // æ‰€æœ‰é‡è©¦éƒ½å¤±æ•—
        log.error("[{}] âŒ Chat å¤±æ•—ï¼ˆå·²é‡è©¦ {} æ¬¡ï¼‰: {}", 
                requestId, MAX_RETRIES, lastException != null ? lastException.getMessage() : "Unknown");
        result.put("success", false);
        result.put("error", "é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
        return ResponseEntity.status(HttpStatus.BAD_GATEWAY).body(result);
    }
    
    /**
     * SSE è§£æçµæœ
     */
    private static class SseParseResult {
        boolean success = false;
        String replyText = "";
        String conversationId;
        String chatId;
        String errorMessage;
        Integer errorCode;
        boolean isBusinessError = false;
    }
    
    /**
     * å‘¼å« Coze API ä¸¦è§£æ SSE äº‹ä»¶æµ
     */
    private SseParseResult callCozeApiWithSse(
            String requestId, 
            String userMessage, 
            String userId, 
            String conversationId,
            int attempt) throws Exception {
        
        SseParseResult result = new SseParseResult();
        HttpURLConnection conn = null;
        
        try {
            // ===== å»ºç«‹é€£ç·š =====
            URL url = new URL(COZE_API_BASE + COZE_CHAT_ENDPOINT);
            conn = (HttpURLConnection) url.openConnection();
            conn.setRequestMethod("POST");
            conn.setConnectTimeout(API_TIMEOUT_MS);
            conn.setReadTimeout(API_TIMEOUT_MS);
            conn.setDoOutput(true);
            
            // ===== è¨­å®š Header =====
            conn.setRequestProperty("Content-Type", "application/json");
            conn.setRequestProperty("Authorization", "Bearer " + pat);
            conn.setRequestProperty("Accept", "text/event-stream"); // é—œéµï¼šæ¥å— SSE
            
            // ===== å»ºæ§‹è«‹æ±‚ Body =====
            Map<String, Object> cozeRequest = new HashMap<>();
            cozeRequest.put("bot_id", botId);
            cozeRequest.put("user_id", userId);
            cozeRequest.put("stream", true);  // é—œéµï¼šå•Ÿç”¨ä¸²æµæ¨¡å¼
            cozeRequest.put("auto_save_history", true);
            
            // additional_messages
            List<Map<String, Object>> messages = new ArrayList<>();
            Map<String, Object> userMsg = new HashMap<>();
            userMsg.put("role", "user");
            userMsg.put("content", userMessage);
            userMsg.put("content_type", "text");
            messages.add(userMsg);
            cozeRequest.put("additional_messages", messages);
            
            // è‹¥æœ‰ conversationIdï¼ŒåŠ å…¥è«‹æ±‚
            if (conversationId != null && !conversationId.isEmpty()) {
                cozeRequest.put("conversation_id", conversationId);
            }
            
            String requestBody = objectMapper.writeValueAsString(cozeRequest);
            
            log.info("[{}] ğŸ“¡ å‘¼å« Coze OpenAPI (SSE, ç¬¬ {} æ¬¡): {}", 
                    requestId, attempt + 1, url);
            
            // ===== ç™¼é€è«‹æ±‚ =====
            try (java.io.OutputStream os = conn.getOutputStream()) {
                os.write(requestBody.getBytes(StandardCharsets.UTF_8));
            }
            
            int responseCode = conn.getResponseCode();
            log.info("[{}] ğŸ“¥ HTTP å›æ‡‰ç¢¼: {}", requestId, responseCode);
            
            // ===== è™•ç†é 2xx å›æ‡‰ =====
            if (responseCode != 200) {
                String errorBody = readErrorStream(conn);
                log.error("[{}] âŒ Coze API éŒ¯èª¤ - HTTP {}: {}", requestId, responseCode, errorBody);
                
                // å˜—è©¦è§£æéŒ¯èª¤è¨Šæ¯
                try {
                    JsonNode errorJson = objectMapper.readTree(errorBody);
                    int code = errorJson.path("code").asInt(0);
                    String msg = errorJson.path("msg").asText("API éŒ¯èª¤");
                    
                    result.errorCode = code;
                    result.errorMessage = mapCozeErrorMessage(code, msg);
                    result.isBusinessError = (code >= 4000 && code < 5000);
                } catch (Exception e) {
                    result.errorMessage = "HTTP " + responseCode;
                }
                
                return result;
            }
            
            // ===== è§£æ SSE äº‹ä»¶æµ =====
            StringBuilder replyBuffer = new StringBuilder();
            String currentConversationId = null;
            String currentChatId = null;
            String logId = null;
            
            try (BufferedReader reader = new BufferedReader(
                    new InputStreamReader(conn.getInputStream(), StandardCharsets.UTF_8))) {
                
                String line;
                String currentEvent = null;
                StringBuilder dataBuffer = new StringBuilder();
                
                while ((line = reader.readLine()) != null) {
                    // SSE æ ¼å¼: "event: xxx" æˆ– "data: xxx" æˆ–ç©ºè¡Œ
                    
                    if (line.startsWith("event:")) {
                        currentEvent = line.substring(6).trim();
                    } else if (line.startsWith("data:")) {
                        dataBuffer.append(line.substring(5).trim());
                    } else if (line.isEmpty() && dataBuffer.length() > 0) {
                        // ç©ºè¡Œè¡¨ç¤ºäº‹ä»¶çµæŸï¼Œè™•ç†äº‹ä»¶
                        String eventData = dataBuffer.toString();
                        dataBuffer.setLength(0);
                        
                        if ("[DONE]".equals(eventData)) {
                            log.info("[{}] ğŸ“¥ SSE çµæŸæ¨™è¨˜ [DONE]", requestId);
                            break;
                        }
                        
                        try {
                            JsonNode json = objectMapper.readTree(eventData);
                            
                            // è¨˜éŒ„ logid
                            if (json.has("logid")) {
                                logId = json.get("logid").asText();
                            }
                            
                            // æ ¹æ“šäº‹ä»¶é¡å‹è™•ç†
                            if ("conversation.message.delta".equals(currentEvent)) {
                                // å¢é‡å›è¦†
                                String content = json.path("content").asText("");
                                if (!content.isEmpty()) {
                                    replyBuffer.append(content);
                                }
                            } else if ("conversation.chat.created".equals(currentEvent)) {
                                // å°è©±å»ºç«‹ï¼Œå–å¾— conversation_id
                                currentConversationId = json.path("conversation_id").asText();
                                currentChatId = json.path("id").asText();
                                log.info("[{}] ğŸ“¥ å°è©±å»ºç«‹ - conversationId: {}, chatId: {}", 
                                        requestId, currentConversationId, currentChatId);
                            } else if ("conversation.message.completed".equals(currentEvent)) {
                                // è¨Šæ¯å®Œæˆï¼Œå¯èƒ½åŒ…å«å®Œæ•´å›è¦†
                                String role = json.path("role").asText();
                                String type = json.path("type").asText();
                                if ("assistant".equals(role) && "answer".equals(type)) {
                                    String content = json.path("content").asText("");
                                    if (!content.isEmpty() && replyBuffer.length() == 0) {
                                        // å¦‚æœ delta æ²’æœ‰ç´¯ç©åˆ°å…§å®¹ï¼Œç”¨ completed çš„å®Œæ•´å…§å®¹
                                        replyBuffer.append(content);
                                    }
                                }
                            } else if ("conversation.chat.completed".equals(currentEvent)) {
                                // å°è©±å®Œæˆ
                                log.info("[{}] ğŸ“¥ å°è©±å®Œæˆ - logId: {}", requestId, logId);
                            } else if ("conversation.chat.failed".equals(currentEvent) || 
                                       "error".equals(currentEvent)) {
                                // éŒ¯èª¤
                                int code = json.path("code").asInt(0);
                                String msg = json.path("msg").asText(json.path("message").asText("éŒ¯èª¤"));
                                log.error("[{}] âŒ SSE éŒ¯èª¤äº‹ä»¶ - code: {}, msg: {}, logId: {}", 
                                        requestId, code, msg, logId);
                                
                                result.errorCode = code;
                                result.errorMessage = mapCozeErrorMessage(code, msg);
                                result.isBusinessError = (code >= 4000 && code < 5000);
                                return result;
                            }
                            
                        } catch (Exception e) {
                            log.warn("[{}] âš ï¸ è§£æ SSE data å¤±æ•—: {}", requestId, e.getMessage());
                        }
                        
                        currentEvent = null;
                    }
                }
            }
            
            // ===== çµ„è£çµæœ =====
            String finalReply = replyBuffer.toString().trim();
            
            if (finalReply.isEmpty()) {
                log.warn("[{}] âš ï¸ SSE è§£æå®Œæˆä½†ç„¡å›è¦†å…§å®¹", requestId);
                result.errorMessage = "AI æœªç”¢ç”Ÿå›è¦†";
                return result;
            }
            
            result.success = true;
            result.replyText = finalReply;
            result.conversationId = currentConversationId;
            result.chatId = currentChatId;
            
            log.info("[{}] âœ… SSE è§£ææˆåŠŸ - å›è¦†é•·åº¦: {}, é è¦½: {}", 
                    requestId, finalReply.length(), 
                    finalReply.length() > 50 ? finalReply.substring(0, 50) + "..." : finalReply);
            
            return result;
            
        } finally {
            if (conn != null) {
                conn.disconnect();
            }
        }
    }
    
    /**
     * è®€å–éŒ¯èª¤å›æ‡‰
     */
    private String readErrorStream(HttpURLConnection conn) {
        try {
            java.io.InputStream errorStream = conn.getErrorStream();
            if (errorStream == null) return "";
            
            try (BufferedReader reader = new BufferedReader(
                    new InputStreamReader(errorStream, StandardCharsets.UTF_8))) {
                StringBuilder sb = new StringBuilder();
                String line;
                while ((line = reader.readLine()) != null) {
                    sb.append(line);
                }
                return sb.toString();
            }
        } catch (Exception e) {
            return "";
        }
    }
    
    /**
     * å°‡ Coze éŒ¯èª¤ç¢¼è½‰æ›ç‚ºä½¿ç”¨è€…å‹å¥½è¨Šæ¯
     */
    private String mapCozeErrorMessage(Integer code, String originalMsg) {
        if (code == null) return "æœªçŸ¥éŒ¯èª¤";
        
        switch (code) {
            case 4100:
                return "æˆæ¬Šå¤±æ•—ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡";
            case 4101:
                return "Bot æœªç™¼å¸ƒæˆ–ç„¡å­˜å–æ¬Šé™";
            case 4102:
                return "Bot ID ç„¡æ•ˆ";
            case 4015:
                return "Bot å°šæœªç™¼å¸ƒåˆ° API Channelï¼Œè«‹è¯ç¹«ç®¡ç†å“¡è¨­å®š";
            case 4200:
                return "è«‹æ±‚æ ¼å¼éŒ¯èª¤";
            default:
                return originalMsg != null ? originalMsg : "æœå‹™éŒ¯èª¤ (" + code + ")";
        }
    }
    // ==================== END: OpenAPI Chat Proxy ====================

    // ==================== BEGIN: Bootstrapï¼ˆä¿ç•™ç›¸å®¹ï¼‰ ====================
    /**
     * GET /api/support/coze/bootstrap
     * 
     * å›æ‡‰æ ¼å¼ï¼ˆå·²èª¿æ•´ï¼Œç§»é™¤ tokenï¼‰ï¼š
     * {
     *   "botId": "7469370888888888888",
     *   "mode": "openapi",
     *   "serverTime": "2026-01-31T12:00:00",
     *   "note": "å·²æ”¹ç”¨ OpenAPI æ¨¡å¼"
     * }
     * 
     * æ³¨æ„ï¼šä¸å†å›å‚³ tokenï¼Œå‰ç«¯æ”¹ç”¨ /chat proxy
     * 
     * @return CozeBootstrapResponseDto
     */
    @GetMapping("/bootstrap")
    public ResponseEntity<?> getBootstrapConfig() {
        // ==================== Step 1ï¼šé©—è­‰å¿…è¦é…ç½®ï¼ˆå›å‚³ 400 è€Œé 500ï¼‰ ====================
        if (botId == null || botId.trim().isEmpty()) {
            log.warn("âš ï¸ Coze Bot ID æœªè¨­å®š");
            
            Map<String, Object> errorResponse = new HashMap<>();
            errorResponse.put("message", "Coze é…ç½®ä¸å®Œæ•´ï¼šç¼ºå°‘ Bot ID");
            errorResponse.put("hint", "è«‹åœ¨ application.yml è¨­å®š coze.bot-id æˆ–ç’°å¢ƒè®Šæ•¸ COZE_BOT_ID");
            errorResponse.put("status", 400);
            errorResponse.put("timestamp", LocalDateTime.now().toString());
            
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(errorResponse);
        }

        if (pat == null || pat.trim().isEmpty()) {
            log.warn("âš ï¸ Coze PAT Token æœªè¨­å®š");
            
            Map<String, Object> errorResponse = new HashMap<>();
            errorResponse.put("message", "Coze é…ç½®ä¸å®Œæ•´ï¼šç¼ºå°‘ PAT Token");
            errorResponse.put("hint", "è«‹åœ¨ application.yml è¨­å®š coze.pat æˆ–ç’°å¢ƒè®Šæ•¸ COZE_PAT");
            errorResponse.put("status", 400);
            errorResponse.put("timestamp", LocalDateTime.now().toString());
            
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(errorResponse);
        }

        // ==================== Step 2ï¼šå»ºç«‹å›æ‡‰ï¼ˆOpenAPI æ¨¡å¼ï¼Œä¸å›å‚³ tokenï¼‰ ====================
        Map<String, Object> response = new HashMap<>();
        response.put("botId", botId);
        response.put("mode", "openapi"); // æ¨™ç¤ºç‚º OpenAPI æ¨¡å¼
        response.put("serverTime", LocalDateTime.now().format(DateTimeFormatter.ISO_DATE_TIME));
        response.put("note", "å·²æ”¹ç”¨ OpenAPI æ¨¡å¼ï¼ŒèŠå¤©è«‹ä½¿ç”¨ POST /api/support/coze/chat");
        response.put("platformHint", platformHint);
        response.put("apiHostHint", apiHostHint);
        response.put("available", true);

        // ==================== Step 3ï¼šLog è¼¸å‡ºï¼ˆä¸å° tokenï¼‰ ====================
        log.info("âœ… Coze Bootstrap é…ç½®å·²æä¾› (OpenAPI æ¨¡å¼) - Bot ID: {}, Platform: {}", 
                botId, platformHint);

        return ResponseEntity.ok(response);
    }
    // ==================== END: Bootstrap ====================
}
</file>

<file path="backend/src/main/java/com/example/backend/dto/maintenance/SpotOptionDto.java">
package com.example.backend.dto.maintenance;

public class SpotOptionDto {
    private Integer spotId;
    private String spotCode;
    private String spotName;
    private String spotAddress;
    private String spotStatus;

    //  ç¶“ç·¯åº¦æ¬„ä½ï¼ˆå‰ç«¯åœ°åœ–ç”¨ï¼‰
    // å»ºè­°ç”¨ Doubleï¼ˆJSON å‹å–„ã€å‰ç«¯ä¹Ÿå¥½è™•ç†ï¼‰
    private Double latitude;
    private Double longitude;

    public SpotOptionDto() {}

    //  èˆŠå»ºæ§‹å­ï¼šä¸å½±éŸ¿æ—¢æœ‰ç¨‹å¼ï¼ˆä¾‹å¦‚ä¸‹æ‹‰é¸å–®åªéœ€è¦åŸºæœ¬æ¬„ä½ï¼‰
    public SpotOptionDto(Integer spotId, String spotCode, String spotName, String spotAddress, String spotStatus) {
        this.spotId = spotId;
        this.spotCode = spotCode;
        this.spotName = spotName;
        this.spotAddress = spotAddress;
        this.spotStatus = spotStatus;
    }

    //  æ–°å»ºæ§‹å­ï¼šçµ¦ã€Œéœ€è¦åœ°åœ–åº§æ¨™ã€çš„æƒ…å¢ƒä½¿ç”¨
    public SpotOptionDto(
            Integer spotId,
            String spotCode,
            String spotName,
            String spotAddress,
            String spotStatus,
            Double latitude,
            Double longitude
    ) {
        this.spotId = spotId;
        this.spotCode = spotCode;
        this.spotName = spotName;
        this.spotAddress = spotAddress;
        this.spotStatus = spotStatus;
        this.latitude = latitude;
        this.longitude = longitude;
    }

    public Integer getSpotId() { return spotId; }
    public void setSpotId(Integer spotId) { this.spotId = spotId; }

    public String getSpotCode() { return spotCode; }
    public void setSpotCode(String spotCode) { this.spotCode = spotCode; }

    public String getSpotName() { return spotName; }
    public void setSpotName(String spotName) { this.spotName = spotName; }

    public String getSpotAddress() { return spotAddress; }
    public void setSpotAddress(String spotAddress) { this.spotAddress = spotAddress; }

    public String getSpotStatus() { return spotStatus; }
    public void setSpotStatus(String spotStatus) { this.spotStatus = spotStatus; }

    //  getter / setterï¼šå‰ç«¯åœ°åœ–è®€ allSpots.value[n].latitude / longitude
    public Double getLatitude() { return latitude; }
    public void setLatitude(Double latitude) { this.latitude = latitude; }

    public Double getLongitude() { return longitude; }
    public void setLongitude(Double longitude) { this.longitude = longitude; }
}
</file>

<file path="backend/src/main/java/com/example/backend/dto/support/CozeBootstrapResponseDto.java">
package com.example.backend.dto.support;

/**
 * Coze Web Chat SDK Bootstrap API å›æ‡‰ DTO
 * 
 * ç”¨é€”ï¼šæä¾›å‰ç«¯åˆå§‹åŒ– Coze SDK æ‰€éœ€çš„é…ç½®è³‡è¨Š
 * 
 * æ³¨æ„ï¼š
 * 1. token æ¬„ä½å«æ•æ„Ÿè³‡è¨Šï¼ŒtoString() å·²åšé®è”½è™•ç†
 * 2. expiresIn è‹¥ç„¡æ³•å–å¾—å¯è¨­ç‚º 0 æˆ– null
 * 3. æ–°å¢è¨ºæ–·æ¬„ä½ï¼šplatformHint, sdkMode, apiHostHint
 */
public class CozeBootstrapResponseDto {
    
    /**
     * Coze Bot IDï¼ˆå…¬é–‹è³‡è¨Šï¼‰
     */
    private String botId;
    
    /**
     * èªè­‰ Tokenï¼ˆæ•æ„Ÿè³‡è¨Šï¼Œéœ€ä¿å¯†ï¼‰
     */
    private String token;
    
    /**
     * Coze SDK Script ä¾†æº URL
     */
    private String sdkSrc;
    
    /**
     * Token éæœŸæ™‚é–“ï¼ˆç§’ï¼‰ï¼Œè‹¥ç„¡æ³•å–å¾—å¯ç‚º null
     */
    private Integer expiresIn;
    
    /**
     * ä¼ºæœå™¨æ™‚é–“ï¼ˆISO-8601 æ ¼å¼ï¼‰
     */
    private String serverTime;
    
    /**
     * å‚™è¨»è¨Šæ¯ï¼ˆä¾‹å¦‚ï¼šæé†’ PAT éæœŸæ™‚é–“ï¼‰
     */
    private String note;

    // ==================== æ–°å¢ï¼šè¨ºæ–·æ¬„ä½ ====================
    
    /**
     * å¹³å°æç¤ºï¼ˆä¾‹å¦‚ "coze.com" æˆ– "coze.cn"ï¼‰
     * ç”¨æ–¼è¨ºæ–·èˆ‡å€åˆ†ä¸åŒå€åŸŸçš„æœå‹™
     */
    private String platformHint;
    
    /**
     * å»ºè­°çš„ SDK è¼‰å…¥æ¨¡å¼ï¼ˆ"npm" | "script"ï¼‰
     * å‰ç«¯å¯æ ¹æ“šæ­¤æ¬„ä½æ±ºå®šè¼‰å…¥ç­–ç•¥
     */
    private String sdkMode;
    
    /**
     * API ä¸»æ©Ÿæç¤ºï¼ˆä¾‹å¦‚ "api.coze.com"ï¼‰
     * ç”¨æ–¼å‰ç«¯è¨ºæ–·é€£é€šæ€§
     */
    private String apiHostHint;

    // Constructors
    public CozeBootstrapResponseDto() {}

    public CozeBootstrapResponseDto(String botId, String token, String sdkSrc) {
        this.botId = botId;
        this.token = token;
        this.sdkSrc = sdkSrc;
    }

    // Getters and Setters
    public String getBotId() {
        return botId;
    }

    public void setBotId(String botId) {
        this.botId = botId;
    }

    public String getToken() {
        return token;
    }

    public void setToken(String token) {
        this.token = token;
    }

    public String getSdkSrc() {
        return sdkSrc;
    }

    public void setSdkSrc(String sdkSrc) {
        this.sdkSrc = sdkSrc;
    }

    public Integer getExpiresIn() {
        return expiresIn;
    }

    public void setExpiresIn(Integer expiresIn) {
        this.expiresIn = expiresIn;
    }

    public String getServerTime() {
        return serverTime;
    }

    public void setServerTime(String serverTime) {
        this.serverTime = serverTime;
    }

    public String getNote() {
        return note;
    }

    public void setNote(String note) {
        this.note = note;
    }

    public String getPlatformHint() {
        return platformHint;
    }

    public void setPlatformHint(String platformHint) {
        this.platformHint = platformHint;
    }

    public String getSdkMode() {
        return sdkMode;
    }

    public void setSdkMode(String sdkMode) {
        this.sdkMode = sdkMode;
    }

    public String getApiHostHint() {
        return apiHostHint;
    }

    public void setApiHostHint(String apiHostHint) {
        this.apiHostHint = apiHostHint;
    }

    /**
     * é‡å¯« toString()ï¼Œé¿å…å°å‡ºå®Œæ•´ token
     * åƒ…é¡¯ç¤ºå‰ 10 å­—å…ƒ + é®è”½ç¬¦è™Ÿ
     */
    @Override
    public String toString() {
        return "CozeBootstrapResponseDto{" +
                "botId='" + botId + '\'' +
                ", token='" + (token != null && token.length() > 10 
                        ? token.substring(0, 10) + "..." 
                        : "[HIDDEN]") + '\'' +
                ", sdkSrc='" + sdkSrc + '\'' +
                ", expiresIn=" + expiresIn +
                ", serverTime='" + serverTime + '\'' +
                ", platformHint='" + platformHint + '\'' +
                ", sdkMode='" + sdkMode + '\'' +
                ", apiHostHint='" + apiHostHint + '\'' +
                ", note='" + note + '\'' +
                '}';
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/repository/rec/RecRentAnalyzeRepository.java">
package com.example.backend.repository.rec;

import java.time.LocalDate;
import java.util.List;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import com.example.backend.model.rec.RecRent;
import com.example.backend.repository.projection.AnalyzeProjections.DurationRate;
import com.example.backend.repository.projection.AnalyzeProjections.HourlyRate;

/**
 * å°ˆé–€ç”¨æ–¼å„€è¡¨æ¿çµ±è¨ˆçš„ Repository
 */
@Repository
public interface RecRentAnalyzeRepository extends JpaRepository<RecRent, Integer> {

    // éœ€æ±‚ 3: æ¯æ—¥æ¯ä¸€æ™‚é–“ä¹‹ç†±åº¦ (å…¨ç«™ç¸½è¨ˆ)
    @Query(value = """
                SELECT
                    DATEPART(HOUR, recRentDT2) as hourofDay,
                    COUNT(*) as rentedCount
                FROM recRent
                WHERE (:startDate IS NULL OR recRentDT2 >= :startDate)
                  AND (:endDate IS NULL OR recRentDT2 < DATEADD(day, 1, :endDate))
                GROUP BY DATEPART(HOUR, recRentDT2)
                ORDER BY hourofDay
            """, nativeQuery = true)
    List<HourlyRate> getHourlyHeatMap(@Param("startDate") LocalDate startDate, @Param("endDate") LocalDate endDate);

    // éœ€æ±‚ 4: ä½¿ç”¨æ™‚é–“é•·çŸ­çµ±è¨ˆ
    @Query(value = """
                SELECT
                    CASE
                        WHEN DATEDIFF(MINUTE, recRentDT2, recReturnDT2) <= 60 THEN '1å°æ™‚å…§'
                        WHEN DATEDIFF(MINUTE, recRentDT2, recReturnDT2) <= 120 THEN '1-2å°æ™‚'
                        WHEN DATEDIFF(MINUTE, recRentDT2, recReturnDT2) <= 240 THEN '2-4å°æ™‚'
                        ELSE '4å°æ™‚ä»¥ä¸Š'
                    END as durationRange,
                    COUNT(*) as count
                FROM recRent
                WHERE recStatus = N'å·²å®Œæˆ' AND recReturnDT2 IS NOT NULL
                  AND (:startDate IS NULL OR recRentDT2 >= :startDate)
                  AND (:endDate IS NULL OR recRentDT2 < DATEADD(day, 1, :endDate))
                GROUP BY
                    CASE
                        WHEN DATEDIFF(MINUTE, recRentDT2, recReturnDT2) <= 60 THEN '1å°æ™‚å…§'
                        WHEN DATEDIFF(MINUTE, recRentDT2, recReturnDT2) <= 120 THEN '1-2å°æ™‚'
                        WHEN DATEDIFF(MINUTE, recRentDT2, recReturnDT2) <= 240 THEN '2-4å°æ™‚'
                        ELSE '4å°æ™‚ä»¥ä¸Š'
                    END
            """, nativeQuery = true)
    List<DurationRate> getDurationStats(@Param("startDate") LocalDate startDate, @Param("endDate") LocalDate endDate);
}
</file>

<file path="backend/src/main/java/com/example/backend/repository/rec/RentDetailsRepository.java">
package com.example.backend.repository.rec;

import java.time.LocalDateTime;
import java.util.List;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;

import com.example.backend.model.rec.RentDetails;

public interface RentDetailsRepository
                extends JpaRepository<RentDetails, String>, JpaSpecificationExecutor<RentDetails> {

        // JPQLæŸ¥è©¢ï¼Œç”¨æ–¼æŒ‰æœˆçµ±è¨ˆæŒ‡å®šæ™‚é–“ç¯„åœå…§çš„è¨‚å–®æ•¸é‡
        // è¿”å›Object[]è€Œä¸æ˜¯DTOï¼Œä»¥é¿å…JPAå¯¦ç¾ä¸­çš„æ§‹é€ å‡½æ•¸é¡å‹åŒ¹é…å•é¡Œ
        @Query("SELECT FUNCTION('YEAR', r.recRentDT2), FUNCTION('MONTH', r.recRentDT2), COUNT(r) " +
                        "FROM RentDetails r " +
                        "WHERE r.recRentDT2 BETWEEN :startDate AND :endDate " +
                        "GROUP BY FUNCTION('YEAR', r.recRentDT2), FUNCTION('MONTH', r.recRentDT2) " +
                        "ORDER BY FUNCTION('YEAR', r.recRentDT2), FUNCTION('MONTH', r.recRentDT2)")
        List<Object[]> findMonthlyOrderCounts(@Param("startDate") LocalDateTime startDate,
                        @Param("endDate") LocalDateTime endDate);

        // JPQLæŸ¥è©¢ï¼Œç”¨æ–¼çµ±è¨ˆæŒ‡å®šæ™‚é–“ç¯„åœå…§å„è¨‚å–®ç‹€æ…‹çš„æ•¸é‡ï¼ˆåœ“é¤…åœ–æ•¸æ“šï¼‰
        @Query("SELECT r.recStatus, COUNT(r) FROM RentDetails r " +
                        "WHERE r.recRentDT2 BETWEEN :startDate AND :endDate " +
                        "GROUP BY r.recStatus")
        List<Object[]> findOrderStatusStats(@Param("startDate") LocalDateTime startDate,
                        @Param("endDate") LocalDateTime endDate);

        // JPQLæŸ¥è©¢ï¼Œç”¨æ–¼ç²å–æŒ‡å®šæ™‚é–“ç¯„åœå…§è¨‚å–®çš„ç§Ÿå€Ÿæ™‚é–“ä¿¡æ¯ï¼ˆæ•£ä½ˆåœ–æ•¸æ“šï¼‰
        // ç¯©é¸æ‰recReturnDT2ç‚ºnullçš„ç´€éŒ„ï¼Œå› ç‚ºç„¡æ³•è¨ˆç®—æ™‚é•·
        @Query("SELECT r.recId, r.recRentDT2, r.recReturnDT2 FROM RentDetails r " +
                        "WHERE r.recRentDT2 BETWEEN :startDate AND :endDate AND r.recReturnDT2 IS NOT NULL")
        List<Object[]> findRentalDurations(@Param("startDate") LocalDateTime startDate,
                        @Param("endDate") LocalDateTime endDate);

        // æŸ¥è©¢ï¼šæŒ‰å°æ™‚çµ±è¨ˆè¨‚å–®æ•¸é‡ (é•·æ¢åœ–) - SQL Server ç‰ˆæœ¬
        @Query(value = "SELECT DATEPART(hour, recRentDT2), COUNT(*) " +
                        "FROM V_RentDetails " + // ä¿®æ­£ï¼šä½¿ç”¨æ­£ç¢ºçš„ View èˆ‡æ¬„ä½åç¨±
                        "WHERE recRentDT2 BETWEEN :startDate AND :endDate " +
                        "GROUP BY DATEPART(hour, recRentDT2) " +
                        "ORDER BY DATEPART(hour, recRentDT2)", nativeQuery = true)
        List<Object[]> findHourlyOrderCounts(@Param("startDate") LocalDateTime startDate,
                        @Param("endDate") LocalDateTime endDate);

        // æŸ¥è©¢ï¼šæŒ‰æ—¥çµ±è¨ˆè¨‚å–®æ•¸é‡ (æŠ˜ç·šåœ–) - SQL Server ç‰ˆæœ¬
        @Query(value = "SELECT CONVERT(varchar, recRentDT2, 23), COUNT(*) " +
                        "FROM V_RentDetails " + // ä¿®æ­£ï¼šä½¿ç”¨æ­£ç¢ºçš„ View èˆ‡æ¬„ä½åç¨±
                        "WHERE recRentDT2 BETWEEN :startDate AND :endDate " +
                        "GROUP BY CONVERT(varchar, recRentDT2, 23) " +
                        "ORDER BY CONVERT(varchar, recRentDT2, 23)", nativeQuery = true)
        List<Object[]> findDailyOrderCounts(@Param("startDate") LocalDateTime startDate,
                        @Param("endDate") LocalDateTime endDate);

        // æŸ¥è©¢ï¼šæŒ‰30åˆ†é˜é–“éš”çµ±è¨ˆç§Ÿå€Ÿæ™‚é•· - SQL Server ç‰ˆæœ¬
        @Query(value = "SELECT floor(DATEDIFF(minute, recRentDT2, recReturnDT2) / 30) AS interval_group, COUNT(*) "
                        +
                        "FROM V_RentDetails " + // ä¿®æ­£ï¼šä½¿ç”¨æ­£ç¢ºçš„ View èˆ‡æ¬„ä½åç¨±
                        "WHERE recRentDT2 BETWEEN :startDate AND :endDate AND recReturnDT2 IS NOT NULL " +
                        "GROUP BY floor(DATEDIFF(minute, recRentDT2, recReturnDT2) / 30) " +
                        "ORDER BY interval_group", nativeQuery = true)
        List<Object[]> findRentalDurationStatsIn30MinIntervals(@Param("startDate") LocalDateTime startDate,
                        @Param("endDate") LocalDateTime endDate);
}
</file>

<file path="backend/src/main/java/com/example/backend/service/maintenance/MaintenanceInformationService.java">
package com.example.backend.service.maintenance;

import com.example.backend.dto.maintenance.SpotOptionDto;
import com.example.backend.dto.maintenance.MaintenanceLogResponseDto;
import com.example.backend.model.maintenance.MaintenanceInformation;
import com.example.backend.model.maintenance.MaintenanceStaff;
import com.example.backend.model.spot.RentalSpot;
import com.example.backend.repository.maintenance.MaintenanceInformationRepository;
import com.example.backend.repository.maintenance.MaintenanceStaffRepository;
import com.example.backend.repository.spot.RentalSpotRepository;
import com.example.backend.repository.spot.SeatRepository; 
import com.example.backend.model.spot.Seat;
import com.example.backend.model.maintenance.MaintenanceLog;
import com.example.backend.repository.maintenance.MaintenanceLogRepository;

import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.Arrays;
import java.util.Comparator;
import java.util.List;

@Service
@Transactional
public class MaintenanceInformationService {

    // ç‹€æ…‹å¸¸æ•¸
    public static final String STATUS_REPORTED = "REPORTED";
    public static final String STATUS_ASSIGNED = "ASSIGNED";
    public static final String STATUS_UNDER_MAINTENANCE = "UNDER_MAINTENANCE";
    public static final String STATUS_RESOLVED = "RESOLVED";
    public static final String STATUS_CANCELLED = "CANCELLED";

    public static final String PRIORITY_LOW = "LOW";
    public static final String PRIORITY_NORMAL = "NORMAL";
    public static final String PRIORITY_HIGH = "HIGH";
    public static final String PRIORITY_URGENT = "URGENT";

    public static final String RESULT_FIXED = "FIXED";
    public static final String RESULT_MAINTAINED = "MAINTAINED"; //  æ–°å¢ï¼šå·²ä¿é¤Š
    public static final String RESULT_NOT_FIXED = "NOT_FIXED";
    public static final String RESULT_NO_ISSUE = "NO_ISSUE";
    public static final String RESULT_UNFIXABLE = "UNFIXABLE"; //  çµ±ä¸€ç‚º UNFIXABLE
    public static final String RESULT_OTHER = "OTHER";

    public static final String SPOT_STATUS_OPERATIONAL = "ç‡Ÿé‹ä¸­";
    public static final String SPOT_STATUS_MAINTENANCE = "ç¶­ä¿®ä¸­";
    public static final String SEAT_STATUS_ENABLED = "å•Ÿç”¨";
    public static final String SEAT_STATUS_REPAIRING = "ç¶­ä¿®ä¸­";
    
    private final MaintenanceInformationRepository mtifRepo;
    private final MaintenanceStaffRepository staffRepo;
    private final RentalSpotRepository rentalSpotRepo;
    private final SeatRepository seatRepo;
    private final MaintenanceLogRepository logRepo;

    public MaintenanceInformationService(MaintenanceInformationRepository mtifRepo,
                                         MaintenanceStaffRepository staffRepo,
                                         RentalSpotRepository rentalSpotRepo,
                                         SeatRepository seatRepo,
                                         MaintenanceLogRepository logRepo) {
        this.mtifRepo = mtifRepo;
        this.staffRepo = staffRepo;
        this.rentalSpotRepo = rentalSpotRepo;
        this.seatRepo = seatRepo;
        this.logRepo = logRepo;
    }

    public List<Seat> getAllSeats(){ return seatRepo.findAll(); }
    public List<Seat> getSeatsBySpot(Integer spotId){ return seatRepo.findBySpotId(spotId); }
    private boolean isBlank(String s) { return s == null || s.isBlank(); }

    @Transactional(readOnly = true)
    public List<Integer> getAllSpotIds(){
        return rentalSpotRepo.findAll().stream().map(RentalSpot::getSpotId).sorted().toList();
    }

    public List<SpotOptionDto> getSpotOptions(){
        return rentalSpotRepo.findAll().stream()
                .map(spot -> {
                    //  ä¿®æ­£åŸå› ï¼šå‰ç«¯åœ°åœ–åŠŸèƒ½éœ€è¦åº§æ¨™è³‡æ–™ï¼Œå°‡ RentalSpot çš„ BigDecimal è½‰ç‚º Double å‚³çµ¦å‰ç«¯
                    // ä½¿ç”¨æ–°å»ºæ§‹å­å‚³å…¥ latitude/longitudeï¼Œè‹¥ç‚º null å‰‡ä¿æŒ nullï¼ˆå‰ç«¯æœƒåˆ¤æ–·ï¼‰
                    Double lat = (spot.getLatitude() != null) ? spot.getLatitude().doubleValue() : null;
                    Double lng = (spot.getLongitude() != null) ? spot.getLongitude().doubleValue() : null;
                    
                    return new SpotOptionDto(
                        spot.getSpotId(), 
                        spot.getSpotCode(), 
                        spot.getSpotName(), 
                        spot.getSpotAddress(), 
                        spot.getSpotStatus(),
                        lat,  //  æ–°å¢ï¼šç¶“åº¦ï¼ˆå‰ç«¯åœ°åœ–ç”¨ï¼‰
                        lng   //  æ–°å¢ï¼šç·¯åº¦ï¼ˆå‰ç«¯åœ°åœ–ç”¨ï¼‰
                    );
                })
                .sorted(Comparator.comparingInt(SpotOptionDto::getSpotId)).toList();
    }

    // ============ å»ºç«‹ / æ›´æ–° / åˆªé™¤ ============

    public MaintenanceInformation createTicket(MaintenanceInformation mtif, String operator) {
        mtif.setTicketId(null);
        validateForCreate(mtif);
        validateAssignedStaff(mtif.getAssignedStaffId());

        mtif.setIssueType(mtif.getIssueType().trim());
        mtif.setIssueDesc(isBlank(mtif.getIssueDesc()) ? null : mtif.getIssueDesc().trim());

        if (isBlank(mtif.getIssuePriority())) {
            mtif.setIssuePriority(PRIORITY_NORMAL);
        } else {
            String p = mtif.getIssuePriority().trim().toUpperCase();
            if (!isValidPriority(p)) throw new IllegalArgumentException("ç„¡æ•ˆçš„å„ªå…ˆæ¬Š: " + p);
            mtif.setIssuePriority(p);
        }

        mtif.setIssueStatus(mtif.getAssignedStaffId() != null ? STATUS_ASSIGNED : STATUS_REPORTED);
        mtif.setStartAt(null);
        mtif.setResolvedAt(null);
        mtif.setResultType(null);
        mtif.setResolveNote(null);

        MaintenanceInformation saved = mtifRepo.save(mtif);
        
        String finalOperator = isBlank(operator) ? "ç³»çµ±ç®¡ç†å“¡" : operator;
        String comment = String.format("å»ºç«‹å·¥å–® | é¡å‹: %s | å„ªå…ˆæ¬Š: %s", saved.getIssueType(), saved.getIssuePriority());
        saveLog(saved, finalOperator, "CREATED", comment);

        if (saved.getAssignedStaffId() != null) {
            String staffName = staffRepo.findById(saved.getAssignedStaffId())
                    .map(MaintenanceStaff::getStaffName).orElse("æœªçŸ¥äººå“¡");
            saveLog(saved, finalOperator, "ASSIGNED", "æŒ‡æ´¾è² è²¬äºº: " + staffName);
        }
        
        return saved;
    }

    public MaintenanceInformation updateTicket(MaintenanceInformation mtif, String operator) {
        if (mtif.getTicketId() == null) throw new IllegalArgumentException("æ›´æ–°å·¥å–®æ™‚ ticketId ç‚ºå¿…å¡«æ¬„ä½");
        if (isBlank(mtif.getIssueType())) throw new IllegalArgumentException("issueType ç‚ºå¿…å¡«æ¬„ä½");
        MaintenanceInformation existing = getRequiredTicket(mtif.getTicketId());

        String currentStatus = existing.getIssueStatus();
        if (STATUS_RESOLVED.equals(currentStatus) || STATUS_CANCELLED.equals(currentStatus)) {
            throw new IllegalStateException("å·¥å–®å·²çµæ¡ˆæˆ–å–æ¶ˆï¼Œä¸å…è¨±ä¿®æ”¹å…§å®¹");
        }
        
        Integer oldStaffId = existing.getAssignedStaffId();
        Integer newStaffId = mtif.getAssignedStaffId();
        boolean staffChanged = !java.util.Objects.equals(oldStaffId, newStaffId); 

        existing.setIssueType(mtif.getIssueType().trim());
        existing.setIssueDesc(isBlank(mtif.getIssueDesc()) ? null : mtif.getIssueDesc().trim());
        
        if (!isBlank(mtif.getIssuePriority())) {
            String p = mtif.getIssuePriority().trim().toUpperCase();
            if (!isValidPriority(p)) throw new IllegalArgumentException("ç„¡æ•ˆçš„å„ªå…ˆæ¬Š: " + p);
            existing.setIssuePriority(p);
        }

        if (newStaffId != null) {
            validateAssignedStaff(newStaffId);
            existing.setAssignedStaffId(newStaffId);
        }

        MaintenanceInformation saved = mtifRepo.save(existing);

        if (staffChanged && newStaffId != null) {
            String staffName = staffRepo.findById(newStaffId)
                    .map(MaintenanceStaff::getStaffName).orElse("æœªçŸ¥");

            if (STATUS_REPORTED.equals(saved.getIssueStatus())) {
                saved.setIssueStatus(STATUS_ASSIGNED);
                saved = mtifRepo.save(saved);
            }

            // â˜… æ™ºæ…§åˆ¤æ–·ç§»è½‰ï¼šå¦‚æœåŸæœ¬æœ‰äºº (old != null) ä¸”ä¸æ˜¯æ–°çš„äºº -> ç§»è½‰
            String action = (oldStaffId != null) ? "TRANSFERRED" : "ASSIGNED";
            String comment = (oldStaffId != null) ? ("å·¥å–®ç§»è½‰ | è² è²¬äººè®Šæ›´ç‚º: " + staffName) : ("æŒ‡æ´¾è² è²¬äºº: " + staffName);
            
            saveLog(saved, isBlank(operator) ? "ç³»çµ±ç®¡ç†å“¡" : operator, action, comment);
        }

        return saved;
    }

    public void deleteTicket(int ticketId) {
        if (!mtifRepo.existsById(ticketId)) throw new IllegalArgumentException("æ‰¾ä¸åˆ°å·¥å–® " + ticketId);
        mtifRepo.deleteById(ticketId);
    }

    public void cancelTicket(int ticketId, String cancelReason, String operator) {
        MaintenanceInformation mtif = getRequiredTicket(ticketId);
        String status = mtif.getIssueStatus();

        if (STATUS_UNDER_MAINTENANCE.equals(status)) throw new IllegalStateException("ç¶­ä¿®ä¸­ä¸å¯å–æ¶ˆå·¥å–®");
        if (STATUS_RESOLVED.equals(status)) throw new IllegalStateException("å·¥å–®å·²çµæ¡ˆï¼Œç„¡æ³•å–æ¶ˆ");
        if (STATUS_CANCELLED.equals(status)) throw new IllegalStateException("å·¥å–®å·²æ˜¯å–æ¶ˆç‹€æ…‹");

        mtif.setIssueStatus(STATUS_CANCELLED);
        if (!isBlank(cancelReason)) {
            String oldNote = mtif.getResolveNote();
            mtif.setResolveNote(isBlank(oldNote) ? "[å–æ¶ˆåŸå› ] " + cancelReason : oldNote + "ï¼›[å–æ¶ˆåŸå› ] " + cancelReason);
        }

        mtifRepo.save(mtif);
        saveLog(mtif, isBlank(operator) ? "ç³»çµ±ç®¡ç†å“¡" : operator, "CANCELLED", "å–æ¶ˆåŸå› : " + (isBlank(cancelReason) ? "æœªæä¾›" : cancelReason));
    }

    @Transactional(readOnly = true)
    public MaintenanceInformation getTicketById(int ticketId) { return mtifRepo.findById(ticketId).orElse(null); }

    @Transactional(readOnly = true)
    public MaintenanceInformation getRequiredTicket(int ticketId) {
        return mtifRepo.findById(ticketId).orElseThrow(() -> new IllegalArgumentException("æ‰¾ä¸åˆ°å·¥å–® " + ticketId));
    }

    @Transactional(readOnly = true)
    public List<MaintenanceInformation> getTicketsBySpotId(int spotId) { return mtifRepo.findBySpotIdOrderByReportedAtDescTicketIdAsc(spotId); }

    @Transactional(readOnly = true)
    public List<MaintenanceInformation> getAllTickets() { return mtifRepo.findAllByOrderByReportedAtDescTicketIdAsc(); }

    @Transactional(readOnly = true)
    public List<MaintenanceInformation> getActiveTickets() {
        return mtifRepo.findByIssueStatusInOrderByReportedAtDescTicketIdAsc(Arrays.asList(STATUS_REPORTED, STATUS_ASSIGNED, STATUS_UNDER_MAINTENANCE));
    }

    @Transactional(readOnly = true)
    public List<MaintenanceInformation> getHistoryTickets() {
        return mtifRepo.findByIssueStatusInOrderByReportedAtDescTicketIdAsc(Arrays.asList(STATUS_RESOLVED, STATUS_CANCELLED));
    }

    // â˜… assignStaff æ¥æ”¶ operator
    public void assignStaff(int ticketId, Integer staffId, String operator) {
        MaintenanceInformation mtif = getRequiredTicket(ticketId);
        String currentStatus = mtif.getIssueStatus();

        if (STATUS_RESOLVED.equals(currentStatus) || STATUS_CANCELLED.equals(currentStatus)) {
            throw new IllegalStateException("ç›®å‰ç‹€æ…‹ç„¡æ³•è®Šæ›´æŒ‡æ´¾");
        }

        Integer oldStaffId = mtif.getAssignedStaffId();
        validateAssignedStaff(staffId);
        mtif.setAssignedStaffId(staffId);

        if (STATUS_REPORTED.equals(currentStatus) && staffId != null) {
            mtif.setIssueStatus(STATUS_ASSIGNED);
        } else if (staffId == null && STATUS_ASSIGNED.equals(currentStatus)) {
            mtif.setIssueStatus(STATUS_REPORTED);
        }
        
        mtifRepo.save(mtif);
        
        if (staffId != null) {
            MaintenanceStaff newStaff = staffRepo.findById(staffId).orElse(null);
            String newStaffName = (newStaff != null) ? newStaff.getStaffName() : "æœªçŸ¥";
            
            // â˜… åˆ¤æ–·é‚è¼¯ï¼šåŸæœ¬æœ‰äºº != æ–°çš„äºº => ç§»è½‰
            String action = (oldStaffId != null && !oldStaffId.equals(staffId)) ? "TRANSFERRED" : "ASSIGNED";
            String comment = (oldStaffId != null && !oldStaffId.equals(staffId)) 
                    ? ("å·¥å–®ç§»è½‰ | è² è²¬äººè®Šæ›´ç‚º: " + newStaffName) 
                    : ("æŒ‡æ´¾è² è²¬äºº: " + newStaffName);

            saveLog(mtif, isBlank(operator) ? "ç³»çµ±ç®¡ç†å“¡" : operator, action, comment);
        }
    }

    // â˜… transferTickets ç¢ºä¿æ¥æ”¶ operator ä¸¦å‚³çµ¦ assignStaff
    // æ³¨æ„ï¼šåŸæœ¬æ‚¨çš„ç‰ˆæœ¬é€™è£¡å¯èƒ½æ¼äº† operatorï¼Œå°è‡´ç„¡æ³•ç´€éŒ„æ˜¯èª°è½‰ç§»çš„
    public void transferTickets(Integer fromStaffId, Integer toStaffId, String operator) {
        if (fromStaffId == null || toStaffId == null) return;
        List<MaintenanceInformation> tickets = mtifRepo.findByAssignedStaffIdAndIssueStatusIn(
            fromStaffId, Arrays.asList(STATUS_ASSIGNED, STATUS_UNDER_MAINTENANCE));
        
        for (MaintenanceInformation ticket : tickets) {
            try {
                // å‘¼å« assignStaffï¼Œå®ƒå·²ç¶“åŒ…å« "TRANSFERRED" çš„åˆ¤æ–·é‚è¼¯
                assignStaff(ticket.getTicketId(), toStaffId, operator);
            } catch (Exception e) {
                System.err.println("å·¥å–®ç§»è½‰å¤±æ•— ID: " + ticket.getTicketId());
            }
        }
    }

    public void startTicket(int ticketId) {
        MaintenanceInformation mtif = getRequiredTicket(ticketId);
        String status = mtif.getIssueStatus();

        if (!STATUS_REPORTED.equals(status) && !STATUS_ASSIGNED.equals(status)) {
            throw new IllegalStateException("ç›®å‰ç‹€æ…‹ç„¡æ³•é–‹å§‹ç¶­ä¿®");
        }
        if (mtif.getAssignedStaffId() == null) throw new IllegalStateException("å°šæœªæŒ‡æ´¾äººå“¡");

        if (mtif.getStartAt() == null) mtif.setStartAt(LocalDateTime.now());
        mtif.setIssueStatus(STATUS_UNDER_MAINTENANCE);

        if (mtif.getSpotId() != null) {
            RentalSpot spot = rentalSpotRepo.findById(mtif.getSpotId()).orElseThrow();
            spot.setSpotStatus(SPOT_STATUS_MAINTENANCE);
            rentalSpotRepo.save(spot);
        }
        if (mtif.getSeatsId() != null) {
            Seat seat = this.seatRepo.findById(mtif.getSeatsId()).orElseThrow();
            seat.setSeatsStatus(SEAT_STATUS_REPAIRING);
            this.seatRepo.save(seat);
        }
        mtifRepo.save(mtif);
        
        MaintenanceStaff staff = staffRepo.findById(mtif.getAssignedStaffId()).orElse(null);
        String staffName = (staff != null) ? staff.getStaffName() : "æœªçŸ¥";
        saveLog(mtif, staffName, "STARTED", "é–‹å§‹é€²è¡Œç¶­ä¿®ä½œæ¥­");
    }

    public void resolveTicket(int ticketId, String resultType, String resolveNote) {
        if (isBlank(resultType)) throw new IllegalArgumentException("ç¶­ä¿®çµæœå¿…å¡«");
        if (!isValidResultType(resultType)) throw new IllegalArgumentException("éŒ¯èª¤çµæœé¡å‹");

        MaintenanceInformation mtif = getRequiredTicket(ticketId);
        if (!STATUS_UNDER_MAINTENANCE.equals(mtif.getIssueStatus())) throw new IllegalStateException("åªæœ‰ç¶­ä¿®ä¸­å·¥å–®å¯çµæ¡ˆ");

        mtif.setResolvedAt(LocalDateTime.now());
        mtif.setResultType(resultType);
        mtif.setResolveNote(resolveNote);
        mtif.setIssueStatus(STATUS_RESOLVED);
        mtifRepo.save(mtif); 
        
        MaintenanceStaff staff = staffRepo.findById(mtif.getAssignedStaffId()).orElse(null);
        String staffName = (staff != null) ? staff.getStaffName() : "æœªçŸ¥";
        saveLog(mtif, staffName, "RESOLVED", String.format("ç¶­ä¿®å®Œæˆ | çµæœ: %s | å‚™è¨»: %s", resultType, resolveNote));

        List<String> activeStatuses = Arrays.asList(STATUS_REPORTED, STATUS_ASSIGNED, STATUS_UNDER_MAINTENANCE);

        if (mtif.getSpotId() != null) {
            List<MaintenanceInformation> spotTickets = getTicketsBySpotId(mtif.getSpotId());
            boolean hasOther = spotTickets.stream().filter(t -> !t.getTicketId().equals(ticketId))
                    .anyMatch(t -> activeStatuses.contains(t.getIssueStatus()));
            if (!hasOther) {
                RentalSpot spot = rentalSpotRepo.findById(mtif.getSpotId()).orElseThrow();
                spot.setSpotStatus(SPOT_STATUS_OPERATIONAL);
                rentalSpotRepo.save(spot);
            }
        }
        if (mtif.getSeatsId() != null) {
            List<MaintenanceInformation> seatTickets = mtifRepo.findBySeatsIdOrderByReportedAtDescTicketIdAsc(mtif.getSeatsId());
            boolean hasOther = seatTickets.stream().filter(t -> !t.getTicketId().equals(ticketId))
                    .anyMatch(t -> activeStatuses.contains(t.getIssueStatus()));
            if (!hasOther) {
                Seat seat = this.seatRepo.findById(mtif.getSeatsId()).orElseThrow();
                seat.setSeatsStatus(SEAT_STATUS_ENABLED);
                this.seatRepo.save(seat);
            }
        }
    }
    
    private void validateForCreate(MaintenanceInformation mtif) {
        if (mtif == null) throw new IllegalArgumentException("å·¥å–®ç©ºç™½");
        boolean hasSpot = (mtif.getSpotId() != null && mtif.getSpotId() > 0);
        boolean hasSeat = (mtif.getSeatsId() != null && mtif.getSeatsId() > 0);
        if (!hasSpot && !hasSeat) throw new IllegalArgumentException("éœ€æŒ‡å®šå ´åœ°æˆ–æ¤…å­");
        if (isBlank(mtif.getIssueType())) throw new IllegalArgumentException("issueType å¿…å¡«");
        if (hasSpot && !rentalSpotRepo.existsById(mtif.getSpotId())) throw new IllegalArgumentException("ç§Ÿå€Ÿé»ä¸å­˜åœ¨");
        if (hasSeat && !seatRepo.existsById(mtif.getSeatsId())) throw new IllegalArgumentException("æ¤…å­ä¸å­˜åœ¨");
    }

    private void validateAssignedStaff(Integer staffId) {
        if (staffId == null) return;
        MaintenanceStaff staff = staffRepo.findById(staffId).orElse(null);
        if (staff == null) throw new IllegalArgumentException("æ‰¾ä¸åˆ°äººå“¡");
        if (Boolean.FALSE.equals(staff.getIsActive())) throw new IllegalArgumentException("è©²äººå“¡å·²åœç”¨");
    }

    private boolean isValidResultType(String resultType) {
        // âœ… æ”¯æŒ FIXED, MAINTAINED, NOT_FIXED, NO_ISSUE, UNFIXABLE, OTHER
        return !isBlank(resultType) && Arrays.asList(
            RESULT_FIXED, 
            RESULT_MAINTAINED, 
            RESULT_UNFIXABLE, 
            RESULT_OTHER
        ).contains(resultType);
    }

    private boolean isValidPriority(String priority) {
        return !isBlank(priority) && Arrays.asList(PRIORITY_LOW, PRIORITY_NORMAL, PRIORITY_HIGH, PRIORITY_URGENT).contains(priority);
    }

    private void saveLog(MaintenanceInformation ticket, String operator, String action, String comment) {
        if (ticket == null || isBlank(operator) || isBlank(action)) return;
        logRepo.save(new MaintenanceLog(ticket, operator.trim(), action.trim(), comment));
    }

    @Transactional(readOnly = true)
    public List<MaintenanceLogResponseDto> getTicketLogs(Integer ticketId) {
        if (ticketId == null) throw new IllegalArgumentException("ticketId ç©º");
        if (!mtifRepo.existsById(ticketId)) throw new IllegalArgumentException("æ‰¾ä¸åˆ°å·¥å–®");
        
        return logRepo.findByTicketTicketIdOrderByCreatedAtDesc(ticketId).stream()
                   .map(log -> new MaintenanceLogResponseDto(log.getLogId(), log.getOperator(), log.getAction(), log.getComment(), log.getCreatedAt()))
                   .toList();
    }
    
    public List<MaintenanceInformation> getTicketsByStaff(Integer staffId, List<String> statuses) {
        if (statuses != null && !statuses.isEmpty()) {
            return mtifRepo.findByAssignedStaffIdAndIssueStatusInOrderByReportedAtDescTicketIdAsc(staffId, statuses);
        } else {
            return mtifRepo.findByAssignedStaffIdOrderByReportedAtDescTicketIdAsc(staffId);
        }
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/service/spot/IRentalSpotService.java">
package com.example.backend.service.spot;

import java.util.List;
import java.util.Map;

import com.example.backend.model.spot.RentalSpot;

public interface IRentalSpotService {

    public RentalSpot insert(RentalSpot insertBean);

    public RentalSpot update(RentalSpot updateBean);

    public RentalSpot selectById(Integer spotId);

    public boolean deleteById(Integer spotId);

    public List<RentalSpot> selectAll();

    public List<RentalSpot> findByCondition(String spotCode, String spotName, String spotStatus, Integer merchantId);

    public List<RentalSpot> selectByKeyword(String keyword);

    public List<Map<String, Object>> findAllMerchantsForSelect();

    public List<com.example.backend.repository.projection.AnalyzeProjections.SpotWithSeats> selectAllWithSeatCount();

}
</file>

<file path="backend/src/main/java/com/example/backend/service/spot/RentalSpotService.java">
package com.example.backend.service.spot;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.StringUtils;

import jakarta.persistence.criteria.Predicate;

import com.example.backend.model.spot.RentalSpot;
import com.example.backend.file.FileStorageService;
import com.example.backend.repository.spot.RentalSpotRepository;
// [æ³¨æ„] è«‹ç¢ºèªä»¥ä¸‹ Merchant ç›¸é—œçš„ package è·¯å¾‘æ˜¯å¦æ­£ç¢º
import com.example.backend.repository.merchantAndCoupon.MerchantRepository;
import com.example.backend.model.merchantAndCoupon.MerchantBean;

@Service
@Transactional
public class RentalSpotService implements IRentalSpotService {

    private final RentalSpotRepository rentalSpotRepository;
    private final FileStorageService fileStorageService;
    private final MerchantRepository merchantRepository;

    public RentalSpotService(RentalSpotRepository rentalSpotRepository, FileStorageService fileStorageService,
            MerchantRepository merchantRepository) {
        this.rentalSpotRepository = rentalSpotRepository;
        this.fileStorageService = fileStorageService;
        this.merchantRepository = merchantRepository;
    }

    /**
     * æ–°å¢æ“šé»ï¼Œä¸¦åœ¨å„²å­˜å‰æª¢æŸ¥ä»£ç¢¼ (spotCode) æ˜¯å¦é‡è¤‡ã€‚
     * 
     * @param rentalSpot è¦æ–°å¢çš„æ“šé»ç‰©ä»¶
     * @return å„²å­˜å¾Œçš„æ“šé»ç‰©ä»¶
     * @throws IllegalArgumentException å¦‚æœä»£ç¢¼å·²å­˜åœ¨
     */
    @Override
    public RentalSpot insert(RentalSpot rentalSpot) {
        // 1. æª¢æŸ¥ spotCode æ˜¯å¦ç‚ºç©ºæˆ–ç©ºå­—ä¸²
        if (StringUtils.hasText(rentalSpot.getSpotCode())) {

            // 2. å‘¼å« Repository çš„ existsBySpotCode æ–¹æ³•é€²è¡Œæª¢æŸ¥
            if (rentalSpotRepository.existsBySpotCode(rentalSpot.getSpotCode())) {

                // 3. å¦‚æœä»£ç¢¼å·²å­˜åœ¨ï¼Œæ‹‹å‡ºæ¥­å‹™é‚è¼¯ç•°å¸¸
                throw new IllegalArgumentException("æ“šé»ä»£ç¢¼ (Spot Code) '" + rentalSpot.getSpotCode() + "' å·²å­˜åœ¨ï¼Œè«‹ä½¿ç”¨ä¸åŒçš„ä»£ç¢¼ã€‚");
            }
        }

        // 4. åŸ·è¡Œå„²å­˜
        return rentalSpotRepository.save(rentalSpot);
    }

    @Override
    public RentalSpot update(RentalSpot rentalSpot) {
        // [ä¿®æ­£] ç¢ºä¿ Update æ“ä½œæœ‰ IDï¼Œé¿å…è®Šæˆ Insert
        if (rentalSpot.getSpotId() == null) {
            throw new IllegalArgumentException("æ›´æ–°å¤±æ•—ï¼šæ“šé» ID (spotId) ä¸èƒ½ç‚ºç©º");
        }

        // [å„ªåŒ–] æª”æ¡ˆæ¸…ç†æ©Ÿåˆ¶ï¼šå¦‚æœæ›´æ–°äº†åœ–ç‰‡ï¼Œåˆªé™¤èˆŠçš„å¯¦é«”æª”æ¡ˆ
        rentalSpotRepository.findById(rentalSpot.getSpotId()).ifPresent(oldSpot -> {
            String oldImage = oldSpot.getSpotImage();
            String newImage = rentalSpot.getSpotImage();

            // ç•¶è³‡æ–™åº«åŸæœ¬æœ‰åœ–ï¼Œä¸”æ–°å‚³å…¥çš„åœ–èˆ‡èˆŠåœ–ä¸åŒï¼ˆä»£è¡¨æ›´æ›äº†æˆ–æ˜¯åŸæœ¬æœ‰ç¾åœ¨è¦åˆªé™¤ï¼‰
            if (StringUtils.hasText(oldImage) && !oldImage.equals(newImage)) {
                fileStorageService.delete(oldImage);
            }
        });

        // æ›´æ–°æ™‚é€šå¸¸ä¸æª¢æŸ¥ä»£ç¢¼é‡è¤‡ (é™¤éå…è¨±ä¿®æ”¹ä»£ç¢¼ä¸”æ”¹åˆ°è·Ÿåˆ¥äººä¸€æ¨£)ï¼Œç›´æ¥å„²å­˜
        return rentalSpotRepository.save(rentalSpot);
    }

    @Override
    public boolean deleteById(Integer spotId) {
        if (spotId == null) {
            return false;
        }
        RentalSpot spot = rentalSpotRepository.findById(spotId).orElse(null);
        if (spot != null) {
            rentalSpotRepository.delete(spot);
            // è‹¥è©²æ“šé»æœ‰åœ–ç‰‡ï¼Œå‰‡ä¸€ä½µåˆªé™¤å¯¦é«”æª”æ¡ˆ
            if (StringUtils.hasText(spot.getSpotImage())) {
                fileStorageService.delete(spot.getSpotImage());
            }
            return true;
        }
        return false;
    }

    @Override
    public RentalSpot selectById(Integer spotId) {
        if (spotId == null) {
            return null;
        }
        return rentalSpotRepository.findById(spotId).orElse(null);
    }

    @Override
    public List<RentalSpot> selectAll() {
        return rentalSpotRepository.findAll();
    }

    @Override
    public List<RentalSpot> selectByKeyword(String keyword) {
        return rentalSpotRepository.findByKeyword(keyword);
    }

    @Override
    public List<RentalSpot> findByCondition(String spotCode, String spotName, String spotStatus, Integer merchantId) {
        return rentalSpotRepository.findAll((root, query, cb) -> {
            List<Predicate> predicates = new ArrayList<>();

            if (StringUtils.hasText(spotCode)) {
                predicates.add(cb.like(root.get("spotCode"), "%" + spotCode + "%"));
            }
            if (StringUtils.hasText(spotName)) {
                predicates.add(cb.like(root.get("spotName"), "%" + spotName + "%"));
            }
            if (StringUtils.hasText(spotStatus)) {
                predicates.add(cb.equal(root.get("spotStatus"), spotStatus));
            }
            if (merchantId != null) {
                predicates.add(cb.equal(root.get("merchantId"), merchantId));
            }
            return cb.and(predicates.toArray(new Predicate[0]));
        });
    }

    @Override
    public List<Map<String, Object>> findAllMerchantsForSelect() {
        // å–å¾—æ‰€æœ‰å•†å®¶
        List<MerchantBean> merchants = merchantRepository.findAll();

        // è½‰æ›ç‚ºç°¡å–®çš„ Map åˆ—è¡¨ (åªåŒ…å« ID å’Œ åç¨±)
        return merchants.stream().map(m -> {
            Map<String, Object> map = new HashMap<>();
            map.put("merchantId", m.getMerchantId());
            map.put("merchantName", m.getMerchantName());
            return map;
        }).collect(Collectors.toList());
    }

    @Override
    public List<com.example.backend.repository.projection.AnalyzeProjections.SpotWithSeats> selectAllWithSeatCount() {
        return rentalSpotRepository.findAllSpotsWithSeatCount();
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/service/spot/SeatService.java">
package com.example.backend.service.spot;

import java.util.ArrayList;
import java.util.List; // ç¢ºèªé€™è£¡æ˜¯ java.util.List

import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.example.backend.model.spot.Seat;
import com.example.backend.repository.spot.SeatRepository;

import jakarta.persistence.criteria.Predicate;

@Service
@Transactional
public class SeatService implements ISeatService {

    private final SeatRepository seatRepository;

    public SeatService(SeatRepository seatRepository) {
        this.seatRepository = seatRepository;
    }

    /**
     * æ–°å¢ä¸€å€‹åº§ä½ï¼Œä¸¦åœ¨å„²å­˜å‰æª¢æŸ¥åºè™Ÿæ˜¯å¦é‡è¤‡ã€‚
     * 
     * @param seat è¦æ–°å¢çš„åº§ä½ç‰©ä»¶
     * @return å„²å­˜å¾Œçš„åº§ä½ç‰©ä»¶
     * @throws IllegalArgumentException å¦‚æœåºè™Ÿå·²å­˜åœ¨
     */
    @Override
    public Seat insert(Seat seat) {
        // 1. [å„ªåŒ–] Serial Number æ”¹ç”±è³‡æ–™åº« Computed Column è‡ªå‹•ç”Ÿæˆ
        // Hibernate @Generated æ¨™è¨»æœƒç¢ºä¿ insert/update å¾Œè‡ªå‹•æ’ˆå›æ•¸å€¼

        // 2. åŸ·è¡Œå„²å­˜
        return seatRepository.save(seat);
    }

    @Override
    public Seat update(Seat seat) {
        // save(): é€™è£¡æ˜¯ä¿®æ”¹ã€‚
        // [ä¿®æ­£] ç¢ºä¿ Update æ“ä½œæœ‰ IDï¼Œé¿å…è®Šæˆ Insert
        if (seat.getSeatsId() == null) {
            throw new IllegalArgumentException("æ›´æ–°å¤±æ•—ï¼šåº§ä½ ID ä¸èƒ½ç‚ºç©º");
        }
        return seatRepository.save(seat);
    }

    @Override
    public boolean deleteById(Integer seatsId) {
        if (seatsId == null) {
            return false;
        }
        // å…ˆæª¢æŸ¥æ˜¯å¦å­˜åœ¨ï¼Œå†åˆªé™¤ã€‚
        if (seatRepository.existsById(seatsId)) {
            seatRepository.deleteById(seatsId);
            return true;
        }
        return false;
    }

    @Override
    public Seat selectById(Integer seatsId) {
        if (seatsId == null) {
            return null;
        }
        // findById(): æ ¹æ“šä¸»éµæŸ¥è©¢ã€‚
        return seatRepository.findById(seatsId).orElse(null);
    }

    @Override
    public List<Seat> selectAll() {
        // findAll(): æŸ¥è©¢å…¨éƒ¨ã€‚
        return seatRepository.findAll();
    }

    @Override
    public List<Seat> selectBySpotId(Integer spotId) {
        if (spotId == null) {
            return new ArrayList<>();
        }
        return seatRepository.findBySpotId(spotId);
    }

    @Override
    public List<Seat> findByCondition(String seatsName, String seatsType, String seatsStatus, Integer spotId,
            String serialNumber) {
        // ä½¿ç”¨ Specification é€²è¡Œå‹•æ…‹æŸ¥è©¢ï¼Œé¿å…æ‰‹å¯« SQL/HQLã€‚
        return seatRepository.findAll((root, query, cb) -> {
            List<Predicate> predicates = new ArrayList<>(); // ç¢ºèª Predicate å¾Œé¢æ²’æœ‰ <...>

            if (seatsName != null && !seatsName.isBlank()) {
                predicates.add(cb.like(root.get("seatsName"), "%" + seatsName + "%"));
            }
            if (seatsType != null && !seatsType.isBlank()) {
                predicates.add(cb.equal(root.get("seatsType"), seatsType));
            }
            if (seatsStatus != null && !seatsStatus.isBlank()) {
                predicates.add(cb.equal(root.get("seatsStatus"), seatsStatus));
            }
            if (spotId != null) {
                predicates.add(cb.equal(root.get("spotId"), spotId));
            }
            if (serialNumber != null && !serialNumber.isBlank()) {
                predicates.add(cb.like(root.get("serialNumber"), "%" + serialNumber + "%"));
            }

            return cb.and(predicates.toArray(new Predicate[0]));
        });
    }

    @Override
    public List<Seat> selectByKeyword(String keyword) {
        return seatRepository.findByKeyword(keyword);
    }

    @Override
    public long countBySpotId(Integer spotId) {
        return seatRepository.countBySpotId(spotId);
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/config/WebConfig.java">
package com.example.backend.config;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

/**
 * Web MVC é…ç½®
 * è¨­å®šéœæ…‹è³‡æºè·¯å¾‘ï¼Œè®“å‰ç«¯å¯ä»¥å­˜å–ä¸Šå‚³çš„åœ–ç‰‡
 */
@Configuration
public class WebConfig implements WebMvcConfigurer {

    @Value("${app.file.upload-path}")
    private String uploadPath;

    @Override
    public void addResourceHandlers(ResourceHandlerRegistry registry) {
        // ç¢ºä¿è·¯å¾‘ä»¥ / çµå°¾ï¼Œä¸¦åŠ ä¸Š file: å‰ç¶´
        // ä½¿ç”¨ System.getProperty("user.dir") ç¢ºä¿å°æ‡‰åˆ°å°ˆæ¡ˆæ ¹ç›®éŒ„ä¸‹çš„ uploads
        String projectRoot = System.getProperty("user.dir");
        String resourceLocation = "file:" + projectRoot + "/" + uploadPath + "/";

        // ä¿æŒåŸæœ¬çš„ uploads æ˜ å°„
        registry.addResourceHandler("/uploads/**")
                .addResourceLocations(resourceLocation);

        // âœ¨ æ–°å¢é€™å€‹ï¼šæŠŠå‰ç«¯è«‹æ±‚çš„ /images/** æŒ‡å‘ä½ çš„å¯¦é«”å­˜æ”¾è³‡æ–™å¤¾
        // å‡è¨­ä½ çš„åœ–ç‰‡æ˜¯å­˜æ”¾åœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„ä¸‹çš„ uploads è³‡æ–™å¤¾
        registry.addResourceHandler("/images/**")
                .addResourceLocations(resourceLocation);
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/controller/rec/AnalyzeController.java">
package com.example.backend.controller.rec;

import java.time.LocalDate;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.format.annotation.DateTimeFormat;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import com.example.backend.service.rec.AnalyzeService;

@RestController
@RequestMapping("/api/analyze")
public class AnalyzeController {

    @Autowired
    private AnalyzeService analyzeService;

    /**
     * å–å¾—å„€è¡¨æ¿çµ±è¨ˆæ•¸æ“š
     * API: GET /api/analyze/stats
     * å›å‚³: JSON ç‰©ä»¶ï¼ŒåŒ…å« cityDistribution, spotMonitor, hourlyHeatMap, durationStats,
     * hotSpots
     */
    @GetMapping("/stats")
    public ResponseEntity<Map<String, Object>> getAnalyzeStats(
            @RequestParam(required = false) @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate startDate,
            @RequestParam(required = false) @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate endDate) {
        Map<String, Object> stats = analyzeService.getAnalyzeStats(startDate, endDate);
        return ResponseEntity.ok(stats);
    }

    /**
     * å–å¾—ç«™é»å³æ™‚ç›£æ§æ•¸æ“šï¼ˆå°ˆä¾›èª¿åº¦ä¸­å¿ƒä¸­å¿ƒä½¿ç”¨ï¼‰
     * API: GET /api/analyze/spot-monitor
     */
    @GetMapping("/spot-monitor")
    public ResponseEntity<Object> getSpotMonitor() {
        Map<String, Object> stats = analyzeService.getAnalyzeStats(null, null);
        return ResponseEntity.ok(stats.get("spotMonitor"));
    }

    /**
     * å–å¾—ç†±é–€é»ä½æ•¸æ“šï¼ˆå°ˆä¾›é¦–é ä½¿ç”¨ï¼‰
     * API: GET /api/analyze/hot-spots
     */
    @GetMapping("/hot-spots")
    public ResponseEntity<Object> getHotSpots() {
        Map<String, Object> stats = analyzeService.getAnalyzeStats(null, null);
        return ResponseEntity.ok(stats.get("hotSpots"));
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/service/rec/AnalyzeService.java">
package com.example.backend.service.rec;

import java.time.LocalDate;
import java.util.HashMap;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.example.backend.repository.rec.RecRentAnalyzeRepository;
import com.example.backend.repository.spot.RentalSpotRepository;

@Service
public class AnalyzeService {

    @Autowired
    private RentalSpotRepository rentalSpotRepository;

    @Autowired
    private RecRentAnalyzeRepository recRentAnalyzeRepository;

    /**
     * ç²å–å„€è¡¨æ¿æ‰€éœ€çš„æ‰€æœ‰çµ±è¨ˆæ•¸æ“š
     * å°‡ä¸åŒ Repository çš„æŸ¥è©¢çµæœå½™æ•´åˆ°ä¸€å€‹ Map ä¸­
     */
    public Map<String, Object> getAnalyzeStats(LocalDate startDate, LocalDate endDate) {
        Map<String, Object> data = new HashMap<>();

        // ç¸£å¸‚åˆ†ä½ˆ (ä¾†è‡ª RentalSpotRepository)
        // å°æ‡‰å‰ç«¯åœ–è¡¨ï¼šåœ“é¤…åœ– (Pie Chart)
        data.put("cityDistribution", rentalSpotRepository.getCityDistribution());

        // ç«™é»å³æ™‚ç›£æ§ (ä¾†è‡ª RentalSpotRepository)
        // å°æ‡‰å‰ç«¯åœ–è¡¨ï¼šåˆ—è¡¨æˆ–å„€è¡¨æ¿ (Gauge/Table)
        data.put("spotMonitor", rentalSpotRepository.getSpotRealtimeStatus());

        // æ™‚æ®µç†±åº¦ (ä¾†è‡ª RecRentAnalyzeRepository)
        // å°æ‡‰å‰ç«¯åœ–è¡¨ï¼šæŠ˜ç·šåœ– (Line Chart)
        data.put("hourlyHeatMap", recRentAnalyzeRepository.getHourlyHeatMap(startDate, endDate));

        // ä½¿ç”¨æ™‚é–“é•·çŸ­çµ±è¨ˆ (ä¾†è‡ª RecRentAnalyzeRepository)
        // å°æ‡‰å‰ç«¯åœ–è¡¨ï¼šé•·æ¢åœ– (Bar Chart)
        data.put("durationStats", recRentAnalyzeRepository.getDurationStats(startDate, endDate));

        // ç†±é–€é»ä½ (ä¾†è‡ª RentalSpotRepository)
        // ç”¨æ–¼é¦–é æ¨è–¦
        data.put("hotSpots", rentalSpotRepository.getHotSpots());

        return data;
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/service/rec/RecDetailMgnService.java">
package com.example.backend.service.rec;

import java.time.Duration;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.List;
import java.util.stream.Collectors;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.example.backend.dto.rec.DailyOrderCountDTO;
import com.example.backend.dto.rec.HourlyOrderCountDTO;
import com.example.backend.dto.rec.MonthlyOrderCountDTO;
import com.example.backend.dto.rec.OrderStatusStatsDTO;
import com.example.backend.dto.rec.RentalDurationDTO;
import com.example.backend.dto.rec.RentalDurationStatsDTO;
import com.example.backend.model.rec.RecRent;
import com.example.backend.model.rec.RentDetails;
import com.example.backend.repository.rec.RecRentRepository;
import com.example.backend.repository.rec.RentDetailsRepository;
import com.example.backend.repository.rec.RentDetailsSpecs;
import org.springframework.data.domain.Sort;

@Service
@Transactional
public class RecDetailMgnService {
    @Autowired
    private RentDetailsRepository detailRepos;
    @Autowired
    private RecRentRepository recRepos;

    public List<RentDetails> getAllRec() {
        return detailRepos.findAll(Sort.by(Sort.Direction.DESC, "recRentDT2"));
    }

    public List<RentDetails> search(
            Integer recSeqId,
            String recId,
            Integer memId,
            String memName,
            String recStatus,
            Integer spotId,
            String spotName,
            LocalDate startDate,
            LocalDate endDate) {

        Specification<RentDetails> spec = Specification.where(null);

        if (recId != null && !recId.isEmpty()) {
            spec = spec.and(RentDetailsSpecs.hasRecId(recId));
        }
        if (memId != null) {
            spec = spec.and(RentDetailsSpecs.hasMemId(memId));
        }
        if (memName != null && !memName.isEmpty()) {
            spec = spec.and(RentDetailsSpecs.memNameContains(memName));
        }
        if (recStatus != null && !recStatus.isEmpty()) {
            spec = spec.and(RentDetailsSpecs.hasRecStatus(recStatus));
        }
        if (spotId != null) {
            spec = spec.and(RentDetailsSpecs.hasSpotId(spotId));
        }
        if (spotName != null && !spotName.isEmpty()) {
            spec = spec.and(RentDetailsSpecs.spotNameContains(spotName));
        }
        // Time Range Search
        if (startDate != null || endDate != null) {
            spec = spec.and(RentDetailsSpecs.isWithinTimeRange(startDate, endDate));
        }

        return detailRepos.findAll(spec, Sort.by(Sort.Direction.DESC, "recRentDT2"));
    }

    public RentDetails getRecById(String recId) {
        // æ‰¾ä¸åˆ°IDå›å‚³ERR MSG
        return detailRepos.findById(recId).orElseThrow(
                () -> new RuntimeException("RentDetails not found with ID: " + recId));// ??
    }

    // æ–°å¢è¨‚å–®
    public void insertOrUpdateRec(RecRent recRent) {
        recRepos.save(recRent);

    }

    // å‘¼å«Repositoryå–å¾—åŸå§‹çµ±è¨ˆæ•¸æ“šï¼Œä¸¦åœ¨æœå‹™å±¤å°‡å…¶æ˜ å°„ç‚ºDTOåˆ—è¡¨
    public List<MonthlyOrderCountDTO> getMonthlyOrderCounts(LocalDate startDate, LocalDate endDate) {
        // å°‡LocalDateè½‰æ›ç‚ºLocalDateTimeä»¥ç¬¦åˆRepositoryæŸ¥è©¢éœ€æ±‚
        LocalDateTime startDateTime = startDate.atStartOfDay();
        LocalDateTime endDateTime = endDate.atTime(23, 59, 59);
        List<Object[]> results = detailRepos.findMonthlyOrderCounts(startDateTime, endDateTime);
        return results.stream().map(row -> new MonthlyOrderCountDTO(
                ((Number) row[0]).intValue(), // å¹´ä»½
                ((Number) row[1]).intValue(), // æœˆä»½
                ((Number) row[2]).longValue() // è¨‚å–®è¨ˆæ•¸
        )).collect(Collectors.toList());
    }

    // ç²å–è¨‚å–®ç‹€æ…‹çµ±è¨ˆæ•¸æ“šï¼ˆåœ“é¤…åœ–ï¼‰
    public List<OrderStatusStatsDTO> getOrderStatusStats(LocalDate startDate, LocalDate endDate) {
        LocalDateTime startDateTime = startDate.atStartOfDay();
        LocalDateTime endDateTime = endDate.atTime(23, 59, 59);
        List<Object[]> results = detailRepos.findOrderStatusStats(startDateTime, endDateTime);
        return results.stream()
                .map(row -> new OrderStatusStatsDTO((String) row[0], ((Number) row[1]).longValue()))
                .collect(Collectors.toList());
    }

    // ç²å–è¨‚å–®ç§Ÿå€Ÿæ™‚é•·æ•¸æ“šï¼ˆæ•£ä½ˆåœ–ï¼‰
    public List<RentalDurationDTO> getRentalDurations(LocalDate startDate, LocalDate endDate) {
        LocalDateTime startDateTime = startDate.atStartOfDay();
        LocalDateTime endDateTime = endDate.atTime(23, 59, 59);
        List<Object[]> results = detailRepos.findRentalDurations(startDateTime, endDateTime);
        return results.stream().map(row -> {
            String recId = (String) row[0];
            LocalDateTime rentTime = (LocalDateTime) row[1];
            LocalDateTime returnTime = (LocalDateTime) row[2];
            // è¨ˆç®—ç§Ÿå€Ÿæ™‚é•·ï¼ˆåˆ†é˜ï¼‰
            long durationInMinutes = Duration.between(rentTime, returnTime).toMinutes();
            return new RentalDurationDTO(recId, rentTime, durationInMinutes);
        }).collect(Collectors.toList());
    }

    // ç²å–æ¯å°æ™‚è¨‚å–®çµ±è¨ˆ
    public List<HourlyOrderCountDTO> getHourlyOrderCounts(LocalDate startDate, LocalDate endDate) {
        LocalDateTime startDateTime = startDate.atStartOfDay();
        LocalDateTime endDateTime = endDate.atTime(23, 59, 59);
        List<Object[]> results = detailRepos.findHourlyOrderCounts(startDateTime, endDateTime);
        return results.stream()
                .map(row -> new HourlyOrderCountDTO(((Number) row[0]).intValue(), ((Number) row[1]).longValue()))
                .collect(Collectors.toList());
    }

    // ç²å–æ¯æ—¥è¨‚å–®çµ±è¨ˆ
    public List<DailyOrderCountDTO> getDailyOrderCounts(LocalDate startDate, LocalDate endDate) {
        LocalDateTime startDateTime = startDate.atStartOfDay();
        LocalDateTime endDateTime = endDate.atTime(23, 59, 59);
        List<Object[]> results = detailRepos.findDailyOrderCounts(startDateTime, endDateTime);
        return results.stream()
                .map(row -> new DailyOrderCountDTO((String) row[0], ((Number) row[1]).longValue()))
                .collect(Collectors.toList());
    }

    // ç²å–ç§Ÿå€Ÿæ™‚é•·çµ±è¨ˆ (30åˆ†é˜é–“éš”)
    public List<RentalDurationStatsDTO> getRentalDurationStats(LocalDate startDate, LocalDate endDate) {
        LocalDateTime startDateTime = startDate.atStartOfDay();
        LocalDateTime endDateTime = endDate.atTime(23, 59, 59);
        List<Object[]> results = detailRepos.findRentalDurationStatsIn30MinIntervals(startDateTime, endDateTime);
        return results.stream()
                .map(row -> new RentalDurationStatsDTO(
                        row[0] != null ? ((Number) row[0]).intValue() : 0,
                        row[1] != null ? ((Number) row[1]).longValue() : 0L))
                .collect(Collectors.toList());
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/utils/EcpayUtils.java">
package com.example.backend.utils;

import org.springframework.stereotype.Component;
import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;
import java.security.MessageDigest;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Map;
import java.util.TreeMap;
import java.util.stream.Collectors;

@Component
public class EcpayUtils {
    private static final String HASH_KEY = "pwFHCqoQZGmho4w6";
    private static final String HASH_IV = "EkRm7iFT261dpevs";
    private static final String MERCHANT_ID = "3002607";
    
    // ğŸ’¡ è¨˜å¾—æ›´æ›ç‚ºä½ ç›®å‰çš„ Localtunnel ç¶²å€
    // æ³¨æ„ï¼šé€™è£¡å¿…é ˆæ˜¯ä½ ç¾åœ¨æœ‰æ•ˆçš„ Ngrok æˆ– Localtunnel ç¶²å€
    // å¦‚æœéšŠå‹çš„ç¶²å€å·²å¤±æ•ˆï¼Œè«‹æ›æˆä½ è‡ªå·±çš„ï¼Œå¦å‰‡ç¶ ç•Œä»˜æ¬¾å¾Œè·³è½‰æœƒ 404
    private static final String BASE_URL = "https://ceola-unreigning-paraphrastically.ngrok-free.dev";

    public String genCheckOutForm(String tradeNo, String totalAmount, String itemName, String baseUrl) {
        Map<String, String> params = new TreeMap<>();
        params.put("MerchantID", MERCHANT_ID);
        params.put("MerchantTradeNo", tradeNo);
        params.put("MerchantTradeDate", LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy/MM/dd HH:mm:ss")));
        params.put("PaymentType", "aio");
        params.put("TotalAmount", totalAmount);
        params.put("TradeDesc", "PlatformTransaction");
        params.put("ItemName", itemName);
        params.put("ReturnURL", baseUrl + "/api/payment/callback");
        params.put("OrderResultURL", baseUrl + "/api/payment/payment-success"); // ğŸ’¡ æ”¯ä»˜å®Œè·³è½‰å›ä¾†çš„ç¶²å€
        params.put("ChoosePayment", "ALL");
        params.put("EncryptType", "1");

        String checkMacValue = generateCheckMacValue(params);
        params.put("CheckMacValue", checkMacValue);

        StringBuilder form = new StringBuilder();
        form.append(
                "<form id='ecpayForm' action='https://payment-stage.ecpay.com.tw/Cashier/AioCheckOut/V5' method='post'>");
        for (Map.Entry<String, String> entry : params.entrySet()) {
            form.append("<input type='hidden' name='").append(entry.getKey()).append("' value='")
                    .append(entry.getValue()).append("'>");
        }
        form.append("</form>");
        return form.toString();
    }

    public static String generateCheckMacValue(Map<String, String> params) {
        String rawData = params.entrySet().stream()
                .filter(e -> !"CheckMacValue".equals(e.getKey()) && e.getValue() != null)
                .map(e -> e.getKey() + "=" + e.getValue())
                .collect(Collectors.joining("&"));
        String combinedData = "HashKey=" + HASH_KEY + "&" + rawData + "&HashIV=" + HASH_IV;
        String urlEncoded = ecpayUrlEncode(combinedData).toLowerCase();
        return sha256(urlEncoded).toUpperCase();
    }

    private static String ecpayUrlEncode(String data) {
        try {
            String encoded = URLEncoder.encode(data, StandardCharsets.UTF_8.toString());
            return encoded.replace("%2d", "-").replace("%5f", "_").replace("%2e", ".")
                    .replace("%2a", "*").replace("%28", "(").replace("%29", ")").replace("%21", "!");
        } catch (Exception e) {
            return "";
        }
    }

    private static String sha256(String base) {
        try {
            MessageDigest digest = MessageDigest.getInstance("SHA-256");
            byte[] hash = digest.digest(base.getBytes(StandardCharsets.UTF_8));
            StringBuilder hexString = new StringBuilder();
            for (byte b : hash) {
                String hex = Integer.toHexString(0xff & b);
                if (hex.length() == 1)
                    hexString.append('0');
                hexString.append(hex);
            }
            return hexString.toString();
        } catch (Exception ex) {
            throw new RuntimeException(ex);
        }
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/controller/spot/RentalSpotController.java">
package com.example.backend.controller.spot;

import com.example.backend.dto.spot.SpotUpdateRequest;
import com.example.backend.model.spot.RentalSpot;
import com.example.backend.service.spot.RentalSpotService;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import java.util.List;
import java.util.Map;

/**
 * [é‡æ§‹] ç§Ÿå€Ÿæ“šé» (RentalSpot) è³‡æºçš„çµ±ä¸€æ§åˆ¶å™¨
 * - åˆä½µäº† List, One, Insert, Update, Delete, ByCondition ç­‰å¤šå€‹ Controller çš„åŠŸèƒ½ã€‚
 * - éµå¾ª RESTful API è¨­è¨ˆé¢¨æ ¼ã€‚
 */
@RestController
@RequestMapping("/spot") // [ä¿®æ­£] é…åˆå‰ç«¯ Proxy ç§»é™¤ /api å‰ç¶´çš„è¡Œç‚ºï¼Œæ”¹ç‚ºç›£è½ /spot
public class RentalSpotController {

    @Value("${app.file.upload-path}")
    private String configUploadPath;

    private final RentalSpotService rentalSpotService;

    public RentalSpotController(RentalSpotService rentalSpotService) {
        this.rentalSpotService = rentalSpotService;
    }

    // region æŸ¥è©¢åŠŸèƒ½ (Read)

    /**
     * æŸ¥è©¢æ‰€æœ‰æ“šé» (GET /api/spots)
     * (åŸ SpotListController)
     */
    @GetMapping("/list")
    public List<RentalSpot> getAllSpots() {
        return rentalSpotService.selectAll();
    }

    /**
     * [æ–°å¢] æŸ¥è©¢æ‰€æœ‰æ“šé»åŠå…¶å³æ™‚åº§ä½æ•¸ (GET /api/spot/list-with-seats)
     * å°ˆä¾›é¦–é åœ°åœ–èˆ‡æœå°‹å‘ˆç¾ä½¿ç”¨ï¼ŒåŒ…å«å³æ™‚å¯ç”¨åº§ä½è³‡è¨Šã€‚
     */
    @GetMapping("/list-with-seats")
    public List<com.example.backend.repository.projection.AnalyzeProjections.SpotWithSeats> getAllSpotsWithSeats() {
        return rentalSpotService.selectAllWithSeatCount();
    }

    /**
     * æ ¹æ“š ID æŸ¥è©¢å–®ä¸€æ“šé» (GET /api/spots/{id})
     * (åŸ SpotOneController)
     * å„ªåŒ–ï¼šä½¿ç”¨ @PathVariableï¼Œè®“ URL æ›´èªæ„åŒ–ã€‚
     * å„ªåŒ–ï¼šä½¿ç”¨ ResponseEntity å›å‚³ï¼Œç•¶æ‰¾ä¸åˆ°æ“šé»æ™‚å›å‚³ 404 Not Foundã€‚
     */
    @GetMapping("/{id}")
    public ResponseEntity<RentalSpot> getSpotById(@PathVariable("id") Integer spotId) {
        RentalSpot spot = rentalSpotService.selectById(spotId);
        return (spot != null) ? ResponseEntity.ok(spot) : ResponseEntity.notFound().build();
    }

    /**
     * æ¢ä»¶æŸ¥è©¢ (GET /api/spots/search?spotName=...)
     * (åŸ SpotByConditionController)
     */
    @GetMapping("/search")
    public List<RentalSpot> findSpotsByCondition(@RequestParam(required = false) String spotCode,
            @RequestParam(required = false) String spotName, @RequestParam(required = false) String spotStatus,
            @RequestParam(required = false) Integer merchantId) {
        return rentalSpotService.findByCondition(spotCode, spotName, spotStatus, merchantId);
    }

    /**
     * [æ–°å¢] å–å¾—å•†å®¶ä¸‹æ‹‰é¸å–®è³‡æ–™ (GET /spot/merchants)
     * ä¾›å‰ç«¯ä¸‹æ‹‰é¸å–®ä½¿ç”¨ï¼Œå›å‚³å•†å®¶ ID èˆ‡åç¨±
     */
    @GetMapping("/merchants")
    public ResponseEntity<List<Map<String, Object>>> getMerchantOptions() {
        return ResponseEntity.ok(rentalSpotService.findAllMerchantsForSelect());
    }

    // endregion

    // region ç·¨è¼¯åŠŸèƒ½ (Create / Update / Delete)

    /**
     * æ–°å¢æ“šé» (POST /api/spots)
     * (åŸ SpotInsertController)
     * å„ªåŒ–ï¼šå›å‚³ 201 Created ç‹€æ…‹ç¢¼ï¼Œè¡¨ç¤ºè³‡æºå·²æˆåŠŸå»ºç«‹ã€‚
     */
    @PostMapping
    public ResponseEntity<RentalSpot> createSpot(@RequestBody RentalSpot spot) {
        RentalSpot createdSpot = rentalSpotService.insert(spot);
        return new ResponseEntity<>(createdSpot, HttpStatus.CREATED);
    }

    /**
     * æ›´æ–°æ“šé» (PUT /api/spots/{id})
     * (åŸ SpotUpdateController)
     * å„ªåŒ–ï¼šä½¿ç”¨ PUT æ–¹æ³•è¡¨ç¤ºã€Œå®Œæ•´æ›´æ–°ã€ä¸€å€‹å·²å­˜åœ¨çš„è³‡æºã€‚
     */
    @PutMapping("/{id}")
    public ResponseEntity<RentalSpot> updateSpot(@PathVariable("id") Integer spotId,
            @RequestBody SpotUpdateRequest updateRequest) {
        // å¢åŠ ä¸€å€‹æª¢æŸ¥ï¼Œç¢ºä¿ URL ä¸­çš„ ID èˆ‡è«‹æ±‚å…§å®¹çš„ ID ä¸€è‡´
        if (!spotId.equals(updateRequest.getSpotId())) {
            return ResponseEntity.badRequest().build(); // å›å‚³ 400 éŒ¯èª¤è«‹æ±‚
        }

        // 1. å…ˆå¾è³‡æ–™åº«æŸ¥å‡ºèˆŠè³‡æ–™
        RentalSpot spot = rentalSpotService.selectById(spotId);

        if (spot == null) {
            return ResponseEntity.notFound().build();
        }

        // 2. ä½¿ç”¨ BeanUtils è‡ªå‹•å°‡ DTO çš„å€¼è¤‡è£½åˆ° Entity
        // é€™æœƒè‡ªå‹•æ¯”å°æ¬„ä½åç¨±ï¼Œå°‡ updateRequest çš„å€¼è¤‡è£½åˆ° spot ä¸­ï¼Œçœå»æ‰‹å¯« set çš„ç¹ç‘£
        BeanUtils.copyProperties(updateRequest, spot);

        // 3. å‘¼å« Service çš„ update æ–¹æ³•å„²å­˜
        RentalSpot updatedSpot = rentalSpotService.update(spot);
        return ResponseEntity.ok(updatedSpot);
    }

    /**
     * åˆªé™¤æ“šé» (DELETE /api/spots/{id})
     * (åŸ SpotDeleteController)
     * å„ªåŒ–ï¼šä½¿ç”¨ DELETE æ–¹æ³•ï¼Œæ›´ç¬¦åˆ RESTful é¢¨æ ¼ã€‚
     */
    @DeleteMapping("/{id}")
    public ResponseEntity<Map<String, String>> deleteSpot(@PathVariable("id") Integer spotId) {
        boolean isDeleted = rentalSpotService.deleteById(spotId);
        if (isDeleted) {
            return ResponseEntity.ok(Map.of("message", "Spot with ID " + spotId + " deleted successfully."));
        } else {
            return ResponseEntity.notFound().build();
        }
    }

    /**
     * ä¸Šå‚³æ“šé»åœ–ç‰‡ (POST /api/spot/{id}/upload-image)
     * å°‡åœ–ç‰‡å„²å­˜åˆ°æª”æ¡ˆç³»çµ±ï¼Œè³‡æ–™åº«åªå­˜æª”æ¡ˆè·¯å¾‘
     */
    @PostMapping("/{id}/upload-image")
    public ResponseEntity<Map<String, String>> uploadSpotImage(
            @PathVariable("id") Integer spotId,
            @RequestParam("image") MultipartFile file) {

        try {
            // 1. é©—è­‰æª”æ¡ˆæ˜¯å¦ç‚ºç©º
            if (file.isEmpty()) {
                return ResponseEntity.badRequest()
                        .body(Map.of("message", "è«‹é¸æ“‡è¦ä¸Šå‚³çš„åœ–ç‰‡"));
            }

            // 2. é©—è­‰æª”æ¡ˆé¡å‹
            String contentType = file.getContentType();
            if (contentType == null || !contentType.startsWith("image/")) {
                return ResponseEntity.badRequest()
                        .body(Map.of("message", "åªèƒ½ä¸Šå‚³åœ–ç‰‡æª”æ¡ˆ (jpg, png, gif)"));
            }

            // 3. é©—è­‰æª”æ¡ˆå¤§å° (é™åˆ¶ 5MB)
            long maxSize = 5 * 1024 * 1024; // 5MB
            if (file.getSize() > maxSize) {
                return ResponseEntity.badRequest()
                        .body(Map.of("message", "åœ–ç‰‡å¤§å°ä¸èƒ½è¶…é 5MB"));
            }

            // 4. æŸ¥è©¢æ“šé»æ˜¯å¦å­˜åœ¨
            RentalSpot spot = rentalSpotService.selectById(spotId);
            if (spot == null) {
                return ResponseEntity.notFound().build();
            }

            // 5. å»ºç«‹ uploads ç›®éŒ„ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            String projectRoot = System.getProperty("user.dir");
            String uploadDir = projectRoot + "/" + configUploadPath + "/spots";
            java.io.File directory = new java.io.File(uploadDir);
            if (!directory.exists()) {
                directory.mkdirs();
            }

            // 6. ç”Ÿæˆå”¯ä¸€æª”æ¡ˆåç¨±ï¼ˆä½¿ç”¨æ™‚é–“æˆ³ + åŸå§‹å‰¯æª”åï¼‰
            String originalFilename = file.getOriginalFilename();
            String fileExtension = "";
            if (originalFilename != null && originalFilename.contains(".")) {
                fileExtension = originalFilename.substring(originalFilename.lastIndexOf("."));
            }
            String fileName = "spot_" + spotId + "_" + System.currentTimeMillis() + fileExtension;
            String dbFilePath = configUploadPath + "/spots/" + fileName;

            // 7. åˆªé™¤èˆŠåœ–ç‰‡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (spot.getSpotImage() != null && !spot.getSpotImage().isEmpty()) {
                // åˆªé™¤æ™‚ä¹Ÿè¦ç”¨çµ•å°è·¯å¾‘æ‰¾æª”æ¡ˆ
                java.io.File oldFile = new java.io.File(projectRoot, spot.getSpotImage());
                if (oldFile.exists()) {
                    oldFile.delete();
                }
            }

            // 8. å„²å­˜æª”æ¡ˆåˆ°æª”æ¡ˆç³»çµ±
            java.io.File destFile = new java.io.File(directory, fileName);
            file.transferTo(destFile);

            // 9. æ›´æ–°æ“šé»çš„åœ–ç‰‡æ¬„ä½ï¼ˆå„²å­˜ç›¸å°è·¯å¾‘ï¼‰
            spot.setSpotImage(dbFilePath);
            rentalSpotService.update(spot);

            // 10. å›å‚³æª”æ¡ˆ URLï¼ˆå‰ç«¯å¯ç”¨æ–¼é¡¯ç¤ºï¼‰
            String imageUrl = "/" + dbFilePath; // å‰ç«¯é€ééœæ…‹è³‡æºå­˜å–

            return ResponseEntity.ok(Map.of(
                    "message", "åœ–ç‰‡ä¸Šå‚³æˆåŠŸ",
                    "imageUrl", imageUrl,
                    "filePath", dbFilePath));

        } catch (Exception e) {
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body(Map.of("message", "åœ–ç‰‡ä¸Šå‚³å¤±æ•—: " + e.getMessage()));
        }
    }

    /**
     * åˆªé™¤æ“šé»åœ–ç‰‡ (DELETE /api/spot/{id}/image)
     * åˆªé™¤æª”æ¡ˆç³»çµ±ä¸­çš„åœ–ç‰‡æª”æ¡ˆï¼Œä¸¦æ¸…ç©ºè³‡æ–™åº«æ¬„ä½
     */
    @DeleteMapping("/{id}/image")
    public ResponseEntity<Map<String, String>> deleteSpotImage(@PathVariable("id") Integer spotId) {
        RentalSpot spot = rentalSpotService.selectById(spotId);
        if (spot == null) {
            return ResponseEntity.notFound().build();
        }

        // åˆªé™¤æª”æ¡ˆç³»çµ±ä¸­çš„åœ–ç‰‡
        if (spot.getSpotImage() != null && !spot.getSpotImage().isEmpty()) {
            String projectRoot = System.getProperty("user.dir");
            java.io.File file = new java.io.File(projectRoot, spot.getSpotImage());
            if (file.exists()) {
                file.delete();
            }
        }

        // æ¸…ç©ºè³‡æ–™åº«æ¬„ä½
        spot.setSpotImage(null);
        rentalSpotService.update(spot);

        return ResponseEntity.ok(Map.of("message", "åœ–ç‰‡å·²åˆªé™¤"));
    }

    // endregion
}
</file>

<file path="backend/src/main/java/com/example/backend/model/member/Member.java">
package com.example.backend.model.member;

import java.time.LocalDateTime;

import jakarta.persistence.*;

import org.hibernate.annotations.CreationTimestamp;
import org.hibernate.annotations.UpdateTimestamp;

import com.fasterxml.jackson.annotation.JsonFormat;

@Entity
@Table(name = "member")
public class Member {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "memId")
    private int memId;

    @Column(name = "memUsername", nullable = false, length = 50)
    private String memUsername;

    @Column(name = "memPassword", nullable = false, length = 100)
    private String memPassword;

    @Column(name = "memName", nullable = false, length = 50)
    private String memName;

    @Column(name = "memEmail", nullable = false, length = 50)
    private String memEmail;

    @Column(name = "memPhone", nullable = false, length = 20)
    private String memPhone;

    @Column(name = "memStatus", nullable = false)
    private int memStatus;
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss")
    @CreationTimestamp
    @Column(name = "createdAt", nullable = false, updatable = false)
    private LocalDateTime createdAt;
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss")
    @UpdateTimestamp
    @Column(name = "updatedAt", nullable = false)
    private LocalDateTime updatedAt;

    @Column(name = "memPoints", nullable = false)
    private int memPoints;

    @Column(name = "memViolation", nullable = false)
    private int memViolation;

    @Column(name = "memLevel", nullable = false)
    private int memLevel;

    @Column(name = "memInvoice", length = 20)
    private String memInvoice;

    @Column(name = "memImage", length = 255)
    private String memImage = "default.png";

    public Member() {
    }

    // getter / setter
    public int getMemId() {
        return memId;
    }

    public void setMemId(int memId) {
        this.memId = memId;
    }

    public String getMemUsername() {
        return memUsername;
    }

    public void setMemUsername(String memUsername) {
        this.memUsername = memUsername;
    }

    public String getMemPassword() {
        return memPassword;
    }

    public void setMemPassword(String memPassword) {
        this.memPassword = memPassword;
    }

    public String getMemName() {
        return memName;
    }

    public void setMemName(String memName) {
        this.memName = memName;
    }

    public String getMemEmail() {
        return memEmail;
    }

    public void setMemEmail(String memEmail) {
        this.memEmail = memEmail;
    }

    public String getMemPhone() {
        return memPhone;
    }

    public void setMemPhone(String memPhone) {
        this.memPhone = memPhone;
    }

    public int getMemStatus() {
        return memStatus;
    }

    public void setMemStatus(int memStatus) {
        this.memStatus = memStatus;
    }

    public LocalDateTime getCreatedAt() {
        return createdAt;
    }

    public void setCreatedAt(LocalDateTime createdAt) {
        this.createdAt = createdAt;
    }

    public LocalDateTime getUpdatedAt() {
        return updatedAt;
    }

    public void setUpdatedAt(LocalDateTime updatedAt) {
        this.updatedAt = updatedAt;
    }

    public int getMemPoints() {
        return memPoints;
    }

    public void setMemPoints(int memPoints) {
        this.memPoints = memPoints;
    }

    public int getMemViolation() {
        return memViolation;
    }

    public void setMemViolation(int memViolation) {
        this.memViolation = memViolation;
    }

    public int getMemLevel() {
        return memLevel;
    }

    public void setMemLevel(int memLevel) {
        this.memLevel = memLevel;
    }

    public String getMemInvoice() {
        return memInvoice;
    }

    public void setMemInvoice(String memInvoice) {
        this.memInvoice = memInvoice;
    }

    public String getMemImage() {
        return memImage;
    }

    public void setMemImage(String memImage) {
        this.memImage = memImage;
    }

}
</file>

<file path="backend/src/main/java/com/example/backend/controller/rec/RecRentController.java">
package com.example.backend.controller.rec;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.format.annotation.DateTimeFormat;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import com.example.backend.model.rec.RecRent;
import com.example.backend.model.rec.RentDetails;
import com.example.backend.model.spot.Seat;
import com.example.backend.repository.rec.RecRentRepository;
import com.example.backend.service.rec.RecDetailMgnService;
import com.example.backend.service.spot.SeatService;

import jakarta.transaction.Transactional;

@RestController
@RequestMapping("/rec-rent") // 1. å°‡æ ¹è·¯å¾‘æ”¹ç‚º /rec-rent
@CrossOrigin
@Transactional
public class RecRentController {

    @Autowired // SQL view çš„æŸ¥è©¢
    private RecDetailMgnService recDetailService;

    @Autowired // å¯¦éš›çš„è¨‚å–®TABLE
    private RecRentRepository rentRepos;

    @Autowired // åº§ä½ TABLE çš„æ“ä½œæœå‹™
    private SeatService seatService;

    // 1. æŸ¥è©¢å…¨éƒ¨æˆ–ä¾æ¢ä»¶æœå°‹
    @GetMapping
    public List<RentDetails> searchRents(
            @RequestParam(required = false) Integer recSeqId,
            @RequestParam(required = false) String recId,
            @RequestParam(required = false) Integer memId,
            @RequestParam(required = false) String memName,
            @RequestParam(required = false) String recStatus,
            @RequestParam(required = false) Integer spotId,
            @RequestParam(required = false) String spotName,
            @RequestParam(required = false) @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate startDate,
            @RequestParam(required = false) @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate endDate) {

        // å¦‚æœæ‰€æœ‰åƒæ•¸éƒ½ç‚ºç©ºï¼Œå‰‡è¿”å›æ‰€æœ‰åˆ—è¡¨
        if (recId == null && memId == null && memName == null && recStatus == null && spotId == null && spotName == null
                && startDate == null && endDate == null) {
            return recDetailService.getAllRec();
        }

        // å¦å‰‡ï¼Œå‘¼å« search service
        return recDetailService.search(recSeqId, recId, memId, memName, recStatus, spotId, spotName, startDate,
                endDate);
    }

    // 2. ä¾è¨‚å–®PK (recSeqId) æŸ¥è©¢
    @GetMapping("/{id}")
    public RentDetails getRecById(@PathVariable String id) {
        return recDetailService.getRecById(id);
    }

    // 4. æ–°å¢è¨‚å–®
    @PostMapping("/new") // 2. å°‡ç«¯é»æ”¹ç‚º /new
    public ResponseEntity<RecRent> create(@RequestBody RecRent recRent) {
        // 3. åœ¨å¾Œç«¯æ§åˆ¶å°æ‰“å°æ”¶åˆ°çš„å®Œæ•´è¨‚å–®è³‡æ–™
        System.out.println("æ–°è¨‚å–®è«‹æ±‚: " + recRent.toString());

        // recSeqId æœƒç”±è³‡æ–™åº«è‡ªå‹•ç”¢ç”Ÿ
        // recId æœƒç”±è³‡æ–™åº«è‡ªå‹•è¨ˆç®—

        // èªªæ˜: è‹¥å‰ç«¯æœªæä¾›ç§Ÿå€Ÿæ™‚é–“ï¼Œå‰‡è¨­å®šç‚ºç•¶å‰ä¼ºæœå™¨æ™‚é–“ï¼›è‹¥æœ‰æä¾›å‰‡ä½¿ç”¨å‰ç«¯å€¼
        if (recRent.getRecRentDT2() == null) {
            recRent.setRecRentDT2(LocalDateTime.now());
        }

        RecRent savedRent = rentRepos.save(recRent);

        // ç§Ÿå€Ÿè¨‚å–®å»ºç«‹æˆåŠŸå¾Œï¼ŒåŒæ­¥æ›´æ–°è©²åº§ä½çš„ spotId ç‚º 0 (è¡¨ç¤ºè¢«ç§Ÿç”¨ï¼Œä¸åœ¨ä»»ä½•å¯é¸åœ°é»ä¸Š)
        // ç”±æ–¼æ•´å€‹ Controller å·²æ¨™è¨˜ç‚º @Transactionalï¼Œæ­¤æ“ä½œå°‡èˆ‡ä¸Šé¢çš„è¨‚å–®æ–°å¢åœ¨åŒä¸€å€‹è³‡æ–™åº«äº¤æ˜“ä¸­ï¼Œç¢ºä¿è³‡æ–™ä¸€è‡´æ€§ã€‚
        Integer seatId = Integer.valueOf(savedRent.getSeatsId());

        Seat seatToUpdate = seatService.selectById(seatId);
        if (seatToUpdate != null) {
            seatToUpdate.setSpotId(null);
            seatService.update(seatToUpdate);

        }

        // 4. è¿”å› 201 Created ç‹€æ…‹ç¢¼ä»¥åŠå·²å„²å­˜çš„è¨‚å–®ç‰©ä»¶
        return new ResponseEntity<>(savedRent, HttpStatus.CREATED);
    }

    // 5. ä¾è¨‚å–®æ¥­å‹™ID (recId) æ›´æ–°
    @PutMapping("/{recId}")
    public ResponseEntity<RecRent> update(
            @PathVariable String recId,
            @RequestBody RecRent updatedRentData,
            @RequestParam(required = false) Integer spotIdReturn) { // [æ–°å¢] æ¥æ”¶ URL åƒæ•¸ä½œç‚ºå‚™æ¡ˆ

        // [æ–°å¢] é™¤éŒ¯æ—¥èªŒï¼šç¢ºèªå‰ç«¯å‚³ä¾†çš„è³‡æ–™æ˜¯å¦åŒ…å« spotIdReturn
        System.out.println("æ”¶åˆ°è¨‚å–®æ›´æ–°è«‹æ±‚ RecId: " + recId);
        System.out.println("å‰ç«¯å‚³å…¥çš„æ­¸é‚„ç«™é» (Body): " + updatedRentData.getSpotIdReturn() + ", (Param): " + spotIdReturn);

        // ä½¿ç”¨ recId å¾è³‡æ–™åº«ä¸­æ‰¾åˆ°å°æ‡‰çš„ RecRent å¯¦é«”
        RecRent existingRent = rentRepos.findByRecId(recId);

        // å¦‚æœè¨‚å–®ä¸å­˜åœ¨ï¼Œè¿”å› 404 Not Found
        if (existingRent == null) {
            return new ResponseEntity<>(HttpStatus.NOT_FOUND);
        }
        System.out.println("getRecRentDT2(): " + updatedRentData.getRecStatus());
        System.out.println("updatedgetRecRentDT2(): " + updatedRentData.getRecRentDT2());
        System.out.println(" existgetRecRentDT2(): " + existingRent.getRecRentDT2());
        System.out.println("updatedgetRecReturnDT2(): " + updatedRentData.getRecReturnDT2());
        System.out.println(" existgetRecReturnDT2(): " + existingRent.getRecReturnDT2());

        // èªªæ˜: ç‚ºç¢ºä¿è³‡æ–™ä¸€è‡´æ€§èˆ‡å®‰å…¨æ€§ï¼Œåƒ…æ›´æ–°å…è¨±ä¿®æ”¹çš„æ¬„ä½ã€‚
        // è¨‚å–®æˆç«‹æ™‚çš„æ ¸å¿ƒè³‡è¨Šï¼Œå¦‚æœƒå“¡IDã€åº§ä½IDã€ç§Ÿå€Ÿå ´åœ°èˆ‡ç§Ÿå€Ÿæ™‚é–“ï¼Œåœ¨æ­¤æ–¹æ³•ä¸­ä¸æ‡‰è¢«ä¿®æ”¹ã€‚
        // èªªæ˜: æ›´æ–°é‚„è»Šå ´åœ°ï¼Œåƒ…åœ¨å‰ç«¯æä¾›æ™‚æ›´æ–°
        // [ä¿®æ­£] å„ªå…ˆä½¿ç”¨ Body ä¸­çš„å€¼ï¼Œè‹¥ç‚º null å‰‡å˜—è©¦ä½¿ç”¨ URL Param çš„å€¼ (é›™é‡ä¿éšª)

        // èªªæ˜: æ›´æ–°è¨‚å–®ç‹€æ…‹
        String newStatus = updatedRentData.getRecStatus();
        if (newStatus != null) {
            existingRent.setRecStatus(newStatus);
        }

        Integer finalSpotIdReturn = updatedRentData.getSpotIdReturn();
        if (updatedRentData.getSpotIdReturn() == null) {
            finalSpotIdReturn = spotIdReturn;
        } else {
            existingRent.setSpotIdReturn(finalSpotIdReturn);
        }

        // èªªæ˜: æ›´æ–°å…¶é¤˜å¯è®Šå‹•çš„è¨‚å–®è³‡è¨Šï¼Œåƒ…åœ¨å‰ç«¯æä¾›énullå€¼æ™‚æ‰æ›´æ–°
        if (updatedRentData.getRecRentDT2() != null) {
            existingRent.setRecRentDT2(updatedRentData.getRecRentDT2());
        }
        if (updatedRentData.getSpotIdRent() != null) {
            existingRent.setSpotIdRent(updatedRentData.getSpotIdRent());
        }

        if (updatedRentData.getRecUsageDT2() != null) {
            existingRent.setRecUsageDT2(updatedRentData.getRecUsageDT2());
        }
        if (updatedRentData.getRecPrice() != null) {
            existingRent.setRecPrice(updatedRentData.getRecPrice());
        }
        if (updatedRentData.getRecRequestPay() != null) {
            existingRent.setRecRequestPay(updatedRentData.getRecRequestPay());
        }
        if (updatedRentData.getRecPayment() != null) {
            existingRent.setRecPayment(updatedRentData.getRecPayment());
        }
        if (updatedRentData.getRecPayBy() != null) {
            existingRent.setRecPayBy(updatedRentData.getRecPayBy());
        }
        if (updatedRentData.getRecInvoice() != null) {
            existingRent.setRecInvoice(updatedRentData.getRecInvoice());
        }
        if (updatedRentData.getRecCarrier() != null) {
            existingRent.setRecCarrier(updatedRentData.getRecCarrier());
        }
        if (updatedRentData.getRecViolatInt() != null) {
            existingRent.setRecViolatInt(updatedRentData.getRecViolatInt());
        }
        if (updatedRentData.getRecNote() != null) {
            existingRent.setRecNote(updatedRentData.getRecNote());
        }

        // æ³¨æ„ï¼šä»»ä½• RecRent ä¸­å­˜åœ¨ä½†å‰ç«¯æœªæä¾›çš„æ¬„ä½ï¼Œåœ¨æ­¤è™•å°‡ä¿æŒå…¶åœ¨è³‡æ–™åº«ä¸­çš„åŸå§‹å€¼

        // ä¿å­˜æ›´æ–°å¾Œçš„è¨‚å–®ç‰©ä»¶ï¼ŒJPA å°‡æœƒåŸ·è¡Œ UPDATE æ“ä½œ
        RecRent savedRent = rentRepos.save(existingRent);

        // å¦‚æœå‰ç«¯ç‹€æ…‹æ›´æ–°ç‚ºã€Œå·²æ­¸é‚„ã€ä½†æ²’æœ‰æä¾›æ­¸é‚„æ™‚é–“
        // å‰‡è‡ªå‹•å°‡æ­¸é‚„æ™‚é–“è¨­ç‚ºç•¶å‰ä¼ºæœå™¨æ™‚é–“ã€‚
        if (updatedRentData.getRecReturnDT2() != null) {
            existingRent.setRecReturnDT2(updatedRentData.getRecReturnDT2());
        } else if ("å·²å®Œæˆ".equals(newStatus)) { // è«‹æ³¨æ„: "2" æ˜¯å‡è¨­çš„ã€Œå·²æ­¸é‚„ã€ç‹€æ…‹ä»£ç¢¼ï¼Œè«‹ä¾æ“šæ‚¨ç³»çµ±çš„å¯¦éš›å®šç¾©ä¿®æ”¹ã€‚
            existingRent.setRecReturnDT2(LocalDateTime.now());
        }

        // åŒæ­¥æ›´æ–°è©²åº§ä½çš„åœ°é»(spotId)ç‚ºæ­¸é‚„æ™‚çš„åœ°é»ã€‚
        Integer newSpotId = finalSpotIdReturn; // [ä¿®æ­£] ä½¿ç”¨æ•´åˆå¾Œçš„è®Šæ•¸
        if ("å·²å®Œæˆ".equals(newStatus) && newSpotId != null) {
            Integer seatId = Integer.valueOf(savedRent.getSeatsId());
            if (seatId != null) {
                Seat seatToUpdate = seatService.selectById(seatId);
                if (seatToUpdate != null) {
                    seatToUpdate.setSpotId(newSpotId);
                    seatService.update(seatToUpdate);
                }
            }
        }

        // è¿”å› 200 OK ä»¥åŠæ›´æ–°å¾Œçš„è¨‚å–®ç‰©ä»¶
        return new ResponseEntity<>(savedRent, HttpStatus.OK);
    }

    // 6. ä¾è¨‚å–®æ¥­å‹™ID (recId) åˆªé™¤
    @DeleteMapping("/{recId}")
    public ResponseEntity<Void> delete(@PathVariable String recId) { // æª¢æŸ¥è¨‚å–®æ˜¯å¦å­˜åœ¨
        if (recDetailService.getRecById(recId) == null) {
            return new ResponseEntity<>(HttpStatus.NOT_FOUND);
        }
        // å‘¼å« repository ä¾ recId åˆªé™¤
        rentRepos.deleteByRecId(recId);
        // è¿”å› 204 No Content è¡¨ç¤ºæˆåŠŸåˆªé™¤
        return new ResponseEntity<>(HttpStatus.NO_CONTENT);
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/repository/projection/AnalyzeProjections.java">
package com.example.backend.repository.projection;

public class AnalyzeProjections {

    // ç«™é»æ–¼å„åŸå¸‚ä¹‹åˆ†å¸ƒçµ±è¨ˆ
    public interface SpotCountByCity {
        String getCity();

        Integer getSpotCount();
    }

    // å„æ™‚æ®µç§Ÿå€Ÿæ¬¡æ•¸çµ±è¨ˆ
    public interface HourlyRate {
        Integer getHourofDay();

        Integer getRentedCount();
    }

    // ç«™é»å³æ™‚ç›£æ§ (åç¨±ã€ç¸½åº§ä½ã€å·²ç§Ÿå€Ÿ)
    public interface SpotMonitor {
        Integer getSpotId(); // æ–°å¢ ID ä»¥ä¾¿å‰ç«¯é€²è¡Œèª¿åº¦æ“ä½œ

        String getSpotName();

        Integer getTotalSeats();

        Integer getAvailableSeats();
    }

    // å„ç§Ÿå€Ÿæ™‚é•·å€é–“çµ±è¨ˆ
    public interface DurationRate {
        String getDurationRange();

        Integer getCount();
    }

    // ç†±é–€é»ä½çµ±è¨ˆ (é¦–é ä½¿ç”¨)
    public interface HotSpot {
        Integer getSpotId();

        String getSpotName();

        String getSpotStatus();

        Integer getAvailableSeats();

        String getSpotImage();

        Double getLatitude();

        Double getLongitude();

        Integer getOrderCount();
    }

    // [æ–°å¢] ç«™é»èˆ‡å³æ™‚åº§ä½æ•¸ (åœ°åœ–æ¨™è¨˜ä½¿ç”¨)
    public interface SpotWithSeats {
        Integer getSpotId();

        String getSpotName();

        String getSpotStatus();

        Double getLatitude();

        Double getLongitude();

        String getSpotImage();

        Integer getAvailableSeats();
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/controller/member/AdminController.java">
package com.example.backend.controller.member;

import java.util.List;
import java.util.Map;

import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import com.example.backend.model.member.Admin;
import com.example.backend.service.member.AdminService;

@CrossOrigin(origins = "http://localhost:5173")
@RestController
@RequestMapping("/admins")
public class AdminController {

    private final AdminService adminService;

    public AdminController(AdminService adminService) {
        this.adminService = adminService;
    }

    // æŸ¥å…¨éƒ¨
    @GetMapping
    public List<Admin> findAll() {
        return adminService.findAll();
    }

    // æŸ¥å–®ç­†
    @GetMapping("/find")
    public Object findOne(@RequestParam(required = false) Integer admId) {

        if (admId == null) {
            return "è«‹è¼¸å…¥ admId";
        }

        Admin admin = adminService.findById(admId);
        return admin != null ? admin : "æŸ¥ç„¡æ­¤ç®¡ç†å“¡";
    }

    // æ–°å¢
    @PostMapping
    public ResponseEntity<?> insert(@RequestBody Admin admin) {
        try {
            adminService.insert(admin);
            return ResponseEntity.ok("ç®¡ç†å“¡æ–°å¢æˆåŠŸ");
        } catch (IllegalArgumentException e) {
            return ResponseEntity.badRequest().body(e.getMessage());
        }
    }

    // ä¿®æ”¹
    @PostMapping("/update")
    public String update(@RequestBody Admin admin) {

        Admin old = adminService.findById(admin.getAdmId());
        if (old == null) {
            return "æŸ¥ç„¡æ­¤ç®¡ç†å“¡";
        }

        old.setAdmUsername(admin.getAdmUsername());
        old.setAdmName(admin.getAdmName());
        old.setAdmEmail(admin.getAdmEmail());
        old.setAdmRole(admin.getAdmRole());
        old.setUpdatedAt(java.time.LocalDateTime.now());
        //old.setAdminImage(admin.getAdminImage());
        // å¯†ç¢¼ï¼šæœ‰å‚³æ‰æ›´æ–°
        if (admin.getAdmPassword() != null && !admin.getAdmPassword().isBlank()) {
            old.setAdmPassword(admin.getAdmPassword());
        }

        adminService.update(old);
        return "ç®¡ç†å“¡ä¿®æ”¹æˆåŠŸ";
    }

    // åˆªé™¤
    @GetMapping("/delete")
    public String delete(@RequestParam Integer admId) {
        adminService.deleteById(admId);
        return "ç®¡ç†å“¡åˆªé™¤æˆåŠŸï¼ˆadmId=" + admId + "ï¼‰";
    }

    // æ¨¡ç³ŠæŸ¥è©¢
    @GetMapping("/search")
    public List<Admin> search(@RequestParam String keyword) {
        return adminService.findByKeyword(keyword);
    }

    // åœæ¬Š
    @GetMapping("/disable")
    public String disable(@RequestParam Integer admId) {

        Admin admin = adminService.findById(admId);
        if (admin == null) {
            return "æŸ¥ç„¡æ­¤ç®¡ç†å“¡";
        }

        admin.setAdmStatus(0);
        adminService.update(admin);

        return "ç®¡ç†å“¡å·²åœæ¬Šï¼ˆadmId=" + admId + "ï¼‰";
    }

    // å•Ÿç”¨
    @GetMapping("/enable")
    public String enable(@RequestParam Integer admId) {

        Admin admin = adminService.findById(admId);
        if (admin == null) {
            return "æŸ¥ç„¡æ­¤ç®¡ç†å“¡";
        }

        admin.setAdmStatus(1);
        adminService.update(admin);

        return "ç®¡ç†å“¡å·²å•Ÿç”¨ï¼ˆadmId=" + admId + "ï¼‰";
    }

    // åœè· API (å°æ‡‰å‰ç«¯çš„ confirmBanAdmin)
    @PostMapping("/ban")
    public ResponseEntity<?> banAdmin(@RequestBody Map<String, Object> payload) {
        try {
            Object idObj = payload.get("admId");
            if (idObj == null)
                return ResponseEntity.badRequest().body("ç¼ºå°‘ admId");
            Integer admId = Integer.valueOf(idObj.toString());

            Admin admin = adminService.findById(admId);
            if (admin == null)
                return ResponseEntity.status(404).body("æ‰¾ä¸åˆ°è©²ç®¡ç†å“¡");

            // ä¿®æ”¹ç‹€æ…‹
            admin.setAdmStatus(0);
            admin.setUpdatedAt(java.time.LocalDateTime.now());

            // é—œéµï¼šå› ç‚º Service çš„ update æœƒè·‘ normalize (æª¢æŸ¥ trim)
            // å¦‚æœä½ çš„è³‡æ–™åº«æ¬„ä½æœ‰ç©ºå€¼ï¼Œé€™é‚Šå»ºè­°ç›´æ¥ç”¨ repository å­˜ï¼Œ
            // æˆ–è€…ç¢ºä¿ admin ç‰©ä»¶å…§å®¹æ˜¯å®Œæ•´çš„ã€‚
            // é€™è£¡æˆ‘å€‘ç›´æ¥å‘¼å«åŸæœ¬çš„ updateï¼š
            adminService.update(admin);

            return ResponseEntity.ok("ç®¡ç†å“¡å·²åœè·");
        } catch (Exception e) {
            e.printStackTrace(); // é€™è¡Œå¾ˆé‡è¦ï¼Œè«‹çœ‹ Eclipse/IntelliJ çš„ Console å ±ä»€éº¼éŒ¯
            return ResponseEntity.status(500).body("æ“ä½œå¤±æ•—ï¼š" + e.getMessage());
        }
    }

    // é‡æ–°å•Ÿç”¨ API (å°æ‡‰å‰ç«¯çš„ activateAdmin)
    @PostMapping("/activate")
    public ResponseEntity<?> activateAdmin(@RequestBody Map<String, Object> payload) {
        try {
            // å–å¾— admId
            Integer admId = (Integer) payload.get("admId");

            Admin admin = adminService.findById(admId);
            if (admin == null) {
                return ResponseEntity.status(404).body("æ‰¾ä¸åˆ°è©²ç®¡ç†å“¡");
            }

            // å°‡ç‹€æ…‹è¨­ç‚º 1 (å•Ÿç”¨)
            admin.setAdmStatus(1);
            admin.setUpdatedAt(java.time.LocalDateTime.now());

            // å„²å­˜è®Šæ›´
            adminService.update(admin);

            return ResponseEntity.ok("ç®¡ç†å“¡å·²é‡æ–°å•Ÿç”¨");
        } catch (Exception e) {
            e.printStackTrace();
            return ResponseEntity.status(500).body("å•Ÿç”¨å¤±æ•—ï¼š" + e.getMessage());
        }
    }

    @PostMapping("/{id}/role")
    public ResponseEntity<?> updateRole(@PathVariable Integer id, @RequestBody Map<String, Integer> payload) {
        try {
            // é€é Service æ‰¾åˆ°ç®¡ç†å“¡
            Admin admin = adminService.findById(id);
            if (admin == null) {
                return ResponseEntity.status(404).body("æ‰¾ä¸åˆ°è©²ç®¡ç†å“¡");
            }

            // æ›´æ–°æ¬Šé™
            admin.setAdmRole(payload.get("admRole"));
            admin.setUpdatedAt(java.time.LocalDateTime.now()); // ç¢ºä¿æ›´æ–°æ™‚é–“æœ‰è®Šå‹•

            // å‘¼å« Service çš„ update æ–¹æ³•å­˜å›è³‡æ–™åº«
            adminService.update(admin);

            return ResponseEntity.ok("æ¬Šé™æ›´æ–°æˆåŠŸ");
        } catch (Exception e) {
            e.printStackTrace();
            return ResponseEntity.status(500).body("æ›´æ–°å¤±æ•—ï¼š" + e.getMessage());
        }
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/controller/member/MemberController.java">
package com.example.backend.controller.member;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import com.example.backend.model.member.Member;
import com.example.backend.service.member.MemberService;

@CrossOrigin(origins = "http://localhost:5173") // ç¢ºä¿è·¨åŸŸæ²’å•é¡Œ
@RestController
@RequestMapping("/api/members")
public class MemberController {

    private final MemberService memberService;

    public MemberController(MemberService memberService) {
        this.memberService = memberService;
    }

    // æŸ¥å…¨éƒ¨
    @GetMapping
    public List<Member> findAll() {
        return memberService.findAll();
    }

    // æŸ¥å–®ç­†
    @GetMapping("/find")
    public ResponseEntity<?> findOne(@RequestParam(required = false) Integer memId) {
        if (memId == null) {
            return ResponseEntity.badRequest().body("è«‹è¼¸å…¥ memId");
        }

        Member member = memberService.findById(memId);

        if (member != null) {
            // --- æš´åŠ›æ‹†è§£æ³•ï¼šåªå‚³éœ€è¦çš„æ¬„ä½ï¼Œé¿é–‹æ‰€æœ‰å¯èƒ½å°è‡´ 500 çš„è¤‡é›œç‰©ä»¶ ---
            Map<String, Object> response = new HashMap<>();
            response.put("memId", member.getMemId());
            response.put("memPoints", member.getMemPoints());
            response.put("memName", member.getMemName());
            response.put("memUsername", member.getMemUsername());
            response.put("memEmail", member.getMemEmail());
            response.put("memPhone", member.getMemPhone());
            response.put("memInvoice", member.getMemInvoice());
            response.put("memImage", member.getMemImage());

            return ResponseEntity.ok(response);
        } else {
            return ResponseEntity.status(404).body("æŸ¥ç„¡æ­¤æœƒå“¡");
        }
    }

    // æ–°å¢
    @PostMapping
    public ResponseEntity<?> insert(@RequestBody Member member) {
        try {
            memberService.insert(member);
            return ResponseEntity.ok("æœƒå“¡æ–°å¢æˆåŠŸ");
        } catch (IllegalArgumentException e) {
            return ResponseEntity.badRequest().body(e.getMessage());
        }
    }

    // ä¿®æ”¹
    @PostMapping("/update")
    public ResponseEntity<?> update(@RequestBody Member member) {

        // æ ¹æ“š ID æ‰¾åˆ°èˆŠè³‡æ–™ (é€™æ­¥å¾ˆé‡è¦ï¼Œç¢ºä¿æ˜¯æ›´æ–°ç¾æœ‰è³‡æ–™åº«è³‡æ–™)
        Member old = memberService.findById(member.getMemId());
        if (old == null) {
            return ResponseEntity.status(404).body("æŸ¥ç„¡æ­¤æœƒå“¡");
        }

        // å°‡å‰ç«¯å‚³ä¾†çš„è³‡æ–™å¡«å…¥ old ç‰©ä»¶
        old.setMemName(member.getMemName());
        old.setMemEmail(member.getMemEmail());
        old.setMemPhone(member.getMemPhone());
        old.setMemInvoice(member.getMemInvoice());
        old.setMemUsername(member.getMemUsername());
        old.setMemPoints(member.getMemPoints());

        // å‘¼å« Service æ›´æ–° (åªå‘¼å«é€™ä¸€å€‹ update å³å¯ï¼Œå®ƒæœƒè™•ç†å­˜æª”)
        try {
            // é€™è£¡æœƒåŒæ™‚è™•ç†åŸºæœ¬è³‡æ–™å­˜æª”èˆ‡å¯†ç¢¼é©—è­‰
            memberService.update(old, member.getMemPassword());
        } catch (IllegalArgumentException e) {
            // å¦‚æœå¯†ç¢¼æ ¼å¼ä¸å°ï¼Œå›å‚³éŒ¯èª¤è¨Šæ¯çµ¦å‰ç«¯
            return ResponseEntity.badRequest().body(e.getMessage());
        }

        return ResponseEntity.ok("æœƒå“¡ä¿®æ”¹æˆåŠŸ");
    }

    // åˆªé™¤
    @GetMapping("/delete")
    public String delete(@RequestParam Integer memId) {
        memberService.deleteById(memId);
        return "æœƒå“¡åˆªé™¤æˆåŠŸï¼ˆmemId=" + memId + "ï¼‰";
    }

    // æ¨¡ç³ŠæŸ¥è©¢
    @GetMapping("/search")
    public Object search(@RequestParam String keyword) {
        if (keyword == null || keyword.isBlank()) {
            return "è«‹è¼¸å…¥æœå°‹é—œéµå­—";
        }
        return memberService.search(keyword);
    }

    // æœƒå“¡è¨»å†Š
    @PostMapping("/register")
    public ResponseEntity<?> register(@RequestBody Member member) {
        try {
            memberService.insert(member);
            return ResponseEntity.ok("è¨»å†ŠæˆåŠŸ");
        } catch (IllegalArgumentException e) {
            return ResponseEntity.badRequest().body(e.getMessage());
        }
    }

    // 1. åœæ¬Š API (å°æ‡‰å‰ç«¯çš„ confirmBanMember)
    @PostMapping("/ban")
    public ResponseEntity<?> banMember(@RequestBody Map<String, Object> payload) {
        try {
            // å¾å‰ç«¯å‚³ä¾†çš„ JSON å–å¾— memId (å‰ç«¯å‚³çš„æ˜¯ { memId: xxx, reason: yyy })
            Integer memId = (Integer) payload.get("memId");

            // æ‰¾åˆ°è©²æœƒå“¡
            Member member = memberService.findById(memId);
            if (member == null) {
                return ResponseEntity.status(404).body("æ‰¾ä¸åˆ°è©²æœƒå“¡");
            }

            // å°‡ç‹€æ…‹è¨­ç‚º 0 (åœæ¬Š)
            member.setMemStatus(0);

            // å„²å­˜è®Šæ›´ (ç›´æ¥ç”¨ä½ ç¾æœ‰çš„ update æ–¹æ³•ï¼Œå¯†ç¢¼å‚³ null ä»£è¡¨ä¸æ”¹å¯†ç¢¼)
            memberService.update(member, null);

            return ResponseEntity.ok("æœƒå“¡å·²æˆåŠŸåœæ¬Š");
        } catch (Exception e) {
            e.printStackTrace(); // åœ¨å¾Œç«¯çµ‚ç«¯æ©Ÿå°å‡ºéŒ¯èª¤ç´°ç¯€
            return ResponseEntity.status(500).body("åœæ¬Šå¤±æ•—ï¼š" + e.getMessage());
        }
    }

    // 2. é‡æ–°å•Ÿç”¨ API (å°æ‡‰å‰ç«¯çš„ activateMember)
    @PostMapping("/activate")
    public ResponseEntity<?> activateMember(@RequestBody Map<String, Object> payload) {
        try {
            Integer memId = (Integer) payload.get("memId");

            Member member = memberService.findById(memId);
            if (member == null) {
                return ResponseEntity.status(404).body("æ‰¾ä¸åˆ°è©²æœƒå“¡");
            }

            // å°‡ç‹€æ…‹è¨­ç‚º 1 (å•Ÿç”¨)
            member.setMemStatus(1);

            // å„²å­˜è®Šæ›´
            memberService.update(member, null);

            return ResponseEntity.ok("æœƒå“¡å·²é‡æ–°å•Ÿç”¨");
        } catch (Exception e) {
            e.printStackTrace();
            return ResponseEntity.status(500).body("å•Ÿç”¨å¤±æ•—ï¼š" + e.getMessage());
        }
    }

}
</file>

<file path="backend/src/main/java/com/example/backend/controller/payment/PaymentApiController.java">
package com.example.backend.controller.payment;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import com.example.backend.model.rec.RecRent;
import com.example.backend.model.spot.Seat;
import com.example.backend.repository.rec.RecRentRepository;
import com.example.backend.service.merchantAndCoupon.PaymentService;
import com.example.backend.service.spot.SeatService;
import com.example.backend.utils.EcpayUtils;

@RestController
@RequestMapping("/api/payment")
public class PaymentApiController {

    @Autowired
    private RecRentRepository recRentRepository;

    @Autowired
    private com.example.backend.repository.merchantAndCoupon.SponsorshipRepository sponsorshipRepository; // ğŸ’¡ æ³¨å…¥è´ŠåŠ©
                                                                                                          // Repository

    @Autowired
    private EcpayUtils ecpayUtils;

    @Autowired
    private PaymentService paymentService;

    @Autowired
    private SeatService seatService;

    @CrossOrigin(origins = "http://localhost:5173", allowCredentials = "true") //
    @PostMapping(value = "/checkout", produces = "text/html;charset=UTF-8")
    public String checkout(
            @RequestParam("recId") String recId,
            @RequestParam("amount") String amount,
            @RequestParam("baseUrl") String baseUrl) {
        RecRent order = recRentRepository.findByRecId(recId);
        if (order == null) {
            return "<h2>è¨‚å–®ä¸å­˜åœ¨</h2>";
        }
        String itemName = "ç§Ÿå€Ÿè²»ç”¨-" + order.getRecId();
        String tradeNo = order.getRecId() + "X" + (System.currentTimeMillis() / 1000);

        return ecpayUtils.genCheckOutForm(tradeNo, amount, itemName, baseUrl);
    }

    /**
     * 2. ç”¢ç”Ÿè´ŠåŠ©è¡¨å–®
     * ğŸ’¡ ä¿®æ”¹ï¼šåŠ å…¥ memberId èˆ‡ commentï¼Œä¸¦åœ¨è·³è½‰å‰å­˜å…¥è³‡æ–™åº«
     */
    @PostMapping(value = "/sponsor", produces = "text/html;charset=UTF-8")
    public String sponsor(@RequestParam("memberId") Integer memberId,
            @RequestParam("amount") BigDecimal amount,
            @RequestParam(value = "comment", required = false) String comment,
            @RequestParam("baseUrl") String baseUrl) {

        // æ‰€æœ‰çš„é«’æ´»ï¼ˆå­˜è³‡æ–™åº«ã€ç”¢è¡¨å–®ï¼‰éƒ½ä¸Ÿçµ¦ Service
        return paymentService.createSponsorshipOrder(memberId, amount, comment, baseUrl);
    }

    /**
     * 3. ç¶ ç•Œç€è¦½å™¨è·³è½‰é  (OrderResultURL)
     */
    @RequestMapping(value = "/payment-success", method = { RequestMethod.GET,
            RequestMethod.POST }, produces = "text/html;charset=UTF-8")
    public String paymentSuccess(@RequestParam Map<String, String> formData) {

        String rtnCode = formData.getOrDefault("RtnCode", "0");
        String tradeNo = formData.get("MerchantTradeNo");
        System.out.println("formData: " + formData);
        if (tradeNo != null && tradeNo.startsWith("SPN")) {
            paymentService.processPaymentResult(formData);
        }

        String message = "1".equals(rtnCode) ? "è¨‚å–®æ”¯ä»˜æˆåŠŸï¼" : "æ”¯ä»˜éç¨‹ä¼¼ä¹æœ‰èª¤ï¼Œè«‹æ´½ç®¡ç†å“¡ã€‚";
        String icon = "1".equals(rtnCode) ? "success" : "error";

        return "<html><head><meta charset='UTF-8'><script src='https://cdn.jsdelivr.net/npm/sweetalert2@11'></script></head>"
                +
                "<body><script>window.onload = function() {" +
                "  Swal.fire({ title: '" + message + "', icon: '" + icon +
                "', showDenyButton: true, confirmButtonText: 'å›åˆ°é¦–é ', denyButtonText: 'æŸ¥çœ‹è¨‚å–®', denyButtonColor: '#28a745', allowOutsideClick: false }).then((result) => {"
                +
                "    if (result.isConfirmed) {" +
                "      if (window.opener) { window.opener.postMessage('PAYMENT_SUCCESS', '*'); window.close(); }" +
                "      else { window.location.href = 'http://localhost:5173/'; }" +
                "    } else if (result.isDenied) {" +
                "      window.location.href = 'http://localhost:5173/rent/record';" +
                "    }" +
                "  });" +
                "};</script></body></html>";
    }

    /**
     * 4. ç¶ ç•Œå¾Œå°éåŒæ­¥å›å‚³ (ReturnURL)
     */
    @PostMapping("/callback")
    public String callback(@RequestParam Map<String, String> formData) {
        String ecpayTradeNo = formData.get("MerchantTradeNo");
        String rtnCode = formData.get("RtnCode");
        String tradeAmt = formData.get("TradeAmt");

        if ("1".equals(rtnCode)) {
            // A. è™•ç†è´ŠåŠ©ç´€éŒ„æ›´æ–°
            if (ecpayTradeNo.startsWith("SPN")) {
                // ğŸ’¡ ä¿®æ­£ï¼šç›´æ¥å‘¼å« Serviceï¼Œå®ƒæœƒè™•ç†ç‹€æ…‹è®Šæ›´ + æœƒå“¡åŠ é»
                paymentService.processPaymentResult(formData);
                return "1|OK";
            }

            // B. è™•ç†ç§Ÿå€Ÿè¨‚å–®æ›´æ–°
            String realId = ecpayTradeNo.contains("X") ? ecpayTradeNo.split("X")[0] : ecpayTradeNo;
            RecRent order = recRentRepository.findByRecId(realId);
            System.out.println("*realId:  " + realId);
            if (order != null) {
                // 1. æ›´æ–°è¨‚å–®ç‹€æ…‹èˆ‡ä»˜æ¬¾è³‡è¨Š
                order.setRecStatus("å·²å®Œæˆ"); // æ”¹ç‚ºèˆ‡ RecRentController ä¸€è‡´çš„ç‹€æ…‹
                order.setRecPayment((int) Double.parseDouble(tradeAmt));
                order.setRecPayBy(formData.get("PaymentType"));

                // è‹¥ç„¡æ­¸é‚„æ™‚é–“ï¼Œè£œä¸Šç•¶ä¸‹æ™‚é–“
                if (order.getRecReturnDT2() == null) {
                    order.setRecReturnDT2(LocalDateTime.now());
                }

                recRentRepository.save(order);

                // 2. åŸ·è¡Œæ­¸é‚„é‚è¼¯ï¼šæ›´æ–°åº§ä½ä½ç½® (å°æ‡‰ RecRentController.update çš„é‚è¼¯)
                Integer returnSpotId = order.getSpotIdReturn();

                // [æ–°å¢] é™¤éŒ¯æ—¥èªŒ
                System.out.println("ä»˜æ¬¾å›èª¿è™•ç†ä¸­ - è¨‚å–®: " + realId + ", è³‡æ–™åº«ä¸­çš„æ­¸é‚„ç«™é» ID: " + returnSpotId);

                if (returnSpotId != null) {
                    try {
                        Seat seat = seatService.selectById(Integer.valueOf(order.getSeatsId()));
                        seat.setSpotId(returnSpotId);
                        seatService.update(seat);
                        System.out.println("åº§ä½ " + seat.getSeatsId() + " å·²æˆåŠŸç§»å‹•è‡³ç«™é» " + returnSpotId);
                    } catch (Exception e) {
                        System.err.println("ä»˜æ¬¾å›èª¿æ›´æ–°åº§ä½å¤±æ•—: " + e.getMessage());
                    }
                } else {
                    System.err.println("è­¦å‘Šï¼šè¨‚å–® " + realId + " çš„æ­¸é‚„ç«™é» ID ç‚ºç©ºï¼Œç„¡æ³•æ›´æ–°åº§ä½ä½ç½®ï¼");
                }

                return "1|OK";
            }
        }
        return "0|Error";
    }

    @GetMapping("/admin/sponsors")
    public ResponseEntity<?> getAllSponsors() {
        // å‡è¨­ä½ åœ¨ SponsorshipRepository è£¡æœ‰ findAll()
        return ResponseEntity.ok(sponsorshipRepository.findAllByOrderBySponsorIdDesc());
    }
}
</file>

<file path="backend/src/main/java/com/example/backend/model/member/Admin.java">
package com.example.backend.model.member;

import java.time.LocalDateTime;

import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.PrePersist;
import jakarta.persistence.PreUpdate;
import jakarta.persistence.Table;
import lombok.Data;

@Data
@Entity
@Table(name = "admin")
public class Admin {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "admId")
    private Integer admId;

    @Column(name = "admUsername", nullable = false, unique = true)
    private String admUsername;

    @Column(name = "admPassword", nullable = false)
    private String admPassword;

    @Column(name = "admName", nullable = false)
    private String admName;

    @Column(name = "admEmail", nullable = false)
    private String admEmail;

    @Column(name = "admRole", nullable = false)
    private Integer admRole;

    @Column(name = "createdAt")
    private LocalDateTime createdAt;

    @Column(name = "updatedAt")
    private LocalDateTime updatedAt;

    // åœ¨é¡åˆ¥è£¡é¢è£œä¸Šé€™å…©å€‹è‡ªå‹•è¨­å®šï¼Œé€™æ¨£ä½ æ–°å¢ã€ä¿®æ”¹å°±éƒ½ä¸ç”¨æ‰‹å‹• set æ™‚é–“äº†
    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
        this.updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }

    @Column(name = "admStatus")
    private Integer admStatus = 1;
}
</file>

<file path="backend/src/main/java/com/example/backend/repository/spot/RentalSpotRepository.java">
package com.example.backend.repository.spot;

import java.util.List;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import com.example.backend.model.spot.RentalSpot;
import com.example.backend.repository.projection.AnalyzeProjections.SpotCountByCity;
import com.example.backend.repository.projection.AnalyzeProjections.SpotMonitor;
import com.example.backend.repository.projection.AnalyzeProjections.HotSpot;

@Repository
public interface RentalSpotRepository extends JpaRepository<RentalSpot, Integer>, JpaSpecificationExecutor<RentalSpot> {

    @Query("SELECT r FROM RentalSpot r WHERE r.spotCode LIKE %:keyword% OR r.spotName LIKE %:keyword% OR r.spotAddress LIKE %:keyword%")
    List<RentalSpot> findByKeyword(@Param("keyword") String keyword);

    boolean existsBySpotCode(String spotCode);

    @Query(value = """
                SELECT
                    SUBSTRING(spotAddress, 1, 3) as city,
                    COUNT(*) as spotCount
                FROM renting_Spot
                WHERE spotAddress IS NOT NULL
                GROUP BY SUBSTRING(spotAddress, 1, 3)
                ORDER BY spotCount DESC
            """, nativeQuery = true)
    List<SpotCountByCity> getCityDistribution();

    @Query(value = """
                SELECT
                    s.spotId   AS spotId,
                    s.spotName AS spotName,
                    20 AS totalSeats,
                    COALESCE(curr.availableCount, 0) AS availableSeats
                FROM renting_Spot s
                LEFT JOIN (
                    SELECT spotId, COUNT(*) AS availableCount
                    FROM seats
                    WHERE seatsStatus = N'å•Ÿç”¨' AND spotId IS NOT NULL
                    -- æ’é™¤ç›®å‰æ­£åœ¨ç§Ÿå€Ÿä¸­çš„åº§ä½
                    AND seatsId NOT IN (
                        SELECT CAST(seatsId AS INT) FROM recRent WHERE recStatus = N'ç§Ÿå€Ÿä¸­'
                    )
                    GROUP BY spotId
                ) curr ON curr.spotId = s.spotId
                WHERE s.spotStatus = N'ç‡Ÿé‹ä¸­'
            """, nativeQuery = true)
    List<SpotMonitor> getSpotRealtimeStatus();

    /**
     * ç²å–ç†±é–€é»ä½ (ä¾æ“šç§Ÿå€Ÿæ¬¡æ•¸æ’åºï¼Œå–å‰ 4 å)
     * ç”¨æ–¼é¦–é  HomeView å‘ˆç¾ã€‚
     */
    @Query(value = """
                SELECT TOP 4
                    s.spotId,
                    s.spotName,
                    s.spotStatus,
                    COALESCE(curr.availableCount, 0) AS availableSeats,
                    s.spotImage,
                    s.latitude,
                    s.longitude,
                    COUNT(r.recId) AS orderCount
                FROM renting_Spot s
                LEFT JOIN (
                    SELECT spotId, COUNT(*) AS availableCount
                    FROM seats
                    WHERE seatsStatus = N'å•Ÿç”¨' AND spotId IS NOT NULL
                    -- æ’é™¤ç›®å‰æ­£åœ¨ç§Ÿå€Ÿä¸­çš„åº§ä½
                    AND seatsId NOT IN (
                        SELECT CAST(seatsId AS INT) FROM recRent WHERE recStatus = N'ç§Ÿå€Ÿä¸­'
                    )
                    GROUP BY spotId
                ) curr ON curr.spotId = s.spotId
                LEFT JOIN recRent r ON r.spotIdRent = s.spotId
                WHERE s.spotStatus = N'ç‡Ÿé‹ä¸­'
                GROUP BY s.spotId, s.spotName, s.spotStatus, curr.availableCount, s.spotImage, s.latitude, s.longitude
                ORDER BY orderCount DESC
            """, nativeQuery = true)
    List<HotSpot> getHotSpots();

    /**
     * [æ–°å¢] ç²å–æ‰€æœ‰ç‡Ÿé‹ä¸­çš„ç«™é»åŠå…¶å³æ™‚åº§ä½æ•¸
     * ç”¨æ–¼é¦–é åœ°åœ–æ¨™è¨˜å‘ˆç¾ã€‚
     */
    @Query(value = """
                SELECT
                    s.spotId,
                    s.spotName,
                    s.spotStatus,
                    s.latitude,
                    s.longitude,
                    s.spotImage,
                    COALESCE(curr.availableCount, 0) AS availableSeats
                FROM renting_Spot s
                LEFT JOIN (
                    SELECT spotId, COUNT(*) AS availableCount
                    FROM seats
                    WHERE seatsStatus = N'å•Ÿç”¨' AND spotId IS NOT NULL
                    AND seatsId NOT IN (
                        SELECT CAST(seatsId AS INT) FROM recRent WHERE recStatus = N'ç§Ÿå€Ÿä¸­'
                    )
                    GROUP BY spotId
                ) curr ON curr.spotId = s.spotId
                WHERE s.spotStatus = N'ç‡Ÿé‹ä¸­'
            """, nativeQuery = true)
    List<com.example.backend.repository.projection.AnalyzeProjections.SpotWithSeats> findAllSpotsWithSeatCount();
}
</file>

<file path="backend/src/main/resources/application.yml">
server:
  port: 8080

app:
  file:
    upload-path: uploads

spring:
  profiles:
    active: local

  application:
    name: seat-rent-backend

  # --- æ–°å¢ Google OAuth2 è¨­å®š ---
  security:
    oauth2:
      client:
        registration:
          google:
            client-id: 231325237264-ngpc81gmkl8pop0nq8jlgv0g63pj9fjg.apps.googleusercontent.com
            client-secret: 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
            scope:
              - email
              - profile

  # æœ¬åœ°ç«¯è³‡æ–™åº«é€£ç·šè¨­å®š
  datasource:
    driver-class-name: com.microsoft.sqlserver.jdbc.SQLServerDriver

  # JPA èˆ‡ Hibernate è¨­å®š (æ ¼å¼ä¿®æ­£ï¼šåŸæœ¬é€™æ®µåœ¨ datasource å…§æœƒè®€ä¸åˆ°)
  jpa:
    show-sql: true
    hibernate:
      ddl-auto: none
      naming:
        physical-strategy: org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl
        implicit-strategy: org.hibernate.boot.model.naming.ImplicitNamingStrategyLegacyJpaImpl
    properties:
      "[hibernate.format_sql]": true
      "[hibernate.default_schema]": dbo
      "[hibernate.dialect]": org.hibernate.dialect.SQLServerDialect
      "[hibernate.jdbc.lob.non_contextual_creation]": true

  # --- æ–°å¢éƒµä»¶ç™¼é€è¨­å®š ---
  mail:
    host: smtp.gmail.com
    port: 587
    username: alan123149@gmail.com
    password: nyjctvblehdjzxbc
    properties:
      mail:
        smtp:
          auth: true
          starttls:
            enable: true

# Coze Web Chat SDK é…ç½®
# ç”¨é€”ï¼šæä¾›å‰ç«¯åˆå§‹åŒ– Coze AI å®¢æœæ‰€éœ€çš„è³‡è¨Š
#
# è¨­å®šæ–¹å¼ï¼š
# 1. ç›´æ¥åœ¨æ­¤æª”æ¡ˆè¨­å®šï¼ˆé–‹ç™¼ç’°å¢ƒï¼‰
# 2. ä½¿ç”¨ç’°å¢ƒè®Šæ•¸ï¼ˆæ­£å¼ç’°å¢ƒå»ºè­°ï¼‰ï¼š
#    export COZE_BOT_ID="ä½ çš„Bot ID"
#    export COZE_PAT="ä½ çš„Personal Access Token"
#    export COZE_CHAT_SDK_SRC="SDKä¾†æºURL"
coze:
  bot-id: ${COZE_BOT_ID:7601738394883883013}
  pat: ${COZE_PAT:pat_d0EULo0arrZmb8XiINrc935XCzOBNn4C3o36MCLaJZkJ7kVZRoB29CJYFPhz78s3}
  chat-sdk-src: ${COZE_CHAT_SDK_SRC:}
  # æ–°å¢ï¼šè¨ºæ–·ç”¨æ¬„ä½
  platform-hint: ${COZE_PLATFORM_HINT:coze.com}
  api-host-hint: ${COZE_API_HOST_HINT:api.coze.com}
  # æ³¨æ„ï¼šPAT (Personal Access Token) ç‰¹æ€§
  # - åªèƒ½åœ¨å»ºç«‹æ™‚çœ‹åˆ°ä¸€æ¬¡ï¼Œä¹‹å¾Œç„¡æ³•å†æŸ¥çœ‹
  # - æœ‰éæœŸæ™‚é–“ï¼ŒéæœŸå¾Œç„¡æ³•å»¶é•·ï¼Œéœ€é‡æ–°å»ºç«‹
  # - å»ºè­°å®šæœŸæ›´æ›ï¼ˆä¾‹å¦‚ï¼šæ¯ 90 å¤©ï¼‰
</file>

<file path="backend/src/main/java/com/example/backend/config/SecurityConfig.java">
package com.example.backend.config;

import com.example.backend.repository.member.CustomOAuth2UserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.oauth2.client.registration.ClientRegistrationRepository;
import org.springframework.security.oauth2.client.web.DefaultOAuth2AuthorizationRequestResolver;
import org.springframework.security.oauth2.client.web.OAuth2AuthorizationRequestResolver;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.CorsConfigurationSource;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;

import java.util.Arrays;

@Configuration
@EnableWebSecurity
public class SecurityConfig {

        @Autowired
        private CustomOAuth2UserService customOAuth2UserService;

        @Autowired
        private ClientRegistrationRepository clientRegistrationRepository;

        @Bean
        public BCryptPasswordEncoder passwordEncoder() {
                return new BCryptPasswordEncoder();
        }

        @Bean
        public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
                http
                                /**
                                 * - ç¶ ç•Œå›å‘¼ /api/payment/** å¤šç‚ºå¤–éƒ¨ POSTï¼Œè‹¥ä¸æ’é™¤å¸¸è¦‹ 403
                                 * - /login/memberï¼šè¨»è§£èªªæ˜¯è§£ 403 çš„é—œéµï¼Œä¿ç•™
                                 * - /api/auth/**ï¼šå‰ç«¯è·¨åŸŸå‘¼å«å¸¸è¦‹ï¼Œä¿ç•™
                                 */
                                .csrf(csrf -> csrf.ignoringRequestMatchers(
                                                /*
                                                 * (ç¿Œå¸†)é€™é‚Šæˆ‘è¦èªªæ˜ä¸€ä¸‹ åŸæœ¬å¯«æ³•æ˜¯é€™æ¨£
                                                 * "/api/payment/**", // ç¶ ç•Œå›å‘¼çš„ POST è«‹æ±‚
                                                 * "/login/member", // æ”¾è¡Œå‰ç«¯ç™»å…¥è«‹æ±‚
                                                 * "/api/auth/**" // æ”¾è¡Œæ‰€æœ‰èªè­‰ç›¸é—œè«‹æ±‚
                                                 * ä½†æ˜¯æœƒç™¼ç”Ÿå…¶ä»–åŠŸèƒ½æ¨¡çµ„çš„ POST è«‹æ±‚ä¹Ÿè¢«æ“‹ä¸‹ä¾†çš„å•é¡Œï¼Œé‚„æœ‰å¾Œå°ç®¡ç†å“¡ç™»å…¥ç„¡æ³•é€²å…¥çš„å•é¡Œã€‚
                                                 * æ‰€ä»¥æˆ‘å…ˆæ”¹æˆæ”¾è¡Œæ‰€æœ‰å¾Œç«¯ API çš„è«‹æ±‚ï¼Œè·Ÿç®¡ç†å“¡ç™»å…¥è«‹æ±‚ï¼Œæœªä¾†å†è¦–æƒ…æ³èª¿æ•´ã€‚
                                                 */
                                                "/api/**", // æ”¾è¡Œæ‰€æœ‰å¾Œç«¯ API (å·¥å–®ã€é‡‘æµã€åº§ä½ã€åˆ†æ...)
                                                "/rec-rent/**", // è§£æ±ºå‰ç«¯æ­¸é‚„åº§ä½æ™‚ï¼ŒPUTè«‹æ±‚è¢«CSRFé˜»æ“‹çš„å•é¡Œ
                                                "/login/**", // æ”¾è¡Œæ‰€æœ‰ç™»å…¥è«‹æ±‚
                                                "/oauth2/**", // æ”¾è¡Œ OAuth2 ç›¸é—œ (é€šå¸¸ä¸éœ€è¦ï¼Œä½†åŠ è‘—ä¿éšª)
                                                "/spot/**",
                                                "/seats/**",
                                                "/admins/**"))

                                // 2. è¼‰å…¥è‡ªå®šç¾©çš„ CORS è¨­å®š
                                .cors(cors -> cors.configurationSource(corsConfigurationSource()))

                                // 3. è™•ç† iframe åŒæºå•é¡Œ
                                .headers(headers -> headers.frameOptions(frame -> frame.sameOrigin()))

                                // 4. è«‹æ±‚æ¬Šé™æ§ç®¡
                                .authorizeHttpRequests(auth -> auth
                                                .requestMatchers(
                                                                "/favicon.ico", "/error", "/css/**", "/js/**",
                                                                "/images/**")
                                                .permitAll()
                                                .requestMatchers(
                                                                "/api/**", // å…¶å¯¦ä¸‹æ–¹APIå‰ç¶´éƒ½å·²ç¶“è¢«åŒ…å«äº†ï¼Œåªæ˜¯å¯«äº†ä¹Ÿä¸å½±éŸ¿å°±ä¸ç‰¹åˆ¥åˆªé™¤ã€‚
                                                                "/login/**",
                                                                "/oauth2/**",
                                                                "/api/auth/**",
                                                                "/api/analyze/**",
                                                                "/api/forgot-password/**",
                                                                "/api/admin/forgot-password/**",
                                                                "/api/payment/**")
                                                .permitAll()
                                                .anyRequest().permitAll() // é–‹ç™¼æœŸé–“æ”¾è¡Œæ‰€æœ‰è«‹æ±‚
                                )

                                // 5. OAuth2 ç™»å…¥é…ç½®
                                .oauth2Login(oauth2 -> oauth2
                                                .authorizationEndpoint(authorization -> authorization
                                                                .authorizationRequestResolver(
                                                                                authorizationRequestResolver(
                                                                                                clientRegistrationRepository)))
                                                .userInfoEndpoint(userInfo -> userInfo
                                                                .userService(customOAuth2UserService))
                                                .defaultSuccessUrl("http://localhost:5173/", true))

                                // 6. ç™»å‡ºé…ç½®
                                .logout(logout -> logout
                                                .logoutUrl("/api/auth/logout")
                                                .logoutSuccessHandler((request, response, authentication) -> {
                                                        response.setStatus(200);
                                                })
                                                .invalidateHttpSession(true)
                                                .deleteCookies("JSESSIONID"));

                return http.build();
        }

        /**
         * å¼·åˆ¶ Google é¡¯ç¤ºå¸³è™Ÿé¸æ“‡è¦–çª—
         */
        private OAuth2AuthorizationRequestResolver authorizationRequestResolver(
                        ClientRegistrationRepository clientRegistrationRepository) {
                DefaultOAuth2AuthorizationRequestResolver resolver = new DefaultOAuth2AuthorizationRequestResolver(
                                clientRegistrationRepository, "/oauth2/authorization");
                resolver.setAuthorizationRequestCustomizer(customizer -> customizer
                                .additionalParameters(params -> params.put("prompt", "select_account")));
                return resolver;
        }

        /**
         * æ•´åˆå¾Œçš„ CORS è¨­å®š
         */
        @Bean
        public CorsConfigurationSource corsConfigurationSource() {
                UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();

                // A. å‰ç«¯ Vue ä½¿ç”¨ (éœ€ credentials, ç”¨ Pattern)
                CorsConfiguration frontendConfig = new CorsConfiguration();
                frontendConfig.setAllowedOriginPatterns(Arrays.asList(
                                "http://localhost:5173",
                                "https://*.ngrok-free.dev",
                                "https://*.trycloudflare.com",
                                "https://*.loca.lt"));
                // åŠ å…¥ PATCH æ–¹æ³•ï¼Œæ”¯æ´ /toggle ç‹€æ…‹åˆ‡æ› API(ç¿Œå¸†å·¥å–®ç³»çµ±æœ‰ç”¨åˆ°)
                frontendConfig.setAllowedMethods(Arrays.asList("GET", "POST", "PUT", "DELETE", "OPTIONS", "PATCH"));
                frontendConfig.setAllowedHeaders(Arrays.asList("*"));
                frontendConfig.setAllowCredentials(true);

                // B. ç¶ ç•Œå›å‚³ä½¿ç”¨ (ä¸å…è¨± credentials, ç”¨ *)
                CorsConfiguration ecpayConfig = new CorsConfiguration();
                ecpayConfig.setAllowedOrigins(Arrays.asList("*"));
                ecpayConfig.setAllowedMethods(Arrays.asList("POST", "GET"));
                ecpayConfig.setAllowedHeaders(Arrays.asList("*"));
                ecpayConfig.setAllowCredentials(false);

                // è¨»å†Šè·¯å¾‘ï¼šå…·é«”è·¯å¾‘å„ªå…ˆæ¬Šé«˜
                source.registerCorsConfiguration("/api/payment/payment-success", ecpayConfig);
                source.registerCorsConfiguration("/**", frontendConfig);

                return source;
        }
}
</file>

</files>
