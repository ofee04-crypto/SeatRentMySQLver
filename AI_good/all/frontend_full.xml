This file is a merged representation of a subset of the codebase, containing specifically included files and files not matching ignore patterns, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Only files matching these patterns are included: frontend/**, frontend/package.json, frontend/vite.config.js, frontend/index.html
- Files matching these patterns are excluded: **/*.map, **/*.min.js, **/*.min.css, **/node_modules/**, **/dist/**, **/target/**, **/vendor/**, **/public/vendor/**, **/logs/**, **/*.log, **/*.svg, **/*.png, **/*.jpg, **/*.ico, AI_good/**
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
frontend/.env
frontend/.prettierrc.json
frontend/env.d.js
frontend/eslint.config.js
frontend/index.html
frontend/jsconfig.json
frontend/package.json
frontend/public/config.js
frontend/src/api/http.js
frontend/src/api/httpjs說明.txt
frontend/src/api/modules/說明.txt
frontend/src/api/modules/maintenance.js
frontend/src/api/modules/rec.js
frontend/src/api/modules/spot.js
frontend/src/api/modules/support.js
frontend/src/api/modules/tdx.js
frontend/src/App.vue
frontend/src/assets/custom.css
frontend/src/components/icons/IconCommunity.vue
frontend/src/components/icons/IconDocumentation.vue
frontend/src/components/icons/IconEcosystem.vue
frontend/src/components/icons/IconSupport.vue
frontend/src/components/icons/IconTooling.vue
frontend/src/components/maintenance/MaintenancePageHeader.vue
frontend/src/components/maintenance/ScheduleCalendar.vue
frontend/src/components/maintenance/StatCard.vue
frontend/src/components/maintenance/TicketCharts.vue
frontend/src/components/maintenance/TicketTimeline.vue
frontend/src/components/rec/RecRentAdd.vue
frontend/src/components/rec/RecRentEdit.vue
frontend/src/components/rec/RecRentSearch.vue
frontend/src/components/rec/RecRentUserComplete.vue
frontend/src/components/rec/RecRentUserOrder.vue
frontend/src/components/rec/RecRentUserRecord.vue
frontend/src/composables/說明.txt
frontend/src/composables/maintenance/useCozeChat.js
frontend/src/composables/maintenance/useMaintenanceStaffForm.js
frontend/src/composables/maintenance/usePagination.js
frontend/src/composables/maintenance/useScheduleConfig.js
frontend/src/composables/maintenance/useStaffStatus.js
frontend/src/composables/maintenance/useTicketConfig.js
frontend/src/composables/spot/useGoogleMaps.js
frontend/src/css/MtifServlet.css
frontend/src/data/supportFaq.js
frontend/src/js/Axios.js
frontend/src/js/MtifServlet.js
frontend/src/layouts/AdminLayout.vue
frontend/src/layouts/AuthLayout.vue
frontend/src/layouts/MainLayout.vue
frontend/src/layouts/MemberLayout.vue
frontend/src/main.js
frontend/src/router/index.js
frontend/src/stores/adminAuth.js
frontend/src/stores/auth.js
frontend/src/stores/memberAuth.js
frontend/src/views/ecpay/PaymentSuccessView.vue
frontend/src/views/ecpay/PaymentView.vue
frontend/src/views/ecpay/PaymentViewOrder.vue
frontend/src/views/ecpay/SponsorLog.vue
frontend/src/views/ecpay/SponsorView.vue
frontend/src/views/EnterancePage.vue
frontend/src/views/game/SnakeGame.vue
frontend/src/views/HomeView.vue
frontend/src/views/maintenance/MaintenanceStaffForm.vue
frontend/src/views/maintenance/MaintenanceStaffHistory.vue
frontend/src/views/maintenance/MaintenanceStaffList.vue
frontend/src/views/maintenance/MtifForm.vue
frontend/src/views/maintenance/MtifList.vue
frontend/src/views/maintenance/ScheduleForm.vue
frontend/src/views/maintenance/ScheduleList.vue
frontend/src/views/member/AdminCreateView.vue
frontend/src/views/member/AdminEditView.vue
frontend/src/views/member/AdminHomeView.vue
frontend/src/views/member/AdminInfoModal.vue
frontend/src/views/member/AdminListView.vue
frontend/src/views/member/LoginView.vue
frontend/src/views/member/MemberCreateView.vue
frontend/src/views/member/MemberEditView.vue
frontend/src/views/member/MemberListView.vue
frontend/src/views/member/MemberProfileView.vue
frontend/src/views/member/Register.vue
frontend/src/views/merchantAndCoupon/CouponMallView.vue
frontend/src/views/merchantAndCoupon/DiscountList.vue
frontend/src/views/merchantAndCoupon/MerchantList.vue
frontend/src/views/merchantAndCoupon/RedemptionHistory.vue
frontend/src/views/merchantAndCoupon/RedemptionLogList.vue
frontend/src/views/rec_rent_management.txt
frontend/src/views/rec/RecRentMgnChartPage.vue
frontend/src/views/rec/RecRentMgnPage.vue
frontend/src/views/rec/RecRentUserPage.vue
frontend/src/views/rec/RecRentUserSearchPage.vue
frontend/src/views/rec/RightsClaimPage.vue
frontend/src/views/rec/VisitSiteReommandPage.vue
frontend/src/views/spot/DispatchMonitor.vue
frontend/src/views/spot/SeatForm.vue
frontend/src/views/spot/SeatList.vue
frontend/src/views/spot/SeatOne.vue
frontend/src/views/spot/SeatResult.vue
frontend/src/views/spot/SeatSearch.vue
frontend/src/views/spot/SpotAnalyze.vue
frontend/src/views/spot/SpotForm.vue
frontend/src/views/spot/SpotList.vue
frontend/src/views/spot/SpotOne.vue
frontend/src/views/spot/SpotResult.vue
frontend/src/views/spot/SpotSearch.vue
frontend/src/views/support/ReportDamageView.vue
frontend/src/views/support/ReportEntryView.vue
frontend/src/views/support/ReportManualView.vue
frontend/src/views/support/SupportCenterView.vue
frontend/vite.config.js
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="frontend/.prettierrc.json">
{
  "$schema": "https://json.schemastore.org/prettierrc",
  "semi": false,
  "singleQuote": true,
  "printWidth": 100
}
</file>

<file path="frontend/env.d.js">
/// <reference types="vite/client" />
</file>

<file path="frontend/eslint.config.js">
import pluginVue from 'eslint-plugin-vue'
import skipFormatting from '@vue/eslint-config-prettier/skip-formatting'

export default [
  // 1. 設定要檢查的檔案範圍
  {
    name: 'app/files-to-lint',
    files: ['**/*.{js,mjs,jsx,vue}'],
  },

  // 2. 設定要忽略的資料夾
  {
    name: 'app/files-to-ignore',
    ignores: ['**/dist/**', '**/dist-ssr/**', '**/coverage/**'],
  },

  // 3. 載入 Vue 的基本規則 (Essential)
  ...pluginVue.configs['flat/essential'],

  // 4. 載入 Prettier 格式化規則 (避免 ESLint 跟 Prettier 打架)
  skipFormatting,

  // 5. 【關鍵】自定義寬鬆規則 (豁免金牌區域)
  {
    rules: {
      // -----------------------------------------------------------
      // 核心修正：解決 "The 'lang' attribute is missing"
      // -----------------------------------------------------------
      'vue/block-lang': 'off',

      // -----------------------------------------------------------
      // JS 寬鬆設定
      // -----------------------------------------------------------
      // 允許變數宣告了卻沒用到 (改成黃色警告，不要紅色報錯)
      'no-unused-vars': 'warn',

      // 允許使用未定義的變數 (避免因為沒寫 TS 定義而報錯)
      'no-undef': 'off',

      // Vue 寬鬆設定

      // 允許組件名稱只有一個單字
      'vue/multi-word-component-names': 'off',

      // 關閉 Props 必須定義型別的強制檢查
      'vue/require-prop-types': 'off',
    },
  },
]
</file>

<file path="frontend/jsconfig.json">
{
  "compilerOptions": {
    "target": "esnext",
    "module": "esnext",
    "moduleResolution": "node",
    "strict": false,
    "jsx": "preserve",
    "sourceMap": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "esModuleInterop": true,
    "lib": ["esnext", "dom"],
    "skipLibCheck": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    }
  },
  "include": ["src/**/*.js", "src/**/*.vue", "src/**/*.json"],
  "exclude": ["node_modules"]
}
</file>

<file path="frontend/src/api/httpjs說明.txt">
功能：

統一網址： 設定好了 baseURL (目前是 localhost:8080/api)，之後上線或換 IP 只要改這裡這一個檔案，全站都會生效。

統一逾時： 設定請求超過 10 秒自動 timeout。

攔截器 (Interceptors)： 這裡預留了位置，之後要這做「登入 Token 自動帶入」或「統一錯誤處理 (Alert)」都在這裡寫一次就好。

注意： 這個檔案大家直接引用，通常不需要修改它，除非要改全域設定。
</file>

<file path="frontend/src/api/modules/說明.txt">
這裡存放我們各自負責的功能模組。
在modules底下開個字的資料夾，然後放個自的功能模組
在裡面把後端的 API 寫成 function 匯出。

好處： Vue 檔會變很乾淨，而且不用怕網址打錯字。
</file>

<file path="frontend/src/api/modules/spot.js">
import http from '../http';

/**
 * @description 獲取所有站點資料
 * @returns {Promise}
 */
export const getAllSpots = () => {
  // 假設的後端API端點為 /api/v1/spots
  // 如果您的端點不同，請修改此處的 URL
  return http.get('/api/v1/spots');
};
</file>

<file path="frontend/src/App.vue">
<script setup>
import { onMounted } from 'vue';
import { RouterView } from 'vue-router';
import { useMemberAuthStore } from '@/stores/memberAuth';
import { useAdminAuthStore } from '@/stores/adminAuth';
import axios from 'axios';

/**
 * App.vue：整個前端的「根容器」
 *
 * [核心邏輯] 應用程式狀態恢復 (Rehydration)
 * 此處的 onMounted 會在整個應用程式啟動時執行一次。
 * 它的任務是檢查 localStorage 中是否儲存了上次的登入資訊，
 * 如果有，就將其恢復到 Pinia store 中。
 * 這可以確保用戶在重新整理頁面後，登入狀態得以保持。
 */
onMounted(async() => {
  const memberAuthStore = useMemberAuthStore();
  const adminAuthStore = useAdminAuthStore();

  // 不論本地是否有舊資料，只要後端有 Session，就以 Google 的為準
  try {
    const res = await axios.get('http://localhost:8080/api/auth/me', { withCredentials: true });
    
    if (res.data) {
      // 找到 Google 登入資訊，直接寫入並覆蓋 localStorage
      memberAuthStore.setMemberLogin(res.data);
      localStorage.setItem('member_user', JSON.stringify(res.data));
      localStorage.setItem('token', 'google-session-ok'); // 給予暫時 token
      
      // Google 登入時通常需確保管理員狀態是清空的，避免權限衝突
      adminAuthStore.clearAdmin(); 
      localStorage.removeItem('admin');
      
      console.log('App.vue: 已同步最新的 Google 會員資訊並覆蓋舊狀態。');
      return; // 同步成功，直接結束邏輯
    }
  } catch (err) {
    // 沒抓到 Google Session (例如 401)，才往下執行原本的恢復邏輯
    console.log('App.vue: 無 Google Session，檢查本地儲存。');
  }

  // 1. 恢復一般會員的登入狀態
  if (!memberAuthStore.isLogin) {
    const storedUser = localStorage.getItem('member_user');
    if (storedUser) {
      try {
        const userData = JSON.parse(storedUser);
        memberAuthStore.setMemberLogin(userData);
        console.log('App.vue: 會員登入狀態已從 localStorage 恢復。');
      } catch (e) {
        console.error('恢復會員狀態失敗:', e);
        // 如果解析失敗，清除損壞的資料
        localStorage.removeItem('member_user');
      }
    }
  }

  // 2. 恢復管理員的登入狀態
  if (!adminAuthStore.isLogin) {
    const storedAdmin = localStorage.getItem('admin');
    if (storedAdmin) {
      try {
        const adminData = JSON.parse(storedAdmin);
        adminAuthStore.setAdmin(adminData);
        console.log('admin login');
      } catch (e) {
        console.error('恢復管理員狀態失敗:', e);
        localStorage.removeItem('admin');
      }
    }
  }
});
</script>

<template>
  <RouterView />
</template>

<style>
/* * 這裡只留全域通用的設定
 * AdminLTE 的具體樣式已經移交給 index.html 和 AdminLayout 處理
 */
@import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css');
@import url('https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css');

html,
body,
#app {
  height: 100vh;
  margin: 0;
  padding: 0;
  font-family: 'Noto Sans TC', 'PingFang TC', 'Microsoft JhengHei', sans-serif;
}

/* 這是 Vue Router 自動加上的 class，用來做選單高亮 */
</style>
</file>

<file path="frontend/src/assets/custom.css">
@charset "UTF-8";

/* 重置基礎樣式 */
html,
body {
  height: 100%;
  width: 100%;
  margin: 0;
  padding: 0;
  font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif;
  font-size: 15px;
}

/* ✅ 關鍵：強制解開 Vue 的寬度限制 */
body {
  display: block !important;
}
#app {
  display: block !important;
  max-width: none !important;
  margin: 0 !important;
  padding: 0 !important;
  height: 100%;
}

.wrapper {
  min-height: 100vh;
}

/* 表格與標籤樣式 (保留你原本喜歡的米色風格) */
.jy-table {
  width: 100%;
  border-collapse: collapse;
  background-color: #fffdf5;
  margin-bottom: 1rem;
}
.jy-table th {
  background-color: #f4e3c1;
  color: #2b2114;
  font-weight: bold;
  text-align: center;
  padding: 10px 8px;
  border: 1px solid #c8b79b;
  white-space: nowrap;
}
.jy-table td {
  border: 1px solid #dcdcdc;
  padding: 8px;
  vertical-align: middle;
}
.jy-table tbody tr:nth-child(even) {
  background-color: #fff9f0;
}
.jy-table tbody tr:hover {
  background-color: #fff1d0;
}
.small-box .inner h3 {
  font-family: 'Noto Sans TC', sans-serif;
  font-weight: 700;
}
</file>

<file path="frontend/src/components/icons/IconCommunity.vue">
<template>
  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor">
    <path
      d="M15 4a1 1 0 1 0 0 2V4zm0 11v-1a1 1 0 0 0-1 1h1zm0 4l-.707.707A1 1 0 0 0 16 19h-1zm-4-4l.707-.707A1 1 0 0 0 11 14v1zm-4.707-1.293a1 1 0 0 0-1.414 1.414l1.414-1.414zm-.707.707l-.707-.707.707.707zM9 11v-1a1 1 0 0 0-.707.293L9 11zm-4 0h1a1 1 0 0 0-1-1v1zm0 4H4a1 1 0 0 0 1.707.707L5 15zm10-9h2V4h-2v2zm2 0a1 1 0 0 1 1 1h2a3 3 0 0 0-3-3v2zm1 1v6h2V7h-2zm0 6a1 1 0 0 1-1 1v2a3 3 0 0 0 3-3h-2zm-1 1h-2v2h2v-2zm-3 1v4h2v-4h-2zm1.707 3.293l-4-4-1.414 1.414 4 4 1.414-1.414zM11 14H7v2h4v-2zm-4 0c-.276 0-.525-.111-.707-.293l-1.414 1.414C5.42 15.663 6.172 16 7 16v-2zm-.707 1.121l3.414-3.414-1.414-1.414-3.414 3.414 1.414 1.414zM9 12h4v-2H9v2zm4 0a3 3 0 0 0 3-3h-2a1 1 0 0 1-1 1v2zm3-3V3h-2v6h2zm0-6a3 3 0 0 0-3-3v2a1 1 0 0 1 1 1h2zm-3-3H3v2h10V0zM3 0a3 3 0 0 0-3 3h2a1 1 0 0 1 1-1V0zM0 3v6h2V3H0zm0 6a3 3 0 0 0 3 3v-2a1 1 0 0 1-1-1H0zm3 3h2v-2H3v2zm1-1v4h2v-4H4zm1.707 4.707l.586-.586-1.414-1.414-.586.586 1.414 1.414z"
    />
  </svg>
</template>
</file>

<file path="frontend/src/components/icons/IconDocumentation.vue">
<template>
  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="17" fill="currentColor">
    <path
      d="M11 2.253a1 1 0 1 0-2 0h2zm-2 13a1 1 0 1 0 2 0H9zm.447-12.167a1 1 0 1 0 1.107-1.666L9.447 3.086zM1 2.253L.447 1.42A1 1 0 0 0 0 2.253h1zm0 13H0a1 1 0 0 0 1.553.833L1 15.253zm8.447.833a1 1 0 1 0 1.107-1.666l-1.107 1.666zm0-14.666a1 1 0 1 0 1.107 1.666L9.447 1.42zM19 2.253h1a1 1 0 0 0-.447-.833L19 2.253zm0 13l-.553.833A1 1 0 0 0 20 15.253h-1zm-9.553-.833a1 1 0 1 0 1.107 1.666L9.447 14.42zM9 2.253v13h2v-13H9zm1.553-.833C9.203.523 7.42 0 5.5 0v2c1.572 0 2.961.431 3.947 1.086l1.107-1.666zM5.5 0C3.58 0 1.797.523.447 1.42l1.107 1.666C2.539 2.431 3.928 2 5.5 2V0zM0 2.253v13h2v-13H0zm1.553 13.833C2.539 15.431 3.928 15 5.5 15v-2c-1.92 0-3.703.523-5.053 1.42l1.107 1.666zM5.5 15c1.572 0 2.961.431 3.947 1.086l1.107-1.666C9.203 13.523 7.42 13 5.5 13v2zm5.053-11.914C11.539 2.431 12.928 2 14.5 2V0c-1.92 0-3.703.523-5.053 1.42l1.107 1.666zM14.5 2c1.573 0 2.961.431 3.947 1.086l1.107-1.666C18.203.523 16.421 0 14.5 0v2zm3.5.253v13h2v-13h-2zm1.553 12.167C18.203 13.523 16.421 13 14.5 13v2c1.573 0 2.961.431 3.947 1.086l1.107-1.666zM14.5 13c-1.92 0-3.703.523-5.053 1.42l1.107 1.666C11.539 15.431 12.928 15 14.5 15v-2z"
    />
  </svg>
</template>
</file>

<file path="frontend/src/components/icons/IconEcosystem.vue">
<template>
  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="20" fill="currentColor">
    <path
      d="M11.447 8.894a1 1 0 1 0-.894-1.789l.894 1.789zm-2.894-.789a1 1 0 1 0 .894 1.789l-.894-1.789zm0 1.789a1 1 0 1 0 .894-1.789l-.894 1.789zM7.447 7.106a1 1 0 1 0-.894 1.789l.894-1.789zM10 9a1 1 0 1 0-2 0h2zm-2 2.5a1 1 0 1 0 2 0H8zm9.447-5.606a1 1 0 1 0-.894-1.789l.894 1.789zm-2.894-.789a1 1 0 1 0 .894 1.789l-.894-1.789zm2 .789a1 1 0 1 0 .894-1.789l-.894 1.789zm-1.106-2.789a1 1 0 1 0-.894 1.789l.894-1.789zM18 5a1 1 0 1 0-2 0h2zm-2 2.5a1 1 0 1 0 2 0h-2zm-5.447-4.606a1 1 0 1 0 .894-1.789l-.894 1.789zM9 1l.447-.894a1 1 0 0 0-.894 0L9 1zm-2.447.106a1 1 0 1 0 .894 1.789l-.894-1.789zm-6 3a1 1 0 1 0 .894 1.789L.553 4.106zm2.894.789a1 1 0 1 0-.894-1.789l.894 1.789zm-2-.789a1 1 0 1 0-.894 1.789l.894-1.789zm1.106 2.789a1 1 0 1 0 .894-1.789l-.894 1.789zM2 5a1 1 0 1 0-2 0h2zM0 7.5a1 1 0 1 0 2 0H0zm8.553 12.394a1 1 0 1 0 .894-1.789l-.894 1.789zm-1.106-2.789a1 1 0 1 0-.894 1.789l.894-1.789zm1.106 1a1 1 0 1 0 .894 1.789l-.894-1.789zm2.894.789a1 1 0 1 0-.894-1.789l.894 1.789zM8 19a1 1 0 1 0 2 0H8zm2-2.5a1 1 0 1 0-2 0h2zm-7.447.394a1 1 0 1 0 .894-1.789l-.894 1.789zM1 15H0a1 1 0 0 0 .553.894L1 15zm1-2.5a1 1 0 1 0-2 0h2zm12.553 2.606a1 1 0 1 0 .894 1.789l-.894-1.789zM17 15l.447.894A1 1 0 0 0 18 15h-1zm1-2.5a1 1 0 1 0-2 0h2zm-7.447-5.394l-2 1 .894 1.789 2-1-.894-1.789zm-1.106 1l-2-1-.894 1.789 2 1 .894-1.789zM8 9v2.5h2V9H8zm8.553-4.894l-2 1 .894 1.789 2-1-.894-1.789zm.894 0l-2-1-.894 1.789 2 1 .894-1.789zM16 5v2.5h2V5h-2zm-4.553-3.894l-2-1-.894 1.789 2 1 .894-1.789zm-2.894-1l-2 1 .894 1.789 2-1L8.553.106zM1.447 5.894l2-1-.894-1.789-2 1 .894 1.789zm-.894 0l2 1 .894-1.789-2-1-.894 1.789zM0 5v2.5h2V5H0zm9.447 13.106l-2-1-.894 1.789 2 1 .894-1.789zm0 1.789l2-1-.894-1.789-2 1 .894 1.789zM10 19v-2.5H8V19h2zm-6.553-3.894l-2-1-.894 1.789 2 1 .894-1.789zM2 15v-2.5H0V15h2zm13.447 1.894l2-1-.894-1.789-2 1 .894 1.789zM18 15v-2.5h-2V15h2z"
    />
  </svg>
</template>
</file>

<file path="frontend/src/components/icons/IconSupport.vue">
<template>
  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor">
    <path
      d="M10 3.22l-.61-.6a5.5 5.5 0 0 0-7.666.105 5.5 5.5 0 0 0-.114 7.665L10 18.78l8.39-8.4a5.5 5.5 0 0 0-.114-7.665 5.5 5.5 0 0 0-7.666-.105l-.61.61z"
    />
  </svg>
</template>
</file>

<file path="frontend/src/components/icons/IconTooling.vue">
<!-- This icon is from <https://github.com/Templarian/MaterialDesign>, distributed under Apache 2.0 (https://www.apache.org/licenses/LICENSE-2.0) license-->
<template>
  <svg
    xmlns="http://www.w3.org/2000/svg"
    xmlns:xlink="http://www.w3.org/1999/xlink"
    aria-hidden="true"
    role="img"
    class="iconify iconify--mdi"
    width="24"
    height="24"
    preserveAspectRatio="xMidYMid meet"
    viewBox="0 0 24 24"
  >
    <path
      d="M20 18v-4h-3v1h-2v-1H9v1H7v-1H4v4h16M6.33 8l-1.74 4H7v-1h2v1h6v-1h2v1h2.41l-1.74-4H6.33M9 5v1h6V5H9m12.84 7.61c.1.22.16.48.16.8V18c0 .53-.21 1-.6 1.41c-.4.4-.85.59-1.4.59H4c-.55 0-1-.19-1.4-.59C2.21 19 2 18.53 2 18v-4.59c0-.32.06-.58.16-.8L4.5 7.22C4.84 6.41 5.45 6 6.33 6H7V5c0-.55.18-1 .57-1.41C7.96 3.2 8.44 3 9 3h6c.56 0 1.04.2 1.43.59c.39.41.57.86.57 1.41v1h.67c.88 0 1.49.41 1.83 1.22l2.34 5.39z"
      fill="currentColor"
    ></path>
  </svg>
</template>
</file>

<file path="frontend/src/components/maintenance/MaintenancePageHeader.vue">
<script setup>
import { computed } from 'vue'

// 定義外部傳入的參數
const props = defineProps({
  title: {
    type: String,
    required: true,
  },
  subtitle: {
    type: String,
    default: '',
  },
  // 預設圖示
  icon: {
    type: String,
    default: 'fas fa-cube',
  },
  // 模式：'add' (新增-綠色) | 'edit' (編輯-橘色) | 'view' (檢視/列表-藍色)
  mode: {
    type: String,
    default: 'view',
  },
})

// 根據模式決定 Icon 的 CSS class
const iconClass = computed(() => {
  switch (props.mode) {
    case 'add':
      return 'add-mode'
    case 'edit':
      return 'edit-mode'
    default:
      return 'view-mode' // 預設藍色
  }
})
</script>

<template>
  <div class="page-title-box">
    <div class="title-icon" :class="iconClass">
      <i :class="icon"></i>
    </div>
    <div class="title-content">
      <h1>{{ title }}</h1>
      <p v-if="subtitle" class="subtitle">
        {{ subtitle }}
      </p>
    </div>
  </div>
</template>

<style scoped>
.page-title-box {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 16px 24px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
}

.title-icon {
  width: 56px;
  height: 56px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  color: white;
  transition: transform 0.3s ease;
}

.title-icon:hover {
  transform: scale(1.1) rotate(5deg);
}

/* 顏色定義 */
.add-mode {
  background: linear-gradient(135deg, #67c23a 0%, #95d475 100%);
}

.edit-mode {
  background: linear-gradient(135deg, #e6a23c 0%, #f3d19e 100%);
}

.view-mode {
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
}

.title-content h1 {
  margin: 0;
  font-size: 1.5rem;
  font-weight: 600;
  color: #303133;
}

.title-content .subtitle {
  margin: 4px 0 0;
  font-size: 0.875rem;
  color: #909399;
}
</style>
</file>

<file path="frontend/src/components/maintenance/StatCard.vue">
<script setup>
/**
 * 統計卡片元件
 * 用於顯示數據統計，可自訂圖示、數值、標籤和樣式
 */
defineProps({
  // 圖示 class (FontAwesome)
  icon: {
    type: String,
    default: 'fas fa-chart-bar',
  },
  // 顯示的數值
  value: {
    type: [String, Number],
    required: true,
  },
  // 標籤說明
  label: {
    type: String,
    required: true,
  },
  // 卡片變體樣式：'primary' | 'success' | 'warning' | 'danger' | 'info'
  variant: {
    type: String,
    default: 'primary',
  },
  // 是否啟用脈衝動畫
  pulse: {
    type: Boolean,
    default: false,
  },
  // 是否可點擊
  clickable: {
    type: Boolean,
    default: false,
  },
  // 背景裝飾圖示 (可選)
  bgIcon: {
    type: String,
    default: '',
  },
})

// 點擊事件
const emit = defineEmits(['click'])

const handleClick = () => {
  emit('click')
}
</script>

<template>
  <div 
    class="stat-card" 
    :class="[`${variant}-card`, { clickable }]"
    @click="handleClick"
  >
    <div class="stat-icon" :class="{ pulse }">
      <i :class="icon"></i>
    </div>
    <div class="stat-info">
      <h3>{{ value }}</h3>
      <span>{{ label }}</span>
    </div>
    <!-- 背景裝飾圖示 -->
    <div v-if="bgIcon" class="stat-bg-icon">
      <i :class="bgIcon"></i>
    </div>
  </div>
</template>

<style scoped>
.stat-card {
  position: relative;
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 18px;
  background: white;
  border-radius: 14px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
  transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  overflow: hidden;
}

.stat-card.clickable {
  cursor: pointer;
}

.stat-card:hover {
  transform: translateY(-6px);
  box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
}

.stat-icon {
  width: 50px;
  height: 50px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  color: white;
  z-index: 1;
  flex-shrink: 0;
}

.stat-icon.pulse {
  animation: pulse 1.5s infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

/* 變體樣式 */
.primary-card .stat-icon {
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
}

.success-card .stat-icon {
  background: linear-gradient(135deg, #67c23a 0%, #95d475 100%);
}

.warning-card .stat-icon {
  background: linear-gradient(135deg, #e6a23c 0%, #f3d19e 100%);
}

.danger-card .stat-icon {
  background: linear-gradient(135deg, #f56c6c 0%, #f89898 100%);
}

.info-card .stat-icon {
  background: linear-gradient(135deg, #909399 0%, #c0c4cc 100%);
}

.stat-info {
  z-index: 1;
  min-width: 0;
}

.stat-info h3 {
  margin: 0;
  font-size: 1.8rem;
  font-weight: 700;
  color: #303133;
  line-height: 1.2;
}

.stat-info span {
  font-size: 0.85rem;
  color: #909399;
  white-space: nowrap;
}

/* 背景裝飾圖示 */
.stat-bg-icon {
  position: absolute;
  right: -10px;
  bottom: -10px;
  font-size: 80px;
  color: rgba(0, 0, 0, 0.03);
  z-index: 0;
}
</style>
</file>

<file path="frontend/src/components/maintenance/TicketCharts.vue">
<template>
  <el-row :gutter="20" class="charts-container" v-show="hasData">
    <!-- 狀態分佈圖 -->
    <el-col :md="8" :sm="24">
      <el-card shadow="hover" class="chart-card">
        <template #header>
          <div class="chart-header">
            <span class="chart-icon status-icon">
              <i class="fas fa-chart-pie"></i>
            </span>
            <b>狀態分佈</b>
          </div>
        </template>
        <div ref="statusChartRef" class="chart-container"></div>
      </el-card>
    </el-col>

    <!-- 優先級佔比圖 -->
    <el-col :md="8" :sm="24">
      <el-card shadow="hover" class="chart-card">
        <template #header>
          <div class="chart-header">
            <span class="chart-icon priority-icon">
              <i class="fas fa-flag"></i>
            </span>
            <b>優先級佔比</b>
          </div>
        </template>
        <div ref="priorityChartRef" class="chart-container"></div>
      </el-card>
    </el-col>

    <!-- 故障類型統計圖 -->
    <el-col :md="8" :sm="24">
      <el-card shadow="hover" class="chart-card">
        <template #header>
          <div class="chart-header">
            <span class="chart-icon type-icon">
              <i class="fas fa-tools"></i>
            </span>
            <b>前五大故障類型</b>
          </div>
        </template>
        <div ref="typeChartRef" class="chart-container"></div>
      </el-card>
    </el-col>
  </el-row>
</template>

<script setup>
import { ref, computed, watch, onMounted, onBeforeUnmount, nextTick } from 'vue'
import ApexCharts from 'apexcharts'
import { useTicketConfig } from '@/composables/maintenance/useTicketConfig'

const props = defineProps({
  /** 工單資料陣列 */
  tickets: {
    type: Array,
    default: () => [],
  },
})

const { statusConfig, priorityConfig } = useTicketConfig()

// --- 圖表 DOM 參照 ---
const statusChartRef = ref(null)
const priorityChartRef = ref(null)
const typeChartRef = ref(null)

// --- 圖表實例 ---
let statusChart = null
let priorityChart = null
let typeChart = null

// --- 是否有資料 ---
const hasData = computed(() => props.tickets.length > 0)

// --- 計算圖表數據 ---
const chartData = computed(() => {
  const data = props.tickets

  // 狀態統計
  const statusCount = {}
  data.forEach((t) => {
    statusCount[t.issueStatus] = (statusCount[t.issueStatus] || 0) + 1
  })

  // 優先級統計
  const priorityCount = { LOW: 0, NORMAL: 0, HIGH: 0, URGENT: 0 }
  data.forEach((t) => {
    if (priorityCount[t.issuePriority] !== undefined) {
      priorityCount[t.issuePriority]++
    }
  })

  // 故障類型統計 (前5名)
  const typeCount = {}
  data.forEach((t) => {
    typeCount[t.issueType] = (typeCount[t.issueType] || 0) + 1
  })
  const sortedTypes = Object.entries(typeCount)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 5)

  return { statusCount, priorityCount, sortedTypes }
})

// --- 圖表配置工廠 ---
const createStatusChartOptions = (statusCount) => ({
  series: Object.values(statusCount),
  labels: Object.keys(statusCount).map((k) => statusConfig[k]?.text || k),
  chart: {
    type: 'donut',
    height: 280,
    toolbar: { show: false },
    animations: {
      enabled: true,
      easing: 'easeinout',
      speed: 800,
      animateGradually: { enabled: true, delay: 150 },
      dynamicAnimation: { enabled: true, speed: 350 },
    },
  },
  colors: ['#17a2b8', '#007bff', '#ffc107', '#28a745', '#6c757d'],
  dataLabels: { enabled: false },
  legend: { position: 'bottom', fontSize: '13px' },
  plotOptions: {
    pie: {
      donut: {
        size: '65%',
        labels: {
          show: true,
          total: {
            show: true,
            label: '總計',
            fontSize: '14px',
            fontWeight: 600,
            color: '#909399',
          },
        },
      },
    },
  },
  stroke: { width: 2, colors: ['#fff'] },
  tooltip: {
    y: { formatter: (val) => `${val} 件` },
  },
})

const createPriorityChartOptions = (priorityCount) => ({
  series: [priorityCount.LOW, priorityCount.NORMAL, priorityCount.HIGH, priorityCount.URGENT],
  labels: [
    `${priorityConfig.LOW.icon} 低`,
    `${priorityConfig.NORMAL.icon} 普通`,
    `${priorityConfig.HIGH.icon} 高`,
    `${priorityConfig.URGENT.icon} 緊急`,
  ],
  chart: {
    type: 'pie',
    height: 280,
    toolbar: { show: false },
    animations: {
      enabled: true,
      easing: 'easeinout',
      speed: 800,
    },
  },
  colors: ['#909399', '#67c23a', '#e6a23c', '#f56c6c'],
  legend: { position: 'bottom', fontSize: '13px' },
  stroke: { width: 2, colors: ['#fff'] },
  tooltip: {
    y: { formatter: (val) => `${val} 件` },
  },
})

const createTypeChartOptions = (sortedTypes) => ({
  series: [{ name: '件數', data: sortedTypes.map((i) => i[1]) }],
  chart: {
    type: 'bar',
    height: 280,
    toolbar: { show: false },
    animations: {
      enabled: true,
      easing: 'easeinout',
      speed: 800,
    },
  },
  xaxis: {
    categories: sortedTypes.map((i) => i[0]),
    labels: { style: { fontSize: '12px' } },
  },
  plotOptions: {
    bar: {
      borderRadius: 8,
      horizontal: true,
      distributed: true,
      dataLabels: { position: 'center' },
    },
  },
  colors: ['#409eff', '#67c23a', '#e6a23c', '#f56c6c', '#909399'],
  dataLabels: {
    enabled: true,
    formatter: (val) => `${val} 件`,
    style: { fontSize: '12px', colors: ['#fff'] },
  },
  tooltip: {
    y: { formatter: (val) => `${val} 件` },
  },
})

// --- 渲染圖表 ---
const renderCharts = () => {
  if (!hasData.value) return

  if (!statusChartRef.value || !priorityChartRef.value || !typeChartRef.value) return

  const { statusCount, priorityCount, sortedTypes } = chartData.value

  const statusOptions = createStatusChartOptions(statusCount)
  const priorityOptions = createPriorityChartOptions(priorityCount)
  const typeOptions = createTypeChartOptions(sortedTypes)

  // 更新或建立圖表
  if (statusChart) {
    statusChart.updateOptions(statusOptions)
    priorityChart.updateOptions(priorityOptions)
    typeChart.updateOptions(typeOptions)
  } else {
    if (statusChartRef.value) {
      statusChart = new ApexCharts(statusChartRef.value, statusOptions)
      statusChart.render()
    }
    if (priorityChartRef.value) {
      priorityChart = new ApexCharts(priorityChartRef.value, priorityOptions)
      priorityChart.render()
    }
    if (typeChartRef.value) {
      typeChart = new ApexCharts(typeChartRef.value, typeOptions)
      typeChart.render()
    }
  }
}

// --- 銷毀圖表 ---
const destroyCharts = () => {
  if (statusChart) {
    statusChart.destroy()
    statusChart = null
  }
  if (priorityChart) {
    priorityChart.destroy()
    priorityChart = null
  }
  if (typeChart) {
    typeChart.destroy()
    typeChart = null
  }
}

// --- 監聽資料變化重新渲染 ---
watch(
  () => props.tickets,
  () => {
    setTimeout(() => {
      nextTick(() => renderCharts())
    }, 100)
  },
  { deep: true },
)

// --- 生命週期 ---
onMounted(() => {
  nextTick(() => renderCharts())
})

onBeforeUnmount(() => {
  destroyCharts()
})

// 暴露方法供外部調用
defineExpose({
  renderCharts,
  destroyCharts,
})
</script>

<style scoped>
.charts-container {
  margin-bottom: 20px;
}

.chart-card {
  border-radius: 16px;
  overflow: hidden;
  border: none;
  min-height: 360px;
  margin-bottom: 16px;
  transition: all 0.3s ease;
  background: linear-gradient(145deg, #ffffff 0%, #fafbfc 100%);
}

.chart-card:hover {
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
  transform: translateY(-2px);
}

.chart-header {
  display: flex;
  align-items: center;
  gap: 10px;
}

.chart-icon {
  width: 32px;
  height: 32px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 14px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.status-icon {
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
}

.priority-icon {
  background: linear-gradient(135deg, #e6a23c 0%, #f3d19e 100%);
}

.type-icon {
  background: linear-gradient(135deg, #67c23a 0%, #95d475 100%);
}

.chart-container {
  min-height: 280px;
}

/* 響應式調整 */
@media (max-width: 768px) {
  .chart-card {
    min-height: 320px;
  }

  .chart-container {
    min-height: 240px;
  }
}
</style>
</file>

<file path="frontend/src/components/maintenance/TicketTimeline.vue">
<template>
  <div class="ticket-timeline-container">
    <div class="timeline-header">
      <h3>
        <i class="fas fa-history"></i>
        工單歷程記錄
      </h3>
      <el-button size="small" @click="fetchLogs" :loading="loading" circle>
        <i class="fas fa-sync-alt"></i>
      </el-button>
    </div>

    <div v-if="loading" class="loading-skeleton">
      <el-skeleton :rows="5" animated />
    </div>

    <el-empty v-else-if="logs.length === 0" description="尚無歷程記錄" :image-size="120" />

    <el-timeline v-else class="timeline-content">
      <el-timeline-item
        v-for="(log, index) in logs"
        :key="log.logId"
        :color="getActionColor(log.action)"
        :icon="getActionIcon(log.action)"
        :size="log.action === 'URGENT' ? 'large' : 'normal'"
        :class="['timeline-item', `animate-delay-${index % 5}`]"
      >
        <el-card shadow="hover" class="log-card" :class="`action-${log.action.toLowerCase()}`">
          <template #header>
            <div class="card-header">
              <span class="action-badge" :class="`badge-${log.action.toLowerCase()}`">
                {{ getActionLabel(log.action) }}
              </span>
              <span class="timestamp">
                <i class="far fa-clock"></i>
                {{ log.createdAt }}
              </span>
            </div>
          </template>

          <div class="card-body">
            <div class="operator">
              <i class="fas fa-user-circle"></i>
              <strong>{{ log.operator || '系統' }}</strong>
            </div>
            <div v-if="log.comment" class="comment">
              <i class="fas fa-comment-dots"></i>
              {{ formatLogComment(log.comment) }}
            </div>
          </div>
        </el-card>
      </el-timeline-item>
    </el-timeline>
  </div>
</template>

<script setup>
import { ref, onMounted, watch } from 'vue'
import maintenanceApi from '@/api/modules/maintenance'
import { ElMessage } from 'element-plus'
import {
  getPriorityText,
  getStatusText,
  getResultText,
} from '@/composables/maintenance/useTicketConfig'

// ========== Props ==========
const props = defineProps({
  ticketId: {
    type: Number,
    required: true,
  },
})

// ========== State ==========
const logs = ref([])
const loading = ref(false)

// ========== Methods ==========

const fetchLogs = async () => {
  if (!props.ticketId) return

  loading.value = true
  try {
    const response = await maintenanceApi.getTicketLogs(props.ticketId)
    logs.value = response.data
  } catch (error) {
    console.error('取得歷程記錄失敗:', error)
    ElMessage.error('載入歷程記錄失敗，請稍後再試')
  } finally {
    loading.value = false
  }
}

/**
 * 根據 action 決定顏色 (★ 包含 TRANSFERRED)
 */
const getActionColor = (action) => {
  const colorMap = {
    CREATED: '#409EFF', // 藍
    ASSIGNED: '#909399', // 灰
    TRANSFERRED: '#8E44AD', // ★ 紫色 (移轉)
    STARTED: '#E6A23C', // 橘
    RESOLVED: '#67C23A', // 綠
    CANCELLED: '#F56C6C', // 紅
    URGENT: '#FF6600', // 深橘 (緊急)
  }
  return colorMap[action] || '#409EFF'
}

/**
 * 根據 action 決定圖示
 */
const getActionIcon = (action) => {
  const iconMap = {
    CREATED: 'Plus',
    ASSIGNED: 'User',
    TRANSFERRED: 'Refresh', // ★ 移轉圖示
    STARTED: 'Tools',
    RESOLVED: 'CircleCheck',
    CANCELLED: 'CircleClose',
    URGENT: 'Warning',
  }
  return iconMap[action] || 'DocumentCopy'
}

/**
 * 根據 action 顯示中文標籤
 */
const getActionLabel = (action) => {
  const labelMap = {
    CREATED: '建立工單',
    ASSIGNED: '指派人員',
    TRANSFERRED: '工單移轉', // ★ 移轉文字
    STARTED: '開始維修',
    RESOLVED: '維修完成',
    CANCELLED: '取消工單',
    URGENT: '緊急標記',
  }
  return labelMap[action] || action
}

const formatLogComment = (comment) => {
  if (!comment) return '-'
  let formatted = comment
  formatted = formatted.replace(
    /優先權:\s*([A-Z_]+)/g,
    (match, code) => `優先權: ${getPriorityText(code)}`,
  )
  formatted = formatted.replace(
    /狀態:\s*([A-Z_]+)/g,
    (match, code) => `狀態: ${getStatusText(code)}`,
  )
  formatted = formatted.replace(
    /結果:\s*([A-Z_]+)/g,
    (match, code) => `結果: ${getResultText(code)}`,
  )
  return formatted
}

defineExpose({ fetchLogs })

onMounted(() => {
  fetchLogs()
})

watch(
  () => props.ticketId,
  () => {
    fetchLogs()
  },
)
</script>

<style scoped>
/* ========== 容器基礎樣式 ========== */
.ticket-timeline-container {
  padding: 20px;
  background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
  border-radius: 12px;
  min-height: 400px;
}

.timeline-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 2px solid #dcdfe6;
}

.timeline-header h3 {
  margin: 0;
  font-size: 20px;
  color: #303133;
  font-weight: 600;
}

.timeline-header h3 i {
  margin-right: 8px;
  color: #409eff;
}

.loading-skeleton {
  padding: 20px;
}
.timeline-content {
  padding: 10px 0;
}

/* ========== 卡片樣式 ========== */
.log-card {
  border-radius: 10px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  border-left: 4px solid transparent;
}

.log-card:hover {
  transform: translateY(-4px) scale(1.02);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12) !important;
}

/* 根據 action 類型顯示不同左側邊框顏色 */
.log-card.action-created {
  border-left-color: #409eff;
}
.log-card.action-assigned {
  border-left-color: #909399;
}
.log-card.action-transferred {
  border-left-color: #8e44ad;
} /* ★ 紫色 */
.log-card.action-started {
  border-left-color: #e6a23c;
}
.log-card.action-resolved {
  border-left-color: #67c23a;
}
.log-card.action-cancelled {
  border-left-color: #f56c6c;
}
.log-card.action-urgent {
  border-left-color: #ff6600;
  animation: pulseGlow 2s ease-in-out infinite;
}

/* 卡片頭部 */
.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.action-badge {
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 600;
  color: white;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* Badge 顏色 */
.badge-created {
  background: linear-gradient(135deg, #409eff, #66b1ff);
}
.badge-assigned {
  background: linear-gradient(135deg, #909399, #b3b8bd);
}
.badge-transferred {
  background: linear-gradient(135deg, #8e44ad, #9b59b6);
} /* ★ 紫色 */
.badge-started {
  background: linear-gradient(135deg, #e6a23c, #f0bc65);
}
.badge-resolved {
  background: linear-gradient(135deg, #67c23a, #85ce61);
}
.badge-cancelled {
  background: linear-gradient(135deg, #f56c6c, #f89898);
}
.badge-urgent {
  background: linear-gradient(135deg, #ff6600, #ff9933);
  animation: badgePulse 1.5s ease-in-out infinite;
}

.timestamp {
  font-size: 13px;
  color: #909399;
  font-weight: 500;
}
.timestamp i {
  margin-right: 4px;
}

/* 卡片內容 */
.card-body {
  padding: 12px 0;
}

.operator {
  display: flex;
  align-items: center;
  font-size: 15px;
  color: #303133;
  margin-bottom: 8px;
}
.operator i {
  margin-right: 8px;
  color: #409eff;
  font-size: 18px;
}

.comment {
  margin-top: 10px;
  padding: 10px;
  background: #f4f4f5;
  border-radius: 6px;
  font-size: 14px;
  color: #606266;
  line-height: 1.6;
  display: flex;
  align-items: flex-start;
}
.comment i {
  margin-right: 8px;
  margin-top: 2px;
  color: #909399;
  flex-shrink: 0;
}

/* ========== 動畫效果 ========== */
@keyframes bounceInRight {
  0% {
    opacity: 0;
    transform: translateX(100px) scale(0.9);
  }
  60% {
    opacity: 1;
    transform: translateX(-10px) scale(1.02);
  }
  80% {
    transform: translateX(5px);
  }
  100% {
    transform: translateX(0) scale(1);
  }
}

.timeline-item {
  animation: bounceInRight 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55) both;
}

.animate-delay-0 {
  animation-delay: 0s;
}
.animate-delay-1 {
  animation-delay: 0.1s;
}
.animate-delay-2 {
  animation-delay: 0.2s;
}
.animate-delay-3 {
  animation-delay: 0.3s;
}
.animate-delay-4 {
  animation-delay: 0.4s;
}

@keyframes pulseGlow {
  0%,
  100% {
    box-shadow: 0 0 5px rgba(255, 102, 0, 0.3);
  }
  50% {
    box-shadow:
      0 0 20px rgba(255, 102, 0, 0.6),
      0 0 30px rgba(255, 102, 0, 0.4);
  }
}

@keyframes badgePulse {
  0%,
  100% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.05);
  }
}

@media (max-width: 768px) {
  .timeline-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
  }
  .card-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }
  .log-card:hover {
    transform: translateY(-2px) scale(1.01);
  }
}
</style>
</file>

<file path="frontend/src/composables/說明.txt">
拿來做抽邏輯使用
避免vue太過肥大。
</file>

<file path="frontend/src/composables/maintenance/useMaintenanceStaffForm.js">
import { ref, reactive, computed, unref } from 'vue'
import Swal from 'sweetalert2'

export function useMaintenanceStaffForm({ staffId, router, maintenanceApi }) {
  // 1. 優化編輯模式判斷：確保它是數字且大於 0
  const isEdit = computed(() => {
    const id = unref(staffId) // 以防萬一傳入的是 ref
    return !isNaN(id) && id > 0
  })

  const formRef = ref(null)
  const loading = ref(false)
  const submitting = ref(false)
  const formVisible = ref(false)

  const form = reactive({
    staffName: '',
    staffCompany: '',
    staffPhone: '',
    staffEmail: '',
    staffNote: '',
    isActive: true,
  })

  const rules = {
    staffName: [{ required: true, message: '請輸入姓名', trigger: 'blur' }],
    staffEmail: [{ type: 'email', message: 'Email 格式不正確', trigger: 'blur' }],
  }

  const init = async () => {
    console.log('Init called. isEdit:', isEdit.value) // 除錯 Log

    // 觸發進場動畫
    setTimeout(() => {
      formVisible.value = true
      console.log('Form Visible set to true') // 除錯 Log
    }, 100)

    if (!isEdit.value) {
      console.log('Create Mode - Stopping init')
      return
    }

    loading.value = true
    try {
      // 這裡原本直接用 staffId，建議確保它是數值
      const res = await maintenanceApi.getStaffById(staffId)
      Object.assign(form, res.data)
    } catch (error) {
      console.error('Fetch Error:', error) // 捕捉錯誤
      router.push('/admin/staff-list')
    } finally {
      loading.value = false
    }
  }

  const submitForm = async () => {
    if (!formRef.value) return

    await formRef.value.validate(async (valid) => {
      if (!valid) {
        await Swal.fire({
          icon: 'warning',
          title: '表單驗證失敗',
          text: '請檢查必填欄位與格式',
          confirmButtonText: '確認',
          showClass: { popup: 'animate__animated animate__shakeX' },
        })
        return
      }

      // 確認彈窗
      const confirmResult = await Swal.fire({
        title: isEdit.value ? '確認更新？' : '確認新增？',
        text: isEdit.value ? '即將更新此人員資料' : '即將新增維護人員',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#409eff',
        cancelButtonColor: '#909399',
        confirmButtonText: '確認送出',
        cancelButtonText: '取消',
        showClass: { popup: 'animate__animated animate__fadeInDown animate__faster' },
        hideClass: { popup: 'animate__animated animate__fadeOutUp animate__faster' },
      })

      if (!confirmResult.isConfirmed) return

      submitting.value = true
      try {
        if (isEdit.value) {
          await maintenanceApi.updateStaff(staffId, form)
          await Swal.fire({
            icon: 'success',
            title: '更新成功！',
            html: `<span class="text-success">人員 <b>${form.staffName}</b> 資料已更新</span>`,
            timer: 2000,
            timerProgressBar: true,
            showConfirmButton: false,
            showClass: { popup: 'animate__animated animate__bounceIn' },
          })
        } else {
          await maintenanceApi.createStaff(form)
          await Swal.fire({
            icon: 'success',
            title: '新增成功！',
            html: `<span class="text-success">加入新成員 <b>${form.staffName}</b> 加入團隊</span>`,
            timer: 2000,
            timerProgressBar: true,
            showConfirmButton: false,
            showClass: { popup: 'animate__animated animate__tada' },
          })
        }

        router.push('/admin/staff-list')
      } catch {
        // 錯誤已由 http.js 攔截器處理
      } finally {
        submitting.value = false
      }
    })
  }

  const handleCancel = async () => {
    // 保持你原本的「判斷有無填寫」條件
    if (form.staffName || form.staffCompany || form.staffPhone) {
      const result = await Swal.fire({
        title: '確定要離開嗎？',
        text: '您填寫的資料將不會被保存',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#e6a23c',
        cancelButtonColor: '#909399',
        confirmButtonText: '離開',
        cancelButtonText: '繼續編輯',
        showClass: { popup: 'animate__animated animate__fadeIn animate__faster' },
      })
      if (!result.isConfirmed) return
    }
    router.push('/admin/staff-list')
  }

  return {
    // state
    isEdit,
    formRef,
    loading,
    submitting,
    formVisible,
    form,
    rules,

    // actions
    init,
    submitForm,
    handleCancel,
  }
}
</file>

<file path="frontend/src/composables/maintenance/usePagination.js">
/**
 * 分頁 Composable
 * 提供前端分頁邏輯，可在多個列表頁面共用
 */
import { ref, computed, watch } from 'vue'

/**
 * 建立分頁功能
 * @param {Ref} sourceList - 原始資料列表 (ref)
 * @param {Object} options - 配置選項
 * @param {number} options.defaultPageSize - 預設每頁筆數，預設 10
 * @param {Ref} options.searchText - 搜尋文字 (當變更時重置頁碼)
 * @returns {Object} 分頁相關的響應式資料和方法
 */
export function usePagination(sourceList, options = {}) {
  const { defaultPageSize = 10, searchText = null } = options

  // 響應式狀態
  const currentPage = ref(1)
  const pageSize = ref(defaultPageSize)

  // 計算總頁數
  const totalPages = computed(() => {
    return Math.ceil(sourceList.value.length / pageSize.value)
  })

  // 計算分頁後的列表
  const paginatedList = computed(() => {
    const start = (currentPage.value - 1) * pageSize.value
    const end = start + pageSize.value
    return sourceList.value.slice(start, end)
  })

  // 計算總筆數
  const total = computed(() => sourceList.value.length)

  // 是否有資料
  const hasData = computed(() => sourceList.value.length > 0)

  // 是否需要顯示分頁器
  const showPagination = computed(() => sourceList.value.length > pageSize.value)

  // 當搜尋文字變更時，重置到第一頁
  if (searchText) {
    watch(searchText, () => {
      currentPage.value = 1
    })
  }

  // 當原始列表變更時，確保當前頁碼有效
  watch(sourceList, () => {
    if (currentPage.value > totalPages.value && totalPages.value > 0) {
      currentPage.value = totalPages.value
    }
  })

  // ★ 修復：當 pageSize 變更時，強制回到第一頁
  watch(pageSize, () => {
    currentPage.value = 1
  })

  // 跳轉到指定頁
  const goToPage = (page) => {
    if (page >= 1 && page <= totalPages.value) {
      currentPage.value = page
    }
  }

  // 上一頁
  const prevPage = () => {
    if (currentPage.value > 1) {
      currentPage.value--
    }
  }

  // 下一頁
  const nextPage = () => {
    if (currentPage.value < totalPages.value) {
      currentPage.value++
    }
  }

  // 重置分頁
  const resetPagination = () => {
    currentPage.value = 1
  }

  return {
    // 響應式狀態
    currentPage,
    pageSize,
    totalPages,
    total,

    // 計算屬性
    paginatedList,
    hasData,
    showPagination,

    // 方法
    goToPage,
    prevPage,
    nextPage,
    resetPagination,
  }
}

export default usePagination
</file>

<file path="frontend/src/composables/maintenance/useScheduleConfig.js">
/**
 * 排程配置 Composable
 * 集中管理排程相關的配置與格式化方法
 */
import { computed } from 'vue'

export function useScheduleConfig() {
  // ====== 排程類型配置 ======
  const scheduleTypeConfig = {
    DAILY: {
      text: '每日',
      icon: 'fas fa-sun',
      color: '#67c23a',
      tagType: 'success',
      bgColor: 'rgba(103, 194, 58, 0.1)',
    },
    WEEKLY: {
      text: '每週',
      icon: 'fas fa-calendar-week',
      color: '#409eff',
      tagType: '',
      bgColor: 'rgba(64, 158, 255, 0.1)',
    },
    MONTHLY: {
      text: '每月',
      icon: 'fas fa-calendar-alt',
      color: '#e6a23c',
      tagType: 'warning',
      bgColor: 'rgba(230, 162, 60, 0.1)',
    },
  }

  // ====== 星期配置 ======
  const dayOfWeekConfig = {
    1: { text: '週一', short: '一', color: '#409eff' },
    2: { text: '週二', short: '二', color: '#67c23a' },
    3: { text: '週三', short: '三', color: '#e6a23c' },
    4: { text: '週四', short: '四', color: '#f56c6c' },
    5: { text: '週五', short: '五', color: '#909399' },
    6: { text: '週六', short: '六', color: '#b88230' },
    7: { text: '週日', short: '日', color: '#f56c6c' },
  }

  // ====== 優先級配置 ======
  const priorityConfig = {
    LOW: { text: '低', color: '#909399', tagType: 'info' },
    NORMAL: { text: '一般', color: '#409eff', tagType: '' },
    HIGH: { text: '高', color: '#e6a23c', tagType: 'warning' },
    URGENT: { text: '緊急', color: '#f56c6c', tagType: 'danger' },
  }

  // ====== 格式化方法 ======
  const formatDateTime = (dateStr) => {
    if (!dateStr) return '-'
    const d = new Date(dateStr)
    const pad = (n) => String(n).padStart(2, '0')
    return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`
  }

  const formatDate = (dateStr) => {
    if (!dateStr) return '-'
    const d = new Date(dateStr)
    const pad = (n) => String(n).padStart(2, '0')
    return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`
  }

  const formatTime = (timeStr) => {
    if (!timeStr) return '-'
    return timeStr.substring(0, 5)
  }

  const formatScheduleDetail = (schedule) => {
    const time = formatTime(schedule.executeTime)
    switch (schedule.scheduleType) {
      case 'DAILY':
        return `每天 ${time}`
      case 'WEEKLY':
        return `每${dayOfWeekConfig[schedule.dayOfWeek]?.text || '?'} ${time}`
      case 'MONTHLY':
        return `每月 ${schedule.dayOfMonth} 號 ${time}`
      default:
        return '-'
    }
  }

  // ====== 計算下次執行的相對時間 ======
  const getRelativeTime = (dateStr) => {
    if (!dateStr) return { text: '-', isOverdue: false }
    const now = new Date()
    const target = new Date(dateStr)
    const diff = target - now

    if (diff < 0) {
      return { text: '已過期', isOverdue: true }
    }

    const minutes = Math.floor(diff / 60000)
    const hours = Math.floor(minutes / 60)
    const days = Math.floor(hours / 24)

    if (days > 0) {
      return { text: `${days} 天後`, isOverdue: false }
    } else if (hours > 0) {
      return { text: `${hours} 小時後`, isOverdue: false }
    } else {
      return { text: `${minutes} 分鐘後`, isOverdue: false, isSoon: minutes < 30 }
    }
  }

  // ====== 取得排程的標籤樣式 ======
  const getScheduleTypeTag = (type) => scheduleTypeConfig[type] || scheduleTypeConfig.DAILY
  const getPriorityTag = (priority) => priorityConfig[priority] || priorityConfig.NORMAL

  return {
    scheduleTypeConfig,
    dayOfWeekConfig,
    priorityConfig,
    formatDateTime,
    formatDate,
    formatTime,
    formatScheduleDetail,
    getRelativeTime,
    getScheduleTypeTag,
    getPriorityTag,
  }
}
</file>

<file path="frontend/src/css/MtifServlet.css">
/* 讓外層佔滿內容區 */
.wrapper { width: 100%; padding: 0; box-sizing: border-box; }

.table-wrapper { 
  background-color: #fdf5e6; border: 1px solid #c8b79b; 
  padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
}

.table-title {
  font-size: 24px; font-weight: bold; text-align: center; padding: 12px 0; 
  margin: 0 0 20px 0; background: #d2b48c; color: #2b2114; 
  border: 1px solid #8b7355; letter-spacing: 0.1em;
}

/* 工具列隨寬度縮放 */
.toolbar { display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }

.input-field-retro { 
  padding: 8px 12px; border: 1px solid #c8b79b; background: #fffdf5; 
  border-radius: 4px; width: 220px; transition: border 0.3s;
}

/* --- 表格核心：防止跑版 --- */
.jy-table { 
  width: 100%; border-collapse: collapse; background-color: #fffdf5; 
  table-layout: fixed; /* 關鍵：強制分配欄寬 */
}

.jy-table th { background-color: #f4e3c1; color: #5d4037; padding: 12px 8px; border: 1px solid #555; }
.jy-table td { 
  border: 1px solid #999; padding: 10px 8px; font-size: 14px; 
  color: #333; vertical-align: middle; 
  word-break: break-all; /* 防止電子信箱撐開表格 */
}

.jy-table tbody tr:nth-child(even) { background-color: #fff9f0; }
.jy-table tbody tr:hover { background-color: #fff1d0; }

/* 狀態行效果 */
.row-disabled { background-color: #e9e9e9 !important; color: #999 !important; }
.row-ended { background-color: #fff0f0 !important; }

/* 元件樣式 */
.badge-retro { padding: 4px 8px; border-radius: 4px; font-size: 11px; color: white; white-space: nowrap; }
.bg-green { background-color: #28a745; }
.bg-red { background-color: #dc3545; }
.bg-gray { background-color: #6c757d; }

.btn-retro, .btn-retro-add { background: #8b7355; color: white; border: none; padding: 8px 15px; cursor: pointer; border-radius: 4px; font-weight: bold; white-space: nowrap; }
.btn-retro-outline { background: transparent; color: #8b7355; border: 1px solid #8b7355; padding: 8px 15px; border-radius: 4px; cursor: pointer; }

.btn-action { padding: 4px 8px; margin: 2px; border-radius: 4px; border: 1px solid #999; cursor: pointer; font-size: 12px; white-space: nowrap; }
.edit { background: white; color: #333; }
.status { background: #d2b48c; color: #2b2114; }
.delete { background: #dc3545; color: white; border: none; }

.text-center { text-align: center; }
.bold-text { font-weight: 600; color: #2b2114; }
.empty-state { text-align: center; padding: 30px; color: #8b7355; font-style: italic; }
</file>

<file path="frontend/src/js/Axios.js">
import { createApp } from 'vue'
import App from './App.vue'
import axios from 'axios'
import Swal from 'sweetalert2'

const app = createApp(App)

// --- Axios 全域設定 ---

// 1. 設定基礎路徑，之後寫 API 只要寫 /api/merchants 即可
axios.defaults.baseURL = 'http://localhost:8080'

// 2. 設定請求超時時間 (例如 10 秒)
axios.defaults.timeout = 10000

// 3. 請求攔截器 (Request Interceptor)
axios.interceptors.request.use(
  (config) => {
    // 這裡可以統一加入 Token，例如：
    // config.headers['Authorization'] = 'Bearer ' + localStorage.getItem('token')
    console.log('發送請求:', config.url)
    return config
  },
  (error) => {
    return Promise.reject(error)
  },
)

// 4. 回應攔截器 (Response Interceptor)
// 這裡可以統一處理後端 Result<T> 的錯誤訊息
axios.interceptors.response.use(
  (response) => {
    const res = response.data

    // 如果後端回傳的 code 不是 200，直接在這裡噴出 SweetAlert 提示
    if (res.code && res.code !== 200) {
      Swal.fire({
        icon: 'error',
        title: '操作失敗',
        text: res.message || '系統發生錯誤',
      })
      return Promise.reject(new Error(res.message || 'Error'))
    }
    return response
  },
  (error) => {
    // 處理 HTTP 狀態碼錯誤 (如 404, 500)
    Swal.fire({
      icon: 'error',
      title: '網路錯誤',
      text: '無法連線至伺服器，請檢查後端是否啟動',
    })
    return Promise.reject(error)
  },
)

// 5. 將 axios 掛載到全域變數 (選用，Vue 3 建議直接 import)
app.config.globalProperties.$http = axios

app.mount('#app')
</file>

<file path="frontend/src/js/MtifServlet.js">
document.addEventListener('DOMContentLoaded', function () {
  const input     = document.getElementById('searchInput');
  const button    = document.getElementById('searchBtn');
  const table     = document.getElementById('ticketTable');
  const priSel    = document.getElementById('priorityFilter');
  const statusSel = document.getElementById('statusFilter');

  if (!table) {
    return; // 找不到表格就直接結束
  }

  const tbody = table.tBodies[0];
  if (!tbody) {
    return;
  }

  function filterTickets() {
    const keyword    = input ? input.value.trim().toLowerCase() : '';
    const priValue   = priSel ? priSel.value.toUpperCase() : '';
    const statusValue= statusSel ? statusSel.value.toUpperCase() : '';
    const rows       = tbody.rows;

    for (let i = 0; i < rows.length; i++) {
      const row = rows[i];

      // 「目前沒有維修工單」那一列：第一格有 colspan
      const firstCell = row.cells[0];
      if (!firstCell) {
        continue;
      }
      if (firstCell.hasAttribute('colspan')) {
        continue;
      }

      // 0: ticketId, 2: issueType, 3: issueDesc
      const ticketIdText  = (row.cells[0].textContent || '').toLowerCase();
      const issueTypeText = (row.cells[2].textContent || '').toLowerCase();
      const issueDescText = (row.cells[3].textContent || '').toLowerCase();

      const keywordMatch =
        keyword === '' ||
        ticketIdText.includes(keyword) ||
        issueTypeText.includes(keyword) ||
        issueDescText.includes(keyword);

      // 來自 data-* 屬性（都是大寫）
      const rowPri    = (row.dataset.priority || '').toUpperCase();
      const rowStatus = (row.dataset.status || '').toUpperCase();

      const priMatch    = !priValue   || rowPri === priValue;
      const statusMatch = !statusValue|| rowStatus === statusValue;

      const match = keywordMatch && priMatch && statusMatch;

      row.style.display = match ? '' : 'none';
    }
  }

  if (input) {
    input.addEventListener('keyup', filterTickets);
  }
  if (button) {
    button.addEventListener('click', filterTickets);
  }
  if (priSel) {
    priSel.addEventListener('change', filterTickets);
  }
  if (statusSel) {
    statusSel.addEventListener('change', filterTickets);
  }
});
</file>

<file path="frontend/src/layouts/MemberLayout.vue">
<script setup>
import { useRouter, useRoute } from "vue-router";
import { ElMessageBox } from "element-plus";

const router = useRouter();
const route = useRoute();

const logout = async () => {
  try {
    // 只有按「登出」才會 resolve
    await ElMessageBox.confirm("確定要登出嗎？", "登出確認", {
      confirmButtonText: "登出",
      cancelButtonText: "取消",
      type: "warning",
    });

    // 使用者真的確認後，才跳轉
    localStorage.removeItem("token");
    router.push("/login");
  } catch (err) {
    // 使用者按取消，什麼都不做
  }
};

const go = (path) => {
  router.push(path);
};
</script>

<template>
  <el-container class="layout">
    <!-- Header -->
    <el-header class="header">
        <router-link to="/">
          <div class="logo">SeatRentSys</div>
        </router-link>
    </el-header>

    <el-container>
      <!-- Sidebar -->
      <el-aside class="aside" width="220px">
        <el-menu class="menu" :default-active="route.name">
          <el-menu-item index="member-profile" @click="go('/member/profile')">
            個人資料
          </el-menu-item>
          <el-menu-item
            index="rec-rent-user-order"
            :class="{
              'is-active':
                route.name === 'rec-rent-user' &&
                (route.params.action === 'order' || !route.params.action),
            }"
            @click="router.push({ name: 'rec-rent-user', params: { action: 'order' } })"
          >
            租借＠Seat
          </el-menu-item>
          <el-menu-item
            index="rec-rent-user-complete"
            :class="{
              'is-active':
                route.name === 'rec-rent-user' && route.params.action === 'complete',
            }"
            @click="
              router.push({ name: 'rec-rent-user', params: { action: 'complete' } })
            "
          >
            歸還＠Seat
          </el-menu-item>

          <div class="divider"></div>

          <!-- 不要 index + 不要 router -->
          <el-menu-item index="logout" class="logout" @click="logout">
            登出
          </el-menu-item>
        </el-menu>
      </el-aside>

      <!-- Content -->
      <el-main class="main">
        <RouterView />
      </el-main>
    </el-container>
  </el-container>
</template>

<style scoped>
.layout {
  height: 100vh;
  background: #f8f9fa;
}

.header {
  height: 60px;
  background: #fff;
  border-bottom: 1px solid #e5e7eb;
  display: flex;
  align-items: center;
  padding: 0 20px;
}

.logo {
  font-size: 20px;
  font-weight: 700;
}

.aside {
  background: #f7f8fa;
  border-right: 1px solid #e5e7eb;
  padding: 12px 10px;
}

.menu {
  border-right: none;
  background: transparent;
}

.divider {
  height: 1px;
  background: #e5e7eb;
  margin: 12px 8px;
}

.main {
  padding: 30px;
}

/* 登出樣式：Element Plus menu-item 需要用 class 覆蓋 */
:deep(.logout) {
  color: #b91c1c;
}
:deep(.logout:hover) {
  background: #fef2f2 !important;
}
</style>
</file>

<file path="frontend/src/stores/auth.js">
import { defineStore } from 'pinia'

export const useAuthStore = defineStore('auth', {
  state: () => ({
    isLogin: false,
    role: null, // 'member' | 'admin'
    user: null, // { id, username, name ... }
  }),

  actions: {
    login(user, role) {
      this.isLogin = true
      this.user = user
      this.role = role
    },

    logout() {
      this.isLogin = false
      this.user = null
      this.role = null
    },
  },
})
</file>

<file path="frontend/src/stores/memberAuth.js">
import { defineStore } from 'pinia'
import axios from 'axios'

export const useMemberAuthStore = defineStore('memberAuth', {
  state: () => {
    // ✅ 保留 HEAD：登入狀態還原
    const savedMember = localStorage.getItem('member_user')
    const savedLogin = localStorage.getItem('isLogin') === 'true'

    return {
      /* =====================
       * 類型 1：登入狀態（核心）
       * ===================== */
      isLogin: savedLogin,

      /* =====================
       * 類型 2：會員業務資料（前台會用）
       * ===================== */
      member: savedMember
        ? JSON.parse(savedMember)
        : {
            memId: null,
            memUsername: '',
            memName: '',
            memPoints: 0,
            memInvoice: '',
          },

      /* =====================
       * 類型 3：使用者操作暫存（rec 需要）
       * ===================== */
      selectedSpotId: null,
    }
  },

  actions: {
    /* ========= 登入 ========= */
    setMemberLogin(memberData) {
      this.isLogin = true
      this.member = {
        memId: memberData.memId,
        memUsername: memberData.memUsername,
        memName: memberData.memName,
        memPoints: memberData.memPoints,
        memInvoice: memberData.memInvoice,
      }

      localStorage.setItem('member_user', JSON.stringify(this.member))
      localStorage.setItem('isLogin', 'true')
    },

    /* ========= 點數同步========= */
    async refreshPoints() {
      if (!this.member.memId) return

      try {
        const res = await axios.get('http://localhost:8080/api/members/find', {
          params: { memId: this.member.memId },
        })

        if (res.data) {
          this.member = {
            ...this.member,
            memPoints: res.data.memPoints,
            memName: res.data.memName || this.member.memName,
          }

          localStorage.setItem('member_user', JSON.stringify(this.member))
        }
      } catch (err) {
        console.warn('點數同步失敗', err)
      }
    },

    /* ========= 登出 ========= */
    async clearMemberLogin() {
      try {
        await axios.post('http://localhost:8080/api/auth/logout', {}, { withCredentials: true })
      } catch (_) {}

      this.isLogin = false
      this.member = {
        memId: null,
        memUsername: '',
        memName: '',
        memPoints: 0,
        memInvoice: '',
      }
      this.selectedSpotId = null

      localStorage.removeItem('member_user')
      localStorage.removeItem('isLogin')
      localStorage.removeItem('token')
    },

    /* ========= rec 專用 ========= */
    setSpotId(spotId) {
      this.selectedSpotId = spotId
    },
    clearSpotId() {
      this.selectedSpotId = null
    },
  },
})
</file>

<file path="frontend/src/views/EnterancePage.vue">
<script setup>
import { ref, onMounted, nextTick } from "vue";
import { LocationFilled } from "@element-plus/icons-vue";
import axios from "axios";
import MainLayout from "@/layouts/MainLayout.vue";
import { useRouter } from "vue-router";
import { useAuthStore } from "@/stores/auth";

// --- 路由與狀態管理 ---
const router = useRouter();
const authStore = useAuthStore();
// --- 1. 狀態定義 ---

// --- 2. 核心邏輯 ---

// --- 3. 視圖切換邏輯 ---

</script>

<template>
<!-- 框架區塊 -->
<MainLayout></MainLayout>
<!-- 組件區塊 -->

</template>

<style scoped>

</style>
</file>

<file path="frontend/src/views/merchantAndCoupon/RedemptionHistory.vue">
<template>
  <div class="history-page">
    <h2>我的兌換紀錄</h2>
    
    <el-table 
      v-loading="loading" 
      :data="logs" 
      border 
      stripe 
      style="width: 100%"
      empty-text="目前尚無兌換紀錄"
    >
      <el-table-column label="兌換時間" width="200" sortable>
        <template #default="scope">
          {{ formatDate(scope.row.redeemTime) }}
        </template>
      </el-table-column>

      <el-table-column prop="merchantName" label="合作商家" />
      <el-table-column prop="couponName" label="兌換項目" />
      
      <el-table-column label="消耗點數" width="120">
        <template #default="scope">
          <span style="color: #f56c6c; font-weight: bold;">
            - {{ scope.row.pointsSpent }} P
          </span>
        </template>
      </el-table-column>
    </el-table>
  </div>
</template>
<script setup>
import { ref, onMounted, computed } from 'vue';
import axios from 'axios';
// 💡 這裡路徑請根據你實際的檔案名稱（假設是 auth.js 或 memberAuth.js）
import { useMemberAuthStore } from '@/stores/memberAuth'; 

const authStore = useMemberAuthStore();
const logs = ref([]);
const loading = ref(false);

// 💡 修正：根據你的 Store 結構，從 member 物件中拿 memId
const memberId = computed(() => authStore.member?.memId);

const fetchLogs = async () => {
  // 防呆：確保 ID 存在且不是 null 字串
  if (!memberId.value) {
    console.warn("尚未登入或找不到 memId，取消請求");
    return;
  }

  loading.value = true;
  try {
    // 💡 發送請求到正確的路徑
    const url = `http://localhost:8080/api/discounts/member/${memberId.value}/logs`;
    console.log("正在請求會員紀錄，ID:", memberId.value);
    
    const res = await axios.get(url);
    logs.value = res.data;
    console.log("成功抓取紀錄，筆數:", logs.value.length);
  } catch (error) {
    console.error("抓取紀錄失敗:", error);
  } finally {
    loading.value = false;
  }
};

const formatDate = (dateStr) => {
  if (!dateStr) return '---';
  // 處理 ISO 8601 格式
  return dateStr.replace('T', ' ').substring(0, 19);
};

onMounted(fetchLogs);
</script>
<style scoped>
.history-page {
  padding: 20px;
}
</style>
</file>

<file path="frontend/src/views/rec_rent_management.txt">
子桓你原本檔案裏面的程式碼(後來改成Vue版本，這個當作備份)



<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>訂單管理系統 (RecRent CRUD)</title>
    <style>
        body {
            font-family: "Microsoft JhengHei", Arial, sans-serif;
            margin: 0;
            background-color: #f9f9f9;
            display: flex;
            height: 100vh;
            /* 讓頁面佔滿視窗高度 */
        }

        /* Sidebar 側邊欄樣式 */
        .sidebar {
            width: 250px;
            background-color: #343a40;
            color: white;
            display: flex;
            flex-direction: column;
            padding-top: 20px;
            flex-shrink: 0;
        }

        .sidebar h2 {
            color: white;
            text-align: center;
            font-size: 1.2em;
            margin-bottom: 30px;
        }

        .sidebar a {
            padding: 15px 20px;
            text-decoration: none;
            color: #cfd8dc;
            display: block;
            transition: 0.3s;
            cursor: pointer;
        }

        .sidebar a:hover,
        .sidebar a.active {
            background-color: #495057;
            color: white;
        }

        /* 主要內容區塊樣式 */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            /* 內容過多時出現卷軸 */
        }

        h1,
        h2 {
            color: #333;
        }

        /* 表單樣式 */
        .form-section {
            background-color: #eef;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .form-group label {
            width: 180px;
            font-weight: bold;
        }

        .form-group input {
            padding: 5px;
            flex: 1;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        /* 按鈕樣式 */
        button {
            padding: 8px 15px;
            cursor: pointer;
            border: none;
            border-radius: 3px;
            font-weight: bold;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-warning {
            background-color: #ffc107;
            color: black;
        }

        button:hover {
            opacity: 0.9;
        }

        /* 表格樣式 */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        th {
            background-color: #343a40;
            color: white;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        /* 頁面切換控制：預設隱藏，加上 active 才顯示 */
        .view-section {
            display: none;
        }

        .view-section.active {
            display: block;
        }

        /* 搜尋列樣式 */
        .search-container {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
        }

        .search-container input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 3px;
            width: 250px;
        }
    </style>
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <h2>後台管理系統</h2>
        <a onclick="switchView('list')" id="nav-list" class="active">訂單查詢</a>
        <a onclick="resetForm(); switchView('add')" id="nav-add">新增訂單</a>
        <a onclick="switchView('member')" id="nav-member">會員管理</a>
        <a onclick="switchView('report')" id="nav-report">報表分析</a>
        <a onclick="switchView('settings')" id="nav-settings">系統設定</a>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <h1>訂單管理系統 (RecRent)</h1>

        <!-- 新增/編輯區塊 (預設隱藏) -->
        <div id="view-add" class="view-section form-section">
            <h2 id="formTitle">新增訂單</h2>
            <input type="hidden" id="recSeqId">

            <div class="form-group">
                <label>會員 ID (memId):</label>
                <input type="number" id="memId" placeholder="例如: 1" required>
            </div>
            <div class="form-group">
                <label>座位編號 (seatsId):</label>
                <input type="text" id="seatsId" placeholder="例如: S001" required>
            </div>
            <div class="form-group">
                <label>租借站點 ID (spotIdRent):</label>
                <input type="number" id="spotIdRent" placeholder="例如: 10" required>
            </div>
            <div class="form-group">
                <label>租借時間 (recRentDT2):</label>
                <!-- step="1" 允許輸入秒數 -->
                <input type="datetime-local" id="recRentDT2" step="1" required>
            </div>
            <div class="form-group">
                <label>違規記點 (recViolatInt):</label>
                <input type="number" id="recViolatInt" value="0" required>
            </div>

            <div style="text-align: right;">
                <button class="btn-secondary" onclick="resetForm()">重置 / 取消</button>
                <button class="btn-primary" onclick="saveRent()">儲存訂單</button>
            </div>
        </div>

        <!-- 列表區塊 (預設顯示) -->
        <div id="view-list" class="view-section active">
            <h2>訂單列表 <button class="btn-secondary" style="font-size: 0.8em;" onclick="loadRents()">重新整理</button></h2>

            <div class="search-container">
                <input type="text" id="searchInput" placeholder="輸入會員ID、座位或訂單ID搜尋..."
                    onkeyup="if(event.key === 'Enter') searchRents()">
                <button class="btn-primary" onclick="searchRents()">搜尋</button>
                <button class="btn-secondary"
                    onclick="document.getElementById('searchInput').value=''; searchRents();">清除</button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th width="50">ID</th>
                        <th>業務編號</th>
                        <th>會員</th>
                        <th>座位</th>
                        <th>租借站點</th>
                        <th>租借時間</th>
                        <th width="150">操作</th>
                    </tr>
                </thead>
                <tbody id="rentTableBody">
                    <!-- 資料將由 JavaScript 動態載入 -->
                </tbody>
            </table>
        </div>

        <!-- 新增的頁面區塊 (預設隱藏) -->
        <div id="view-member" class="view-section">
            <h2>會員管理</h2>
            <p>這裡是會員管理功能的區塊 (範例)...</p>
            <button class="btn-primary">新增會員</button>
        </div>

        <div id="view-report" class="view-section">
            <h2>報表分析</h2>
            <p>這裡是報表分析功能的區塊 (範例)...</p>
            <div style="background: #ddd; height: 200px; display: flex; align-items: center; justify-content: center;">
                圖表預留位置</div>
        </div>

        <div id="view-settings" class="view-section">
            <h2>系統設定</h2>
            <p>這裡是系統設定功能的區塊 (範例)...</p>
        </div>
    </div>

    <script>
        // 若是直接開啟 HTML 檔案，請使用完整 URL (需注意後端 CORS 設定)
        const API_URL = 'http://localhost:8080/api/rec-rents';
        let currentRents = []; // 暫存資料以便編輯時使用

        // 頁面載入完成後執行
        document.addEventListener('DOMContentLoaded', loadRents);

        // 1. 查詢 (Read)
        function loadRents() {
            fetch(API_URL)
                .then(res => res.json())
                .then(data => {
                    currentRents = data;
                    renderTable(data);
                })
                .catch(err => {
                    console.error('載入失敗:', err);
                    alert('無法載入資料，請確認後端伺服器是否已啟動。\n錯誤: ' + err.message);
                });
        }

        // 渲染表格 (支援搜尋過濾)
        function renderTable(data) {
            const tbody = document.getElementById('rentTableBody');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">查無資料</td></tr>';
                return;
            }

            data.forEach((rent) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${rent.recSeqId}</td>
                    <td>${rent.recId || '<span style="color:gray">處理中...</span>'}</td>
                    <td>${rent.memId}</td>
                    <td>${rent.seatsId}</td>
                    <td>${rent.spotIdRent}</td>
                    <td>${rent.recRentDT2 ? rent.recRentDT2.replace('T', ' ') : ''}</td>
                    <td>
                        <!-- 改為傳遞 ID 而非 index，確保搜尋後編輯對象正確 -->
                        <button class="btn-warning" onclick="editRent(${rent.recSeqId})">編輯</button>
                        <button class="btn-danger" onclick="deleteRent(${rent.recSeqId})">刪除</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 搜尋功能
        function searchRents() {
            const keyword = document.getElementById('searchInput').value.trim().toLowerCase();

            // 若無輸入則顯示全部
            if (!keyword) {
                renderTable(currentRents);
                return;
            }

            // 過濾資料 (比對 ID, 會員ID, 座位)
            const filtered = currentRents.filter(rent =>
                String(rent.recSeqId).includes(keyword) ||
                String(rent.memId).includes(keyword) ||
                (rent.seatsId && rent.seatsId.toLowerCase().includes(keyword))
            );
            renderTable(filtered);
        }

        // 2. 新增或更新 (Create / Update)
        function saveRent() {
            const id = document.getElementById('recSeqId').value;
            const rentData = {
                memId: document.getElementById('memId').value,
                seatsId: document.getElementById('seatsId').value,
                spotIdRent: document.getElementById('spotIdRent').value,
                recRentDT2: document.getElementById('recRentDT2').value,
                recViolatInt: document.getElementById('recViolatInt').value
            };

            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API_URL}/${id}` : API_URL;

            fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(rentData)
            })
                .then(res => {
                    if (res.ok) {
                        alert(id ? '更新成功！' : '新增成功！');
                        resetForm();
                        loadRents();
                        switchView('list'); // 儲存成功後跳轉回列表
                    } else {
                        alert('儲存失敗，請檢查輸入資料。');
                    }
                });
        }

        // 3. 刪除 (Delete)
        function deleteRent(id) {
            if (!confirm('確定要刪除這筆訂單嗎？(ID: ' + id + ')')) return;

            fetch(`${API_URL}/${id}`, { method: 'DELETE' })
                .then(res => {
                    if (res.ok) {
                        loadRents();
                    } else {
                        alert('刪除失敗');
                    }
                });
        }

        // 準備編輯資料
        function editRent(id) {
            // 改用 ID 尋找資料，避免搜尋過濾後 index 對不上的問題
            const rent = currentRents.find(r => r.recSeqId == id);
            if (!rent) return;

            document.getElementById('formTitle').innerText = '編輯訂單 (ID: ' + rent.recSeqId + ')';
            document.getElementById('recSeqId').value = rent.recSeqId;
            document.getElementById('memId').value = rent.memId;
            document.getElementById('seatsId').value = rent.seatsId;
            document.getElementById('spotIdRent').value = rent.spotIdRent;
            document.getElementById('recViolatInt').value = rent.recViolatInt;

            // 處理時間格式以符合 input type="datetime-local"
            if (rent.recRentDT2) {
                // 截取 yyyy-MM-ddTHH:mm:ss 格式，去除毫秒與時區資訊以免 input 顯示錯誤
                let formattedDate = rent.recRentDT2;
                if (formattedDate.length > 19) {
                    formattedDate = formattedDate.substring(0, 19);
                }
                document.getElementById('recRentDT2').value = formattedDate;
            }

            // 切換到編輯頁面
            switchView('add');
            // 捲動到內容上方 (因為現在是 main-content 在捲動)
            document.querySelector('.main-content').scrollTo({ top: 0, behavior: 'smooth' });
        }

        // 重置表單
        function resetForm() {
            document.getElementById('formTitle').innerText = '新增訂單';
            document.getElementById('recSeqId').value = '';
            document.getElementById('memId').value = '';
            document.getElementById('seatsId').value = '';
            document.getElementById('spotIdRent').value = '';
            document.getElementById('recRentDT2').value = '';
            document.getElementById('recViolatInt').value = '0';
        }

        // 切換頁面視圖函式
        function switchView(viewName) {
            // 1. 隱藏所有視圖
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            // 2. 移除 Sidebar 的 active 狀態
            document.querySelectorAll('.sidebar a').forEach(el => el.classList.remove('active'));

            // 3. 顯示目標視圖
            document.getElementById('view-' + viewName).classList.add('active');
            // 4. 設定 Sidebar 當前項目為 active
            document.getElementById('nav-' + viewName).classList.add('active');
        }
    </script>
</body>

</html>
</file>

<file path="frontend/src/views/spot/SeatOne.vue">
<template>
  <div class="seat-one-container">
    <!-- ========== Header 區域 ========== -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row align-items-center">
          <div class="col-sm-6">
            <div class="page-title-box">
              <div class="title-icon detail-mode">
                <i class="fas fa-chair"></i>
              </div>
              <div class="title-content">
                <h1>Seat 詳細資料</h1>
                <p class="subtitle">查看座位完整資訊</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="content">
      <div class="container-fluid">
        <transition name="zoom-fade" appear>
          <div>
            <el-card v-if="loading" shadow="hover" class="detail-card">
              <div class="loading-state">
                <i class="fas fa-spinner fa-spin"></i>
                <span>載入中...</span>
              </div>
            </el-card>

            <el-card v-else-if="!seat" shadow="hover" class="detail-card">
              <el-empty description="找不到資料" />
            </el-card>

            <el-card v-else shadow="hover" class="detail-card">
              <div class="detail-content">
                <el-descriptions :column="2" border>
                  <el-descriptions-item label="ID">
                    <el-tag type="info">{{ seat.seatsId }}</el-tag>
                  </el-descriptions-item>
                  <el-descriptions-item label="名稱">
                    <span class="name-text">{{ seat.seatsName }}</span>
                  </el-descriptions-item>
                  <el-descriptions-item label="類型">
                    {{ seat.seatsType }}
                  </el-descriptions-item>
                  <el-descriptions-item label="狀態">
                    <el-tag :type="seat.seatsStatus === '啟用' ? 'success' : (seat.seatsStatus === '維修中' ? 'warning' : 'danger')">
                      {{ seat.seatsStatus }}
                    </el-tag>
                  </el-descriptions-item>
                  <el-descriptions-item label="SpotId">
                    <el-tag type="info">{{ seat.spotId }}</el-tag>
                  </el-descriptions-item>
                  <el-descriptions-item label="序號">
                    <span class="code-text">{{ seat.serialNumber || '-' }}</span>
                  </el-descriptions-item>
                  <el-descriptions-item label="CreatedAt">
                    {{ seat.createdAt || '-' }}
                  </el-descriptions-item>
                  <el-descriptions-item label="UpdatedAt">
                    {{ seat.updatedAt || '-' }}
                  </el-descriptions-item>
                </el-descriptions>
              </div>

              <div class="card-actions">
                <router-link to="/admin/seat/list">
                  <el-button>
                    <i class="fas fa-arrow-left mr-1"></i> 回清單
                  </el-button>
                </router-link>
              </div>
            </el-card>
          </div>
        </transition>
      </div>
    </section>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue'
import { useRoute } from 'vue-router'
import axios from 'axios'


// 明確定義元件名稱，方便識別與除錯
defineOptions({
  name: 'SeatOne'
})
const route = useRoute()
const seat = ref(null)
const loading = ref(true)

onMounted(async () => {
  const seatId = route.params.id
  if (seatId) {
    try {
      // [修正] 改用 RESTful 風格: GET /api/seats/{id}
      const response = await axios.get(`/api/seats/${seatId}`)
      seat.value = response.data
    } catch (error) {
      console.error('Error fetching seat:', error)
    }
  }
  loading.value = false
})
</script>

<style scoped>
/* ========== 頁面容器 ========== */
.seat-one-container {
  padding: 20px;
  background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
  min-height: 100vh;
}

/* ========== 頁面標題區 ========== */
.page-title-box {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 16px 24px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
}

.title-icon {
  width: 56px;
  height: 56px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  color: white;
  transition: transform 0.3s ease;
}

.title-icon:hover {
  transform: scale(1.1) rotate(5deg);
}

.detail-mode {
  background: linear-gradient(135deg, #909399 0%, #c0c4cc 100%);
}

.title-content h1 {
  margin: 0;
  font-size: 1.5rem;
  font-weight: 600;
  color: #303133;
}

.title-content .subtitle {
  margin: 4px 0 0;
  font-size: 0.875rem;
  color: #909399;
}

/* ========== 詳情卡片 ========== */
.detail-card {
  border-radius: 12px;
  max-width: 900px;
  margin: 0 auto;
}

.loading-state {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  padding: 40px;
  color: #409eff;
  font-size: 16px;
}

.detail-content {
  margin-bottom: 24px;
}

.code-text {
  font-family: monospace;
  background: #f5f7fa;
  padding: 2px 8px;
  border-radius: 4px;
}

.name-text {
  font-weight: 600;
  color: #303133;
}

/* ========== 按鈕區 ========== */
.card-actions {
  display: flex;
  justify-content: flex-start;
  padding-top: 24px;
  border-top: 1px solid #ebeef5;
}

/* ========== 動畫效果 ========== */
.zoom-fade-enter-active {
  transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.zoom-fade-leave-active {
  transition: all 0.3s ease-in;
}

.zoom-fade-enter-from {
  transform: scale(0.9);
  opacity: 0;
}

.zoom-fade-leave-to {
  transform: scale(0.95);
  opacity: 0;
}

/* ========== 工具類 ========== */
.mr-1 { margin-right: 4px; }
</style>
</file>

<file path="frontend/src/views/spot/SeatResult.vue">
<template>
  <div class="seat-result-container">
    <!-- ========== Header 區域 ========== -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row align-items-center">
          <div class="col-sm-6">
            <div class="page-title-box">
              <div class="title-icon result-mode">
                <i class="fas fa-list-alt"></i>
              </div>
              <div class="title-content">
                <h1>Seat 查詢結果</h1>
                <p class="subtitle">顯示符合條件的座位資料</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="content">
      <div class="container-fluid">
        <transition name="fade-slide" appear>
          <el-card shadow="hover" class="result-card">
            <el-empty v-if="seatList.length === 0" description="沒有找到符合條件的資料。" />

            <el-table
              v-else
              :data="seatList"
              stripe
              style="width: 100%"
              :header-cell-style="{ background: '#f5f7fa', fontWeight: 'bold', color: '#303133' }"
              class="modern-table"
            >
              <el-table-column prop="seatsId" label="ID" width="70" align="center" />
              <el-table-column prop="seatsName" label="名稱" min-width="120">
                <template #default="{ row }">
                  <div class="seat-name-cell">
                    <i class="fas fa-chair text-primary mr-2"></i>
                    <span>{{ row.seatsName }}</span>
                  </div>
                </template>
              </el-table-column>
              <el-table-column prop="seatsType" label="類型" width="100" />
              <el-table-column prop="seatsStatus" label="狀態" width="100" align="center">
                <template #default="{ row }">
                  <el-tag
                    :type="row.seatsStatus === '可用' ? 'success' : (row.seatsStatus === '維修' || row.seatsStatus === '故障' ? 'warning' : 'danger')"
                    size="small"
                    effect="light"
                  >
                    {{ row.seatsStatus }}
                  </el-tag>
                </template>
              </el-table-column>
              <el-table-column prop="spotId" label="SpotId" width="90" align="center">
                <template #default="{ row }">
                  <el-tag type="info" size="small">{{ row.spotId }}</el-tag>
                </template>
              </el-table-column>
              <el-table-column prop="serialNumber" label="序號" width="120" />
              <el-table-column label="UpdatedAt" min-width="160">
                <template #default="{ row }">
                  {{ row.updatedAt?.replace('T', ' ').substring(0, 19) }}
                </template>
              </el-table-column>
              <el-table-column label="操作" width="140" align="center" fixed="right">
                <template #default="{ row }">
                  <el-button-group>
                    <el-tooltip content="檢視" placement="top">
                      <router-link :to="`/admin/seat/view/${row.seatsId}`">
                        <el-button size="small" type="info">
                          <i class="fas fa-eye"></i>
                        </el-button>
                      </router-link>
                    </el-tooltip>
                    <el-tooltip content="修改" placement="top">
                      <router-link :to="`/admin/seat/edit/${row.seatsId}`">
                        <el-button size="small" type="primary">
                          <i class="fas fa-edit"></i>
                        </el-button>
                      </router-link>
                    </el-tooltip>
                  </el-button-group>
                </template>
              </el-table-column>
            </el-table>

            <div class="card-actions">
              <router-link to="/admin/seat/search">
                <el-button type="primary">
                  <i class="fas fa-search mr-1"></i> 回查詢
                </el-button>
              </router-link>
              <router-link to="/admin/seat/list">
                <el-button>
                  <i class="fas fa-list mr-1"></i> 回清單
                </el-button>
              </router-link>
            </div>
          </el-card>
        </transition>
      </div>
    </section>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue'
import { useRoute } from 'vue-router'
import axios from 'axios'

const route = useRoute()
const seatList = ref([])

// 明確定義元件名稱，方便識別與除錯
defineOptions({
  name: 'SeatResult'
})

onMounted(async () => {
  const query = route.query
  console.log('Search query:', query)

  try {
    // 改用 RESTful API: GET /api/seats/search (搭配查詢參數)
    const response = await axios.get('/api/seats/search', { params: query })
    seatList.value = response.data
  } catch (error) {
    console.error('Error fetching seats:', error)
  }
})

// [新增] 簡單的狀態顏色輔助函式
const getStatusClass = (status) => {
  if (status === '可用') return 'badge badge-success'
  if (status === '維修' || status === '故障') return 'badge badge-warning'
  if (status === '停用') return 'badge badge-danger'
  return 'badge badge-secondary'
}
</script>

<style scoped>
/* ========== 頁面容器 ========== */
.seat-result-container {
  padding: 20px;
  background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
  min-height: 100vh;
}

/* ========== 頁面標題區 ========== */
.page-title-box {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 16px 24px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
}

.title-icon {
  width: 56px;
  height: 56px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  color: white;
  transition: transform 0.3s ease;
}

.title-icon:hover {
  transform: scale(1.1) rotate(5deg);
}

.result-mode {
  background: linear-gradient(135deg, #67c23a 0%, #95d475 100%);
}

.title-content h1 {
  margin: 0;
  font-size: 1.5rem;
  font-weight: 600;
  color: #303133;
}

.title-content .subtitle {
  margin: 4px 0 0;
  font-size: 0.875rem;
  color: #909399;
}

/* ========== 結果卡片 ========== */
.result-card {
  border-radius: 12px;
}

.modern-table {
  border-radius: 8px;
  overflow: hidden;
}

.seat-name-cell {
  display: flex;
  align-items: center;
}

/* ========== 按鈕區 ========== */
.card-actions {
  display: flex;
  gap: 12px;
  padding-top: 24px;
  margin-top: 24px;
  border-top: 1px solid #ebeef5;
}

/* ========== 動畫效果 ========== */
.fade-slide-enter-active {
  transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.fade-slide-leave-active {
  transition: all 0.3s ease-in;
}

.fade-slide-enter-from {
  transform: translateY(20px);
  opacity: 0;
}

.fade-slide-leave-to {
  transform: translateY(-10px);
  opacity: 0;
}

/* ========== 工具類 ========== */
.mr-1 { margin-right: 4px; }
.mr-2 { margin-right: 8px; }
.text-primary { color: #409eff; }
</style>
</file>

<file path="frontend/src/views/spot/SeatSearch.vue">
<template>
  <div class="seat-search-container">
    <!-- ========== Header 區域 ========== -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row align-items-center">
          <div class="col-sm-6">
            <div class="page-title-box">
              <div class="title-icon search-mode">
                <i class="fas fa-search"></i>
              </div>
              <div class="title-content">
                <h1>Seat 條件查詢</h1>
                <p class="subtitle">依條件搜尋座位資料</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="content">
      <div class="container-fluid">
        <transition name="zoom-fade" appear>
          <el-card shadow="hover" class="search-card">
            <el-form :model="searchCriteria" label-width="120px" label-position="top" @submit.prevent="handleSearch">
              <el-row :gutter="20">
                <el-col :span="12">
                  <el-form-item label="名稱 (模糊)">
                    <el-input v-model="searchCriteria.seatsName" placeholder="請輸入座位名稱" clearable>
                      <template #prefix><i class="fas fa-chair"></i></template>
                    </el-input>
                  </el-form-item>
                </el-col>
                <el-col :span="12">
                  <el-form-item label="類型 (模糊)">
                    <el-input v-model="searchCriteria.seatsType" placeholder="請輸入座位類型" clearable>
                      <template #prefix><i class="fas fa-couch"></i></template>
                    </el-input>
                  </el-form-item>
                </el-col>
              </el-row>

              <el-row :gutter="20">
                <el-col :span="12">
                  <el-form-item label="狀態">
                    <el-select v-model="searchCriteria.seatsStatus" placeholder="(不限制)" clearable style="width: 100%">
                      <el-option label="可用" value="可用" />
                      <el-option label="維修" value="維修" />
                      <el-option label="停用" value="停用" />
                    </el-select>
                  </el-form-item>
                </el-col>
                <el-col :span="12">
                  <el-form-item label="SpotId (精準)">
                    <el-input v-model="searchCriteria.spotId" type="number" placeholder="請輸入據點ID" clearable>
                      <template #prefix><i class="fas fa-map-marker-alt"></i></template>
                    </el-input>
                  </el-form-item>
                </el-col>
              </el-row>

              <el-row :gutter="20">
                <el-col :span="12">
                  <el-form-item label="序號 (模糊)">
                    <el-input v-model="searchCriteria.serialNumber" placeholder="請輸入序號" clearable>
                      <template #prefix><i class="fas fa-barcode"></i></template>
                    </el-input>
                  </el-form-item>
                </el-col>
              </el-row>

              <div class="form-actions">
                <el-button type="primary" @click="handleSearch" class="search-btn">
                  <i class="fas fa-search mr-1"></i> 查詢
                </el-button>
                <router-link to="/admin/seat/list">
                  <el-button>
                    <i class="fas fa-arrow-left mr-1"></i> 回清單
                  </el-button>
                </router-link>
              </div>
            </el-form>
          </el-card>
        </transition>
      </div>
    </section>
  </div>
</template>

<script setup>
import { ref } from 'vue'
import { useRouter } from 'vue-router'

// 明確定義元件名稱，方便識別與除錯
defineOptions({
  name: 'SeatSearch'
})

const router = useRouter()
const searchCriteria = ref({
  seatsName: '',
  seatsType: '',
  seatsStatus: '',
  spotId: '',
  serialNumber: '',
})

const handleSearch = () => {
  // [修正] 加上 /admin
  router.push({ path: '/admin/seat/result', query: { ...searchCriteria.value } })
}
</script>

<style scoped>
/* ========== 頁面容器 ========== */
.seat-search-container {
  padding: 20px;
  background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
  min-height: 100vh;
}

/* ========== 頁面標題區 ========== */
.page-title-box {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 16px 24px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
}

.title-icon {
  width: 56px;
  height: 56px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  color: white;
  transition: transform 0.3s ease;
}

.title-icon:hover {
  transform: scale(1.1) rotate(5deg);
}

.search-mode {
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
}

.title-content h1 {
  margin: 0;
  font-size: 1.5rem;
  font-weight: 600;
  color: #303133;
}

.title-content .subtitle {
  margin: 4px 0 0;
  font-size: 0.875rem;
  color: #909399;
}

/* ========== 搜尋卡片 ========== */
.search-card {
  border-radius: 12px;
  max-width: 800px;
  margin: 0 auto;
}

/* ========== 按鈕區 ========== */
.form-actions {
  display: flex;
  gap: 12px;
  padding-top: 24px;
  margin-top: 24px;
  border-top: 1px solid #ebeef5;
}

.search-btn {
  min-width: 120px;
  border-radius: 10px;
  font-weight: 600;
}

/* ========== 動畫效果 ========== */
.zoom-fade-enter-active {
  transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.zoom-fade-leave-active {
  transition: all 0.3s ease-in;
}

.zoom-fade-enter-from {
  transform: scale(0.9);
  opacity: 0;
}

.zoom-fade-leave-to {
  transform: scale(0.95);
  opacity: 0;
}

/* ========== 工具類 ========== */
.mr-1 { margin-right: 4px; }
.mr-2 { margin-right: 8px; }
</style>
</file>

<file path="frontend/src/views/spot/SpotOne.vue">
<template>
  <div class="spot-one-container">
    <!-- ========== Header 區域 ========== -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row align-items-center">
          <div class="col-sm-6">
            <div class="page-title-box">
              <div class="title-icon detail-mode">
                <i class="fas fa-map-marker-alt"></i>
              </div>
              <div class="title-content">
                <h1>景點詳細資料</h1>
                <p class="subtitle">查看據點完整資訊</p>
              </div>
            </div>
          </div>
          <div class="col-sm-6 text-right">
            <ol class="breadcrumb-modern">
              <li><router-link to="/admin/spot/list"><i class="fas fa-home"></i> Home</router-link></li>
              <li class="active">Spot Detail</li>
            </ol>
          </div>
        </div>
      </div>
    </section>

    <section class="content">
      <div class="container-fluid">
        <transition name="zoom-fade" appear>
          <div>
            <el-card v-if="loading" shadow="hover" class="detail-card">
              <div class="loading-state">
                <i class="fas fa-spinner fa-spin"></i>
                <span>載入中...</span>
              </div>
            </el-card>

            <el-card v-else-if="!spot" shadow="hover" class="detail-card">
              <el-empty description="找不到資料" />
            </el-card>

            <el-card v-else shadow="hover" class="detail-card">
              <div class="detail-content">
                <el-descriptions :column="2" border>
                  <el-descriptions-item label="ID">
                    <el-tag type="info">{{ spot.spotId }}</el-tag>
                  </el-descriptions-item>
                  <el-descriptions-item label="代碼 (Code)">
                    <span class="code-text">{{ spot.spotCode }}</span>
                  </el-descriptions-item>
                  <el-descriptions-item label="名稱 (Name)">
                    <span class="name-text">{{ spot.spotName }}</span>
                  </el-descriptions-item>
                  <el-descriptions-item label="狀態 (Status)">
                    <el-tag :type="spot.spotStatus === '營運中' ? 'success' : (spot.spotStatus === '維修中' ? 'warning' : 'danger')">
                      {{ spot.spotStatus }}
                    </el-tag>
                  </el-descriptions-item>
                  <el-descriptions-item label="地址 (Address)" :span="2">
                    <i class="fas fa-map-marker-alt text-primary mr-2"></i>{{ spot.spotAddress }}
                  </el-descriptions-item>
                  <el-descriptions-item label="Merchant ID">
                    <el-tag v-if="spot.merchantId" type="info">{{ spot.merchantId }}</el-tag>
                    <span v-else class="text-muted">-</span>
                  </el-descriptions-item>
                  <el-descriptions-item label="緯度 (Latitude)">
                    {{ spot.latitude || '-' }}
                  </el-descriptions-item>
                  <el-descriptions-item label="經度 (Longitude)">
                    {{ spot.longitude || '-' }}
                  </el-descriptions-item>
                </el-descriptions>
              </div>

              <div class="card-actions">
                <router-link to="/admin/spot/list">
                  <el-button>
                    <i class="fas fa-arrow-left mr-1"></i> 回列表
                  </el-button>
                </router-link>
                <router-link :to="`/admin/spot/edit/${spot.spotId}`">
                  <el-button type="primary">
                    <i class="fas fa-edit mr-1"></i> 編輯
                  </el-button>
                </router-link>
              </div>
            </el-card>
          </div>
        </transition>
      </div>
    </section>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import { useRoute } from 'vue-router';
import axios from 'axios';

// 明確定義元件名稱，方便識別與除錯
defineOptions({
  name: 'SpotOne'
});

const route = useRoute();
const spot = ref(null);
const loading = ref(true);

onMounted(async () => {
  const id = route.params.id;
  if (id) {
    try {
      const response = await axios.get(`/api/spot/${id}`);
      spot.value = response.data;
    } catch (error) {
      console.error('Error fetching spot:', error);
    }
  }
  loading.value = false;
});
</script>

<style scoped>
/* ========== 頁面容器 ========== */
.spot-one-container {
  padding: 20px;
  background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
  min-height: 100vh;
}

/* ========== 頁面標題區 ========== */
.page-title-box {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 16px 24px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
}

.title-icon {
  width: 56px;
  height: 56px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  color: white;
  transition: transform 0.3s ease;
}

.title-icon:hover {
  transform: scale(1.1) rotate(5deg);
}

.detail-mode {
  background: linear-gradient(135deg, #909399 0%, #c0c4cc 100%);
}

.title-content h1 {
  margin: 0;
  font-size: 1.5rem;
  font-weight: 600;
  color: #303133;
}

.title-content .subtitle {
  margin: 4px 0 0;
  font-size: 0.875rem;
  color: #909399;
}

/* ========== 面包屑 ========== */
.breadcrumb-modern {
  list-style: none;
  padding: 0;
  margin: 0;
  display: flex;
  gap: 8px;
  align-items: center;
  justify-content: flex-end;
}

.breadcrumb-modern li a {
  color: #409eff;
  text-decoration: none;
}

.breadcrumb-modern li.active {
  color: #909399;
}

.breadcrumb-modern li:not(:last-child)::after {
  content: '/';
  margin-left: 8px;
  color: #c0c4cc;
}

/* ========== 詳情卡片 ========== */
.detail-card {
  border-radius: 12px;
  max-width: 900px;
  margin: 0 auto;
}

.loading-state {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  padding: 40px;
  color: #409eff;
  font-size: 16px;
}

.detail-content {
  margin-bottom: 24px;
}

.code-text {
  font-family: monospace;
  background: #f5f7fa;
  padding: 2px 8px;
  border-radius: 4px;
}

.name-text {
  font-weight: 600;
  color: #303133;
}

/* ========== 按鈕區 ========== */
.card-actions {
  display: flex;
  justify-content: space-between;
  padding-top: 24px;
  border-top: 1px solid #ebeef5;
}

/* ========== 動畫效果 ========== */
.zoom-fade-enter-active {
  transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.zoom-fade-leave-active {
  transition: all 0.3s ease-in;
}

.zoom-fade-enter-from {
  transform: scale(0.9);
  opacity: 0;
}

.zoom-fade-leave-to {
  transform: scale(0.95);
  opacity: 0;
}

/* ========== 工具類 ========== */
.mr-1 { margin-right: 4px; }
.mr-2 { margin-right: 8px; }
.text-primary { color: #409eff; }
.text-muted { color: #909399; }
</style>
</file>

<file path="frontend/src/views/spot/SpotResult.vue">
<template>
  <div class="spot-result-container">
    <!-- ========== Header 區域 ========== -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row align-items-center">
          <div class="col-sm-6">
            <div class="page-title-box">
              <div class="title-icon result-mode">
                <i class="fas fa-list-alt"></i>
              </div>
              <div class="title-content">
                <h1>查詢結果列表</h1>
                <p class="subtitle">顯示符合條件的據點資料</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="content">
      <div class="container-fluid">
        <transition name="fade-slide" appear>
          <el-card shadow="hover" class="result-card">
            <el-empty v-if="spotList.length === 0" description="沒有找到符合條件的資料。" />

            <el-table
              v-else
              :data="spotList"
              stripe
              style="width: 100%"
              :header-cell-style="{ background: '#f5f7fa', fontWeight: 'bold', color: '#303133' }"
              class="modern-table"
            >
              <el-table-column prop="spotId" label="ID" width="70" align="center" />
              <el-table-column prop="spotCode" label="代碼" width="100" />
              <el-table-column prop="spotName" label="名稱" min-width="150">
                <template #default="{ row }">
                  <div class="spot-name-cell">
                    <i class="fas fa-store text-primary mr-2"></i>
                    <span>{{ row.spotName }}</span>
                  </div>
                </template>
              </el-table-column>
              <el-table-column prop="spotAddress" label="地址" min-width="200" show-overflow-tooltip />
              <el-table-column prop="spotStatus" label="狀態" width="100" align="center">
                <template #default="{ row }">
                  <el-tag
                    :type="row.spotStatus === '營運中' ? 'success' : (row.spotStatus === '維修中' ? 'warning' : 'danger')"
                    size="small"
                    effect="light"
                  >
                    {{ row.spotStatus }}
                  </el-tag>
                </template>
              </el-table-column>
              <el-table-column label="Merchant ID" width="110" align="center">
                <template #default="{ row }">
                  <el-tag v-if="row.merchantId" type="info" size="small">{{ row.merchantId }}</el-tag>
                  <span v-else class="text-muted">-</span>
                </template>
              </el-table-column>
              <el-table-column prop="latitude" label="緯度" width="100" />
              <el-table-column prop="longitude" label="經度" width="100" />
            </el-table>

            <div class="card-actions">
              <router-link to="/admin/spot/search">
                <el-button type="primary">
                  <i class="fas fa-search mr-1"></i> 回查詢
                </el-button>
              </router-link>
            </div>
          </el-card>
        </transition>
      </div>
    </section>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import { useRoute } from 'vue-router';
import axios from 'axios';

const route = useRoute();
const spotList = ref([]);

// 明確定義元件名稱，方便識別與除錯
defineOptions({
  name: 'SpotResult'
})

onMounted(async () => {
  const query = route.query;
  try {
    // [AXIOS GET 請求原理]
    // 1. 動作：發送 GET 請求到 /spot/condition，並帶上查詢參數 (query)。
    const response = await axios.get('/api/spot/condition', { params: query });
    // 2. 接收：後端回傳的是一個 JSON 陣列 (List<RentalSpot>，即租借據點列表)。
    // 3. 更新：將資料存入 spotList，Vue 的 v-for 就會自動把表格畫出來。
    spotList.value = response.data;
  } catch (error) {
    console.error('Error fetching spots:', error);
  }
});
</script>

<style scoped>
/* ========== 頁面容器 ========== */
.spot-result-container {
  padding: 20px;
  background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
  min-height: 100vh;
}

/* ========== 頁面標題區 ========== */
.page-title-box {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 16px 24px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
}

.title-icon {
  width: 56px;
  height: 56px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  color: white;
  transition: transform 0.3s ease;
}

.title-icon:hover {
  transform: scale(1.1) rotate(5deg);
}

.result-mode {
  background: linear-gradient(135deg, #67c23a 0%, #95d475 100%);
}

.title-content h1 {
  margin: 0;
  font-size: 1.5rem;
  font-weight: 600;
  color: #303133;
}

.title-content .subtitle {
  margin: 4px 0 0;
  font-size: 0.875rem;
  color: #909399;
}

/* ========== 結果卡片 ========== */
.result-card {
  border-radius: 12px;
}

.modern-table {
  border-radius: 8px;
  overflow: hidden;
}

.spot-name-cell {
  display: flex;
  align-items: center;
}

/* ========== 按鈕區 ========== */
.card-actions {
  display: flex;
  gap: 12px;
  padding-top: 24px;
  margin-top: 24px;
  border-top: 1px solid #ebeef5;
}

/* ========== 動畫效果 ========== */
.fade-slide-enter-active {
  transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.fade-slide-leave-active {
  transition: all 0.3s ease-in;
}

.fade-slide-enter-from {
  transform: translateY(20px);
  opacity: 0;
}

.fade-slide-leave-to {
  transform: translateY(-10px);
  opacity: 0;
}

/* ========== 工具類 ========== */
.mr-1 { margin-right: 4px; }
.mr-2 { margin-right: 8px; }
.text-primary { color: #409eff; }
.text-muted { color: #909399; }
</style>
</file>

<file path="frontend/src/views/spot/SpotSearch.vue">
<template>
  <div class="spot-search-container">
    <!-- ========== Header 區域 ========== -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row align-items-center">
          <div class="col-sm-6">
            <div class="page-title-box">
              <div class="title-icon search-mode">
                <i class="fas fa-search"></i>
              </div>
              <div class="title-content">
                <h1>景點查詢</h1>
                <p class="subtitle">依條件搜尋據點資料</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="content">
      <div class="container-fluid">
        <transition name="zoom-fade" appear>
          <el-card shadow="hover" class="search-card">
            <el-form :model="searchCriteria" label-width="120px" label-position="top" @submit.prevent="handleSearch">
              <el-row :gutter="20">
                <el-col :span="12">
                  <el-form-item label="景點名稱">
                    <el-input v-model="searchCriteria.spotName" placeholder="請輸入景點名稱" clearable>
                      <template #prefix><i class="fas fa-store"></i></template>
                    </el-input>
                  </el-form-item>
                </el-col>
                <el-col :span="12">
                  <el-form-item label="景點代碼">
                    <el-input v-model="searchCriteria.spotCode" placeholder="請輸入景點代碼" clearable>
                      <template #prefix><i class="fas fa-barcode"></i></template>
                    </el-input>
                  </el-form-item>
                </el-col>
              </el-row>

              <el-row :gutter="20">
                <el-col :span="12">
                  <el-form-item label="狀態">
                    <el-select v-model="searchCriteria.spotStatus" placeholder="啟用/停用" clearable style="width: 100%">
                      <el-option label="營運中" value="營運中" />
                      <el-option label="停用" value="停用" />
                      <el-option label="維修中" value="維修中" />
                    </el-select>
                  </el-form-item>
                </el-col>
                <el-col :span="12">
                  <el-form-item label="商家ID">
                    <el-input v-model="searchCriteria.merchantId" type="number" :min="1" placeholder="請輸入商家ID" clearable>
                      <template #prefix><i class="fas fa-building"></i></template>
                    </el-input>
                  </el-form-item>
                </el-col>
              </el-row>

              <div class="form-actions">
                <el-button type="primary" @click="handleSearch" class="search-btn">
                  <i class="fas fa-search mr-1"></i> 查詢
                </el-button>
                <router-link to="/admin/spot/add">
                  <el-button type="success">
                    <i class="fas fa-plus mr-1"></i> 新增景點
                  </el-button>
                </router-link>
              </div>
            </el-form>
          </el-card>
        </transition>
      </div>
    </section>
  </div>
</template>

<script setup>
import { ref } from 'vue'
import { useRouter } from 'vue-router'

// 明確定義元件名稱，方便識別與除錯
defineOptions({
  name: 'SpotSearch'
})

const router = useRouter()
const searchCriteria = ref({
  spotName: '',
  spotCode: '',
  spotStatus: '',
  merchantId: '',
})

const handleSearch = () => {
  // 將查詢條件帶入 URL query 參數，跳轉至結果頁
  router.push({
    path: '/admin/spot/result',
    query: { ...searchCriteria.value },
  })
}
</script>

<style scoped>
/* ========== 頁面容器 ========== */
.spot-search-container {
  padding: 20px;
  background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
  min-height: 100vh;
}

/* ========== 頁面標題區 ========== */
.page-title-box {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 16px 24px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
}

.title-icon {
  width: 56px;
  height: 56px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  color: white;
  transition: transform 0.3s ease;
}

.title-icon:hover {
  transform: scale(1.1) rotate(5deg);
}

.search-mode {
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
}

.title-content h1 {
  margin: 0;
  font-size: 1.5rem;
  font-weight: 600;
  color: #303133;
}

.title-content .subtitle {
  margin: 4px 0 0;
  font-size: 0.875rem;
  color: #909399;
}

/* ========== 搜尋卡片 ========== */
.search-card {
  border-radius: 12px;
  max-width: 800px;
  margin: 0 auto;
}

/* ========== 按鈕區 ========== */
.form-actions {
  display: flex;
  gap: 12px;
  padding-top: 24px;
  margin-top: 24px;
  border-top: 1px solid #ebeef5;
}

.search-btn {
  min-width: 120px;
  border-radius: 10px;
  font-weight: 600;
}

/* ========== 動畫效果 ========== */
.zoom-fade-enter-active {
  transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.zoom-fade-leave-active {
  transition: all 0.3s ease-in;
}

.zoom-fade-enter-from {
  transform: scale(0.9);
  opacity: 0;
}

.zoom-fade-leave-to {
  transform: scale(0.95);
  opacity: 0;
}

/* ========== 工具類 ========== */
.mr-1 { margin-right: 4px; }
</style>
</file>

<file path="frontend/index.html">
<!doctype html>
<html lang="zh-Hant">
  <head>
    <script src="/config.js"></script>
    <meta charset="UTF-8" />
    <link rel="icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>維修管理系統</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="/vendor/adminlte/plugins/fontawesome-free/css/all.min.css" />
    <link
      rel="stylesheet"
      href="/vendor/adminlte/plugins/overlayScrollbars/css/OverlayScrollbars.min.css"
    />
    <link rel="stylesheet" href="/vendor/adminlte/dist/css/adminlte.min.css" />
  </head>

  <body class="hold-transition sidebar-mini layout-fixed">
    <div id="app"></div>

    <script src="/vendor/adminlte/plugins/jquery/jquery.min.js"></script>
    <script src="/vendor/adminlte/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="/vendor/adminlte/plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js"></script>
    <script src="/vendor/adminlte/dist/js/adminlte.min.js"></script>

    <script type="module" src="/src/main.js"></script>
  </body>
</html>
</file>

<file path="frontend/src/api/modules/maintenance.js">
/**
 * 維修模組 API
 * 封裝所有維修相關的 API 呼叫
 */
import http from '../http'

// ============ 維護人員 (Staff) API ============

/**
 * 取得所有在職維護人員
 */
export const getAllStaff = () => {
  return http.get('/maintenance/staff')
}

/**
 * ★ Bug2 修復：取得啟用中的維護人員（建立工單用）
 */
export const getActiveStaff = () => {
  return http.get('/maintenance/staff/active')
}

/**
 * 取得單一維護人員
 * @param {number} id - 人員 ID
 */
export const getStaffById = (id) => {
  return http.get(`/maintenance/staff/${id}`)
}

/**
 * 取得已停用的維護人員 (歷史紀錄)
 */
export const getInactiveStaff = () => {
  return http.get('/maintenance/staff/inactive')
}

/**
 * 新增維護人員
 * @param {Object} staff - 人員資料
 */
export const createStaff = (staff) => {
  return http.post('/maintenance/staff', staff)
}

/**
 * 更新維護人員
 * @param {number} id - 人員 ID
 * @param {Object} staff - 人員資料
 */
export const updateStaff = (id, staff) => {
  return http.put(`/maintenance/staff/${id}`, staff)
}

/**
 * 刪除維護人員 (軟刪除)
 * @param {number} id - 人員 ID
 */
export const deleteStaff = (id) => {
  return http.delete(`/maintenance/staff/${id}`)
}

/**
 * 轉移工單並刪除人員
 * @param {number} targetStaffId - 接手人員 ID
 * @param {number} deleteStaffId - 要停用的人員 ID
 */
export const transferAndDelete = (targetStaffId, deleteStaffId) => {
  return http.post('/maintenance/staff/transfer-and-delete', {
    targetStaffId,
    deleteStaffId,
  })
}

// ============ 工單 (Ticket) API ============

/**
 * 取得全部工單
 */
export const getAllTickets = () => {
  return http.get('/maintenance/tickets')
}

/**
 * 取得待處理工單 (Active)
 */
export const getActiveTickets = () => {
  return http.get('/maintenance/tickets/active')
}

/**
 * 取得歷史工單 (History)
 */
export const getHistoryTickets = () => {
  return http.get('/maintenance/tickets/history')
}

/**
 * 取得單一工單
 * @param {number} id - 工單 ID
 */
export const getTicketById = (id) => {
  return http.get(`/maintenance/tickets/${id}`)
}

/**
 * ★ C) 新增：取得工單歷程記錄
 * @param {number} id - 工單 ID
 */
export const getTicketLogs = (id) => {
  return http.get(`/maintenance/tickets/${id}/logs`)
}

/**
 * 依據點 ID 查詢工單
 * @param {number} spotId - 據點 ID
 */
export const getTicketsBySpot = (spotId) => {
  return http.get(`/maintenance/tickets/spot/${spotId}`)
}

/**
 * 新增工單
 * @param {Object} ticket - 工單資料
 */
export const createTicket = (ticket) => {
  return http.post('/maintenance/tickets', ticket)
}

/**
 * 更新工單
 * @param {number} id - 工單 ID
 * @param {Object} ticket - 工單資料
 */
export const updateTicket = (id, ticket) => {
  return http.put(`/maintenance/tickets/${id}`, ticket)
}

// ============ 工單狀態流程 API ============

/**
 * 指派維修人員
 * @param {number} ticketId - 工單 ID
 * @param {number|null} staffId - 人員 ID (null 表示取消指派)
 */
export const assignStaff = (ticketId, staffId) => {
  return http.post(`/maintenance/tickets/${ticketId}/assign`, { staffId })
}

/**
 * 開始維修
 * @param {number} ticketId - 工單 ID
 */
export const startTicket = (ticketId) => {
  return http.post(`/maintenance/tickets/${ticketId}/start`)
}

/**
 * 結案
 * @param {number} ticketId - 工單 ID
 * @param {string} resultType - 結果類型 (FIXED, NOT_FIXED, NO_ISSUE, NOT_FIXABLE, OTHER)
 * @param {string} resolveNote - 備註
 */
export const resolveTicket = (ticketId, resultType, resolveNote) => {
  return http.post(`/maintenance/tickets/${ticketId}/resolve`, { resultType, resolveNote })
}

/**
 * 取消工單
 * @param {number} ticketId - 工單 ID
 * @param {string} reason - 取消原因
 */
export const cancelTicket = (ticketId, reason) => {
  return http.post(`/maintenance/tickets/${ticketId}/cancel`, { reason })
}

// ============ 據點 API (供工單表單使用) ============

/**
 * 取得所有據點 (供下拉選單使用)
 */
export const getAllSpots = () => {
  return http.get('/maintenance/spots')
}

// ============ 椅子 API (供工單表單使用) ============

/**
 * 取得所有椅子 (供下拉選單使用)
 */
export const getAllSeats = () => {
  return http.get('/maintenance/seats')
}

/**
 * 依據點 ID 取得椅子
 * @param {number} spotId - 據點 ID
 */
export const getSeatsBySpot = (spotId) => {
  return http.get(`/maintenance/seats/spot/${spotId}`)
}

// ============ 排程 (Schedule) API ============

/**
 * 取得所有排程
 */
export const getAllSchedules = () => {
  return http.get('/maintenance/schedule')
}

/**
 * 取得單一排程
 * @param {number} id - 排程 ID
 */
export const getScheduleById = (id) => {
  return http.get(`/maintenance/schedule/${id}`)
}

/**
 * 取得啟用中的排程
 */
export const getActiveSchedules = () => {
  return http.get('/maintenance/schedule/active')
}

/**
 * 建立排程
 * @param {Object} schedule - 排程資料
 */
export const createSchedule = (schedule) => {
  return http.post('/maintenance/schedule', schedule)
}

/**
 * 更新排程
 * @param {number} id - 排程 ID
 * @param {Object} schedule - 排程資料
 */
export const updateSchedule = (id, schedule) => {
  return http.put(`/maintenance/schedule/${id}`, schedule)
}

/**
 * 刪除排程
 * @param {number} id - 排程 ID
 */
export const deleteSchedule = (id) => {
  return http.delete(`/maintenance/schedule/${id}`)
}

/**
 * 切換排程啟用狀態
 * @param {number} id - 排程 ID
 */
export const toggleSchedule = (id) => {
  return http.patch(`/maintenance/schedule/${id}/toggle`)
}

// ============ 資產健康度統計 (Stats) API ============

/**
 * 取得資產健康度統計
 * @param {string} assetType - 資產類型：'SPOT' 或 'SEAT'
 */
export const getAssetStats = (assetType) => {
  return http.get('/maintenance/stats/assets', { params: { assetType } })
}

// ============ 工單附件 (Attachment) API ============

/**
 * 上傳工單附件（圖片）
 * @param {number} ticketId - 工單 ID
 * @param {File[]} files - 圖片檔案陣列
 * @param {string} note - 備註（可選）
 */
export const uploadTicketAttachments = (ticketId, files, note = null) => {
  const formData = new FormData()
  
  // 加入多個檔案
  files.forEach(file => {
    formData.append('files', file)
  })
  
  // 加入備註（可選）
  if (note) {
    formData.append('note', note)
  }
  
  return http.post(`/maintenance/tickets/${ticketId}/attachments`, formData, {
    headers: {
      'Content-Type': 'multipart/form-data'
    }
  })
}

/**
 * 取得工單的所有附件
 * @param {number} ticketId - 工單 ID
 */
export const getTicketAttachments = (ticketId) => {
  return http.get(`/maintenance/tickets/${ticketId}/attachments`)
}

/**
 * 刪除附件（軟刪除）
 * @param {number} attachmentId - 附件 ID
 */
export const deleteTicketAttachment = (attachmentId) => {
  return http.delete(`/maintenance/attachments/${attachmentId}`)
}

// 匯出所有 API 作為預設物件 (方便一次 import)
export default {
  // Staff
  getAllStaff,
  getActiveStaff, // ★ 修復：加入 getActiveStaff
  getStaffById,
  getInactiveStaff,
  createStaff,
  updateStaff,
  deleteStaff,
  transferAndDelete,
  // Ticket
  getAllTickets,
  getActiveTickets,
  getHistoryTickets,
  getTicketById,
  getTicketLogs, // ★ (1A) 修復：加入 getTicketLogs
  getTicketsBySpot,
  createTicket,
  updateTicket,
  // Workflow
  assignStaff,
  startTicket,
  resolveTicket,
  cancelTicket,
  // Spot
  getAllSpots,
  // Seat
  getAllSeats,
  getSeatsBySpot,
  // Schedule
  getAllSchedules,
  getScheduleById,
  getActiveSchedules,
  createSchedule,
  updateSchedule,
  deleteSchedule,
  toggleSchedule,
  // Stats
  getAssetStats,
  // Attachments (圖片附件)
  uploadTicketAttachments,
  getTicketAttachments,
  deleteTicketAttachment,
  // Task 2: 歷史工單查詢支援
  getTicketsByStaff: (staffId, statuses = null) => {
    const params = statuses ? { statuses: statuses.join(',') } : {}
    return api.get(`/api/maintenance/staff/${staffId}/tickets`, { params })
  },
}
</file>

<file path="frontend/src/api/modules/tdx.js">
import axios from 'axios';

const tdxApi = axios.create({
  baseURL: 'https://tdx.transportdata.tw/api/basic',
});

const authApi = axios.create({
  baseURL: 'https://tdx.transportdata.tw/auth/realms/TDXConnect/protocol/openid-connect',
});

// 提示: 請務必將以下預留位置替換為您真實的 TDX API 憑證
const clientId = 'YOUR_CLIENT_ID'; // <-- 請填入您的 Client ID
const clientSecret = 'YOUR_CLIENT_SECRET'; // <-- 請填入您的 Client Secret

let accessToken = null;
let tokenExpiryTime = 0;

/**
 * 從 TDX 認證伺服器獲取 access token。
 * 此函數會快取 token，避免不必要的重複認證。
 * @returns {Promise<string>} The access token.
 */
async function getAccessToken() {
  // 如果 token 仍然有效，直接返回快取的 token
  if (accessToken && Date.now() < tokenExpiryTime) {
    return accessToken;
  }

  // 檢查是否提供了憑證
  if (clientId === 'YOUR_CLIENT_ID' || clientSecret === 'YOUR_CLIENT_SECRET') {
    const errorMessage = "TDX API 憑證未設定。請在 'frontend/src/api/modules/tdx.js' 檔案中設定您的 Client ID 和 Client Secret。";
    console.error(errorMessage);
    // 直接拋出錯誤，讓呼叫者可以捕捉到這個明確的問題
    throw new Error(errorMessage);
  }

  try {
    const params = new URLSearchParams();
    params.append('grant_type', 'client_credentials');
    params.append('client_id', clientId);
    params.append('client_secret', clientSecret);

    const response = await authApi.post('/token', params, {
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
    });

    accessToken = response.data.access_token;
    // 將 token 的過期時間設定為比實際過期時間提早 20 秒，以增加緩衝
    tokenExpiryTime = Date.now() + (response.data.expires_in - 20) * 1000;
    
    return accessToken;
  } catch (error) {
    console.error('從 TDX 獲取 access token 失敗:', error);
    // 將原始錯誤向上拋出
    throw error;
  }
}

/**
 * 獲取所有觀光景點資料。
 * @returns {Promise<Array>} 景點列表。
 */
export async function getScenicSpots() {
  const token = await getAccessToken();
  const response = await tdxApi.get('/v2/Tourism/ScenicSpot', {
    headers: {
      Authorization: `Bearer ${token}`,
    },
    params: {
      '$format': 'JSON',
    }
  });
  return response.data;
}

/**
 * 獲取所有餐飲資料。
 * @returns {Promise<Array>} 餐廳列表。
 */
export async function getRestaurants() {
  const token = await getAccessToken();
  const response = await tdxApi.get('/v2/Tourism/Restaurant', {
    headers: {
      Authorization: `Bearer ${token}`,
    },
    params: {
      '$format': 'JSON',
    }
  });
  return response.data;
}
</file>

<file path="frontend/src/components/maintenance/ScheduleCalendar.vue">
<script setup>
import { ref, computed } from 'vue'
import { useScheduleConfig } from '@/composables/maintenance/useScheduleConfig'

const props = defineProps({
  schedules: { type: Array, default: () => [] },
})

const emit = defineEmits(['select-date', 'click-schedule'])
const { scheduleTypeConfig, formatTime } = useScheduleConfig()

const calendarValue = ref(new Date())

// ====== 中文日曆 Header（取代 el-calendar 預設英文） ======
const weekDaysZh = ['日', '一', '二', '三', '四', '五', '六']
const monthNameZh = (date) => `${date.getFullYear()} 年 ${date.getMonth() + 1} 月`
const currentMonthText = computed(() => monthNameZh(calendarValue.value))

const goPrevMonth = () => {
  const d = new Date(calendarValue.value)
  d.setMonth(d.getMonth() - 1)
  calendarValue.value = d
}
const goNextMonth = () => {
  const d = new Date(calendarValue.value)
  d.setMonth(d.getMonth() + 1)
  calendarValue.value = d
}
const goToday = () => {
  calendarValue.value = new Date()
}

// 格式化日期為 key
const formatDateKey = (date) => {
  const d = new Date(date)
  return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`
}

// 取得某日期的排程
const getSchedulesForDate = (date) => {
  const dateStr = formatDateKey(date)
  return props.schedules.filter((s) => {
    if (!s.isActive) return false
    const nextDate = formatDateKey(new Date(s.nextExecuteAt))
    return nextDate === dateStr
  })
}

const handleDateClick = (date) => emit('select-date', date)
const handleScheduleClick = (schedule) => emit('click-schedule', schedule)
</script>

<template>
  <div class="schedule-calendar">
    <!-- ✅ 自訂中文 Header -->
    <div class="calendar-header-zh">
      <div class="title">{{ currentMonthText }}</div>
      <div class="actions">
        <el-button size="small" @click="goPrevMonth">上個月</el-button>
        <el-button size="small" @click="goToday">今天</el-button>
        <el-button size="small" @click="goNextMonth">下個月</el-button>
      </div>
    </div>

    <!-- ✅ 中文星期列 -->
    <div class="week-header-zh">
      <div v-for="d in weekDaysZh" :key="d" class="week-day">{{ d }}</div>
    </div>

    <el-calendar v-model="calendarValue" class="calendar-body">
      <template #date-cell="{ data }">
        <div
          class="calendar-cell"
          :class="{ 'has-schedule': getSchedulesForDate(data.date).length > 0 }"
          @click="handleDateClick(data.date)"
        >
          <div class="date-number">
            {{ data.date.getDate() }}
          </div>

          <!-- 排程標記 -->
          <div class="schedule-dots" v-if="getSchedulesForDate(data.date).length > 0">
            <template
              v-for="schedule in getSchedulesForDate(data.date).slice(0, 3)"
              :key="schedule.scheduleId"
            >
              <el-tooltip
                :content="`${schedule.title} - ${formatTime(schedule.executeTime)}`"
                placement="top"
              >
                <div
                  class="schedule-dot"
                  :style="{ backgroundColor: scheduleTypeConfig[schedule.scheduleType]?.color }"
                  @click.stop="handleScheduleClick(schedule)"
                ></div>
              </el-tooltip>
            </template>

            <span v-if="getSchedulesForDate(data.date).length > 3" class="more-count">
              +{{ getSchedulesForDate(data.date).length - 3 }}
            </span>
          </div>
        </div>
      </template>
    </el-calendar>

    <!-- 圖例 -->
    <div class="calendar-legend">
      <span v-for="(config, key) in scheduleTypeConfig" :key="key" class="legend-item">
        <span class="legend-dot" :style="{ backgroundColor: config.color }"></span>
        {{ config.text }}
      </span>
    </div>
  </div>
</template>

<style scoped>
.schedule-calendar {
  border-radius: 12px;
  overflow: hidden;
  background: #fff;
}

/* ✅ 中文 header */
.calendar-header-zh {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  border-bottom: 1px solid #ebeef5;
}
.calendar-header-zh .title {
  font-size: 16px;
  font-weight: 700;
  color: #303133;
}
.calendar-header-zh .actions {
  display: flex;
  gap: 8px;
}

/* ✅ 中文星期列 */
.week-header-zh {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  padding: 8px 10px;
  background: #f5f7fa;
  border-bottom: 1px solid #ebeef5;
}
.week-day {
  text-align: center;
  font-size: 12px;
  font-weight: 600;
  color: #606266;
}

/* cell */
.calendar-cell {
  height: 100%;
  padding: 4px;
  cursor: pointer;
  transition: all 0.2s;
  border-radius: 6px;
}
.calendar-cell:hover {
  background: rgba(64, 158, 255, 0.1);
}
.calendar-cell.has-schedule {
  background: rgba(64, 158, 255, 0.05);
}

.date-number {
  font-size: 14px;
  font-weight: 600;
  text-align: center;
  margin-bottom: 4px;
}

.schedule-dots {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 3px;
  flex-wrap: wrap;
}

.schedule-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  cursor: pointer;
  transition: transform 0.2s;
}
.schedule-dot:hover {
  transform: scale(1.3);
}

.more-count {
  font-size: 10px;
  color: #909399;
}

.calendar-legend {
  display: flex;
  justify-content: center;
  gap: 20px;
  padding: 12px;
  background: #f5f7fa;
  border-top: 1px solid #ebeef5;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  color: #606266;
}
.legend-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
}

/* ✅ 關鍵：把 el-calendar 原本英文 header + 英文星期列隱藏 */
:deep(.el-calendar__header) {
  display: none !important;
}
:deep(.el-calendar-table thead) {
  display: none !important;
}

/* day cell height */
:deep(.el-calendar-table .el-calendar-day) {
  height: 70px;
  padding: 0;
}
</style>
</file>

<file path="frontend/src/composables/maintenance/useStaffStatus.js">
/**
 * 維護人員狀態計算邏輯 (統一使用，避免重複實作)
 * 
 * 用途：
 * - 根據 maintenanceInformation (tickets) 動態計算人員即時狀態
 * - 提供統一的狀態判斷邏輯給：統計卡、人員列表、人員詳情彈窗
 * 
 * 修改原因：
 * - 原本人員狀態是靜態欄位，沒有根據工單動態計算
 * - 導致「維修中」、「已指派」統計不準確
 * - 人員列表 badge 與實際工單狀態不一致
 */

/**
 * 判斷工單狀態是否為已完成 (RESOLVED / CANCELLED)
 * @param {string} status - 工單狀態
 * @returns {boolean}
 */
export function isCompletedStatus(status) {
  return status === 'RESOLVED' || status === 'CANCELLED'
}

/**
 * 判斷是否為保養任務 (根據問題類型或描述關鍵字)
 * @param {string} issueType - 問題類型
 * @param {string} issueDesc - 問題描述
 * @returns {boolean}
 */
export function isMaintenanceTask(issueType, issueDesc) {
  const type = String(issueType || '').trim()
  const desc = String(issueDesc || '').trim()

  if (!type && !desc) return false

  // 保養相關關鍵字 (涵蓋排程表單的 issueTypeOptions)
  const keywords = ['保養', '維護', '例行', '檢查', '清潔', '校正', '安全', '耗材', '更換']

  // 排程自動產生的保養任務標記
  const scheduleMarker = '【排程自動保養】'

  return keywords.some((k) => type.includes(k) || desc.includes(k)) || desc.includes(scheduleMarker)
}

/**
 * 計算人員即時狀態 (根據工單動態判斷)
 * 
 * 判斷優先級 (嚴格遵守)：
 * 1. 有 UNDER_MAINTENANCE → 維修中
 * 2. 無上者但有 ASSIGNED → 已指派  
 * 3. 其餘 → 閒置中
 * 
 * @param {number} staffId - 人員 ID
 * @param {Array} tickets - 所有工單列表 (maintenanceInformation)
 * @returns {Object} 狀態物件 { key, text, tagType, icon }
 */
export function computeStaffStatus(staffId, tickets) {
  // 篩選此人員的工單 (排除已完成的)
  const staffTickets = tickets.filter(
    (t) => t.assignedStaffId === staffId && !isCompletedStatus(t.issueStatus)
  )

  // 判斷 1: 有正在維修中的工單
  const hasUnderMaintenance = staffTickets.some((t) => t.issueStatus === 'UNDER_MAINTENANCE')
  if (hasUnderMaintenance) {
    return {
      key: 'UNDER_MAINTENANCE',
      text: '維修中',
      tagType: 'warning',
      icon: 'fas fa-wrench'
    }
  }

  // 判斷 2: 有已指派但尚未開始的工單
  const hasAssigned = staffTickets.some((t) => t.issueStatus === 'ASSIGNED')
  if (hasAssigned) {
    return {
      key: 'ASSIGNED',
      text: '已指派',
      tagType: 'primary',
      icon: 'fas fa-user-check'
    }
  }

  // 判斷 3: 閒置中 (無未完成工單)
  return {
    key: 'IDLE',
    text: '閒置中',
    tagType: 'success',
    icon: 'fas fa-mug-hot'
  }
}

/**
 * 計算人員任務統計 (區分維修/保養、未完成/已完成)
 * 
 * @param {number} staffId - 人員 ID
 * @param {Array} tickets - 所有工單列表
 * @returns {Object} 統計物件
 *   {
 *     repairCurrent: 維修中數量,
 *     maintainCurrent: 保養中數量,
 *     repairAssigned: 待修數量,
 *     maintainAssigned: 待保養數量,
 *     repairDone: 維修完成數量,
 *     maintainDone: 保養完成數量
 *   }
 */
export function computeStaffTaskStats(staffId, tickets) {
  const stats = {
    repairCurrent: 0,
    maintainCurrent: 0,
    repairAssigned: 0,
    maintainAssigned: 0,
    repairDone: 0,
    maintainDone: 0
  }

  // 篩選此人員的所有工單
  const staffTickets = tickets.filter((t) => t.assignedStaffId === staffId)

  staffTickets.forEach((t) => {
    const maintenance = isMaintenanceTask(t.issueType, t.issueDesc)
    const status = t.issueStatus
    const done = isCompletedStatus(status)
    const assigned = status === 'ASSIGNED'
    const inProgress = status === 'UNDER_MAINTENANCE'

    if (maintenance) {
      if (inProgress) stats.maintainCurrent++
      else if (assigned) stats.maintainAssigned++
      else if (done) stats.maintainDone++
    } else {
      if (inProgress) stats.repairCurrent++
      else if (assigned) stats.repairAssigned++
      else if (done) stats.repairDone++
    }
  })

  return stats
}

/**
 * 計算整體人員狀態統計 (用於統計卡)
 * 
 * @param {Array} staffList - 人員列表
 * @param {Array} tickets - 所有工單列表
 * @returns {Object} 統計物件
 *   {
 *     underMaintenance: 維修中人數,
 *     assigned: 已指派人數,
 *     idle: 閒置中人數
 *   }
 */
export function computeOverallStaffStats(staffList, tickets) {
  const stats = {
    underMaintenance: 0,
    assigned: 0,
    idle: 0
  }

  staffList.forEach((staff) => {
    const status = computeStaffStatus(staff.staffId, tickets)
    
    if (status.key === 'UNDER_MAINTENANCE') {
      stats.underMaintenance++
    } else if (status.key === 'ASSIGNED') {
      stats.assigned++
    } else {
      stats.idle++
    }
  })

  return stats
}
</file>

<file path="frontend/src/composables/maintenance/useTicketConfig.js">
/**
 * 工單配置 Composable
 * 統一管理工單的狀態、優先級等配置
 */

// ==================== 優先級配置 ====================
export const priorityConfig = {
  LOW: {
    color: '#909399',
    bgColor: '#f4f4f5',
    icon: '🔵',
    text: '低優先',
    desc: '可稍後處理',
    tagType: 'info',
  },
  NORMAL: {
    color: '#409eff',
    bgColor: '#ecf5ff',
    icon: '🟢',
    text: '普通',
    desc: '正常排程處理',
    tagType: '',
  },
  HIGH: {
    color: '#e6a23c',
    bgColor: '#fdf6ec',
    icon: '🟠',
    text: '高優先',
    desc: '優先安排處理',
    tagType: 'warning',
  },
  URGENT: {
    color: '#f56c6c',
    bgColor: '#fef0f0',
    icon: '🔴',
    text: '緊急',
    desc: '立即處理',
    tagType: 'danger',
  },
}

// ==================== 狀態配置 ====================
export const statusConfig = {
  REPORTED: {
    text: '已通報',
    icon: '📋',
    tagType: 'info',
    color: '#17a2b8',
  },
  ASSIGNED: {
    text: '已指派',
    icon: '👤',
    tagType: 'primary',
    color: '#007bff',
  },
  UNDER_MAINTENANCE: {
    text: '維修中',
    icon: '🔧',
    tagType: 'warning',
    color: '#ffc107',
  },
  RESOLVED: {
    text: '已完成',
    icon: '✅',
    tagType: 'success',
    color: '#28a745',
  },
  CANCELLED: {
    text: '已取消',
    icon: '❌',
    tagType: 'info',
    color: '#6c757d',
  },
}

// ==================== 問題類型選項 ====================
export const issueTypeOptions = [
  { value: '椅子損壞', icon: '🪑' },
  { value: '機台故障異常', icon: '🖥️' },
  { value: '保養', icon: '🔧' },
]

// ==================== 結案結果配置 ====================
export const resultConfig = {
  FIXED: {
    text: '已修復',
    icon: '✅',
    color: '#67c23a',
    desc: '問題已成功修復',
  },
  MAINTAINED: {
    text: '已保養',
    icon: '🔧',
    color: '#409eff',
    desc: '保養作業已完成',
  },

  UNFIXABLE: {
    text: '無法修復',
    icon: '❌',
    color: '#f56c6c',
    desc: '問題無法修復，需更換設備',
  },
  OTHER: {
    text: '其他',
    icon: '📋',
    color: '#e6a23c',
    desc: '其他情況',
  },
}

// ==================== 工具函數 ====================

/**
 * 取得優先級對應的 Tag 類型
 * @param {string} priority - 優先級代碼
 * @returns {string} Element Plus tag type
 */
export const getPriorityTag = (priority) => {
  return priorityConfig[priority]?.tagType || 'info'
}

/**
 * 取得狀態對應的 Tag 類型
 * @param {string} status - 狀態代碼
 * @returns {string} Element Plus tag type
 */
export const getStatusTag = (status) => {
  return statusConfig[status]?.tagType || ''
}

/**
 * 取得優先級文字
 * @param {string} priority - 優先級代碼
 * @returns {string} 優先級文字
 */
export const getPriorityText = (priority) => {
  return priorityConfig[priority]?.text || priority
}

/**
 * 取得狀態文字
 * @param {string} status - 狀態代碼
 * @returns {string} 狀態文字
 */
export const getStatusText = (status) => {
  return statusConfig[status]?.text || status
}

/**
 * 取得優先級圖示
 * @param {string} priority - 優先級代碼
 * @returns {string} emoji 圖示
 */
export const getPriorityIcon = (priority) => {
  return priorityConfig[priority]?.icon || '❓'
}

/**
 * 取得狀態圖示
 * @param {string} status - 狀態代碼
 * @returns {string} emoji 圖示
 */
export const getStatusIcon = (status) => {
  return statusConfig[status]?.icon || '❓'
}

/**
 * 取得結案結果文字
 * @param {string} resultType - 結案結果代碼
 * @returns {string} 結果文字 (找不到則回傳原始代碼)
 */
export const getResultText = (resultType) => {
  if (!resultType) return '-'
  return resultConfig[resultType]?.text || resultType
}

/**
 * 取得結案結果圖示
 * @param {string} resultType - 結案結果代碼
 * @returns {string} emoji 圖示
 */
export const getResultIcon = (resultType) => {
  return resultConfig[resultType]?.icon || '❓'
}

// ==================== Composable Hook ====================
export function useTicketConfig() {
  return {
    priorityConfig,
    statusConfig,
    resultConfig,
    issueTypeOptions,
    getPriorityTag,
    getStatusTag,
    getPriorityText,
    getStatusText,
    getPriorityIcon,
    getStatusIcon,
    getResultText,
    getResultIcon,
  }
}

export default useTicketConfig
</file>

<file path="frontend/src/layouts/AuthLayout.vue">
<script setup>
import { RouterView } from 'vue-router'

// 粒子特效設定
const particlesOptions = {
  fullScreen: { enable: false },
  background: {
    color: { value: 'transparent' },
  },
  particles: {
    color: { value: '#ffffff' },
    links: {
      enable: true,
      color: '#ffffff',
      distance: 150,
      opacity: 0.3,
      width: 1,
    },
    move: {
      enable: true,
      speed: 0.6,
      direction: 'none',
      random: true,
      straight: false,
      outMode: {
        default: 'bounce',
      },
    },
    number: {
      value: 60,
      density: {
        enable: true,
        area: 800,
      },
    },
    opacity: {
      value: 0.5,
    },
    shape: {
      type: 'circle',
    },
    size: {
      value: { min: 1, max: 3 },
    },
  },
  interactivity: {
    events: {
      onHover: {
        enable: true,
        mode: 'grab',
      },
      onClick: {
        enable: true,
        mode: 'push',
      },
    },
    modes: {
      grab: {
        distance: 140,
        links: {
          opacity: 0.8,
        },
      },
    },
  },
}
</script>

<template>
  <div class="auth-layout">
    <div class="auth-background"></div>

    <vue-particles id="tsparticles" :options="particlesOptions" class="particles-layer" />

    <div class="auth-container">
      <header class="auth-header animate-fade-down">
        <h1 class="logo-text">SeatRentSys</h1>
      </header>

      <main class="auth-content glass-card-wrapper animate-pop-in">
        <router-view v-slot="{ Component }">
          <transition name="fade-slide" mode="out-in">
            <component :is="Component" />
          </transition>
        </router-view>
      </main>

      <footer class="auth-footer">
        <p>&copy;</p>
      </footer>
    </div>
  </div>
</template>

<style scoped>
/* 版面容器*/
.auth-layout {
  position: relative;
  /* 修正：改用 min-height 並移除溢出隱藏/自動設定，讓外層自然捲動 */
  min-height: 100vh; 
  width: 100%;
  
  display: flex;
  justify-content: center;
  /* 修正：使用 flex-start 配合 padding，確保長表單頂部不被切掉 */
  align-items: flex-start; 
  
  /* 針對各種裝置的呼吸空間 */
  padding: 60px 15px; 
  font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  
  /* 確保背景層不會因為 padding 而跑位 */
  box-sizing: border-box;
}

/* ========== 背景圖設定區 ========== */
.auth-background {
  position: absolute;
  inset: 0;
  z-index: -2;
  background-image: url('@/assets/bg-login.jpg'); /* 載入照片的區塊 */
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;

  /* 疊加一層深色，讓文字更清楚 */
  background-color: rgba(15, 23, 42, 0.4);
  background-blend-mode: multiply;

  /* === 新增：模糊特效 === */
  /* blur(8px) 數值越大越模糊，您可以根據喜好調整 */
  filter: blur(8px);

  /* === 新增：放大背景 === */
  /* 因為模糊會導致邊緣內縮產生白邊，所以要稍微放大一點點來填補 */
  transform: scale(1.1);
}

/* 粒子層定位 */
.particles-layer {
  position: absolute;
  inset: 0;
  z-index: -1;
}

/* 內容容器*/
.auth-container {
  position: relative;
  z-index: 1;
  width: 100%;
  /* 修正：限制最大寬度，但在手機上自動撐滿 */
  max-width: 480px; 
  
  /* 關鍵：利用 margin 達成垂直與水平的靈活置中 */
  margin: auto; 

  display: flex;
  flex-direction: column;
  align-items: center;
  
  /* 確保在極端窄的螢幕下不會爆版 */
  word-wrap: break-word;
}

/* Header & Logo */
.auth-header {
  margin-bottom: 1rem; /* 減少間距 (原本2rem) */
  text-align: center;
  flex-shrink: 0; /* 防止 Logo 被壓扁 */
}

.logo-text {
  font-size: 2rem; /* 縮小 Logo 字體 (原本3rem)，節省空間 */
  font-weight: 800;
  color: #ffffff;
  letter-spacing: 1.5px;
  text-shadow:
    0 0 10px rgba(14, 165, 233, 0.6),
    0 0 20px rgba(14, 165, 233, 0.4);
  margin: 0;
}

/* ========== 重點修改：3D 立體卡片容器 ========== */
.glass-card-wrapper {
  width: 100%;
  background: rgba(255, 255, 255, 0.95);
  border-radius: 20px; /* 稍微調小圓角 */

  /* 【修復點 1】移除 padding，解決邊框折疊感 */
  padding: 0;

  /* 【修復點 2】加上 overflow: hidden，讓內部內容不會跑出圓角外 */
  overflow: hidden;

  box-shadow:
    0 20px 50px -12px rgba(0, 0, 0, 0.5),
    0 0 0 1px rgba(255, 255, 255, 0.2) inset;

  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);

  /* 讓卡片本身可以收縮，不要硬撐大 */
  display: flex;
  flex-direction: column;
}

/* Footer */
.auth-footer {
  margin-top: 1rem; /* 減少間距 (原本2rem) */
  font-size: 0.75rem; /* 字體縮小一點 */
  color: #cbd5e1;
  text-align: center;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
  flex-shrink: 0;
}

/* Vue Transition 動畫 */
.fade-slide-enter-active,
.fade-slide-leave-active {
  transition:
    opacity 0.3s ease,
    transform 0.3s ease;
}

.fade-slide-enter-from {
  opacity: 0;
  transform: translateY(10px);
}

.fade-slide-leave-to {
  opacity: 0;
  transform: translateY(-10px);
}

.animate-fade-down {
  animation: fadeDown 0.8s ease-out;
}

.animate-pop-in {
  animation: popIn 0.6s cubic-bezier(0.16, 1, 0.3, 1);
}

@keyframes fadeDown {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes popIn {
  from {
    opacity: 0;
    transform: scale(0.95) translateY(20px);
  }
  to {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}
</style>
</file>

<file path="frontend/src/stores/adminAuth.js">
import { defineStore } from 'pinia'

export const useAdminAuthStore = defineStore('adminAuth', {
  state: () => ({
    isLogin: false,
    admin: {
      username: '',
      name: '',
      role: null,
      admId: null,
      admUsername: '',
      admName: '',
      admEmail: '',
      admRole: null,
      createdAt: null
    },
  }),
  actions: {
    setAdmin(admin) {
      this.isLogin = true
      this.admin = admin
    },
    clearAdmin() {
      this.isLogin= false
      this.admin = {
        username: '',
        name: '',
        role: null,
        admId: null,
        admUsername: '',
        admName: '',
        admEmail: '',
        admRole: null,
        createdAt: null
      }
    },
  },
})
</file>

<file path="frontend/src/views/ecpay/PaymentView.vue">
<template>
  <div class="payment-container">
    <div class="payment-card">
      <h2>租借訂單結帳</h2>
      <hr />
      
      <div class="order-info">
        <div class="info-item">
          <span>訂單編號：</span>
          <strong>{{ recId }}</strong>
        </div>
        <div class="info-item">
          <span>服務項目：</span>
          <strong>機台/座位租借</strong>
        </div>
        <p class="warning-text">※ 請確認金額後再前往付款</p>
      </div>

      <div class="payment-methods">
        <p>支付平台：</p>
        <label class="method-option">
          <input type="radio" checked /> 
          <span class="radio-label">綠界科技 ECPay 安全支付</span>
        </label>
      </div>

      <button 
        @click="handleCheckout" 
        :disabled="isLoading" 
        class="checkout-btn"
      >
        <span v-if="isLoading" class="loader"></span>
        {{ isLoading ? '導向支付頁面中...' : '前往付款' }}
      </button>

      <p class="note">※ 點擊按鈕後將離開本站，導向至綠界金流加密頁面</p>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import { useRoute } from 'vue-router';
import axios from 'axios';
import Swal from 'sweetalert2';

const route = useRoute();
const isLoading = ref(false);
const recId = ref('');

onMounted(() => {
  recId.value = route.params.recId;
  if (!recId.value) {
    Swal.fire('錯誤', '無效的訂單編號', 'error');
  }
});

const handleCheckout = async () => {
  if (!recId.value) return;

  isLoading.value = true;
  try {
    // 1. 呼叫後端 API
    const response = await axios.post(`http://localhost:8080/api/payment/checkout?recId=${recId.value}`);
    
    // 2. 處理回應
    const payHtml = response.data;
    if (!payHtml || (typeof payHtml === 'string' && payHtml.includes('Error'))) {
      throw new Error('訂單資訊有誤，無法付款');
    }

    // 💡 修正點 A：先移除 HTML 裡的 <script> 標籤，避免塞入 DOM 時觸發 CSP 報錯
    const cleanHtml = payHtml.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, "");

    // 3. 建立一個臨時容器並插入純表單 HTML
    const div = document.createElement('div');
    div.style.display = 'none'; 
    div.innerHTML = cleanHtml; 
    document.body.appendChild(div);

    // 💡 修正點 B：直接抓取 form 並提交
    const form = div.querySelector('form');
    if (form) {
      console.log("表單準備就緒，執行提交...");
      form.submit();
    } else {
      throw new Error('找不到支付表單，請稍後再試');
    }

  } catch (error) {
    console.error('付款啟動失敗', error);
    Swal.fire({
      icon: 'error',
      title: '啟動支付失敗',
      text: error.message || '請檢查網路連線或聯絡客服。',
    });
  }
};
</script>

<style scoped>
.payment-container {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 85vh;
  background-color: #f0f2f5;
}
.payment-card {
  background: white;
  padding: 2.5rem;
  border-radius: 16px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.08);
  width: 100%;
  max-width: 420px;
}
.warning-text {
  font-size: 0.85rem;
  color: #856404;
  background-color: #fff3cd;
  padding: 8px;
  border-radius: 4px;
  margin-top: 10px;
}
.order-info {
  margin: 2rem 0;
}
.info-item {
  display: flex;
  justify-content: space-between;
  margin-bottom: 1rem;
}
.checkout-btn {
  width: 100%;
  padding: 1.2rem;
  background-color: #2a9d8f;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 1.2rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 10px;
}
.checkout-btn:hover {
  background-color: #21867a;
  transform: translateY(-2px);
}
.checkout-btn:disabled {
  background-color: #a8dadc;
  cursor: not-allowed;
}
.loader {
  border: 3px solid #f3f3f3;
  border-top: 3px solid #1d3557;
  border-radius: 50%;
  width: 18px;
  height: 18px;
  animation: spin 1s linear infinite;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
.note {
  font-size: 0.8rem;
  color: #666;
  text-align: center;
  margin-top: 1rem;
}
</style>
</file>

<file path="frontend/src/views/game/SnakeGame.vue">
<template>
  <div class="snake-page">
    <div class="game-container">
      <!-- Header -->
      <div class="page-header">
        <router-link to="/mall" class="back-link">
          <i class="bi bi-arrow-left"></i>
          返回商城
        </router-link>

        <h1 class="page-title">
          <i class="bi bi-controller"></i>
          蛇蛇賺點數
        </h1>
            <span class="badge bg-warning text-dark px-3 py-2">
              <template v-if="memberId">
                <i class="bi bi-person-fill me-1"></i>{{ memName }} 
                <span class="mx-2 opacity-50">|</span>
                <i class="bi bi-coin me-1"></i>{{ currentPoints }} Pts
                <span class="mx-2 opacity-50">|</span>
                ID: {{ memberId }}
              </template>
              <template v-else>
                <router-link to="/login" class="text-dark text-decoration-none">⚠️ 未登入 (點我登入)</router-link>
              </template>
            </span>
      </div>

      <!-- KPI -->
      <div class="kpi-section">
        <div class="kpi-tile">
          <div class="kpi-label">目前得分</div>
          <!-- UI ONLY: displayScore 用於平滑遞增顯示 -->
          <div class="kpi-value">{{ displayScore }}</div>
        </div>

        <div class="kpi-tile" :class="{ redeemable: pointsEarned > 0 }">
          <div class="kpi-label">可換點數</div>
          <div class="kpi-value points">{{ pointsEarned }}</div>
          <div v-if="pointsEarned > 0" class="kpi-hint">
            <i class="bi bi-check-circle"></i>
            可立即兌換
          </div>
        </div>
      </div>

      <!-- Daily Play Limit Hint -->
      <div class="limit-hint" v-if="remainingPlays !== null">
        今日剩餘遊玩次數：<strong>{{ remainingPlays }}</strong> / {{ maxDailyPlays }}
      </div>

      <!-- Canvas -->
      <div class="canvas-section">
        <div class="canvas-wrapper" :class="{ playing: isGameRunning, shake: isShaking }">
          <canvas ref="gameCanvas" width="400" height="400"></canvas>

          <!-- Start Overlay -->
          <transition name="overlay-fade">
            <div v-if="!isGameRunning && !gameOver" class="game-overlay">
              <div class="overlay-card">
                <div class="overlay-icon">
                  <i class="bi bi-joystick"></i>
                </div>
                <div class="overlay-title">準備好了嗎？</div>
                <div class="overlay-desc">使用方向鍵控制蛇蛇移動</div>

                <button class="btn-primary" @click="startGame">
                  <i class="bi bi-play-fill"></i>
                  開始遊戲
                </button>
              </div>
            </div>
          </transition>

          <!-- Result Overlay -->
          <transition name="overlay-fade">
            <div v-if="gameOver" class="game-overlay">
              <div class="overlay-card">
                <div class="overlay-icon warn">
                  <i class="bi bi-flag-fill"></i>
                </div>
                <div class="overlay-title">遊戲結束</div>

                <div class="result-grid">
                  <div class="result-item">
                    <div class="result-label">本次得分</div>
                    <div class="result-value">{{ score }}</div>
                  </div>
                  <div class="divider"></div>
                  <div class="result-item">
                    <div class="result-label">可換點數</div>
                    <div class="result-value highlight">{{ pointsEarned }}</div>
                  </div>
                </div>

                <div v-if="!memberId" class="login-prompt">
                  <i class="bi bi-info-circle"></i>
                  登入後可兌換點數
                </div>

                <div class="actions">
                  <button
                    class="btn-warning"
                    @click="uploadScore"
                    :disabled="isUploaded || pointsEarned < 1 || isRedeeming"
                  >
                    <template v-if="isRedeeming">
                      <span class="spinner"></span>
                      兌換中…
                    </template>
                    <template v-else-if="isUploaded">
                      <i class="bi bi-check-circle"></i>
                      已入帳
                    </template>
                    <template v-else-if="pointsEarned < 1">
                      <i class="bi bi-x-circle"></i>
                      分數不足
                    </template>
                    <template v-else>
                      <i class="bi bi-gift"></i>
                      領取 {{ pointsEarned }} 點
                    </template>
                  </button>

                  <button class="btn-ghost" @click="startGame">
                    <i class="bi bi-arrow-clockwise"></i>
                    再玩一次
                  </button>
                </div>

                <div class="limit-hint overlay-limit" v-if="remainingPlays !== null">
                  今日剩餘遊玩次數：<strong>{{ remainingPlays }}</strong> / {{ maxDailyPlays }}
                </div>
              </div>
            </div>
          </transition>
        </div>
      </div>

      <!-- Rules -->
      <div class="rules-section">
        <div class="rules-title">
          <i class="bi bi-info-circle"></i>
          遊戲說明
        </div>
        <ul class="rules-list">
          <li>方向鍵控制移動，撞牆或撞到自己即結束。</li>
          <li>吃到食物獲得 200 分，蛇身變長。</li>
          <li>每累積 <strong>100 分</strong> 可兌換 <strong>1 點(上限50點)</strong>（無條件捨去）。</li>
          <li>領取點數前請先登入會員帳號。</li>
          <li>
            每日遊玩次數上限：<strong>{{ maxDailyPlays }}</strong> 次（超過需隔天再來）。
          </li>
        </ul>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, watch, onMounted, onUnmounted } from 'vue'
import { useRouter } from 'vue-router'
import axios from 'axios'
import Swal from 'sweetalert2'
import { useMemberAuthStore } from '@/stores/memberAuth'; 

const router = useRouter();
const memberAuthStore = useMemberAuthStore();

const memberId = computed(() => memberAuthStore.member?.memId);
const memName = computed(() => memberAuthStore.member?.memName || '訪客');
const currentPoints = computed(() => memberAuthStore.member?.memPoints || 0);

// =============================
// 每日遊玩次數限制（整合自組員邏輯，但不破壞你原本流程）
// =============================
const maxDailyPlays = 10 // 你可自行調整
const remainingPlays = ref(null)

const getTodayKey = () => {
  // 使用本機 locale 的日期字串即可（同一天判斷一致即可）
  return new Date().toLocaleDateString()
}

const readPlayRecord = () => {
  try {
    return JSON.parse(localStorage.getItem('snake_game_record') || '{}')
  } catch {
    return {}
  }
}

const writePlayRecord = (record) => {
  localStorage.setItem('snake_game_record', JSON.stringify(record))
}

const refreshPlayLimit = () => {
  const today = getTodayKey()
  const record = readPlayRecord()

  // 若不是今天，重置
  if (record.date !== today) {
    const newRecord = { date: today, count: 0 }
    writePlayRecord(newRecord)
    remainingPlays.value = maxDailyPlays
    return { ok: true, record: newRecord }
  }

  // 是今天
  const count = Number.isFinite(record.count) ? record.count : 0
  remainingPlays.value = Math.max(0, maxDailyPlays - count)
  return { ok: count < maxDailyPlays, record: { date: today, count } }
}

const consumeOnePlay = () => {
  const { ok, record } = refreshPlayLimit()
  if (!ok) return false

  const next = { ...record, count: (record.count || 0) + 1 }
  writePlayRecord(next)
  remainingPlays.value = Math.max(0, maxDailyPlays - next.count)
  return true
}

// ===== 核心遊戲狀態（維持原規則） =====
const gameCanvas = ref(null)
const score = ref(0)
const gameSpeed = ref(150)
const isGameRunning = ref(false)
const gameOver = ref(false)
const isUploaded = ref(false)



// ===== UI ONLY（不影響核心規則） =====
const displayScore = ref(0) // UI ONLY: 分數平滑顯示
const isRedeeming = ref(false) // UI ONLY: 兌點 loading
const isShaking = ref(false) // UI ONLY: Game Over shake
let foodPulse = 0 // CANVAS VISUAL ONLY: 食物呼吸

const pointsEarned = computed(() => Math.floor(score.value / 100))

watch(score, (newScore) => {
  // UI ONLY: 如果分數被重置（例如重新開始），同步顯示
  if (newScore <= displayScore.value) {
    displayScore.value = newScore
    return
  }
  const start = displayScore.value
  const delta = newScore - start
  const steps = 10
  let n = 0
  const tick = () => {
    n += 1
    displayScore.value = Math.round(start + (delta * n) / steps)
    if (n < steps) requestAnimationFrame(tick)
  }
  requestAnimationFrame(tick)
})

// ===== 遊戲邏輯變數（核心） =====
let ctx = null
let snake = []
let food = { x: 5, y: 5 }
let direction = { x: 1, y: 0 }
let nextDirection = { x: 1, y: 0 }
const gridSize = 20

const checkLoginStatus = () => {
  memberId.value = localStorage.getItem('memberId') || localStorage.getItem('memId')
}

// 內部：真正啟動遊戲（保持你原本遊戲初始化與流程不變）
const startGameCore = () => {
  score.value = 0
  displayScore.value = 0 // UI ONLY
  gameSpeed.value = 150
  direction = { x: 1, y: 0 }
  nextDirection = { x: 1, y: 0 }
  snake = [
    { x: 10, y: 10 },
    { x: 9, y: 10 },
    { x: 8, y: 10 },
  ]
  gameOver.value = false
  isUploaded.value = false
  isShaking.value = false // UI ONLY
  isGameRunning.value = true
  spawnFood()
  gameLoop()
}

// 外部：你畫面所有按鈕呼叫的 startGame（加入每日次數限制，但不破壞你的 UX/UI 流程）
const startGame = async () => {
  // 若正在遊戲中，不做任何事（避免重複扣次數/重啟）
  if (isGameRunning.value) return

  // 先刷新顯示（確保 UI 顯示正確）
  const { ok } = refreshPlayLimit()
  if (!ok) {
    await Swal.fire({
      icon: 'error',
      title: '今日次數已用盡',
      text: `今天已經玩滿 ${maxDailyPlays} 次囉，請明天再來！`,
      confirmButtonText: '回商城逛逛',
    })
    router.push('/mall')
    return
  }

  // 扣一次
  const consumed = consumeOnePlay()
  if (!consumed) {
    await Swal.fire({
      icon: 'error',
      title: '今日次數已用盡',
      text: `今天已經玩滿 ${maxDailyPlays} 次囉，請明天再來！`,
      confirmButtonText: '回商城逛逛',
    })
    router.push('/mall')
    return
  }

  startGameCore()
}

const gameLoop = () => {
  if (!isGameRunning.value) return
  setTimeout(() => {
    update()
    draw()
    gameLoop()
  }, gameSpeed.value)
}

const update = () => {
  direction = nextDirection
  const head = { x: snake[0].x + direction.x, y: snake[0].y + direction.y }

  // 碰撞偵測（核心規則不變）
  if (
    head.x < 0 ||
    head.x >= 20 ||
    head.y < 0 ||
    head.y >= 20 ||
    snake.some((s) => s.x === head.x && s.y === head.y)
  ) {
    isGameRunning.value = false
    gameOver.value = true

    // UI ONLY: 輕微震動回饋
    isShaking.value = true
    setTimeout(() => (isShaking.value = false), 350)
    return
  }

  snake.unshift(head)

  if (head.x === food.x && head.y === food.y) {
    score.value += 200
    // 每 100 分加速一次（核心規則不變）
    if (score.value % 100 === 0 && gameSpeed.value > 60) gameSpeed.value -= 15
    spawnFood()
  } else {
    snake.pop()
  }
}

const draw = () => {
  if (!ctx) return

  // CANVAS VISUAL ONLY: 背景（柔和深色）
  const bg = ctx.createLinearGradient(0, 0, 0, 400)
  bg.addColorStop(0, '#24313c')
  bg.addColorStop(1, '#171f27')
  ctx.fillStyle = bg
  ctx.fillRect(0, 0, 400, 400)

  // CANVAS VISUAL ONLY: 淡格線
  ctx.strokeStyle = 'rgba(255,255,255,0.06)'
  ctx.lineWidth = 1
  for (let i = 0; i <= 20; i++) {
    ctx.beginPath()
    ctx.moveTo(i * gridSize, 0)
    ctx.lineTo(i * gridSize, 400)
    ctx.stroke()

    ctx.beginPath()
    ctx.moveTo(0, i * gridSize)
    ctx.lineTo(400, i * gridSize)
    ctx.stroke()
  }

  // CANVAS VISUAL ONLY: 食物呼吸 + 光暈
  foodPulse += 0.12
  const pulse = 8 + Math.sin(foodPulse) * 1.2

  const fx = food.x * gridSize + 10
  const fy = food.y * gridSize + 10
  const glow = ctx.createRadialGradient(fx, fy, 0, fx, fy, pulse + 6)
  glow.addColorStop(0, 'rgba(230,162,60,0.9)')
  glow.addColorStop(1, 'rgba(230,162,60,0)')
  ctx.fillStyle = glow
  ctx.beginPath()
  ctx.arc(fx, fy, pulse + 6, 0, Math.PI * 2)
  ctx.fill()

  ctx.fillStyle = '#e6a23c'
  ctx.beginPath()
  ctx.arc(fx, fy, pulse, 0, Math.PI * 2)
  ctx.fill()

  // CANVAS VISUAL ONLY: 蛇（頭部更亮 + 小眼睛）
  snake.forEach((p, i) => {
    const x = p.x * gridSize
    const y = p.y * gridSize

    if (i === 0) {
      ctx.fillStyle = '#f5f7fa'
      ctx.fillRect(x + 1, y + 1, gridSize - 2, gridSize - 2)

      // 眼睛（簡單辨識）
      ctx.fillStyle = 'rgba(30,30,30,0.7)'
      ctx.beginPath()
      ctx.arc(x + 7, y + 8, 1.6, 0, Math.PI * 2)
      ctx.arc(x + 13, y + 8, 1.6, 0, Math.PI * 2)
      ctx.fill()
    } else {
      ctx.fillStyle = '#67c23a'
      ctx.fillRect(x + 2, y + 2, gridSize - 4, gridSize - 4)
    }
  })
}

const spawnFood = () => {
  food = { x: Math.floor(Math.random() * 20), y: Math.floor(Math.random() * 20) }
  if (snake.some((s) => s.x === food.x && s.y === food.y)) spawnFood()
}

const handleKeyDown = (e) => {
  const key = e.key
  if (key === 'ArrowUp' && direction.y === 0) nextDirection = { x: 0, y: -1 }
  if (key === 'ArrowDown' && direction.y === 0) nextDirection = { x: 0, y: 1 }
  if (key === 'ArrowLeft' && direction.x === 0) nextDirection = { x: -1, y: 0 }
  if (key === 'ArrowRight' && direction.x === 0) nextDirection = { x: 1, y: 0 }
}

const uploadScore = async () => {
  checkLoginStatus();

  if (!memberId.value) {
    // 儲存目前分數到 Session，登入後可恢復
    sessionStorage.setItem('pendingSnakeScore', score.value);
    
    const result = await Swal.fire({
      title: '請先登入',
      text: `您獲得了 ${score.value} 分，登入後即可換取點數！`,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: '去登入',
      cancelButtonText: '下次再說'
    });

    if (result.isConfirmed) {
      router.push({ path: '/login', query: { redirect: '/snake' } });
    }
    return;
  }

  const points = Math.floor(score.value / 100);
  
  try {
    const res = await axios.post('http://localhost:8080/api/game/add-points', {
      memberId: memberId.value,
      points: points
    });

    isUploaded.value = true;
    sessionStorage.removeItem('pendingSnakeScore');

    
    await Swal.fire({
      title: '兌換成功！',
      text: `已入帳 ${res.data.addPoints} 點，目前帳戶總點數：${res.data.currentPoints}`,  
      icon: 'success'
    });

    // ✅ 自動刷新全站點數
    if (typeof memberAuthStore.refreshPoints === 'function') {
      await memberAuthStore.refreshPoints();
    }
  } catch (err) {
    console.error("上傳失敗", err);
    Swal.fire('系統錯誤', '無法連接到伺服器，請稍後再試', 'error');
   
  }
};

onMounted(() => {
  ctx = gameCanvas.value?.getContext('2d')
  window.addEventListener('keydown', handleKeyDown)

  // 會員狀態（保留你原本邏輯）
  checkLoginStatus()

  // 每日次數顯示初始化
  refreshPlayLimit()

  // 登入後回來可承接暫存分數（核心行為不變）
  const savedScore = sessionStorage.getItem('pendingSnakeScore')
  if (savedScore && memberId.value) {
    score.value = parseInt(savedScore, 10)
    displayScore.value = score.value // UI ONLY
    gameOver.value = true
    isGameRunning.value = false
    Swal.fire({
      title: '歡迎回來',
      text: `已偵測到您剛才獲得的 ${score.value} 分，快領取點數吧！`,
      icon: 'info',
      confirmButtonText: '確定',
    })
  }

  draw()
})

onUnmounted(() => {
  window.removeEventListener('keydown', handleKeyDown)
})
</script>

<style scoped>
/* 基底：不花俏的商城風格 + 遊戲區淡霓虹 */
.snake-page {
  --bg1: #f3f6fb;
  --bg2: #e9eef6;
  --text: #303133;
  --muted: #606266;
  --border: #dcdfe6;
  --primary: #409eff;
  --success: #67c23a;
  --warning: #e6a23c;

  min-height: 100vh;
  background: linear-gradient(180deg, var(--bg1) 0%, var(--bg2) 100%);
  padding: 20px 14px;
  color: var(--text);
}

.game-container {
  max-width: 640px;
  margin: 0 auto;
}

/* Header */
.page-header {
  background: #fff;
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 14px 16px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  align-items: center;
  gap: 10px;
  margin-bottom: 14px;
}

.back-link {
  text-decoration: none;
  color: var(--muted);
  font-size: 13px;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}
.back-link:hover {
  color: var(--primary);
}

.page-title {
  margin: 0;
  font-size: 18px;
  font-weight: 700;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}
.page-title i {
  color: var(--primary);
}

.login-status {
  justify-self: end;
}

.status-badge {
  border-radius: 999px;
  padding: 6px 12px;
  font-size: 13px;
  font-weight: 600;
  text-decoration: none;
  display: inline-flex;
  gap: 6px;
  align-items: center;
  border: 1px solid var(--border);
}
.status-badge.logged-in {
  background: #f0f9eb;
  color: var(--success);
  border-color: rgba(103, 194, 58, 0.35);
}
.status-badge.not-logged {
  background: #fef0f0;
  color: #f56c6c;
  border-color: rgba(245, 108, 108, 0.35);
}
.status-badge.not-logged:hover {
  background: #f56c6c;
  color: #fff;
}

/* KPI */
.kpi-section {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 10px;
}

.kpi-tile {
  background: #fff;
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 14px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
  text-align: center;
}

.kpi-label {
  font-size: 12px;
  color: #909399;
  margin-bottom: 6px;
  font-weight: 600;
}

.kpi-value {
  font-size: 28px;
  font-weight: 800;
  line-height: 1.1;
}

.kpi-value.points {
  color: var(--success);
}

.kpi-tile.redeemable {
  border-color: rgba(103, 194, 58, 0.55);
  box-shadow:
    0 2px 10px rgba(0, 0, 0, 0.04),
    0 0 18px rgba(103, 194, 58, 0.12);
}

.kpi-hint {
  margin-top: 8px;
  font-size: 12px;
  color: var(--success);
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

/* Daily Limit Hint */
.limit-hint {
  margin: 0 2px 12px;
  font-size: 13px;
  color: var(--muted);
}
.overlay-limit {
  margin-top: 10px;
  color: rgba(255, 255, 255, 0.82);
}

/* Canvas */
.canvas-section {
  margin-bottom: 14px;
}

.canvas-wrapper {
  position: relative;
  width: fit-content;
  margin: 0 auto;
  border-radius: 14px;
  overflow: hidden;
  border: 2px solid var(--border);
  box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
  transition:
    border-color 180ms ease,
    box-shadow 180ms ease;
}

.canvas-wrapper.playing {
  border-color: rgba(64, 158, 255, 0.55);
  box-shadow:
    0 6px 18px rgba(0, 0, 0, 0.08),
    0 0 18px rgba(64, 158, 255, 0.12);
}

.canvas-wrapper.shake {
  animation: shake 0.35s;
}

@keyframes shake {
  0%,
  100% {
    transform: translateX(0);
  }
  20% {
    transform: translateX(-4px);
  }
  40% {
    transform: translateX(4px);
  }
  60% {
    transform: translateX(-3px);
  }
  80% {
    transform: translateX(3px);
  }
}

canvas {
  display: block;
}

/* Overlay */
.game-overlay {
  position: absolute;
  inset: 0;
  background: rgba(15, 20, 26, 0.82);
  backdrop-filter: blur(4px);
  display: grid;
  place-items: center;
  padding: 16px;
}

.overlay-card {
  width: min(420px, 92%);
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.16);
  border-radius: 14px;
  padding: 18px 16px;
  text-align: center;
}

.overlay-icon {
  font-size: 40px;
  color: rgba(255, 255, 255, 0.9);
  margin-bottom: 8px;
}
.overlay-icon.warn {
  color: rgba(230, 162, 60, 0.95);
}

.overlay-title {
  font-size: 18px;
  font-weight: 800;
  color: #fff;
  margin-bottom: 6px;
}
.overlay-desc {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.78);
  margin-bottom: 14px;
}

.result-grid {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  align-items: center;
  gap: 12px;
  margin: 12px 0 14px;
  padding: 12px;
  border-radius: 12px;
  background: rgba(255, 255, 255, 0.06);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.result-label {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.72);
  margin-bottom: 6px;
}
.result-value {
  font-size: 26px;
  font-weight: 900;
  color: #fff;
}
.result-value.highlight {
  color: var(--warning);
}

.divider {
  width: 1px;
  height: 46px;
  background: rgba(255, 255, 255, 0.16);
}

.login-prompt {
  display: inline-flex;
  gap: 8px;
  align-items: center;
  justify-content: center;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid rgba(230, 162, 60, 0.45);
  background: rgba(230, 162, 60, 0.14);
  color: rgba(230, 162, 60, 0.95);
  font-size: 13px;
  margin-bottom: 12px;
}

.actions {
  display: grid;
  gap: 10px;
}

/* Buttons */
.btn-primary,
.btn-warning,
.btn-ghost {
  border: none;
  border-radius: 12px;
  padding: 12px 14px;
  font-weight: 800;
  cursor: pointer;
  display: inline-flex;
  gap: 8px;
  align-items: center;
  justify-content: center;
  transition:
    transform 120ms ease,
    filter 120ms ease,
    opacity 120ms ease;
}

.btn-primary {
  background: var(--success);
  color: #fff;
}
.btn-primary:hover {
  filter: brightness(1.03);
  transform: translateY(-1px);
}

.btn-warning {
  background: var(--warning);
  color: #fff;
}
.btn-warning:disabled {
  opacity: 0.65;
  cursor: not-allowed;
  transform: none;
}

.btn-ghost {
  background: transparent;
  color: rgba(255, 255, 255, 0.88);
  border: 1px solid rgba(255, 255, 255, 0.28);
}
.btn-ghost:hover {
  background: rgba(255, 255, 255, 0.08);
}

.spinner {
  width: 14px;
  height: 14px;
  border-radius: 50%;
  border: 2px solid rgba(255, 255, 255, 0.35);
  border-top-color: rgba(255, 255, 255, 0.95);
  animation: spin 0.7s linear infinite;
}
@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

.overlay-fade-enter-active,
.overlay-fade-leave-active {
  transition:
    opacity 200ms ease,
    transform 200ms ease;
}
.overlay-fade-enter-from,
.overlay-fade-leave-to {
  opacity: 0;
  transform: scale(0.98);
}

/* Rules */
.rules-section {
  background: #fff;
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 14px 16px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
}

.rules-title {
  font-weight: 800;
  display: inline-flex;
  gap: 8px;
  align-items: center;
  margin-bottom: 10px;
}

.rules-title i {
  color: var(--primary);
}

.rules-list {
  margin: 0;
  padding-left: 18px;
  color: var(--muted);
  font-size: 13px;
  display: grid;
  gap: 8px;
}

@media (max-width: 520px) {
  .page-header {
    grid-template-columns: 1fr;
    text-align: center;
  }
  .login-status {
    justify-self: center;
  }
  .kpi-section {
    grid-template-columns: 1fr;
  }
}
</style>
</file>

<file path="frontend/src/views/maintenance/MaintenanceStaffHistory.vue">
<script setup>
import { ref, onMounted, computed, watch } from 'vue'
import maintenanceApi from '@/api/modules/maintenance'
import Swal from 'sweetalert2'
import { useRouter } from 'vue-router'
import { usePagination } from '@/composables/maintenance/usePagination'

const router = useRouter()
const staffList = ref([])
const searchText = ref('')
const loading = ref(false)
const pageVisible = ref(false)

// 新增：日期格式化小工具
const formatDate = (dateVal, row = {}) => {
  // 優先順序：傳入的值 > updateTime > updated_at > createTime > createdAt
  // 這裡假設如果沒有更新時間，可能要看建立時間 (例如這筆歷史資料的建立時間)
  const targetDate =
    dateVal || row.updatedAt || row.updateTime || row.updated_at || row.createTime || row.createdAt

  if (!targetDate) return '-'

  const date = new Date(targetDate)
  // 檢查是否為有效日期
  if (isNaN(date.getTime())) return '-'

  return date.toLocaleDateString('zh-TW', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
  })
}

// 專門從備註裡抓出 [停用日期：...] 的工具
const extractDateFromNote = (noteStr) => {
  if (!noteStr) return '-'

  // 使用正則表達式抓取 [停用日期：xxxx/xx/xx]
  const match = noteStr.match(/\[停用日期：(.*?)\]/)

  if (match && match[1]) {
    return match[1] // 回傳抓到的日期，例如 "2026/01/29"
  }

  return '-' // 沒抓到就顯示槓槓
}

// ✅ [新增] 解析備註中的歷史紀錄 (將備註字串轉為時間軸陣列)
const parseHistoryFromNote = (note) => {
  if (!note) return []

  const history = []

  // 使用正則表達式抓取所有中括號內的內容，例如 [停用日期：2026/01/29]
  // flag 'g' 代表抓取全部，不只抓第一個
  const regex = /\[(.*?)\]/g
  let match

  // 迴圈找出所有的標籤
  while ((match = regex.exec(note)) !== null) {
    const content = match[1] // 取得括號內的文字

    // 預設樣式 (灰色)
    let color = '#909399'
    let iconColor = '#fff'
    let borderColor = '#909399'

    // 根據關鍵字決定顏色
    if (content.includes('停用')) {
      color = '#f56c6c' // 紅色文字
      borderColor = '#f56c6c' // 紅色圓點
    } else if (content.includes('復職')) {
      color = '#67c23a' // 綠色文字
      borderColor = '#67c23a' // 綠色圓點
    }

    history.push({
      content: content,
      color: color,
      borderColor: borderColor,
    })
  }

  // 如果希望最新的紀錄顯示在最上面，可以使用 history.reverse()
  return history
}

// 取得已停用 (Inactive) 的資料
const fetchHistory = async () => {
  try {
    loading.value = true
    const res = await maintenanceApi.getInactiveStaff()
    console.log('API回傳的第一筆資料:', res.data[0])
    staffList.value = res.data
  } catch {
    // 錯誤已由 http.js 攔截器處理
  } finally {
    loading.value = false
  }
}

// 前端搜尋
const filteredList = computed(() => {
  const key = searchText.value.trim().toLowerCase()
  if (!key) return staffList.value
  return staffList.value.filter(
    (s) =>
      (s.staffName || '').toLowerCase().includes(key) ||
      (s.staffCompany || '').toLowerCase().includes(key),
  )
})

// 使用 usePagination composable
const {
  currentPage,
  pageSize,
  paginatedList,
  total: paginationTotal,
  showPagination,
  resetPagination,
} = usePagination(filteredList, { defaultPageSize: 10 })

// 搜尋時重置分頁
watch(searchText, () => {
  resetPagination()
})

// 查看詳情彈窗
// ✅ [修改] 查看詳情彈窗 (包含時間軸顯示)
const viewDetail = (row) => {
  // 1. 先抓出備註原始字串
  const noteStr = row.staffNote || ''

  // 2. 利用剛剛寫的工具，解析出歷史紀錄陣列
  const historyList = parseHistoryFromNote(noteStr)

  // 3. 準備原始備註 (移除掉所有 [xxx] 標籤，只留純文字備註)
  // replace 語法會把所有中括號標籤都洗掉
  const originalNote = noteStr.replace(/\[.*?\]/g, '').trim() || '無其他詳細備註'

  // 4. 建構時間軸的 HTML (因為 Swal 只能吃 HTML 字串)
  let timelineHtml = ''

  if (historyList.length > 0) {
    // 如果有紀錄，開始組裝 HTML
    timelineHtml = '<div style="text-align: left; padding: 0 10px; margin-bottom: 20px;">'
    timelineHtml +=
      '<p style="font-size: 13px; color: #606266; font-weight: bold; margin-bottom: 12px;"><i class="fas fa-stream mr-1"></i> 異動歷程</p>'
    timelineHtml +=
      '<ul style="list-style: none; padding: 0; margin: 0; border-left: 2px solid #e4e7ed; margin-left: 8px;">'

    historyList.forEach((item) => {
      timelineHtml += `
        <li style="margin-bottom: 20px; padding-left: 24px; position: relative;">
          <div style="position: absolute; left: -7px; top: 2px; width: 12px; height: 12px; border-radius: 50%; background: #fff; border: 3px solid ${item.borderColor};"></div>
          <div style="font-size: 14px; color: #303133; font-weight: 500;">
            <span style="color: ${item.color}">${item.content}</span>
          </div>
        </li>
      `
    })

    timelineHtml += '</ul></div>'
  } else {
    // 如果沒有紀錄
    timelineHtml = `
      <div style="margin-bottom: 20px; padding: 12px; background: #f4f4f5; border-radius: 8px; color: #909399; font-size: 13px; border: 1px dashed #dcdfe6; text-align: center;">
        <i class="fas fa-info-circle mr-1"></i> 尚無異動紀錄
      </div>
    `
  }

  // 5. 顯示彈窗
  Swal.fire({
    // 標題區：姓名 + 公司
    title: `<div style="display:flex; flex-direction:column; align-items:center; padding-bottom: 10px; border-bottom: 1px solid #ebeef5;">
              <span style="font-size: 1.6rem; color: #303133;">${row.staffName}</span>
              <span style="font-size: 0.9rem; color: #909399; font-weight: normal; margin-top: 6px;">
                <i class="fas fa-building mr-1"></i>${row.staffCompany || '無公司資訊'}
              </span>
            </div>`,
    html: `
      <div style="text-align: left; padding: 15px 5px 0;">
        
        ${timelineHtml}

        <div style="margin-bottom: 16px;">
           <p style="margin: 0 0 8px 0; color: #606266; font-size: 13px; font-weight: bold;">基本資料</p>
           <div style="padding: 12px; background: #f5f7fa; border-radius: 8px;">
            <p style="margin: 6px 0; font-size: 14px; color: #606266;">
              <i class="fas fa-phone mr-2 text-success" style="width:20px; text-align:center;"></i>
              ${row.staffPhone || '未填寫'}
            </p>
            <p style="margin: 6px 0; font-size: 14px; color: #606266;">
              <i class="fas fa-envelope mr-2 text-warning" style="width:20px; text-align:center;"></i>
              ${row.staffEmail || '未填寫'}
            </p>
          </div>
        </div>

        <div>
          <p style="margin: 0 0 8px 0; color: #606266; font-size: 13px; font-weight: bold;">
            <i class="fas fa-sticky-note mr-1"></i> 其他備註
          </p>
          <div style="padding: 12px; background: #fff; border: 1px solid #dcdfe6; border-radius: 8px; color: #606266; font-size: 14px; line-height: 1.6; white-space: pre-line;">
            ${originalNote}
          </div>
        </div>

      </div>
    `,
    confirmButtonText: '關閉',
    confirmButtonColor: '#909399',
    width: 480, // 稍微加寬一點讓時間軸好看
    showClass: { popup: 'animate__animated animate__fadeInDown animate__faster' },
    hideClass: { popup: 'animate__animated animate__fadeOutUp animate__faster' },
  })
}

// 恢復人員功能
// 修改 handleRestore 函式
const handleRestore = async (row) => {
  const result = await Swal.fire({
    title: '確認恢復人員？',
    html: `<p>即將恢復 <b class="text-primary">${row.staffName}</b> 的在職狀態</p>`,
    icon: 'question',
    showCancelButton: true,
    confirmButtonColor: '#67c23a',
    cancelButtonColor: '#909399',
    confirmButtonText: '<i class="fas fa-undo mr-1"></i> 確認恢復',
    cancelButtonText: '取消',
    showClass: { popup: 'animate__animated animate__bounceIn' },
  })

  if (result.isConfirmed) {
    try {
      // --- 修正開始：清洗備註 ---
      let cleanNote = row.staffNote || ''
      // 1. 移除 [停用原因：...] (使用正則表達式 global 替換)
      cleanNote = cleanNote.replace(/\[停用原因：.*?\]/g, '')

      // 2. 移除 [停用日期：...] (使用正則表達式 global 替換)
      cleanNote = cleanNote.replace(/\[停用日期：.*?\]/g, '')

      // 3. 移除多餘空白行與前後空白
      cleanNote = cleanNote.trim()

      // 傳送清洗過的備註 (cleanNote) 回後端
      await maintenanceApi.updateStaff(row.staffId, {
        ...row,
        isActive: true,
        staffNote: cleanNote,
      })

      await Swal.fire({
        icon: 'success',
        title: '恢復成功！',
        html: `<span class="text-success"><b>${row.staffName}</b> 已恢復在職狀態</span>`,
        timer: 1000,
        timerProgressBar: true,
        showConfirmButton: false,
        showClass: { popup: 'animate__animated animate__tada' },
      })
      fetchHistory()
    } catch {
      // 錯誤已由攔截器處理
    }
  }
}

const handleBack = () => {
  router.push('/admin/staff-list')
}

onMounted(() => {
  fetchHistory()
  setTimeout(() => (pageVisible.value = true), 100)
})
</script>

<template>
  <div class="history-container">
    <!-- 頁面標題區 -->
    <section class="content-header">
      <div class="container-fluid">
        <transition name="slide-down" appear>
          <div class="page-title-box">
            <div class="title-icon">
              <i class="fas fa-archive"></i>
            </div>
            <div class="title-content">
              <h1>維護人員歷史紀錄</h1>
              <p class="subtitle">檢視已離職或停用的人員資料</p>
            </div>
            <div class="title-actions">
              <el-button type="primary" plain @click="handleBack" class="back-btn">
                <i class="fas fa-arrow-left mr-2"></i> 返回列表
              </el-button>
            </div>
          </div>
        </transition>
      </div>
    </section>

    <!-- 主內容區 -->
    <section class="content">
      <div class="container-fluid">
        <transition name="zoom-fade" appear>
          <div v-show="pageVisible">
            <!-- 統計卡片 -->
            <el-row :gutter="20" class="mb-4">
              <el-col :xs="24" :sm="8" :md="6">
                <div class="stat-card archive-card">
                  <div class="stat-icon">
                    <i class="fas fa-user-slash"></i>
                  </div>
                  <div class="stat-info">
                    <h3>{{ staffList.length }}</h3>
                    <span>已封存人員</span>
                  </div>
                </div>
              </el-col>
              <el-col :xs="24" :sm="8" :md="6">
                <div class="stat-card filter-card">
                  <div class="stat-icon">
                    <i class="fas fa-filter"></i>
                  </div>
                  <div class="stat-info">
                    <h3>{{ filteredList.length }}</h3>
                    <span>篩選結果</span>
                  </div>
                </div>
              </el-col>
            </el-row>

            <!-- 資料表格卡片 -->
            <el-card shadow="hover" class="table-card">
              <template #header>
                <div class="card-header-content">
                  <div class="header-left">
                    <span class="header-icon">
                      <i class="fas fa-history"></i>
                    </span>
                    <span class="header-text">已封存人員清單</span>
                    <el-tag type="info" effect="plain" size="small" class="ml-2">
                      共 {{ filteredList.length }} 筆
                    </el-tag>
                  </div>
                  <div class="header-right">
                    <el-input
                      v-model="searchText"
                      placeholder="搜尋姓名或公司..."
                      prefix-icon="Search"
                      clearable
                      class="search-input"
                    />
                  </div>
                </div>
              </template>

              <!-- 骨架屏 -->
              <el-skeleton :rows="6" animated v-if="loading" />

              <!-- 資料表格 -->
              <el-table
                v-else
                :data="paginatedList"
                stripe
                highlight-current-row
                style="width: 100%"
                class="custom-table"
                :row-class-name="tableRowClassName"
              >
                <el-table-column prop="staffId" label="ID" width="70" align="center" sortable>
                  <template #default="{ row }">
                    <el-tag effect="plain" size="small" type="info">{{ row.staffId }}</el-tag>
                  </template>
                </el-table-column>

                <el-table-column prop="staffName" label="姓名" width="140" sortable>
                  <template #default="{ row }">
                    <div class="name-cell">
                      <el-avatar :size="32" class="name-avatar">
                        {{ row.staffName?.charAt(0) || '?' }}
                      </el-avatar>
                      <span class="name-text">{{ row.staffName }}</span>
                    </div>
                  </template>
                </el-table-column>

                <el-table-column prop="staffCompany" label="公司" min-width="160" sortable>
                  <template #default="{ row }">
                    <span v-if="row.staffCompany">
                      <i class="fas fa-building mr-1 text-primary"></i>
                      {{ row.staffCompany }}
                    </span>
                    <span v-else class="text-muted">-</span>
                  </template>
                </el-table-column>

                <el-table-column prop="staffPhone" label="電話" min-width="150">
                  <template #default="{ row }">
                    <span v-if="row.staffPhone">
                      <i class="fas fa-phone mr-1 text-success"></i>
                      {{ row.staffPhone }}
                    </span>
                    <span v-else class="text-muted">-</span>
                  </template>
                </el-table-column>

                <el-table-column
                  prop="staffEmail"
                  label="Email"
                  min-width="200"
                  show-overflow-tooltip
                >
                  <template #default="{ row }">
                    <span class="email-cell">
                      <i class="fas fa-envelope mr-1 text-warning"></i>
                      {{ row.staffEmail }}
                    </span>
                  </template>
                </el-table-column>

                <el-table-column label="停用日期" width="120" sortable prop="updatedAt">
                  <template #default="{ row }">
                    <div style="display: flex; flex-direction: column; align-items: flex-start">
                      <span style="font-size: 13px; color: #606266">
                        <i class="far fa-calendar-alt mr-1 text-muted"></i>
                        {{ extractDateFromNote(row.staffNote) }}
                      </span>
                    </div>
                  </template>
                </el-table-column>

                <el-table-column label="狀態" width="110" align="center">
                  <template #default>
                    <el-tag type="info" effect="dark" class="status-tag">
                      <i class="fas fa-ban mr-1"></i> 已離職
                    </el-tag>
                  </template>
                </el-table-column>

                <el-table-column label="操作" width="160" align="center" fixed="right">
                  <template #default="{ row }">
                    <el-button-group>
                      <el-tooltip content="查看詳情" placement="top">
                        <el-button
                          type="info"
                          size="small"
                          circle
                          @click="viewDetail(row)"
                          class="action-btn"
                        >
                          <i class="fas fa-eye"></i>
                        </el-button>
                      </el-tooltip>
                      <el-tooltip content="恢復在職" placement="top">
                        <el-button
                          type="success"
                          size="small"
                          circle
                          @click="handleRestore(row)"
                          class="action-btn"
                        >
                          <i class="fas fa-undo"></i>
                        </el-button>
                      </el-tooltip>
                    </el-button-group>
                  </template>
                </el-table-column>

                <!-- 空狀態 -->
                <template #empty>
                  <el-empty description="暫無歷史資料">
                    <template #image>
                      <div class="empty-icon">
                        <i class="fas fa-inbox"></i>
                      </div>
                    </template>
                    <el-button type="primary" plain @click="handleBack"> 返回人員列表 </el-button>
                  </el-empty>
                </template>
              </el-table>

              <!-- 分頁器 -->
              <div class="pagination-wrapper" v-if="showPagination">
                <el-pagination
                  v-model:current-page="currentPage"
                  v-model:page-size="pageSize"
                  :page-sizes="[5, 10, 20, 50]"
                  :total="paginationTotal"
                  layout="total, sizes, prev, pager, next, jumper"
                  background
                />
              </div>
            </el-card>
          </div>
        </transition>
      </div>
    </section>
  </div>
</template>

<style scoped>
.history-container {
  min-height: 100vh;
  background: linear-gradient(135deg, #f0f2f5 0%, #e2e6ea 100%);
  padding-bottom: 40px;
}

.content-header {
  padding: 20px 1rem;
}

.page-title-box {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 20px 24px;
  background: white;
  border-radius: 16px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
}

.title-icon {
  width: 60px;
  height: 60px;
  border-radius: 14px;
  background: linear-gradient(135deg, #909399 0%, #c0c4cc 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 26px;
  color: white;
  transition: all 0.3s ease;
}

.title-icon:hover {
  transform: scale(1.1) rotate(-5deg);
}

.title-content {
  flex: 1;
}

.title-content h1 {
  margin: 0;
  font-size: 1.6rem;
  font-weight: 700;
  color: #303133;
}

.title-content .subtitle {
  margin: 6px 0 0;
  font-size: 0.9rem;
  color: #909399;
}

.title-actions .back-btn {
  border-radius: 10px;
  font-weight: 500;
  transition: all 0.3s ease;
}

.title-actions .back-btn:hover {
  transform: translateX(-5px);
}

/* 統計卡片 */
.stat-card {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 20px;
  background: white;
  border-radius: 14px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
  transition: all 0.3s ease;
  margin-bottom: 16px;
}

.stat-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
}

.stat-icon {
  width: 50px;
  height: 50px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  color: white;
}

.archive-card .stat-icon {
  background: linear-gradient(135deg, #909399 0%, #b1b3b8 100%);
}

.filter-card .stat-icon {
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
}

.stat-info h3 {
  margin: 0;
  font-size: 1.8rem;
  font-weight: 700;
  color: #303133;
}

.stat-info span {
  font-size: 0.85rem;
  color: #909399;
}

/* 表格卡片 */
.table-card {
  border-radius: 16px;
  overflow: hidden;
  border: none;
}

.card-header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 12px;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 10px;
}

.header-icon {
  width: 36px;
  height: 36px;
  background: linear-gradient(135deg, #909399 0%, #c0c4cc 100%);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 16px;
}

.header-text {
  font-weight: 600;
  font-size: 1.05rem;
  color: #303133;
}

.search-input {
  width: 260px;
}

.search-input :deep(.el-input__wrapper) {
  border-radius: 10px;
}

/* 表格樣式 */
.custom-table {
  --el-table-header-bg-color: #f8f9fa;
}

.name-cell {
  display: flex;
  align-items: center;
  gap: 10px;
}

.name-avatar {
  background: linear-gradient(135deg, #909399 0%, #b1b3b8 100%);
  color: white;
  font-weight: 600;
  flex-shrink: 0;
}

.name-text {
  font-weight: 500;
}

.email-cell {
  display: flex;
  align-items: center;
  width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.status-tag {
  border-radius: 6px;
}

.action-btn {
  transition: all 0.3s ease;
}

.action-btn:hover {
  transform: scale(1.15);
}

/* 空狀態 */
.empty-icon {
  font-size: 60px;
  color: #dcdfe6;
  margin-bottom: 16px;
}

/* 分頁 */
.pagination-wrapper {
  display: flex;
  justify-content: center;
  padding-top: 20px;
  border-top: 1px solid #ebeef5;
  margin-top: 20px;
}

/* 過渡動畫 */
.slide-down-enter-active {
  transition: all 0.5s ease-out;
}
.slide-down-leave-active {
  transition: all 0.3s ease-in;
}
.slide-down-enter-from {
  transform: translateY(-30px);
  opacity: 0;
}
.slide-down-leave-to {
  transform: translateY(-20px);
  opacity: 0;
}

.zoom-fade-enter-active {
  transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.zoom-fade-leave-active {
  transition: all 0.3s ease-in;
}
.zoom-fade-enter-from {
  transform: scale(0.95);
  opacity: 0;
}
.zoom-fade-leave-to {
  transform: scale(0.98);
  opacity: 0;
}

/* 輔助類 */
.text-muted {
  color: #c0c4cc;
}
.text-primary {
  color: #409eff;
}
.text-success {
  color: #67c23a;
}
.text-warning {
  color: #e6a23c;
}
.mr-1 {
  margin-right: 4px;
}
.mr-2 {
  margin-right: 8px;
}
.ml-2 {
  margin-left: 8px;
}
.mb-4 {
  margin-bottom: 1.5rem;
}
</style>
</file>

<file path="frontend/src/views/member/AdminInfoModal.vue">
<script setup>
import { ref, watch } from 'vue'
import axios from 'axios'
import Swal from 'sweetalert2'

const props = defineProps({
  show: Boolean,
  adminData: Object
})

const emit = defineEmits(['close', 'update-success'])

// 表單資料
const form = ref({
  password: '',
  confirmPassword: ''
})

// 格式化日期
const formatDate = (dt) => {
  if (!dt) return 'N/A'
  return dt.substring(0, 10).replace(/-/g, '/')
}

// 取得頭像邏輯 (比照你的管理員列表)
const getAvatar = (id) => {
  if (id >= 1 && id <= 10) {
    const fileName = String(id).padStart(2, '0')
    return `/admin/${fileName}.jpg`
  }
  return '/admin/default.png'
}

// 儲存變更
// 儲存變更
const handleSave = async () => {
  // 1. 如果沒輸入密碼，代表不改密碼，直接關閉
  if (!form.value.password) {
    emit('close')
    return
  }

  // 2. 檢查兩次密碼是否一致
  if (form.value.password !== form.value.confirmPassword) {
    Swal.fire({ icon: 'error', title: '密碼不一致', text: '請再次確認新密碼' })
    return
  }

  try {
    // 3. 準備要傳給 AdminController.java 的物件
    // 這裡的 key 必須對應到你 Admin.java 的欄位名稱
    const updateData = {
      admId: props.adminData.admId,       // 從 props 拿 ID
      admUsername: props.adminData.admUsername, 
      admName: props.adminData.admName,
      admEmail: props.adminData.admEmail,
      admRole: props.adminData.admRole,
      admPassword: form.value.password   // 這是你要更新的新密碼
    };

    // 4. 改呼叫你自己的 API：/admins/update
    // 這裡用 POST，因為你的 Controller 寫的是 @PostMapping("/update")
    const response = await axios.post('http://localhost:8080/admins/update', updateData);

    // 5. 判斷回傳字串 (因為你的 Controller 回傳的是 String "管理員修改成功")
    if (response.data === "管理員修改成功") {
      await Swal.fire({ 
        icon: 'success', 
        title: '密碼修改成功', 
        timer: 1500, 
        showConfirmButton: false 
      });
      emit('update-success');
      emit('close');
    } else {
      Swal.fire({ icon: 'error', title: '儲存失敗', text: response.data });
    }

  } catch (error) {
    console.error('更新失敗:', error);
    // 這裡報錯通常是連線問題，因為你走的是自己的路徑，應該不會再有 401 了
    Swal.fire({ icon: 'error', title: '連線失敗', text: '請檢查後端伺服器是否運行' });
  }
}

// 每次開啟時清空密碼欄位
watch(() => props.show, (newVal) => {
  if (newVal) {
    form.value.password = ''
    form.value.confirmPassword = ''
  }
})
</script>

<template>
  <div v-if="show" class="modal-overlay" @click.self="emit('close')">
    <div class="profile-card">
      <div class="profile-header">
        <div class="header-title">
          <i class="fas fa-address-card"></i>
          <span>管理員個人資訊</span>
        </div>
        <button class="close-x" @click="emit('close')">&times;</button>
      </div>

      <div class="profile-body">
        <div class="left-panel">
          <div class="avatar-wrapper">
            <img :src="getAvatar(adminData?.admId)" />
          </div>
          <h3 class="admin-name">{{ adminData?.admName }}</h3>
          <span class="admin-tag">@{{ adminData?.admUsername }}</span>
        </div>

        <div class="right-panel">
          <div class="info-section">
            <div class="section-divider">個人資訊</div>
            <div class="detail-grid">
              <div class="detail-item">
                <label>管理員 ID</label>
                <div class="value">{{ adminData?.admId }}</div>
              </div>
              <div class="detail-item">
                <label>電子信箱</label>
                <div class="value">{{ adminData?.admEmail }}</div>
              </div>
              <div class="detail-item">
                <label>目前權限</label>
                <div class="value">
                  <span class="role-badge" :class="adminData?.admRole === 9 ? 'super' : 'normal'">
                    {{ adminData?.admRole === 9 ? '超級管理員' : '一般管理員' }}
                  </span>
                </div>
              </div>
              <div class="detail-item">
                <label>到職日期</label>
                <div class="value">{{ formatDate(adminData?.createdAt) }}</div>
              </div>
            </div>
          </div>

          <div class="info-section">
            <div class="section-divider">安全性設定</div>
            <div class="password-fields">
              <div class="input-group">
                <label>修改密碼 (留空則不更動)</label>
                <input 
                  type="password" 
                  v-model="form.password" 
                  placeholder="請輸入新密碼" 
                />
              </div>
              <div class="input-group">
                <label>再次確認新密碼</label>
                <input 
                  type="password" 
                  v-model="form.confirmPassword" 
                  placeholder="請再次輸入新密碼" 
                />
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="profile-footer">
        <button class="btn-cancel" @click="emit('close')">關閉視窗</button>
        <button class="btn-save" @click="handleSave">儲存變更</button>
      </div>
    </div>
  </div>
</template>

<style scoped>
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  backdrop-filter: blur(3px);
}

.profile-card {
  background: white;
  width: 750px;
  border-radius: 16px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
  overflow: hidden;
}

.profile-header {
  padding: 20px 24px;
  border-bottom: 1px solid #f0f0f0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.header-title {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 20px;
  font-weight: 700;
  color: #333;
}

.header-title i {
  color: #1890ff;
}

.close-x {
  border: none;
  background: none;
  font-size: 24px;
  cursor: pointer;
  color: #999;
}

.profile-body {
  display: flex;
  min-height: 400px;
}

/* 左側樣式 */
.left-panel {
  flex: 1;
  background: #fcfcfc;
  border-right: 1px solid #f0f0f0;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 40px 20px;
}

.avatar-wrapper {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  border: 4px solid #fff;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  overflow: hidden;
  margin-bottom: 16px;
}

.avatar-wrapper img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.admin-name {
  font-size: 22px;
  margin: 0;
  color: #262626;
}

.admin-tag {
  color: #8c8c8c;
  font-size: 14px;
}

/* 右側樣式 */
.right-panel {
  flex: 2;
  padding: 30px;
}

.section-divider {
  font-weight: 600;
  color: #1890ff;
  border-left: 4px solid #1890ff;
  padding-left: 10px;
  margin-bottom: 20px;
}

.detail-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 30px;
}

.detail-item label {
  display: block;
  font-size: 13px;
  color: #8c8c8c;
  margin-bottom: 4px;
}

.detail-item .value {
  font-size: 15px;
  color: #262626;
  font-weight: 500;
}

.role-badge {
  padding: 2px 10px;
  border-radius: 12px;
  font-size: 12px;
  color: white;
}

.role-badge.super { background: #f5222d; }
.role-badge.normal { background: #1890ff; }

.password-fields {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.input-group label {
  display: block;
  font-size: 13px;
  color: #595959;
  margin-bottom: 6px;
}

.input-group input {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #d9d9d9;
  border-radius: 8px;
  transition: all 0.3s;
}

.input-group input:focus {
  border-color: #40a9ff;
  outline: none;
  box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
}

/* Footer */
.profile-footer {
  padding: 16px 24px;
  border-top: 1px solid #f0f0f0;
  text-align: right;
  display: flex;
  justify-content: flex-end;
  gap: 12px;
}

.btn-cancel {
  padding: 8px 20px;
  background: #f0f0f0;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  color: #595959;
}

.btn-save {
  padding: 8px 20px;
  background: #1890ff;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  color: white;
  transition: background 0.3s;
}

.btn-save:hover {
  background: #40a9ff;
}
</style>
</file>

<file path="frontend/src/views/member/Register.vue">
<script setup>
import { reactive, ref } from 'vue'
import { useRouter } from 'vue-router'
import axios from 'axios'
import Swal from 'sweetalert2'

const router = useRouter()

const form = reactive({
  memName: '',
  memUsername: '',
  memEmail: '',
  memPhone: '',
  memPassword: '',
})

const confirmPassword = ref('')

const autoFill = () => {
  form.memName = '林育辰'
  form.memUsername = 'demo123'
  form.memEmail = 'alan123145@gmail.com'
  form.memPhone = '0998765432'
  form.memPassword = 'demo987'
  confirmPassword.value = 'demo987'
}

const submit = async () => {
  // 1️⃣ 空值檢查
  if (
    !form.memName ||
    !form.memUsername ||
    !form.memEmail ||
    !form.memPhone ||
    !form.memPassword ||
    !confirmPassword.value
  ) {
    Swal.fire('錯誤', '請填寫所有欄位', 'warning')
    return
  }

  // 2️⃣ Email 格式驗證
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
  if (!emailRegex.test(form.memEmail)) {
    Swal.fire('錯誤', '電子郵件格式不正確', 'error')
    return
  }

  // 3️⃣ 手機號碼驗證（只允許數字，8~15 碼你可調）
  const phoneRegex = /^\d{8,15}$/
  if (!phoneRegex.test(form.memPhone)) {
    Swal.fire('錯誤', '手機號碼格式不正確', 'error')
    return
  }

  // 4️⃣ 密碼一致檢查
  if (form.memPassword !== confirmPassword.value) {
    Swal.fire('錯誤', '兩次密碼輸入不一致', 'error')
    return
  }

  // 5️⃣ 送後端
  try {
    await axios.post('http://localhost:8080/api/members/register', form)
    await Swal.fire('成功', '註冊成功，請登入', 'success')
    router.push('/login')
  } catch (err) {
    Swal.fire('註冊失敗', err.response?.data || '錯誤', 'error')
  }
}

const goLogin = () => {
  router.push('/login')
}
</script>

<template>
  <div class="register-card">
    <h2 class="page-title">會員註冊</h2>
    
    <form @submit.prevent="submit" novalidate class="register-form">
      <div class="form-group">
        <label>姓名</label>
        <input v-model="form.memName" type="text" placeholder="請輸入您的姓名" />
      </div>

      <div class="form-group">
        <label>帳號</label>
        <input v-model="form.memUsername" type="text" placeholder="請輸入帳號" />
      </div>

      <div class="form-group">
        <label>電子郵件</label>
        <input v-model="form.memEmail" type="text" placeholder="請輸入您的 E-MAIL" />
      </div>

      <div class="form-group">
        <label>手機</label>
        <input v-model="form.memPhone" type="text" placeholder="請輸入您的手機" />
      </div>

      <div class="form-group">
        <label>密碼</label>
        <input v-model="form.memPassword" type="password" placeholder="請輸入您的密碼" />
      </div>

      <div class="form-group">
        <label>再次輸入密碼</label>
        <input v-model="confirmPassword" type="password" placeholder="再輸入一次密碼" />
      </div>

      <button type="submit" class="submit-btn">加入會員</button>

      <button type="button" class="demo-btn" @click="autoFill">
        一鍵帶入
      </button>
    </form>

    <div class="back-login-area">
      <div class="back-login" @click="goLogin">
        👤 我已經有會員帳號了？ <span>回登入頁面</span>
      </div>
    </div>
  </div>
</template>

<style scoped>
/* 核心白底卡片容器 */
.register-card {
  background-color: #ffffff;
  width: 100%;
  max-width: 650px;
  margin: 0 auto;
  padding: 50px 80px;
  border: 1px solid #e8e8e8;
  border-radius: 4px; /* 輕微圓角增加質感 */
}

/* 標題樣式 */
.page-title {
  text-align: center;
  font-size: 22px;
  font-weight: 600;
  color: #333;
  margin-bottom: 35px;
}

.register-form {
  display: flex;
  flex-direction: column;
}

/* 欄位群組 */
.form-group {
  margin-bottom: 22px;
}

.form-group label {
  display: block;
  font-size: 14px;
  font-weight: bold;
  color: #444;
  margin-bottom: 8px;
}

/* 輸入框樣式：仿照圖片寬高與色調 */
.form-group input {
  width: 100%;
  height: 45px;
  padding: 0 15px;
  border: 1px solid #dcdcdc;
  border-radius: 4px;
  font-size: 14px;
  color: #333;
  outline: none;
  transition: all 0.2s ease-in-out;
}

.form-group input:focus {
  border-color: #ff7a66;
  box-shadow: 0 0 4px rgba(255, 122, 102, 0.2);
}

/* 按鈕樣式：珊瑚橘滿版設計 */
.submit-btn {
  width: 100%;
  height: 50px;
  background-color: #ff7a66;
  color: #ffffff;
  border: none;
  border-radius: 4px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 15px;
  transition: background 0.3s;
}

.submit-btn:hover {
  background-color: #ff6650;
}

/* 底部連結區塊 */
.back-login-area {
  margin-top: 30px;
  text-align: center;
}

.back-login {
  font-size: 14px;
  color: #555;
  cursor: pointer;
  display: inline-block;
}

.back-login span {
  color: #0066cc;
  margin-left: 5px;
}

.back-login:hover span {
  text-decoration: underline;
}

/* 針對行動裝置的調整 */
@media (max-width: 600px) {
  .register-card {
    padding: 30px 20px;
    border: none;
  }
}

.demo-btn {
  width: 100%;
  height: 40px;
  background-color: #f4f4f4;
  color: #666;
  border: 1px dashed #ccc;
  border-radius: 4px;
  font-size: 14px;
  cursor: pointer;
  margin-top: 10px;
  transition: all 0.3s;
}

.demo-btn:hover {
  background-color: #eee;
  border-color: #ff7a66;
  color: #ff7a66;
}
</style>
</file>

<file path="frontend/src/views/merchantAndCoupon/CouponMallView.vue">
<template>
  <div class="mall-page p-4">
    <div class="container-fluid">
      <div class="header-section d-flex flex-wrap justify-content-between align-items-center mb-4 bg-white p-3 rounded shadow-sm border-start border-warning border-4">
        <div class="d-flex align-items-center">
          <h4 class="mb-0 fw-bold text-dark me-3">
            <i class="bi bi-shop me-2 text-warning"></i>點數商城
          </h4>
        </div>

        <div class="d-flex align-items-center gap-3 mt-3 mt-md-0">
          <div class="points-display px-4 py-2 bg-dark rounded-pill shadow-sm">
            <span class="text-white-50 small me-2">可用點數</span>
            <span class="text-warning fw-bold h5 mb-0">{{ currentPoints }}</span>
            <span class="text-warning small ms-1">Pts</span>
          </div>
          <router-link to="/snake" class="btn btn-warning fw-bold px-4 rounded-pill shadow-sm hover-scale">
            <i class="bi bi-controller me-1"></i> 玩遊戲賺點數
          </router-link>
        </div>
      </div>

      <div class="text-center mb-5 py-3">
        <h2 class="fw-bold display-6">🎫 專屬優惠兌換</h2>
        <p class="lead text-muted">消費回饋點數，現場即享折扣</p>
      
        <div class="search-container mx-auto mt-4">
          <div class="input-group shadow-sm rounded-pill overflow-hidden border">
            <span class="input-group-text bg-white border-0">
              <i class="bi bi-search text-warning"></i>
            </span>
            <input
              v-model="searchKeyword"
              @input="handleSearch"
              type="text"
              class="form-control border-0 ps-0 shadow-none"
              placeholder="搜尋優惠券、商家名稱或描述..."
            />
            <button v-if="searchKeyword" @click="clearSearch" class="btn btn-white border-0 text-muted" type="button">
              <i class="bi bi-x-circle"></i>
            </button>
          </div>
        </div>

        <div v-if="route.query.merchantId" class="mt-3">
          <span class="badge bg-warning-subtle text-dark border border-warning px-3 py-2 rounded-pill">
            正在查看特定商家的優惠
            <button @click="resetAndFetch" class="btn-close ms-2" style="font-size: 0.6rem;"></button>
          </span>
        </div>
      </div>

      <div v-if="loading" class="text-center py-5">
        <div class="spinner-grow text-warning" role="status"></div>
        <p class="mt-3 text-muted fw-bold">正在載入最新優惠...</p>
      </div>

      <div v-else>
        <div class="row g-4 gy-5">
          <div v-for="coupon in pagedCoupons" :key="coupon.couponId" class="col-sm-12 col-md-6 col-lg-4 col-xl-3">
            <div class="card h-100 border-0 shadow-sm coupon-card">
              <div class="image-wrapper position-relative">
                <img
                  :src="coupon.couponImg ? `http://localhost:8080/images/${coupon.couponImg}` : 'https://placehold.co/600x400?text=Discount'"
                  class="card-img-top"
                  alt="coupon"
                />
                <div class="merchant-badge">{{ coupon.merchantName || '特約商家' }}</div>
              </div>

              <div class="card-body p-4 d-flex flex-column">
                <h5 class="fw-bold card-title mb-2 text-dark">{{ coupon.couponName }}</h5>
                <p class="text-secondary small description-text flex-grow-1">
                  {{ coupon.couponDescription }}
                </p>
               
                <hr class="my-3 opacity-10">
               
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <div class="text-orange h4 fw-bold mb-0">{{ coupon.pointsRequired }} <small class="h6">Pts</small></div>
                    <div class="text-muted x-small">有效期至 {{ coupon.endDate }}</div>
                  </div>
                  <button
                    @click="handleRedeem(coupon)"
                    class="btn redeem-btn fw-bold px-3 shadow-sm"
                    :class="canAfford(coupon.pointsRequired) ? 'btn-warning' : 'btn-light disabled text-muted'"
                  >
                    {{ canAfford(coupon.pointsRequired) ? '現場核銷' : '點數不足' }}
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div v-if="filteredCoupons.length === 0" class="text-center py-5 mt-5">
          <i class="bi bi-ticket-perforated display-1 text-light"></i>
          <p class="text-muted h5 mt-3">目前找不到符合條件的優惠</p>
          <button @click="resetAndFetch" class="btn btn-outline-warning btn-sm mt-2 rounded-pill">顯示全部優惠</button>
        </div>

        <nav v-if="totalPages > 1" class="mt-5 d-flex justify-content-center">
          <ul class="pagination pagination-md shadow-sm">
            <li class="page-item" :class="{ disabled: currentPage === 1 }">
              <a class="page-link" href="#" @click.prevent="changePage(currentPage - 1)">上一頁</a>
            </li>
            <li v-for="page in totalPages" :key="page" class="page-item" :class="{ active: currentPage === page }">
              <a class="page-link" href="#" @click.prevent="changePage(page)">{{ page }}</a>
            </li>
            <li class="page-item" :class="{ disabled: currentPage === totalPages }">
              <a class="page-link" href="#" @click.prevent="changePage(currentPage + 1)">下一頁</a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted, computed, watch } from 'vue'
import { useRouter, useRoute } from 'vue-router'
import { useMemberAuthStore } from '@/stores/memberAuth'
import axios from 'axios'
import Swal from 'sweetalert2'

const router = useRouter()
const route = useRoute()
const memberStore = useMemberAuthStore()

// 狀態管理
const loading = ref(true)
const searchKeyword = ref('')
const allCoupons = ref([])
const currentPage = ref(1)
const itemsPerPage = 8 // 每頁顯示 8 張，版面更整齊

// 響應式抓取會員與點數
const memberId = computed(() => memberStore.member?.memId)
const currentPoints = computed(() => memberStore.member?.memPoints || 0)

// 篩選與分頁邏輯
const filteredCoupons = computed(() => allCoupons.value.filter(c => c.couponStatus === 1))
const pagedCoupons = computed(() => {
  const start = (currentPage.value - 1) * itemsPerPage
  return filteredCoupons.value.slice(start, start + itemsPerPage)
})
const totalPages = computed(() => Math.ceil(filteredCoupons.value.length / itemsPerPage))

// 判斷點數是否足夠
const canAfford = (required) => currentPoints.value >= required

/**
 * 核心功能：現場核銷 (Redeem) - 含商家核銷碼驗證
 */
const handleRedeem = async (coupon) => {
  // 1. 檢查登入狀態
  if (!memberStore.isLogin || !memberId.value) {
    const result = await Swal.fire({
      title: '請先登入',
      text: '您需要登入會員帳號才能進行點數兌換。',
      icon: 'info',
      showCancelButton: true,
      confirmButtonText: '立即登入',
      confirmButtonColor: '#ffc107'
    })
    if (result.isConfirmed) router.push('/login')
    return
  }

  // 2. 點數充足檢查
  if (!canAfford(coupon.pointsRequired)) {
    Swal.fire('點數不足', `兌換此優惠需要 ${coupon.pointsRequired} 點。`, 'error')
    return
  }

  // 3. 第一步：確認兌換意願
  const confirmRedeem = await Swal.fire({
    title: '確認兌換？',
    html: `將扣除 <b class="text-danger">${coupon.pointsRequired}</b> 點數。<br><b>「${coupon.couponName}」</b>`,
    icon: 'question',
    showCancelButton: true,
    confirmButtonText: '前往核銷',
    cancelButtonText: '取消',
    confirmButtonColor: '#ffc107'
  })

  if (!confirmRedeem.isConfirmed) return

  // 4. 第二步：輸入商家核銷碼 (由店員操作)
  const { value: merchantCode } = await Swal.fire({
    title: '商家核銷',
    input: 'password', // 使用密碼形式隱藏輸入內容
    inputLabel: '請請店員輸入核銷碼',
    inputPlaceholder: '請在此輸入 4-6 位核銷碼',
    inputAttributes: {
      autocapitalize: 'off',
      autocorrect: 'off'
    },
    showCancelButton: true,
    confirmButtonText: '驗證並扣點',
    cancelButtonText: '返回',
    confirmButtonColor: '#28a745',
    inputValidator: (value) => {
      if (!value) {
        return '核銷碼不能為空！'
      }
    }
  })

  // 5. 第三步：發送請求到後端 (帶上核銷碼)
  if (merchantCode) {
    try {
      // 這裡將 merchantCode 一併送往後端驗證
      const response = await axios.post(`http://localhost:8080/api/discounts/redeem`, {
        memberId: memberId.value,
        couponId: coupon.couponId,
       passcode: merchantCode // 傳送商家輸入的核銷碼
      })

      if (response.data.code !== 200) { 
            throw new Error(response.data.msg || '核銷失敗');
        }

      // 6. 成功提示
      await Swal.fire({
        title: '兌換成功！',
        text: `核銷完成！${response.data.message || ''}`,
        icon: 'success',
        confirmButtonColor: '#28a745'
      })

      // 同步全站點數
      if (typeof memberStore.refreshPoints === 'function') {
        await memberStore.refreshPoints()
      }
     
      fetchData() // 刷新列表

    } catch (err) {
      console.error('Redeem Error:', err)
      // 如果核銷碼錯誤，後端應回傳 400 或 403
      Swal.fire(
        '核銷失敗',
        err.response?.data?.message || '核銷碼錯誤',
        'error'
      )
    }
  }
}

/**
 * 抓取後端資料
 */
const fetchData = async () => {
  loading.value = true
  try {
    const targetId = route.query.merchantId
    const res = await axios.get('http://localhost:8080/api/discounts', {
      params: { keyword: searchKeyword.value }
    })
   
    let data = res.data.data || []
   
    // 如果 URL 有商家 ID，進行過濾
    if (targetId) {
      data = data.filter(item => (item.merchantId || item.merchant?.merchantId) == targetId)
    }
   
    allCoupons.value = data

    // 若已登入，同步最新會員資訊 (包含點數)
    if (memberStore.isLogin && typeof memberStore.refreshPoints === 'function') {
      await memberStore.refreshPoints()
    }
  } catch (error) {
    console.error('Load Data Failed:', error)
  } finally {
    loading.value = false
  }
}

/**
 * 搜尋與分頁輔助
 */
let searchTimer = null
const handleSearch = () => {
  if (searchTimer) clearTimeout(searchTimer)
  searchTimer = setTimeout(() => {
    currentPage.value = 1
    fetchData()
  }, 500)
}

const clearSearch = () => {
  searchKeyword.value = ''
  fetchData()
}

const resetAndFetch = () => {
  searchKeyword.value = ''
  router.push('/mall')
  fetchData()
}

const changePage = (p) => {
  currentPage.value = p
  window.scrollTo({ top: 0, behavior: 'smooth' })
}

// 監聽網址參數變化 (從別的商家跳轉回來時)
watch(() => route.query.merchantId, () => {
  currentPage.value = 1
  fetchData()
})

onMounted(fetchData)
</script>

<style scoped>
.mall-page {
  background-color: #f8f9fa;
  min-height: 100vh;
}

.search-container {
  max-width: 550px;
}

.coupon-card {
  transition: all 0.3s cubic-bezier(.25,.8,.25,1);
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.coupon-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.1);
}

.btn-redeem {
  background-color: #ffc107;
  color: #212529;
  font-weight: 600;
  border: none;
  transition: background 0.2s;
}
.btn-redeem:hover {
  background-color: #e0a800;
  color: #212529;
}

.pagination-btn {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  border: 1px solid #ddd;
  background: white;
  cursor: pointer;
  transition: all 0.2s;
}

.pagination-btn:hover:not(.active) {
  border-color: #ffc107;
  color: #ffc107;
}

.pagination-btn.active {
  background-color: #ffc107;
  border-color: #ffc107;
  color: white;
}

.search-input {
  border: 2px solid #ffc107;
  border-radius: 50px;
  padding: 10px 20px;
  transition: box-shadow 0.2s;
}
.search-input:focus {
  border-color: #ffc107;
  box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.1);
}

.back-btn {
  background-color: #212529;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 20px;
  cursor: pointer;
  transition: background 0.2s;
}

.back-btn:hover {
  background-color: #343a40;
}
</style>
</file>

<file path="frontend/src/views/merchantAndCoupon/DiscountList.vue">
<template>
  <div class="discount-list-container">
    <section class="content-header">
      <div class="container-fluid">
        <div class="row align-items-center">
          <div class="col-12">
            <div class="page-title-box">
              <div class="title-icon">
                <i class="fas fa-ticket-alt"></i>
              </div>
              <div class="title-content">
                <h1>優惠券管理系統</h1>
                <p class="subtitle">管理合作商家優惠券活動</p>
              </div>
              <div class="title-actions">
                <el-button type="success" class="action-btn add-btn" @click="openEditModal()">
                  <i class="fas fa-plus mr-1"></i> 新增優惠券
                </el-button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="content">
      <div class="container-fluid">
        <transition name="fade-slide" appear>
          <div>
            <el-row :gutter="20" class="mb-4">
              <el-col :xs="12" :sm="6">
                <div class="stat-card total-card">
                  <div class="stat-icon"><i class="fas fa-ticket-alt"></i></div>
                  <div class="stat-info">
                    <h3>{{ discounts.length }}</h3>
                    <span>總優惠券</span>
                  </div>
                </div>
              </el-col>
              <el-col :xs="12" :sm="6">
                <div class="stat-card active-card">
                  <div class="stat-icon"><i class="fas fa-play-circle"></i></div>
                  <div class="stat-info">
                    <h3>{{ discounts.filter((d) => d.couponStatus === 1).length }}</h3>
                    <span>進行中</span>
                  </div>
                </div>
              </el-col>
              <el-col :xs="12" :sm="6">
                <div class="stat-card pending-card">
                  <div class="stat-icon"><i class="fas fa-clock"></i></div>
                  <div class="stat-info">
                    <h3>{{ discounts.filter((d) => d.couponStatus === 0).length }}</h3>
                    <span>尚未開始</span>
                  </div>
                </div>
              </el-col>
              <el-col :xs="12" :sm="6">
                <div class="stat-card ended-card">
                  <div class="stat-icon"><i class="fas fa-stop-circle"></i></div>
                  <div class="stat-info">
                    <h3>
                      {{
                        discounts.filter((d) => d.couponStatus === 2 || d.couponStatus === 3).length
                      }}
                    </h3>
                    <span>已結束/下架</span>
                  </div>
                </div>
              </el-col>
            </el-row>

            <el-card shadow="hover" class="table-card">
              <template #header>
                <div class="card-header-content">
                  <div class="header-left">
                    <span class="header-icon"><i class="fas fa-list"></i></span>
                    <span class="header-text">優惠券列表</span>
                    <el-tag type="warning" effect="light" size="small" round
                      >{{ discounts.length }} 筆</el-tag
                    >
                  </div>
                </div>
              </template>

              <div class="filter-bar">
                <el-input
                  v-model="keyword"
                  placeholder="搜尋優惠券名稱..."
                  prefix-icon="Search"
                  clearable
                  class="filter-input"
                  @keyup.enter="fetchDiscounts"
                />
                <el-button type="warning" @click="fetchDiscounts" class="search-btn">
                  <i class="fas fa-search mr-1"></i> 搜尋
                </el-button>
              </div>

              <el-table
                :data="paginatedDiscounts"
                v-loading="loading"
                stripe
                highlight-current-row
                style="width: 100%"
                :header-cell-style="{ background: '#f5f7fa', fontWeight: 'bold', color: '#303133' }"
                class="modern-table"
              >
                <el-table-column prop="couponId" label="ID" width="70" align="center">
                  <template #default="{ row }">
                    <span class="id-tag">#{{ row.couponId }}</span>
                  </template>
                </el-table-column>
                <el-table-column label="圖片" width="90" align="center">
                  <template #default="{ row }">
                    <div class="img-cell" @click.stop>
                      <el-image
                        v-if="row.couponImg"
                        class="coupon-img"
                        :src="`http://localhost:8080/images/${row.couponImg}`"
                        :preview-src-list="[`http://localhost:8080/images/${row.couponImg}`]"
                        :preview-teleported="true"
                        :z-index="4000"
                        fit="cover"
                        @click.stop
                      />
                      <span v-else class="img-empty">—</span>
                    </div>
                  </template>
                </el-table-column>
                <el-table-column label="優惠名稱 / 內容" min-width="200">
                  <template #default="{ row }">
                    <div class="coupon-info-cell">
                      <div class="coupon-name">{{ row.couponName }}</div>
                      <div class="coupon-desc" :title="row.couponDescription">
                        {{ row.couponDescription }}
                      </div>
                    </div>
                  </template>
                </el-table-column>
                <el-table-column label="隸屬商家" width="140">
                  <template #default="{ row }">
                    <el-tag type="info" effect="plain" size="small" class="merchant-tag">
                      <i class="fas fa-store mr-1"></i>
                      {{
                        row.merchantName || (row.merchant ? row.merchant.merchantName : '未指定')
                      }}
                    </el-tag>
                  </template>
                </el-table-column>
                <el-table-column label="所需點數" width="100" align="center">
                  <template #default="{ row }">
                    <span class="points-text">{{ row.pointsRequired }} <small>Pts</small></span>
                  </template>
                </el-table-column>
                <el-table-column label="狀態" width="110" align="center">
                  <template #default="{ row }">
                    <el-tag
                      :type="getStatusType(row.couponStatus)"
                      effect="light"
                      size="small"
                      class="status-tag"
                    >
                      <i :class="getStatusIcon(row.couponStatus)" class="mr-1"></i>
                      {{ getStatusText(row.couponStatus) }}
                    </el-tag>
                  </template>
                </el-table-column>
                <el-table-column label="活動期限" width="180">
                  <template #default="{ row }">
                    <div class="date-cell">
                      <i class="fas fa-calendar-alt text-primary mr-1"></i>
                      <span>{{ row.startDate }} ~ {{ row.endDate }}</span>
                    </div>
                  </template>
                </el-table-column>
                <el-table-column label="操作" width="150" align="center" fixed="right">
                  <template #default="{ row }">
                    <el-button-group>
                      <el-tooltip content="編輯" placement="top">
                        <el-button size="small" type="primary" @click="openEditModal(row)">
                          <i class="fas fa-edit"></i>
                        </el-button>
                      </el-tooltip>
                      <el-tooltip
                        v-if="row.couponStatus === 0 || row.couponStatus === 1"
                        content="下架"
                        placement="top"
                      >
                        <el-button
                          size="small"
                          type="warning"
                          @click="handleStatusChange(row.couponId, 'disable')"
                        >
                          <i class="fas fa-pause"></i>
                        </el-button>
                      </el-tooltip>
                      <el-tooltip v-if="row.couponStatus === 3" content="上架" placement="top">
                        <el-button
                          size="small"
                          type="success"
                          @click="handleStatusChange(row.couponId, 'relist')"
                        >
                          <i class="fas fa-play"></i>
                        </el-button>
                      </el-tooltip>
                      <el-tooltip content="刪除" placement="top">
                        <el-button size="small" type="danger" @click="deleteDiscount(row.couponId)">
                          <i class="fas fa-trash-alt"></i>
                        </el-button>
                      </el-tooltip>
                    </el-button-group>
                  </template>
                </el-table-column>
              </el-table>

              <div style="margin-top: 20px; display: flex; justify-content: center;">
                <el-pagination
                  v-model:current-page="currentPage"
                  v-model:page-size="pageSize"
                  :page-sizes="[5, 10, 15, 20]"
                  layout="total, sizes, prev, pager, next, jumper"
                  :total="filteredDiscounts.length"
                  background
                />
              </div>

              <el-empty
                v-if="discounts.length === 0 && !loading"
                description="目前沒有優惠券資料"
              />
            </el-card>
          </div>
        </transition>
      </div>
    </section>

    <el-dialog
      v-model="isEditModalOpen"
      :title="editingDiscount.couponId ? `編輯優惠券 #${editingDiscount.couponId}` : '新增優惠券'"
      width="600px"
      top="5vh"
      class="modern-dialog"
      :close-on-click-modal="false"
    >
      <div style="display: flex; justify-content: flex-end; margin-bottom: 15px;">
        <el-button 
          type="warning" 
          plain 
          size="small" 
          @click="handleQuickFill"
          style="border-style: dashed;"
        >
          <i class="fas fa-magic mr-1"></i> 一鍵填入測試資料
        </el-button>
      </div>

      <el-form
        :model="editingDiscount"
        label-position="top"
        class="modern-form"
      >
        <el-form-item label="優惠名稱" required>
          <el-input v-model="editingDiscount.couponName" placeholder="請輸入優惠名稱">
            <template #prefix><i class="fas fa-tag"></i></template>
          </el-input>
        </el-form-item>

        <el-form-item label="優惠描述">
          <el-input
            v-model="editingDiscount.couponDescription"
            type="textarea"
            :rows="2"
            placeholder="請輸入優惠描述"
          />
        </el-form-item>

        <el-form-item label="隸屬商家" required>
          <el-select
            v-model="editingDiscount.merchantId"
            placeholder="請選擇商家"
            style="width: 100%"
          >
            <el-option
              v-for="m in merchants"
              :key="m.merchantId"
              :value="m.merchantId"
              :label="m.merchantName"
            >
              <i class="fas fa-store mr-2 text-primary"></i>{{ m.merchantName }}
            </el-option>
          </el-select>
        </el-form-item>

        <el-row :gutter="20">
          <el-col :span="12">
            <el-form-item label="開始日期">
              <el-date-picker
                v-model="editingDiscount.startDate"
                type="date"
                value-format="YYYY-MM-DD"
                placeholder="選擇日期"
                style="width: 100%"
              />
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="結束日期">
              <el-date-picker
                v-model="editingDiscount.endDate"
                type="date"
                value-format="YYYY-MM-DD"
                placeholder="選擇日期"
                style="width: 100%"
              />
            </el-form-item>
          </el-col>
        </el-row>

        <el-row :gutter="20">
          <el-col :span="12">
            <el-form-item label="所需點數">
              <el-input-number
                v-model="editingDiscount.pointsRequired"
                :min="0"
                style="width: 100%"
              />
            </el-form-item>
          </el-col>
          
          <el-col :span="12">
            <el-form-item label="優惠圖片">
              <div class="upload-container">
                <el-upload
                  action="#"
                  :auto-upload="false"
                  :show-file-list="false"
                  :on-change="onFileChange"
                  accept="image/*"
                >
                  <el-button type="info" plain style="width: 100%;">
                    <i class="fas fa-upload mr-1"></i>選擇圖片
                  </el-button>
                </el-upload>

                <div v-if="imagePreview" class="preview-box">
                  <el-image 
                    :src="imagePreview" 
                    fit="cover" 
                    class="preview-img-fill"
                  />
                  <div class="preview-overlay" @click="imagePreview = null; selectedFile = null">
                    <i class="fas fa-times"></i>
                  </div>
                </div>
              </div>
            </el-form-item>
          </el-col>
        </el-row>
      </el-form>

      <template #footer>
        <div class="dialog-footer">
          <el-button @click="isEditModalOpen = false">取消</el-button>
          <el-button type="primary" @click="handleSave">儲存資料</el-button>
        </div>
      </template>
    </el-dialog>
  </div>
</template>

<script setup>
import { ref, onMounted, computed } from 'vue' // 修正：補上 computed
import axios from 'axios'
import Swal from 'sweetalert2'

// 基本狀態
const discounts = ref([])
const merchants = ref([])
const keyword = ref('')
const loading = ref(false)
const currentPage = ref(1)
const pageSize = ref(15)

// 搜尋過濾邏輯 
const filteredDiscounts = computed(() => {
  if (!keyword.value) return discounts.value;
  return discounts.value.filter(discount => 
    discount.couponName && discount.couponName.toLowerCase().includes(keyword.value.toLowerCase())
  );
});

// 分頁邏輯 
const paginatedDiscounts = computed(() => {
  const start = (currentPage.value - 1) * pageSize.value;
  const end = start + pageSize.value;
  return filteredDiscounts.value.slice(start, end);
});

// Modal 與圖片控制
const isEditModalOpen = ref(false)
const selectedFile = ref(null)
const imagePreview = ref(null)

const editingDiscount = ref({
  couponId: null,
  couponName: '',
  couponDescription: '',
  merchantId: null,
  couponStatus: 1,
  couponImg: '',
  startDate: '',
  endDate: '',
  pointsRequired: 0,
})

// 狀態輔助函數
const getStatusType = (status) => {
  const map = { 0: 'info', 1: 'success', 2: 'danger', 3: 'warning' }
  return map[status] || 'info'
}

const getStatusText = (status) => {
  const map = { 0: '尚未開始', 1: '進行中', 2: '已結束', 3: '已下架' }
  return map[status] || '未知'
}

const getStatusIcon = (status) => {
  const map = {
    0: 'fas fa-clock',
    1: 'fas fa-play-circle',
    2: 'fas fa-stop-circle',
    3: 'fas fa-pause-circle',
  }
  return map[status] || 'fas fa-question-circle'
}

// 1. 取得列表
const fetchDiscounts = async () => {
  loading.value = true
  try {
    const res = await axios.get('http://localhost:8080/api/discounts', {
      params: { keyword: keyword.value },
    })
    discounts.value = res.data.data || []
  } catch (err) {
    console.error(err)
    Swal.fire({
      title: '錯誤',
      html: '<div style="display:flex;flex-direction:column;align-items:center;"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#f56c6c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg><p style="margin-top:12px;">取得清單失敗</p></div>',
      confirmButtonColor: '#409eff',
      confirmButtonText: '確定',
    })
  } finally {
    loading.value = false
  }
}

// 2. 取得商家選單
const fetchMerchants = async () => {
  try {
    const res = await axios.get('http://localhost:8080/api/merchants')
    merchants.value = res.data.data || []
  } catch (err) {
    console.error('載入商家失敗', err)
  }
}

// 3. 上、下架手動切換
const handleStatusChange = async (id, action) => {
  const actionText = action === 'relist' ? '上架' : '下架'

  const result = await Swal.fire({
    title: `確定要${actionText}嗎？`,
    html: `<div style="display:flex;flex-direction:column;align-items:center;"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#e6a23c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg><p style="margin-top:12px;">${action === 'disable' ? '下架後消費者將無法在商城兌換此券' : '上架將根據活動日期自動判定狀態'}</p></div>`,
    showCancelButton: true,
    confirmButtonColor: '#409eff',
    cancelButtonColor: '#909399',
    confirmButtonText: `確定${actionText}`,
    cancelButtonText: '取消',
  })

  if (!result.isConfirmed) return

  try {
    const res = await axios.put(`http://localhost:8080/api/discounts/${id}/status`, null, {
      params: { action: action },
    })

    if (res.data.code === 200) {
      Swal.fire({
        title: '成功',
        html: `<div style="display:flex;flex-direction:column;align-items:center;"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#67c23a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg><p style="margin-top:12px;">${actionText}成功</p></div>`,
        confirmButtonColor: '#409eff',
        confirmButtonText: '確定',
      })
      fetchDiscounts()
    } else {
      Swal.fire({
        title: '失敗',
        html: `<div style="display:flex;flex-direction:column;align-items:center;"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#f56c6c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg><p style="margin-top:12px;">${res.data.message || '操作失敗'}</p></div>`,
        confirmButtonColor: '#409eff',
        confirmButtonText: '確定',
      })
    }
  } catch (err) {
    console.error(err)
    Swal.fire({
      title: '錯誤',
      html: '<div style="display:flex;flex-direction:column;align-items:center;"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#f56c6c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg><p style="margin-top:12px;">伺服器連線異常</p></div>',
      confirmButtonColor: '#409eff',
      confirmButtonText: '確定',
    })
  }
}

// 4. 圖片處理
const onFileChange = (file) => {
  if (file && file.raw) {
    selectedFile.value = file.raw
    imagePreview.value = URL.createObjectURL(file.raw)
  }
}

// 5. 開啟 Modal
const openEditModal = (item = null) => {
  if (item) {
    editingDiscount.value = { ...item }
    imagePreview.value = item.couponImg ? `http://localhost:8080/images/${item.couponImg}` : null
  } else {
    editingDiscount.value = {
      couponId: null,
      couponName: '',
      couponDescription: '',
      merchantId: null,
      couponStatus: 1,
      couponImg: '',
      startDate: '',
      endDate: '',
      pointsRequired: 0,
    }
    imagePreview.value = null
  }
  selectedFile.value = null
  isEditModalOpen.value = true
}

// 6. 儲存
const handleSave = async () => {
  try {
    const formData = new FormData()
    const jsonBlob = new Blob([JSON.stringify(editingDiscount.value)], { type: 'application/json' })
    formData.append('discount', jsonBlob)

    if (selectedFile.value) {
      formData.append('image', selectedFile.value)
    }

    const res = await axios.post('http://localhost:8080/api/discounts', formData)

    if (res.data.code === 200) {
      Swal.fire({
        title: '成功',
        html: '<div style="display:flex;flex-direction:column;align-items:center;"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#67c23a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg><p style="margin-top:12px;">資料已儲存</p></div>',
        confirmButtonColor: '#409eff',
        confirmButtonText: '確定',
      })
      isEditModalOpen.value = false
      fetchDiscounts()
    } else {
      Swal.fire({
        title: '失敗',
        html: `<div style="display:flex;flex-direction:column;align-items:center;"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#f56c6c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg><p style="margin-top:12px;">${res.data.message}</p></div>`,
        confirmButtonColor: '#409eff',
        confirmButtonText: '確定',
      })
    }
  } catch (err) {
    Swal.fire({
      title: '儲存失敗',
      html: '<div style="display:flex;flex-direction:column;align-items:center;"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#f56c6c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg><p style="margin-top:12px;">請檢查資料完整性</p></div>',
      confirmButtonColor: '#409eff',
      confirmButtonText: '確定',
    })
  }
}

// 7. 刪除
const deleteDiscount = (id) => {
  Swal.fire({
    title: '確定刪除？',
    html: '<div style="display:flex;flex-direction:column;align-items:center;"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#e6a23c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg><p style="margin-top:12px;">刪除後無法還原！</p></div>',
    showCancelButton: true,
    confirmButtonColor: '#f56c6c',
    cancelButtonColor: '#909399',
    confirmButtonText: '確定刪除',
    cancelButtonText: '取消',
  }).then(async (result) => {
    if (result.isConfirmed) {
      try {
        await axios.delete(`http://localhost:8080/api/discounts/${id}`)
        Swal.fire({
          title: '已刪除',
          html: '<div style="display:flex;flex-direction:column;align-items:center;"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#67c23a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg><p style="margin-top:12px;">優惠券已移除</p></div>',
          confirmButtonColor: '#409eff',
          confirmButtonText: '確定',
        })
        fetchDiscounts()
      } catch {
        Swal.fire({
          title: '錯誤',
          html: '<div style="display:flex;flex-direction:column;align-items:center;"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#f56c6c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg><p style="margin-top:12px;">刪除失敗</p></div>',
          confirmButtonColor: '#409eff',
          confirmButtonText: '確定',
        })
      }
    }
  })
}
// 一鍵填入測試資料
const handleQuickFill = () => {
  const templates = [
    { name: '新春限時 8 折券', desc: '全店消費不限金額即可享有 8 折優惠', points: 50 },
    { name: '拿鐵咖啡買一送一', desc: '限中杯以上拿鐵，每人限領一次', points: 30 },
    { name: '百元抵用券', desc: '消費滿 500 元即可折抵 100 元', points: 100 },
    { name: '下午茶套餐組合優惠', desc: '指定蛋糕加飲料現折 50 元', points: 20 },
    { name: 'VIP 會員獨享禮', desc: '憑此券兌換精美好禮一份', points: 150 }
  ];

  const randomTpl = templates[Math.floor(Math.random() * templates.length)];
  const now = new Date();
  const future = new Date();
  future.setDate(now.getDate() + 60);
  const formatDate = (date) => date.toISOString().split('T')[0];

  editingDiscount.value = {
    ...editingDiscount.value,
    couponName: randomTpl.name,
    couponDescription: randomTpl.desc,
    pointsRequired: randomTpl.points,
    startDate: formatDate(now),
    endDate: formatDate(future),
    couponStatus: 1,
    merchantId: merchants.value.length > 0 ? merchants.value[merchants.value.length - 1].merchantId : null
  };
};

onMounted(() => {
  fetchDiscounts()
  fetchMerchants()
})
</script>

<style scoped>
/* ========== 頁面容器 ========== */
.discount-list-container {
  min-height: 100vh;
  background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
  padding: 20px;
}

/* ========== 頁面標題區 ========== */
.page-title-box {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 20px 24px;
  background: white;
  border-radius: 16px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  flex-wrap: wrap;
}
/*========= 標題圖示 ========== */
.title-icon {
  width: 64px;
  height: 64px;
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  color: white;
  background: linear-gradient(135deg, #e6a23c 0%, #f3d19e 100%);
  transition: all 0.4s ease;
  box-shadow: 0 4px 15px rgba(230, 162, 60, 0.3);
}

/*========= 標題內容 ========== */
.title-icon:hover {
  transform: scale(1.1) rotate(10deg);
}

.title-content {
  flex: 1;
  min-width: 200px;
}

.title-content h1 {
  margin: 0;
  font-size: 1.7rem;
  font-weight: 700;
  color: #303133;
}

.title-content .subtitle {
  margin: 6px 0 0;
  font-size: 0.9rem;
  color: #909399;
}

.title-actions {
  display: flex;
  gap: 10px;
}

.action-btn {
  border-radius: 12px;
  font-weight: 600;
  padding: 12px 24px;
  transition: all 0.3s ease;
}

.add-btn {
  background: linear-gradient(135deg, #67c23a 0%, #95d475 100%);
  border: none;
  box-shadow: 0 4px 15px rgba(103, 194, 58, 0.3);
}

.add-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(103, 194, 58, 0.4);
}

/* ========== 統計卡片 ========== */
.stat-card {
  position: relative;
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 20px;
  background: white;
  border-radius: 14px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
  transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  overflow: hidden;
  margin-bottom: 16px;
}

.stat-card:hover {
  transform: translateY(-6px);
  box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  border-radius: 4px 0 0 4px;
}

.total-card::before {
  background: linear-gradient(135deg, #e6a23c 0%, #f3d19e 100%);
}
.active-card::before {
  background: linear-gradient(135deg, #67c23a 0%, #95d475 100%);
}
.pending-card::before {
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
}
.ended-card::before {
  background: linear-gradient(135deg, #909399 0%, #c0c4cc 100%);
}

.stat-icon {
  width: 50px;
  height: 50px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  color: white;
}

.total-card .stat-icon {
  background: linear-gradient(135deg, #e6a23c 0%, #f3d19e 100%);
}
.active-card .stat-icon {
  background: linear-gradient(135deg, #67c23a 0%, #95d475 100%);
}
.pending-card .stat-icon {
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
}
.ended-card .stat-icon {
  background: linear-gradient(135deg, #909399 0%, #c0c4cc 100%);
}

.stat-info h3 {
  margin: 0;
  font-size: 1.8rem;
  font-weight: 700;
  color: #303133;
}

.stat-info span {
  font-size: 0.85rem;
  color: #909399;
}

/* ========== 表格卡片 ========== */
.table-card {
  border-radius: 16px;
  overflow: hidden;
  border: none;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
}

.card-header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 10px;
}

.header-icon {
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, #e6a23c 0%, #f3d19e 100%);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 16px;
}

.header-text {
  font-weight: 600;
  font-size: 1.1rem;
  color: #303133;
}

/* ========== 篩選區 ========== */
.filter-bar {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin-bottom: 20px;
  padding: 16px;
  background: #f8f9fa;
  border-radius: 12px;
}

.filter-input {
  width: 300px;
}

.filter-input :deep(.el-input__wrapper) {
  border-radius: 10px;
}

.search-btn {
  border-radius: 10px;
  font-weight: 500;
  background: linear-gradient(135deg, #e6a23c 0%, #f3d19e 100%);
  border: none;
}

.search-btn:hover {
  background: linear-gradient(135deg, #d48806 0%, #e6a23c 100%);
}

/* ========== 表格樣式 ========== */
.modern-table {
  border-radius: 12px;
  overflow: hidden;
}

.id-tag {
  font-size: 12px;
  color: #909399;
  font-weight: 600;
}

.coupon-img {
  width: 50px;
  height: 50px;
  border-radius: 8px;
  object-fit: cover;
  cursor: pointer;
  transition: transform 0.3s ease;
}

.coupon-img:hover {
  transform: scale(1.1);
}

.no-img {
  width: 50px;
  height: 50px;
  background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #c0c4cc;
  font-size: 18px;
}

.coupon-info-cell {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.coupon-name {
  font-weight: 600;
  color: #303133;
}

.coupon-desc {
  font-size: 12px;
  color: #909399;
  max-width: 200px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.merchant-tag {
  border-radius: 20px;
}

.points-text {
  font-weight: 700;
  color: #e6a23c;
  font-size: 16px;
}

.points-text small {
  font-weight: 400;
  font-size: 12px;
}

.status-tag {
  border-radius: 20px;
  padding: 4px 12px;
}

.date-cell {
  font-size: 12px;
  color: #606266;
  display: flex;
  align-items: center;
}

/* ========== 彈窗樣式 ========== */
.modern-dialog :deep(.el-dialog) {
  border-radius: 16px;
  overflow: hidden;
}

.modern-dialog :deep(.el-dialog__header) {
  background: linear-gradient(135deg, #e6a23c 0%, #f3d19e 100%);
  color: white;
  padding: 16px 20px;
}

.modern-dialog :deep(.el-dialog__title) {
  color: white;
  font-weight: 600;
}

.modern-dialog :deep(.el-dialog__headerbtn .el-dialog__close) {
  color: white;
}

.modern-form :deep(.el-form-item__label) {
  font-weight: 600;
  color: #303133;
}

.modern-form :deep(.el-input__wrapper),
.modern-form :deep(.el-textarea__inner),
.modern-form :deep(.el-select .el-input__wrapper) {
  border-radius: 10px;
}

.image-preview {
  display: flex;
  justify-content: center;
  padding: 16px;
  background: #f5f7fa;
  border-radius: 12px;
  margin-top: 16px;
}

.preview-img {
  max-height: 150px;
  border-radius: 8px;
}

.dialog-footer {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

.save-btn {
  background: linear-gradient(135deg, #e6a23c 0%, #f3d19e 100%);
  border: none;
  border-radius: 10px;
  padding: 10px 24px;
}

.save-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(230, 162, 60, 0.4);
}

/* ========== 動畫效果 ========== */
.fade-slide-enter-active {
  transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.fade-slide-leave-active {
  transition: all 0.3s ease-in;
}

.fade-slide-enter-from {
  transform: translateY(30px);
  opacity: 0;
}

.fade-slide-leave-to {
  transform: translateY(-20px);
  opacity: 0;
}

/* ========== 間距工具類 ========== */
.mb-4 {
  margin-bottom: 1.5rem;
}
.mr-1 {
  margin-right: 4px;
}
.mr-2 {
  margin-right: 8px;
}

/* ========== 顏色工具類 ========== */
.text-primary {
  color: #409eff;
}
.text-success {
  color: #67c23a;
}
.text-warning {
  color: #e6a23c;
}
.text-danger {
  color: #f56c6c;
}

/* ========== 響應式設計 ========== */
@media (max-width: 768px) {
  .page-title-box {
    flex-direction: column;
    text-align: center;
    gap: 16px;
  }

  .title-actions {
    width: 100%;
    justify-content: center;
  }

  .filter-bar {
    flex-direction: column;
  }

  .filter-input {
    width: 100%;
  }
 .upload-container {
  display: flex;
  flex-direction: column;
  gap: 8px;
  width: 100%;
}

.preview-box {
  position: relative;
  width: 100%;
  height: 120px; /* 固定預覽高度 */
  border-radius: 4px;
  overflow: hidden;
  border: 1px solid #dcdfe6;
}

.preview-img-fill {
  width: 100%;
  height: 100%;
}

.preview-overlay {
  position: absolute;
  top: 4px;
  right: 4px;
  background: rgba(0,0,0,0.5);
  color: white;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  font-size: 12px;
}
}
</style>
</file>

<file path="frontend/src/views/merchantAndCoupon/MerchantList.vue">
<script setup>
import { ref, onMounted, computed } from 'vue'
import { useRouter } from 'vue-router'
import axios from 'axios'
import Swal from 'sweetalert2'
import { Search } from '@element-plus/icons-vue'

const router = useRouter()

// 1. 狀態管理 - 確保初始化是空陣列 []，絕對不給 null
const allRawMerchants = ref([]) 
const loading = ref(false)
const searchQuery = ref('')
const dialogVisible = ref(false)
const isEdit = ref(false)
const formRef = ref(null)

// 2. 分頁狀態
const currentPage = ref(1)
const pageSize = ref(10)

// 3. 搜尋過濾邏輯 - 加入防錯機制 (?.)
const filteredMerchants = computed(() => {
  const list = allRawMerchants.value || [] // 如果是 undefined 就給空陣列
  if (!searchQuery.value) return list
  const q = searchQuery.value.toLowerCase()
  return list.filter(m => 
    (m.merchantName?.toLowerCase().includes(q)) ||
    (m.merchantAddress?.toLowerCase().includes(q))
  )
})

// 4. 強行分頁邏輯 - 你的 el-table :data 綁定這個
const merchantList = computed(() => {
  const list = filteredMerchants.value || []
  const start = (currentPage.value - 1) * pageSize.value
  const end = start + pageSize.value
  return list.slice(start, end)
})

// 5. 分頁器總筆數 - 加入防錯，確保不報 length 錯誤
const totalItems = computed(() => {
  return (filteredMerchants.value && filteredMerchants.value.length) ? filteredMerchants.value.length : 0
})

// 營運中商家統計 - 加入防錯
const activeMerchantsCount = computed(() => {
  const list = allRawMerchants.value || []
  return list.filter((m) => m.merchantStatus === 1).length
})

// 表單狀態
const form = ref({
  merchantId: null,
  merchantName: '',
  merchantPhone: '',
  merchantEmail: '',
  merchantAddress: '',
  merchantStatus: 1,
})

const rules = {
  merchantName: [{ required: true, message: '請輸入商家名稱', trigger: 'blur' }],
  merchantAddress: [{ required: true, message: '請輸入商家地址', trigger: 'blur' }]
}

// 獲取資料
const fetchMerchants = async () => {
  loading.value = true
  try {
    const res = await axios.get('http://localhost:8080/api/merchants')
    // 嚴格檢查回傳格式
    let data = []
    if (Array.isArray(res.data)) {
      data = res.data
    } else if (res.data && res.data.data) {
      data = res.data.data
    }
    allRawMerchants.value = data
  } catch (error) {
    console.error('獲取商家失敗:', error)
    Swal.fire('錯誤', '無法載入商家資料', 'error')
  } finally {
    loading.value = false
  }
}

// 搜尋與分頁處理
const handleSearch = () => {
  currentPage.value = 1
}

const resetSearch = () => {
  searchQuery.value = ''
  currentPage.value = 1
}

const handleSizeChange = (val) => {
  pageSize.value = val
  currentPage.value = 1
}

const handleCurrentChange = (val) => {
  currentPage.value = val
}

const goToMerchantCoupons = (merchantId) => {
  if (!merchantId) return
  router.push({ path: '/mall', query: { merchantId: merchantId } })
}

const openAddModal = () => {
  isEdit.value = false
  form.value = { merchantId: null, merchantName: '', merchantPhone: '', merchantEmail: '', merchantAddress: '', merchantStatus: 1 }
  dialogVisible.value = true
}

const openEditModal = (row) => {
  isEdit.value = true
  form.value = { ...row }
  dialogVisible.value = true
}

const submitForm = async () => {
  if (!formRef.value) return
  await formRef.value.validate(async (valid) => {
    if (!valid) return
    const isDuplicate = allRawMerchants.value.some(m => 
      (m.merchantName === form.value.merchantName || m.merchantAddress === form.value.merchantAddress) &&
      m.merchantId !== form.value.merchantId
    )
    if (isDuplicate) {
      Swal.fire('無法儲存', '店名或地址重複！', 'warning')
      return
    }
    try {
      if (isEdit.value) {
        await axios.put(`http://localhost:8080/api/merchants/${form.value.merchantId}`, form.value)
      } else {
        await axios.post('http://localhost:8080/api/merchants', form.value)
      }
      dialogVisible.value = false
      Swal.fire('成功', isEdit.value ? '資料已更新' : '商家已新增', 'success')
      fetchMerchants()
    } catch (error) {
      Swal.fire('錯誤', '操作失敗', 'error')
    }
  })
}

const deleteMerchant = (id, name) => {
  Swal.fire({
    title: '確定刪除？',
    text: `將刪除商家：${name}`,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: '確定',
    cancelButtonText: '取消',
  }).then(async (result) => {
    if (result.isConfirmed) {
      try {
        await axios.delete(`http://localhost:8080/api/merchants/${id}`)
        Swal.fire('已刪除', '', 'success')
        fetchMerchants()
      } catch (error) {
        Swal.fire('錯誤', '刪除失敗', 'error')
      }
    }
  })
}

const handleQuickFill = () => {
  form.value = {
    merchantName: '開心咖啡館',
    merchantPhone: '02-23456789',
    merchantEmail: 'happy.coffee@example.com',
    merchantAddress: '台北市中正區忠孝西路一段 118 號',
    merchantStatus: 1,
  }
}

onMounted(fetchMerchants)
</script>
<template>
  <div class="merchant-list-container">
    <section class="content-header">
      <div class="container-fluid">
        <div class="row align-items-center">
          <div class="col-12">
            <div class="page-title-box">
              <div class="title-icon">
                <i class="fas fa-store"></i>
              </div>
              <div class="title-content">
                <h1>商家管理系統</h1>
                <p class="subtitle">管理合作商家資訊與狀態</p>
              </div>
              <div class="title-actions">
                <el-button type="success" class="action-btn add-btn" @click="openAddModal()">
                  <i class="fas fa-plus mr-1"></i> 新增商家
                </el-button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="content">
      <div class="container-fluid">
        <transition name="fade-slide" appear>
          <div>
            <el-row :gutter="20" class="mb-4">
              <el-col :xs="12" :sm="6">
                <div class="stat-card total-card">
                  <div class="stat-icon"><i class="fas fa-store"></i></div>
                  <div class="stat-info">
                    <h3>{{ totalItems }}</h3>
                    <span>系統總筆數</span>
                  </div>
                </div>
              </el-col>
              <el-col :xs="12" :sm="6">
                <div class="stat-card active-card">
                  <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                  <div class="stat-info">
                    <h3>{{ activeMerchantsCount }}</h3>
                    <span>合作營運中</span>
                  </div>
                </div>
              </el-col>
              <el-col :xs="12" :sm="6">
                <div class="stat-card inactive-card">
                  <div class="stat-icon"><i class="fas fa-pause-circle"></i></div>
                  <div class="stat-info">
                    <h3>{{ totalItems - activeMerchantsCount }}</h3>
                    <span>停止合作</span>
                  </div>
                </div>
              </el-col>
            </el-row>

            <el-card shadow="hover" class="table-card">
              <template #header>
                <div class="card-header-content">
                  <div class="header-left">
                    <span class="header-icon"><i class="fas fa-list"></i></span>
                    <span class="header-text">商家列表</span>
                    <el-tag type="primary" effect="light" size="small" round
                      >{{ totalItems }} 筆</el-tag
                    >
                  </div>
                </div>
              </template>

              <div class="filter-bar">
                <el-input
                  v-model="searchQuery"
                  placeholder="搜尋名稱或地址..."
                  :prefix-icon="Search"
                  clearable
                  class="filter-input"
                  @keyup.enter="handleSearch"
                  @clear="handleSearch"
                />
                <el-button type="primary" @click="handleSearch" class="search-btn">
                  <i class="fas fa-search mr-1"></i> 搜尋
                </el-button>
                <el-button @click="resetSearch" class="reset-btn">
                  <i class="fas fa-redo mr-1"></i> 重置
                </el-button>
              </div>

              <el-table
                :data="merchantList"
                v-loading="loading"
                stripe
                highlight-current-row
                style="width: 100%"
                :header-cell-style="{ background: '#f5f7fa', fontWeight: 'bold', color: '#303133' }"
                class="modern-table"
              >
                <el-table-column prop="merchantId" label="ID" width="80" align="center">
                  <template #default="{ row }">
                    <span class="id-tag">#{{ row.merchantId }}</span>
                  </template>
                </el-table-column>

                <el-table-column prop="merchantName" label="商家名稱" min-width="150">
                  <template #default="{ row }">
                    <div
                      class="merchant-name-cell click-link"
                      @click="goToMerchantCoupons(row.merchantId)"
                      title="點擊前往商城查看優惠券"
                    >
                      <i class="fas fa-store text-primary mr-2"></i>
                      <span class="name-text">{{ row.merchantName }}</span>
                    </div>
                  </template>
                </el-table-column>

                <el-table-column prop="merchantAddress" label="地址" min-width="200">
                  <template #default="{ row }">
                    <div class="address-cell">
                      <i class="fas fa-map-marker-alt text-warning mr-2"></i>
                      <span>{{ row.merchantAddress || '-' }}</span>
                    </div>
                  </template>
                </el-table-column>
                
                <el-table-column prop="merchantPhone" label="電話" width="140">
                  <template #default="{ row }">
                    <span class="phone-text">
                      <i class="fas fa-phone mr-1"></i>{{ row.merchantPhone || '-' }}
                    </span>
                  </template>
                </el-table-column>

                <el-table-column prop="merchantStatus" label="狀態" width="120" align="center">
                  <template #default="{ row }">
                    <el-tag
                      :type="row.merchantStatus === 1 ? 'success' : 'danger'"
                      effect="light"
                      size="small"
                      class="status-tag"
                    >
                      <i :class="row.merchantStatus === 1 ? 'fas fa-check-circle' : 'fas fa-times-circle'" class="mr-1"></i>
                      {{ row.merchantStatus === 1 ? '營運中' : '停用中' }}
                    </el-tag>
                  </template>
                </el-table-column>

                <el-table-column label="操作" width="160" align="center" fixed="right">
                  <template #default="{ row }">
                    <el-button-group>
                      <el-button size="small" type="primary" @click="openEditModal(row)">
                        <i class="fas fa-edit"></i>
                      </el-button>
                      <el-button size="small" type="danger" @click="deleteMerchant(row.merchantId, row.merchantName)">
                        <i class="fas fa-trash-alt"></i>
                      </el-button>
                    </el-button-group>
                  </template>
                </el-table-column>
              </el-table>

              <div class="pagination-wrapper">
                <el-pagination
                  v-model:current-page="currentPage"
                  v-model:page-size="pageSize"
                  :page-sizes="[10, 20, 50]"
                  :total="totalItems"
                  layout="total, sizes, prev, pager, next, jumper"
                  @size-change="handleSizeChange"
                  @current-change="handleCurrentChange"
                  background
                />
              </div>
            </el-card>
          </div>
        </transition>
      </div>
    </section>

    <el-dialog
      v-model="dialogVisible"
      :title="isEdit ? `編輯商家 #${form.merchantId}` : '新增商家'"
      width="600px"
      class="modern-dialog"
      :close-on-click-modal="false"
    >
      <el-form 
        ref="formRef" 
        :model="form" 
        :rules="rules" 
        label-width="80px" 
        label-position="top" 
        class="modern-form"
      >
        <div style="margin-bottom: 15px; text-align: right;">
          <el-button type="info" plain size="small" @click="handleQuickFill" style="border-style: dashed;">
            <i class="fas fa-magic mr-1"></i> 一鍵填入測試資料
          </el-button>
        </div>
        <el-row :gutter="20">
          <el-col :span="12">
            <el-form-item label="商家名稱" prop="merchantName">
              <el-input v-model="form.merchantName" placeholder="請輸入商家名稱">
                <template #prefix><i class="fas fa-store"></i></template>
              </el-input>
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="聯絡電話">
              <el-input v-model="form.merchantPhone" placeholder="請輸入聯絡電話">
                <template #prefix><i class="fas fa-phone"></i></template>
              </el-input>
            </el-form-item>
          </el-col>
        </el-row>
        <el-form-item label="電子信箱">
          <el-input v-model="form.merchantEmail" placeholder="請輸入電子信箱">
            <template #prefix><i class="fas fa-envelope"></i></template>
          </el-input>
        </el-form-item>
        <el-form-item label="商家地址" prop="merchantAddress">
          <el-input
            v-model="form.merchantAddress"
            type="textarea"
            :rows="2"
            placeholder="請輸入商家地址"
          />
        </el-form-item>
        <el-form-item label="營運狀態">
          <el-select v-model="form.merchantStatus" placeholder="請選擇狀態" style="width: 100%">
            <el-option :value="1" label="營運中">營運中</el-option>
            <el-option :value="0" label="停用中">停用中</el-option>
          </el-select>
        </el-form-item>
      </el-form>
      <template #footer>
        <div class="dialog-footer">
          <el-button @click="dialogVisible = false">取消</el-button>
          <el-button type="primary" @click="submitForm" class="save-btn">
            儲存資料
          </el-button>
        </div>
      </template>
    </el-dialog>
  </div>
</template>

<style scoped>
/* ========== 頁面容器 ========== */
.merchant-list-container {
  min-height: 100vh;
  background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
  padding: 20px;
}

/* ========== 頁面標題區 ========== */
.page-title-box {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 20px 24px;
  background: white;
  border-radius: 16px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  flex-wrap: wrap;
}

.title-icon {
  width: 64px;
  height: 64px;
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  color: white;
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
  transition: all 0.4s ease;
  box-shadow: 0 4px 15px rgba(64, 158, 255, 0.3);
}

.title-icon:hover {
  transform: scale(1.1) rotate(10deg);
}

.title-content {
  flex: 1;
  min-width: 200px;
}

.title-content h1 {
  margin: 0;
  font-size: 1.7rem;
  font-weight: 700;
  color: #303133;
}

.title-content .subtitle {
  margin: 6px 0 0;
  font-size: 0.9rem;
  color: #909399;
}

.title-actions {
  display: flex;
  gap: 10px;
}

.action-btn {
  border-radius: 12px;
  font-weight: 600;
  padding: 12px 24px;
  transition: all 0.3s ease;
}

.add-btn {
  background: linear-gradient(135deg, #67c23a 0%, #95d475 100%);
  border: none;
  box-shadow: 0 4px 15px rgba(103, 194, 58, 0.3);
}

.add-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(103, 194, 58, 0.4);
}

/* ========== 統計卡片 ========== */
.stat-card {
  position: relative;
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 20px;
  background: white;
  border-radius: 14px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
  transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  overflow: hidden;
  margin-bottom: 16px;
}

.stat-card:hover {
  transform: translateY(-6px);
  box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  border-radius: 4px 0 0 4px;
}

.total-card::before {
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
}
.active-card::before {
  background: linear-gradient(135deg, #67c23a 0%, #95d475 100%);
}
.inactive-card::before {
  background: linear-gradient(135deg, #f56c6c 0%, #f89898 100%);
}

.stat-icon {
  width: 50px;
  height: 50px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  color: white;
}

.total-card .stat-icon {
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
}
.active-card .stat-icon {
  background: linear-gradient(135deg, #67c23a 0%, #95d475 100%);
}
.inactive-card .stat-icon {
  background: linear-gradient(135deg, #f56c6c 0%, #f89898 100%);
}

.stat-info h3 {
  margin: 0;
  font-size: 1.8rem;
  font-weight: 700;
  color: #303133;
}

.stat-info span {
  font-size: 0.85rem;
  color: #909399;
}

/* ========== 表格卡片 ========== */
.table-card {
  border-radius: 16px;
  overflow: hidden;
  border: none;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
}

.card-header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 10px;
}

.header-icon {
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 16px;
}

.header-text {
  font-weight: 600;
  font-size: 1.1rem;
  color: #303133;
}

/* ========== 篩選區 ========== */
.filter-bar {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin-bottom: 20px;
  padding: 16px;
  background: #f8f9fa;
  border-radius: 12px;
}

.filter-input {
  width: 300px;
}

.filter-input :deep(.el-input__wrapper) {
  border-radius: 10px;
}

.search-btn,
.reset-btn {
  border-radius: 10px;
  font-weight: 500;
}

/* ========== 表格樣式 ========== */
.modern-table {
  border-radius: 12px;
  overflow: hidden;
}

.id-tag {
  font-size: 12px;
  color: #909399;
  font-weight: 600;
}

.merchant-name-cell {
  display: flex;
  align-items: center;
}

/* [新增] 可點擊的樣式 */
.click-link {
  cursor: pointer;
  transition: all 0.2s;
  padding: 4px 0;
}

.click-link:hover .name-text {
  color: #409eff;
  text-decoration: underline;
}

.name-text {
  font-weight: 600;
  color: #303133;
  transition: color 0.2s;
}

.address-cell {
  display: flex;
  align-items: center;
  color: #606266;
}

.phone-text {
  color: #606266;
  font-size: 13px;
}

.email-text {
  color: #606266;
  font-size: 13px;
}

.status-tag {
  border-radius: 20px;
  padding: 4px 12px;
}

.pagination-wrapper {
  margin-top: 20px;
  display: flex;
  justify-content: center;
  padding-bottom: 20px;
}

/* ========== 彈窗樣式 ========== */
.modern-dialog :deep(.el-dialog) {
  border-radius: 16px;
  overflow: hidden;
}

.modern-dialog :deep(.el-dialog__header) {
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
  color: white;
  padding: 16px 20px;
}

.modern-dialog :deep(.el-dialog__title) {
  color: white;
  font-weight: 600;
}

.modern-dialog :deep(.el-dialog__headerbtn .el-dialog__close) {
  color: white;
}

.modern-form :deep(.el-form-item__label) {
  font-weight: 600;
  color: #303133;
}

.modern-form :deep(.el-input__wrapper),
.modern-form :deep(.el-textarea__inner),
.modern-form :deep(.el-select .el-input__wrapper) {
  border-radius: 10px;
}

.dialog-footer {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

.save-btn {
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
  border: none;
  border-radius: 10px;
  padding: 10px 24px;
}

.save-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(64, 158, 255, 0.4);
}

/* ========== 動畫效果 ========== */
.fade-slide-enter-active {
  transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.fade-slide-leave-active {
  transition: all 0.3s ease-in;
}

.fade-slide-enter-from {
  transform: translateY(30px);
  opacity: 0;
}

.fade-slide-leave-to {
  transform: translateY(-20px);
  opacity: 0;
}

/* ========== 間距工具類 ========== */
.mb-4 {
  margin-bottom: 1.5rem;
}
.mr-1 {
  margin-right: 4px;
}
.mr-2 {
  margin-right: 8px;
}

/* ========== 顏色工具類 ========== */
.text-primary {
  color: #409eff;
}
.text-success {
  color: #67c23a;
}
.text-warning {
  color: #e6a23c;
}
.text-danger {
  color: #f56c6c;
}

/* ========== 響應式設計 ========== */
@media (max-width: 768px) {
  .page-title-box {
    flex-direction: column;
    text-align: center;
    gap: 16px;
  }

  .title-actions {
    width: 100%;
    justify-content: center;
  }

  .filter-bar {
    flex-direction: column;
  }

  .filter-input {
    width: 100%;
  }
}
</style>
</file>

<file path="frontend/src/views/rec/RecRentUserPage.vue">
<script setup>
import { ref, onMounted, watch, computed } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { useMemberAuthStore } from '@/stores/memberAuth' // 引入 Store
import { useAdminAuthStore } from '@/stores/adminAuth' // 引入 Store

// --- Component Imports ---
import RecRentUserOrder from '@/components/rec/RecRentUserOrder.vue'
import RecRentUserComplete from '@/components/rec/RecRentUserComplete.vue'
import RecRentUserRecord from '@/components/rec/RecRentUserRecord.vue'

const route = useRoute()
const router = useRouter()
const memberAuthStore = useMemberAuthStore() // 初始化 Store
const adminAuthStore = useAdminAuthStore() // 初始化 Store
// --- 1. 狀態定義 (State Definitions) ---
// [修正] 根據路由參數初始化 activeView，避免預設 'order' 導致 RecRentUserOrder 在歸還模式下被錯誤掛載
// 這樣可以防止進入歸還頁面時，因為先渲染了租借頁面而觸發「有未歸還訂單」的防呆檢查
const activeView = ref(
  ['order', 'complete', 'record'].includes(route.params.action) ? route.params.action : 'order',
)

// --- 2. 視圖切換邏輯 (View Switching Logic) ---
const setActiveView = (view) => {
  activeView.value = view
}

// --- 3. 路由監聽 (Route Listener from UserPage) ---
onMounted(() => {
  // [新增] 進入頁面時，若 URL 有 spotId，同步到 Pinia；若 URL 沒有但 Pinia 有，則保留 Pinia 的值
  if (route.query.spotId) {
    memberAuthStore.setSpotId(route.query.spotId)
  }
})

watch(
  () => route.params.action,
  (newAction) => {
    if (newAction === 'order' || newAction === 'complete' || newAction === 'record') {
      setActiveView(newAction)
    }
  },
)

// [新增] 監聽 URL 的 spotId 變化，隨時同步回 Pinia (例如使用者手動改網址)
watch(
  () => route.query.spotId,
  (newId) => {
    if (newId) {
      memberAuthStore.setSpotId(newId)
    }
  },
)

// [新增] 統一取得目前的 SpotId (優先看 URL，沒有則看 Pinia)
const currentSpotId = computed(() => {
  return route.query.spotId || memberAuthStore.selectedSpotId
})

// --- 4. Computed for router-link ---
const orderRoute = computed(() => {
  const r = { name: 'rec-rent-user', params: { action: 'order' } }
  // [修改] 使用 currentSpotId 確保切換時帶上 ID
  if (currentSpotId.value) {
    r.query = { spotId: currentSpotId.value }
  }
  return r
})

// [新增] 歸還頁面的路由物件，確保切換時也帶上 spotId
const completeRoute = computed(() => {
  const r = { name: 'rec-rent-user', params: { action: 'complete' } }
  if (currentSpotId.value) {
    r.query = { spotId: currentSpotId.value }
  }
  return r
})

// [新增] 紀錄頁面的路由物件
const recordRoute = computed(() => {
  const r = { name: 'rec-rent-user', params: { action: 'record' } }
  if (currentSpotId.value) {
    r.query = { spotId: currentSpotId.value }
  }
  return r
})
</script>

<template>
  <div class="top-nav">
    <!-- 還原為 router-link，用於頁面內部切換 -->
    <router-link :to="orderRoute" custom v-slot="{ navigate }">
      <button
        @click="navigate"
        :class="{ active: activeView === 'order' }"
        :disabled="activeView === 'order'"
      >
        租借＠Seat
      </button>
    </router-link>
    <router-link :to="completeRoute" custom v-slot="{ navigate }">
      <button
        @click="navigate"
        :class="{ active: activeView === 'complete' }"
        :disabled="activeView === 'complete'"
      >
        歸還＠Seat
      </button>
    </router-link>
    <router-link :to="recordRoute" custom v-slot="{ navigate }">
      <button
        @click="navigate"
        :class="{ active: activeView === 'record' }"
        :disabled="activeView === 'record'"
      >
        我的租借紀錄
      </button>
    </router-link>
  </div>

  <div class="rec-rent-container">
    <div class="main-content">
      <h1>＠Seat 租借服務</h1>

      <!-- Views from UserPage -->
      <div v-if="activeView === 'order'" class="view-section">
        <!-- 傳遞 spotId 給子元件，會員資訊由子元件自行從 store 獲取 -->
        <!-- [修改] 改用 currentSpotId，這樣即使 URL 暫時沒有 query，只要 Pinia 有值也能顯示 -->
        <rec-rent-user-order v-if="currentSpotId" :spot-id="String(currentSpotId)" />
        <div v-else class="alert alert-info">請先至「站點地圖」選擇一個租借站點。</div>
        <router-link to="/SearchSpot" class="btn btn-primary">前往地圖</router-link>
      </div>
      <div v-if="activeView === 'complete'" class="view-section">
        <rec-rent-user-complete />
      </div>
      <div v-if="activeView === 'record'" class="view-section">
        <rec-rent-user-record />
      </div>
    </div>
  </div>
</template>

<style scoped>
/* General container and navigation styles */
.rec-rent-container {
  display: flex;
  flex-direction: column;
  /* height: 100%; */ /* 移除，讓內容自然撐高 */
  width: 100%;
  font-family: 'Microsoft JhengHei', Arial, sans-serif;
  background-color: #f9f9f9;
}

.top-nav {
  width: 100%;
  background-color: #acacac;
  color: white;
  display: flex;
  padding-top: 0px;
  flex-shrink: 0;
}

.top-nav button {
  background-color: #01e68e;
  color: #2b2b2b;
  font-size: 25px;
  font-weight: 500;
  display: flex;
  margin: 10px;
  border: none;
  cursor: pointer;
}

.top-nav button:disabled,
.top-nav button.active {
  background-color: #00ff9d;
  color: black;
  font-weight: bold;
  cursor: not-allowed;
}

.top-nav button:not(:disabled):not(.active):hover {
  background-color: #5dffc4;
}

.main-content {
  flex: 1;
  padding: 20px;
  /* overflow-y: auto; */ /* 移除，交由 MainLayout 滾動 */
}

.view-section {
  display: block;
}
</style>
</file>

<file path="frontend/src/views/rec/RightsClaimPage.vue">
<template>

        <p>
1. 租賃與歸還認定
租借自 WebApp 顯示訂單時起算。歸還須確保 完全插入機台鎖槽 且 App 彈出「結案單」方視為終止。若因使用者原因導致被他人取走，使用者應負遺失賠償之責。
2. 費率計算
採分段計費制：
● 第一階段：0-30 分鐘，固定收費 NT$45。
● 第二階段：30 分鐘後，每 30 分鐘 NT$30。
● 跨日累計：若超過 24 小時未歸還，除租金外，本公司有權先行鎖定帳號。
3. 使用者檢查義務
使用者取車/取物後應立即檢查。若發現損壞應透過 App 「報修功能」上傳照片。10 分鐘後未報修則視為領取時設備完好。
4. 維修與損害賠償
1. 正常耗損由本公司負擔。
2. 遺失或人為毀損（如塗鴉、切割、支架彎曲）：賠償金 NT$1,500。
3. 若因違規使用（如站立）導致他人受傷，由使用者承擔法律責任。
5. 業者維護責任
本公司承諾定期巡檢設備安全，但 不擔保 設備於租借期間因非預見因素產生的突發故障。若發生故障，使用者應立即停止使用。
6. 爭議處理
若對費用有爭議，應於扣款後 14 日內 提出。本條款以中華民國法律為準，以 台灣桃園地方法院 為第一審管轄法院。</p>
<p>
二、 使用者隱私權政策與個資蒐集聲明
根據《個資法》第 8 條規定，您必須在 App 註冊頁面告知以下事項：
1. 蒐集目的與類別
蒐集目的： 租賃服務管理、金流扣款、設備追蹤、客服爭議處理、行銷活動推送。
個資類別： 姓名、聯絡電話、電子郵件、地理位置（GPS）、信用卡號或第三方支付代碼。
2. 利用期間與地區
期間： 會員帳號有效期間內及法律規定之保存期限依會計法規定。
地區： 台灣地區及本公司委託之雲端伺服器所在地。
3. 使用者權利
您可隨時透過 App 設定或聯繫客服行使：查詢、閱覽、製給複製本、補充、更正、停止蒐集處理或利用、刪除個人資料之權利。
4. 設備位置追蹤
為確保資產安全，本服務將於「租借期間」內記錄設備之位置資訊。歸還完成後，系統將停止主動追蹤該次行程位置。

</p>
</template>

<script setup>

</script>

<style scoped>

</style>
</file>

<file path="frontend/src/views/spot/SeatForm.vue">
<template>
  <div class="seat-form-container">
    <!-- ========== Header 區域 ========== -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row align-items-center">
          <div class="col-sm-6">
            <div class="page-title-box">
              <div class="title-icon" :class="isEditMode ? 'edit-mode' : 'add-mode'">
                <i :class="isEditMode ? 'fas fa-edit' : 'fas fa-plus-circle'"></i>
              </div>
              <div class="title-content">
                <h1>{{ isEditMode ? '修改座位' : '新增座位' }}</h1>
                <p class="subtitle">{{ isEditMode ? '修改座位資訊' : '建立新的座位設備' }}</p>
              </div>
            </div>
          </div>
          <div class="col-sm-6 text-right">
            <el-button @click="goBack">
              <i class="fas fa-arrow-left mr-1"></i> 返回列表
            </el-button>
          </div>
        </div>
      </div>
    </section>

    <section class="content">
      <div class="container-fluid">
        <transition name="zoom-fade" appear>
          <el-card shadow="hover" class="form-card">
            <el-form
              :model="formData"
              label-width="120px"
              label-position="top"
              class="modern-form"
              @submit.prevent="handleSubmit"
            >
              <!-- ========== 基本資料區 ========== -->
              <div class="form-section">
                <div class="section-header">
                  <i class="fas fa-info-circle"></i>
                  <span>基本資料</span>
                </div>

                <!-- 所屬據點 (下拉選單) -->
                <el-form-item label="所屬據點" required>
                  <el-select v-model="formData.spotId" placeholder="請選擇據點" style="width: 100%">
                    <el-option
                      v-for="spot in spotList"
                      :key="spot.spotId"
                      :label="`${spot.spotName} (ID: ${spot.spotId})`"
                      :value="spot.spotId"
                    />
                  </el-select>
                </el-form-item>

                <el-row :gutter="20">
                  <el-col :span="12">
                    <!-- 座位名稱 -->
                    <el-form-item label="座位名稱" required>
                      <el-input v-model="formData.seatsName" placeholder="例如：A-01" clearable>
                        <template #prefix><i class="fas fa-chair"></i></template>
                      </el-input>
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <!-- 序號 -->
                    <el-form-item label="序號">
                      <el-input v-model="formData.serialNumber" :placeholder="isEditMode ? '例如：SN-2023001' : '留空則自動產生 (例如：SN-2026001)'" clearable>
                        <template #prefix><i class="fas fa-barcode"></i></template>
                      </el-input>
                    </el-form-item>
                  </el-col>
                </el-row>

                <el-row :gutter="20">
                  <el-col :span="12">
                    <!-- 類型 -->
                    <el-form-item label="類型" required>
                      <el-input v-model="formData.seatsType" placeholder="例如:高腳椅、塑膠椅..." clearable>
                        <template #prefix><i class="fas fa-couch"></i></template>
                      </el-input>
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <!-- 狀態 -->
                    <el-form-item label="狀態">
                      <el-select v-model="formData.seatsStatus" style="width: 100%">
                        <el-option label="啟用" value="啟用">
                          <i class="fas fa-check-circle text-success mr-2"></i> 啟用
                        </el-option>
                        <el-option label="停用" value="停用">
                          <i class="fas fa-ban text-danger mr-2"></i> 停用
                        </el-option>
                        <el-option label="維修中" value="維修中">
                          <i class="fas fa-tools text-warning mr-2"></i> 維修中
                        </el-option>
                      </el-select>
                    </el-form-item>
                  </el-col>
                </el-row>
              </div>

              <!-- ========== 按鈕區 ========== -->
              <div class="form-actions">
                <el-button @click="goBack" class="back-btn">
                  <i class="fas fa-times mr-1"></i> 取消
                </el-button>
                <el-button type="primary" @click="handleSubmit" :loading="isSubmitting" class="submit-btn">
                  <i class="fas fa-save mr-1"></i> {{ isSubmitting ? '儲存中...' : '儲存' }}
                </el-button>
              </div>
            </el-form>
          </el-card>
        </transition>
      </div>
    </section>
  </div>
</template>

<script setup>
import { ref, onMounted, computed } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import axios from 'axios'
import Swal from 'sweetalert2'

const route = useRoute()
const router = useRouter()

// 明確定義元件名稱，方便識別與除錯
defineOptions({
  name: 'SeatForm'
})

// 判斷是否為編輯模式 (網址有 id 參數)
const isEditMode = computed(() => !!route.params.id)

// 表單資料
const formData = ref({
  seatsName: '',
  seatsType: '',
  seatsStatus: '啟用',
  spotId: '',
  serialNumber: '',
})

// 防止重複提交的狀態
const isSubmitting = ref(false)

// 據點列表 (供下拉選單使用)
const spotList = ref([])

// 初始化
onMounted(async () => {
  await fetchSpots()
  
  if (isEditMode.value) {
    await fetchSeatData(route.params.id)
  }
})

// 取得所有據點 (用於下拉選單)
const fetchSpots = async () => {
  try {
    const res = await axios.get('/api/spot/list')
    spotList.value = res.data
  } catch (err) {
    console.error('無法取得據點列表:', err)
    Swal.fire({
      title: '載入失敗',
      html: '<div style="display:flex;flex-direction:column;align-items:center;"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#f56c6c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg><p style="margin-top:12px;">無法載入據點列表，請檢查後端連線</p></div>',
      confirmButtonColor: '#409eff',
      confirmButtonText: '確定'
    })
  }
}

// 取得單一座位資料 (編輯模式用)
const fetchSeatData = async (id) => {
  if (!id) {
    console.warn('未提供座位ID，無法取得資料')
    return
  }
  try {
    const res = await axios.get(`/api/seats/${id}`)
    // 將後端資料填入表單
    formData.value = {
      seatsId: res.data.seatsId, // 雖然表單不顯示，但更新時可能需要
      seatsName: res.data.seatsName,
      seatsType: res.data.seatsType,
      seatsStatus: res.data.seatsStatus,
      spotId: res.data.spotId,
      serialNumber: res.data.serialNumber,
    }
  } catch (err) {
    console.error('無法取得座位資料:', err)
    Swal.fire({
      title: '讀取失敗',
      html: '<div style="display:flex;flex-direction:column;align-items:center;"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#f56c6c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg><p style="margin-top:12px;">無法讀取座位資料</p></div>',
      confirmButtonColor: '#409eff',
      confirmButtonText: '確定'
    })
    router.push('/admin/seat/list')
  }
}

// 送出表單
const handleSubmit = async () => {
  if (isSubmitting.value) return
  isSubmitting.value = true

  // [優化] 建立一個乾淨的 payload，避免直接修改 ref
  const payload = { ...formData.value };

  // [修正] 如果序號為空字串，應轉為 null 送出，以符合資料庫的唯一索引篩選 (WHERE serialNumber IS NOT NULL)
  // 避免多筆空字串資料違反唯一約束
  if (payload.serialNumber === '') {
    payload.serialNumber = null;
  }

  try {
    if (isEditMode.value) {
      // 更新 (PUT)
      const seatId = route.params.id
      await axios.put(`/api/seats/${seatId}`, payload)
      await Swal.fire({
        title: '更新成功',
        html: '<div style="display:flex;flex-direction:column;align-items:center;"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#67c23a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg><p style="margin-top:12px;">座位資料已成功更新</p></div>',
        confirmButtonColor: '#409eff',
        confirmButtonText: '確定'
      })
    } else {
      // 新增 (POST)
      await axios.post('/api/seats', payload)
      await Swal.fire({
        title: '新增成功',
        html: '<div style="display:flex;flex-direction:column;align-items:center;"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#67c23a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg><p style="margin-top:12px;">座位資料已成功新增</p></div>',
        confirmButtonColor: '#409eff',
        confirmButtonText: '確定'
      })
    }
    // 成功後返回列表
    router.push('/admin/seat/list')
  } catch (err) {
    console.error('儲存失敗:', err)
    // [優化] 顯示更詳細的錯誤訊息
    const errorMsg = err.response?.data?.message || '儲存失敗，請檢查輸入資料或後端連線';
    Swal.fire({
      title: '儲存失敗',
      html: `<div style="display:flex;flex-direction:column;align-items:center;"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#f56c6c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg><p style="margin-top:12px;">${errorMsg}</p></div>`,
      confirmButtonColor: '#409eff',
      confirmButtonText: '確定'
    })
  } finally {
    isSubmitting.value = false
  }
}

const goBack = () => {
  router.back()
}
</script>

<style scoped>
/* ========== 頁面容器 ========== */
.seat-form-container {
  padding: 20px;
  background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
  min-height: 100vh;
}

/* ========== 頁面標題區 ========== */
.page-title-box {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 16px 24px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
}

.title-icon {
  width: 56px;
  height: 56px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  color: white;
  transition: transform 0.3s ease;
}

.title-icon:hover {
  transform: scale(1.1) rotate(5deg);
}

.add-mode {
  background: linear-gradient(135deg, #67c23a 0%, #95d475 100%);
}

.edit-mode {
  background: linear-gradient(135deg, #e6a23c 0%, #f3d19e 100%);
}

.title-content h1 {
  margin: 0;
  font-size: 1.5rem;
  font-weight: 600;
  color: #303133;
}

.title-content .subtitle {
  margin: 4px 0 0;
  font-size: 0.875rem;
  color: #909399;
}

/* ========== 表單卡片 ========== */
.form-card {
  border-radius: 12px;
  max-width: 800px;
  margin: 0 auto;
}

.form-section {
  margin-bottom: 32px;
}

.section-header {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 1.1rem;
  font-weight: 600;
  color: #409eff;
  margin-bottom: 20px;
  padding-bottom: 12px;
  border-bottom: 2px solid #409eff;
}

/* ========== 按鈕區 ========== */
.form-actions {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  padding-top: 24px;
  margin-top: 24px;
  border-top: 1px solid #ebeef5;
}

.submit-btn {
  min-width: 120px;
  border-radius: 10px;
  font-weight: 600;
  background: linear-gradient(135deg, #67c23a 0%, #95d475 100%);
  border: none;
  transition: all 0.3s ease;
}

.submit-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(103, 194, 58, 0.4);
}

.back-btn {
  min-width: 100px;
  border-radius: 10px;
}

/* ========== 動畫效果 ========== */
.zoom-fade-enter-active {
  transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.zoom-fade-leave-active {
  transition: all 0.3s ease-in;
}

.zoom-fade-enter-from {
  transform: scale(0.9);
  opacity: 0;
}

.zoom-fade-leave-to {
  transform: scale(0.95);
  opacity: 0;
}

/* ========== 工具類 ========== */
.mr-1 { margin-right: 4px; }
.mr-2 { margin-right: 8px; }
.text-success { color: #67c23a; }
.text-warning { color: #e6a23c; }
.text-danger { color: #f56c6c; }

/* ========== 響應式設計 ========== */
@media (max-width: 768px) {
  .page-title-box {
    flex-direction: column;
    text-align: center;
    gap: 12px;
  }
}
</style>
</file>

<file path="frontend/src/views/spot/SeatList.vue">
<template>
  <div class="seat-list-container">
    <!-- ========== Header 區域 ========== -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row align-items-center">
          <div class="col-sm-6">
            <div class="page-title-box">
              <div class="title-icon view-mode">
                <i class="fas fa-chair"></i>
              </div>
              <div class="title-content">
                <h1>座位管理列表</h1>
                <p class="subtitle">管理所有座位設備資訊</p>
              </div>
            </div>
          </div>
          <div class="col-sm-6 text-right">
            <el-button type="primary" @click="goToAdd" class="add-btn">
              <i class="fas fa-plus mr-1"></i> 新增座位
            </el-button>
          </div>
        </div>
      </div>
    </section>

    <section class="content">
      <div class="container-fluid">
        <transition name="fade-slide" appear>
          <div>
            <!-- ========== 主要表格卡片 ========== -->
            <el-card shadow="hover" class="table-card">
              <!-- 搜尋區塊 -->
              <!-- [修改] 參考 SpotList.vue 的搜尋介面 -->
              <div class="toolbar">
                <div class="search-controls">
                  <el-input
                    v-model="searchKeyword"
                    placeholder="搜尋名稱、類型或序號"
                    clearable
                    prefix-icon="Search"
                    class="search-input"
                  />
                  <el-input
                    v-model.number="searchSpotId"
                    placeholder="搜尋據點ID"
                    type="number"
                    :min="1"
                    clearable
                    class="search-input-sm"
                    @input="sanitizeSpotId"
                  />
                  <el-select v-model="searchStatus" placeholder="全部狀態" clearable class="search-select">
                    <el-option label="啟用" value="啟用" />
                    <el-option label="停用" value="停用" />
                    <el-option label="維修中" value="維修中" />
                  </el-select>
                </div>
              </div>

              <!-- 表格 -->
              <el-table
                :data="paginatedSeats"
                v-loading="loading"
                stripe
                style="width: 100%"
                :header-cell-style="{ background: '#f5f7fa', fontWeight: 'bold', color: '#303133' }"
                class="modern-table"
              >
                <el-table-column prop="seatsId" label="ID" width="70" align="center" />
                <el-table-column prop="seatsName" label="名稱" min-width="120">
                  <template #default="{ row }">
                    <div class="seat-name-cell">
                      <i class="fas fa-chair text-primary mr-2"></i>
                      <span>{{ row.seatsName }}</span>
                    </div>
                  </template>
                </el-table-column>
                <el-table-column prop="seatsType" label="類型" width="120" />
                <el-table-column prop="serialNumber" label="序號" width="140" />
                <!-- 建議後端 DTO 回傳 spotName，若無則顯示 ID -->
                <el-table-column label="所屬據點 ID" width="120" align="center">
                  <template #default="{ row }">
                    <el-tag type="info" size="small" effect="plain">
                      {{ row.spotName || row.spotId }}
                    </el-tag>
                  </template>
                </el-table-column>
                <el-table-column prop="seatsStatus" label="設備狀態" width="100" align="center">
                  <!-- 增加對後端可能回傳 1/0 或 ACTIVE/INACTIVE 的相容性判斷 -->
                  <template #default="{ row }">
                    <el-tag
                      :type="(row.seatsStatus === '啟用' || row.seatsStatus === 1 || row.seatsStatus === 'ACTIVE') ? 'success' : (row.seatsStatus === '維修中' ? 'warning' : 'danger')"
                      size="small"
                      effect="light"
                    >
                      {{ row.seatsStatus }}
                    </el-tag>
                  </template>
                </el-table-column>
                <el-table-column label="操作" width="180" align="center" fixed="right">
                  <template #default="{ row }">
                    <el-button-group>
                      <!-- [新增] 詳細按鈕 -->
                      <el-tooltip content="檢視" placement="top">
                        <el-button size="small" type="info" @click="goToView(row.seatsId)">
                          <i class="fas fa-eye"></i>
                        </el-button>
                      </el-tooltip>
                      <!-- [新增] 編輯按鈕 -->
                      <el-tooltip content="編輯" placement="top">
                        <el-button size="small" type="primary" @click="goToEdit(row.seatsId)">
                          <i class="fas fa-edit"></i>
                        </el-button>
                      </el-tooltip>
                      <el-tooltip content="刪除" placement="top">
                        <el-button size="small" type="danger" @click="deleteSeat(row.seatsId)">
                          <i class="fas fa-trash-alt"></i>
                        </el-button>
                      </el-tooltip>
                    </el-button-group>
                  </template>
                </el-table-column>
              </el-table>

              <el-empty v-if="filteredSeats.length === 0 && !loading" description="目前沒有符合條件的座位資料" />

              <!-- 分頁元件 -->
              <div class="pagination-wrapper" v-if="total > 0">
                <el-pagination
                  v-model:current-page="currentPage"
                  v-model:page-size="pageSize"
                  :page-sizes="[10, 20, 50, 100]"
                  :total="total"
                  layout="total, sizes, prev, pager, next, jumper"
                  background
                  @size-change="handleSizeChange"
                  @current-change="handlePageChange"
                />
              </div>
            </el-card>
          </div>
        </transition>
      </div>
    </section>
  </div>
</template>

<script setup>
import { ref, onMounted, computed } from 'vue'
import { useRouter } from 'vue-router' // [新增] 引入 useRouter
import axios from 'axios'
import Swal from 'sweetalert2' // 假設您有安裝，若無可改用 alert

// 明確定義元件名稱
defineOptions({
  name: 'SeatList'
})

const router = useRouter() // [新增] 初始化 router
const seats = ref([])
const loading = ref(false)

// 分頁狀態
const currentPage = ref(1)
const pageSize = ref(10)

// [新增] 參考 SpotList.vue 的搜尋狀態
const searchKeyword = ref('')
const searchSpotId = ref('')
const searchStatus = ref('')

// [新增] 參考 SpotList.vue 的數字輸入處理函式，並調整變數名稱
const sanitizeSpotId = () => {
  const v = searchSpotId.value
  if (v === '' || v === null || v === undefined) return

  if (!Number.isFinite(v) || v < 1) {
    searchSpotId.value = 1
  }
}

// [新增] 跳轉到詳細頁 (使用具名路由，更安全)
const goToView = (id) => {
  router.push({ name: 'seat-view', params: { id } })
}

// [新增] 跳轉到編輯頁
const goToEdit = (id) => {
  router.push({ name: 'seat-edit', params: { id } })
}

// [新增] 跳轉到新增頁
const goToAdd = () => {
  router.push({ name: 'seat-insert' })
}

// 查詢座位
const fetchSeats = async () => {
  loading.value = true
  try {
    // [修改] 為了實現前端過濾，移除請求參數，一次性獲取所有資料
    const res = await axios.get('/api/seats/search')
    seats.value = res.data
  } catch (err) {
    console.error('載入失敗:', err)
    Swal.fire({
      title: '錯誤',
      html: '<div style="display:flex;flex-direction:column;align-items:center;"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#f56c6c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg><p style="margin-top:12px;">無法載入座位列表</p></div>',
      confirmButtonColor: '#409eff',
      confirmButtonText: '確定'
    })
  } finally {
    loading.value = false
  }
}

// [新增] 參考 SpotList.vue 的計算屬性，並根據 Seat 的欄位調整過濾邏輯
const filteredSeats = computed(() => {
  let results = seats.value

  // 1. 關鍵字過濾 (對應 Seat 的名稱、類型、序號)
  if (searchKeyword.value.trim()) {
    const keyword = searchKeyword.value.toLowerCase().trim()
    results = results.filter(
      (seat) =>
        seat.seatsName?.toLowerCase().includes(keyword) ||
        seat.seatsType?.toLowerCase().includes(keyword) ||
        seat.serialNumber?.toLowerCase().includes(keyword)
    )
  }

  // 2. 據點 ID 過濾 (對應 Seat 的 spotId)
  if (searchSpotId.value !== '' && searchSpotId.value !== null) {
    const sId = Number(searchSpotId.value)
    results = results.filter((seat) => Number(seat.spotId) === sId)
  }

  // 3. 狀態過濾 (對應 Seat 的 seatsStatus)
  if (searchStatus.value) {
    results = results.filter((seat) => seat.seatsStatus === searchStatus.value)
  }

  return results
})

// 分頁後的資料
const paginatedSeats = computed(() => {
  const start = (currentPage.value - 1) * pageSize.value
  const end = start + pageSize.value
  return filteredSeats.value.slice(start, end)
})

// 總筆數
const total = computed(() => filteredSeats.value.length)

// 分頁切換處理
const handlePageChange = (page) => {
  currentPage.value = page
}

const handleSizeChange = (size) => {
  pageSize.value = size
  currentPage.value = 1
}

// 刪除座位
const deleteSeat = async (id) => {
  const result = await Swal.fire({
    title: '確定刪除?',
    html: '<div style="display:flex;flex-direction:column;align-items:center;"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#e6a23c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg><p style="margin-top:12px;">刪除後將無法復原！</p></div>',
    showCancelButton: true,
    confirmButtonColor: '#f56c6c',
    cancelButtonColor: '#909399',
    confirmButtonText: '是的，刪除',
    cancelButtonText: '取消'
  })

  if (result.isConfirmed) {
    try {
      await axios.delete(`/api/seats/${id}`)
      Swal.fire({
        title: '已刪除',
        html: '<div style="display:flex;flex-direction:column;align-items:center;"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#67c23a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg><p style="margin-top:12px;">該座位已被移除</p></div>',
        confirmButtonColor: '#409eff',
        confirmButtonText: '確定'
      })
      fetchSeats() // 重新整理列表
    } catch (err) {
      Swal.fire({
        title: '失敗',
        html: '<div style="display:flex;flex-direction:column;align-items:center;"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#f56c6c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg><p style="margin-top:12px;">刪除失敗，可能尚有相關聯的訂單</p></div>',
        confirmButtonColor: '#409eff',
        confirmButtonText: '確定'
      })
    }
  }
}

onMounted(() => {
  fetchSeats()
})
</script>

<style scoped>
/* ========== 頁面容器 ========== */
.seat-list-container {
  padding: 20px;
  background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
  min-height: 100vh;
}

/* ========== 頁面標題區 ========== */
.page-title-box {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 16px 24px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
}

.title-icon {
  width: 56px;
  height: 56px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  color: white;
  transition: transform 0.3s ease;
}

.title-icon:hover {
  transform: scale(1.1) rotate(5deg);
}

.view-mode {
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
}

.title-content h1 {
  margin: 0;
  font-size: 1.5rem;
  font-weight: 600;
  color: #303133;
}

.title-content .subtitle {
  margin: 4px 0 0;
  font-size: 0.875rem;
  color: #909399;
}

/* ========== 新增按鈕 ========== */
.add-btn {
  border-radius: 10px;
  font-weight: 600;
  padding: 12px 24px;
  background: linear-gradient(135deg, #67c23a 0%, #95d475 100%);
  border: none;
  transition: all 0.3s ease;
}

.add-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(103, 194, 58, 0.4);
}

/* ========== 表格卡片 ========== */
.table-card {
  border-radius: 12px;
  overflow: hidden;
}

.toolbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 1px solid #ebeef5;
}

.search-controls {
  display: flex;
  gap: 12px;
  align-items: center;
}

.search-input {
  width: 220px;
}

.search-input-sm {
  width: 120px;
}

.search-select {
  width: 140px;
}

/* ========== 表格樣式 ========== */
.modern-table {
  border-radius: 8px;
  overflow: hidden;
}

.seat-name-cell {
  display: flex;
  align-items: center;
}

.text-primary {
  color: #409eff;
}

/* ========== 動畫效果 ========== */
.fade-slide-enter-active {
  transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.fade-slide-leave-active {
  transition: all 0.3s ease-in;
}

.fade-slide-enter-from {
  transform: translateY(20px);
  opacity: 0;
}

.fade-slide-leave-to {
  transform: translateY(-10px);
  opacity: 0;
}

/* ========== 間距工具類 ========== */
.mr-1 { margin-right: 4px; }
.mr-2 { margin-right: 8px; }

/* ========== 分頁樣式 ========== */
.pagination-wrapper {
  display: flex;
  justify-content: flex-end;
  margin-top: 20px;
  padding-top: 16px;
  border-top: 1px solid #ebeef5;
}

/* ========== 響應式設計 ========== */
@media (max-width: 768px) {
  .page-title-box {
    flex-direction: column;
    text-align: center;
    gap: 12px;
  }
  
  .toolbar {
    flex-direction: column;
    gap: 12px;
  }
  
  .search-controls {
    flex-wrap: wrap;
    width: 100%;
  }
  
  .search-input,
  .search-input-sm,
  .search-select {
    width: 100%;
  }
}
</style>
</file>

<file path="frontend/src/views/spot/SpotList.vue">
<template>
  <div class="spot-list-container">
    <!-- ========== Header 區域 ========== -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row align-items-center">
          <div class="col-sm-6">
            <div class="page-title-box">
              <div class="title-icon view-mode">
                <i class="fas fa-map-marker-alt"></i>
              </div>
              <div class="title-content">
                <h1>據點管理列表</h1>
                <p class="subtitle">管理所有營業據點資訊</p>
              </div>
            </div>
          </div>
          <div class="col-sm-6 text-right">
            <!-- 點擊新增，跳轉到 SpotForm (無 ID) -->
            <el-button type="primary" @click="goToAdd" class="add-btn">
              <i class="fas fa-plus mr-1"></i> 新增據點
            </el-button>
          </div>
        </div>
      </div>
    </section>

    <section class="content">
      <div class="container-fluid">
        <!-- ========== 數據摘要區 ========== -->
        <div class="stats-overview">
          <div class="stat-box blue">
            <div class="stat-icon"><i class="fas fa-building"></i></div>
            <div class="stat-info">
              <span class="stat-label">據點總數</span>
              <span class="stat-value">{{ statsSummary.totalSpots }}</span>
            </div>
          </div>
          <div class="stat-box orange">
            <div class="stat-icon"><i class="fas fa-wrench"></i></div>
            <div class="stat-info">
              <span class="stat-label">維修中據點</span>
              <span class="stat-value">{{ statsSummary.maintenance }}</span>
            </div>
          </div>
          <div class="stat-box purple">
            <div class="stat-icon"><i class="fas fa-chair"></i></div>
            <div class="stat-info">
              <span class="stat-label">營運座位數</span>
              <span class="stat-value">{{ statsSummary.activeSeats }}</span>
            </div>
          </div>
          <div class="stat-box green">
            <div class="stat-icon"><i class="fas fa-clipboard-check"></i></div>
            <div class="stat-info">
              <span class="stat-label">今日累計租借</span>
              <span class="stat-value">{{ statsSummary.todayRents }}</span>
            </div>
          </div>
        </div>

        <transition name="fade-slide" appear>
          <div>
            <!-- ========== 主要表格卡片 ========== -->
            <el-card shadow="hover" class="table-card">
              <!-- 工具列 -->
              <div class="toolbar">
                <div class="search-controls">
                  <!-- [修復] 補上遺失的關鍵字搜尋框 -->
                  <el-input
                    v-model="searchKeyword"
                    placeholder="搜尋名稱、代碼或地址"
                    clearable
                    prefix-icon="Search"
                    class="search-input"
                  />
                  <!-- Merchant ID 搜尋框 ，說明：min="0" 讓點擊上下箭頭時不會變負數；oninput 則是防止使用者直接用鍵盤打 - 號。-->
                  <el-input
                    v-model.number="searchMerchantId"
                    placeholder="搜尋ID"
                    type="number"
                    :min="1"
                    clearable
                    class="search-input-sm"
                    @input="sanitizeMerchantId"
                  />
                  <!-- 狀態下拉選單 -->
                  <el-select v-model="searchStatus" placeholder="全部狀態" clearable class="search-select">
                    <el-option label="營運中" value="營運中" />
                    <el-option label="停用" value="停用" />
                    <el-option label="維修中" value="維修中" />
                  </el-select>
                </div>
              </div>

              <!-- 表格 -->
              <el-table
                :data="paginatedSpots"
                v-loading="loading"
                stripe
                style="width: 100%"
                :header-cell-style="{ background: '#f5f7fa', fontWeight: 'bold', color: '#303133' }"
                class="modern-table"
              >
                <el-table-column prop="spotId" label="ID" width="70" align="center" />
                <el-table-column prop="spotCode" label="代碼" width="100" />
                <el-table-column prop="spotName" label="名稱" min-width="150">
                  <template #default="{ row }">
                    <div class="spot-name-cell">
                      <i class="fas fa-store text-primary mr-2"></i>
                      <span>{{ row.spotName }}</span>
                    </div>
                  </template>
                </el-table-column>
                <el-table-column prop="spotAddress" label="地址" min-width="200" show-overflow-tooltip />
                <!-- 這裡新增了 Merchant ID 的標題欄位 -->
                <!-- 建議後端 DTO 補上 merchantName -->
                <el-table-column label="Merchant ID" width="120" align="center">
                  <template #default="{ row }">
                    <el-tag v-if="row.merchantId" type="info" size="small" effect="plain">
                      {{ row.merchantName || row.merchantId }}
                    </el-tag>
                    <span v-else class="text-muted">-</span>
                  </template>
                </el-table-column>
                <el-table-column prop="spotStatus" label="狀態" width="100" align="center">
                  <template #default="{ row }">
                    <el-tag
                      :type="(row.spotStatus === '營運中' || row.spotStatus === '啟用' || row.spotStatus === 1) ? 'success' : (row.spotStatus === '維修中' ? 'warning' : 'danger')"
                      size="small"
                      effect="light"
                    >
                      {{ row.spotStatus }}
                    </el-tag>
                  </template>
                </el-table-column>
                <el-table-column label="操作" width="180" align="center" fixed="right">
                  <template #default="{ row }">
                    <el-button-group>
                      <!-- [修改] 改用 button 統一操作風格，並呼叫 goToView 函式 -->
                      <el-tooltip content="檢視" placement="top">
                        <el-button size="small" type="info" @click="goToView(row.spotId)">
                          <i class="fas fa-eye"></i>
                        </el-button>
                      </el-tooltip>
                      <!-- 點擊編輯，跳轉到 SpotForm (帶 ID) -->
                      <el-tooltip content="編輯" placement="top">
                        <el-button size="small" type="primary" @click="goToEdit(row.spotId)">
                          <i class="fas fa-edit"></i>
                        </el-button>
                      </el-tooltip>
                      <el-tooltip content="刪除" placement="top">
                        <el-button size="small" type="danger" @click="deleteSpot(row.spotId, row.spotName)">
                          <i class="fas fa-trash-alt"></i>
                        </el-button>
                      </el-tooltip>
                    </el-button-group>
                  </template>
                </el-table-column>
              </el-table>

              <!-- 空資料提示 -->
              <el-empty v-if="paginatedSpots.length === 0 && !loading" description="目前沒有資料" />

              <!-- 分頁元件 -->
              <div class="pagination-wrapper" v-if="total > 0">
                <el-pagination
                  v-model:current-page="currentPage"
                  v-model:page-size="pageSize"
                  :page-sizes="[10, 20, 50, 100]"
                  :total="total"
                  layout="total, sizes, prev, pager, next, jumper"
                  background
                  @size-change="handleSizeChange"
                  @current-change="handlePageChange"
                />
              </div>
            </el-card>
          </div>
        </transition>
      </div>
    </section>
  </div>
</template>

<script setup>
import { ref, onMounted, computed } from 'vue'
import { useRouter } from 'vue-router'
import axios from 'axios'
import Swal from 'sweetalert2'

defineOptions({
  name: 'SpotList'
})

const router = useRouter()
const spots = ref([])
const loading = ref(false)
const searchKeyword = ref('') // 搜尋關鍵字狀態
const searchMerchantId = ref('') // Merchant ID 搜尋狀態
const searchStatus = ref('') // 狀態搜尋狀態

// 統計數據摘要
const statsSummary = ref({
  totalSpots: 0,
  maintenance: 0,
  activeSeats: 0,
  todayRents: 0
})

// 分頁設定
const currentPage = ref(1)
const pageSize = ref(10)

// 防止輸入負數
const sanitizeMerchantId = () => {
  const v = searchMerchantId.value
  if (v === '' || v === null || v === undefined) return
  if (!Number.isFinite(v) || v < 1) {
    searchMerchantId.value = 1
  }
}

const loadSpots = async () => {
  loading.value = true
  try {
    // 1. 先讀取列表 (核心功能)
    const resList = await axios.get('/api/spot/list')
    spots.value = resList.data

    // 2. 再嘗試讀取統計數據 (非核心功能，失敗不應影響列表)
    try {
      const resStats = await axios.get('/api/analyze/stats')
      calculateStats(resList.data, resStats.data)
    } catch (statsErr) {
      console.warn('統計數據讀取失敗，僅顯示列表:', statsErr)
      // 傳入 null 讓 calculateStats 計算基礎數據即可
      calculateStats(resList.data, null)
    }

  } catch (err) {
    console.error('讀取失敗:', err)
    Swal.fire({
      title: '讀取失敗',
      text: '讀取資料失敗，請檢查後端連線',
      icon: 'error',
      confirmButtonText: '確定',
      confirmButtonColor: '#409eff'
    })
  } finally {
    loading.value = false
  }
}

const calculateStats = (listData, statsData) => {
  // A. 從列表計算的基本數據
  statsSummary.value.totalSpots = listData.length
  statsSummary.value.maintenance = listData.filter(s => s.spotStatus === '維修中').length

  // B. 從統計 API 取得的進階數據 (spotMonitor 陣列)
  const monitorList = statsData?.spotMonitor || []

  // 用 reduce 加總所有站點的數據
  statsSummary.value.activeSeats = monitorList.reduce((sum, item) => sum + (item.totalSeats || 0), 0)
  statsSummary.value.todayRents = monitorList.reduce((sum, item) => sum + (item.rentedCount || 0), 0)
}

const filteredSpots = computed(() => {
  let results = spots.value
  if (searchKeyword.value.trim()) {
    const keyword = searchKeyword.value.toLowerCase().trim()
    results = results.filter(
      (spot) =>
        spot.spotName?.toLowerCase().includes(keyword) ||
        spot.spotCode?.toLowerCase().includes(keyword) ||
        spot.spotAddress?.toLowerCase().includes(keyword),
    )
  }
  if (searchMerchantId.value !== '' && searchMerchantId.value !== null) {
    const mId = Number(searchMerchantId.value)
    results = results.filter((spot) => Number(spot.merchantId) === mId)
  }
  if (searchStatus.value) {
    results = results.filter((spot) => spot.spotStatus === searchStatus.value)
  }
  return results
})

// 分頁後的資料
const paginatedSpots = computed(() => {
  const start = (currentPage.value - 1) * pageSize.value
  const end = start + pageSize.value
  return filteredSpots.value.slice(start, end)
})

// 總筆數
const total = computed(() => filteredSpots.value.length)

// 當過濾條件變化時，重置到第一頁
const resetPage = () => {
  currentPage.value = 1
}

// 分頁變化
const handlePageChange = (page) => {
  currentPage.value = page
}

const handleSizeChange = (size) => {
  pageSize.value = size
  currentPage.value = 1
}

// 跳轉到新增頁面
const goToAdd = () => {
  router.push({ name: 'spot-add' })
}

const goToMonitor = () => {
  // 請確保 router/index.js 中已設定 name: 'dispatch-monitor' 的路由
  router.push({ name: 'dispatch-monitor' })
}

const goToAnalyze = () => {
  router.push({ name: 'spot-analyze' })
}

const goToView = (id) => {
  router.push({ name: 'spot-view', params: { id } })
}

const goToEdit = (id) => {
  router.push({ name: 'spot-edit', params: { id } })
}

const deleteSpot = async (id, name) => {
  // 二次確認：顯示更詳細的資訊 (名稱 + ID)，並提示無法復原，增加安全性
  const result = await Swal.fire({
    title: '確定要刪除嗎？',
    html: `您即將刪除據點「<strong>${name}</strong>」(ID: ${id})<br><span style="color: #f56c6c;">此動作無法復原！</span>`,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#f56c6c',
    cancelButtonColor: '#909399',
    confirmButtonText: '是的，刪除',
    cancelButtonText: '取消'
  })

  if (!result.isConfirmed) return

  try {
    await axios.delete(`/api/spot/${id}`)

    Swal.fire({
      title: '刪除成功',
      text: '據點已成功刪除',
      icon: 'success',
      confirmButtonText: '確定',
      confirmButtonColor: '#67c23a'
    })
    await loadSpots()
  } catch (err) {
    console.error('刪除失敗:', err)
    Swal.fire({
      title: '刪除失敗',
      text: '刪除失敗，可能尚有相關聯的座位或訂單',
      icon: 'error',
      confirmButtonText: '確定',
      confirmButtonColor: '#409eff'
    })
  }
}

onMounted(() => {
  loadSpots()
})
</script>

<style scoped>
/* ========== 頁面容器 ========== */
.spot-list-container {
  padding: 20px;
  background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
  min-height: 100vh;
}

/* ========== 數據摘要區 ========== */
.stats-overview {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 24px;
}

.stat-box {
  background: rgba(255, 255, 255, 0.7);
  backdrop-filter: blur(8px);
  border-radius: 12px;
  padding: 20px;
  display: flex;
  align-items: center;
  gap: 16px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.5);
  transition: transform 0.3s ease;
}

.stat-box:hover {
  transform: translateY(-5px);
}

.stat-icon {
  width: 48px;
  height: 48px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  color: white;
}

.stat-info {
  display: flex;
  flex-direction: column;
}

.stat-label {
  font-size: 0.85rem;
  color: #64748b;
  margin-bottom: 4px;
}

.stat-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: #1e293b;
}

.stat-box.blue .stat-icon { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
.stat-box.orange .stat-icon { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
.stat-box.purple .stat-icon { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
.stat-box.green .stat-icon { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }

/* ========== 頁面標題區 ========== */
.page-title-box {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 16px 24px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
}

.title-icon {
  width: 56px;
  height: 56px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  color: white;
  transition: transform 0.3s ease;
}

.title-icon:hover {
  transform: scale(1.1) rotate(5deg);
}

.view-mode {
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
}

.title-content h1 {
  margin: 0;
  font-size: 1.5rem;
  font-weight: 600;
  color: #303133;
}

.title-content .subtitle {
  margin: 4px 0 0;
  font-size: 0.875rem;
  color: #909399;
}

/* ========== 新增按鈕 ========== */
.add-btn {
  border-radius: 10px;
  font-weight: 600;
  padding: 12px 24px;
  background: linear-gradient(135deg, #67c23a 0%, #95d475 100%);
  border: none;
  transition: all 0.3s ease;
}

.add-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(103, 194, 58, 0.4);
}

/* ========== 表格卡片 ========== */
.table-card {
  border-radius: 12px;
  overflow: hidden;
}

.toolbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 1px solid #ebeef5;
}

.search-controls {
  display: flex;
  gap: 12px;
  align-items: center;
}

.search-input {
  width: 220px;
}

.search-input-sm {
  width: 120px;
}

.search-select {
  width: 140px;
}

/* ========== 表格樣式 ========== */
.modern-table {
  border-radius: 8px;
  overflow: hidden;
}

.spot-name-cell {
  display: flex;
  align-items: center;
}

.text-primary {
  color: #409eff;
}

.text-muted {
  color: #909399;
}

/* ========== 動畫效果 ========== */
.fade-slide-enter-active {
  transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.fade-slide-leave-active {
  transition: all 0.3s ease-in;
}

.fade-slide-enter-from {
  transform: translateY(20px);
  opacity: 0;
}

.fade-slide-leave-to {
  transform: translateY(-10px);
  opacity: 0;
}

/* ========== 間距工具類 ========== */
.mb-4 { margin-bottom: 1.5rem; }
.mr-1 { margin-right: 4px; }
.mr-2 { margin-right: 8px; }

/* ========== 分頁樣式 ========== */
.pagination-wrapper {
  display: flex;
  justify-content: flex-end;
  margin-top: 20px;
  padding-top: 16px;
  border-top: 1px solid #ebeef5;
}

/* ========== 響應式設計 ========== */
@media (max-width: 768px) {
  .page-title-box {
    flex-direction: column;
    text-align: center;
    gap: 12px;
  }
  
  .toolbar {
    flex-direction: column;
    gap: 12px;
  }
  
  .search-controls {
    flex-wrap: wrap;
    width: 100%;
  }
  
  .search-input,
  .search-input-sm,
  .search-select {
    width: 100%;
  }
}
</style>
</file>

<file path="frontend/src/views/support/ReportEntryView.vue">
<script setup>
import { useRouter } from 'vue-router'

const router = useRouter()

// 問題類型選項
const reportTypes = [
  {
    type: 'damage',
    icon: '🔧',
    title: '機台/椅子毀損問題',
    desc: '回報設備損壞、故障、清潔等問題',
    color: '#f56c6c',
    action: () => router.push('/support/report/damage')
  },
  {
    type: 'borrow',
    icon: '📋',
    title: '借還問題',
    desc: '租借訂單、歸還異常等問題',
    color: '#e6a23c',
    action: () => router.push({ path: '/support/report/manual', query: { type: 'borrow' } })
  },
  {
    type: 'other',
    icon: '❓',
    title: '其他',
    desc: '其他類型的問題諮詢',
    color: '#909399',
    action: () => router.push({ path: '/support/report/manual', query: { type: 'other' } })
  }
]

// 返回客服支援中心
const goBack = () => {
  router.push('/support')
}
</script>

<template>
  <div class="report-entry-container">
    <!-- 頁面標題 -->
    <section class="page-header">
      <div class="container-fluid">
        <div class="header-content">
          <div class="header-icon">
            <i class="fas fa-exclamation-circle"></i>
          </div>
          <div class="header-text">
            <h1>問題回報</h1>
            <p>請選擇您要回報的問題類型</p>
          </div>
        </div>
      </div>
    </section>

    <!-- 選項卡片 -->
    <section class="content">
      <div class="container-fluid">
        <div class="type-cards">
          <div
            v-for="item in reportTypes"
            :key="item.type"
            class="type-card"
            @click="item.action"
          >
            <div class="card-icon" :style="{ background: item.color }">
              {{ item.icon }}
            </div>
            <div class="type-text">
              <div class="type-title">{{ item.title }}</div>
              <div class="type-desc">{{ item.desc }}</div>
            </div>
            <div class="card-arrow">
              <i class="fas fa-arrow-right"></i>
            </div>
          </div>
        </div>

        <!-- 返回按鈕 -->
        <div class="back-section">
          <el-button size="large" @click="goBack">
            <i class="fas fa-arrow-left mr-2"></i> 返回客服支援中心
          </el-button>
        </div>

        <!-- 提示資訊 -->
        <div class="tips-card">
          <div class="tip-item">
            <i class="fas fa-info-circle"></i>
            <span>選擇正確的問題類型能幫助我們更快為您處理</span>
          </div>
        </div>
      </div>
    </section>
  </div>
</template>

<style scoped>
/* ========== 頁面容器 ========== */
.report-entry-container {
  min-height: 100vh;
  background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
  padding-bottom: 40px;
}

/* ========== 頁面標題 ========== */
.page-header {
  background: linear-gradient(135deg, #d4e3ee 0%, #c8d9e6 100%);
  padding: 40px 20px;
  color: white;
}

.header-content {
  max-width: 900px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  gap: 20px;
}

.header-icon {
  width: 64px;
  height: 64px;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 32px;
}

.header-text h1 {
  margin: 0 0 5px;
  font-size: 1.8rem;
  font-weight: 800;
  color: #2c3e50;
  text-shadow: 0 2px 8px rgba(0, 0, 0, 0.15), 0 1px 3px rgba(255, 255, 255, 0.5);
}

.header-text p {
  margin: 0;
  font-size: 0.95rem;
  font-weight: 600;
  color: #34495e;
  text-shadow: 0 1px 4px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(255, 255, 255, 0.3);
}

/* ========== 內容區域 ========== */
.content {
  padding: 40px 20px;
}

/* ========== 類型卡片 ========== */
.type-cards {
  max-width: 900px;
  margin: 0 auto 30px;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 24px;
}

.type-card {
  background: white;
  border-radius: 16px;
  padding: 40px 30px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
  position: relative;
  overflow: hidden;
}

.type-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, transparent, var(--card-color, #409eff), transparent);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.type-card:hover {
  transform: translateY(-8px);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
}

.type-card:hover::before {
  opacity: 1;
}

.card-icon {
  width: 80px;
  height: 80px;
  border-radius: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 40px;
  margin: 0 auto 20px;
  transition: all 0.3s ease;
}

.type-card:hover .card-icon {
  transform: scale(1.1) rotate(5deg);
}

.type-text {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  margin-bottom: 20px;
}

.type-title {
  font-size: 1.3rem;
  font-weight: 700;
  color: #2c3e50;
  margin: 0;
  text-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  text-align: center;
}

.type-desc {
  font-size: 0.95rem;
  color: #606266;
  margin: 0;
  line-height: 1.6;
  font-weight: 500;
  text-align: center;
}

.card-arrow {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: #f5f7fa;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto;
  transition: all 0.3s ease;
  color: #909399;
}

.type-card:hover .card-arrow {
  background: #409eff;
  color: white;
  transform: translateX(5px);
}

/* ========== 返回區域 ========== */
.back-section {
  max-width: 900px;
  margin: 0 auto 30px;
  text-align: center;
}

/* ========== 提示卡片 ========== */
.tips-card {
  max-width: 900px;
  margin: 0 auto;
  padding: 20px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
}

.tip-item {
  display: flex;
  align-items: center;
  gap: 12px;
  color: #606266;
  font-size: 14px;
  font-weight: 500;
}

.tip-item i {
  color: #409eff;
  font-size: 18px;
}

/* ========== 響應式設計 ========== */
@media (max-width: 768px) {
  .type-cards {
    grid-template-columns: 1fr;
  }

  .header-text h1 {
    font-size: 1.5rem;
  }
}

/* ========== 輔助類 ========== */
.mr-2 {
  margin-right: 8px;
}
</style>
</file>

<file path="frontend/src/views/support/ReportManualView.vue">
<script setup>
import { computed } from 'vue'
import { useRouter, useRoute } from 'vue-router'

const router = useRouter()
const route = useRoute()

// 根據 query.type 顯示不同內容
const problemType = computed(() => route.query.type || 'other')

// 標題和說明
const pageInfo = computed(() => {
  const info = {
    borrow: {
      title: '借還問題',
      icon: '📋',
      color: '#e6a23c',
      desc: '關於租借訂單、歸還異常等問題'
    },
    other: {
      title: '其他問題',
      icon: '❓',
      color: '#909399',
      desc: '其他類型的問題諮詢'
    }
  }
  return info[problemType.value] || info.other
})

// 返回客服支援中心
const goToSupport = () => {
  router.push('/support')
}

// 返回類型選擇
const goBack = () => {
  router.push('/support/report')
}
</script>

<template>
  <div class="manual-support-container">
    <!-- 頁面標題 -->
    <section class="page-header">
      <div class="container-fluid">
        <div class="header-content">
          <div class="header-icon" :style="{ background: pageInfo.color }">
            {{ pageInfo.icon }}
          </div>
          <div class="header-text">
            <h1>{{ pageInfo.title }}</h1>
            <p>{{ pageInfo.desc }}</p>
          </div>
        </div>
      </div>
    </section>

    <!-- 內容區域 -->
    <section class="content">
      <div class="container-fluid">
        <div class="info-card">
          <!-- 主要訊息 -->
          <div class="main-message">
            <i class="fas fa-info-circle message-icon"></i>
            <h2>需要人工協助</h2>
            <p>此類型問題需要客服人員協助處理，請透過以下方式與我們聯繫：</p>
          </div>

          <!-- 聯絡方式 -->
          <div class="contact-methods">
            <div class="contact-item">
              <div class="contact-icon phone">
                <i class="fas fa-phone"></i>
              </div>
              <div class="contact-info">
                <h3>電話聯繫</h3>
                <p class="contact-value">0800-123-456</p>
                <p class="contact-note">服務時間：週一至週五 09:00-18:00</p>
              </div>
            </div>

            <div class="contact-item">
              <div class="contact-icon email">
                <i class="fas fa-envelope"></i>
              </div>
              <div class="contact-info">
                <h3>Email 聯繫</h3>
                <p class="contact-value">support@seatrentsys.com</p>
                <p class="contact-note">我們會在 24 小時內回覆您</p>
              </div>
            </div>

            <div class="contact-item">
              <div class="contact-icon chat">
                <i class="fas fa-comments"></i>
              </div>
              <div class="contact-info">
                <h3>線上客服</h3>
                <p class="contact-value">返回客服支援中心使用 AI 智能客服</p>
                <p class="contact-note">即時線上諮詢服務</p>
              </div>
            </div>
          </div>

          <!-- 注意事項 -->
          <div class="notice-box">
            <h4><i class="fas fa-lightbulb"></i> 溫馨提醒</h4>
            <ul>
              <li>請準備好您的訂單編號或會員帳號，以便快速查詢</li>
              <li>詳細描述問題狀況，可加快處理速度</li>
              <li>如有相關照片或截圖，請一併提供</li>
            </ul>
          </div>

          <!-- 按鈕組 -->
          <div class="action-buttons">
            <el-button size="large" @click="goBack">
              <i class="fas fa-arrow-left"></i> 返回類型選擇
            </el-button>
            <el-button type="primary" size="large" @click="goToSupport">
              <i class="fas fa-home"></i> 返回客服支援中心
            </el-button>
          </div>
        </div>
      </div>
    </section>
  </div>
</template>

<style scoped>
/* ========== 頁面容器 ========== */
.manual-support-container {
  min-height: 100vh;
  background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
  padding-bottom: 40px;
}

/* ========== 頁面標題 ========== */
.page-header {
  background: linear-gradient(135deg, #d4e3ee 0%, #c8d9e6 100%);
  padding: 40px 20px;
  color: white;
}

.header-content {
  max-width: 900px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  gap: 20px;
}

.header-icon {
  width: 64px;
  height: 64px;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 32px;
  transition: all 0.3s ease;
}

.header-text h1 {
  margin: 0 0 5px;
  font-size: 1.8rem;
  font-weight: 800;
  color: #2c3e50;
  text-shadow: 0 2px 8px rgba(0, 0, 0, 0.15), 0 1px 3px rgba(255, 255, 255, 0.5);
}

.header-text p {
  margin: 0;
  font-size: 0.95rem;
  font-weight: 600;
  color: #34495e;
  text-shadow: 0 1px 4px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(255, 255, 255, 0.3);
}

/* ========== 內容區域 ========== */
.content {
  padding: 40px 20px;
}

.info-card {
  max-width: 900px;
  margin: 0 auto;
  background: white;
  border-radius: 16px;
  padding: 40px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
}

/* ========== 主要訊息 ========== */
.main-message {
  text-align: center;
  margin-bottom: 40px;
  padding-bottom: 30px;
  border-bottom: 2px solid #f0f2f5;
}

.message-icon {
  font-size: 64px;
  color: #409eff;
  margin-bottom: 20px;
}

.main-message h2 {
  font-size: 1.8rem;
  font-weight: 700;
  color: #2c3e50;
  margin: 0 0 12px;
  text-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.main-message p {
  font-size: 1rem;
  color: #606266;
  margin: 0;
  font-weight: 500;
}

/* ========== 聯絡方式 ========== */
.contact-methods {
  display: grid;
  gap: 24px;
  margin-bottom: 30px;
}

.contact-item {
  display: flex;
  align-items: flex-start;
  gap: 20px;
  padding: 24px;
  background: #f8f9fa;
  border-radius: 12px;
  transition: all 0.3s ease;
}

.contact-item:hover {
  background: #e8ecf1;
  transform: translateX(5px);
}

.contact-icon {
  width: 56px;
  height: 56px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  color: white;
  flex-shrink: 0;
}

.contact-icon.phone {
  background: linear-gradient(135deg, #67c23a 0%, #85ce61 100%);
}

.contact-icon.email {
  background: linear-gradient(135deg, #409eff 0%, #66b1ff 100%);
}

.contact-icon.chat {
  background: linear-gradient(135deg, #e6a23c 0%, #ebb563 100%);
}

.contact-info {
  flex: 1;
}

.contact-info h3 {
  margin: 0 0 8px;
  font-size: 1.1rem;
  font-weight: 700;
  color: #2c3e50;
}

.contact-value {
  margin: 0 0 6px;
  font-size: 1.1rem;
  font-weight: 600;
  color: #409eff;
}

.contact-note {
  margin: 0;
  font-size: 0.85rem;
  color: #909399;
  font-weight: 500;
}

/* ========== 注意事項 ========== */
.notice-box {
  background: #fff9e6;
  border-left: 4px solid #e6a23c;
  padding: 20px 24px;
  border-radius: 8px;
  margin-bottom: 30px;
}

.notice-box h4 {
  margin: 0 0 12px;
  font-size: 1.05rem;
  font-weight: 700;
  color: #2c3e50;
  display: flex;
  align-items: center;
  gap: 8px;
}

.notice-box h4 i {
  color: #e6a23c;
}

.notice-box ul {
  margin: 0;
  padding-left: 20px;
  list-style: none;
}

.notice-box li {
  margin-bottom: 8px;
  font-size: 0.95rem;
  color: #606266;
  font-weight: 500;
  position: relative;
  padding-left: 16px;
}

.notice-box li:last-child {
  margin-bottom: 0;
}

.notice-box li::before {
  content: '•';
  position: absolute;
  left: 0;
  color: #e6a23c;
  font-weight: bold;
}

/* ========== 按鈕組 ========== */
.action-buttons {
  display: flex;
  gap: 12px;
  justify-content: center;
  flex-wrap: wrap;
}

.action-buttons .el-button {
  min-width: 180px;
}

.action-buttons i {
  margin-right: 6px;
}

/* ========== 響應式設計 ========== */
@media (max-width: 768px) {
  .info-card {
    padding: 24px;
  }

  .header-text h1 {
    font-size: 1.5rem;
  }

  .main-message h2 {
    font-size: 1.4rem;
  }

  .contact-item {
    flex-direction: column;
    text-align: center;
  }

  .action-buttons {
    flex-direction: column;
  }

  .action-buttons .el-button {
    width: 100%;
  }
}
</style>
</file>

<file path="frontend/.env">
VITE_GOOGLE_MAPS_API_KEY="AIzaSyCu6YRYdgvvOg2aLI6K5L3R0GtnyyfRe_M"

# ==================== Coze SDK 配置 ====================
# SDK 載入模式：auto | npm | script
# - auto（預設）：先嘗試 npm import，失敗則 fallback 到 script
# - npm：強制使用 npm import（測試用，可能因 Taro 依賴失敗）
# - script：強制使用 script loader（最穩定）
VITE_COZE_SDK_MODE="auto"

# Script Loader SDK 來源（當 mode=script 或 npm fallback 時使用）
# 可選值：
# - /vendor/coze/index.js（本地，最穩定）
# - https://lf-cdn.coze.com/obj/unpkg/flow-platform/chat-app-sdk/1.2.0/libs/cn/index.js（CDN）
VITE_COZE_CHAT_SDK_SRC="/vendor/coze/index.js"
</file>

<file path="frontend/src/api/http.js">
/**
 * HTTP Client 統一封裝
 * - 使用 axios.create 建立實體
 * - 統一錯誤處理 (使用 SweetAlert2)
 * - 自動加上 /api 前綴
 */
import axios from 'axios'
import Swal from 'sweetalert2'


const TUNNEL_API = window.APP_CONFIG?.API_URL; // 從設定檔抓 Tunnel 網址
const LOCAL_API = "http://localhost:8080";

let currentBaseURL = LOCAL_API; // 預設用本機
if (window.location.hostname.includes("trycloudflare.com")) { 
// 而且設定檔裡面有填 Tunnel 網址 
if (TUNNEL_API) { currentBaseURL = TUNNEL_API; console.log("🌐 偵測到外部連線，切換至 Tunnel API");
 } else { console.log("⚠️ 雖然在 Tunnel，但設定檔未填 API_URL，仍使用 Localhost"); } 
} else { console.log("🏠 偵測到本機連線，使用 Localhost API");}

// 建立 axios 實體
const http = axios.create({
  baseURL: '/api', // Vite Proxy 會將 /api 轉發到 http://localhost:8080
  timeout: 10000, // 10 秒逾時
  headers: {
    'Content-Type': 'application/json',
  },
})

// ============ Request 攔截器 ============
http.interceptors.request.use(
  (config) => {
    // 可在此加入 Token 等驗證資訊
    // const token = localStorage.getItem('token')
    // if (token) config.headers.Authorization = `Bearer ${token}`
    return config
  },
  (error) => {
    return Promise.reject(error)
  }
)

// ============ Response 攔截器 ============
http.interceptors.response.use(
  (response) => {
    // 成功回應，直接回傳 data
    return response
  },
  (error) => {
    // 錯誤處理：使用 SweetAlert2 顯示錯誤訊息
    const status = error.response?.status
    const message = error.response?.data?.message 
      || error.response?.data?.error 
      || error.response?.data 
      || '發生未知錯誤，請稍後再試'

    // 根據狀態碼顯示不同訊息
    if (status === 400) {
      Swal.fire('請求錯誤', message, 'warning')
    } else if (status === 401) {
      Swal.fire('未授權', '請重新登入', 'error')
      // 可在此導向登入頁
      // window.location.href = '/login'
    } else if (status === 403) {
      Swal.fire('權限不足', '您沒有權限執行此操作', 'error')
    } else if (status === 404) {
      Swal.fire('找不到資源', message, 'error')
    } else if (status === 500) {
      Swal.fire('伺服器錯誤', message, 'error')
    } else if (error.code === 'ECONNABORTED') {
      Swal.fire('連線逾時', '請檢查網路連線', 'error')
    } else if (!error.response) {
      Swal.fire('網路錯誤', '無法連線到伺服器', 'error')
    } else {
      Swal.fire('錯誤', message, 'error')
    }

    return Promise.reject(error)
  }
)

export default http
</file>

<file path="frontend/src/api/modules/rec.js">
/**
 * 租借記錄模組 API
 * 封裝所有租借記錄相關的 API 呼叫
 */
import http from '../http'

/**
 * 依時間區間取得每月訂單統計數據
 * @param {string} startDate - 開始日期 (格式: YYYY-MM-DD)
 * @param {string} endDate - 結束日期 (格式: YYYY-MM-DD)
 * @returns {Promise}
 */
export const getMonthlyOrderStats = (startDate, endDate) => {
  return http.get('/rent-details/stats/monthly-orders', {
    params: {
      startDate,
      endDate
    }
  })
}

/**
 * 依時間區間取得訂單狀態統計
 * @param {string} startDate - 開始日期 (格式: YYYY-MM-DD)
 * @param {string} endDate - 結束日期 (格式: YYYY-MM-DD)
 * @returns {Promise}
 */
export const getOrderStatusStats = (startDate, endDate) => {
  return http.get('/rent-details/stats/order-status', {
    params: {
      startDate,
      endDate
    }
  })
}

/**
 * 依時間區間取得訂單租借時長
 * @param {string} startDate - 開始日期 (格式: YYYY-MM-DD)
 * @param {string} endDate - 結束日期 (格式: YYYY-MM-DD)
 * @returns {Promise}
 */
export const getRentalDurations = (startDate, endDate) => {
  return http.get('/rent-details/stats/rental-duration', {
    params: {
      startDate,
      endDate
    }
  })
}

/**
 * 依時間區間取得每小時訂單統計
 * @param {string} startDate - 開始日期 (格式: YYYY-MM-DD)
 * @param {string} endDate - 結束日期 (格式: YYYY-MM-DD)
 * @returns {Promise}
 */
export const getHourlyOrderStats = (startDate, endDate) => {
  return http.get('/rent-details/stats/hourly-orders', {
    params: {
      startDate,
      endDate
    }
  })
}

/**
 * 依時間區間取得每日訂單統計
 * @param {string} startDate - 開始日期 (格式: YYYY-MM-DD)
 * @param {string} endDate - 結束日期 (格式: YYYY-MM-DD)
 * @returns {Promise}
 */
export const getDailyOrderStats = (startDate, endDate) => {
  return http.get('/rent-details/stats/daily-orders', {
    params: {
      startDate,
      endDate
    }
  })
}

/**
 * 依時間區間取得租借時長統計 (30分鐘間隔)
 * @param {string} startDate - 開始日期 (格式: YYYY-MM-DD)
 * @param {string} endDate - 結束日期 (格式: YYYY-MM-DD)
 * @returns {Promise}
 */
export const getRentalDurationStats = (startDate, endDate) => {
  return http.get('/rent-details/stats/rental-duration-intervals', {
    params: {
      startDate,
      endDate
    }
  })
}


// 匯出所有 API 作為預設物件 (方便一次 import)
export default {
  getMonthlyOrderStats,
  getOrderStatusStats,
  getRentalDurations,
  getHourlyOrderStats,
  getDailyOrderStats,
  getRentalDurationStats
}
</file>

<file path="frontend/src/api/modules/support.js">
import http from '../http'

/**
 * Support 模組 API 封裝
 * 
 * 【重構說明】2026-02-01
 * - 移除 WebSDK 相關 API
 * - 改用 Coze OpenAPI Proxy
 */

// ==================== BEGIN: OpenAPI 整合 ====================

/**
 * 取得 Coze 配置資訊（OpenAPI 模式）
 * GET /support/coze/bootstrap
 *
 * @returns {Promise} { botId, mode, serverTime, available }
 */
export const getCozeBootstrap = () => {
  return http.get('/support/coze/bootstrap')
}

/**
 * 檢查 Coze OpenAPI 狀態
 * GET /support/coze/status
 * 
 * @returns {Promise<{status: string, available: boolean, message: string}>}
 */
export const checkCozeStatus = () => {
  return http.get('/support/coze/status')
}

/**
 * 發送聊天訊息（透過後端 Proxy）
 * POST /support/coze/chat
 * 
 * @param {Object} params
 * @param {string} params.message - 使用者訊息
 * @param {string} [params.userId] - 使用者 ID（可選）
 * @param {string} [params.conversationId] - 對話 ID（可選，用於多輪對話）
 * @returns {Promise<{success: boolean, replyText?: string, conversationId?: string, error?: string}>}
 */
export const sendChatMessage = (params) => {
  return http.post('/support/coze/chat', params)
}

// ==================== END: OpenAPI 整合 ====================

// 匯出所有 API
export default {
  getCozeBootstrap,
  checkCozeStatus,
  sendChatMessage
}
</file>

<file path="frontend/src/components/rec/RecRentEdit.vue">
<script setup>
import { ref, watch, onMounted } from 'vue'

// 1. 定義 props
const props = defineProps({
  initialData: {
    type: Object,
    required: true,
  },
})

// 2. 定義 emit 事件
const emit = defineEmits(['save-rent', 'cancel'])

// 3. 使用 ref 來儲存表單資料
const form = ref({})
const formTitle = ref('修改訂單')

// 修正後的日期格式化函式，此方法更安全且能避免時區問題
const formatDateTimeForInput = (dateTimeString) => {
  if (!dateTimeString) {
    return null // v-model 會將 null 處理為空值
  }
  
  return dateTimeString.replace(' ', 'T').substring(0, 19)
}

// 4. 使用 watch 監聽 props.initialData 的變化
watch(
  () => props.initialData,
  (newData) => {
    // 只要 newData 是個有內容的物件，就進行更新
    if (newData && Object.keys(newData).length > 0) {
      formTitle.value = newData.recSeqId ? `修改訂單 (SeqID: ${newData.recSeqId})` : '修改訂單'

      // 當 props 更新時，填充表單
      form.value = {
        ...newData,
        recRentDT2: formatDateTimeForInput(newData.recRentDT2),
        recReturnDT2: formatDateTimeForInput(newData.recReturnDT2),
      }
      console.log('表單資料已更新:', form.value)
    }
  },
  { immediate: true, deep: true },
)

// 5. 提交表單的處理函式
const saveRent = () => {
  const dataToSend = {
    ...form.value,
    recRentDT2: form.value.recRentDT2 ? form.value.recRentDT2 : null,
    recReturnDT2: form.value.recReturnDT2 ? form.value.recReturnDT2 : null,
  }
  emit('save-rent', dataToSend)
}

// 6. 取消操作
const backToList = () => {
  emit('cancel')
}
</script>

<template>
  <div class="view-section form-section active">
    <h2 v-text="formTitle"></h2>

    <div class="form-group">
      <label>訂單編號:</label>
      <!-- 設定為 disabled -->
      <input v-model="form.recId" type="text" placeholder="訂單編號" disabled />
    </div>
    <div class="form-group">
      <label>會員編號:</label>
      <!-- 設定為 disabled -->
      <input v-model="form.memId" type="number" placeholder="會員編號" disabled />
    </div>
    <div class="form-group">
      <label>姓名:</label>
      <input v-model="form.memName" type="text" placeholder="例如: 王大明" disabled />
    </div>
    <div class="form-group">
      <label>座椅編號:</label>
      <input v-model="form.seatsId" type="text" placeholder="例如: S001" disabled />
    </div>
    <div class="form-group">
      <label>訂單狀態:</label>
      <select v-model="form.recStatus">
        <option value="租借中">租借中</option>
        <option value="已完成">已完成</option>
        <option value="未歸還">未歸還</option>
        <option value="已取消">已取消</option>
      </select>
    </div>
    <div class="form-group">
      <label>租借站點:</label>
      <input v-model="form.spotIdRent" type="number" placeholder="例如: 1" required />
    </div>
    <div class="form-group">
      <label>歸還站點:</label>
      <input v-model="form.spotIdReturn" type="number" placeholder="例如: 2" />
    </div>
    <div class="form-group">
      <label>租借時間:</label>
      <input v-model="form.recRentDT2" type="datetime-local" step="1" required />
    </div>
    <div class="form-group">
      <label>歸還時間:</label>
      <input v-model="form.recReturnDT2" type="datetime-local" step="1" />
    </div>
    <div class="form-group">
      <label>費用:</label>
      <input v-model="form.recPayment" type="number" />
    </div>
    <!-- <div class="form-group">
      <label>違規累計:</label>
      <input v-model="form.recViolatInt" type="number" required />
    </div> -->
    <div class="form-group">
      <label>備註:</label>
      <input v-model="form.recNote" type="text" />
    </div>

    <div style="text-align: right">
      <button class="btn-secondary" @click="backToList">取消</button>
      <button class="btn-primary" @click="saveRent">儲存變更</button>
    </div>
  </div>
</template>

<style scoped>
/* ========== 表單區塊 - 淺色風格 ========== */
.form-section {
  background: #f5f7fa;
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 20px;
}

/* ========== 表單標題 ========== */
.form-section h2 {
  font-size: 1.3rem;
  font-weight: 600;
  color: #303133;
  margin-bottom: 20px;
  padding-bottom: 10px;
  border-bottom: 2px solid #e4e7ed;
}

/* ========== 表單組 ========== */
.form-group {
  margin-bottom: 14px;
  display: flex;
  align-items: center;
}

.form-group label {
  width: 180px;
  font-weight: 500;
  font-size: 14px;
  color: #606266;
}

.form-group input,
.form-group select {
  padding: 10px 12px;
  flex: 1;
  border: 1px solid #e4e7ed;
  border-radius: 8px;
  font-size: 14px;
  background: #fff;
  transition: all 0.3s ease;
}

.form-group input:focus,
.form-group select:focus {
  border-color: #c0c4cc;
  box-shadow: 0 0 0 2px rgba(64, 158, 255, 0.08);
  outline: none;
}

.form-group input::placeholder {
  color: #c0c4cc;
}

/* ========== 停用輸入框樣式 ========== */
.form-group input:disabled {
  background: #f5f7fa;
  color: #c0c4cc;
  cursor: not-allowed;
  border: 1px dashed #e4e7ed;
}

.view-section.active {
  display: block;
}

/* ========== 按鈕樣式 ========== */
button {
  margin-left: 10px;
  padding: 10px 18px;
  cursor: pointer;
  border: none;
  border-radius: 8px;
  font-weight: 500;
  font-size: 14px;
  transition: all 0.3s ease;
}

button:hover {
  transform: translateY(-1px);
}

.btn-primary {
  background: #67c23a;
  color: white;
}

.btn-primary:hover {
  background: #85ce61;
}

.btn-secondary {
  background: #909399;
  color: white;
}

.btn-secondary:hover {
  background: #a6a9ad;
}
</style>
</file>

<file path="frontend/src/composables/maintenance/useCozeChat.js">
import { ref, computed } from 'vue'
import supportApi from '@/api/modules/support'
import { useMemberAuthStore } from '@/stores/memberAuth'

/**
 * Coze OpenAPI 聊天 Composable
 *
 * 【重構說明】2026-02-01
 * - 完全移除 WebSDK / chatapp 整合（已確認 502 TLB 問題）
 * - 改用 Coze OpenAPI（透過後端 Proxy）
 * - 前端自製聊天 UI，不依賴 SDK
 *
 * 【功能】
 * 1. 透過後端 Proxy 與 Coze OpenAPI 通訊
 * 2. 管理對話歷史（本地）
 * 3. 降級 UI 狀態管理
 * 4. 重試機制（指數退避）
 */
export function useCozeChat() {
  const memberAuthStore = useMemberAuthStore()

  // ==================== BEGIN: 狀態定義 ====================
  const loading = ref(false)
  const initialized = ref(false)
  const error = ref(null)
  const degraded = ref(false) // 降級模式（API 不可用）
  const retryCount = ref(0)
  const maxRetries = 3

  // 聊天相關狀態
  const messages = ref([]) // { role: 'user'|'assistant', content: string, timestamp: Date }
  const conversationId = ref(null)
  const sending = ref(false) // 正在發送訊息
  // ==================== END: 狀態定義 ====================

  // ==================== BEGIN: 計算屬性 ====================
  const status = computed(() => {
    if (loading.value) return 'loading'
    if (degraded.value) return 'degraded'
    if (initialized.value) return 'ready'
    if (error.value) return 'error'
    return 'idle'
  })

  const statusText = computed(() => {
    const statusMap = {
      loading: '初始化中...',
      degraded: '服務暫時不可用',
      ready: '已就緒',
      error: '初始化失敗',
      idle: '未啟動',
    }
    return statusMap[status.value] || '未知狀態'
  })
  // ==================== END: 計算屬性 ====================

  // ==================== BEGIN: 工具函數 ====================
  const getRetryDelay = (attempt) => {
    const delays = [300, 800, 1500]
    return delays[Math.min(attempt, delays.length - 1)]
  }

  const sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms))

  const getUserId = () => {
    if (memberAuthStore.isLogin && memberAuthStore.member?.memId) {
      return `member_${memberAuthStore.member.memId}`
    }
    const storageKey = 'support_user_id'
    let userId = localStorage.getItem(storageKey)
    if (!userId) {
      userId = crypto.randomUUID
        ? crypto.randomUUID()
        : `guest_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
      localStorage.setItem(storageKey, userId)
    }
    return userId
  }

  const logDiagnostic = (level, message, data = {}) => {
    const timestamp = new Date().toISOString()
    const safeData = { ...data }
    delete safeData.token
    delete safeData.pat

    if (level === 'error') {
      console.error(`[Coze OpenAPI] ${message}`, safeData)
    } else if (level === 'warn') {
      console.warn(`[Coze OpenAPI] ${message}`, safeData)
    } else {
      console.log(`[Coze OpenAPI] ${message}`, safeData)
    }
  }

  /**
   * 從 AI 回覆中擷取結構化 intent（JSON）
   * - 找 ```json ... ``` 區塊
   * - parse JSON
   * - 回傳：{ cleanText, intent }
   */

  const extractIntentFromReply = (rawText) => {
    if (!rawText) {
      return { cleanText: rawText, intent: null }
    }

    const jsonBlockRegex = /```json\s*([\s\S]*?)\s*```/i
    const match = rawText.match(jsonBlockRegex)

    if (!match) {
      return { cleanText: rawText, intent: null }
    }

    let intent = null
    try {
      intent = JSON.parse(match[1])
    } catch (e) {
      logDiagnostic('warn', 'JSON intent 解析失敗，已忽略', { error: e.message })
    }

    // 把 JSON 區塊從顯示文字中移除
    const cleanText = rawText.replace(jsonBlockRegex, '').trim()

    return { cleanText, intent }
  }

  // ==================== END: 工具函數 ====================

  // ==================== BEGIN: 初始化（檢查 API 狀態） ====================
  const initCozeChat = async () => {
    if (initialized.value) {
      logDiagnostic('info', '已初始化，跳過')
      return { success: true, cached: true }
    }

    loading.value = true
    error.value = null
    degraded.value = false

    try {
      logDiagnostic('info', '檢查 Coze OpenAPI 狀態...')

      const response = await supportApi.checkCozeStatus()
      const statusData = response.data

      if (statusData.available) {
        initialized.value = true
        logDiagnostic('info', '✅ OpenAPI 可用', { mode: statusData.mode })
        return { success: true, mode: 'openapi' }
      } else {
        // API 不可用，進入降級模式
        degraded.value = true
        error.value = statusData.message || 'API 不可用'
        logDiagnostic('warn', '⚠️ OpenAPI 不可用，進入降級模式', {
          status: statusData.status,
          message: statusData.message,
        })
        return { success: false, degraded: true, error: statusData.message }
      }
    } catch (err) {
      error.value = err.message || '無法連線至伺服器'
      degraded.value = true
      logDiagnostic('error', '❌ 初始化失敗', { error: err.message })
      return { success: false, error: err.message, degraded: true }
    } finally {
      loading.value = false
    }
  }
  // ==================== END: 初始化 ====================

  // ==================== BEGIN: 發送訊息 ====================
  const sendMessage = async (messageText) => {
    if (!messageText || !messageText.trim()) {
      return { success: false, error: '訊息不可為空' }
    }

    if (degraded.value) {
      return { success: false, error: '服務暫時不可用' }
    }

    sending.value = true
    const userId = getUserId()

    // 先將使用者訊息加入列表
    const userMessage = {
      role: 'user',
      content: messageText.trim(),
      timestamp: new Date(),
    }
    messages.value.push(userMessage)

    try {
      logDiagnostic('info', '📤 發送訊息', { length: messageText.length })

      const response = await supportApi.sendChatMessage({
        message: messageText.trim(),
        userId: userId,
        conversationId: conversationId.value,
      })

      const result = response.data

      if (result.success) {
        // 儲存 conversationId 供後續對話使用
        if (result.conversationId) {
          conversationId.value = result.conversationId
        }

        // 加入 AI 回覆

        //解析intent
        const { cleanText, intent } = extractIntentFromReply(result.replyText)

        //加入乾淨AI回覆(讓使用者看不到JSON)
        messages.value.push({
          role: 'assistant',
          content: cleanText || '（無回覆）',
          timestamp: new Date(),
        })

        logDiagnostic('info', '✅ 收到回覆', {
          conversationId: result.conversationId,
          replyLength: result.replyText?.length,
        })

        retryCount.value = 0 // 成功後重置重試計數
        return { success: true, reply: result.replyText }
      } else {
        // API 回傳錯誤
        const errorMsg = result.error || '發送失敗'
        logDiagnostic('warn', '⚠️ API 回傳錯誤', { error: errorMsg })

        // 加入錯誤訊息
        messages.value.push({
          role: 'assistant',
          content: `⚠️ ${errorMsg}`,
          timestamp: new Date(),
          isError: true,
        })

        return { success: false, error: errorMsg }
      }
    } catch (err) {
      const errorMsg = err.response?.data?.error || err.message || '網路錯誤'
      const isBusinessError = err.response?.data?.isBusinessError === true
      const status = err.response?.status

      logDiagnostic('error', '❌ 發送失敗', { error: errorMsg, status, isBusinessError })

      // ==================== BEGIN: 修正重試邏輯 ====================
      // 只有 502/503/504/408 才重試，400/409 業務錯誤不重試
      const shouldRetryStatus = [502, 503, 504, 408]
      const canRetry =
        !isBusinessError && shouldRetryStatus.includes(status) && retryCount.value < maxRetries

      if (canRetry) {
        retryCount.value++
        const delay = getRetryDelay(retryCount.value - 1)
        logDiagnostic('info', `重試 ${retryCount.value}/${maxRetries}，延遲 ${delay}ms`)

        // 移除剛加入的使用者訊息（重試時會重新加入）
        messages.value.pop()

        await sleep(delay)
        return await sendMessage(messageText)
      }
      // ==================== END: 修正重試邏輯 ====================

      // 加入錯誤訊息
      messages.value.push({
        role: 'assistant',
        content: `⚠️ ${errorMsg}`,
        timestamp: new Date(),
        isError: true,
      })

      // 只有連線錯誤才進入降級模式，業務錯誤不進入
      if (!isBusinessError && retryCount.value >= maxRetries) {
        degraded.value = true
        logDiagnostic('warn', '重試次數已達上限，進入降級模式')
      }

      return { success: false, error: errorMsg }
    } finally {
      sending.value = false
    }
  }
  // ==================== END: 發送訊息 ====================

  // ==================== BEGIN: 手動重試 ====================
  const manualRetry = async () => {
    retryCount.value = 0
    degraded.value = false
    error.value = null
    initialized.value = false

    return await initCozeChat()
  }
  // ==================== END: 手動重試 ====================

  // ==================== BEGIN: 清除對話 ====================
  const clearMessages = () => {
    messages.value = []
    conversationId.value = null
    logDiagnostic('info', '對話已清除')
  }
  // ==================== END: 清除對話 ====================

  // ==================== BEGIN: 銷毀 ====================
  const destroy = () => {
    messages.value = []
    conversationId.value = null
    initialized.value = false
    degraded.value = false
    error.value = null
    retryCount.value = 0
  }
  // ==================== END: 銷毀 ====================

  return {
    // 狀態
    loading,
    initialized,
    error,
    degraded,
    retryCount,
    status,
    statusText,
    messages,
    conversationId,
    sending,

    // 方法
    initCozeChat,
    sendMessage,
    manualRetry,
    clearMessages,
    destroy,
  }
}
</file>

<file path="frontend/src/main.js">
import './assets/custom.css'

import { createApp } from 'vue'
import { createPinia } from 'pinia'
import axios from 'axios'

// Element Plus
import ElementPlus from 'element-plus'
import 'element-plus/dist/index.css'
import * as ElementPlusIconsVue from '@element-plus/icons-vue'

// --- [ADD] 引入 vue-google-maps ---
import VueGoogleMaps from '@fawmi/vue-google-maps'
// Particles.js（Vue 3 版）
import Particles from '@tsparticles/vue3'
import { loadSlim } from '@tsparticles/slim'

import VueApexCharts from 'vue3-apexcharts'

import App from './App.vue'
import router from './router'

import { ElMessageBox } from 'element-plus'

// Axios request interceptor
axios.interceptors.request.use(
  (config) => {
    const token = localStorage.getItem('token')
    if (token) {
      config.headers.Authorization = `Bearer ${token}`
    }
    return config
  },
  (error) => {
    return Promise.reject(error)
  },
)

let isAuthExpiredDialogShowing = false

axios.interceptors.response.use(
  (response) => response,
  (error) => {
    const status = error.response?.status
    const url = error.config?.url || ''
    const currentPath = window.location.hash || window.location.pathname // 取得當前路徑

    // 修改邏輯：
    // 1. 排除登入相關請求
    // 2. 只有在「非首頁」且「非登入頁」發生 401 時才強行踢出
    // 3. 增加對 /member/profile 的容錯，避免剛進首頁就噴錯
    if (
      status === 401 &&
      !url.includes('/login') &&
      !url.includes('/oauth2') &&
      !url.includes('/api/auth/me') &&
      !isAuthExpiredDialogShowing
    ) {
      // 如果是在首頁 (#/)，通常是靜態展示，我們就默默清理掉過期資訊就好，不跳彈窗
      if (currentPath === '#/' || currentPath === '/') {
        localStorage.removeItem('token')
        localStorage.removeItem('admin')
        localStorage.removeItem('member_user')
        return Promise.reject(error)
      }

      // 只有在試圖進入「管理後台」或「個人設定」等深層頁面時，才跳出警示
      isAuthExpiredDialogShowing = true

      ElMessageBox.alert('登入已過期或權限不足，請重新登入', '存取受限', {
        confirmButtonText: '確認',
        type: 'warning',
        showClose: false,
        closeOnClickModal: false,
      }).then(() => {
        isAuthExpiredDialogShowing = false
        // 清理所有身分緩存
        localStorage.clear()
        router.push('/login')
      })
    }

    return Promise.reject(error)
  },
)

const app = createApp(App)

app.use(createPinia())
app.use(router)

// Element Plus
app.use(ElementPlus)

// ApexCharts
app.use(VueApexCharts)

// --- 啟用 vue-google-maps 並設定 API 金鑰 ---
app.use(VueGoogleMaps, {
  load: {
    key: import.meta.env.VITE_GOOGLE_MAPS_API_KEY,
    libraries: ['marker', 'places'], // 載入 marker 和 places 函式庫
    v: 'quarterly', // 指定載入穩定的 API 版本
  },
})

// --- [NEW] 4. 自動註冊所有圖示 (解決方塊亂碼問題) ---
// Element Plus Icons
for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
  app.component(key, component)
}

// 初始化 Particles（只做一次）
app.use(Particles, {
  init: async (engine) => {
    await loadSlim(engine)
  },
})

app.mount('#app')
</file>

<file path="frontend/src/views/ecpay/PaymentSuccessView.vue">
<template>
  <div class="redirect-container">
    <el-result icon="success" title="支付處理中" sub-title="正在同步贊助狀態，請勿關閉視窗...">
      <template #extra>
        <el-icon class="is-loading" style="font-size: 30px;"><Loading /></el-icon>
      </template>
    </el-result>
  </div>
</template>

<script setup>
import { onMounted } from 'vue';
import { Loading } from '@element-plus/icons-vue';

onMounted(() => {
  console.log("💳 支付完成中轉頁已啟動");

  const notifyAndClose = () => {
    // 💡 核心邏輯：向開啟這個視窗的父視窗發送訊息
    if (window.opener) {
      window.opener.postMessage('PAYMENT_SUCCESS', '*');
      console.log("已通知主視窗");
    }
    
    // 如果是在 iframe 內執行
    if (window.parent && window.parent !== window) {
      window.parent.postMessage('PAYMENT_SUCCESS', '*');
      console.log("已通知父層 iframe");
    }

    // 延遲關閉視窗，讓使用者稍微看到成功狀態
    setTimeout(() => {
      if (window.opener) {
        window.close();
      }
    }, 2500);
  };

  notifyAndClose();
});
</script>

<style scoped>
.redirect-container {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 60vh; /* 在 MainLayout 中居中 */
}
.is-loading {
  color: #2a9d8f;
}
</style>
</file>

<file path="frontend/src/views/ecpay/SponsorLog.vue">
<template>
  <div class="admin-container">
    <section class="content-header mb-4">
      <div class="page-title-box">
        <div class="title-icon"><i class="fas fa-gem"></i></div>
        <div class="title-content">
          <h1>贊助與財務分析中心</h1>
          <p class="subtitle">追蹤月度營收增長與會員贊助分佈</p>
        </div>
      </div>
    </section>

    <el-card shadow="never" class="filter-card mb-4">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
        <div class="d-flex gap-3 align-items-center">
          <div class="filter-item">
            <span class="label"><i class="fas fa-calendar-alt me-1"></i> 月份查詢：</span>
            <el-date-picker
              v-model="selectedMonth"
              type="month"
              placeholder="選擇月份"
              value-format="YYYY-MM"
              @change="handleFilterChange"
            />
          </div>
          <el-divider direction="vertical" />
          <el-input 
            v-model="searchQuery" 
            placeholder="搜尋 ID 或 單號" 
            style="width: 220px;" 
            clearable 
            @input="handleFilterChange"
          />
          <el-select v-model="statusFilter" placeholder="狀態" clearable style="width: 120px;" @change="handleFilterChange">
            <el-option label="待支付" :value="0" />
            <el-option label="成功" :value="1" />
            <el-option label="失敗" :value="2" />
          </el-select>
        </div>
        <div class="actions">
          <el-button @click="resetFilters">重置</el-button>
          <el-button type="success" @click="exportToExcel">
            <i class="fas fa-file-excel me-1"></i> 匯出報表
          </el-button>
        </div>
      </div>
    </el-card>

    <el-row :gutter="20" class="mb-4">
      <el-col :xs="24" :sm="12" :md="8">
        <div class="stat-card revenue-card">
          <div class="stat-icon"><i class="fas fa-sack-dollar"></i></div>
          <div class="stat-info">
            <h3>$ {{ totalAmount.toLocaleString() }}</h3>
            <span>{{ selectedMonth || '歷年' }} 成功贊助總額</span>
          </div>
        </div>
      </el-col>
      <el-col :xs="24" :sm="12" :md="8">
        <div class="stat-card count-card">
          <div class="stat-icon"><i class="fas fa-receipt"></i></div>
          <div class="stat-info">
            <h3>{{ filteredData.length }} <small>筆</small></h3>
            <span>{{ selectedMonth || '歷年' }} 交易總筆數</span>
          </div>
        </div>
      </el-col>
      <el-col :xs="24" :sm="12" :md="8">
        <div class="stat-card user-card">
          <div class="stat-icon"><i class="fas fa-users"></i></div>
          <div class="stat-info">
            <h3>{{ uniqueDonors }} <small>人</small></h3>
            <span>本月贊助會員數</span>
          </div>
        </div>
      </el-col>
    </el-row>

    <el-card shadow="hover" class="chart-card mb-4">
      <template #header>
        <div class="card-header">
          <i class="fas fa-chart-line me-2 text-primary"></i> 
          {{ selectedMonth || '年度' }} 贊助趨勢分析
        </div>
      </template>
      <div ref="chartRef" style="height: 300px; width: 100%;"></div>
    </el-card>

    <el-card shadow="hover" class="table-card">
      <el-table :data="paginatedData" v-loading="loading" stripe style="width: 100%">
        <el-table-column prop="merchantTradeNo" label="訂單編號" min-width="180">
          <template #default="{ row }"><code class="order-code">{{ row.merchantTradeNo }}</code></template>
        </el-table-column>
        <el-table-column prop="memberId" label="會員 ID" width="100" />
        <el-table-column prop="amount" label="金額" width="120" sortable>
          <template #default="{ row }"><span class="amount-text">${{ row.amount }}</span></template>
        </el-table-column>
        <el-table-column label="狀態" width="100">
          <template #default="{ row }">
            <el-tag :type="statusType(row.status)">{{ statusText(row.status) }}</el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="paymentType" label="支付方式" width="120" />
        <el-table-column prop="createdAt" label="時間" width="180" sortable />
        <el-table-column prop="sponsorComment" label="留言" show-overflow-tooltip />
      </el-table>

      <div class="d-flex justify-content-end mt-4">
        <el-pagination
          v-model:current-page="currentPage"
          v-model:page-size="pageSize"
          :total="filteredData.length"
          layout="total, prev, pager, next"
        />
      </div>
    </el-card>
  </div>
</template>

<script setup>
import { ref, computed, onMounted, watch, onUnmounted } from 'vue';
import axios from 'axios';
import * as XLSX from 'xlsx';
import * as echarts from 'echarts';

// --- 響應式變數 ---
const loading = ref(false);
const allData = ref([]);
const selectedMonth = ref(''); // YYYY-MM
const searchQuery = ref('');
const statusFilter = ref(null);
const currentPage = ref(1);
const pageSize = ref(10);
const chartRef = ref(null);
let myChart = null;

// --- 數據獲取 ---
const fetchSponsors = async () => {
  loading.value = true;
  try {
    const apiUrl = window.APP_CONFIG?.API_URL || 'http://localhost:8080';
    const response = await axios.get(`${apiUrl}/api/payment/admin/sponsors`);
    allData.value = response.data;
    updateChart();
  } catch (error) {
    console.error("載入失敗", error);
  } finally {
    loading.value = false;
  }
};

// --- 核心過濾邏輯 ---
const filteredData = computed(() => {
  return allData.value.filter(item => {
    const matchesMonth = !selectedMonth.value || (item.createdAt && item.createdAt.startsWith(selectedMonth.value));
    const query = searchQuery.value.toLowerCase();
    const matchesSearch = item.merchantTradeNo.toLowerCase().includes(query) || String(item.memberId).includes(query);
    const matchesStatus = statusFilter.value === null || item.status === statusFilter.value;
    return matchesMonth && matchesSearch && matchesStatus;
  });
});

const paginatedData = computed(() => {
  const start = (currentPage.value - 1) * pageSize.value;
  return filteredData.value.slice(start, start + pageSize.value);
});

// --- 統計計算 ---
const totalAmount = computed(() => 
  filteredData.value.filter(i => i.status === 1).reduce((s, i) => s + (i.amount || 0), 0)
);
const uniqueDonors = computed(() => new Set(filteredData.value.map(i => i.memberId)).size);

// --- 圖表邏輯 ---
const updateChart = () => {
  if (!chartRef.value) return;
  if (!myChart) myChart = echarts.init(chartRef.value);

  // 按日期統計成功金額
  const stats = {};
  filteredData.value.filter(i => i.status === 1).forEach(i => {
    const day = i.createdAt.split(' ')[0]; // 抓 YYYY-MM-DD
    stats[day] = (stats[day] || 0) + i.amount;
  });

  const sortedDays = Object.keys(stats).sort();
  
  myChart.setOption({
    tooltip: { trigger: 'axis' },
    xAxis: { type: 'category', data: sortedDays },
    yAxis: { type: 'value', name: '金額' },
    series: [{
      data: sortedDays.map(d => stats[d]),
      type: 'line',
      smooth: true,
      color: '#409eff',
      areaStyle: { opacity: 0.1 }
    }]
  });
};

// --- 功能函數 ---
const statusType = s => (s === 1 ? 'success' : s === 2 ? 'danger' : 'info');
const statusText = s => (s === 1 ? '成功' : s === 2 ? '失敗' : '待支付');
const resetFilters = () => { selectedMonth.value = ''; searchQuery.value = ''; statusFilter.value = null; };
const handleFilterChange = () => { currentPage.value = 1; updateChart(); };

const exportToExcel = () => {
  const ws = XLSX.utils.json_to_sheet(filteredData.value);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Sponsors");
  XLSX.writeFile(wb, `贊助報表_${selectedMonth.value || '全部'}.xlsx`);
};

// --- 生命週期 ---
onMounted(() => {
  fetchSponsors();
  window.addEventListener('resize', () => myChart?.resize());
});
watch([selectedMonth, searchQuery, statusFilter], () => updateChart());
</script>

<style scoped>
.admin-container { padding: 20px; background: #f5f7fa; min-height: 100vh; }
.page-title-box { background: white; padding: 20px; border-radius: 12px; display: flex; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
.title-icon { font-size: 2rem; color: #409eff; margin-right: 15px; }
.stat-card { padding: 20px; border-radius: 12px; color: white; display: flex; align-items: center; }
.revenue-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
.count-card { background: linear-gradient(135deg, #2af598 0%, #009efd 100%); }
.user-card { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
.stat-icon { font-size: 2.5rem; opacity: 0.3; margin-right: 15px; }
.order-code { background: #f0f2f5; padding: 2px 6px; border-radius: 4px; font-family: monospace; }
.amount-text { color: #e6a23c; font-weight: bold; }
.chart-card { border-radius: 12px; }
</style>
</file>

<file path="frontend/src/views/maintenance/MaintenanceStaffForm.vue">
<script setup>
import { ref, onMounted, reactive, computed } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { ElMessageBox, ElMessage } from 'element-plus' // 改用 Element Plus 元件
import maintenanceApi from '@/api/modules/maintenance'
import MaintenancePageHeader from '@/components/maintenance/MaintenancePageHeader.vue'

const route = useRoute()
const router = useRouter()
const staffId = Number(route.params.id)
const isEdit = computed(() => !isNaN(staffId) && staffId > 0)

const formRef = ref(null)
const loading = ref(false)
const submitting = ref(false)
// 移除 formVisible 與 setTimeout，改用 CSS 動畫原生的 appear

const form = reactive({
  staffName: '',
  staffCompany: '',
  staffPhone: '',
  staffEmail: '',
  staffNote: '',
  isActive: true,
})

const rules = {
  staffName: [{ required: true, message: '請輸入姓名', trigger: 'blur' }],
  staffEmail: [{ type: 'email', message: 'Email 格式不正確', trigger: 'blur' }],
}

onMounted(async () => {
  if (isEdit.value) {
    loading.value = true
    try {
      const res = await maintenanceApi.getStaffById(staffId)
      // 確保 API 回傳的資料能正確映射
      Object.assign(form, res.data || res)
    } catch (error) {
      console.error('獲取資料失敗:', error)
      ElMessage.error('無法載入人員資料，請稍後再試')
      router.push('/admin/staff-list')
    } finally {
      loading.value = false
    }
  }
})

const submitForm = async () => {
  if (!formRef.value) return

  await formRef.value.validate(async (valid) => {
    if (valid) {
      // 1. 確認視窗 (使用 Element Plus)
      try {
        await ElMessageBox.confirm(
          isEdit.value ? '即將更新此人員資料，確定嗎？' : '即將新增維護人員，確定嗎？',
          isEdit.value ? '確認更新' : '確認新增',
          {
            confirmButtonText: '確認送出',
            cancelButtonText: '再想想',
            type: 'warning',
            draggable: true,
          },
        )
      } catch {
        // 使用者點擊取消
        return
      }

      // 2. 執行送出
      submitting.value = true
      try {
        if (isEdit.value) {
          await maintenanceApi.updateStaff(staffId, form)
          ElMessage.success({
            message: `更新成功！人員 ${form.staffName} 資料已更新`,
            duration: 2000,
          })
        } else {
          await maintenanceApi.createStaff(form)
          ElMessage.success({
            message: `新增成功！歡迎 ${form.staffName} 加入團隊`,
            duration: 2000,
          })
        }
        router.push('/admin/staff-list')
      } catch (error) {
        // 錯誤通常由 http.js 攔截器處理，這裡做備用
        console.error(error)
      } finally {
        submitting.value = false
      }
    } else {
      // 驗證失敗提示
      ElMessage.warning('表單驗證失敗，請檢查必填欄位')
    }
  })
}

//一鍵帶入(Demo用)
const handleDemoFill = () => {
  form.staffName = '江小魚'
  form.staffCompany = '小魚科技股份有限公司'
  form.staffPhone = '0988-123-456'
  form.staffEmail = 'swagsnail860701@gmail.com'
  form.staffNote = '資深維護工程師，負責北區機台維修，週一至週五 09:00~18:00 可聯繫。'
  form.isActive = true

  // 提示一下使用者
  ElMessage.success('已帶入測試資料！')
}

const handleCancel = async () => {
  // 如果有填寫內容，離開前確認
  if (form.staffName || form.staffCompany || form.staffPhone) {
    try {
      await ElMessageBox.confirm('您填寫的資料將不會被保存，確定要離開嗎？', '確認離開', {
        confirmButtonText: '離開',
        cancelButtonText: '繼續編輯',
        type: 'warning',
      })
    } catch {
      return
    }
  }
  router.push('/admin/staff-list')
}
</script>

<template>
  <div class="staff-form-container">
    <section class="content-header">
      <div class="container-fluid">
        <transition name="slide-fade" appear>
          <MaintenancePageHeader
            :title="isEdit ? '編輯人員資料' : '新增維護人員'"
            :subtitle="isEdit ? '修改現有人員的詳細資訊' : '建立新的維護人員檔案'"
            :icon="isEdit ? 'fas fa-user-edit' : 'fas fa-user-plus'"
            :mode="isEdit ? 'edit' : 'add'"
          />
        </transition>
      </div>
    </section>

    <section class="content">
      <div class="container-fluid d-flex justify-content-center">
        <transition name="zoom-fade" appear>
          <el-card
            shadow="hover"
            class="form-card"
            v-loading="loading"
            element-loading-text="載入中..."
          >
            <template #header>
              <div class="card-header-content">
                <div class="header-left">
                  <span class="header-icon">
                    <i class="fas fa-id-card"></i>
                  </span>
                  <span class="header-text">基本資料</span>
                  <el-tag v-if="isEdit" type="warning" effect="plain" size="small" class="ml-2">
                    編輯模式
                  </el-tag>
                  <el-tag v-else type="success" effect="plain" size="small" class="ml-2">
                    新增模式
                  </el-tag>
                </div>

                <el-button class="cancel-btn" text type="info" @click="handleCancel">
                  <i class="fas fa-times mr-1"></i> 取消
                </el-button>
              </div>
            </template>

            <el-form
              ref="formRef"
              :model="form"
              :rules="rules"
              label-width="100px"
              label-position="top"
              status-icon
              class="staff-form"
            >
              <el-form-item label="姓名" prop="staffName" class="form-item-animated">
                <template #label>
                  <span class="custom-label">
                    <i class="fas fa-user label-icon"></i> 姓名
                    <span class="required-star">*</span>
                  </span>
                </template>
                <el-input
                  v-model="form.staffName"
                  placeholder="請輸入維護人員姓名"
                  prefix-icon="User"
                  clearable
                  size="large"
                  class="custom-input"
                />
              </el-form-item>

              <el-form-item label="公司" prop="staffCompany" class="form-item-animated">
                <template #label>
                  <span class="custom-label">
                    <i class="fas fa-building label-icon"></i> 所屬公司
                  </span>
                </template>
                <el-input
                  v-model="form.staffCompany"
                  placeholder="請輸入所屬公司名稱"
                  prefix-icon="OfficeBuilding"
                  clearable
                  size="large"
                  class="custom-input"
                />
              </el-form-item>

              <el-row :gutter="20">
                <el-col :span="12">
                  <el-form-item label="電話" prop="staffPhone" class="form-item-animated">
                    <template #label>
                      <span class="custom-label">
                        <i class="fas fa-phone label-icon"></i> 聯絡電話
                      </span>
                    </template>
                    <el-input
                      v-model="form.staffPhone"
                      placeholder="09xx-xxx-xxx"
                      prefix-icon="Phone"
                      clearable
                      size="large"
                      class="custom-input"
                    />
                  </el-form-item>
                </el-col>
                <el-col :span="12">
                  <el-form-item label="Email" prop="staffEmail" class="form-item-animated">
                    <template #label>
                      <span class="custom-label">
                        <i class="fas fa-envelope label-icon"></i> 電子郵件
                      </span>
                    </template>
                    <el-input
                      v-model="form.staffEmail"
                      placeholder="example@mail.com"
                      prefix-icon="Message"
                      clearable
                      size="large"
                      class="custom-input"
                    />
                  </el-form-item>
                </el-col>
              </el-row>

              <el-form-item label="備註" prop="staffNote" class="form-item-animated">
                <template #label>
                  <span class="custom-label">
                    <i class="fas fa-sticky-note label-icon"></i> 備註說明
                  </span>
                </template>
                <el-input
                  v-model="form.staffNote"
                  type="textarea"
                  :rows="4"
                  placeholder="可填寫專長、負責區域等補充資訊..."
                  show-word-limit
                  maxlength="500"
                  class="custom-textarea"
                />
              </el-form-item>

              <transition name="fade-slide">
                <el-form-item v-if="isEdit" label="狀態" prop="isActive" class="status-switch-item">
                  <template #label>
                    <span class="custom-label">
                      <i class="fas fa-toggle-on label-icon"></i> 人員狀態
                    </span>
                  </template>
                  <div class="status-switch-wrapper">
                    <el-switch
                      v-model="form.isActive"
                      active-text="在職"
                      inactive-text="停用"
                      :active-icon="''"
                      :inactive-icon="''"
                      inline-prompt
                      style="--el-switch-on-color: #67c23a; --el-switch-off-color: #f56c6c"
                      size="large"
                    />
                    <el-tag
                      :type="form.isActive ? 'success' : 'danger'"
                      effect="light"
                      class="status-tag ml-3"
                    >
                      <i :class="form.isActive ? 'fas fa-check-circle' : 'fas fa-ban'"></i>
                      {{ form.isActive ? '目前為在職狀態' : '目前為停用狀態' }}
                    </el-tag>
                  </div>
                </el-form-item>
              </transition>

              <el-divider>
                <i class="fas fa-paper-plane"></i>
              </el-divider>

              <el-form-item class="form-actions">
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    width: 100%;
                    align-items: center;
                  "
                >
                  <div class="left-actions">
                    <el-button
                      type="primary"
                      @click="submitForm"
                      :loading="submitting"
                      size="large"
                      class="submit-btn"
                    >
                      <i class="fas fa-save mr-2" v-if="!submitting"></i>
                      <span>{{ submitting ? '處理中...' : isEdit ? '更新資料' : '確認新增' }}</span>
                    </el-button>

                    <el-button @click="handleCancel" size="large" class="back-btn ml-3">
                      <i class="fas fa-arrow-left mr-2"></i> 返回列表
                    </el-button>
                  </div>

                  <div class="right-actions">
                    <el-button
                      type="warning"
                      link
                      @click="handleDemoFill"
                      style="opacity: 0.6; transition: opacity 0.3s"
                      onmouseover="this.style.opacity=1"
                      onmouseout="this.style.opacity=0.6"
                    >
                      <i class="fas fa-magic mr-1"></i> 一鍵帶入
                    </el-button>
                  </div>
                </div>
              </el-form-item>
            </el-form>
          </el-card>
        </transition>
      </div>
    </section>
  </div>
</template>

<style scoped>
.staff-form-container {
  min-height: 100vh;
  background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
  padding-bottom: 40px;
}

.content-header {
  padding: 20px 1rem;
}

/* PageHeader 的樣式已移至元件中，此處刪除 */

/* 表單卡片 */
.form-card {
  width: 100%;
  max-width: 700px;
  border-radius: 16px;
  overflow: hidden;
  border: none;
  transition: all 0.3s ease;
}

.form-card:hover {
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
}

.card-header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 8px;
}

.header-icon {
  width: 32px;
  height: 32px;
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 14px;
}

.header-text {
  font-weight: 600;
  font-size: 1rem;
  color: #303133;
}

.cancel-btn {
  transition: all 0.3s ease;
}

.cancel-btn:hover {
  transform: translateX(3px);
}

/* 表單樣式 */
.staff-form {
  padding: 10px 20px;
}

.custom-label {
  display: flex;
  align-items: center;
  gap: 6px;
  font-weight: 500;
  color: #606266;
}

.label-icon {
  color: #409eff;
  font-size: 14px;
}

.required-star {
  color: #f56c6c;
  margin-left: 2px;
}

.form-item-animated {
  animation: fadeInUp 0.5s ease forwards;
  opacity: 0;
}

.form-item-animated:nth-child(1) {
  animation-delay: 0.1s;
}
.form-item-animated:nth-child(2) {
  animation-delay: 0.15s;
}
.form-item-animated:nth-child(3) {
  animation-delay: 0.2s;
}
.form-item-animated:nth-child(4) {
  animation-delay: 0.25s;
}
.form-item-animated:nth-child(5) {
  animation-delay: 0.3s;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.custom-input :deep(.el-input__wrapper) {
  border-radius: 10px;
  transition: all 0.3s ease;
}

.custom-input :deep(.el-input__wrapper):hover {
  box-shadow: 0 0 0 1px #409eff inset;
}

.custom-input :deep(.el-input__wrapper.is-focus) {
  box-shadow: 0 0 0 2px rgba(64, 158, 255, 0.3) inset;
}

.custom-textarea :deep(.el-textarea__inner) {
  border-radius: 10px;
  transition: all 0.3s ease;
}

.custom-textarea :deep(.el-textarea__inner):hover {
  box-shadow: 0 0 0 1px #409eff inset;
}

/* 狀態切換 */
.status-switch-wrapper {
  display: flex;
  align-items: center;
  padding: 12px 16px;
  background: #f5f7fa;
  border-radius: 10px;
}

.status-tag {
  display: flex;
  align-items: center;
  gap: 6px;
}

/* 按鈕區 */
.form-actions {
  margin-top: 20px;
}

.submit-btn {
  min-width: 140px;
  border-radius: 10px;
  font-weight: 600;
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
  border: none;
  transition: all 0.3s ease;
}

.submit-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(64, 158, 255, 0.4);
}

.back-btn {
  min-width: 120px;
  border-radius: 10px;
  transition: all 0.3s ease;
}

.back-btn:hover {
  transform: translateX(-3px);
}

/* 過渡動畫 */
.slide-fade-enter-active {
  transition: all 0.4s ease-out;
}
.slide-fade-leave-active {
  transition: all 0.3s ease-in;
}
.slide-fade-enter-from {
  transform: translateX(-20px);
  opacity: 0;
}
.slide-fade-leave-to {
  transform: translateX(20px);
  opacity: 0;
}

.zoom-fade-enter-active {
  transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.zoom-fade-leave-active {
  transition: all 0.3s ease-in;
}
.zoom-fade-enter-from {
  transform: scale(0.9);
  opacity: 0;
}
.zoom-fade-leave-to {
  transform: scale(0.95);
  opacity: 0;
}

.fade-slide-enter-active,
.fade-slide-leave-active {
  transition: all 0.3s ease;
}
.fade-slide-enter-from,
.fade-slide-leave-to {
  opacity: 0;
  transform: translateY(-10px);
}

/* Element Plus 分隔線 */
:deep(.el-divider__text) {
  background: white;
  color: #c0c4cc;
}
</style>
</file>

<file path="frontend/src/views/maintenance/MtifForm.vue">
<script setup>
import { ref, onMounted, reactive, computed, watch } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import maintenanceApi from '@/api/modules/maintenance'
import Swal from 'sweetalert2'
import { useTicketConfig } from '@/composables/maintenance/useTicketConfig'
import TicketTimeline from '@/components/maintenance/TicketTimeline.vue'
import { ElMessage } from 'element-plus'

const route = useRoute()
const router = useRouter()
const ticketId = computed(() => Number(route.params.id))
const isEdit = computed(() => !isNaN(ticketId.value) && ticketId.value > 0)

const formRef = ref(null)
const timelineRef = ref(null)
const loading = ref(false)
const submitting = ref(false)
const formVisible = ref(false)
const activeStep = ref(0)

// ============ 圖片附件相關 ============
const uploadRef = ref(null) // el-upload ref
const attachments = ref([]) // 已上傳的附件清單
const fileList = ref([]) // 待上傳的檔案清單（新增模式暫存）
const attachmentNote = ref('') // 附件備註
const uploadingAttachments = ref(false) // 上傳中狀態
const showAttachmentSection = ref(false) // 是否顯示附件區塊（編輯模式立即顯示，新增模式在建單後顯示）

// 允許的圖片類型
const ALLOWED_IMAGE_TYPES = ['image/jpeg', 'image/png', 'image/webp']
const MAX_FILE_SIZE = 5 * 1024 * 1024 // 5MB
const MAX_FILE_COUNT = 5

// 維修目標類型：'spot' (機台) 或 'seat' (椅子)
const targetType = ref('spot')

const form = reactive({
  spotId: null,
  seatsId: null, // 新增：椅子 ID
  issueType: '',
  issueDesc: '',
  issuePriority: 'NORMAL',
  assignedStaffId: null,
})

const staffOptions = ref([])
const spotOptions = ref([])
const seatOptions = ref([]) // 新增：椅子選項

const STAFF_UI_STATUS = Object.freeze({
  IDLE: 'IDLE',
  ASSIGNED: 'ASSIGNED',
  MAINTENANCE: 'MAINTENANCE',
  MAINTAINING: 'MAINTAINING',
})

const staffUiStatusMap = ref({}) // { [staffId]: STAFF_UI_STATUS.* }

const getStaffUiTag = (staff) => {
  const st = staffUiStatusMap.value?.[staff.staffId] || STAFF_UI_STATUS.IDLE
  if (st === STAFF_UI_STATUS.MAINTAINING) return { type: 'danger', text: '保養中' }
  if (st === STAFF_UI_STATUS.MAINTENANCE) return { type: 'warning', text: '維修中' }
  if (st === STAFF_UI_STATUS.ASSIGNED) return { type: 'primary', text: '已指派' }
  return { type: 'success', text: '空閒中' }
}

// 取得進行中工單：優先用 active 端點；若只有 all，就前端過濾
const fetchActiveTicketsForStaffStatus = async () => {
  const tryCalls = [
    () => maintenanceApi.getActiveTickets?.(),
    () => maintenanceApi.getTicketsActive?.(),
    () => maintenanceApi.getAllTickets?.(),
    () => maintenanceApi.getTicketsAll?.(),
  ]

  for (const call of tryCalls) {
    try {
      const res = await call()
      if (Array.isArray(res?.data)) return res.data
    } catch (e) {
      // ignore
    }
  }
  return []
}

const refreshStaffStatusTags = async () => {
  if (!Array.isArray(staffOptions.value) || staffOptions.value.length === 0) return

  const tickets = await fetchActiveTicketsForStaffStatus()

  // 只看會影響人員狀態的「進行中」狀態
  const active = (tickets || []).filter((t) => {
    const s = String(t?.issueStatus || '')
      .trim()
      .toUpperCase()
    return s === 'ASSIGNED' || s === 'UNDER_MAINTENANCE'
  })

  // 優先級：保養中 > 維修中 > 已指派 > 空閒中
  const map = {}
  const priority = {
    [STAFF_UI_STATUS.IDLE]: 0,
    [STAFF_UI_STATUS.ASSIGNED]: 1,
    [STAFF_UI_STATUS.MAINTENANCE]: 2,
    [STAFF_UI_STATUS.MAINTAINING]: 3,
  }
  const setIfHigher = (staffId, next) => {
    if (!staffId) return
    const cur = map[staffId] || STAFF_UI_STATUS.IDLE
    if (priority[next] > priority[cur]) map[staffId] = next
  }

  // default：啟用人員先當空閒
  for (const s of staffOptions.value) {
    if (s?.staffId != null && s.isActive === true) map[s.staffId] = STAFF_UI_STATUS.IDLE
  }

  for (const t of active) {
    const staffId = t.assignedStaffId
    if (!staffId) continue

    const issueStatus = String(t.issueStatus || '')
      .trim()
      .toUpperCase()
    const issueType = String(t.issueType || '').trim()

    if (issueType === '保養') {
      // 保養中：只要是保養工單且已指派/進行中
      setIfHigher(staffId, STAFF_UI_STATUS.MAINTAINING)
    } else if (issueStatus === 'UNDER_MAINTENANCE') {
      setIfHigher(staffId, STAFF_UI_STATUS.MAINTENANCE)
    } else if (issueStatus === 'ASSIGNED') {
      setIfHigher(staffId, STAFF_UI_STATUS.ASSIGNED)
    }
  }

  staffUiStatusMap.value = map
}
// ========= [新增結束] =========

// ★ Bug3 修復：記錄編輯時原始的 assignedStaffId，用於判斷是否有變更
const originalAssignedStaffId = ref(null)

// ★ Bug3 修復：定義可編輯的狀態
const EDITABLE_STATUSES = ['REPORTED', 'ASSIGNED']

// 原來定義的 issueTypeOptions
// const { issueTypeOptions: sharedIssueTypes } = useTicketConfig()
// const issueTypeOptions = sharedIssueTypes

//修改：使用 computed 過濾掉 "保養"
const { issueTypeOptions: sharedIssueTypes } = useTicketConfig()

const issueTypeOptions = computed(() => {
  // 假設 sharedIssueTypes 是一個 Ref 陣列
  // 過濾條件：value 不等於 '保養' (或是看您的 config 裡是用 key 還是 value，通常是 value)
  return (sharedIssueTypes.value || sharedIssueTypes).filter((t) => t.value !== '保養')
})

// 優先級配置（擴展版，含描述）
const priorityConfig = {
  LOW: { color: '#909399', bgColor: '#f4f4f5', icon: '🔵', text: '低優先', desc: '可稍後處理' },
  NORMAL: { color: '#409eff', bgColor: '#ecf5ff', icon: '🟢', text: '普通', desc: '正常排程處理' },
  HIGH: { color: '#e6a23c', bgColor: '#fdf6ec', icon: '🟠', text: '高優先', desc: '優先安排處理' },
  URGENT: { color: '#f56c6c', bgColor: '#fef0f0', icon: '🔴', text: '緊急', desc: '立即處理' },
}

// 驗證規則
const rules = computed(() => ({
  spotId:
    targetType.value === 'spot'
      ? [{ required: true, message: '請選擇一個機台', trigger: 'change' }]
      : [],
  seatsId:
    targetType.value === 'seat'
      ? [{ required: true, message: '請選擇一張椅子', trigger: 'change' }]
      : [],
  issueType: [{ required: true, message: '請輸入或選擇問題類型', trigger: 'blur' }],
  issuePriority: [{ required: true, message: '請選擇優先級', trigger: 'change' }],
}))

// 計算表單完成度
const formProgress = computed(() => {
  let filled = 0
  if (targetType.value === 'spot' ? form.spotId : form.seatsId) filled++
  if (form.issueType) filled++
  if (form.issueDesc) filled++
  if (form.assignedStaffId) filled++
  return Math.round((filled / 4) * 100)
})

// 監聽表單變化，自動更新步驟指示
watch(
  () => (targetType.value === 'spot' ? form.spotId : form.seatsId),
  (val) => {
    if (val && activeStep.value === 0) activeStep.value = 1
  },
)
watch(
  () => form.issueType,
  (val) => {
    if (val && activeStep.value === 1) activeStep.value = 2
  },
)

// 切換維修類型時，清空已選擇的目標
watch(targetType, (newType) => {
  if (newType === 'spot') {
    form.seatsId = null
  } else {
    form.spotId = null
  }
})

onMounted(async () => {
  setTimeout(() => (formVisible.value = true), 100)

  loading.value = true
  try {
    // ★ Bug3 修復：先讀取工單資料，檢查狀態是否可編輯
    if (isEdit.value) {
      const ticketRes = await maintenanceApi.getTicketById(ticketId.value)
      const ticketData = ticketRes.data

      // ★ 問題A修復：使用正確的欄位名稱 issueStatus
      if (!EDITABLE_STATUSES.includes(ticketData.issueStatus)) {
        await Swal.fire({
          icon: 'warning', // ★ (2B) 改為 warning，不是系統錯誤
          title: '無法編輯',
          html: `
            <p style="color: #909399;">此工單狀態為「<b>${ticketData.issueStatus}</b>」，不允許編輯</p>
            <p style="color: #f56c6c; font-size: 13px; margin-top: 10px;">可編輯狀態：REPORTED, ASSIGNED</p>
          `,
          confirmButtonText: '返回列表',
        })
        router.push({ name: 'mtif-list' })
        return
      }

      // ★ Bug3 修復：記錄原始 assignedStaffId
      originalAssignedStaffId.value = ticketData.assignedStaffId

      // 載入其他資料
      const [spotRes, staffRes, seatRes] = await Promise.all([
        maintenanceApi.getAllSpots().catch(() => ({ data: [] })),
        maintenanceApi.getAllStaff().catch(() => ({ data: [] })), // 編輯時用 getAllStaff
        maintenanceApi.getAllSeats().catch(() => ({ data: [] })),
      ])

      spotOptions.value = Array.isArray(spotRes.data) ? spotRes.data : []
      staffOptions.value = staffRes.data || []
      await refreshStaffStatusTags()
      seatOptions.value = seatRes.data || []

      // ★ 如果原始人員已停用，要保留並顯示為 disabled
      if (ticketData.assignedStaffId) {
        const assignedStaff = staffOptions.value.find(
          (s) => s.staffId === ticketData.assignedStaffId,
        )
        if (assignedStaff && !assignedStaff.isActive) {
          assignedStaff.staffName = assignedStaff.staffName + ' (已停用)'
          assignedStaff.disabled = true
        }
      }

      // 賦值表單
      Object.assign(form, ticketData)
      // 根據資料判斷維修類型
      if (ticketData.seatsId) {
        targetType.value = 'seat'
      } else {
        targetType.value = 'spot'
      }
      activeStep.value = 3

      // === [編輯模式] 載入附件清單 ===
      showAttachmentSection.value = true
      await loadAttachments(ticketId.value)
    } else {
      // ★ Bug2 修復：建立時只載入啟用人員
      const [spotRes, staffRes, seatRes] = await Promise.all([
        maintenanceApi.getAllSpots().catch(() => ({ data: [] })),
        maintenanceApi.getActiveStaff().catch(() => ({ data: [] })), // ★ 改用 getActiveStaff
        maintenanceApi.getAllSeats().catch(() => ({ data: [] })),
      ])

      spotOptions.value = Array.isArray(spotRes.data) ? spotRes.data : []
      staffOptions.value = staffRes.data || []
      await refreshStaffStatusTags()
      seatOptions.value = seatRes.data || []

      if (spotOptions.value.length > 0) form.spotId = spotOptions.value[0].spotId
    }
  } catch (error) {
    console.error('Failed to load form data:', error)
    Swal.fire('錯誤', '載入失敗，請稍後再試', 'error')
    router.push({ name: 'mtif-list' })
  } finally {
    loading.value = false
  }
})

const selectIssueType = (type) => {
  form.issueType = type.value
}

// ============ 圖片附件功能 ============

/**
 * 載入工單附件清單
 */
const loadAttachments = async (ticketIdValue) => {
  try {
    const res = await maintenanceApi.getTicketAttachments(ticketIdValue)
    attachments.value = res.data || []
  } catch (error) {
    console.error('載入附件失敗:', error)
  }
}

/**
 * 檔案上傳前檢查
 */
const beforeUpload = (file) => {
  // 檢查檔案類型
  if (!ALLOWED_IMAGE_TYPES.includes(file.type)) {
    ElMessage.error(`不支援的檔案格式：${file.name}（僅允許 JPG, PNG, WEBP）`)
    return false
  }

  // 檢查檔案大小
  if (file.size > MAX_FILE_SIZE) {
    ElMessage.error(`檔案過大：${file.name}（最大 5MB）`)
    return false
  }

  // 檢查數量限制
  const currentCount = isEdit.value ? attachments.value.length : fileList.value.length
  if (currentCount >= MAX_FILE_COUNT) {
    ElMessage.error(`最多只能上傳 ${MAX_FILE_COUNT} 張圖片`)
    return false
  }

  return true
}

/**
 * 檔案選擇變更（新增模式：暫存到 fileList）
 */
const handleFileChange = (file, uploadFileList) => {
  if (isEdit.value) {
    // 編輯模式：直接上傳
    uploadAttachmentsToServer([file.raw])
  } else {
    // 新增模式：暫存到 fileList
    fileList.value = uploadFileList
  }
}

/**
 * 移除檔案（新增模式：從 fileList 移除）
 */
const handleRemoveFile = (file) => {
  const index = fileList.value.findIndex(f => f.uid === file.uid)
  if (index > -1) {
    fileList.value.splice(index, 1)
  }
}

/**
 * 上傳附件到伺服器
 */
const uploadAttachmentsToServer = async (files) => {
  if (!files || files.length === 0) return

  uploadingAttachments.value = true
  try {
    const res = await maintenanceApi.uploadTicketAttachments(
      ticketId.value,
      files,
      attachmentNote.value || null
    )

    ElMessage.success(`成功上傳 ${res.data.length} 張圖片`)
    
    // 重新載入附件清單
    await loadAttachments(ticketId.value)
    
    // 清空備註與 fileList
    attachmentNote.value = ''
    fileList.value = []
    
    // 清空 el-upload 的 fileList
    if (uploadRef.value) {
      uploadRef.value.clearFiles()
    }
  } catch (error) {
    console.error('上傳附件失敗:', error)
    const errorMsg = error?.response?.data?.message || '上傳失敗，請稍後再試'
    ElMessage.error(errorMsg)
  } finally {
    uploadingAttachments.value = false
  }
}

/**
 * 刪除附件
 */
const deleteAttachment = async (attachment) => {
  const result = await Swal.fire({
    title: '確認刪除圖片？',
    text: `將刪除圖片：${attachment.originalName}`,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#f56c6c',
    cancelButtonColor: '#909399',
    confirmButtonText: '<i class="fas fa-trash-alt mr-1"></i> 確認刪除',
    cancelButtonText: '取消',
  })

  if (!result.isConfirmed) return

  try {
    await maintenanceApi.deleteTicketAttachment(attachment.attachmentId)
    ElMessage.success('圖片已刪除')
    
    // 重新載入附件清單
    await loadAttachments(ticketId.value)
  } catch (error) {
    console.error('刪除附件失敗:', error)
    const errorMsg = error?.response?.data?.message || '刪除失敗，請稍後再試'
    Swal.fire('錯誤', errorMsg, 'error')
  }
}

/**
 * 預覽圖片
 */
const previewImage = (attachment) => {
  Swal.fire({
    imageUrl: `http://localhost:8080${attachment.publicUrl}`,
    imageAlt: attachment.originalName,
    showCloseButton: true,
    showConfirmButton: false,
    width: 'auto',
  })
}

const submit = async () => {
  if (!formRef.value) return

  await formRef.value.validate(async (valid) => {
    if (valid) {
      // 1. 取得選中的人員名稱 (為了顯示確認窗)
      const selectedStaff = staffOptions.value.find((s) => s.staffId === form.assignedStaffId)

      // 2. 顯示確認視窗
      const confirmResult = await Swal.fire({
        title: isEdit.value ? '確認更新工單？' : '確認建立工單？',
        html: `
          <div style="text-align: left; padding: 10px 0;">
            <div style="display: grid; gap: 12px;">
              <div style="padding: 12px; background: #f5f7fa; border-radius: 10px;">
                <p style="margin: 0 0 8px; color: #909399; font-size: 12px;">問題類型</p>
                <p style="margin: 0; font-size: 16px; font-weight: 600;">${form.issueType}</p>
              </div>
              <div style="padding: 12px; background: ${priorityConfig[form.issuePriority].bgColor}; border-radius: 10px; border-left: 4px solid ${priorityConfig[form.issuePriority].color};">
                <p style="margin: 0 0 8px; color: #909399; font-size: 12px;">優先級</p>
                <p style="margin: 0; font-size: 16px; font-weight: 600; color: ${priorityConfig[form.issuePriority].color};">
                   ${priorityConfig[form.issuePriority].icon} ${priorityConfig[form.issuePriority].text}
                </p>
              </div>
              ${
                selectedStaff
                  ? `
              <div style="padding: 12px; background: #f0f9eb; border-radius: 10px;">
                <p style="margin: 0 0 8px; color: #909399; font-size: 12px;">指派人員</p>
                <p style="margin: 0; font-size: 16px; font-weight: 600; color: #67c23a;">
                  <i class="fas fa-user-check mr-1"></i> ${selectedStaff.staffName}
                </p>
              </div>
              `
                  : ''
              }
            </div>
          </div>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#409eff',
        cancelButtonColor: '#909399',
        confirmButtonText: '<i class="fas fa-paper-plane mr-1"></i> 確認送出',
        cancelButtonText: '再檢查一下',
      })

      if (!confirmResult.isConfirmed) return

      submitting.value = true
      try {
        // ★ 關鍵修正：資料清洗（完整版）
        // 建立一個乾淨的物件，只包含後端需要的欄位
        const submitData = {
          spotId: form.spotId,
          seatsId: form.seatsId,
          issueType: form.issueType,
          issueDesc: form.issueDesc,
          issuePriority: form.issuePriority,
          assignedStaffId: form.assignedStaffId,
        }

        // 根據維修類型清除不需要的欄位
        if (targetType.value === 'spot') {
          submitData.seatsId = null
        } else if (targetType.value === 'seat') {
          submitData.spotId = null
        }

        if (isEdit.value) {
          // === [更新模式] ===
          // ★ 問題3修復：後端 updateTicket 已經處理 assignedStaffId 的更新與 Log 紀錄
          // 不需要額外呼叫 assignStaff API，完全依賴 updateTicket 即可
          await maintenanceApi.updateTicket(ticketId.value, submitData)

          await Swal.fire({
            icon: 'success',
            title: '更新成功！',
            text: '工單資料已更新',
            timer: 1200,
            showConfirmButton: false,
          })

          // 編輯模式不跳轉，留在當前頁面（可繼續管理附件）
        } else {
          // === [新增模式] ===
          const createRes = await maintenanceApi.createTicket(submitData)
          const newTicketId = createRes.data?.ticketId

          await Swal.fire({
            icon: 'success',
            title: '建立成功！',
            text: '新工單已建立',
            timer: 1500,
            showConfirmButton: false,
          })

          // 如果有選擇檔案，上傳附件
          if (fileList.value.length > 0 && newTicketId) {
            try {
              const files = fileList.value.map(f => f.raw)
              await maintenanceApi.uploadTicketAttachments(
                newTicketId,
                files,
                attachmentNote.value || null
              )
              ElMessage.success(`成功上傳 ${files.length} 張圖片`)
            } catch (error) {
              console.error('上傳附件失敗:', error)
              ElMessage.warning('工單已建立，但附件上傳失敗')
            }
          }

          // 跳轉回列表頁
          router.push({ name: 'mtif-list' })
        }
      } catch (error) {
        console.error('Submit failed:', error)
        // ★ Bug3 修復：顯示後端回傳的錯誤訊息
        const errorMsg = error?.response?.data?.message || '操作失敗，請稍後再試'
        Swal.fire('錯誤', errorMsg, 'error')
      } finally {
        submitting.value = false
      }
    }
  })
}

// ✅ DEMO 專用：一鍵帶入故障工單
const handleDemoFill = () => {
  // 1. 設定為機台模式
  targetType.value = 'spot'

  // 2. 2. 自動選取第一個 "營運中" 的機台 (修正邏輯：跳過維修中機台)
  if (spotOptions.value && spotOptions.value.length > 0) {
    // 取得第一個營運中機台
    const availableSpot = spotOptions.value.find((s) => s.spotStatus === '營運中')

    // 如果找到，帶入；否則顯示提示
    if (availableSpot) {
      form.spotId = availableSpot.spotId
    } else {
      // 如果全部都在維修中，顯示提示
      Swal.fire({
        icon: 'warning',
        title: '無可選擇的機台',
        text: '目前所有機台皆在維修中',
        toast: true,
        position: 'top-end',
        timer: 900,
      })
      return // 終止
    }
  }

  // 3. 填寫故障情境
  form.issueType = '機台故障異常' // 確保這個文字跟按鈕上的 value 一樣
  form.issueDesc = '機台運作時發出異音，且螢幕畫面閃爍，目前已先暫停使用，請盡快派人員來做檢查。'
  form.issuePriority = 'HIGH' // 設定為高優先

  // 4. (選填) 指派給第一個啟用的人員
  const activeStaff = staffOptions.value.find((s) => s.isActive)
  if (activeStaff) {
    form.assignedStaffId = activeStaff.staffId
  }

  // 5. 提示
  Swal.fire({
    icon: 'success',
    title: '新增資料成功',
    text: '資料已帶入',
    timer: 1500,
    showConfirmButton: false,
    toast: true,
    position: 'top-end',
  })
}

const handleCancel = async () => {
  if (form.issueType || form.issueDesc) {
    const result = await Swal.fire({
      title: '確定要離開嗎？',
      text: '您填寫的工單資料將不會被保存',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#e6a23c',
      cancelButtonColor: '#909399',
      confirmButtonText: '離開',
      cancelButtonText: '繼續編輯',
      showClass: { popup: 'animate__animated animate__fadeIn animate__faster' },
    })
    if (!result.isConfirmed) return
  }
  router.push('/admin/mtif-list')
}
</script>

<template>
  <div class="ticket-form-container">
    <!-- 頁面標題區 -->
    <section class="content-header">
      <div class="container-fluid">
        <transition name="slide-fade" appear>
          <div class="page-title-box">
            <div class="title-icon" :class="isEdit ? 'edit-mode' : 'add-mode'">
              <i :class="isEdit ? 'fas fa-ticket-alt' : 'fas fa-plus-circle'"></i>
            </div>
            <div class="title-content">
              <h1>{{ isEdit ? '編輯維修工單' : '建立新工單' }}</h1>
              <p class="subtitle">
                {{ isEdit ? '修改現有工單資訊' : '填寫問題詳情以建立維修工單' }}
              </p>
            </div>
            <div class="title-progress" v-if="!isEdit">
              <div class="progress-ring">
                <el-progress
                  type="circle"
                  :percentage="formProgress"
                  :width="60"
                  :stroke-width="6"
                  :color="formProgress === 100 ? '#67c23a' : '#409eff'"
                />
              </div>
              <span class="progress-text">完成度</span>
            </div>
          </div>
        </transition>
      </div>
    </section>

    <!-- 表單主體 -->
    <section class="content">
      <div class="container-fluid d-flex justify-content-center">
        <transition name="zoom-fade" appear>
          <el-card
            v-show="formVisible"
            shadow="hover"
            class="form-card"
            v-loading="loading"
            element-loading-text="載入中..."
          >
            <template #header>
              <div class="card-header-content">
                <div class="header-left">
                  <span class="header-icon">
                    <i class="fas fa-clipboard-list"></i>
                  </span>
                  <span class="header-text">工單資訊</span>
                  <el-tag v-if="isEdit" type="warning" effect="plain" size="small" class="ml-2">
                    #{{ ticketId }}
                  </el-tag>
                </div>
                <el-button class="cancel-btn" text type="info" @click="handleCancel">
                  <i class="fas fa-times mr-1"></i> 取消
                </el-button>
              </div>
            </template>

            <!-- 步驟指示器 -->
            <div class="steps-indicator" v-if="!isEdit">
              <el-steps :active="activeStep" finish-status="success" simple>
                <el-step title="選擇場地" icon="Location" />
                <el-step title="問題描述" icon="Edit" />
                <el-step title="設定優先級" icon="Flag" />
                <el-step title="指派人員" icon="User" />
              </el-steps>
            </div>

            <el-form
              ref="formRef"
              :model="form"
              :rules="rules"
              label-position="top"
              status-icon
              class="ticket-form"
            >
              <!-- 維修目標類型切換 -->
              <el-form-item class="form-item-animated">
                <template #label>
                  <span class="custom-label">
                    <i class="fas fa-wrench label-icon"></i> 維修目標
                    <span class="required-star">*</span>
                  </span>
                </template>
                <div class="target-type-switch">
                  <div
                    class="target-type-option"
                    :class="{ active: targetType === 'spot' }"
                    @click="targetType = 'spot'"
                  >
                    <i class="fas fa-desktop"></i>
                    <span>機台</span>
                  </div>
                  <div
                    class="target-type-option"
                    :class="{ active: targetType === 'seat' }"
                    @click="targetType = 'seat'"
                  >
                    <i class="fas fa-chair"></i>
                    <span>椅子</span>
                  </div>
                </div>
              </el-form-item>

              <!-- 機台選擇 (當 targetType === 'spot') -->
              <el-form-item
                v-if="targetType === 'spot'"
                label="場地選擇"
                prop="spotId"
                class="form-item-animated"
              >
                <template #label>
                  <span class="custom-label">
                    <i class="fas fa-desktop label-icon"></i> 選擇機台
                    <span class="required-star">*</span>
                  </span>
                </template>
                <el-select
                  v-model="form.spotId"
                  placeholder="請選擇或搜尋機台..."
                  class="w-100"
                  filterable
                  :disabled="isEdit"
                  size="large"
                  popper-class="mt-spot-select-popper"
                >
                  <template #prefix>
                    <i class="fas fa-search"></i>
                  </template>

                  <el-option
                    v-for="spot in spotOptions"
                    :key="spot.spotId"
                    :label="`${spot.spotCode || spot.spotId} - ${spot.spotName} (${spot.spotStatus || '未知'})`"
                    :value="spot.spotId"
                    :disabled="spot.spotStatus && spot.spotStatus !== '營運中'"
                    style="height: auto; padding: 2px 8px"
                  >
                    <div class="spot-option" style="padding: 2px 0">
                      <span class="spot-code">{{ spot.spotCode || spot.spotId }}</span>
                      <span class="spot-name">{{ spot.spotName }}</span>

                      <el-tag
                        :type="
                          !spot.spotStatus || spot.spotStatus === '營運中' ? 'success' : 'danger'
                        "
                        size="small"
                        effect="plain"
                        style="margin-left: 8px"
                      >
                        {{ spot.spotStatus || '未知' }}
                      </el-tag>
                    </div>
                  </el-option>
                </el-select>
                <small v-if="spotOptions.length === 0" class="text-warning">
                  <i class="fas fa-exclamation-triangle mr-1"></i> 無可用機台資料
                </small>
              </el-form-item>

              <!-- 椅子選擇 (當 targetType === 'seat') -->
              <el-form-item
                v-if="targetType === 'seat'"
                label="椅子選擇"
                prop="seatsId"
                class="form-item-animated"
              >
                <template #label>
                  <span class="custom-label">
                    <i class="fas fa-chair label-icon"></i> 選擇椅子
                    <span class="required-star">*</span>
                  </span>
                </template>
                <el-select
                  v-model="form.seatsId"
                  placeholder="請選擇或搜尋椅子..."
                  class="w-100"
                  filterable
                  :disabled="isEdit"
                  size="large"
                >
                  <template #prefix>
                    <i class="fas fa-search"></i>
                  </template>
                  <el-option
                    v-for="seat in seatOptions"
                    :key="seat.seatsId"
                    :label="`${seat.seatsName || seat.seatsId} (${seat.seatsType || '一般'})`"
                    :value="seat.seatsId"
                  >
                    <div class="seat-option">
                      <span class="seat-icon">🪑</span>
                      <div class="seat-info">
                        <span class="seat-name">{{
                          seat.seatsName || `椅子 #${seat.seatsId}`
                        }}</span>
                        <span class="seat-type"
                          >{{ seat.seatsType || '一般座椅' }} ·
                          {{ seat.seatsStatus || '正常' }}</span
                        >
                      </div>
                    </div>
                  </el-option>
                </el-select>
                <small v-if="seatOptions.length === 0" class="text-warning">
                  <i class="fas fa-exclamation-triangle mr-1"></i> 無可用椅子資料
                </small>
              </el-form-item>

              <!-- 問題類型 -->
              <el-form-item label="問題類型" prop="issueType" class="form-item-animated">
                <template #label>
                  <span class="custom-label">
                    <i class="fas fa-exclamation-circle label-icon"></i> 問題類型
                    <span class="required-star">*</span>
                  </span>
                </template>

                <!-- 快速選擇區 -->
                <div class="quick-select-grid">
                  <div
                    v-for="type in issueTypeOptions"
                    :key="type.value"
                    class="quick-select-item"
                    :class="{ active: form.issueType === type.value }"
                    @click="selectIssueType(type)"
                  >
                    <span class="item-icon">{{ type.icon }}</span>
                    <span class="item-text">{{ type.value }}</span>
                  </div>
                </div>

                <el-input
                  v-model="form.issueType"
                  placeholder="或自行輸入問題類型..."
                  size="large"
                  class="mt-2"
                  clearable
                />
              </el-form-item>

              <!-- 詳細描述 -->
              <el-form-item label="詳細描述" prop="issueDesc" class="form-item-animated">
                <template #label>
                  <span class="custom-label">
                    <i class="fas fa-align-left label-icon"></i> 詳細描述
                  </span>
                </template>
                <el-input
                  v-model="form.issueDesc"
                  type="textarea"
                  :rows="4"
                  placeholder="請詳細描述問題狀況，例如：故障位置、發生時間、嚴重程度等..."
                  show-word-limit
                  maxlength="1000"
                  class="custom-textarea"
                />
              </el-form-item>

              <!-- 優先級選擇 -->
              <el-form-item label="優先級" prop="issuePriority" class="form-item-animated">
                <template #label>
                  <span class="custom-label">
                    <i class="fas fa-flag label-icon"></i> 優先級
                    <span class="required-star">*</span>
                  </span>
                </template>
                <div class="priority-cards">
                  <div
                    v-for="(config, key) in priorityConfig"
                    :key="key"
                    class="priority-card"
                    :class="{ active: form.issuePriority === key }"
                    :style="{
                      '--card-color': config.color,
                      '--card-bg': config.bgColor,
                    }"
                    @click="form.issuePriority = key"
                  >
                    <span class="priority-icon">{{ config.icon }}</span>
                    <span class="priority-text">{{ config.text }}</span>
                    <span class="priority-desc">{{ config.desc }}</span>
                  </div>
                </div>
              </el-form-item>

              <!-- 指派維修員 -->
              <el-form-item label="指派維修員" prop="assignedStaffId" class="form-item-animated">
                <template #label>
                  <span class="custom-label">
                    <i class="fas fa-user-cog label-icon"></i> 指派維修員
                    <el-tag type="info" size="small" class="ml-2">選填</el-tag>
                  </span>
                </template>
                <el-select
                  popper-class="mt-staff-select-popper"
                  v-model="form.assignedStaffId"
                  placeholder="暫不指派，稍後可編輯"
                  class="w-100"
                  filterable
                  clearable
                  size="large"
                >
                  <!-- ★ 問題2修復：過濾只顯示啟用人員，或當前工單已指派的人員（即使已停用） -->
                  <el-option
                    v-for="s in staffOptions.filter(
                      (staff) =>
                        staff.isActive === true || staff.staffId === originalAssignedStaffId,
                    )"
                    :key="s.staffId"
                    :label="`${s.staffName}${s.isActive === false ? ' (已停用)' : ''} (${s.staffCompany || '外部'})`"
                    :value="s.staffId"
                    :disabled="s.isActive === false && s.staffId !== form.assignedStaffId"
                  >
                    <!-- ✅【修正#3】改成左右兩欄：左邊姓名公司、右邊顯示狀態 -->
                    <div class="staff-option">
                      <div class="staff-left">
                        <div
                          class="staff-avatar"
                          :style="{ opacity: s.isActive === false ? 0.5 : 1 }"
                        >
                          {{ s.staffName?.charAt(0) }}
                        </div>

                        <div class="staff-info">
                          <span
                            class="staff-name"
                            :style="{ color: s.isActive === false ? '#909399' : '' }"
                          >
                            {{ s.staffName }}
                            <el-tag
                              v-if="s.isActive === false"
                              type="info"
                              size="small"
                              class="ml-1"
                              >已停用</el-tag
                            >
                          </span>
                          <span class="staff-company">{{ s.staffCompany || '外部人員' }}</span>
                        </div>
                      </div>

                      <!-- 【修正#3】顯示：已指派 / 維修中 / 保養中 / 空閒中 -->
                      <div class="staff-right">
                        <el-tag
                          :type="getStaffUiTag(s).type"
                          size="small"
                          effect="plain"
                          :disable-transitions="true"
                        >
                          {{ getStaffUiTag(s).text }}
                        </el-tag>
                      </div>
                    </div>
                  </el-option>
                </el-select>
              </el-form-item>

              <!-- ============ 圖片附件區塊 ============ -->
              <el-form-item 
                v-if="isEdit" 
                label="圖片附件" 
                class="form-item-animated"
              >
                <template #label>
                  <span class="custom-label">
                    <i class="fas fa-images label-icon"></i> 圖片附件
                    <el-tag type="info" size="small" class="ml-2">選填</el-tag>
                  </span>
                </template>

                <!-- 上傳區 -->
                <div class="attachment-upload-area">
                  <el-upload
                    ref="uploadRef"
                    :auto-upload="false"
                    :on-change="handleFileChange"
                    :on-remove="handleRemoveFile"
                    :before-upload="beforeUpload"
                    :file-list="fileList"
                    accept="image/jpeg,image/png,image/webp"
                    list-type="picture-card"
                    :limit="MAX_FILE_COUNT"
                    :disabled="uploadingAttachments"
                  >
                    <template #default>
                      <div class="upload-trigger">
                        <i class="fas fa-plus"></i>
                        <div class="upload-text">選擇圖片</div>
                      </div>
                    </template>
                    <template #tip>
                      <div class="el-upload__tip">
                        <i class="fas fa-info-circle"></i>
                        支援 JPG、PNG、WEBP 格式，單張最大 5MB，最多 {{ MAX_FILE_COUNT }} 張
                      </div>
                    </template>
                  </el-upload>

                  <!-- 備註輸入 -->
                  <el-input
                    v-if="fileList.length > 0"
                    v-model="attachmentNote"
                    placeholder="選填：為這批圖片加上備註..."
                    class="mt-2"
                    clearable
                    maxlength="200"
                    show-word-limit
                  />

                  <!-- 立即上傳按鈕（編輯模式） -->
                  <el-button
                    v-if="isEdit && fileList.length > 0"
                    type="primary"
                    :loading="uploadingAttachments"
                    @click="uploadAttachmentsToServer(fileList.map(f => f.raw))"
                    class="mt-2"
                  >
                    <i class="fas fa-upload mr-1"></i>
                    {{ uploadingAttachments ? '上傳中...' : '立即上傳' }}
                  </el-button>
                </div>

                <!-- 已上傳的附件清單 -->
                <div v-if="attachments.length > 0" class="attachments-list mt-3">
                  <el-divider content-position="left">
                    <span style="color: #909399; font-size: 13px;">
                      <i class="fas fa-paperclip mr-1"></i>
                      已上傳附件 ({{ attachments.length }})
                    </span>
                  </el-divider>

                  <div class="attachments-grid">
                    <div 
                      v-for="att in attachments" 
                      :key="att.attachmentId" 
                      class="attachment-item"
                    >
                      <!-- 圖片預覽 -->
                      <div class="attachment-preview" @click="previewImage(att)">
                        <img 
                          :src="`http://localhost:8080${att.publicUrl}`" 
                          :alt="att.originalName"
                          @error="$event.target.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2YwZjBmMCIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgZm9udC1zaXplPSIxNCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iIGZpbGw9IiM5OTkiPu+/ve+/ve+/vTwvdGV4dD48L3N2Zz4='"
                        />
                        <div class="preview-overlay">
                          <i class="fas fa-search-plus"></i>
                        </div>
                      </div>

                      <!-- 附件資訊 -->
                      <div class="attachment-info">
                        <div class="attachment-name" :title="att.originalName">
                          {{ att.originalName }}
                        </div>
                        <div class="attachment-meta">
                          <span class="meta-item">
                            <i class="fas fa-clock"></i>
                            {{ att.createdAt }}
                          </span>
                          <span class="meta-item">
                            <i class="fas fa-hdd"></i>
                            {{ (att.fileSize / 1024).toFixed(1) }} KB
                          </span>
                        </div>
                        <div v-if="att.note" class="attachment-note">
                          <i class="fas fa-comment-dots"></i>
                          {{ att.note }}
                        </div>
                      </div>

                      <!-- 刪除按鈕 -->
                      <el-button
                        type="danger"
                        size="small"
                        circle
                        class="delete-btn"
                        @click="deleteAttachment(att)"
                        :title="`刪除 ${att.originalName}`"
                      >
                        <i class="fas fa-trash-alt"></i>
                      </el-button>
                    </div>
                  </div>
                </div>
              </el-form-item>

              <!-- 新增模式：提示可在建立後上傳附件 -->
              <el-form-item 
                v-else 
                label="圖片附件" 
                class="form-item-animated"
              >
                <template #label>
                  <span class="custom-label">
                    <i class="fas fa-images label-icon"></i> 圖片附件
                    <el-tag type="info" size="small" class="ml-2">選填</el-tag>
                  </span>
                </template>

                <!-- 新增模式的上傳區 -->
                <div class="attachment-upload-area">
                  <el-upload
                    ref="uploadRef"
                    :auto-upload="false"
                    :on-change="handleFileChange"
                    :on-remove="handleRemoveFile"
                    :before-upload="beforeUpload"
                    :file-list="fileList"
                    accept="image/jpeg,image/png,image/webp"
                    list-type="picture-card"
                    :limit="MAX_FILE_COUNT"
                  >
                    <template #default>
                      <div class="upload-trigger">
                        <i class="fas fa-plus"></i>
                        <div class="upload-text">選擇圖片</div>
                      </div>
                    </template>
                    <template #tip>
                      <div class="el-upload__tip">
                        <i class="fas fa-info-circle"></i>
                        建立工單後將自動上傳所選圖片（支援 JPG、PNG、WEBP，單張最大 5MB）
                      </div>
                    </template>
                  </el-upload>

                  <!-- 備註輸入 -->
                  <el-input
                    v-if="fileList.length > 0"
                    v-model="attachmentNote"
                    placeholder="選填：為這批圖片加上備註..."
                    class="mt-2"
                    clearable
                    maxlength="200"
                    show-word-limit
                  />
                </div>
              </el-form-item>

              <!-- 分隔線 -->
              <el-divider>
                <i class="fas fa-paper-plane"></i>
              </el-divider>

              <!-- 按鈕區 -->
              <el-form-item class="form-actions">
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    width: 100%;
                    align-items: center;
                  "
                >
                  <div class="left-buttons">
                    <el-button
                      type="primary"
                      @click="submit"
                      :loading="submitting"
                      size="large"
                      class="submit-btn"
                    >
                      <i class="fas fa-paper-plane mr-2" v-if="!submitting"></i>
                      <span>{{ submitting ? '處理中...' : isEdit ? '更新工單' : '建立工單' }}</span>
                    </el-button>

                    <el-button @click="handleCancel" size="large" class="back-btn ml-3">
                      <i class="fas fa-arrow-left mr-2"></i> 返回列表
                    </el-button>
                  </div>

                  <div class="right-buttons">
                    <el-button
                      type="warning"
                      link
                      @click="handleDemoFill"
                      style="opacity: 0.5; font-weight: normal"
                      onmouseover="this.style.opacity=1"
                      onmouseout="this.style.opacity=0.5"
                    >
                      <i class="fas fa-magic mr-1"></i> 一鍵帶入
                    </el-button>
                  </div>
                </div>
              </el-form-item>
            </el-form>
          </el-card>
        </transition>
      </div>
    </section>
  </div>
  <!-- 維修歷程紀錄 -->
  <div class="page-container">
    <el-card v-if="ticketId" class="mt-4" shadow="hover">
      <template #header>
        <div class="card-header">
          <span>維修歷程紀錄</span>
        </div>
      </template>
      <TicketTimeline ref="timelineRef" :ticketId="ticketId" />
    </el-card>
  </div>
</template>

<style scoped>
.ticket-form-container {
  min-height: 100vh;
  background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
  padding-bottom: 40px;
}

/* ============ 圖片附件樣式 ============ */
.attachment-upload-area {
  width: 100%;
}

.upload-trigger {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 8px;
  color: #8c939d;
  font-size: 14px;
}

.upload-trigger i {
  font-size: 28px;
}

.upload-text {
  font-size: 12px;
}

:deep(.el-upload__tip) {
  color: #909399;
  font-size: 12px;
  margin-top: 8px;
  line-height: 1.5;
}

.attachments-list {
  padding: 16px;
  background: #f9fafb;
  border-radius: 8px;
  border: 1px solid #e4e7ed;
}

.attachments-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 16px;
}

.attachment-item {
  position: relative;
  background: white;
  border-radius: 8px;
  overflow: hidden;
  border: 1px solid #e4e7ed;
  transition: all 0.3s ease;
}

.attachment-item:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  transform: translateY(-2px);
}

.attachment-preview {
  position: relative;
  width: 100%;
  height: 180px;
  cursor: pointer;
  overflow: hidden;
  background: #f5f7fa;
}

.attachment-preview img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.3s ease;
}

.attachment-item:hover .attachment-preview img {
  transform: scale(1.05);
}

.preview-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.attachment-preview:hover .preview-overlay {
  opacity: 1;
}

.preview-overlay i {
  font-size: 32px;
  color: white;
}

.attachment-info {
  padding: 12px;
}

.attachment-name {
  font-size: 14px;
  font-weight: 600;
  color: #303133;
  margin-bottom: 8px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.attachment-meta {
  display: flex;
  gap: 12px;
  font-size: 12px;
  color: #909399;
  margin-bottom: 6px;
}

.meta-item {
  display: flex;
  align-items: center;
  gap: 4px;
}

.attachment-note {
  font-size: 12px;
  color: #606266;
  background: #f0f9ff;
  padding: 6px 8px;
  border-radius: 4px;
  border-left: 3px solid #409eff;
  margin-top: 8px;
  line-height: 1.4;
}

.attachment-note i {
  color: #409eff;
  margin-right: 4px;
}

.delete-btn {
  position: absolute;
  top: 8px;
  right: 8px;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.attachment-item:hover .delete-btn {
  opacity: 1;
}

.content-header {
  padding: 20px 1rem;
}

.page-title-box {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 20px 24px;
  background: white;
  border-radius: 16px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
}

.title-icon {
  width: 60px;
  height: 60px;
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 26px;
  color: white;
  transition: transform 0.3s ease;
}

.title-icon:hover {
  transform: scale(1.1) rotate(5deg);
}

.title-icon.add-mode {
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
}

.title-icon.edit-mode {
  background: linear-gradient(135deg, #e6a23c 0%, #f3d19e 100%);
}

.title-content {
  flex: 1;
}

.title-content h1 {
  margin: 0;
  font-size: 1.6rem;
  font-weight: 700;
  color: #303133;
}

.title-content .subtitle {
  margin: 6px 0 0;
  font-size: 0.9rem;
  color: #909399;
}

.title-progress {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}

.progress-text {
  font-size: 12px;
  color: #909399;
}

/* 表單卡片 */
.form-card {
  width: 100%;
  max-width: 800px;
  border-radius: 16px;
  overflow: hidden;
  border: none;
  transition: all 0.3s ease;
}

.form-card:hover {
  box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
}

.card-header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 10px;
}

.header-icon {
  width: 36px;
  height: 36px;
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 16px;
}

.header-text {
  font-weight: 600;
  font-size: 1.1rem;
  color: #303133;
}

/* 步驟指示器 */
.steps-indicator {
  padding: 16px 0 24px;
  border-bottom: 1px dashed #ebeef5;
  margin-bottom: 20px;
}

/* 表單樣式 */
.ticket-form {
  padding: 10px 20px;
}

.custom-label {
  display: flex;
  align-items: center;
  gap: 6px;
  font-weight: 500;
  color: #606266;
}

.label-icon {
  color: #409eff;
  font-size: 14px;
}

.required-star {
  color: #f56c6c;
  margin-left: 2px;
}

.form-item-animated {
  animation: fadeInUp 0.5s ease forwards;
  opacity: 0;
}

.form-item-animated:nth-child(1) {
  animation-delay: 0.1s;
}
.form-item-animated:nth-child(2) {
  animation-delay: 0.15s;
}
.form-item-animated:nth-child(3) {
  animation-delay: 0.2s;
}
.form-item-animated:nth-child(4) {
  animation-delay: 0.25s;
}
.form-item-animated:nth-child(5) {
  animation-delay: 0.3s;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* 場地選項樣式 */
.spot-option {
  display: flex;
  align-items: center;
  gap: 10px;
}

.spot-code {
  background: #409eff;
  color: white;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 600;
}

.spot-name {
  color: #606266;
}

/* 維修目標類型切換 */
.target-type-switch {
  display: flex;
  gap: 16px;
  width: 100%;
}

.target-type-option {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 10px;
  padding: 20px;
  background: #f5f7fa;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  border: 2px solid transparent;
}

.target-type-option:hover {
  background: #ecf5ff;
  transform: translateY(-2px);
}

.target-type-option.active {
  background: linear-gradient(135deg, #ecf5ff 0%, #e6f4ff 100%);
  border-color: #409eff;
  box-shadow: 0 4px 15px rgba(64, 158, 255, 0.2);
}

.target-type-option i {
  font-size: 28px;
  color: #909399;
  transition: all 0.3s ease;
}

.target-type-option.active i {
  color: #409eff;
  transform: scale(1.1);
}

.target-type-option span {
  font-weight: 600;
  font-size: 14px;
  color: #606266;
}

.target-type-option.active span {
  color: #409eff;
}

/* 椅子選項樣式 */
.seat-option {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 4px 0;
}

.seat-icon {
  font-size: 20px;
}

.seat-info {
  display: flex;
  flex-direction: column;
}

.seat-name {
  font-weight: 500;
  color: #303133;
}

.seat-type {
  font-size: 12px;
  color: #909399;
}

/* 快速選擇區 - 橫排設計 */
.quick-select-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
}

.quick-select-item {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 8px;
  padding: 12px 20px;
  background: #f5f7fa;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.3s ease;
  border: 2px solid transparent;
  flex-shrink: 0;
}

.quick-select-item:hover {
  background: #ecf5ff;
  transform: translateY(-2px);
}

.quick-select-item.active {
  background: #ecf5ff;
  border-color: #409eff;
}

.item-icon {
  font-size: 22px;
}

.item-text {
  font-size: 14px;
  color: #606266;
  font-weight: 500;
  white-space: nowrap;
}

/* 優先級卡片 */
.priority-cards {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
}

@media (max-width: 768px) {
  .priority-cards {
    grid-template-columns: repeat(2, 1fr);
  }
}

.priority-card {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 16px 12px;
  background: var(--card-bg);
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  border: 2px solid transparent;
}

.priority-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
}

.priority-card.active {
  border-color: var(--card-color);
  transform: scale(1.05);
}

.priority-icon {
  font-size: 28px;
  margin-bottom: 8px;
}

.priority-text {
  font-weight: 600;
  color: var(--card-color);
  margin-bottom: 4px;
}

.priority-desc {
  font-size: 11px;
  color: #909399;
  text-align: center;
}

/* 維修員選項 */
/* 維修員選項：左右佈局 + 足夠高度，避免公司文字被蓋 */
.staff-option {
  display: flex;
  align-items: center;
  justify-content: space-between; /* 右側留給狀態 tag */
  gap: 12px;
  padding: 8px 6px;
  height: auto !important;
  line-height: 1.4;
}

/* 左側群組（頭像 + 文字） */
.staff-left {
  display: flex;
  align-items: center;
  gap: 10px;
  min-width: 0; /* ✅ 允許文字省略 */
  flex: 1;
}

.staff-avatar {
  width: 36px;
  height: 36px;
  background: linear-gradient(135deg, #67c23a 0%, #95d475 100%);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 600;
  font-size: 14px;
  flex-shrink: 0;
  box-shadow: 0 2px 6px rgba(103, 194, 58, 0.2);
}

.staff-info {
  display: flex;
  flex-direction: column;
  justify-content: center;
  min-width: 0; /*  允許省略 */
  overflow: hidden;
}

.staff-name {
  font-weight: 600;
  font-size: 14px;
  color: #303133;
  line-height: 1.25;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.staff-company {
  font-size: 12px;
  color: #909399;
  line-height: 1.2;
  margin-top: 3px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* 右側狀態 tag */
.staff-right {
  flex-shrink: 0;
  margin-left: 10px;
}

/* 按鈕區 */
.form-actions {
  margin-top: 20px;
}

.submit-btn {
  min-width: 160px;
  border-radius: 12px;
  font-weight: 600;
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
  border: none;
  transition: all 0.3s ease;
}

.submit-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(64, 158, 255, 0.4);
}

.back-btn {
  min-width: 120px;
  border-radius: 12px;
  transition: all 0.3s ease;
}

.back-btn:hover {
  transform: translateX(-3px);
}

/* 過渡動畫 */
.slide-fade-enter-active {
  transition: all 0.4s ease-out;
}
.slide-fade-leave-active {
  transition: all 0.3s ease-in;
}
.slide-fade-enter-from {
  transform: translateX(-20px);
  opacity: 0;
}
.slide-fade-leave-to {
  transform: translateX(20px);
  opacity: 0;
}

.zoom-fade-enter-active {
  transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.zoom-fade-leave-active {
  transition: all 0.3s ease-in;
}
.zoom-fade-enter-from {
  transform: scale(0.9);
  opacity: 0;
}
.zoom-fade-leave-to {
  transform: scale(0.95);
  opacity: 0;
}

/* 輔助類 */
.w-100 {
  width: 100%;
}
.mt-2 {
  margin-top: 8px;
}
.ml-2 {
  margin-left: 8px;
}
.mr-1 {
  margin-right: 4px;
}
.mr-2 {
  margin-right: 8px;
}
.text-warning {
  color: #e6a23c;
}

:deep(.el-divider__text) {
  background: white;
  color: #c0c4cc;
}

.custom-textarea :deep(.el-textarea__inner) {
  border-radius: 10px;
}

/* 【修正#2】機台選單：縮小上下 padding，讓間隔不要太大 */
:deep(.mt-spot-select-popper .el-select-dropdown__item) {
  height: auto !important;
  line-height: 1.2 !important;
  padding-top: 4px !important;
  padding-bottom: 4px !important;
}

/* 【修正#3】維修員選單：保留較舒適的高度，避免兩行文字被蓋到 */
:deep(.mt-staff-select-popper .el-select-dropdown__item) {
  height: auto !important;
  line-height: 1.4 !important;
  padding-top: 10px !important;
  padding-bottom: 10px !important;
}
</style>
</file>

<file path="frontend/src/views/maintenance/ScheduleForm.vue">
<script setup>
import { ref, reactive, computed, onMounted, watch } from 'vue'
import { useRouter, useRoute } from 'vue-router'
import maintenanceApi from '@/api/modules/maintenance'
import Swal from 'sweetalert2'
import { useScheduleConfig } from '@/composables/maintenance/useScheduleConfig'
import { Setting, Aim, Clock, User, Check } from '@element-plus/icons-vue'

const router = useRouter()
const route = useRoute()
const { scheduleTypeConfig, priorityConfig, formatScheduleDetail } = useScheduleConfig()

// ====== 編輯模式判斷 ======
const isEdit = computed(() => !!route.params.id)
const pageTitle = computed(() => (isEdit.value ? '編輯排程' : '新增排程'))

// FIX: 驗證 route param id 是否為有效數字（防止字串 ID 如 DEMO_xxx 進入編輯頁）
const isValidRouteId = computed(() => {
  if (!route.params.id) return true // 新增模式不需驗證
  const id = route.params.id
  return /^\d+$/.test(id) // 必須是純數字
})

// ====== 步驟控制 ======
const currentStep = ref(0)
const steps = [
  { title: '基本資訊', icon: Setting },
  { title: '目標設定', icon: Aim },
  { title: '排程設定', icon: Clock },
  { title: '指派人員', icon: User },
  { title: '確認送出', icon: Check },
]

// ====== 表單資料 ======
const formRef = ref(null)
const loading = ref(false)
const submitting = ref(false)

const form = reactive({
  title: '',
  targetType: 'SPOT',
  targetId: null,
  scheduleType: 'DAILY',
  dayOfWeek: null,
  dayOfMonth: null,
  executeTime: '09:00:00',
  issueType: '',
  issuePriority: 'NORMAL',
  assignedStaffId: null,
  isActive: true,
})

// ====== 下拉選項資料 ======
const spotOptions = ref([])
const seatOptions = ref([])
const staffOptions = ref([])

// ====== 配置選項 ======
const scheduleTypeOptions = [
  { label: '每日', value: 'DAILY', desc: '每天固定時間執行', icon: 'fas fa-sun' },
  { label: '每週', value: 'WEEKLY', desc: '每週固定星期執行', icon: 'fas fa-calendar-week' },
  { label: '每月', value: 'MONTHLY', desc: '每月固定日期執行', icon: 'fas fa-calendar-alt' },
]

const dayOfWeekOptions = [
  { label: '週一', value: 1 },
  { label: '週二', value: 2 },
  { label: '週三', value: 3 },
  { label: '週四', value: 4 },
  { label: '週五', value: 5 },
  { label: '週六', value: 6 },
  { label: '週日', value: 7 },
]

const priorityOptions = [
  { label: '低', value: 'LOW' },
  { label: '一般', value: 'NORMAL' },
  { label: '高', value: 'HIGH' },
  { label: '緊急', value: 'URGENT' },
]

const issueTypeOptions = ['例行保養', '清潔維護', '零件檢查', '系統校正', '安全檢測', '耗材更換']

// ====== 表單驗證規則 ======
const rules = reactive({
  title: [
    { required: true, message: '請輸入排程標題', trigger: 'blur' },
    { min: 2, max: 100, message: '標題長度為 2-100 字', trigger: 'blur' },
  ],
  targetType: [{ required: true, message: '請選擇目標類型', trigger: 'change' }],
  targetId: [{ required: true, message: '請選擇目標', trigger: 'change' }],
  scheduleType: [{ required: true, message: '請選擇排程類型', trigger: 'change' }],
  dayOfWeek: [{ required: true, message: '請選擇星期幾', trigger: 'change' }],
  dayOfMonth: [{ required: true, message: '請輸入日期', trigger: 'blur' }],
  executeTime: [{ required: true, message: '請選擇執行時間', trigger: 'change' }],
  issueType: [{ required: true, message: '請選擇問題類型', trigger: 'change' }],
  issuePriority: [{ required: true, message: '請選擇優先級', trigger: 'change' }],
})

// ====== 動態驗證規則 ======
const dynamicRules = computed(() => {
  const baseRules = { ...rules }
  if (form.scheduleType === 'DAILY') {
    delete baseRules.dayOfWeek
    delete baseRules.dayOfMonth
  } else if (form.scheduleType === 'WEEKLY') {
    delete baseRules.dayOfMonth
  } else if (form.scheduleType === 'MONTHLY') {
    delete baseRules.dayOfWeek
  }
  return baseRules
})

// ====== 載入選項資料 ======
const loadOptions = async () => {
  try {
    loading.value = true
    const [spotsRes, seatsRes, staffRes] = await Promise.all([
      maintenanceApi.getAllSpots(),
      maintenanceApi.getAllSeats(),
      maintenanceApi.getAllStaff(),
    ])
    spotOptions.value = spotsRes.data || []
    seatOptions.value = seatsRes.data || []
    staffOptions.value = (staffRes.data || []).filter((s) => s.isActive)
  } catch {
    // handled by http.js
  } finally {
    loading.value = false
  }
}

// ====== 載入編輯資料 ======
const loadSchedule = async () => {
  if (!isEdit.value) return
  try {
    loading.value = true
    const res = await maintenanceApi.getScheduleById(route.params.id)
    const data = res.data
    Object.assign(form, {
      title: data.title,
      targetType: data.targetType,
      targetId: data.targetId,
      scheduleType: data.scheduleType,
      dayOfWeek: data.dayOfWeek,
      dayOfMonth: data.dayOfMonth,
      executeTime: data.executeTime,
      issueType: data.issueType,
      issuePriority: data.issuePriority,
      assignedStaffId: data.assignedStaffId,
      isActive: data.isActive,
    })
  } catch {
    router.push('/admin/maintenance/schedule')
  } finally {
    loading.value = false
  }
}

// ====== 監聽變更 ======
watch(
  () => form.targetType,
  () => {
    form.targetId = null
  },
)
watch(
  () => form.scheduleType,
  (newType) => {
    if (newType === 'DAILY') {
      form.dayOfWeek = null
      form.dayOfMonth = null
    } else if (newType === 'WEEKLY') {
      form.dayOfMonth = null
    } else if (newType === 'MONTHLY') {
      form.dayOfWeek = null
    }
  },
)

// ====== 步驟驗證 ======
const validateCurrentStep = async () => {
  const fieldsMap = {
    0: ['title', 'issueType', 'issuePriority'],
    1: ['targetType', 'targetId'],
    2: [
      'scheduleType',
      'executeTime',
      ...(form.scheduleType === 'WEEKLY' ? ['dayOfWeek'] : []),
      ...(form.scheduleType === 'MONTHLY' ? ['dayOfMonth'] : []),
    ],
    3: [],
    4: [],
  }
  const fields = fieldsMap[currentStep.value]
  if (!fields.length) return true

  try {
    await formRef.value.validateField(fields)
    return true
  } catch {
    return false
  }
}

const nextStep = async () => {
  if (await validateCurrentStep()) {
    currentStep.value = Math.min(currentStep.value + 1, steps.length - 1)
  }
}
const prevStep = () => {
  currentStep.value = Math.max(currentStep.value - 1, 0)
}

// ====== 提交表單 ======
const handleSubmit = async () => {
  try {
    await formRef.value.validate()
  } catch {
    Swal.fire({
      icon: 'warning',
      title: '請檢查表單',
      text: '有必填欄位尚未填寫',
      confirmButtonColor: '#409eff',
    })
    return
  }

  submitting.value = true
  try {
    const payload = { ...form }
    if (isEdit.value) {
      await maintenanceApi.updateSchedule(route.params.id, payload)
      await Swal.fire({
        icon: 'success',
        title: '更新成功！',
        timer: 1500,
        showConfirmButton: false,
      })
    } else {
      await maintenanceApi.createSchedule(payload)
      await Swal.fire({
        icon: 'success',
        title: '建立成功！',
        timer: 1500,
        showConfirmButton: false,
      })
    }
    router.push('/admin/maintenance/schedule')
  } finally {
    submitting.value = false
  }
}

const handleCancel = () => router.push('/admin/maintenance/schedule')

// ====== 取得目標名稱 ======
const getTargetName = computed(() => {
  if (!form.targetId) return '-'
  if (form.targetType === 'SPOT') {
    const spot = spotOptions.value.find((s) => s.spotId === form.targetId)
    return spot?.spotName || spot?.spotCode || `機台 #${form.targetId}`
  } else {
    const seat = seatOptions.value.find((s) => s.seatsId === form.targetId)
    return seat?.seatsName || seat?.serialNumber || `椅子 #${form.targetId}`
  }
})

const getStaffName = computed(() => {
  if (!form.assignedStaffId) return '(不指派)'
  const staff = staffOptions.value.find((s) => s.staffId === form.assignedStaffId)
  return staff?.staffName || `人員 #${form.assignedStaffId}`
})

onMounted(async () => {
  // FIX: 編輯模式下，檢查 route.params.id 是否為有效數字
  // 防止使用者手動輸入 URL 帶入非數字 ID（如 DEMO_xxx）導致後端 400/500 錯誤
  if (isEdit.value && !isValidRouteId.value) {
    await Swal.fire({
      icon: 'error',
      title: '排程 ID 異常',
      html: '<p>無法讀取此排程資料。</p><p style="color:#909399;font-size:13px;">請返回列表頁面。</p>',
      confirmButtonColor: '#f56c6c',
    })
    router.replace('/admin/maintenance/schedule')
    return
  }

  await loadOptions()
  await loadSchedule()
})
</script>

<template>
  <div class="schedule-form-container">
    <section class="content-header">
      <div class="container-fluid">
        <div class="row align-items-center">
          <div class="col-sm-6">
            <h1 class="page-title">
              <i
                :class="isEdit ? 'fas fa-edit' : 'fas fa-plus-circle'"
                class="mr-2"
                style="color: #409eff"
              ></i>
              {{ pageTitle }}
            </h1>
          </div>
          <div class="col-sm-6 text-right">
            <el-button @click="handleCancel">
              <i class="fas fa-arrow-left mr-1"></i> 返回列表
            </el-button>
          </div>
        </div>
      </div>
    </section>

    <section class="content">
      <div class="container-fluid">
        <el-card shadow="hover" class="form-card" v-loading="loading">
          <el-steps :active="currentStep" finish-status="success" align-center class="mb-6">
            <el-step v-for="(step, idx) in steps" :key="idx" :title="step.title">
              <template #icon
                ><el-icon><component :is="step.icon" /></el-icon
              ></template>
            </el-step>
          </el-steps>

          <el-form
            ref="formRef"
            :model="form"
            :rules="dynamicRules"
            label-width="100px"
            label-position="top"
          >
            <!-- Step 0 -->
            <div v-show="currentStep === 0" class="step-content">
              <div class="step-header">
                <i class="fas fa-info-circle"></i>
                <span>填寫排程基本資訊</span>
              </div>

              <el-form-item label="排程標題" prop="title">
                <el-input
                  v-model="form.title"
                  placeholder="例如：每日機台清潔"
                  maxlength="100"
                  show-word-limit
                  clearable
                >
                  <template #prefix><i class="fas fa-tag"></i></template>
                </el-input>
              </el-form-item>

              <el-row :gutter="20">
                <el-col :span="12">
                  <el-form-item label="問題類型" prop="issueType">
                    <el-select
                      v-model="form.issueType"
                      placeholder="選擇或輸入"
                      filterable
                      allow-create
                      style="width: 100%"
                    >
                      <el-option
                        v-for="type in issueTypeOptions"
                        :key="type"
                        :label="type"
                        :value="type"
                      />
                    </el-select>
                  </el-form-item>
                </el-col>

                <el-col :span="12">
                  <el-form-item label="優先級" prop="issuePriority">
                    <el-radio-group v-model="form.issuePriority" class="priority-radio">
                      <el-radio-button
                        v-for="opt in priorityOptions"
                        :key="opt.value"
                        :value="opt.value"
                        :data-priority="opt.value"
                      >
                        {{ opt.label }}
                      </el-radio-button>
                    </el-radio-group>
                  </el-form-item>
                </el-col>
              </el-row>

              <el-form-item label="啟用狀態">
                <el-switch
                  v-model="form.isActive"
                  active-text="啟用"
                  inactive-text="停用"
                  active-color="#67c23a"
                  inline-prompt
                />
              </el-form-item>
            </div>

            <!-- Step 1 -->
            <div v-show="currentStep === 1" class="step-content">
              <div class="step-header">
                <i class="fas fa-crosshairs"></i>
                <span>選擇維護目標</span>
              </div>

              <el-form-item label="目標類型" prop="targetType">
                <div class="target-type-cards">
                  <div
                    class="target-card"
                    :class="{ active: form.targetType === 'SPOT' }"
                    @click="form.targetType = 'SPOT'"
                  >
                    <i class="fas fa-desktop"></i>
                    <span>機台</span>
                    <small>維護據點設備</small>
                  </div>
                  <div
                    class="target-card"
                    :class="{ active: form.targetType === 'SEAT' }"
                    @click="form.targetType = 'SEAT'"
                  >
                    <i class="fas fa-chair"></i>
                    <span>椅子</span>
                    <small>維護座椅設備</small>
                  </div>
                </div>
              </el-form-item>

              <el-form-item label="選擇目標" prop="targetId">
                <el-select
                  v-if="form.targetType === 'SPOT'"
                  v-model="form.targetId"
                  placeholder="搜尋並選擇機台"
                  filterable
                  style="width: 100%"
                >
                  <el-option
                    v-for="spot in spotOptions"
                    :key="spot.spotId"
                    :label="`${spot.spotName || spot.spotCode || '機台'} (ID: ${spot.spotId})`"
                    :value="spot.spotId"
                  >
                    <div class="option-item">
                      <i class="fas fa-desktop mr-2"></i
                      >{{ spot.spotName || spot.spotCode || '機台' }}
                      <el-tag size="small" class="ml-2">ID: {{ spot.spotId }}</el-tag>
                    </div>
                  </el-option>
                </el-select>

                <el-select
                  v-else
                  v-model="form.targetId"
                  placeholder="搜尋並選擇椅子"
                  filterable
                  style="width: 100%"
                >
                  <el-option
                    v-for="seat in seatOptions"
                    :key="seat.seatsId"
                    :label="`${seat.seatsName || seat.serialNumber || '椅子'} (ID: ${seat.seatsId})`"
                    :value="seat.seatsId"
                  >
                    <div class="option-item">
                      <i class="fas fa-chair mr-2"></i
                      >{{ seat.seatsName || seat.serialNumber || '椅子' }}
                      <el-tag size="small" class="ml-2">ID: {{ seat.seatsId }}</el-tag>
                    </div>
                  </el-option>
                </el-select>
              </el-form-item>
            </div>

            <!-- Step 2 -->
            <div v-show="currentStep === 2" class="step-content">
              <div class="step-header">
                <i class="fas fa-clock"></i>
                <span>設定執行頻率</span>
              </div>

              <el-form-item label="排程類型" prop="scheduleType">
                <div class="schedule-type-cards">
                  <div
                    v-for="opt in scheduleTypeOptions"
                    :key="opt.value"
                    class="schedule-card"
                    :class="{ active: form.scheduleType === opt.value }"
                    @click="form.scheduleType = opt.value"
                  >
                    <i :class="opt.icon"></i>
                    <span>{{ opt.label }}</span>
                    <small>{{ opt.desc }}</small>
                  </div>
                </div>
              </el-form-item>

              <el-row :gutter="20">
                <el-col :span="12" v-if="form.scheduleType === 'WEEKLY'">
                  <el-form-item label="星期幾" prop="dayOfWeek">
                    <el-select v-model="form.dayOfWeek" placeholder="選擇星期" style="width: 100%">
                      <el-option
                        v-for="opt in dayOfWeekOptions"
                        :key="opt.value"
                        :label="opt.label"
                        :value="opt.value"
                      />
                    </el-select>
                  </el-form-item>
                </el-col>

                <el-col :span="12" v-if="form.scheduleType === 'MONTHLY'">
                  <el-form-item label="每月幾號" prop="dayOfMonth">
                    <el-input-number
                      v-model="form.dayOfMonth"
                      :min="1"
                      :max="31"
                      style="width: 100%"
                    />
                  </el-form-item>
                </el-col>

                <el-col :span="12">
                  <el-form-item label="執行時間" prop="executeTime">
                    <el-time-picker
                      v-model="form.executeTime"
                      format="HH:mm"
                      value-format="HH:mm:ss"
                      placeholder="選擇時間"
                      style="width: 100%"
                    />
                  </el-form-item>
                </el-col>
              </el-row>

              <el-alert type="info" :closable="false" show-icon class="mt-4">
                <template #title>
                  <span v-if="form.executeTime">預覽：{{ formatScheduleDetail(form) }}</span>
                  <span v-else>請選擇執行時間</span>
                </template>
              </el-alert>
            </div>

            <!-- Step 3 -->
            <div v-show="currentStep === 3" class="step-content">
              <div class="step-header">
                <i class="fas fa-user-cog"></i>
                <span>指派維護人員 (選填)</span>
              </div>

              <el-form-item label="維護人員">
                <el-select
                  v-model="form.assignedStaffId"
                  placeholder="選擇人員或留空"
                  clearable
                  filterable
                  style="width: 100%"
                >
                  <el-option
                    v-for="staff in staffOptions"
                    :key="staff.staffId"
                    :label="`${staff.staffName} (${staff.specialization || '未設定專長'})`"
                    :value="staff.staffId"
                  >
                    <div class="option-item">
                      <el-avatar :size="24" class="mr-2">{{
                        staff.staffName?.charAt(0)
                      }}</el-avatar>
                      {{ staff.staffName }}
                      <el-tag size="small" type="info" class="ml-2">{{
                        staff.specialization || '未設定'
                      }}</el-tag>
                    </div>
                  </el-option>
                </el-select>
              </el-form-item>

              <el-alert type="warning" :closable="false" show-icon>
                <template #title>提示</template>
                <template #default
                  >若不指派，工單建立後狀態為「已回報」；若指派則為「已指派」</template
                >
              </el-alert>
            </div>

            <!-- Step 4 -->
            <div v-show="currentStep === 4" class="step-content">
              <div class="step-header">
                <i class="fas fa-check-circle"></i>
                <span>確認排程資訊</span>
              </div>

              <el-descriptions :column="2" border class="summary-desc">
                <el-descriptions-item label="排程標題" :span="2">
                  <strong>{{ form.title || '-' }}</strong>
                </el-descriptions-item>

                <el-descriptions-item label="問題類型">{{
                  form.issueType || '-'
                }}</el-descriptions-item>
                <el-descriptions-item label="優先級">
                  <el-tag :type="priorityConfig[form.issuePriority]?.tagType" size="small">
                    {{ priorityConfig[form.issuePriority]?.text }}
                  </el-tag>
                </el-descriptions-item>

                <el-descriptions-item label="目標類型">
                  <el-tag :type="form.targetType === 'SPOT' ? 'primary' : 'warning'" size="small">
                    {{ form.targetType === 'SPOT' ? '機台' : '椅子' }}
                  </el-tag>
                </el-descriptions-item>

                <el-descriptions-item label="目標名稱">{{ getTargetName }}</el-descriptions-item>

                <el-descriptions-item label="執行頻率" :span="2">
                  <el-tag :type="scheduleTypeConfig[form.scheduleType]?.tagType" effect="plain">
                    <i :class="scheduleTypeConfig[form.scheduleType]?.icon" class="mr-1"></i>
                    {{ formatScheduleDetail(form) }}
                  </el-tag>
                </el-descriptions-item>

                <el-descriptions-item label="指派人員">{{ getStaffName }}</el-descriptions-item>
                <el-descriptions-item label="啟用狀態">
                  <el-tag :type="form.isActive ? 'success' : 'info'" size="small">
                    {{ form.isActive ? '啟用' : '停用' }}
                  </el-tag>
                </el-descriptions-item>
              </el-descriptions>
            </div>

            <!-- Buttons -->
            <div class="form-actions">
              <el-button @click="handleCancel">取消</el-button>
              <div class="action-right">
                <el-button v-if="currentStep > 0" @click="prevStep">
                  <i class="fas fa-chevron-left mr-1"></i> 上一步
                </el-button>

                <el-button v-if="currentStep < steps.length - 1" type="primary" @click="nextStep">
                  下一步 <i class="fas fa-chevron-right ml-1"></i>
                </el-button>

                <el-button v-else type="success" :loading="submitting" @click="handleSubmit">
                  <i class="fas fa-save mr-1"></i> {{ isEdit ? '儲存變更' : '建立排程' }}
                </el-button>
              </div>
            </div>
          </el-form>
        </el-card>
      </div>
    </section>
  </div>
</template>

<style scoped>
.schedule-form-container {
  padding: 20px;
}

.page-title {
  font-size: 1.6rem;
  font-weight: 600;
  color: #303133;
  display: flex;
  align-items: center;
  margin: 0;
}

.form-card {
  border-radius: 12px;
  max-width: 800px;
  margin: 0 auto;
}

.mb-6 {
  margin-bottom: 2rem;
}
.step-content {
  min-height: 300px;
}

.step-header {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 1.1rem;
  font-weight: 600;
  color: #409eff;
  margin-bottom: 24px;
  padding-bottom: 12px;
  border-bottom: 2px solid #409eff;
}

/* 目標/排程卡片 */
.target-type-cards,
.schedule-type-cards {
  display: flex;
  gap: 16px;
}
.target-card,
.schedule-card {
  flex: 1;
  padding: 20px;
  border: 2px solid #e4e7ed;
  border-radius: 12px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s;
}
.target-card:hover,
.schedule-card:hover {
  border-color: #409eff;
  background: rgba(64, 158, 255, 0.05);
}
.target-card.active,
.schedule-card.active {
  border-color: #409eff;
  background: rgba(64, 158, 255, 0.1);
  box-shadow: 0 0 0 3px rgba(64, 158, 255, 0.2);
}
.target-card i,
.schedule-card i {
  font-size: 2rem;
  color: #409eff;
  display: block;
  margin-bottom: 8px;
}
.target-card span,
.schedule-card span {
  font-size: 1rem;
  font-weight: 600;
  display: block;
}
.target-card small,
.schedule-card small {
  font-size: 12px;
  color: #909399;
  display: block;
  margin-top: 4px;
}

.option-item {
  display: flex;
  align-items: center;
}

/* ✅ 優先級 Radio：修正文字被吃掉 + 不同顏色 */
.priority-radio {
  width: 100%;
}
.priority-radio :deep(.el-radio-button) {
  flex: 1;
}
.priority-radio :deep(.el-radio-button__inner) {
  width: 100%;
}

.priority-radio :deep(.el-radio-button__original-radio:checked + .el-radio-button__inner) {
  color: #fff !important;
  border-color: transparent !important;
}

/* ✅ 依不同優先級上色 */
.priority-radio :deep([data-priority='LOW'].is-active .el-radio-button__inner) {
  background: #909399 !important;
}
.priority-radio :deep([data-priority='NORMAL'].is-active .el-radio-button__inner) {
  background: #409eff !important;
}
.priority-radio :deep([data-priority='HIGH'].is-active .el-radio-button__inner) {
  background: #e6a23c !important;
}
.priority-radio :deep([data-priority='URGENT'].is-active .el-radio-button__inner) {
  background: #f56c6c !important;
}

.summary-desc {
  margin-top: 16px;
}
.summary-desc :deep(.el-descriptions__label) {
  width: 100px;
  font-weight: 500;
}

.form-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-top: 24px;
  margin-top: 24px;
  border-top: 1px solid #ebeef5;
}
.action-right {
  display: flex;
  gap: 12px;
}

.mr-1 {
  margin-right: 4px;
}
.mr-2 {
  margin-right: 8px;
}
.ml-1 {
  margin-left: 4px;
}
.ml-2 {
  margin-left: 8px;
}
.mt-4 {
  margin-top: 1rem;
}
</style>
</file>

<file path="frontend/src/views/maintenance/ScheduleList.vue">
<script setup>
import { ref, onMounted, computed, watch } from 'vue'
import { useRouter } from 'vue-router'
import maintenanceApi from '@/api/modules/maintenance'
import Swal from 'sweetalert2'
import { usePagination } from '@/composables/maintenance/usePagination'
import { useScheduleConfig } from '@/composables/maintenance/useScheduleConfig'
import ScheduleCalendar from '@/components/maintenance/ScheduleCalendar.vue'
import { Calendar, List, Clock } from '@element-plus/icons-vue'

const router = useRouter()
const { scheduleTypeConfig, formatDateTime, formatScheduleDetail, getRelativeTime } =
  useScheduleConfig()

// ====== 資料狀態 ======
const schedules = ref([])
const loading = ref(true)
const pageVisible = ref(false)
const searchText = ref('')
const viewMode = ref('table') // 'table' | 'calendar'

// ====== 彈窗控制 ======
const showHistoryDialog = ref(false)
const showDeletedDialog = ref(false)
const historyTickets = ref([])
const deletedSchedules = ref([])
const dialogLoading = ref(false)

const historySpots = ref([])
const historySeats = ref([])

const statusMap = {
  ASSIGNED: '已指派',
  PENDING: '待處理',
  In_Progress: '處理中',
  IN_PROGRESS: '處理中',
  RESOLVED: '已完成',
  COMPLETED: '已完成',
  CLOSED: '已結案',
  CANCELLED: '已取消',
}

// ====== API 資料讀取 ======
const fetchSchedules = async () => {
  try {
    loading.value = true
    const res = await maintenanceApi.getAllSchedules()
    schedules.value = res.data
  } catch {
    // 錯誤已由 http.js 攔截器處理
  } finally {
    loading.value = false
    setTimeout(() => (pageVisible.value = true), 100)
  }
}

// ====== 統計數據 ======
const stats = computed(() => {
  const active = schedules.value.filter((s) => s.isActive)
  const daily = active.filter((s) => s.scheduleType === 'DAILY').length
  const weekly = active.filter((s) => s.scheduleType === 'WEEKLY').length
  const monthly = active.filter((s) => s.scheduleType === 'MONTHLY').length

  // 即將執行（24小時內）
  const now = new Date()
  const tomorrow = new Date(now.getTime() + 24 * 60 * 60 * 1000)
  const upcoming = active.filter((s) => {
    const next = new Date(s.nextExecuteAt)
    return next >= now && next <= tomorrow
  }).length

  return { total: active.length, daily, weekly, monthly, upcoming }
})

// ====== 即將執行的排程 (Timeline 用) ======
const upcomingSchedules = computed(() => {
  const now = new Date()
  return schedules.value
    .filter((s) => s.isActive && new Date(s.nextExecuteAt) >= now)
    .sort((a, b) => new Date(a.nextExecuteAt) - new Date(b.nextExecuteAt))
    .slice(0, 5)
})

// ====== 篩選邏輯（✅ 強化搜尋欄位） ======
const filteredList = computed(() => {
  const key = searchText.value.trim().toLowerCase()
  const list = schedules.value.filter((s) => s.isActive === true)

  if (!key) return list

  return list.filter((s) => {
    const idHit = String(s.scheduleId).includes(key)
    const titleHit = (s.title || '').toLowerCase().includes(key)
    const issueTypeHit = (s.issueType || '').toLowerCase().includes(key)
    const targetTypeHit = (s.targetType || '').toLowerCase().includes(key)
    const staffHit = (s.assignedStaffName || '').toLowerCase().includes(key)
    const scheduleTypeHit = (s.scheduleType || '').toLowerCase().includes(key)

    return idHit || titleHit || issueTypeHit || targetTypeHit || staffHit || scheduleTypeHit
  })
})

// ====== 分頁 ======
const { currentPage, pageSize, paginatedList, total, resetPagination } = usePagination(
  filteredList,
  10,
)

watch(searchText, () => resetPagination())

// ====== 業務邏輯 ======
const handleCreate = () => router.push('/admin/maintenance/schedule/create')
// FIX: 判斷 scheduleId 是否為有效數字（過濾歷史遺留的字串 ID）
const isValidScheduleId = (scheduleId) => {
  return (
    typeof scheduleId === 'number' || (typeof scheduleId === 'string' && /^\d+$/.test(scheduleId))
  )
}

const handleEdit = (row) => {
  // 【健壯性保護】若 scheduleId 不是有效數字，禁止編輯
  if (!isValidScheduleId(row.scheduleId)) {
    Swal.fire({
      icon: 'warning',
      title: '無法編輯',
      text: '此排程 ID 異常，請刪除後重新建立',
      confirmButtonColor: '#409eff',
    })
    return
  }
  router.push(`/admin/maintenance/schedule/edit/${row.scheduleId}`)
}

// ============================================================================
// ✅ 【任務二】完整 Demo Workflow（序列執行）：
//    Step 1: 先建立排程 → Step 2: 取得 scheduleId → Step 3: 建立關聯工單
// 符合後端驗證：targetType 使用單數 'SPOT' 或 'SEAT'，ID 欄位用複數 seatsId
// ============================================================================
const handleCreateDemoSchedules = async () => {
  // 【防止重複點擊】開啟 Loading
  loading.value = true

  try {
    // ========== Step 1: 取得真實資料（效能優化：Promise.all 並行請求）==========
    const [spotsRes, seatsRes, staffRes] = await Promise.all([
      maintenanceApi.getAllSpots(),
      maintenanceApi.getAllSeats(),
      maintenanceApi.getAllStaff(),
    ])

    const spots = spotsRes.data || []
    const seats = seatsRes.data || []
    const staffs = staffRes.data || []

    // 【防呆檢查】如果完全沒有設備，無法建立
    if (spots.length === 0 && seats.length === 0) {
      Swal.fire('無法建立', '系統中沒有任何機台或椅子可供綁定', 'warning')
      return
    }

    // ========== Step 2: 決定目標類型與物件 ==========
    //  後端 Enum 嚴格檢查：targetType 必須是單數 'SPOT' 或 'SEAT'
    let targetType = 'SPOT'
    if (seats.length > 0 && spots.length > 0) {
      targetType = Math.random() > 0.5 ? 'SPOT' : 'SEAT'
    } else if (seats.length > 0) {
      targetType = 'SEAT'
    } else if (spots.length > 0) {
      targetType = 'SPOT'
    }

    const targetList = targetType === 'SPOT' ? spots : seats
    const randomTarget = targetList[Math.floor(Math.random() * targetList.length)]

    //  欄位命名陷阱：後端 DB 用 seatsId (複數)，但 targetType 用 SEAT (單數)
    const realTargetId = targetType === 'SPOT' ? randomTarget.spotId : randomTarget.seatsId
    const targetName = randomTarget.spotName || randomTarget.seatsName || '設備'

    // ========== Step 3: 隨機指派員工（只選 Active）==========
    const activeStaffs = staffs.filter((s) => s.isActive)
    const randomStaff =
      activeStaffs.length > 0 ? activeStaffs[Math.floor(Math.random() * activeStaffs.length)] : null

    // ========== Step 4: 準備排程參數 ==========
    const scheduleTypes = ['DAILY', 'WEEKLY', 'MONTHLY']
    const randomScheduleType = scheduleTypes[Math.floor(Math.random() * scheduleTypes.length)]

    // ✅ 必須定義 executeTimeStr 避免報錯
    const executeTimeStr = '10:00:00'

    // ========== Step 5: 建立排程 Payload ==========
    const schedulePayload = {
      title: `${targetName} 定期保養`,
      scheduleType: randomScheduleType,
      issueType: '例行保養',
      issuePriority: 'NORMAL',
      isActive: true,
      executeTime: executeTimeStr,

      // ⚠️ 重要：傳給後端的 targetType 是單數 'SEAT'
      targetType: targetType,

      // ⚠️ 通用驗證欄位：targetId 必填
      targetId: realTargetId,

      // ⚠️ 欄位對應：根據 targetType 填入對應的 ID 欄位
      // 若 targetType 為 'SEAT'，ID 填入 seatsId (複數) 欄位
      spotId: targetType === 'SPOT' ? realTargetId : null,
      seatsId: targetType === 'SEAT' ? realTargetId : null,

      assignedStaffId: randomStaff ? randomStaff.staffId : null,

      // 頻率參數（根據 scheduleType 決定）
      dayOfWeek: randomScheduleType === 'WEEKLY' ? Math.floor(Math.random() * 7) + 1 : null,
      dayOfMonth: randomScheduleType === 'MONTHLY' ? Math.floor(Math.random() * 28) + 1 : null,
    }

    // ========== Step 6: 【序列執行】先建立排程，取得 scheduleId ==========
    // ✅ 修復歷史紀錄消失問題：必須先建立排程，再用回傳的 scheduleId 建立工單
    const scheduleRes = await maintenanceApi.createSchedule(schedulePayload)

    // ✅ 精確提取 scheduleId（參考 DTO 結構）
    const createdScheduleId = scheduleRes.data?.scheduleId
    console.log(' 排程建立成功，scheduleId:', createdScheduleId)

    // ========== Step 7: 【序列執行】建立「已完成」工單（模擬剛做完的保養）==========

    // ========== Step 8: 【序列執行】建立「待處理」工單（模擬下次排程任務）==========
    const pendingTicketPayload = {
      spotId: targetType === 'SPOT' ? realTargetId : null,
      seatsId: targetType === 'SEAT' ? realTargetId : null,

      // ✅ 帶入 scheduleId，確保歷史紀錄能關聯到排程
      scheduleId: createdScheduleId,

      issueType: '保養',
      issueDesc: `下次保養單 (排程ID: ${createdScheduleId})`,
      issuePriority: 'NORMAL',
      issueStatus: 'ASSIGNED', // ✅ 待處理狀態（已指派）
      assignedStaffId: randomStaff ? randomStaff.staffId : null,
    }

    // 再建立待處理工單
    await maintenanceApi.createTicket(pendingTicketPayload)
    console.log(' 待處理工單建立成功')

    // ========== Step 9: 刷新畫面 & 通知其他頁面 ==========
    await fetchSchedules()

    // ✅ 觸發跨頁事件，讓人員列表頁能即時更新統計
    window.dispatchEvent(new CustomEvent('maintenance:tickets-changed'))

    // ========== Step 10: 顯示成功訊息（條列式說明）==========
    Swal.fire({
      icon: 'success',
      title: '建立成功',
      html: `
        <div style="text-align: left; line-height: 2;">
          <p><i class="fas fa-calendar-check" style="color:#409eff"></i> <b>已建立排程</b>：${schedulePayload.title}</p>
          <p><i class="fas fa-check-circle" style="color:#67c23a"></i> <b>已生成完工單據</b>：保養已完成</p>
          <p><i class="fas fa-clock" style="color:#e6a23c"></i> <b>已預排下次任務</b>：待處理保養單</p>
          ${randomStaff ? `<p><i class="fas fa-user" style="color:#909399"></i> <b>指派人員</b>：${randomStaff.staffName}</p>` : ''}
          <p style="color:#909399;font-size:12px;margin-top:8px;">(排程ID: ${createdScheduleId})</p>
        </div>
      `,
      confirmButtonColor: '#409eff',
    })
  } catch (error) {
    console.error('建立測試資料失敗:', error)
    const msg =
      error.response?.data?.message || error.response?.data?.error || '建立測試資料時發生錯誤'
    Swal.fire('錯誤', msg, 'error')
  } finally {
    loading.value = false
  }
}

// ★ switch：確認成功才切換
const handleToggleConfirm = async (row) => {
  const action = row.isActive ? '停用' : '啟用'

  const result = await Swal.fire({
    title: `確定要${action}此排程嗎？`,
    html: `
      <div style="text-align: center;">
        <p>排程：<b style="color: ${row.isActive ? '#f56c6c' : '#67c23a'}">${row.title}</b></p>
        <p style="color: #909399; font-size: 13px;">${row.isActive ? '停用後將不會自動執行' : '啟用後將恢復自動執行'}</p>
      </div>
    `,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: row.isActive ? '#f56c6c' : '#67c23a',
    confirmButtonText: `確認${action}`,
    cancelButtonText: '取消',
  })

  if (!result.isConfirmed) return false

  try {
    await maintenanceApi.toggleSchedule(row.scheduleId)
    await fetchSchedules()

    await Swal.fire({
      icon: 'success',
      title: `已${action}`,
      html: row.isActive
        ? '<p style="color: #909399; font-size: 13px;">排程已移至「已停用」清單</p>'
        : '',
      timer: row.isActive ? 900 : 900,
      showConfirmButton: false,
    })
    return true
  } catch (error) {
    console.error('切換狀態失敗:', error)
    const errorMsg = error?.response?.data?.message || `${action}失敗，請稍後再試`
    Swal.fire('錯誤', errorMsg, 'error')
    return false
  }
}

const handleDelete = async (row) => {
  // 【任務三】優化刪除提示 - 警告用戶此操作將永久移除資料
  const result = await Swal.fire({
    title: '❗ 確定要刪除？',
    html: `
      <div style="text-align: left;">
        <p>排程：<b style="color:#f56c6c">${row.title}</b></p>
        <hr style="border:none;border-top:1px solid #eee;margin:12px 0;">
        <p style="color:#909399;font-size:13px;">
          <i class="fas fa-exclamation-triangle" style="color:#e6a23c"></i>
          <b>注意：</b>此操作將永久移除資料，無法復原！
        </p>
        <p style="color:#909399;font-size:13px;">
          若僅需暫停排程，請使用「狀態開關」將其停用。
        </p>
      </div>
    `,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#f56c6c',
    cancelButtonColor: '#909399',
    confirmButtonText: '<i class="fas fa-trash-alt"></i> 確認刪除',
    cancelButtonText: '取消',
  })

  if (result.isConfirmed) {
    try {
      await maintenanceApi.deleteSchedule(row.scheduleId)
      await fetchSchedules()
      Swal.fire({ icon: 'success', title: '已刪除', timer: 1000, showConfirmButton: false })
    } catch {
      /* handled */
    }
  }
}

// ====== 彈窗邏輯 ======
const openHistoryDialog = async () => {
  showHistoryDialog.value = true
  dialogLoading.value = true
  try {
    // 用 Promise.all 同時撈取 工單、機台、椅子 資料，以便顯示名稱 (解決問題 3)
    const [ticketsRes, spotsRes, seatsRes] = await Promise.all([
      maintenanceApi.getAllTickets(),
      maintenanceApi.getAllSpots(),
      maintenanceApi.getAllSeats(),
    ])

    historySpots.value = spotsRes.data || []
    historySeats.value = seatsRes.data || []

    // 過濾出與自動保養相關的工單
    historyTickets.value = ticketsRes.data.filter(
      (t) => t.issueDesc && t.issueDesc.includes('已完成保養單'), // 或是依照您的篩選邏輯
    )
  } catch (e) {
    console.error(e)
    Swal.fire('錯誤', '無法讀取歷史紀錄', 'error')
  } finally {
    dialogLoading.value = false
  }
}

//  取得目標名稱的輔助函式 (解決問題 3)
const getHistoryTargetName = (row) => {
  if (row.spotId) {
    const spot = historySpots.value.find((s) => s.spotId === row.spotId)
    return spot ? `機台: ${spot.spotName}` : `機台 #${row.spotId}`
  } else if (row.seatsId) {
    const seat = historySeats.value.find((s) => s.seatsId === row.seatsId)
    return seat ? `椅子: ${seat.seatsName}` : `椅子 #${row.seatsId}`
  }
  return '-'
}

// ============================================================================
// 【任務三】已停用排程 Dialog
// ℹ️ 說明：此視窗顯示的是 isActive=false 的「已停用」排程
//    復原功能是將 isActive 切換回 true，並非從資料庫中恢復已刪除的資料
//    若資料已被「真刪除」（從 DB 移除），則無法復原
// ============================================================================
const openDeletedDialog = async () => {
  showDeletedDialog.value = true
  dialogLoading.value = true
  try {
    const res = await maintenanceApi.getAllSchedules()
    deletedSchedules.value = res.data.filter((s) => !s.isActive)
  } catch (e) {
    console.error(e)
  } finally {
    dialogLoading.value = false
  }
}

const handleRestore = async (row) => {
  try {
    await maintenanceApi.toggleSchedule(row.scheduleId)
    Swal.fire({ icon: 'success', title: '排程已復原', showConfirmButton: false, timer: 1000 })
    await fetchSchedules()
    openDeletedDialog()
  } catch {
    Swal.fire('錯誤', '復原失敗', 'error')
  }
}

// ====== 日曆點擊事件 ======
const handleCalendarScheduleClick = (schedule) => {
  handleEdit(schedule)
}

onMounted(fetchSchedules)
</script>

<template>
  <div class="schedule-list-container">
    <!-- ========== Header ========== -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row align-items-center">
          <div class="col-sm-6">
            <h1 class="page-title">
              <i class="fas fa-calendar-check mr-2" style="color: #409eff"></i>
              定期維護排程
            </h1>
          </div>
          <div class="col-sm-6 text-right">
            <el-button-group class="mr-2">
              <el-button type="info" plain @click="openHistoryDialog">
                <i class="fas fa-history mr-1"></i> 保養紀錄
              </el-button>
              <el-button type="warning" plain @click="openDeletedDialog">
                <i class="fas fa-trash-alt mr-1"></i> 已停用
              </el-button>
              <el-button type="success" plain @click="handleCreateDemoSchedules">
                <i class="fas fa-magic mr-1"></i> 一鍵帶入
              </el-button>
            </el-button-group>
            <el-button type="primary" @click="handleCreate">
              <i class="fas fa-plus mr-1"></i> 新增排程
            </el-button>
          </div>
        </div>
      </div>
    </section>

    <section class="content">
      <div class="container-fluid">
        <transition name="fade-slide" appear>
          <div v-if="pageVisible">
            <!-- ========== 統計卡片 ========== -->
            <el-row :gutter="16" class="mb-4">
              <el-col :xs="12" :sm="6" :md="4">
                <el-card shadow="hover" class="stat-card stat-total">
                  <el-statistic title="啟用中排程" :value="stats.total">
                    <template #prefix><i class="fas fa-calendar-check"></i></template>
                  </el-statistic>
                </el-card>
              </el-col>
              <el-col :xs="12" :sm="6" :md="4">
                <el-card shadow="hover" class="stat-card stat-upcoming">
                  <el-statistic title="24小時內執行" :value="stats.upcoming">
                    <template #prefix><i class="fas fa-clock"></i></template>
                  </el-statistic>
                </el-card>
              </el-col>
              <el-col :xs="12" :sm="6" :md="4">
                <el-card shadow="hover" class="stat-card stat-daily">
                  <el-statistic title="每日排程" :value="stats.daily">
                    <template #prefix><i class="fas fa-sun"></i></template>
                  </el-statistic>
                </el-card>
              </el-col>
              <el-col :xs="12" :sm="6" :md="4">
                <el-card shadow="hover" class="stat-card stat-weekly">
                  <el-statistic title="每週排程" :value="stats.weekly">
                    <template #prefix><i class="fas fa-calendar-week"></i></template>
                  </el-statistic>
                </el-card>
              </el-col>
              <el-col :xs="12" :sm="6" :md="4">
                <el-card shadow="hover" class="stat-card stat-monthly">
                  <el-statistic title="每月排程" :value="stats.monthly">
                    <template #prefix><i class="fas fa-calendar-alt"></i></template>
                  </el-statistic>
                </el-card>
              </el-col>
            </el-row>

            <el-row :gutter="16">
              <!-- ========== 主內容區 ========== -->
              <el-col :xs="24" :lg="17">
                <el-card shadow="hover" class="main-card">
                  <!-- 工具列 -->
                  <div class="toolbar">
                    <el-input
                      v-model="searchText"
                      placeholder="搜尋：標題 / 類型 / 人員 / ID / 目標..."
                      clearable
                      prefix-icon="Search"
                      style="width: 320px"
                    />
                    <div class="toolbar-right">
                      <el-radio-group v-model="viewMode" size="small">
                        <el-radio-button value="table">
                          <el-icon><List /></el-icon> 列表
                        </el-radio-button>
                        <el-radio-button value="calendar">
                          <el-icon><Calendar /></el-icon> 日曆
                        </el-radio-button>
                      </el-radio-group>
                      <el-button @click="fetchSchedules" :loading="loading" class="ml-2">
                        <i class="fas fa-sync-alt"></i>
                      </el-button>
                    </div>
                  </div>

                  <!-- 列表視圖 -->
                  <div v-show="viewMode === 'table'">
                    <el-table
                      :data="paginatedList"
                      v-loading="loading"
                      stripe
                      style="width: 100%"
                      :header-cell-style="{ background: '#f5f7fa', fontWeight: 'bold' }"
                    >
                      <el-table-column prop="scheduleId" label="ID" width="60" align="center">
                        <template #default="{ row }">
                          <!-- FIX: 使用 isValidScheduleId 判斷，非數字 ID 標記為異常 -->
                          <el-tag
                            v-if="!isValidScheduleId(row.scheduleId)"
                            type="danger"
                            size="small"
                            effect="light"
                          >
                            異常
                          </el-tag>
                          <span v-else>{{ row.scheduleId }}</span>
                        </template>
                      </el-table-column>

                      <el-table-column prop="title" label="排程標題" min-width="160">
                        <template #default="{ row }">
                          <div class="title-cell">
                            <i
                              :class="scheduleTypeConfig[row.scheduleType]?.icon"
                              :style="{ color: scheduleTypeConfig[row.scheduleType]?.color }"
                              class="mr-2"
                            ></i>
                            <span>{{ row.title }}</span>
                          </div>
                        </template>
                      </el-table-column>

                      <el-table-column label="頻率" width="140" align="center">
                        <template #default="{ row }">
                          <el-tag
                            :type="scheduleTypeConfig[row.scheduleType]?.tagType"
                            size="small"
                            effect="plain"
                          >
                            {{ formatScheduleDetail(row) }}
                          </el-tag>
                        </template>
                      </el-table-column>

                      <el-table-column label="目標" width="80" align="center">
                        <template #default="{ row }">
                          <el-tag
                            :type="row.targetType === 'SPOT' ? 'primary' : 'warning'"
                            size="small"
                            effect="light"
                          >
                            {{ row.targetType === 'SPOT' ? '機台' : '椅子' }}
                          </el-tag>
                        </template>
                      </el-table-column>

                      <el-table-column label="負責人員" width="110" align="center">
                        <template #default="{ row }">
                          <el-tag
                            v-if="row.assignedStaffId"
                            type="success"
                            size="small"
                            effect="plain"
                          >
                            <i class="fas fa-user mr-1"></i>
                            {{ row.assignedStaffName || `#${row.assignedStaffId}` }}
                          </el-tag>
                          <span v-else style="color: #909399; font-size: 12px">未指派</span>
                        </template>
                      </el-table-column>

                      <el-table-column label="下次執行" width="150">
                        <template #default="{ row }">
                          <div class="next-exec-cell">
                            <span class="datetime">{{ formatDateTime(row.nextExecuteAt) }}</span>
                            <el-tag
                              :type="
                                getRelativeTime(row.nextExecuteAt).isOverdue
                                  ? 'danger'
                                  : getRelativeTime(row.nextExecuteAt).isSoon
                                    ? 'warning'
                                    : 'info'
                              "
                              size="small"
                              effect="plain"
                              class="relative-tag"
                            >
                              {{ getRelativeTime(row.nextExecuteAt).text }}
                            </el-tag>
                          </div>
                        </template>
                      </el-table-column>

                      <el-table-column label="狀態" width="80" align="center">
                        <template #default="{ row }">
                          <el-switch
                            :model-value="row.isActive"
                            active-color="#67c23a"
                            inactive-color="#dcdfe6"
                            :before-change="() => handleToggleConfirm(row)"
                          />
                        </template>
                      </el-table-column>

                      <el-table-column label="操作" width="100" align="center">
                        <template #default="{ row }">
                          <el-button-group>
                            <!-- FIX: 使用 isValidScheduleId 判斷，非數字 ID 禁用編輯 -->
                            <el-tooltip
                              :content="
                                isValidScheduleId(row.scheduleId)
                                  ? '編輯排程'
                                  : '排程 ID 異常，請刪除後重新匯入'
                              "
                              placement="top"
                            >
                              <el-button
                                size="small"
                                type="primary"
                                @click="handleEdit(row)"
                                :disabled="!isValidScheduleId(row.scheduleId)"
                              >
                                <i class="fas fa-edit"></i>
                              </el-button>
                            </el-tooltip>
                            <el-button size="small" type="danger" @click="handleDelete(row)">
                              <i class="fas fa-trash-alt"></i>
                            </el-button>
                          </el-button-group>
                        </template>
                      </el-table-column>
                    </el-table>

                    <div class="pagination-bar">
                      <el-pagination
                        v-model:current-page="currentPage"
                        v-model:page-size="pageSize"
                        :page-sizes="[10, 20, 50]"
                        :total="total"
                        layout="total, sizes, prev, pager, next"
                        background
                        small
                      />
                    </div>
                  </div>

                  <!-- ✅ 日曆視圖：吃搜尋後 filteredList -->
                  <div v-show="viewMode === 'calendar'">
                    <ScheduleCalendar
                      :schedules="filteredList"
                      @click-schedule="handleCalendarScheduleClick"
                    />
                  </div>
                </el-card>
              </el-col>

              <!-- ========== 側邊欄：即將執行 ========== -->
              <el-col :xs="24" :lg="7">
                <el-card shadow="hover" class="timeline-card">
                  <template #header>
                    <div class="card-header">
                      <el-icon><Clock /></el-icon>
                      <span>即將執行</span>
                      <el-badge :value="upcomingSchedules.length" :max="9" class="ml-auto" />
                    </div>
                  </template>

                  <el-timeline v-if="upcomingSchedules.length > 0">
                    <el-timeline-item
                      v-for="schedule in upcomingSchedules"
                      :key="schedule.scheduleId"
                      :color="scheduleTypeConfig[schedule.scheduleType]?.color"
                      :hollow="true"
                    >
                      <div class="timeline-content" @click="handleEdit(schedule)">
                        <div class="timeline-title">{{ schedule.title }}</div>
                        <div class="timeline-meta">
                          <el-tag size="small" effect="plain">
                            {{ schedule.targetType === 'SPOT' ? '機台' : '椅子' }}
                          </el-tag>
                          <span class="timeline-time">
                            {{ formatDateTime(schedule.nextExecuteAt) }}
                          </span>
                        </div>
                      </div>
                    </el-timeline-item>
                  </el-timeline>

                  <el-empty v-else description="暫無即將執行的排程" :image-size="80" />
                </el-card>
              </el-col>
            </el-row>
          </div>
        </transition>
      </div>

      <!-- ========== 保養紀錄 Dialog ========== -->
      <el-dialog v-model="showHistoryDialog" title="📜 系統自動保養紀錄" width="70%" draggable>
        <el-table :data="historyTickets" v-loading="dialogLoading" max-height="400" stripe>
          <el-table-column prop="ticketId" label="ID" width="70" />

          <el-table-column label="保養目標" min-width="150">
            <template #default="{ row }">
              {{ getHistoryTargetName(row) }}
            </template>
          </el-table-column>

          <el-table-column prop="issueDesc" label="描述" show-overflow-tooltip />

          <el-table-column prop="reportedAt" label="執行時間" width="160">
            <template #default="{ row }">{{ formatDateTime(row.reportedAt) }}</template>
          </el-table-column>

          <el-table-column prop="issueStatus" label="狀態" width="100">
            <template #default="{ row }">
              <el-tag size="small" :type="row.issueStatus === 'RESOLVED' ? 'success' : 'info'">
                {{ statusMap[row.issueStatus] || row.issueStatus }}
              </el-tag>
            </template>
          </el-table-column>
        </el-table>
      </el-dialog>

      <!-- ========== 已停用 Dialog ========== -->
      <el-dialog v-model="showDeletedDialog" title="🗑️ 已停用排程" width="60%" draggable>
        <el-table :data="deletedSchedules" v-loading="dialogLoading" max-height="400" stripe>
          <el-table-column prop="scheduleId" label="ID" width="70" />
          <el-table-column prop="title" label="標題" />
          <el-table-column label="類型" width="100">
            <template #default="{ row }">
              <el-tag :type="scheduleTypeConfig[row.scheduleType]?.tagType" size="small">
                {{ scheduleTypeConfig[row.scheduleType]?.text }}
              </el-tag>
            </template>
          </el-table-column>
          <el-table-column label="操作" width="100">
            <template #default="{ row }">
              <el-button size="small" type="success" @click="handleRestore(row)">
                <i class="fas fa-undo mr-1"></i> 復原
              </el-button>
            </template>
          </el-table-column>
        </el-table>
      </el-dialog>
    </section>
  </div>
</template>

<style scoped>
.schedule-list-container {
  padding: 20px;
}

.page-title {
  font-size: 1.6rem;
  font-weight: 600;
  color: #303133;
  display: flex;
  align-items: center;
  margin: 0;
}

/* ====== 統計卡片 ====== */
.stat-card {
  border-radius: 10px;
  text-align: center;
  transition: transform 0.2s;
}
.stat-card:hover {
  transform: translateY(-3px);
}
.stat-total :deep(.el-statistic__head) {
  color: #409eff;
}
.stat-upcoming :deep(.el-statistic__head) {
  color: #f56c6c;
}
.stat-daily :deep(.el-statistic__head) {
  color: #67c23a;
}
.stat-weekly :deep(.el-statistic__head) {
  color: #409eff;
}
.stat-monthly :deep(.el-statistic__head) {
  color: #e6a23c;
}

.stat-card :deep(.el-statistic__content) {
  font-size: 1.8rem;
  font-weight: 700;
}

/* ====== 主卡片 ====== */
.main-card {
  border-radius: 12px;
}

.toolbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  flex-wrap: wrap;
  gap: 12px;
}

.toolbar-right {
  display: flex;
  align-items: center;
}

.title-cell {
  display: flex;
  align-items: center;
  font-weight: 500;
}

.next-exec-cell {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.next-exec-cell .datetime {
  font-size: 12px;
  color: #606266;
}

.next-exec-cell .relative-tag {
  width: fit-content;
}

.pagination-bar {
  display: flex;
  justify-content: flex-end;
  margin-top: 16px;
}

/* ====== Timeline 卡片 ====== */
.timeline-card {
  border-radius: 12px;
}

.timeline-card .card-header {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
}

.timeline-content {
  cursor: pointer;
  padding: 8px;
  border-radius: 6px;
  transition: background 0.2s;
}

.timeline-content:hover {
  background: #f5f7fa;
}

.timeline-title {
  font-weight: 500;
  margin-bottom: 6px;
}

.timeline-meta {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  color: #909399;
}

/* ====== 工具類 ====== */
.mr-1 {
  margin-right: 4px;
}
.mr-2 {
  margin-right: 8px;
}
.ml-2 {
  margin-left: 8px;
}
.ml-auto {
  margin-left: auto;
}
.mb-4 {
  margin-bottom: 1rem;
}

/* ====== 動畫 ====== */
.fade-slide-enter-active,
.fade-slide-leave-active {
  transition: all 0.4s ease;
}
.fade-slide-enter-from {
  opacity: 0;
  transform: translateY(20px);
}
</style>

<style>
.swal2-container {
  z-index: 20000 !important;
}
</style>
</file>

<file path="frontend/src/views/member/AdminCreateView.vue">
<script setup>
/**
 * AdminCreateView.vue：新增管理員
 */
import { reactive } from 'vue'
import { useRouter } from 'vue-router'
import axios from 'axios'
import Swal from 'sweetalert2'

const router = useRouter()

const admin = reactive({
  admUsername: '',
  admPassword: '',
  admName: '',
  admEmail: '',
  admRole: 1,
  adminImage: 'default.png' // 11號以後預設圖片
})

// 驗證邏輯
const validateForm = () => {
  // 1. 信箱格式驗證：需包含 @ 且結尾為 .com
  const emailRegex = /^[^\s@]+@[^\s@]+\.com$/
  if (!emailRegex.test(admin.admEmail)) {
    Swal.fire({
      icon: 'warning',
      title: '格式錯誤',
      text: '信箱必須包含 @ 且以 .com 結尾',
      confirmButtonColor: '#409eff'
    })
    return false
  }

  // 2. 密碼格式驗證：至少 6 碼且包含至少 1 個英文字母
  const passwordRegex = /^(?=.*[a-zA-Z]).{6,}$/
  if (!passwordRegex.test(admin.admPassword)) {
    Swal.fire({
      icon: 'warning',
      title: '密碼格式錯誤',
      text: '密碼需至少 6 個字元，並包含至少一個英文字母',
      confirmButtonColor: '#409eff'
    })
    return false
  }

  // 3. 必填檢查
  if (!admin.admUsername || !admin.admName) {
    Swal.fire({
      icon: 'warning',
      title: '資料未填寫',
      text: '帳號與姓名為必填項目',
      confirmButtonColor: '#409eff'
    })
    return false
  }

  return true
}

const submitCreate = () => {
  if (!validateForm()) return

  axios
    .post('http://localhost:8080/admins', admin)
    .then((res) => {
      Swal.fire({
        icon: 'success',
        title: '新增成功',
        text: '管理員帳號已建立',
        timer: 1500,
        showConfirmButton: false
      }).then(() => {
        router.push('/admin/admins')
      })
    })
    .catch((err) => {
      console.error('API Error:', err)
      Swal.fire({
        icon: 'error',
        title: '新增失敗',
        text: err.response?.data || '帳號可能已存在，請檢查輸入內容',
        confirmButtonColor: '#409eff'
      })
    })
}

// 一鍵帶入功能
const autoFill = () => {
  admin.admUsername = 'demoEmployee'
  admin.admPassword = 'demo987'
  admin.admName = '測試員工'
  admin.admEmail = 'alan123145@gmail.com'
  admin.admRole = 1
}

const goBack = () => {
  router.push('/admin/admins')
}
</script>

<template>
  <div class="create-page">
    <div class="form-card">
      <div class="card-header">
        <div class="header-icon">
          <i class="fas fa-user-plus"></i>
        </div>
        <h2>新增管理員</h2>
        <p>建立新的系統管理員帳號</p>
      </div>

      <el-form @submit.prevent="submitCreate" label-position="top" class="admin-form">
        <el-form-item label="帳號" required>
          <el-input
            v-model="admin.admUsername"
            placeholder="請輸入帳號"
            prefix-icon="User"
            autocomplete="new-username"
          />
        </el-form-item>

        <el-form-item label="密碼" required>
          <el-input
            type="password"
            v-model="admin.admPassword"
            placeholder="至少 6 碼且包含英文字母"
            prefix-icon="Lock"
            autocomplete="new-password"
            show-password
          />
        </el-form-item>

        <el-form-item label="姓名" required>
          <el-input
            v-model="admin.admName"
            placeholder="請輸入姓名"
            prefix-icon="UserFilled"
          />
        </el-form-item>

        <el-form-item label="信箱" required>
          <el-input
            v-model="admin.admEmail"
            placeholder="example@mail.com"
            prefix-icon="Message"
          />
        </el-form-item>

        <el-form-item label="角色">
          <el-select v-model="admin.admRole" placeholder="選擇角色" style="width: 100%">
            <el-option :value="1" label="一般管理員">
              <span class="role-option">
                <i class="fas fa-user-tie mr-2"></i> 一般管理員
              </span>
            </el-option>
            <el-option :value="9" label="超級管理員">
              <span class="role-option">
                <i class="fas fa-crown mr-2"></i> 超級管理員
              </span>
            </el-option>
          </el-select>
        </el-form-item>

        <div class="form-actions">
          <el-button 
            type="primary" 
            size="large" 
            native-type="submit" 
            class="submit-btn"
          >
            <i class="fas fa-check mr-2"></i> 確認新增
          </el-button>

          <el-button 
              type="info" 
              plain 
              size="large" 
              @click="autoFill" 
              class="demo-btn"
          >
            <i class="fas fa-magic mr-2"></i> 一鍵帶入
          </el-button>

          <el-button size="large" @click="goBack" class="back-btn" style="margin-left: 0">
            <i class="fas fa-arrow-left mr-2"></i> 回管理員列表
          </el-button>
        </div>
      </el-form>
    </div>
  </div>
</template>

<style scoped>
/* ========== 頁面容器 ========== */
.create-page {
  min-height: 100vh;
  padding: 40px 20px;
  background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ========== 表單卡片 ========== */
.form-card {
  width: 100%;
  max-width: 480px;
  background: white;
  border-radius: 20px;
  padding: 40px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
  animation: slideUp 0.5s ease;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* ========== 標題區域 ========== */
.card-header {
  text-align: center;
  margin-bottom: 32px;
}

.header-icon {
  width: 72px;
  height: 72px;
  background: linear-gradient(135deg, #e8f4fc 0%, #d4e8f7 100%);
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  color: #5b9bd5;
  margin: 0 auto 16px;
  box-shadow: 0 4px 15px rgba(91, 155, 213, 0.15);
}

.card-header h2 {
  margin: 0;
  font-size: 1.6rem;
  font-weight: 700;
  color: #303133;
}

.card-header p {
  margin: 8px 0 0;
  color: #909399;
  font-size: 0.95rem;
}

/* ========== 表單樣式 ========== */
.admin-form {
  margin-top: 24px;
}

.admin-form :deep(.el-form-item__label) {
  font-weight: 600;
  color: #606266;
}

.admin-form :deep(.el-input__wrapper) {
  border-radius: 10px;
  padding: 4px 12px;
}

.admin-form :deep(.el-select .el-input__wrapper) {
  border-radius: 10px;
}

.role-option {
  display: flex;
  align-items: center;
}

/* ========== 按鈕區域 ========== */
.form-actions {
  margin-top: 32px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.submit-btn {
  width: 100%;
  height: 48px;
  font-size: 16px;
  font-weight: 600;
  border-radius: 12px;
  background: linear-gradient(135deg, #5b9bd5 0%, #7cb9e8 100%);
  border: none;
  transition: all 0.3s ease;
  cursor: pointer;
  color: white;
}

.submit-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(91, 155, 213, 0.35);
  filter: brightness(1.1);
}

.submit-btn:active {
  transform: scale(0.95);
}

.back-btn {
  width: 100%;
  height: 44px;
  font-size: 15px;
  border-radius: 10px;
  border: 2px solid #e8ecf1;
  background: transparent;
  color: #606266;
  transition: all 0.3s ease;
  cursor: pointer;
}

.back-btn:hover {
  border-color: #5b9bd5;
  color: #5b9bd5;
  background: rgba(91, 155, 213, 0.05);
}

.back-btn:active {
  transform: scale(0.95);
}

/* ========== 工具類 ========== */
.mr-2 { 
  margin-right: 8px; 
}

/* ========== 響應式設計 ========== */
@media (max-width: 520px) {
  .form-card {
    padding: 24px;
    margin: 16px;
  }
  
  .header-icon {
    width: 60px;
    height: 60px;
    font-size: 24px;
  }
}

/* ========== 一鍵帶入按鈕樣式 ========== */
.demo-btn {
  width: 100%;
  height: 44px;
  font-size: 15px;
  border-radius: 10px;
  border: 1px dashed #909399; /* 虛線邊框 */
  background: #f8f9fa;
  color: #606266;
  transition: all 0.3s ease;
  cursor: pointer;
  margin-left: 0 !important; /* 強制覆蓋 Element Plus 預設間距 */
}

.demo-btn:hover {
  background: #f0f2f5;
  border-color: #5b9bd5;
  color: #5b9bd5;
  transform: translateY(-1px);
}

.demo-btn:active {
  transform: scale(0.98);
}
</style>
</file>

<file path="frontend/src/views/member/AdminEditView.vue">
<script setup>
/**
 * AdminEditView.vue：編輯管理員 (完整驗證與 SweetAlert 版)
 */
import { ref, onMounted } from 'vue'
import { useRouter, useRoute } from 'vue-router'
import axios from 'axios'
import Swal from 'sweetalert2'

const router = useRouter()
const route = useRoute()

const admin = ref(null)
const newPassword = ref('')
const errorMsg = ref('')
const loading = ref(false)

// 載入資料
const fetchAdmin = () => {
  loading.value = true
  const id = route.params.id
  axios
    .get(`http://localhost:8080/admins/find?admId=${id}`)
    .then((res) => {
      // res.data 應包含 adminImage 欄位
      admin.value = res.data
    })
    .catch(() => {
      errorMsg.value = '載入管理員資料失敗'
    })
    .finally(() => {
      loading.value = false
    })
}

// 驗證邏輯
const validateForm = () => {
  // 1. 信箱格式驗證：需包含 @ 且結尾為 .com
  const emailRegex = /^[^\s@]+@[^\s@]+\.com$/
  if (!emailRegex.test(admin.value.admEmail)) {
    Swal.fire({
      icon: 'warning',
      title: '信箱格式錯誤',
      text: '電子郵件必須包含 @ 且以 .com 結尾',
      confirmButtonColor: '#409eff'
    })
    return false
  }

  // 2. 密碼格式驗證：如果有填寫新密碼，則需至少 6 碼 + 1 英文字
  if (newPassword.value && newPassword.value.trim() !== '') {
    const passwordRegex = /^(?=.*[a-zA-Z]).{6,}$/
    if (!passwordRegex.test(newPassword.value)) {
      Swal.fire({
        icon: 'warning',
        title: '新密碼格式不符',
        text: '新密碼需至少 6 個字元，且包含至少 1 個英文字母',
        confirmButtonColor: '#409eff'
      })
      return false
    }
  }

  return true
}

// 提交修改
const submitEdit = () => {
  if (!validateForm()) return

  const payload = {
    ...admin.value,
    admPassword: newPassword.value || '', // 如果沒填就傳空字串，後端會判斷不更新密碼
  }

  axios
    .post('http://localhost:8080/admins/update', payload)
    .then(() => {
      Swal.fire({
        icon: 'success',
        title: '修改成功',
        text: '管理員資料已成功更新',
        timer: 1500,
        showConfirmButton: false
      }).then(() => {
        router.push('/admin/admins')
      })
    })
    .catch((err) => {
      console.error('Update Error:', err)
      Swal.fire({
        icon: 'error',
        title: '修改失敗',
        text: '請檢查輸入資料或連線狀況',
        confirmButtonColor: '#409eff'
      })
    })
}

const goBack = () => {
  router.push('/admin/admins')
}

onMounted(() => {
  fetchAdmin()
})
</script>

<template>
  <div class="edit-page">
    <div class="form-card">
      <div class="card-header">
        <div class="header-icon">
          <i class="fas fa-user-edit"></i>
        </div>
        <h2>修改管理員資料</h2>
        <p>編輯現有管理員的帳號資訊</p>
      </div>

      <el-alert 
        v-if="errorMsg" 
        :title="errorMsg" 
        type="error" 
        show-icon 
        :closable="false" 
        class="error-alert" 
      />
      
      <div v-if="loading" class="loading-state">
        <i class="fas fa-spinner fa-spin loading-icon"></i>
        <p>資料載入中...</p>
      </div>

      <el-form v-else-if="admin" @submit.prevent="submitEdit" label-position="top" class="admin-form">
        <input type="hidden" v-model="admin.admId" />

        <el-form-item label="帳號" required>
          <el-input
            v-model="admin.admUsername"
            placeholder="請輸入帳號"
            prefix-icon="User"
          />
        </el-form-item>

        <el-form-item label="新密碼">
          <el-input
            type="password"
            v-model="newPassword"
            placeholder="若不修改請留空"
            prefix-icon="Lock"
            show-password
          />
          <div class="form-hint">
            <i class="fas fa-info-circle"></i>
            需至少 6 碼並含 1 個英文字，不修改請保持空白
          </div>
        </el-form-item>

        <el-form-item label="姓名" required>
          <el-input
            v-model="admin.admName"
            placeholder="請輸入姓名"
            prefix-icon="UserFilled"
          />
        </el-form-item>

        <el-form-item label="信箱" required>
          <el-input
            v-model="admin.admEmail"
            placeholder="example@mail.com"
            prefix-icon="Message"
          />
        </el-form-item>

        <el-form-item label="角色">
          <el-select v-model="admin.admRole" placeholder="選擇角色" style="width: 100%">
            <el-option :value="1" label="一般管理員">
              <span class="role-option">
                <i class="fas fa-user-tie mr-2"></i> 一般管理員
              </span>
            </el-option>
            <el-option :value="9" label="超級管理員">
              <span class="role-option">
                <i class="fas fa-crown mr-2"></i> 超級管理員
              </span>
            </el-option>
          </el-select>
        </el-form-item>

        <div class="form-actions">
          <el-button 
            type="primary" 
            size="large" 
            native-type="submit" 
            class="submit-btn"
          >
            <i class="fas fa-save mr-2"></i> 確認修改
          </el-button>
          <el-button 
            size="large" 
            @click="goBack" 
            class="back-btn"
            style="margin-left: 0"
          >
            <i class="fas fa-arrow-left mr-2"></i> 回管理員列表
          </el-button>
        </div>
      </el-form>
    </div>
  </div>
</template>

<style scoped>
/* ========== 頁面容器 ========== */
.edit-page {
  min-height: 100vh;
  padding: 40px 20px;
  background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ========== 表單卡片 ========== */
.form-card {
  width: 100%;
  max-width: 480px;
  background: white;
  border-radius: 20px;
  padding: 40px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
  animation: slideUp 0.5s ease;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* ========== 標題區域 ========== */
.card-header {
  text-align: center;
  margin-bottom: 32px;
}

.header-icon {
  width: 72px;
  height: 72px;
  background: linear-gradient(135deg, #e8f4fc 0%, #d4e8f7 100%);
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  color: #5b9bd5;
  margin: 0 auto 16px;
  box-shadow: 0 4px 15px rgba(91, 155, 213, 0.15);
}

.card-header h2 {
  margin: 0;
  font-size: 1.6rem;
  font-weight: 700;
  color: #303133;
}

.card-header p {
  margin: 8px 0 0;
  color: #909399;
  font-size: 0.95rem;
}

/* ========== 載入狀態 ========== */
.loading-state {
  text-align: center;
  padding: 40px;
}

.loading-icon {
  font-size: 36px;
  color: #409eff;
  margin-bottom: 16px;
}

.loading-state p {
  color: #909399;
  font-size: 15px;
}

/* ========== 錯誤提示 ========== */
.error-alert {
  margin-bottom: 20px;
  border-radius: 10px;
}

/* ========== 表單樣式 ========== */
.admin-form {
  margin-top: 24px;
}

.admin-form :deep(.el-form-item__label) {
  font-weight: 600;
  color: #606266;
}

.admin-form :deep(.el-input__wrapper) {
  border-radius: 10px;
  padding: 4px 12px;
}

.admin-form :deep(.el-select .el-input__wrapper) {
  border-radius: 10px;
}

.form-hint {
  margin-top: 6px;
  font-size: 12px;
  color: #909399;
  display: flex;
  align-items: center;
  gap: 6px;
}

.form-hint i {
  color: #409eff;
}

.role-option {
  display: flex;
  align-items: center;
}

/* ========== 按鈕區域 ========== */
.form-actions {
  margin-top: 32px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.submit-btn {
  width: 100%;
  height: 48px;
  font-size: 16px;
  font-weight: 600;
  border-radius: 12px;
  background: linear-gradient(135deg, #5b9bd5 0%, #7cb9e8 100%);
  border: none;
  transition: all 0.3s ease;
  color: white;
  cursor: pointer;
}

.submit-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(91, 155, 213, 0.35);
}

.submit-btn:active {
  transform: scale(0.95);
}

.back-btn {
  width: 100%;
  height: 44px;
  font-size: 15px;
  border-radius: 10px;
  border: 2px solid #e8ecf1;
  background: transparent;
  color: #606266;
  transition: all 0.3s ease;
  cursor: pointer;
}

.back-btn:hover {
  border-color: #5b9bd5;
  color: #5b9bd5;
  background: rgba(91, 155, 213, 0.05);
}

.back-btn:active {
  transform: scale(0.95);
}

/* ========== 工具類 ========== */
.mr-2 { 
  margin-right: 8px; 
}

/* ========== 響應式設計 ========== */
@media (max-width: 520px) {
  .form-card {
    padding: 24px;
    margin: 16px;
  }
  
  .header-icon {
    width: 60px;
    height: 60px;
    font-size: 24px;
  }
}
</style>
</file>

<file path="frontend/src/views/member/LoginView.vue">
<script setup>
import { ref, reactive, watch } from 'vue' // 引入 reactive
import { useRouter, useRoute } from 'vue-router' // 引入 useRoute
import axios from 'axios'

//  SweetAlert2：統一用彈窗顯示成功/失敗訊息（取代 errorMsg/successMsg）
import Swal from 'sweetalert2'

//  Pinia：引入兩種 store
import { useAdminAuthStore } from '@/stores/adminAuth'
import { useMemberAuthStore } from '@/stores/memberAuth'

const adminAuthStore = useAdminAuthStore()
const memberAuthStore = useMemberAuthStore()
const router = useRouter()
const route = useRoute() // 建立 route 實例

/**
 * 登入類型：
 * - member：會員登入（導向 /member/profile）
 * - admin：管理員登入（導向 /admin）
 */
const loginType = ref('member') // member | admin

// --- 忘記密碼相關狀態 ---
const viewMode = ref('login') // login | forgot | reset
const forgotForm = reactive({
  email: '',
  code: '',
  newPassword: '',
  confirmPassword: ''
})

// 返回登入並清空資料
const backToLogin = () => {
  viewMode.value = 'login'
  forgotForm.email = ''
  forgotForm.code = ''
}
// -----------------------

// 共用輸入欄位（會員/管理員都用同一組欄位）
const account = ref('')
const password = ref('')

// 切換登入身分時，清空輸入，避免誤送上一種身分的帳密
watch(loginType, () => {
  account.value = ''
  password.value = ''
})

/**
 * 登入主流程（async/await）
 * 目的：
 * 1) 避免 Promise then/catch 的順序 race condition
 * 2) 確保「先寫入 localStorage」再導頁，路由守衛才會放行
 */
const login = async () => {
  try {
    // =========================
    // 會員登入
    // =========================
    if (loginType.value === 'member') {
      const res = await axios.post(
        'http://localhost:8080/login/member',
        {
          memUsername: account.value,
          memPassword: password.value,
        },
        {
          withCredentials: true,
        },
      )

      /**
       * token 儲存規則（統一 localStorage）
       * - main.js 的 axios interceptor 從 localStorage 取 token
       * - 所以這裡也必須存 localStorage
       * - 若後端沒回 token，暫用 'login-ok'（你原本 HEAD 的策略）避免流程卡死
       */
      const token = res.data?.token || 'login-ok'
      localStorage.setItem('token', token)

      adminAuthStore.clearAdmin()
      localStorage.removeItem('admin')

      //  [+] 將登入狀態存入 Pinia，讓整個 App 保持同步
      memberAuthStore.setMemberLogin({
        memId: res.data.memId,
        memUsername: res.data.memUsername,
        memName: res.data.memName,
        memPoints: res.data.memPoints,
        memInvoice: res.data.memInvoice,
      })

      //  [+] 將會員資料存入 localStorage，實現持久化登入
      localStorage.setItem('member_user', JSON.stringify(res.data))

      // 成功提示
      await Swal.fire({
        icon: 'success',
        title: '登入成功',
        text: '歡迎回來！',
        showConfirmButton: false,
        timer: 1200,
      })

      //  檢查是否有重定向路徑，若有則跳轉，否則導向會員頁
      if (route.query.redirect) {
        router.push(route.query.redirect)
      } else {
        router.push('/')
      }
      return
    }

    // =========================
    // 管理員登入 (最簡化修正版)
    // =========================
    const res = await axios.post(
      'http://localhost:8080/login/admin',
      {
        admUsername: account.value,
        admPassword: password.value,
      },
      {
        withCredentials: true,
      },
    )

    // 1. 只清掉「會員」的資料，不要用 clear()
    localStorage.removeItem('member_user')
    memberAuthStore.clearMemberLogin()

    // 2. 存入管理員 Token 與資料
    const token = res.data?.token || 'admin-login-ok'
    localStorage.setItem('token', token)

    const adminData = {
      username: res.data?.admUsername,
      name: res.data?.admName,
      role: res.data?.admRole,
      admId: res.data?.admId,          // 補上 ID
      admEmail: res.data?.admEmail,    // 補上 Email
      admCreatedAt: res.data?.admCreatedAt // 補上到職日
    }

    // 3. 同步寫入 Pinia 和 LocalStorage
    adminAuthStore.setAdmin(adminData)
    localStorage.setItem('admin', JSON.stringify(adminData))

    // 4. 成功提示
    await Swal.fire({
      icon: 'success',
      title: '管理員登入成功',
      text: '歡迎回來！',
      showConfirmButton: false,
      timer: 1000,
    })

    //  進後台（replace 避免回上一頁又回到登入頁）
    router.push('/admin')
  } catch (err) {
    console.error(err)

    // 錯誤訊息整理：後端可能回字串或物件
    let errorText = '登入失敗'
    if (err.response && err.response.data) {
      const msg = err.response.data
      errorText = typeof msg === 'object' ? JSON.stringify(msg) : String(msg)
    }

    // 失敗提示
    Swal.fire({
      icon: 'error',
      title: '登入失敗',
      text: errorText,
      confirmButtonText: '確認',
    })
  }
}

// 發送驗證碼邏輯
const handleSendCode = async () => {
  if (!forgotForm.email) {
    Swal.fire('錯誤', '請填寫電子郵件', 'warning')
    return
  }
  // 顯示讀取中，因為寄信需要 2~5 秒
  Swal.fire({
    title: '正在發送驗證碼...',
    allowOutsideClick: false,
    didOpen: () => { Swal.showLoading() }
  })
  try {
    // 根據目前的登入身分(member/admin)決定 API 路徑
    const url = loginType.value === 'admin' 
      ? 'http://localhost:8080/api/admin/forgot-password/send-code' 
      : 'http://localhost:8080/api/forgot-password/send-code';

    await axios.post(url, { email: forgotForm.email })
    
    Swal.close() // 關閉 Loading
    await Swal.fire('成功', '驗證碼已發送至您的信箱', 'success')
    viewMode.value = 'reset'
  } catch (err) {
    Swal.close()
    console.error(err)
    // 顯示後端傳回的錯誤訊息（例如：帳號不存在）
    const errorMsg = err.response?.data || '發送失敗，請檢查網路或信箱'
    Swal.fire('失敗', errorMsg, 'error')
  }
}

// 重設密碼邏輯
const handleResetPassword = async () => {
  // 基本檢查
  if (!forgotForm.code || !forgotForm.newPassword) {
    Swal.fire('錯誤', '請完整填寫驗證碼與新密碼', 'warning')
    return
  }

  if (forgotForm.newPassword !== forgotForm.confirmPassword) {
    Swal.fire('錯誤', '兩次密碼輸入不一致', 'error')
    return
  }

  try {
    // 根據目前的登入身分(member/admin)決定 API 路徑
    const url = loginType.value === 'admin' 
      ? 'http://localhost:8080/api/admin/forgot-password/reset' 
      : 'http://localhost:8080/api/forgot-password/reset';

    await axios.post(url, forgotForm)
    
    await Swal.fire('成功', '密碼重設成功，請重新登入', 'success')
    backToLogin()
  } catch (err) {
    console.error(err)
    const errorMsg = err.response?.data || '驗證碼錯誤或已過期'
    Swal.fire('重設失敗', errorMsg, 'error')
  }
}

/**
 * Particles 背景設定（只影響視覺，不影響登入邏輯）
 * 注意：main.js 需已 app.use(Particles) 且已載入 loadSlim
 */
const particlesOptions = {
  background: {
    color: { value: '#e9ecef' },
  },
  particles: {
    color: { value: '#6c757d' },
    links: {
      enable: true,
      color: '#6c757d',
      distance: 150,
      opacity: 0.3,
      width: 1,
    },
    move: {
      enable: true,
      speed: 1.2,
    },
    number: {
      value: 60,
    },
    size: {
      value: { min: 1, max: 3 },
    },
  },
  interactivity: {
    events: {
      onHover: {
        enable: true,
        mode: 'grab',
      },
    },
  },
}

const goRegister = () => {
  router.push('/register')
}

const loginWithGoogle = () => {
  // 加上時間戳記 t=${Date.now()} 確保每次請求都是新的，不被瀏覽器緩存網址
  const googleLoginUrl = `http://localhost:8080/oauth2/authorization/google?prompt=select_account&t=${Date.now()}`
  window.location.href = googleLoginUrl
}
</script>

<template>
  <div class="login-page">
    <vue-particles id="tsparticles" :options="particlesOptions" class="particles-bg" />

    <div class="login-box">
      <div class="card card-outline card-primary">
        <div class="card-header text-center">
          <h1 class="h1"><b>SeatRentSys</b></h1>
        </div>
        <div class="card-body">
          
          <div v-if="viewMode === 'login'">
            <div class="login-switch">
              <button
                :class="{ active: loginType === 'member' }"
                @click="loginType = 'member'"
                type="button"
              >
                會員登入
              </button>

              <button
                :class="{ active: loginType === 'admin' }"
                @click="loginType = 'admin'"
                type="button"
              >
                管理員登入
              </button>
            </div>

            <form @submit.prevent="login">
              <div class="input-group mb-3">
                <input
                  v-model="account"
                  type="text"
                  class="form-control"
                  :placeholder="loginType === 'member' ? '會員帳號' : '管理員帳號'"
                  required
                />
              </div>
              <div class="input-group mb-3">
                <input
                  v-model="password"
                  type="password"
                  class="form-control"
                  :placeholder="loginType === 'member' ? '會員密碼' : '管理員密碼'"
                  required
                />
              </div>

              <div class="helper-links">
                <span v-if="loginType === 'member'" @click="goRegister">註冊會員</span>
                
                <span v-else></span>

                <span @click="viewMode = 'forgot'">忘記密碼？</span>
              </div>

              <div class="google-login-section">
                <div class="divider">
                  <span>或使用第三方登入</span>
                </div>

                <button type="button" class="btn-google" @click="loginWithGoogle">
                  <img
                    src="https://developers.google.com/static/identity/images/g-logo.png"
                    alt="Google"
                  />
                  使用 Google 帳號登入
                </button>
              </div>

              <button type="submit" class="btn btn-primary btn-block">登入</button>
              <div class="back-to-home" @click="router.push('/')">
                <el-icon><ArrowLeft /></el-icon>
                <span>返回首頁</span>
              </div>
            </form>
          </div>

          <div v-else-if="viewMode === 'forgot'">
            <h2 class="sub-title">忘記密碼</h2>
            <p class="desc-text">請輸入您的電子郵件，我們將發送驗證碼至您的信箱</p>
            
            <div class="input-group mb-3">
              <input
                v-model="forgotForm.email"
                type="email"
                class="form-control"
                placeholder="請輸入註冊的 E-MAIL"
              />
            </div>
            
            <button @click="handleSendCode" class="btn btn-primary btn-block">發送驗證碼</button>
            
            <div class="back-link-center" @click="backToLogin">
              <span>返回登入頁面</span>
            </div>
          </div>

          <div v-else-if="viewMode === 'reset'">
            <h2 class="sub-title">重設密碼</h2>
            <div class="info-text">驗證碼已發送至：{{ forgotForm.email }}</div>
            
            <div class="input-group mb-3">
              <input v-model="forgotForm.code" type="text" class="form-control" placeholder="請輸入 6 位驗證碼" />
            </div>
            <div class="input-group mb-3">
              <input v-model="forgotForm.newPassword" type="password" class="form-control" placeholder="新密碼" />
            </div>
            <div class="input-group mb-3">
              <input v-model="forgotForm.confirmPassword" type="password" class="form-control" placeholder="再次確認新密碼" />
            </div>
            
            <button @click="handleResetPassword" class="btn btn-primary btn-block">確認重設</button>
            
            <div class="back-link-center" @click="viewMode = 'forgot'">
              <span>重新輸入電子郵件</span>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</template>

<style scoped>
/* ========== 登入頁面主容器 ========== */
.login-page {
  position: relative;
  height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  background: linear-gradient(135deg, #9db8d4 0%, #8aa5c1 100%);
}

/* 粒子背景：最底層 */
.particles-bg {
  position: fixed;
  inset: 0;
  z-index: 0;
}

/* ========== 登入框：Glassmorphism 風格 ========== */
.login-box {
  width: 400px;
  position: relative;
  z-index: 10;
}

.login-box .card {
  background: rgba(255, 255, 255, 0.85);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border: 1px solid rgba(255, 255, 255, 0.4);
  border-radius: 16px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
  overflow: hidden;
}

.login-box .card-header {
  background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
  padding: 24px;
  border-bottom: none;
}

.login-box .card-header h1 {
  color: #ffffff;
  font-size: 1.8rem;
  font-weight: 700;
  margin: 0;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.login-box .card-body {
  padding: 28px;
}

/* ========== 登入切換按鈕 ========== */
.login-switch {
  display: flex;
  justify-content: center;
  gap: 12px;
  margin-bottom: 24px;
}

.login-switch button {
  padding: 10px 24px;
  border: 2px solid #e2e8f0;
  background-color: #f8fafc;
  color: #475569;
  cursor: pointer;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 500;
  transition:
    background-color 0.2s ease,
    border-color 0.2s ease,
    color 0.2s ease;
}

.login-switch button:hover {
  background-color: #e2e8f0;
  border-color: #cbd5e1;
}

.login-switch button.active {
  background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
  color: #ffffff;
  border-color: #3b82f6;
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

/* ========== 輸入欄位 ========== */
.login-box .input-group {
  margin-bottom: 16px;
}

.login-box .form-control {
  padding: 12px 16px;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  font-size: 15px;
  transition:
    border-color 0.2s ease,
    box-shadow 0.2s ease;
  background: #f8fafc;
}

.login-box .form-control:focus {
  border-color: #60a5fa;
  box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2);
  outline: none;
  background: #ffffff;
}

.login-box .form-control::placeholder {
  color: #94a3b8;
}

/* ========== 輔助連結 (註冊 + 忘記密碼) ========== */
.helper-links {
  display: flex;
  justify-content: space-between;
  margin-bottom: 16px;
}

.helper-links span {
  font-size: 14px;
  color: #3b82f6;
  cursor: pointer;
  font-weight: 500;
  transition: color 0.2s ease;
}

.helper-links span:hover {
  color: #1d4ed8;
  text-decoration: underline;
}

/* ========== 登入按鈕 ========== */
.login-box .btn-primary {
  width: 100%;
  padding: 12px;
  background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
  border: none;
  border-radius: 10px;
  font-size: 16px;
  font-weight: 600;
  color: #ffffff;
  cursor: pointer;
  transition:
    transform 0.15s ease,
    box-shadow 0.15s ease;
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.login-box .btn-primary:hover {
  box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
}

.login-box .btn-primary:active {
  transform: translateY(1px);
}

/* ========== 忘記密碼專用樣式 ========== */
.sub-title {
  text-align: center;
  font-size: 20px;
  color: #333;
  margin-bottom: 15px;
}

.desc-text {
  font-size: 13px;
  color: #64748b;
  text-align: center;
  margin-bottom: 20px;
  line-height: 1.5;
}

.info-text {
  font-size: 14px;
  background-color: #f1f5f9;
  padding: 10px;
  border-radius: 8px;
  color: #475569;
  margin-bottom: 15px;
  text-align: center;
}

.back-link-center {
  margin-top: 20px;
  text-align: center;
  cursor: pointer;
}

.back-link-center span {
  font-size: 14px;
  color: #64748b;
  transition: color 0.2s;
}

.back-link-center:hover span {
  color: #3b82f6;
  text-decoration: underline;
}

/* ========== Google 登入與返回首頁  ========== */
.back-to-home {
  display: flex;
  justify-content: center;
  align-items: center;
  margin-top: 15px;
  /* 與登入按鈕拉開距離 */
  padding-top: 10px;
  border-top: 1px inset #f0f0f0; /* 加一條淡淡的分隔線 */
  color: #6c757d;
  /* 灰色，不搶走登入按鈕的焦點 */
  font-size: 14px;
  cursor: pointer;
  transition: color 0.2s;
  gap: 5px;
}

.back-to-home:hover {
  color: #007bff;
  /* 懸浮時變回藍色 */
  text-decoration: underline;
}

/* 確保 el-icon 在文字中間 */
.back-to-home .el-icon {
  font-size: 12px;
}

.google-login-section {
  margin-top: 20px;
}

.divider {
  display: flex;
  align-items: center;
  margin-bottom: 15px;
  color: #888;
  font-size: 12px;
}

.divider::before,
.divider::after {
  content: '';
  flex: 1;
  height: 1px;
  background: #eee;
}

.divider span {
  padding: 0 10px;
}

.btn-google {
  width: 100%;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  background-color: #ffffff;
  border: 1px solid #dadce0;
  border-radius: 4px;
  color: #3c4043;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: background-color 0.2s;
}

.btn-google img {
  width: 18px;
  height: 18px;
}

.btn-google:hover {
  background-color: #f8f9fa;
  box-shadow:
    0 1px 2px 0 rgba(60, 64, 67, 0.3),
    0 1px 3px 1px rgba(60, 64, 67, 0.15);
}
</style>
</file>

<file path="frontend/src/views/member/MemberCreateView.vue">
<script setup>
/**
 * MemberCreateView.vue：新增會員（換裝美化版）
 */
import { reactive } from 'vue'
import { useRouter } from 'vue-router'
import axios from 'axios'
import Swal from 'sweetalert2'

const router = useRouter()

const member = reactive({
  memUsername: '',
  memPassword: '',
  memName: '',
  memEmail: '',
  memPhone: '',
  memInvoice: '',
  memStatus: 1,
  memLevel: 1,
})

// --- 格式驗證邏輯 (保留原樣) ---
const validateForm = () => {
  if (!member.memUsername || !member.memPassword || !member.memName || !member.memEmail || !member.memPhone) {
    return '除了發票載具，其餘欄位皆為必填'
  }

  const pwdRegex = /^(?=.*[a-zA-Z]).{6,}$/
  if (!pwdRegex.test(member.memPassword)) {
    return '密碼需至少 6 個字元，並包含至少一個英文字母'
  }

  const phoneRegex = /^09\d{8}$/
  if (!phoneRegex.test(member.memPhone)) {
    return '手機格式錯誤，請輸入 09 開頭的 10 位數字'
  }

  const emailRegex = /^[^\s@]+@[^\s@]+\.com$/
  if (!emailRegex.test(member.memEmail)) {
    return '信箱格式錯誤，必須包含 @ 且結尾為 .com'
  }

  return null
}

const submitCreate = async () => {
  const error = validateForm()
  if (error) {
    await Swal.fire({
      icon: 'warning',
      title: '格式錯誤',
      text: error,
      confirmButtonColor: '#5b9bd5',
    })
    return
  }

  try {
    const res = await axios.post('http://localhost:8080/api/members', {
      ...member,
      memStatus: 1,
      memLevel: 1,
    })

    await Swal.fire({
      icon: 'success',
      title: '新增成功',
      text: res.data?.message || '會員已新增',
      timer: 1500,
      showConfirmButton: false,
    })

    router.push('/admin/members')
  } catch (err) {
    const msg = err.response?.data?.message || '新增失敗'
    await Swal.fire({
      icon: 'error',
      title: '新增失敗',
      text: msg,
      confirmButtonColor: '#f56c6c',
    })
  }
}

const goBack = () => {
  router.push('/admin/members')
}
</script>

<template>
  <div class="create-page">
    <div class="form-card">
      <div class="card-header">
        <div class="header-icon">
          <i class="fas fa-user-plus"></i>
        </div>
        <h2>新增會員</h2>
        <p>建立新的 Take@Seat 使用者帳號</p>
      </div>

      <el-form @submit.prevent="submitCreate" label-position="top" class="admin-form">
        <el-form-item label="帳號" required>
          <el-input
            v-model="member.memUsername"
            placeholder="請輸入帳號"
            prefix-icon="User"
            autocomplete="new-username"
          />
        </el-form-item>

        <el-form-item label="密碼" required>
          <el-input
            type="password"
            v-model="member.memPassword"
            placeholder="至少 6 碼且包含英文字母"
            prefix-icon="Lock"
            autocomplete="new-password"
            show-password
          />
        </el-form-item>

        <el-form-item label="姓名" required>
          <el-input
            v-model="member.memName"
            placeholder="請輸入真實姓名"
            prefix-icon="UserFilled"
          />
        </el-form-item>

        <el-form-item label="信箱" required>
          <el-input
            v-model="member.memEmail"
            placeholder="example@mail.com"
            prefix-icon="Message"
          />
        </el-form-item>

        <el-form-item label="手機" required>
          <el-input
            v-model="member.memPhone"
            placeholder="09xxxxxxxx"
            maxlength="10"
            prefix-icon="Iphone"
          />
        </el-form-item>

        <el-form-item label="發票載具 (選填)">
          <el-input
            v-model="member.memInvoice"
            placeholder="例：/ABC1234"
            prefix-icon="Tickets"
          />
        </el-form-item>

        <div class="form-actions">
          <el-button 
            type="primary" 
            size="large" 
            native-type="submit" 
            class="submit-btn"
          >
            <i class="fas fa-check mr-2"></i> 確認新增
          </el-button>
          
          <el-button 
            size="large" 
            @click="goBack" 
            class="back-btn"
            style="margin-left: 0" 
          >
            <i class="fas fa-arrow-left mr-2"></i> 回會員列表
          </el-button>
        </div>
      </el-form>
    </div>
  </div>
</template>

<style scoped>
/* ========== 頁面容器 ========== */
.create-page {
  min-height: 100vh;
  padding: 40px 20px;
  background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ========== 表單卡片 ========== */
.form-card {
  width: 100%;
  max-width: 480px;
  background: white;
  border-radius: 20px;
  padding: 40px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
  animation: slideUp 0.5s ease;
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(30px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ========== 標題區域 ========== */
.card-header {
  text-align: center;
  margin-bottom: 32px;
}

.header-icon {
  width: 72px;
  height: 72px;
  background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  color: #3b82f6;
  margin: 0 auto 16px;
}

.card-header h2 {
  margin: 0;
  font-size: 1.6rem;
  font-weight: 700;
  color: #1e3a5f;
}

.card-header p {
  margin: 8px 0 0;
  color: #94a3b8;
  font-size: 0.95rem;
}

/* ========== 表單樣式 ========== */
.admin-form :deep(.el-form-item__label) {
  font-weight: 600;
  color: #475569;
}

.admin-form :deep(.el-input__wrapper) {
  border-radius: 10px;
  padding: 4px 12px;
  background-color: #f8fafc;
}

/* ========== 按鈕區域 ========== */
.form-actions {
  margin-top: 32px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.submit-btn {
  width: 100%;
  height: 48px;
  font-size: 16px;
  font-weight: 600;
  border-radius: 12px;
  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  border: none;
  color: white;
}

.submit-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(59, 130, 246, 0.35);
}

.back-btn {
  width: 100%;
  height: 48px;
  font-size: 15px;
  border-radius: 12px;
  border: 1px solid #e2e8f0;
  background: white;
  color: #64748b;
}

.back-btn:hover {
  border-color: #3b82f6;
  color: #3b82f6;
  background: #f0f7ff;
}

.mr-2 { margin-right: 8px; }

@media (max-width: 520px) {
  .form-card { padding: 24px; }
}
</style>
</file>

<file path="frontend/src/views/member/MemberEditView.vue">
<script setup>
import { ref, onMounted } from 'vue'
import { useRouter, useRoute } from 'vue-router'
import axios from 'axios'
import Swal from 'sweetalert2'

const router = useRouter()
const route = useRoute()

// 保留你原本的初始結構與回填邏輯
const member = ref({
  memId: '',
  memUsername: '',
  memName: '',
  memEmail: '',
  memPhone: '',
  memPoints: 0,
  memInvoice: ''
})
const newPassword = ref('')
const errorMsg = ref('')
const isSubmitting = ref(false)
const isLoading = ref(true)

const fetchMember = async () => {
  const id = route.params.id
  isLoading.value = true
  try {
    const res = await axios.get(`http://localhost:8080/api/members/find`, {
      params: { memId: id },
    })
    
    const data = res.data
    member.value = {
      ...data,
      memEmail: data.memEmail || data.email || '', 
      memPhone: data.memPhone || data.phone || ''
    }
  } catch (err) {
    errorMsg.value = '載入會員資料失敗'
    Swal.fire({ icon: 'error', title: '載入失敗', text: errorMsg.value })
  } finally {
    isLoading.value = false
  }
}

// 保留原本的驗證邏輯
const validateEditForm = () => {
  const m = member.value
  if (!m.memUsername || !m.memName || !m.memEmail || !m.memPhone) {
    return '基本資料欄位皆為必填'
  }
  if (newPassword.value) {
    const pwdRegex = /^(?=.*[a-zA-Z]).{6,}$/
    if (!pwdRegex.test(newPassword.value)) {
      return '新密碼需至少 6 個字元，並包含至少一個英文字母'
    }
  }
  const phoneRegex = /^09\d{8}$/
  if (!phoneRegex.test(m.memPhone)) {
    return '手機格式錯誤，請輸入 09 開頭的 10 位數字'
  }
  const emailRegex = /^[^\s@]+@[^\s@]+\.com$/
  if (!emailRegex.test(m.memEmail)) {
    return '信箱格式錯誤，必須包含 @ 且結尾為 .com'
  }
  if (m.memInvoice) {
    const invoiceRegex = /^\/[A-Z0-9]{7}$/
    if (!invoiceRegex.test(m.memInvoice)) {
      return '載具格式錯誤！請輸入 / 開頭加上 7 碼大寫英數組合'
    }
  }
  return null
}

const submitEdit = async () => {
  if (!member.value) return
  const error = validateEditForm()
  if (error) {
    await Swal.fire({
      icon: 'warning',
      title: '格式錯誤',
      text: error,
      confirmButtonColor: '#5b9bd5',
    })
    return
  }

  // 保留二次確認視窗
  const confirmResult = await Swal.fire({
    title: '確定要修改嗎？',
    text: "修改後的資料將會立即生效！",
    icon: 'question',
    showCancelButton: true,
    confirmButtonColor: '#5b9bd5',
    cancelButtonColor: '#909399',
    confirmButtonText: '修改',
    cancelButtonText: '取消'
  })

  if (!confirmResult.isConfirmed) return

  errorMsg.value = ''
  isSubmitting.value = true

  try {
    const payload = {
      ...member.value,
      ...(newPassword.value ? { memPassword: newPassword.value } : {}),
    }
    await axios.post('http://localhost:8080/api/members/update', payload)
    await Swal.fire({
      icon: 'success',
      title: '修改成功',
      text: '會員資料已更新',
      timer: 1500,
      showConfirmButton: false
    })
    router.push('/admin/members')
  } catch (err) {
    const msg = err?.response?.data?.message || '修改失敗'
    await Swal.fire({
      icon: 'error',
      title: '修改失敗',
      text: msg,
      confirmButtonColor: '#f56c6c',
    })
  } finally {
    isSubmitting.value = false
  }
}

const goBack = () => router.push('/admin/members')
onMounted(fetchMember)
</script>

<template>
  <div class="edit-page">
    <div class="form-card">
      <div class="card-header">
        <div class="header-icon">
          <i class="fas fa-user-edit"></i>
        </div>
        <h2>修改會員資料</h2>
        <p>編輯 Take@Seat 會員帳號與點數資訊</p>
      </div>

      <el-alert 
        v-if="errorMsg" 
        :title="errorMsg" 
        type="error" 
        show-icon 
        :closable="false" 
        class="error-alert" 
      />
      
      <div v-if="isLoading" class="loading-state">
        <i class="fas fa-spinner fa-spin loading-icon"></i>
        <p>資料載入中...</p>
      </div>

      <el-form v-else @submit.prevent="submitEdit" label-position="top" class="admin-form">
        <input type="hidden" v-model="member.memId" />

        <el-form-item label="帳號" required>
          <el-input v-model="member.memUsername" prefix-icon="User" />
        </el-form-item>

        <el-form-item label="新密碼">
          <el-input
            type="password"
            v-model="newPassword"
            placeholder="若不修改請留空"
            prefix-icon="Lock"
            show-password
          />
          <div class="form-hint">
            <i class="fas fa-info-circle"></i>
            需至少 6 碼並含英文字，不修改請保持空白
          </div>
        </el-form-item>

        <el-form-item label="姓名" required>
          <el-input v-model="member.memName" prefix-icon="UserFilled" />
        </el-form-item>

        <el-form-item label="信箱" required>
          <el-input v-model="member.memEmail" prefix-icon="Message" />
        </el-form-item>

        <el-form-item label="電話" required>
          <el-input v-model="member.memPhone" maxlength="10" prefix-icon="Iphone" />
        </el-form-item>

        <el-form-item label="點數">
          <el-input v-model.number="member.memPoints" type="number" prefix-icon="Coin" />
        </el-form-item>

        <el-form-item label="發票載具">
          <el-input v-model="member.memInvoice" placeholder="例：/ABC1234" prefix-icon="Tickets" />
        </el-form-item>

        <div class="form-actions">
          <el-button 
            type="primary" 
            size="large" 
            native-type="submit" 
            class="submit-btn"
            :loading="isSubmitting"
          >
            <i class="fas fa-save mr-2"></i> {{ isSubmitting ? '修改中...' : '確認修改' }}
          </el-button>
          <el-button 
            size="large" 
            @click="goBack" 
            class="back-btn"
            style="margin-left: 0"
          >
            <i class="fas fa-arrow-left mr-2"></i> 回會員列表
          </el-button>
        </div>
      </el-form>
    </div>
  </div>
</template>

<style scoped>
/* 套用管理員修改頁面的高級樣式 */
.edit-page {
  min-height: 100vh;
  padding: 40px 20px;
  background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
  display: flex;
  align-items: center;
  justify-content: center;
}

.form-card {
  width: 100%;
  max-width: 480px;
  background: white;
  border-radius: 20px;
  padding: 40px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
  animation: slideUp 0.5s ease;
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(30px); }
  to { opacity: 1; transform: translateY(0); }
}

.card-header {
  text-align: center;
  margin-bottom: 32px;
}

.header-icon {
  width: 72px;
  height: 72px;
  background: linear-gradient(135deg, #e8f4fc 0%, #d4e8f7 100%);
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  color: #5b9bd5;
  margin: 0 auto 16px;
}

.card-header h2 {
  margin: 0;
  font-size: 1.6rem;
  font-weight: 700;
  color: #303133;
}

.card-header p {
  margin: 8px 0 0;
  color: #909399;
  font-size: 0.95rem;
}

.loading-state {
  text-align: center;
  padding: 40px;
}

.loading-icon {
  font-size: 36px;
  color: #409eff;
  margin-bottom: 16px;
}

.error-alert {
  margin-bottom: 20px;
  border-radius: 10px;
}

.admin-form :deep(.el-form-item__label) {
  font-weight: 600;
  color: #606266;
}

.admin-form :deep(.el-input__wrapper) {
  border-radius: 10px;
  padding: 4px 12px;
}

.form-hint {
  margin-top: 6px;
  font-size: 12px;
  color: #909399;
  display: flex;
  align-items: center;
  gap: 6px;
}

.form-actions {
  margin-top: 32px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.submit-btn {
  width: 100%;
  height: 48px;
  font-size: 16px;
  font-weight: 600;
  border-radius: 12px;
  background: linear-gradient(135deg, #5b9bd5 0%, #7cb9e8 100%);
  border: none;
  color: white;
  transition: all 0.3s ease;
}

.submit-btn:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(91, 155, 213, 0.35);
}

.back-btn {
  width: 100%;
  height: 48px;
  font-size: 15px;
  border-radius: 12px;
  border: 1px solid #e8ecf1;
  background: transparent;
  color: #606266;
}

.back-btn:hover {
  border-color: #5b9bd5;
  color: #5b9bd5;
  background: rgba(91, 155, 213, 0.05);
}

.mr-2 { margin-right: 8px; }
</style>
</file>

<file path="frontend/src/views/merchantAndCoupon/RedemptionLogList.vue">
<template>
  <div class="log-list-container">
    <section class="content-header mb-4">
      <div class="container-fluid">
        <div class="page-title-box">
          <div class="title-icon"><i class="fas fa-chart-line"></i></div>
          <div class="title-content">
            <h1>兌換數據分析中心</h1>
            <p class="subtitle">視覺化監控優惠券熱度與兌換趨勢</p>
          </div>
        </div>
      </div>
    </section>

    <section class="filter-section mb-4">
      <div class="container-fluid">
        <el-card shadow="never" class="filter-card">
          <div class="d-flex align-items-center flex-wrap">
            <span class="filter-label me-3">
              <i class="fas fa-calendar-alt me-2 text-primary"></i>分析區間：
            </span>
            <el-date-picker
              v-model="dateRange"
              type="daterange"
              unlink-panels
              range-separator="至"
              start-placeholder="開始日期"
              end-placeholder="結束日期"
              value-format="YYYY-MM-DD"
              :shortcuts="dateShortcuts"
              class="me-3"
            />
            <el-button @click="resetFilter" plain size="small">重置</el-button>
            <div class="ms-auto">
              <el-button type="success" @click="exportToExcel">
                <i class="fas fa-file-excel me-1"></i> 匯出報表
              </el-button>
            </div>
          </div>
        </el-card>
      </div>
    </section>

    <section class="stat-section mb-4">
      <div class="container-fluid">
        <el-row :gutter="20">
          <el-col :xs="12" :md="6">
            <div class="stat-card total-card">
              <div class="stat-icon"><i class="fas fa-exchange-alt"></i></div>
              <div class="stat-info">
                <h3>{{ filteredLogs.length }}</h3>
                <span>區間兌換總次數</span>
              </div>
            </div>
          </el-col>
          <el-col :xs="12" :md="6">
            <div class="stat-card points-card">
              <div class="stat-icon"><i class="fas fa-coins"></i></div>
              <div class="stat-info">
                <h3>{{ totalPointsSpent }}</h3>
                <span>消耗點數總計</span>
              </div>
            </div>
          </el-col>
          <el-col :xs="12" :md="6">
            <div class="stat-card avg-card">
              <div class="stat-icon"><i class="fas fa-calculator"></i></div>
              <div class="stat-info">
                <h3>{{ avgPoints }}</h3>
                <span>平均每券點數</span>
              </div>
            </div>
          </el-col>
          <el-col :xs="12" :md="6">
            <div class="stat-card merchant-card">
              <div class="stat-icon"><i class="fas fa-ticket-alt"></i></div>
              <div class="stat-info">
                <h3>{{ uniqueCoupons }}</h3>
                <span>涉及優惠券種</span>
              </div>
            </div>
          </el-col>
        </el-row>
      </div>
    </section>

    <section class="chart-section mb-4">
      <div class="container-fluid">
        <el-row :gutter="20">
          <el-col :xs="24" :lg="16">
            <el-card shadow="hover" class="chart-card mb-4">
              <template #header>
                <div class="chart-header">
                  <i class="fas fa-chart-area me-2 text-primary"></i> 每日兌換趨勢
                </div>
              </template>
              <div ref="lineChartRef" style="height: 350px;"></div>
            </el-card>
          </el-col>
          <el-col :xs="24" :lg="8">
            <el-card shadow="hover" class="chart-card mb-4">
              <template #header>
                <div class="chart-header">
                  <i class="fas fa-chart-pie me-2 text-success"></i> 兌換佔比分析
                </div>
              </template>
              <div ref="pieChartRef" style="height: 350px;"></div>
            </el-card>
          </el-col>
        </el-row>

        <el-card shadow="hover" class="chart-card mb-4">
          <template #header>
            <div class="chart-header">
              <i class="fas fa-crown me-2 text-warning"></i> 熱門兌換排行榜 (Top 10)
            </div>
          </template>
          <div ref="barChartRef" style="height: 400px;"></div>
        </el-card>
      </div>
    </section>
  </div>
</template>

<script setup>
import { ref, computed, watch, onMounted, onUnmounted, nextTick } from 'vue'
import * as echarts from 'echarts'
import axios from 'axios'
import * as XLSX from 'xlsx'

// --- 狀態定義 ---
const allLogs = ref([])
const loading = ref(false)
const dateRange = ref([])
const lineChartRef = ref(null)
const pieChartRef = ref(null)
const barChartRef = ref(null)
let chartInstances = []

// 日期快捷選項
const dateShortcuts = [
  { text: '最近一週', value: () => {
    const end = new Date(); const start = new Date();
    start.setTime(start.getTime() - 3600 * 1000 * 24 * 7);
    return [start, end]
  }},
  { text: '最近一個月', value: () => {
    const end = new Date(); const start = new Date();
    start.setMonth(start.getMonth() - 1);
    return [start, end]
  }},
  { text: '最近三個月', value: () => {
    const end = new Date(); const start = new Date();
    start.setMonth(start.getMonth() - 3);
    return [start, end]
  }}
]

// --- 核心邏輯：數據篩選 ---
const filteredLogs = computed(() => {
  if (!dateRange.value || dateRange.value.length !== 2) return allLogs.value;
  
  const start = new Date(dateRange.value[0]).getTime();
  // 結束日期設為當日 23:59:59
  const end = new Date(dateRange.value[1]).setHours(23, 59, 59, 999);

  return allLogs.value.filter(log => {
    const time = new Date(log.redeemTime).getTime();
    return time >= start && time <= end;
  });
});

// --- 統計數據計算 ---
const totalPointsSpent = computed(() => filteredLogs.value.reduce((s, l) => s + (l.pointsSpent || 0), 0))
const uniqueCoupons = computed(() => new Set(filteredLogs.value.map(l => l.couponId)).size)
const avgPoints = computed(() => {
  return filteredLogs.value.length > 0 
    ? (totalPointsSpent.value / filteredLogs.value.length).toFixed(1) 
    : 0
})

// --- API 請求 ---
const fetchLogs = async () => {
  loading.value = true
  try {
    const res = await axios.get('http://localhost:8080/api/discounts/logs')
    allLogs.value = res.data.data || []
    await nextTick()
    renderAllCharts()
  } catch (err) {
    console.error('資料載入失敗', err)
  } finally {
    loading.value = false
  }
}

// --- 圖表渲染 ---
const renderAllCharts = () => {
  // 清除舊實例
  chartInstances.forEach(c => c.dispose())
  chartInstances = []

  if (filteredLogs.value.length === 0) return

  renderLineChart()
  renderPieChart()
  renderBarChart()
}

const renderLineChart = () => {
  const chart = echarts.init(lineChartRef.value)
  const dateMap = {}
  filteredLogs.value.forEach(l => {
    const d = new Date(l.redeemTime).toLocaleDateString()
    dateMap[d] = (dateMap[d] || 0) + 1
  })
  const sortedDates = Object.keys(dateMap).sort((a, b) => new Date(a) - new Date(b))
  
  chart.setOption({
    tooltip: { trigger: 'axis', backgroundColor: 'rgba(255, 255, 255, 0.9)' },
    grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
    xAxis: { type: 'category', boundaryGap: false, data: sortedDates },
    yAxis: { type: 'value', minInterval: 1 },
    series: [{
      name: '兌換次數',
      type: 'line',
      smooth: true,
      data: sortedDates.map(d => dateMap[d]),
      areaStyle: {
        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
          { offset: 0, color: 'rgba(64, 158, 255, 0.5)' },
          { offset: 1, color: 'rgba(64, 158, 255, 0)' }
        ])
      },
      lineStyle: { width: 3, color: '#409eff' },
      itemStyle: { color: '#409eff' }
    }]
  })
  chartInstances.push(chart)
}

const renderPieChart = () => {
  const chart = echarts.init(pieChartRef.value)
  const nameMap = {}
  filteredLogs.value.forEach(l => {
    const name = l.couponName || '未命名'
    nameMap[name] = (nameMap[name] || 0) + 1
  })

  let pieData = Object.entries(nameMap)
    .map(([name, value]) => ({ name, value }))
    .sort((a, b) => b.value - a.value)

  chart.setOption({
    tooltip: { trigger: 'item', formatter: '{b}: {c}次 ({d}%)' },
    legend: { type: 'scroll', orient: 'vertical', right: 5, top: 20, bottom: 20 },
    series: [{
      type: 'pie',
      radius: ['40%', '70%'],
      center: ['40%', '50%'],
      avoidLabelOverlap: true,
      itemStyle: { borderRadius: 8, borderColor: '#fff', borderWidth: 2 },
      label: { show: false },
      data: pieData
    }]
  })
  chartInstances.push(chart)
}

const renderBarChart = () => {
  const chart = echarts.init(barChartRef.value)
  const rankMap = {}
  filteredLogs.value.forEach(l => {
    rankMap[l.couponName] = (rankMap[l.couponName] || 0) + 1
  })

  const sorted = Object.entries(rankMap)
    .map(([name, value]) => ({ name, value }))
    .sort((a, b) => a.value - b.value)
    .slice(-10)

  chart.setOption({
    tooltip: { trigger: 'axis' },
    grid: { left: '3%', right: '8%', bottom: '3%', top: '2%', containLabel: true },
    xAxis: { type: 'value', minInterval: 1 },
    yAxis: { type: 'category', data: sorted.map(d => d.name) },
    series: [{
      name: '兌換總量',
      type: 'bar',
      data: sorted.map(d => d.value),
      itemStyle: {
        color: new echarts.graphic.LinearGradient(1, 0, 0, 0, [
          { offset: 0, color: '#f6d365' }, { offset: 1, color: '#fda085' }
        ]),
        borderRadius: [0, 5, 5, 0]
      },
      label: { show: true, position: 'right' }
    }]
  })
  chartInstances.push(chart)
}

// --- 監聽與生命週期 ---
watch(filteredLogs, () => {
  renderAllCharts()
}, { deep: true })

const handleResize = () => chartInstances.forEach(c => c.resize())
const resetFilter = () => { dateRange.value = [] }

// --- Excel 匯出 ---
const exportToExcel = () => {
  const summary = {}
  filteredLogs.value.forEach(log => {
    if (!summary[log.couponName]) {
      summary[log.couponName] = { "ID": log.couponId, "名稱": log.couponName, "次數": 0, "點數": 0 }
    }
    summary[log.couponName]["次數"] += 1
    summary[log.couponName]["點數"] += log.pointsSpent
  })

  const ws = XLSX.utils.json_to_sheet(Object.values(summary))
  const wb = XLSX.utils.book_new()
  XLSX.utils.book_append_sheet(wb, ws, "統計結果")
  XLSX.writeFile(wb, `分析報告_${dateRange.value[0] || '全部'}.xlsx`)
}

onMounted(() => {
  fetchLogs()
  window.addEventListener('resize', handleResize)
})

onUnmounted(() => {
  window.removeEventListener('resize', handleResize)
  chartInstances.forEach(c => c.dispose())
})
</script>

<style scoped>
.log-list-container { padding: 20px; background-color: #f5f7fa; min-height: 100vh; }

/* 標題與篩選 */
.page-title-box { display: flex; align-items: center; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.05); }
.title-icon { font-size: 2rem; color: #409eff; margin-right: 15px; }
.subtitle { margin: 0; color: #909399; }
.filter-card { border-radius: 12px; border: none; }
.filter-label { font-weight: bold; color: #606266; }

/* 統計卡片 */
.stat-card { display: flex; align-items: center; padding: 20px; border-radius: 12px; color: white; margin-bottom: 20px; }
.total-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
.points-card { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
.avg-card { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
.merchant-card { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
.stat-icon { font-size: 2.5rem; opacity: 0.2; margin-right: 15px; }
.stat-info h3 { margin: 0; font-size: 1.8rem; }

/* 圖表 */
.chart-card { border-radius: 12px; border: none; }
.chart-header { font-weight: bold; display: flex; align-items: center; }
</style>
</file>

<file path="frontend/src/views/spot/DispatchMonitor.vue">
<template>
  <div class="dispatch-monitor container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="fw-bold text-dark">
        <i class="fas fa-chart-line me-2"></i>站點調度監控中心
      </h2>
      <div class="controls d-flex gap-3 align-items-center">
        <span class="text-muted small">
          最後更新: {{ lastUpdateTime }}
        </span>
        <button 
          class="btn btn-primary" 
          @click="fetchData" 
          :disabled="loading"
        >
          <i class="fas fa-sync-alt" :class="{ 'fa-spin': loading }"></i> 
          {{ loading ? '更新中...' : '立即更新' }}
        </button>
      </div>
    </div>

    <!-- 警示摘要卡片 -->
    <div class="row mb-4">
      <div class="col-md-4">
        <div class="card bg-danger text-white shadow-sm h-100">
          <div class="card-body d-flex justify-content-between align-items-center">
            <div>
              <h6 class="card-title mb-0">急需補給 (可租用率過低)</h6>
              <h2 class="display-6 fw-bold my-2">{{ lowStockSpots.length }}</h2>
              <small>可租用率 &lt; 20%</small>
            </div>
            <i class="fas fa-battery-empty fa-3x opacity-50"></i>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card bg-warning text-dark shadow-sm h-100">
          <div class="card-body d-flex justify-content-between align-items-center">
            <div>
              <h6 class="card-title mb-0">建議清運 (可租用率過高)</h6>
              <h2 class="display-6 fw-bold my-2">{{ overStockSpots.length }}</h2>
              <small>可租用率 &gt; 80%</small>
            </div>
            <i class="fas fa-battery-full fa-3x opacity-50"></i>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card bg-success text-white shadow-sm h-100">
          <div class="card-body d-flex justify-content-between align-items-center">
            <div>
              <h6 class="card-title mb-0">營運正常</h6>
              <h2 class="display-6 fw-bold my-2">{{ normalSpots.length }}</h2>
              <small>可租用率健康</small>
            </div>
            <i class="fas fa-check-circle fa-3x opacity-50"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- 監控列表 -->
    <div class="card shadow">
      <div class="card-header bg-white py-3">
        <h5 class="mb-0">即時站點狀態列表</h5>
      </div>
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>ID</th>
              <th>租借據點名稱</th>
              <th>各據點容量上限</th>
              <th>可借數</th>
              <th>可租用率</th>
              <th>調度建議</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="spot in allSpots" :key="spot.spotId" :class="getRowClass(spot)">
              <td>{{ spot.spotId }}</td>
              <td class="fw-bold">{{ spot.spotName }}</td>
              <td>{{ spot.totalSeats }}</td>
              <td>{{ spot.availableSeats }}</td>
              <td style="width: 200px;">
                <div class="progress" style="height: 20px;">
                  <div 
                    class="progress-bar" 
                    role="progressbar" 
                    :style="{ width: getRentableRate(spot) + '%', backgroundColor: getProgressColor(spot) }"
                    :aria-valuenow="getRentableRate(spot)" 
                    aria-valuemin="0" 
                    aria-valuemax="100"
                  >
                    {{ getRentableRate(spot) }}%
                  </div>
                </div>
              </td>
              <td>
                <span class="badge rounded-pill" :class="getStatusBadge(spot).class">
                  {{ getStatusBadge(spot).text }}
                </span>
              </td>
              <td>
                <button class="btn btn-sm btn-outline-primary" @click="notifyDispatch(spot)">
                  <i class="fas fa-paper-plane"></i> 發送調度單
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue';
import axios from 'axios';
import Swal from 'sweetalert2';

defineOptions({ name: 'DispatchMonitor' });

const allSpots = ref([]);
const loading = ref(false);
const lastUpdateTime = ref('-');

const API_URL = '/api/analyze/spot-monitor';

const getRentableRate = (spot) => {
  const total = Number(spot.totalSeats) || 0;
  const available = Number(spot.availableSeats) || 0;
  if (total <= 0) return 0;

  const rate = Math.round((available / total) * 100);
  return Math.min(100, Math.max(0, rate));
};


const getStatusType = (spot) => {
  const rate = getRentableRate(spot);
  if (rate < 20) return 'NEED_SUPPLY';
  if (rate > 80) return 'NEED_CLEAR';
  return 'NORMAL';
};

const lowStockSpots = computed(() => allSpots.value.filter(s => getStatusType(s) === 'NEED_SUPPLY'));
const overStockSpots = computed(() => allSpots.value.filter(s => getStatusType(s) === 'NEED_CLEAR'));
const normalSpots = computed(() => allSpots.value.filter(s => getStatusType(s) === 'NORMAL'));

const getRowClass = (spot) => {
  const type = getStatusType(spot);
  if (type === 'NEED_SUPPLY') return 'table-danger';
  if (type === 'NEED_CLEAR') return 'table-warning';
  return '';
};

const getProgressColor = (spot) => {
  const type = getStatusType(spot);
  if (type === 'NEED_SUPPLY') return '#dc3545'; // Red
  if (type === 'NEED_CLEAR') return '#ffc107'; // Yellow
  return '#198754'; // Green
};

const getStatusBadge = (spot) => {
  const type = getStatusType(spot);
  if (type === 'NEED_SUPPLY')  return { class: 'bg-danger', text: '急需補給' };
  if (type === 'NEED_CLEAR') return { class: 'bg-warning text-dark', text: '建議清運' };
  return { class: 'bg-success', text: '正常' };
};

const fetchData = async () => {
  loading.value = true;
  try {
    const res = await axios.get(API_URL);
    allSpots.value = res.data;
    lastUpdateTime.value = new Date().toLocaleTimeString();
  } catch (err) {
    console.error('監控數據載入失敗', err);
    Swal.fire({
      icon: 'error',
      title: '載入失敗',
      text: '無法獲取站點監控數據，請稍後再試。'
    });
  } finally {
    loading.value = false;
  }
};

const notifyDispatch = (spot) => {
  const type = getStatusType(spot);
  let msg = '';
  if (type === 'NEED_SUPPLY') msg = `請派員前往 [${spot.spotName}] 補充設備！`;
  else if (type === 'NEED_CLEAR') msg = `請派員前往 [${spot.spotName}] 回收設備！`;
  else msg = `[${spot.spotName}] 目前狀態正常，確定要派單？`;

  Swal.fire({
    title: '發送調度通知?',
    text: msg,
    icon: 'question',
    showCancelButton: true,
    confirmButtonText: '發送',
    cancelButtonText: '取消'
  }).then((result) => {
    if (result.isConfirmed) {
      Swal.fire('已發送', '管理員已收到通知', 'success');
    }
  });
};

onMounted(() => {
  fetchData();
});
</script>

<style scoped>
.dispatch-monitor {
  background-color: #f8f9fa;
  min-height: 100vh;
}
.card {
  border: none;
  border-radius: 10px;
}
.table-danger {
  background-color: #ffebe9 !important;
}
.table-warning {
  background-color: #fff8e1 !important;
}
</style>
</file>

<file path="frontend/src/views/spot/SpotAnalyze.vue">
<template>
  <div class="spot-analyze-container">
    <el-card class="mb-4">
      <template #header>
        <div class="flex justify-between items-center">
          <h2 class="text-xl font-bold m-0 flex items-center gap-2">
            <i class="fas fa-chart-line text-blue-500"></i>
            據點營運統計儀表板
          </h2>
          <div class="flex items-center gap-2" style="display: flex; gap: 10px; align-items: center;">
            <el-date-picker
              v-model="dateRange"
              type="daterange"
              range-separator="至"
              start-placeholder="開始日期"
              end-placeholder="結束日期"
              value-format="YYYY-MM-DD"
              :shortcuts="shortcuts"
              @change="fetchData"
            />
            <el-button type="primary" :loading="loading" @click="fetchData">
              <i class="fas fa-sync-alt mr-1"></i> 重新載入
            </el-button>
          </div>
        </div>
      </template>

      <!-- 恢復為純圖表模式 (移除方案 A 的 Tabs) -->
      <div v-loading="loading">
        <el-row :gutter="20" class="mb-4">
          <el-col :md="10" :sm="24" class="mb-4">
            <el-card shadow="hover" class="chart-card">
              <template #header><b>各縣市站點分佈</b></template>
              <div v-if="hasData" ref="cityChartRef" class="chart-container"></div>
              <el-empty v-else description="暫無數據" />
            </el-card>
          </el-col>
          <el-col :md="14" :sm="24" class="mb-4">
            <el-card shadow="hover" class="chart-card">
              <template #header><b>24小時租借熱度</b></template>
              <div v-if="hasData" ref="heatChartRef" class="chart-container"></div>
              <el-empty v-else description="暫無數據" />
            </el-card>
          </el-col>
        </el-row>

        <el-row :gutter="20">
          <el-col :md="10" :sm="24" class="mb-4">
            <el-card shadow="hover" class="chart-card">
              <template #header><b>租借時長分佈</b></template>
              <div v-if="hasData" ref="durationChartRef" class="chart-container"></div>
              <el-empty v-else description="暫無數據" />
            </el-card>
          </el-col>
          <el-col :md="14" :sm="24" class="mb-4">
            <el-card shadow="hover" class="chart-card">
              <template #header><b>站點即時分佈概覽</b></template>
              <el-table :data="statsData.spotMonitor" style="width: 100%" height="280">
                <el-table-column prop="spotName" label="據點" />
                <el-table-column prop="totalSeats" label="總位" width="80" align="center" />
                <el-table-column prop="availableSeats" label="可借" width="80" align="center" />
                <el-table-column label="可借率" width="120">
                  <template #default="scope">
                    <el-progress :percentage="Math.round((scope.row.availableSeats/scope.row.totalSeats)*100)" />
                  </template>
                </el-table-column>
              </el-table>
            </el-card>
          </el-col>
        </el-row>
      </div>
    </el-card>
  </div>
</template>

<script setup>
import { ref, onMounted, onBeforeUnmount, nextTick } from 'vue'
import axios from 'axios'
import ApexCharts from 'apexcharts'
import Swal from 'sweetalert2'

const loading = ref(false)
const hasData = ref(false)
const statsData = ref({ cityDistribution: [], spotMonitor: [], hourlyHeatMap: [], durationStats: [] })
const dateRange = ref([])

const shortcuts = [
  { text: '最近一週', value: () => { const end = new Date(); const start = new Date(); start.setTime(start.getTime() - 3600 * 1000 * 24 * 7); return [start, end] } },
  { text: '最近一個月', value: () => { const end = new Date(); const start = new Date(); start.setTime(start.getTime() - 3600 * 1000 * 24 * 30); return [start, end] } },
  { text: '最近三個月', value: () => { const end = new Date(); const start = new Date(); start.setTime(start.getTime() - 3600 * 1000 * 24 * 90); return [start, end] } },
]

const cityChartRef = ref(null); const heatChartRef = ref(null); const durationChartRef = ref(null)
let cityChart = null; let heatChart = null; let durationChart = null

const fetchData = async () => {
  loading.value = true
  try {
    const params = {}
    if (dateRange.value && dateRange.value.length === 2) {
      params.startDate = dateRange.value[0]
      params.endDate = dateRange.value[1]
    }
    const res = await axios.get('/api/analyze/stats', { params })
    if (res.data) { statsData.value = res.data; hasData.value = true; nextTick(() => renderCharts()) }
  } catch (err) { console.error(err) } finally { loading.value = false }
}

const renderCharts = () => {
  if (cityChartRef.value) {
    if (cityChart) cityChart.destroy()
    cityChart = new ApexCharts(cityChartRef.value, {
      series: statsData.value.cityDistribution.map(i => i.spotCount),
      labels: statsData.value.cityDistribution.map(i => i.city),
      chart: { type: 'donut', height: 280 }
    })
    cityChart.render()
  }
  if (heatChartRef.value) {
    if (heatChart) heatChart.destroy()
    heatChart = new ApexCharts(heatChartRef.value, {
      series: [{ name: '租借', data: Array.from({length:24}, (_,i) => statsData.value.hourlyHeatMap.find(d => d.hourofDay === i)?.rentedCount || 0) }],
      chart: { type: 'area', height: 280 },
      xaxis: { categories: Array.from({length:24}, (_,i) => `${i}:00`) }
    })
    heatChart.render()
  }
  if (durationChartRef.value) {
    if (durationChart) durationChart.destroy()
    durationChart = new ApexCharts(durationChartRef.value, {
      series: [{ name: '筆數', data: statsData.value.durationStats.map(i => i.count) }],
      chart: { type: 'bar', height: 280 },
      xaxis: { categories: statsData.value.durationStats.map(i => i.durationRange) }
    })
    durationChart.render()
  }
}

onMounted(() => fetchData())
onBeforeUnmount(() => { if(cityChart) cityChart.destroy(); if(heatChart) heatChart.destroy(); if(durationChart) durationChart.destroy() })
</script>

<style scoped>
.chart-card { border-radius: 12px; height: 100%; }
.chart-container { min-height: 280px; }
.mb-4 { margin-bottom: 20px; }
</style>
</file>

<file path="frontend/src/views/support/ReportDamageView.vue">
<script setup>
import { ref, reactive, computed, onMounted } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { ElMessage } from 'element-plus'
import Swal from 'sweetalert2'
import maintenanceApi from '@/api/modules/maintenance'

const route = useRoute()
const router = useRouter()

// ============ 表單狀態 ============
const formRef = ref(null)
const uploadRef = ref(null)
const submitting = ref(false)
const loading = ref(false)

// 維修目標類型
const targetType = ref('spot') // 'spot' | 'seat'

// 表單資料
const form = reactive({
  spotId: null,
  seatsId: null,
  issueType: '',
  issueDesc: '',
  issuePriority: 'NORMAL',
})

// 問題類型選項（不含「保養」）
const issueTypeOptions = [
  { value: '機台故障異常', icon: '🖥️' },
  { value: '椅子損壞', icon: '🪑' },
  { value: '清潔問題', icon: '🧹' },
  { value: '網路異常', icon: '📡' },
  { value: '其他問題', icon: '❓' },
]

// 優先級配置
const priorityConfig = {
  LOW: { color: '#909399', icon: '🔵', text: '低', desc: '可稍後處理' },
  NORMAL: { color: '#409eff', icon: '🟢', text: '普通', desc: '一般問題' },
  HIGH: { color: '#e6a23c', icon: '🟠', text: '高', desc: '需盡快處理' },
  URGENT: { color: '#f56c6c', icon: '🔴', text: '緊急', desc: '立即處理' },
}

// 選項資料
const spotOptions = ref([])
const seatOptions = ref([])

// 圖片上傳
const fileList = ref([])
const MAX_FILE_SIZE = 5 * 1024 * 1024 // 5MB
const MAX_FILE_COUNT = 5
const ALLOWED_IMAGE_TYPES = ['image/jpeg', 'image/png', 'image/webp']

// ============ 驗證規則 ============
const rules = {
  issueType: [{ required: true, message: '請選擇或輸入問題類型', trigger: 'blur' }],
  issueDesc: [],
}

// ============ Computed ============
/**
 * 根據目標類型動態顯示可選擇的機台或椅子
 */
const currentTargetOptions = computed(() => {
  return targetType.value === 'spot' ? spotOptions.value : seatOptions.value
})

/**
 * 表單驗證狀態
 */
const isFormValid = computed(() => {
  const hasTarget = targetType.value === 'spot' ? !!form.spotId : !!form.seatsId
  const hasType = !!form.issueType
  const hasImages = fileList.value.length > 0
  return hasTarget && hasType && hasImages
})

// ============ 生命週期 ============
onMounted(async () => {
  loading.value = true
  try {
    // 載入機台與椅子選項
    const [spotRes, seatRes] = await Promise.all([
      maintenanceApi.getAllSpots().catch(() => ({ data: [] })),
      maintenanceApi.getAllSeats().catch(() => ({ data: [] })),
    ])

    spotOptions.value = Array.isArray(spotRes.data) ? spotRes.data : []
    seatOptions.value = Array.isArray(seatRes.data) ? seatRes.data : []

    // 從 query 預填資料
    const { spotId, seatId, recId } = route.query

    if (spotId) {
      targetType.value = 'spot'
      form.spotId = Number(spotId)
    } else if (seatId) {
      targetType.value = 'seat'
      form.seatsId = Number(seatId)
    }

    // 若有 recId，可在描述中提及（可選）
    if (recId) {
      form.issueDesc = `訂單編號：${recId}\n`
    }
  } catch (error) {
    console.error('載入資料失敗:', error)
    ElMessage.error('載入資料失敗，請重新整理頁面')
  } finally {
    loading.value = false
  }
})

// ============ 方法 ============
/**
 * 檔案上傳前檢查
 */
const beforeUpload = (file) => {
  // 檢查檔案類型
  if (!ALLOWED_IMAGE_TYPES.includes(file.type)) {
    ElMessage.error(`不支援的檔案格式：${file.name}（僅允許 JPG, PNG, WEBP）`)
    return false
  }

  // 檢查檔案大小
  if (file.size > MAX_FILE_SIZE) {
    ElMessage.error(`${file.name} 超過 5MB 限制`)
    return false
  }

  // 檢查數量
  if (fileList.value.length >= MAX_FILE_COUNT) {
    ElMessage.error(`最多只能上傳 ${MAX_FILE_COUNT} 張圖片`)
    return false
  }

  return true
}

/**
 * 檔案變更處理
 */
const handleFileChange = (file) => {
  if (beforeUpload(file.raw)) {
    fileList.value.push(file)
  }
}

/**
 * 移除檔案
 */
const handleRemoveFile = (file) => {
  const index = fileList.value.findIndex((f) => f.uid === file.uid)
  if (index > -1) {
    fileList.value.splice(index, 1)
  }
}

/**
 * 選擇問題類型
 */
const selectIssueType = (type) => {
  form.issueType = type.value
}

/**
 * 送出表單
 */
const submit = async () => {
  // 1. 驗證表單
  await formRef.value.validate()

  // 2. 檢查是否有圖片
  if (fileList.value.length === 0) {
    ElMessage.warning('請至少上傳一張圖片')
    return
  }

  // 3. 確認彈窗
  const confirmResult = await Swal.fire({
    title: '確認送出問題回報？',
    html: `
      <div style="text-align: left; padding: 10px;">
        <p><b>回報目標：</b>${targetType.value === 'spot' ? '機台' : '椅子'} #${targetType.value === 'spot' ? form.spotId : form.seatsId}</p>
        <p><b>問題類型：</b>${form.issueType}</p>
        <p><b>優先級：</b>${priorityConfig[form.issuePriority].text}</p>
        <p><b>圖片數量：</b>${fileList.value.length} 張</p>
      </div>
    `,
    icon: 'question',
    showCancelButton: true,
    confirmButtonColor: '#409eff',
    cancelButtonColor: '#909399',
    confirmButtonText: '<i class="fas fa-paper-plane mr-1"></i> 確認送出',
    cancelButtonText: '再檢查一下',
  })

  if (!confirmResult.isConfirmed) return

  submitting.value = true
  try {
    // ============ 【關鍵】Step 1：建立工單（加上問題回報標記）============
    const ticketPayload = {
      spotId: targetType.value === 'spot' ? form.spotId : null,
      seatsId: targetType.value === 'seat' ? form.seatsId : null,
      issueType: `SUPPORT_${form.issueType}`, // ✅ 標記為問題回報
      issueDesc: `[REPORT] ${form.issueDesc}`, // ✅ 描述前加標記
      issuePriority: form.issuePriority,
      assignedStaffId: null, // 前台回報不指派人員
    }

    console.log('📤 建立工單:', ticketPayload)
    const createRes = await maintenanceApi.createTicket(ticketPayload)
    const ticketId = createRes.data?.ticketId

    if (!ticketId) {
      throw new Error('未取得工單 ID')
    }

    // ============ Step 2：上傳圖片 ============
    let attachmentSuccess = false
    try {
      const files = fileList.value.map((f) => f.raw)
      await maintenanceApi.uploadTicketAttachments(ticketId, files, '使用者回報')
      attachmentSuccess = true
    } catch (attachError) {
      console.error('圖片上傳失敗:', attachError)
      // ✅ 不拋出錯誤，工單已建立成功
    }

    // ============ Step 3：成功提示 ============
    if (attachmentSuccess) {
      await Swal.fire({
        icon: 'success',
        title: '回報成功！',
        html: `
          <div style="text-align: center;">
            <p>您的問題回報已送出</p>
            <p style="color: #67c23a; font-weight: 600; font-size: 18px;">工單編號：#${ticketId}</p>
            <p style="color: #909399; font-size: 13px;">我們會盡快為您處理</p>
          </div>
        `,
        confirmButtonText: '返回地圖',
        confirmButtonColor: '#409eff',
      })
      router.push('/SearchSpot')
    } else {
      // ✅ 工單建立成功但圖片上傳失敗
      await Swal.fire({
        icon: 'warning',
        title: '工單已建立',
        html: `
          <div style="text-align: center;">
            <p style="color: #e6a23c;">工單編號：<b>#${ticketId}</b></p>
            <p style="color: #f56c6c; font-size: 14px;">但圖片上傳失敗</p>
            <p style="color: #909399; font-size: 13px;">您可稍後在工單詳情中補上傳</p>
          </div>
        `,
        confirmButtonText: '我知道了',
        confirmButtonColor: '#e6a23c',
      })
      router.push('/SearchSpot')
    }
  } catch (error) {
    console.error('送出失敗:', error)
    const errorMsg = error?.response?.data?.message || '系統忙碌中，請稍後再試'
    Swal.fire('送出失敗', errorMsg, 'error')
  } finally {
    submitting.value = false
  }
}

/**
 * 返回上一頁
 */
const handleCancel = () => {
  router.push('/support/report')
}
</script>

<template>
  <div class="support-report-container">
    <!-- 頁面標題 -->
    <section class="page-header">
      <div class="container-fluid">
        <div class="header-content">
          <div class="header-icon">
            <i class="fas fa-exclamation-circle"></i>
          </div>
          <div class="header-text">
            <h1>機台/椅子毀損問題</h1>
            <p>請詳細描述您遇到的問題，我們會盡快為您處理</p>
          </div>
        </div>
      </div>
    </section>

    <!-- 表單主體 -->
    <section class="content">
      <div class="container-fluid">
        <el-card shadow="hover" class="form-card" v-loading="loading">
          <template #header>
            <div class="card-header">
              <span class="header-icon">
                <i class="fas fa-clipboard-list"></i>
              </span>
              <span class="header-text">回報表單</span>
            </div>
          </template>

          <el-form
            ref="formRef"
            :model="form"
            :rules="rules"
            label-position="top"
            class="report-form"
          >
            <!-- 回報目標類型 -->
            <el-form-item label="回報目標" required>
              <div class="target-type-switch">
                <div
                  class="target-type-option"
                  :class="{ active: targetType === 'spot' }"
                  @click="targetType = 'spot'"
                >
                  <i class="fas fa-desktop"></i>
                  <span>機台</span>
                </div>
                <div
                  class="target-type-option"
                  :class="{ active: targetType === 'seat' }"
                  @click="targetType = 'seat'"
                >
                  <i class="fas fa-chair"></i>
                  <span>椅子</span>
                </div>
              </div>
            </el-form-item>

            <!-- 選擇機台 / 椅子 -->
            <el-form-item :label="targetType === 'spot' ? '選擇機台' : '選擇椅子'" required>
              <el-select
                v-if="targetType === 'spot'"
                v-model="form.spotId"
                placeholder="請選擇機台"
                filterable
                size="large"
                class="w-100"
              >
                <el-option
                  v-for="spot in spotOptions"
                  :key="spot.spotId"
                  :label="`${spot.spotName || spot.spotId} (${spot.spotStatus})`"
                  :value="spot.spotId"
                  :disabled="spot.spotStatus === '停用'"
                >
                  <div class="option-item">
                    <i class="fas fa-desktop"></i>
                    <span>{{ spot.spotName || `機台 #${spot.spotId}` }}</span>
                    <el-tag
                      :type="spot.spotStatus === '營運中' ? 'success' : 'danger'"
                      size="small"
                    >
                      {{ spot.spotStatus }}
                    </el-tag>
                  </div>
                </el-option>
              </el-select>

              <el-select
                v-else
                v-model="form.seatsId"
                placeholder="請選擇椅子"
                filterable
                size="large"
                class="w-100"
              >
                <el-option
                  v-for="seat in seatOptions"
                  :key="seat.seatsId"
                  :label="`${seat.seatsName || seat.seatsId} (${seat.seatsStatus})`"
                  :value="seat.seatsId"
                  :disabled="seat.seatsStatus === '停用'"
                >
                  <div class="option-item">
                    <i class="fas fa-chair"></i>
                    <span>{{ seat.seatsName || `椅子 #${seat.seatsId}` }}</span>
                    <el-tag
                      :type="seat.seatsStatus === '可用' ? 'success' : 'warning'"
                      size="small"
                    >
                      {{ seat.seatsStatus }}
                    </el-tag>
                  </div>
                </el-option>
              </el-select>
            </el-form-item>

            <!-- 問題類型 -->
            <el-form-item label="問題類型" prop="issueType" required>
              <div class="issue-type-grid">
                <div
                  v-for="type in issueTypeOptions"
                  :key="type.value"
                  class="issue-type-card"
                  :class="{ active: form.issueType === type.value }"
                  @click="selectIssueType(type)"
                >
                  <span class="type-icon">{{ type.icon }}</span>
                  <span class="type-text">{{ type.value }}</span>
                </div>
              </div>
              <el-input
                v-model="form.issueType"
                placeholder="或自行輸入問題類型..."
                size="large"
                clearable
                class="mt-2"
              />
            </el-form-item>

            <!-- 問題描述 -->
            <el-form-item label="問題描述" prop="issueDesc">
              <el-input
                v-model="form.issueDesc"
                type="textarea"
                :rows="6"
                placeholder="請詳細描述問題狀況，例如：故障位置、發生時間、嚴重程度等... "
                show-word-limit
                maxlength="1000"
              />
            </el-form-item>

            <!-- 優先級 -->
            <el-form-item label="優先級">
              <div class="priority-cards">
                <div
                  v-for="(config, key) in priorityConfig"
                  :key="key"
                  class="priority-card"
                  :class="{ active: form.issuePriority === key }"
                  :style="{ '--card-color': config.color }"
                  @click="form.issuePriority = key"
                >
                  <span class="priority-icon">{{ config.icon }}</span>
                  <span class="priority-text">{{ config.text }}</span>
                  <span class="priority-desc">{{ config.desc }}</span>
                </div>
              </div>
            </el-form-item>

            <!-- 圖片上傳 -->
            <el-form-item label="問題照片" required>
              <el-alert type="warning" :closable="false" show-icon class="mb-3">
                <template #title>
                  <span style="font-size: 13px">
                    <i class="fas fa-camera"></i> 必須上傳圖片（最多 5 張，單張最大 5MB，支援
                    JPG/PNG/WEBP）
                  </span>
                </template>
              </el-alert>

              <el-upload
                ref="uploadRef"
                :auto-upload="false"
                :on-change="handleFileChange"
                :on-remove="handleRemoveFile"
                :file-list="fileList"
                accept="image/jpeg,image/png,image/webp"
                list-type="picture-card"
                :limit="MAX_FILE_COUNT"
              >
                <template #default>
                  <div class="upload-trigger">
                    <i class="fas fa-plus"></i>
                    <div class="upload-text">選擇圖片</div>
                  </div>
                </template>
                <template #tip>
                  <div class="el-upload__tip">
                    <i class="fas fa-info-circle"></i>
                    送出後將自動上傳圖片
                  </div>
                </template>
              </el-upload>
            </el-form-item>

            <!-- 按鈕區 -->
            <el-form-item class="form-actions">
              <div class="button-group">
                <el-button
                  type="primary"
                  size="large"
                  @click="submit"
                  :loading="submitting"
                  :disabled="!isFormValid"
                >
                  <i class="fas fa-paper-plane mr-2" v-if="!submitting"></i>
                  {{ submitting ? '送出中...' : '送出回報' }}
                </el-button>
                <el-button size="large" @click="handleCancel">
                  <i class="fas fa-arrow-left mr-2"></i> 返回上一頁
                </el-button>
              </div>
            </el-form-item>
          </el-form>
        </el-card>

        <!-- 提示卡片 -->
        <div class="tips-card">
          <div class="tip-item">
            <i class="fas fa-lightbulb"></i>
            <span>詳細的描述與清晰的照片能幫助我們更快解決問題</span>
          </div>
          <div class="tip-item">
            <i class="fas fa-shield-alt"></i>
            <span>您的個人資料將受到保護，僅用於問題處理</span>
          </div>
        </div>
      </div>
    </section>
  </div>
</template>

<style scoped>
/* ========== 頁面容器 ========== */
.support-report-container {
  min-height: 100vh;
  background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
  padding-bottom: 40px;
}

/* ========== 頁面標題 ========== */
.page-header {
  background: linear-gradient(135deg, #d4e3ee 0%, #c8d9e6 100%);
  padding: 40px 20px;
  color: white;
}

.header-content {
  max-width: 900px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  gap: 20px;
}

.header-icon {
  width: 64px;
  height: 64px;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 32px;
}

.header-text h1 {
  margin: 0 0 5px;
  font-size: 1.8rem;
  font-weight: 800;
  color: #2c3e50;
  text-shadow:
    0 2px 8px rgba(0, 0, 0, 0.15),
    0 1px 3px rgba(255, 255, 255, 0.5);
}

.header-text p {
  margin: 0;
  font-size: 0.95rem;
  font-weight: 600;
  color: #34495e;
  text-shadow:
    0 1px 4px rgba(0, 0, 0, 0.1),
    0 1px 2px rgba(255, 255, 255, 0.3);
}

/* ========== 內容區域 ========== */
.content {
  padding: 30px 20px;
}

.form-card {
  max-width: 900px;
  margin: 0 auto 30px;
  border-radius: 16px;
  overflow: hidden;
}

.card-header {
  display: flex;
  align-items: center;
  gap: 10px;
}

.card-header .header-icon {
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, #d4e3ee 0%, #c8d9e6 100%);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 18px;
}

.card-header .header-text {
  font-weight: 600;
  font-size: 1.1rem;
  color: #303133;
}

/* ========== 表單樣式 ========== */
.report-form {
  padding: 20px 0;
}

/* 回報目標類型切換 */
.target-type-switch {
  display: flex;
  gap: 16px;
  width: 100%;
}

.target-type-option {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 10px;
  padding: 24px;
  background: #f5f7fa;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  border: 2px solid transparent;
}

.target-type-option:hover {
  background: #ecf5ff;
  transform: translateY(-2px);
}

.target-type-option.active {
  background: linear-gradient(135deg, #d4e3ee 0%, #c8d9e6 100%);
  color: #2c3e50;
  border-color: #409eff;
  transform: scale(1.05);
}

.target-type-option i {
  font-size: 32px;
}

.target-type-option span {
  font-weight: 600;
  font-size: 16px;
}

/* 選項項目 */
.option-item {
  display: flex;
  align-items: center;
  gap: 10px;
  width: 100%;
}

.option-item i {
  color: #409eff;
}

/* 問題類型卡片 */
.issue-type-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 12px;
  margin-bottom: 10px;
}

.issue-type-card {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  padding: 16px;
  background: #f5f7fa;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.3s ease;
  border: 2px solid transparent;
}

.issue-type-card:hover {
  background: #ecf5ff;
  transform: translateY(-2px);
}

.issue-type-card.active {
  border-color: #409eff;
  background: #ecf5ff;
}

.type-icon {
  font-size: 28px;
}

.type-text {
  font-size: 13px;
  color: #606266;
  font-weight: 500;
  text-align: center;
}

/* 優先級卡片 */
.priority-cards {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
}

.priority-card {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  padding: 16px 12px;
  background: #f5f7fa;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.3s ease;
  border: 2px solid transparent;
}

.priority-card:hover {
  background: #ecf5ff;
  transform: translateY(-2px);
}

.priority-card.active {
  border-color: var(--card-color);
  background: white;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.priority-icon {
  font-size: 24px;
}

.priority-text {
  font-size: 14px;
  color: var(--card-color);
  font-weight: 600;
}

.priority-desc {
  font-size: 11px;
  color: #909399;
  text-align: center;
}

/* 圖片上傳 */
.upload-trigger {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 8px;
  color: #8c939d;
}

.upload-trigger i {
  font-size: 28px;
}

.upload-text {
  font-size: 12px;
}

:deep(.el-upload__tip) {
  color: #909399;
  font-size: 12px;
}

/* 按鈕區 */
.form-actions {
  margin-top: 30px;
}

.button-group {
  display: flex;
  gap: 12px;
  justify-content: center;
}

/* 提示卡片 */
.tips-card {
  max-width: 900px;
  margin: 0 auto;
  padding: 20px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
}

.tip-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 0;
  color: #606266;
  font-size: 14px;
}

.tip-item i {
  color: #409eff;
  font-size: 18px;
}

/* ========== 響應式設計 ========== */
@media (max-width: 768px) {
  .priority-cards {
    grid-template-columns: repeat(2, 1fr);
  }

  .issue-type-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

/* ========== 輔助類 ========== */
.w-100 {
  width: 100%;
}
.mt-2 {
  margin-top: 8px;
}
.mb-3 {
  margin-bottom: 12px;
}
.mr-1 {
  margin-right: 4px;
}
.mr-2 {
  margin-right: 8px;
}
</style>
</file>

<file path="frontend/vite.config.js">
import { fileURLToPath, URL } from 'node:url'
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import vueDevTools from 'vite-plugin-vue-devtools'

export default defineConfig({
  plugins: [
    vue({
      template: {
        compilerOptions: {
          //所有以 gmpx- 開頭的標籤都是 Web Components
          isCustomElement: (tag) => tag.startsWith('gmpx-'),
        },
      },
    }),
    vueDevTools(),
  ],
  resolve: {
    alias: {
      '@': fileURLToPath(new URL('./src', import.meta.url)),
    },
  },
  // ==================== 2026-02-01: 已改用 Coze OpenAPI，不再需要 WebSDK ====================
  // 保留 exclude/external 以防任何殘留 import 造成編譯錯誤
  optimizeDeps: {
    exclude: ['@coze/chat-sdk'],
  },
  build: {
    rollupOptions: {
      external: ['@coze/chat-sdk'],
    },
  },
  // ==================== 結束 ====================
  server: {
    //允許cloudflare和localhost進入
    host: true,
    allowedHosts: ['.trycloudflare.com', 'localhost'],
    proxy: {
      // ⚠️ 重點修正 1：針對「據點 (Spot)」的特殊處理
      // 前端呼叫 /api/spot -> Vite 幫忙去掉 /api -> 後端收到 /spot
      '/api/spot': {
        target: 'http://localhost:8080',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, ''),
      },

      // ⚠️ 重點修正 2：針對「座位 (Seat)」的特殊處理
      // 前端呼叫 /api/seat -> Vite 幫忙去掉 /api -> 後端收到 /seat
      '/api/seat': {
        target: 'http://localhost:8080',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, ''),
      },

      // 3. 維修模組 (保留 /api)
      // 因為你的 MaintenanceController 是真的有寫 @RequestMapping("/api/maintenance")
      // 所以這個規則要放在後面，讓上面兩個特定規則先被抓到
      '/api': {
        target: 'http://localhost:8080',
        changeOrigin: true,
      },

      // 4. 圖片資源
      '/images': {
        target: 'http://localhost:8080',
        changeOrigin: true,
      },

      // 5. 座位與據點的備用規則 (預防他們前端改用 /seat 開頭)
      '/seat': { target: 'http://localhost:8080', changeOrigin: true },
      '/spot': { target: 'http://localhost:8080', changeOrigin: true },
    },
  },
})
</file>

<file path="frontend/package.json">
{
  "name": "frontend",
  "version": "0.0.0",
  "private": true,
  "type": "module",
  "engines": {
    "node": "^20.19.0 || >=22.12.0"
  },
  "scripts": {
    "dev": "vite",
    "build": "run-p type-check \"build-only {@}\" --",
    "preview": "vite preview",
    "build-only": "vite build",
    "type-check": "vue-tsc --build",
    "lint": "eslint . --fix --cache",
    "format": "prettier --write --experimental-cli src/",
    "test": "vitest"
  },
  "dependencies": {
    "@coze/chat-sdk": "^0.1.11-beta.19",
    "@element-plus/icons-vue": "^2.3.2",
    "@fawmi/vue-google-maps": "^0.9.79",
    "@googlemaps/extended-component-library": "^0.6.14",
    "@tsparticles/slim": "^3.9.1",
    "@tsparticles/vue3": "^3.0.1",
    "apexcharts": "^5.3.6",
    "axios": "^1.13.2",
    "chart.js": "^4.5.1",
    "echarts": "^6.0.0",
    "element-plus": "^2.13.1",
    "flatpickr": "^4.6.13",
    "fullcalendar": "^6.1.20",
    "html5-qrcode": "^2.3.8",
    "pinia": "^3.0.4",
    "sweetalert2": "^11.26.17",
    "vue": "^3.5.25",
    "vue-chartjs": "^5.3.3",
    "vue-router": "^4.6.3",
    "vue3-apexcharts": "^1.10.0",
    "xlsx": "^0.18.5"
  },
  "devDependencies": {
    "@tsconfig/node24": "^24.0.3",
    "@types/node": "^24.10.1",
    "@vitejs/plugin-vue": "^6.0.2",
    "@vue/eslint-config-prettier": "^10.2.0",
    "@vue/eslint-config-typescript": "^14.6.0",
    "@vue/test-utils": "^2.4.6",
    "@vue/tsconfig": "^0.8.1",
    "eslint": "^9.39.1",
    "eslint-plugin-vue": "~10.5.1",
    "jiti": "^2.6.1",
    "jsdom": "^24.1.0",
    "npm-run-all2": "^8.0.4",
    "prettier": "3.6.2",
    "sass-embedded": "^1.97.3",
    "typescript": "~5.9.0",
    "vite": "^7.2.4",
    "vite-plugin-vue-devtools": "^8.0.5",
    "vitest": "^4.0.16",
    "vue-tsc": "^3.1.5"
  }
}
</file>

<file path="frontend/src/composables/spot/useGoogleMaps.js">
import { ref } from 'vue'
import Swal from 'sweetalert2'

/**
 * [核心] Google Maps 相關邏輯的組合式函數 (Composable)
 * @param {Ref} formData - 表單資料的 ref 物件
 * @param {Object} manualOverride - 手動覆蓋座標的 reactive 狀態
 */
export function useGoogleMaps(formData, manualOverride) {
  // ========== 狀態定義 ==========
  const geoLoading = ref(false)
  const geoError = ref('')
  const geoPrecision = ref('') // 儲存 Google 回傳的精確度類型
  
  // Template Refs (需在元件 setup 中 return 給 template 綁定)
  const gmapAutoRef = ref(null)
  const addrElInputRef = ref(null)

  // ========== 輔助函式 ==========
  
  // 精確度顯示文字轉換
  const formatPrecision = (type) => {
    const map = { 
      'ROOFTOP': '精確 (Rooftop)', 
      'RANGE_INTERPOLATED': '街道插值 (Interpolated)', 
      'GEOMETRIC_CENTER': '區域中心 (Center)', 
      'APPROXIMATE': '粗略 (Approximate)', 
      'PLACES_API': 'Google 地點 (Place)', 
      'MANUAL': '手動修正 (Manual)' 
    }
    return map[type] || type
  }

  const getPrecisionTagType = (type) => {
    return (type === 'ROOFTOP' || type === 'PLACES_API' || type === 'MANUAL') ? 'success' : (type === 'RANGE_INTERPOLATED' ? 'warning' : 'info')
  }

  /**
  清理 Google 回傳的地址格式
   */
  const formatGoogleAddress = (rawAddress) => {
    if (!rawAddress) return ''
    // Regex: 移除開頭的 "數字+空白(可選)" 以及 "台灣"
    return rawAddress.replace(/^(\d+\s?)?(台灣)?/, '').trim()
  }

  /**
   * [關鍵] 將 formData 中的 spotAddress「強制同步」回 ElementPlus 的原生 input 元素。
   * 這是為了解決 Google Maps Autocomplete 腳本會覆蓋 Vue 響應式更新的問題。
   * 透過多次延遲執行，確保在 Google 初始化完成後，我們的值能成功寫入。
   * @returns {void}
   */
  const syncAddressToNativeInput = () => {
    const updateValue = () => {
      const comp = addrElInputRef.value
      let nativeInput = null

      // 1. 嘗試從 Element Plus 元件實例獲取 input
      if (comp) {
        // Element Plus 暴露的 input 屬性 (HTMLInputElement)
        if (comp.input && comp.input instanceof HTMLInputElement) {
          nativeInput = comp.input
        } 
        // 或者透過 DOM 查找
        else if (comp.$el) {
          nativeInput = comp.$el.querySelector('input')
        }
      }

      // 2. 最後手段：透過 placeholder 查找
      if (!nativeInput) {
        nativeInput = document.querySelector('input[placeholder="請輸入完整地址（可用建議清單）"]')
      }

      if (nativeInput) {
        const newValue = formData.value.spotAddress || ''
        // 只有當值不一致時才寫入
        if (nativeInput.value !== newValue) {
          nativeInput.value = newValue
          // 重要：觸發 input 事件，確保 Vue v-model 也能收到通知
          nativeInput.dispatchEvent(new Event('input', { bubbles: true }))
        }
      }
    }
    
    // 增加多次嘗試，確保在 Google Maps 初始化或 DOM 更新後能正確寫入
    setTimeout(updateValue, 100)
    setTimeout(updateValue, 300)
    setTimeout(updateValue, 800)
  }

  // ========== 核心邏輯 ==========
  /**
   * [初始化] 將 Google Places Autocomplete 功能綁定到地址輸入框上。
   * 這個函式必須在元件掛載 (mounted) 後呼叫，確保能抓取到 DOM 元素。
   * @returns {Promise<void>}
   */
const initPlacesAutocomplete = async () => {
  // 注意：要在元件 mounted 後、DOM 出來後才抓得到 input
  const comp = addrElInputRef.value
  const nativeInput =
    comp?.input instanceof HTMLInputElement
      ? comp.input
      : comp?.$el?.querySelector?.('input')

  if (!nativeInput) return

  // [新增] 等待機制：如果 Google Maps API 還沒載入，就稍微等一下 (最多等 3 秒)
  if (!window.google?.maps?.places?.Autocomplete) {
    await new Promise((resolve) => {
      const checkInterval = setInterval(() => {
        if (window.google?.maps?.places?.Autocomplete) {
          clearInterval(checkInterval)
          resolve()
        }
      }, 100) // 每 0.1 秒檢查一次
      setTimeout(() => { clearInterval(checkInterval); resolve() }, 3000) // 3秒後超時放棄
    })
  }

  if (!window.google?.maps?.places?.Autocomplete) {
    geoError.value = 'Google Places 載入失敗或逾時（請確認網路狀況或 API Key 設定）'
    return
  }

  const ac = new window.google.maps.places.Autocomplete(nativeInput, {
    fields: ['name', 'geometry', 'formatted_address', 'place_id'],
    componentRestrictions: { country: 'tw' }
  })

  ac.addListener('place_changed', () => {
    const place = ac.getPlace()
    onPlaceChangedForForm(place)
  })
}



  /**
   * [途徑 A-1] 當使用者從 Google Autocomplete 下拉選單中選取一個地點時觸發。
   * @param {google.maps.places.PlaceResult} placeFromEvent - Google API 回傳的地點物件。
   */
  const onPlaceChangedForForm = (placeFromEvent) => {
    const place = placeFromEvent || gmapAutoRef.value?.getPlace?.()
    if (!place?.geometry?.location) return

    // 如果 Google Place 有名稱，且我們的「據點名稱」欄位是空的，就自動帶入
    // 這是為了提升使用者體驗，選了「台北101」，名稱欄位就自動填上。
    if (place.name && !formData.value.spotName) {
      formData.value.spotName = place.name
    }

    if (place.formatted_address) {
      formData.value.spotAddress = formatGoogleAddress(place.formatted_address)
      syncAddressToNativeInput()
    }

    const loc = place.geometry.location
    formData.value.latitude = Number(loc.lat())
    formData.value.longitude = Number(loc.lng())

    // 標記精確度，並重置手動鎖定
    geoPrecision.value = 'PLACES_API'
    manualOverride.lat = false
    manualOverride.lng = false
    geoError.value = ''
  }

  /**
   * [途徑 A-2] 將文字地址透過 Geocoder API 轉換為經緯度。
   * @param {Object} options - 選項物件
   * @param {boolean} options.force - 是否強制執行，無視 `manualOverride` 鎖定。
   */
  const geocodeAddress = ({ force } = { force: false }) => {
    const address = (formData.value.spotAddress || '').trim()
    if (!address) return

    // [關鍵] 如果使用者手動修改過座標 (manualOverride 為 true)，
    // 且不是強制執行 (force 為 false)，則直接返回，以保護使用者的手動輸入。
    if (!force && (manualOverride.lat || manualOverride.lng)) return

    if (!window.google?.maps?.Geocoder) {
      geoError.value = 'Google Maps 尚未載入（請確認已載入 places library）'
      return
    }

    geoLoading.value = true
    geoError.value = ''

    const geocoder = new window.google.maps.Geocoder()
    geocoder.geocode({ address }, (results, status) => {
      geoLoading.value = false

      if (status === 'OK' && results?.[0]) {
        const location = results[0].geometry.location
        const lat = Number(location.lat())
        const lng = Number(location.lng())

        geoPrecision.value = results[0].geometry.location_type
        if (force || !manualOverride.lat) formData.value.latitude = lat
        if (force || !manualOverride.lng) formData.value.longitude = lng
        return
      }

      geoError.value = `找不到座標，請輸入更完整地址（狀態：${status}）`
    })
  }

  /**
   * [途徑 B] 依據「據點名稱」搜尋經緯度與地址。
   * 當使用者點擊名稱欄位旁的搜尋按鈕時觸發。
   */
  const geocodeByName = () => {
    const name = (formData.value.spotName || '').trim()
    if (!name) {
      Swal.fire({ icon: 'warning', title: '請先輸入據點名稱', timer: 1500, showConfirmButton: false })
      return
    }
    
    geoLoading.value = true
    geoError.value = ''
    
    const geocoder = new window.google.maps.Geocoder()
    geocoder.geocode({ address: name, componentRestrictions: { country: 'TW' } }, (results, status) => {
      geoLoading.value = false
      if (status === 'OK' && results?.[0]) {
        const location = results[0].geometry.location
        formData.value.latitude = Number(location.lat())
        formData.value.longitude = Number(location.lng())
        formData.value.spotAddress = formatGoogleAddress(results[0].formatted_address)
        syncAddressToNativeInput()
        
        geoPrecision.value = results[0].geometry.location_type
        manualOverride.lat = false
        manualOverride.lng = false
      } else {
        geoError.value = `找不到該名稱的位置（狀態：${status}）`
      }
    })
  }

  /**
   * [途徑 C] 當使用者在地圖上拖曳標記 (Marker) 後觸發。
   * 這是最高優先權的操作，會直接更新座標並啟用「手動鎖定」。
   * @param {google.maps.MapMouseEvent} event - 拖曳事件物件，包含新的經緯度。
   */
  const onMarkerDragEnd = (event) => {
    const lat = event.latLng.lat()
    const lng = event.latLng.lng()
    formData.value.latitude = Number(lat.toFixed(6))
    formData.value.longitude = Number(lng.toFixed(6))
    manualOverride.lat = true
    manualOverride.lng = true
    geoPrecision.value = 'MANUAL'
  }

  // 將狀態和方法導出，供 Vue 元件使用
  return {
    // State
    geoLoading,
    geoError,
    geoPrecision,
    gmapAutoRef,
    addrElInputRef,
    
    // Methods
     initPlacesAutocomplete,
    syncAddressToNativeInput,
    onPlaceChangedForForm,
    geocodeAddress,
    geocodeByName,
    onMarkerDragEnd,
    formatPrecision,
    getPrecisionTagType
  }
}
</file>

<file path="frontend/src/data/supportFaq.js">
/**
 * 客服支援 FAQ 資料來源
 * 結構：[{ category, items: [{ q, a, tags, keywords }] }]
 */
export const faqData = [
  {
    category: '租借相關',
    icon: 'fas fa-map-marker-alt',
    color: '#409eff',
    items: [
      {
        q: '如何租借座位？',
        a: `
          <ol style="line-height: 1.8; padding-left: 20px;">
            <li>前往「尋找租借點」頁面，選擇您想要的地點</li>
            <li>點擊地圖上的據點標記，查看可用座位數量</li>
            <li>點擊「租借」按鈕，選擇座位並確認</li>
            <li>完成付款後即可開始使用</li>
          </ol>
          <p style="color: #909399; font-size: 13px; margin-top: 10px;">
            <i class="fas fa-lightbulb"></i> 提示：建議先登入會員，可累積點數享有優惠！
          </p>
        `,
        tags: ['租借', '座位', '新手'],
        keywords: ['怎麼租', '如何使用', '租借流程'],
      },
      {
        q: '租借費率如何計算？',
        a: `
          <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #409eff;">
            <p style="margin: 0 0 10px; font-weight: 600;">基本費率</p>
            <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
              <li>基本費：20 NTD（起租費）</li>
              <li>時段費：30 NTD / 每 30 分鐘</li>
              <li>會員點數折抵：100 點 = 1 NTD</li>
            </ul>
          </div>
          <p style="color: #67c23a; font-size: 13px; margin-top: 10px;">
            <i class="fas fa-gift"></i> 首次租借享 9 折優惠！
          </p>
        `,
        tags: ['費率', '計費', '價格'],
        keywords: ['多少錢', '費用', '收費', '計算'],
      },
      {
        q: '可以提前結束租借嗎？',
        a: `
          <p>可以的！您可以在租借期間隨時歸還座位，系統會依實際使用時間計費。</p>
          <div style="margin-top: 10px; padding: 10px; background: #fef0f0; border-radius: 6px;">
            <p style="margin: 0; color: #f56c6c; font-size: 13px;">
              <i class="fas fa-exclamation-triangle"></i> 注意：基本費 20 NTD 不退還
            </p>
          </div>
        `,
        tags: ['歸還', '提前結束'],
        keywords: ['提前還', '中途離開', '退費'],
      },
      {
        q: '找不到可用座位怎麼辦？',
        a: `
          <p>若目前據點無可用座位，您可以：</p>
          <ul style="line-height: 1.8; padding-left: 20px;">
            <li>點擊「附近據點」查看其他地點</li>
            <li>聯繫客服詢問座位釋出時間</li>
          </ul>
        `,
        tags: ['座位', '滿位'],
        keywords: ['沒有座位', '滿了', '額滿'],
      },
    ],
  },
  {
    category: '維修保養',
    icon: 'fas fa-tools',
    color: '#e6a23c',
    items: [
      {
        q: '遇到設備故障該如何回報？',
        a: `
          <p>請立即透過以下方式回報：</p>
          <ol style="line-height: 1.8; padding-left: 20px;">
            <li>點擊頁面底部「<b>我要回報問題</b>」按鈕</li>
            <li>選擇故障的機台或椅子</li>
            <li>填寫問題描述並上傳照片（必須）</li>
            <li>送出後會立即通知維修人員處理</li>
          </ol>
          <p style="color: #f56c6c; font-size: 13px; margin-top: 10px;">
            <i class="fas fa-exclamation-circle"></i> 緊急故障請直接聯繫現場人員！
          </p>
        `,
        tags: ['故障', '回報', '維修'],
        keywords: ['壞了', '不能用', '故障', '報修'],
      },
      {
        q: '設備維修需要多久時間？',
        a: `
          <div style="background: #fff7e6; padding: 15px; border-radius: 8px;">
            <p style="margin: 0 0 10px; font-weight: 600;">一般維修時程</p>
            <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
              <li><b style="color: #f56c6c;">緊急故障</b>：2 小時內到場</li>
              <li><b style="color: #e6a23c;">一般維修</b>：24 小時內處理</li>
              <li><b style="color: #67c23a;">定期保養</b>：每月排程執行</li>
            </ul>
          </div>
          <p style="color: #909399; font-size: 13px; margin-top: 10px;">
            您可以在「維修工單管理」查看處理進度
          </p>
        `,
        tags: ['維修', '時間', '進度'],
        keywords: ['多久', '要多少時間', '修理'],
      },
      {
        q: '維修期間可以使用其他座位嗎？',
        a: `
          <p>當然可以！系統會自動標示維修中的座位為「不可租借」，您可以：</p>
          <ul style="line-height: 1.8; padding-left: 20px;">
            <li>選擇同據點的其他可用座位</li>
            <li>切換到附近的其他據點</li>
            <li>享有維修補償點數（依情況而定）</li>
          </ul>
        `,
        tags: ['維修', '座位', '替代'],
        keywords: ['換座位', '其他位置'],
      },
    ],
  },
  {
    category: '付款相關',
    icon: 'fas fa-credit-card',
    color: '#67c23a',
    items: [
      {
        q: '支援哪些付款方式？',
        a: `
          <div style="background: #f0f9ff; padding: 15px; border-radius: 8px;">
            <p style="margin: 0 0 10px; font-weight: 600;">支援付款方式</p>
            <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
              <li><i class="fas fa-credit-card" style="color: #409eff;"></i> 信用卡 / 金融卡</li>
              <li><i class="fas fa-mobile-alt" style="color: #67c23a;"></i> LINE Pay / Apple Pay</li>
              <li><i class="fas fa-university" style="color: #e6a23c;"></i> ATM 轉帳</li>
              <li><i class="fas fa-store" style="color: #f56c6c;"></i> 超商代碼繳費</li>
            </ul>
          </div>
          <p style="color: #909399; font-size: 13px; margin-top: 10px;">
            所有付款均透過 ECPay 綠界金流，安全有保障
          </p>
        `,
        tags: ['付款', '支付', '方式'],
        keywords: ['怎麼付', '信用卡', '行動支付', 'LINE Pay'],
      },
      {
        q: '付款失敗怎麼辦？',
        a: `
          <p>若遇到付款失敗，請依以下步驟處理：</p>
          <ol style="line-height: 1.8; padding-left: 20px;">
            <li>確認信用卡額度是否充足</li>
            <li>檢查網路連線是否穩定</li>
            <li>嘗試更換付款方式</li>
            <li>仍無法解決請聯繫客服（附上訂單編號）</li>
          </ol>
          <div style="margin-top: 10px; padding: 10px; background: #fef0f0; border-radius: 6px;">
            <p style="margin: 0; color: #f56c6c; font-size: 13px;">
              <i class="fas fa-info-circle"></i> 付款失敗不會扣款，請放心重試
            </p>
          </div>
        `,
        tags: ['付款', '失敗', '錯誤'],
        keywords: ['付不了', '扣款失敗', '無法付款'],
      },
      {
        q: '如何申請退款？',
        a: `
          <p>退款申請條件：</p>
          <ul style="line-height: 1.8; padding-left: 20px;">
            <li>設備故障導致無法使用</li>
            <li>系統錯誤重複扣款</li>
            <li>其他非使用者因素</li>
          </ul>
          <p style="margin-top: 10px;">申請方式：</p>
          <ol style="line-height: 1.8; padding-left: 20px;">
            <li>前往「訂單管理」找到該筆訂單</li>
            <li>點擊「申請退款」並填寫原因</li>
            <li>客服審核通過後 3-7 工作天退款</li>
          </ol>
        `,
        tags: ['退款', '退費'],
        keywords: ['退錢', '申請退款', '取消訂單'],
      },
    ],
  },
  {
    category: '帳號與其他',
    icon: 'fas fa-user-circle',
    color: '#909399',
    items: [
      {
        q: '如何修改個人資料？',
        a: `
          <ol style="line-height: 1.8; padding-left: 20px;">
            <li>點擊右上角「會員中心」</li>
            <li>選擇「個人資料」</li>
            <li>修改完成後點擊「儲存」</li>
          </ol>
          <p style="color: #909399; font-size: 13px; margin-top: 10px;">
            <i class="fas fa-shield-alt"></i> 修改手機號碼需要簡訊驗證
          </p>
        `,
        tags: ['帳號', '個人資料'],
        keywords: ['修改資料', '更改', '編輯'],
      },
      {
        q: '忘記密碼怎麼辦？',
        a: `
          <ol style="line-height: 1.8; padding-left: 20px;">
            <li>點擊登入頁面的「忘記密碼」</li>
            <li>輸入註冊時的 Email</li>
            <li>前往信箱點擊重設密碼連結</li>
            <li>設定新密碼並重新登入</li>
          </ol>
          <div style="margin-top: 10px; padding: 10px; background: #fef0f0; border-radius: 6px;">
            <p style="margin: 0; color: #f56c6c; font-size: 13px;">
              <i class="fas fa-exclamation-triangle"></i> 重設連結 30 分鐘內有效
            </p>
          </div>
        `,
        tags: ['密碼', '登入'],
        keywords: ['忘記密碼', '重設', '登不進去'],
      },
      {
        q: '點數如何累積與使用？',
        a: `
          <div style="background: #f0f9ff; padding: 15px; border-radius: 8px;">
            <p style="margin: 0 0 10px; font-weight: 600;">點數累積方式</p>
            <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
              <li>每消費 1 NTD = 1 點</li>
              <li>首次租借贈送 500 點</li>
              <li>推薦好友註冊贈送 200 點</li>
              <li>每月生日贈送 100 點</li>
            </ul>
          </div>
          <div style="margin-top: 10px; background: #f0f9eb; padding: 15px; border-radius: 8px;">
            <p style="margin: 0 0 10px; font-weight: 600;">點數使用方式</p>
            <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
              <li>100 點 = 1 NTD 折抵</li>
              <li>兌換商家優惠券</li>
              <li>參加會員專屬活動</li>
            </ul>
          </div>
        `,
        tags: ['點數', '會員', '優惠'],
        keywords: ['積分', '紅利', '折扣'],
      },
      {
        q: '如何聯繫客服？',
        a: `
          <p>我們提供多種聯繫方式：</p>
          <ul style="line-height: 1.8; padding-left: 20px;">
            <li><i class="fas fa-headset" style="color: #409eff;"></i> 客服專線：0968-179-091（24 小時）</li>
            <li><i class="fas fa-envelope" style="color: #67c23a;"></i> Email：support@seatrentsys.com</li>
            <li><i class="fas fa-comment-dots" style="color: #e6a23c;"></i> LINE 官方帳號：@seatrent</li>
            <li><i class="fas fa-exclamation-circle" style="color: #f56c6c;"></i> 緊急回報：點擊下方「我要回報問題」</li>
          </ul>
          <p style="color: #909399; font-size: 13px; margin-top: 10px;">
            平均回覆時間：1 小時內（尖峰時段可能較長）
          </p>
        `,
        tags: ['客服', '聯繫', '幫助'],
        keywords: ['客服', '聯絡', '電話', '信箱'],
      },
    ],
  },
]
</file>

<file path="frontend/src/views/ecpay/SponsorView.vue">
<template>
  <div class="payment-container">
    <div v-if="isSuccess" class="payment-card success-card animated fadeIn">
      <div class="hero-header">
        <el-icon class="success-icon" style="font-size: 60px; color: #2a9d8f;"><SuccessFilled /></el-icon>
        <h2 style="color: #2a9d8f;">贊助成功！</h2>
        <p>您的支持是我們前進的最大動力。</p>
      </div>
      <button @click="router.push('/')" class="checkout-btn">回到首頁</button>
    </div>

    <div v-else class="payment-card sponsor-card">
      <div class="hero-header">
        <el-icon class="star-icon"><StarFilled /></el-icon>
        <h2>支持我們的願景</h2>
        <p>您的支持是我們進步的最大動力</p>
      </div>
      <hr />
      <div class="amount-selector">
        <p class="section-title">選擇贊助金額：</p>
        <div class="price-tags">
          <button v-for="p in [100, 500, 1000]" :key="p" :class="{ active: amount === p }" @click="amount = p">
            ${{ p }}
          </button>
        </div>
        <div class="points-hint" style="margin: 10px 0; color: #e67e22; font-weight: bold;">
          <i class="bi bi-gift-fill"></i>
          感謝支持！本次贊助您將獲得 
          <span style="font-size: 1.2rem;">{{ amount }}</span> 
          點數回饋
        </div>
        <el-input-number v-model="amount" :min="10" :step="50" class="custom-input" />
      </div>
      <div class="payment-methods">
        <p class="section-title">支付平台：</p>
        <label class="method-option">
          <input type="radio" checked /> 
          <span class="radio-label">綠界科技 ECPay 安全支付</span>
        </label>
      </div>
      <div class="comment-area" style="margin-top: 20px;">
  <p class="section-title">給我們的鼓勵 (留言)：</p>
  <el-input
    v-model="comment"
    type="textarea"
    :rows="3"
    placeholder="寫下您想說的話..."
    maxlength="500"
    show-word-limit
    class="custom-textarea"
  />
</div>
<hr>
      <button @click="handleSponsorSubmit" :disabled="isLoading" class="checkout-btn sponsor-btn">
        <span v-if="isLoading" class="loader"></span>
        {{ isLoading ? '準備導向支付頁面...' : '立即贊助' }}
      </button>
      <p class="note">※ 點擊後將跳轉至綠界金流頁面，過程受加密保護</p>
    </div>
  </div>
</template>
<script setup>
import { ref, computed, onMounted, onUnmounted } from 'vue';
import axios from 'axios';
import { StarFilled, SuccessFilled } from '@element-plus/icons-vue';
import { useRouter } from 'vue-router';
// 💡 導入你的會員 Store
import { useMemberAuthStore } from '@/stores/memberAuth'; 

const isLoading = ref(false);
const isSuccess = ref(false);
const amount = ref(100);
const comment = ref(""); // 💡 留言板變數
const router = useRouter();
const memberAuthStore = useMemberAuthStore();

// 💡 統一使用 Store 的資料 (與蛇蛇遊戲一致)
const memberId = computed(() => memberAuthStore.member?.memId);

const messageHandler = (event) => {
  if (event.data === 'PAYMENT_SUCCESS') {
    isSuccess.value = true;
    isLoading.value = false;
    // 成功後順便刷新一下全站點數 (如果有需要的話)
    if (typeof memberAuthStore.refreshPoints === 'function') {
        memberAuthStore.refreshPoints();
    }
  }
};

onMounted(() => {
  window.addEventListener('message', messageHandler);
});

onUnmounted(() => {
  window.removeEventListener('message', messageHandler);
});

const handleSponsorSubmit = async () => {
  // 1. 檢查登入狀態
  if (!memberId.value) {
    alert("請先登入後再進行贊助，讓我們能記錄您的貢獻！");
    router.push({ path: '/login', query: { redirect: '/sponsor' } });
    return;
  }

  isLoading.value = true;
  const windowName = "ecpayPaymentWindow";
  const paymentWindow = window.open("", windowName);
  
  if (!paymentWindow) {
    alert("彈出視窗被瀏覽器封鎖，請允許本站開啟彈出視窗。");
    isLoading.value = false;
    return;
  }

  paymentWindow.document.write("<html><body style='display:flex;justify-content:center;align-items:center;height:100vh;font-family:sans-serif;'><div><h2>正在導向綠界支付...</h2></div></body></html>");

  try {
    const apiUrl = window.APP_CONFIG?.API_URL || 'http://localhost:8080';
    const frontendUrl = window.location.origin;

    // 💡 修正：將參數完整傳遞給整合後的後端
    const response = await axios.post(`${apiUrl}/api/payment/sponsor`, null, {
      params: { 
        memberId: memberId.value, // 從 computed 拿值
        amount: amount.value,
        comment: comment.value,   // 傳送留言板內容
        baseUrl: frontendUrl 
      }
    });

    const tempDiv = document.createElement('div');
    tempDiv.style.display = 'none';
    tempDiv.innerHTML = response.data;
    document.body.appendChild(tempDiv);

    const form = tempDiv.querySelector('form');
    if (form) {
      form.target = windowName; 
      form.submit();
      setTimeout(() => {
        if (document.body.contains(tempDiv)) document.body.removeChild(tempDiv);
      }, 500);
    }
  } catch (error) {
    console.error("導向失敗", error);
    if (paymentWindow) paymentWindow.close();
    alert("系統忙碌中，請稍後再試。");
    isLoading.value = false;
  }
};
</script>

<style scoped>
.payment-container {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 85vh;
  background-color: #f0f2f5;
}

.payment-card {
  background: white;
  padding: 2.5rem;
  border-radius: 16px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.08);
  width: 100%;
  max-width: 420px;
}

.hero-header { text-align: center; margin-bottom: 1.5rem; }
.star-icon { font-size: 40px; color: #f4a261; margin-bottom: 10px; }
.section-title { font-weight: bold; margin-bottom: 10px; color: #333; }

.price-tags { display: flex; gap: 10px; margin-bottom: 15px; }
.price-tags button {
  flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px;
  background: white; cursor: pointer; transition: all 0.3s; font-weight: bold;
}
.price-tags button.active {
  background: #2a9d8f; color: white; border-color: #2a9d8f;
}

.custom-input { width: 100%; margin-top: 10px; }

.payment-methods { margin: 1.5rem 0; }
.method-option {
  display: flex; align-items: center; gap: 10px; padding: 12px;
  border: 1px solid #e0e0e0; border-radius: 8px; background: #fafafa;
}

.checkout-btn {
  width: 100%; padding: 1.2rem; background-color: #2a9d8f; color: white;
  border: none; border-radius: 8px; font-size: 1.2rem; font-weight: 600;
  cursor: pointer; transition: all 0.3s; display: flex;
  justify-content: center; align-items: center; gap: 10px;
}

.sponsor-btn { background-color: #e76f51; }
.sponsor-btn:hover { background-color: #d65d41; transform: translateY(-2px); }

.loader {
  border: 3px solid #f3f3f3; border-top: 3px solid #ffffff;
  border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite;
}

.section-title {
  font-weight: bold;
  margin-bottom: 8px;
  color: #333;
  display: block;
  text-align: left;
}

.custom-textarea :deep(.el-textarea__inner) {
  border-radius: 8px;
  border: 1px solid #ddd;
  transition: border-color 0.3s;
}

.custom-textarea :deep(.el-textarea__inner:focus) {
  border-color: #2a9d8f;
}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.note { font-size: 0.8rem; color: #888; text-align: center; margin-top: 1.2rem; }
</style>
</file>

<file path="frontend/src/views/maintenance/MtifList.vue">
<script setup>
import { ref, onMounted, computed, reactive, watch } from 'vue'
import maintenanceApi from '@/api/modules/maintenance'
import Swal from 'sweetalert2'
import { useTicketConfig } from '@/composables/maintenance/useTicketConfig'
import { usePagination } from '@/composables/maintenance/usePagination'
import TicketCharts from '@/components/maintenance/TicketCharts.vue'
import TicketTimeline from '@/components/maintenance/TicketTimeline.vue'

// --- Props & Refs ---
const props = defineProps({ historyMode: Boolean })
const tickets = ref([])
const filters = reactive({ keyword: '', priority: '', status: '' })
const loading = ref(false)
const pageVisible = ref(false)
const allSpots = ref([])

// ====== 【新增】問題回報模式 ======
const viewMode = ref('all') // 'all' | 'support'

// 問題回報標記規則（可擴展）
const SUPPORT_TAG_PREFIX = 'SUPPORT_'
const SUPPORT_TAG_DESC = '[REPORT]'

/**
 * 【新增】判斷是否為問題回報工單
 * 規則：issueType 以 SUPPORT_ 開頭 或 issueDesc 包含 [REPORT]
 */
const isSupportTicket = (ticket) => {
  if (!ticket) return false
  const typeMatch = ticket.issueType?.startsWith(SUPPORT_TAG_PREFIX)
  const descMatch = ticket.issueDesc?.includes(SUPPORT_TAG_DESC)
  return typeMatch || descMatch
}

/**
 * 【新增】問題回報未處理數量（用於 Tab Badge）
 */
const supportPendingCount = computed(() => {
  return tickets.value.filter(t => 
    isSupportTicket(t) && t.issueStatus === 'REPORTED'
  ).length
})

// ====== 資產健康度統計 ======
const assetStatsTab = ref('SPOT')
const assetStats = ref([])
const assetStatsLoading = ref(false)

// 取得資產健康度統計
const fetchAssetStats = async () => {
  try {
    assetStatsLoading.value = true
    const res = await maintenanceApi.getAssetStats(assetStatsTab.value)
    assetStats.value = res.data || []
  } catch (err) {
    console.error('取得資產統計失敗:', err)
    assetStats.value = []
    Swal.fire({
      icon: 'error',
      title: '載入失敗',
      text: '無法取得資產健康度統計',
      timer: 2000,
      showConfirmButton: false,
    })
  } finally {
    assetStatsLoading.value = false
  }
}

// 監聽 tab 切換
watch(assetStatsTab, () => {
  fetchAssetStats()
})

// spotId -> spotName 對照表（讓椅子工單可顯示「機台真名」）
const spotNameMap = computed(() => {
  const map = new Map()
  for (const s of allSpots.value || []) {
    map.set(Number(s.spotId), s.spotName)
  }
  return map
})

// 取得顯示用的機台名稱：優先 row.rentalSpot，其次 allSpots，再 fallback 到「機台 #id」
const getSpotDisplayName = (spotId, rentalSpot) => {
  if (rentalSpot?.spotName) return rentalSpot.spotName
  const name = spotNameMap.value.get(Number(spotId))
  return name || `機台 #${spotId}`
}

// 格式化百分比
const formatPercent = (value) => {
  if (value == null || isNaN(value)) return '0.0%'
  return (value * 100).toFixed(1) + '%'
}

// 格式化故障率
const formatRate = (value) => {
  if (value == null || isNaN(value)) return '0.00'
  return value.toFixed(2)
}

// 取得妥善率狀態顏色
const getAvailabilityStatus = (value) => {
  if (value >= 0.95) return 'success'
  if (value >= 0.8) return 'warning'
  return 'exception'
}

// 控制 LOG 彈窗的變數
const logDialogVisible = ref(false)
const currentLogTicketId = ref(0)

const openLogDialog = (id) => {
  currentLogTicketId.value = id
  logDialogVisible.value = true
}

// 判斷工單是否可編輯
const EDITABLE_STATUSES = ['REPORTED', 'ASSIGNED']
const canEdit = (row) => EDITABLE_STATUSES.includes(row.issueStatus)

// 提示不可編輯原因
const getEditTooltip = (row) => {
  if (canEdit(row)) {
    return '編輯工單'
  }
  const statusName = getStatusText(row.issueStatus)
  return `狀態為「${statusName}」不可編輯（僅 REPORTED/ASSIGNED 可編輯）`
}

// 控制結案彈窗
const showResolveDialog = ref(false)
const resolveForm = reactive({ ticketId: 0, resultType: 'FIXED', resolveNote: '' })

// 使用共用 composables
const {
  priorityConfig,
  statusConfig,
  resultConfig,
  getPriorityTag,
  getStatusTag,
  getPriorityText,
  getStatusText,
  getPriorityIcon,
  getStatusIcon,
  getResultText,
  getResultIcon,
} = useTicketConfig()

// 向後相容：保留原有變數名稱 (供模板使用)
const priorityText = Object.fromEntries(Object.entries(priorityConfig).map(([k, v]) => [k, v.text]))
const priorityIcon = Object.fromEntries(Object.entries(priorityConfig).map(([k, v]) => [k, v.icon]))
const statusText = Object.fromEntries(Object.entries(statusConfig).map(([k, v]) => [k, v.text]))
const statusIcon = Object.fromEntries(Object.entries(statusConfig).map(([k, v]) => [k, v.icon]))

// --- API 資料讀取 ---
const fetchTickets = async () => {
  try {
    loading.value = true
    const res = props.historyMode
      ? await maintenanceApi.getHistoryTickets()
      : await maintenanceApi.getActiveTickets()
    tickets.value = res.data
  } catch {
    // 錯誤已由 http.js 攔截器處理
  } finally {
    loading.value = false
  }
}

// 統計卡片數據
const statsCards = computed(() => {
  const total = tickets.value.length
  const urgent = tickets.value.filter((t) => t.issuePriority === 'URGENT').length
  const inProgress = tickets.value.filter((t) => t.issueStatus === 'UNDER_MAINTENANCE').length
  const resolved = tickets.value.filter((t) => t.issueStatus === 'RESOLVED').length
  return { total, urgent, inProgress, resolved }
})

// 監聽篩選條件變更，重置分頁
watch(
  filters,
  () => {
    resetPagination()
  },
  { deep: true },
)

// ★ [Fix Issue 1] 根據模式動態產生狀態選項
// 如果是 historyMode，只顯示 已結案/已取消
// 如果是 activeMode，只顯示 已通報/已指派/維修中
const availableStatusOptions = computed(() => {
  const allStatuses = statusText
  const filtered = {}

  if (props.historyMode) {
    // 歷史模式：只顯示 RESOLVED, CANCELLED
    if (allStatuses['RESOLVED']) filtered['RESOLVED'] = allStatuses['RESOLVED']
    if (allStatuses['CANCELLED']) filtered['CANCELLED'] = allStatuses['CANCELLED']
  } else {
    // 現有模式：顯示 REPORTED, ASSIGNED, UNDER_MAINTENANCE
    if (allStatuses['REPORTED']) filtered['REPORTED'] = allStatuses['REPORTED']
    if (allStatuses['ASSIGNED']) filtered['ASSIGNED'] = allStatuses['ASSIGNED']
    if (allStatuses['UNDER_MAINTENANCE'])
      filtered['UNDER_MAINTENANCE'] = allStatuses['UNDER_MAINTENANCE']
  }
  return filtered
})

// --- 業務邏輯 & 排序邏輯 ---
const filteredTickets = computed(() => {
  // 1. 先進行篩選
  let list = tickets.value.filter((t) => {
    const k = filters.keyword.toLowerCase()
    const textMatch =
      !k ||
      String(t.ticketId).includes(k) ||
      (t.issueDesc || '').toLowerCase().includes(k) ||
      (t.issueType || '').toLowerCase().includes(k)
    const pMatch = !filters.priority || t.issuePriority === filters.priority
    const sMatch = !filters.status || t.issueStatus === filters.status
    return textMatch && pMatch && sMatch
  })

  // 【新增】2. 根據 viewMode 過濾問題回報
  if (viewMode.value === 'support') {
    list = list.filter(t => isSupportTicket(t))
  }

  // 3. 進行排序：緊急工單 (URGENT) 置頂
  return list.sort((a, b) => {
    // 如果 a 是緊急，b 不是，a 排前面 (-1)
    if (a.issuePriority === 'URGENT' && b.issuePriority !== 'URGENT') return -1
    // 如果 b 是緊急，a 不是，b 排前面 (1)
    if (b.issuePriority === 'URGENT' && a.issuePriority !== 'URGENT') return 1

    // 如果優先級相同，依照 ID 倒序 (新的在上面)
    return b.ticketId - a.ticketId
  })
})

// 使用 usePagination composable
const {
  currentPage,
  pageSize,
  paginatedList: paginatedTickets,
  total: paginationTotal,
  showPagination,
  resetPagination,
} = usePagination(filteredTickets, { defaultPageSize: 10 })

// 開始維修
const startTicket = async (row) => {
  const result = await Swal.fire({
    title: '開始維修？',
    html: `
      <div style="text-align: center; padding: 10px 0;">
        <div style="font-size: 48px; margin-bottom: 12px;"><i class="fas fa-wrench" style="color: #e6a23c;"></i></div>
        <p>工單 <b>#${row.ticketId}</b> 即將進入維修狀態</p>
        <p style="color: #909399; font-size: 13px;">問題類型：${row.issueType}</p>
      </div>
    `,
    icon: null,
    showCancelButton: true,
    confirmButtonColor: '#409eff',
    cancelButtonColor: '#909399',
    confirmButtonText: '<i class="fas fa-play mr-1"></i> 開始維修',
    cancelButtonText: '稍後再說',
    showClass: { popup: 'animate__animated animate__bounceIn' },
  })

  if (result.isConfirmed) {
    try {
      await maintenanceApi.startTicket(row.ticketId)
      await Swal.fire({
        icon: 'success',
        title: '維修開始！',
        html: '<span class="text-primary">工單狀態已更新為「維修中」</span>',
        timer: 1000,
        timerProgressBar: true,
        showConfirmButton: false,
        showClass: { popup: 'animate__animated animate__fadeInUp animate__faster' },
      })
      fetchTickets()
    } catch {
      // 錯誤已由攔截器處理
    }
  }
}

// 取消工單
const cancelTicket = async (row) => {
  const { value: reason } = await Swal.fire({
    title: '取消工單',
    html: `
      <div style="text-align: center; padding: 10px 0;">
        <div style="font-size: 48px; margin-bottom: 12px;"><i class="fas fa-exclamation-triangle" style="color: #f56c6c;"></i></div>
        <p style="margin-bottom: 16px;">工單 <b>#${row.ticketId}</b> - ${row.issueType}</p>
      </div>
    `,
    input: 'textarea',
    inputPlaceholder: '請輸入取消原因...',
    inputAttributes: { rows: 3 },
    showCancelButton: true,
    confirmButtonColor: '#f56c6c',
    cancelButtonColor: '#909399',
    confirmButtonText: '<i class="fas fa-times mr-1"></i> 確認取消',
    cancelButtonText: '返回',
    showClass: { popup: 'animate__animated animate__fadeInDown animate__faster' },
    inputValidator: (value) => {
      if (!value) return '請輸入取消原因！'
    },
  })

  if (reason) {
    try {
      await maintenanceApi.cancelTicket(row.ticketId, reason)
      await Swal.fire({
        icon: 'success',
        title: '工單已取消',
        timer: 1000,
        timerProgressBar: true,
        showConfirmButton: false,
        showClass: { popup: 'animate__animated animate__bounceIn' },
      })
      fetchTickets()
    } catch {
      // 錯誤已由攔截器處理
    }
  }
}

// 開啟結案彈窗
const openResolveDialog = (id) => {
  resolveForm.ticketId = id
  resolveForm.resultType = 'FIXED'
  resolveForm.resolveNote = ''
  showResolveDialog.value = true
}

// 送出結案
const submitResolve = async () => {
  try {
    // ✅ [除錯用] 在瀏覽器 Console 印出傳送的資料，請按 F12 查看
    console.log('📤 準備結案，傳送資料:', {
      ticketId: resolveForm.ticketId,
      resultType: resolveForm.resultType, // 必須是英文大寫 Key (FIXED, MAINTAINED, UNFIXABLE, OTHER)
      resolveNote: resolveForm.resolveNote,
    })

    await maintenanceApi.resolveTicket(
      resolveForm.ticketId,
      resolveForm.resultType, // ✅ 直接傳送英文 Key，由 resultConfig 保證正確性
      resolveForm.resolveNote,
    )
    showResolveDialog.value = false

    const config = resultConfig[resolveForm.resultType] || {
      text: '已結案',
      icon: '🎉',
      color: '#67c23a',
    }

    await Swal.fire({
      icon: 'success',
      title: '結案成功！',
      html: `
        <div style="text-align: center;">
          <div style="font-size: 48px; margin-bottom: 12px;">${config.icon}</div>
          <p>結案結果：<b style="color: ${config.color};">${config.text}</b></p>
        </div>
      `,
      timer: 1200,
      timerProgressBar: true,
      showConfirmButton: false,
      position: 'center',
      heightAuto: false,
      showClass: { popup: 'animate__animated animate__tada' },
    })
    fetchTickets()
  } catch (error) {
    console.error('❌ 結案失敗:', error)
    console.error('❌ 後端回傳:', error.response?.data)
    console.error('❌ HTTP 狀態:', error.response?.status)

    // ✅ 顯示更詳細的錯誤給使用者
    const errorMsg =
      error.response?.data?.message ||
      error.response?.data?.error ||
      '後端不接受此結果類型 (Enum不匹配)'
    await Swal.fire({
      icon: 'error',
      title: '結案失敗',
      html: `
        <div style="text-align: left; padding: 10px;">
          <p><b>錯誤訊息：</b>${errorMsg}</p>
          ${error.response?.status ? `<p><b>HTTP 狀態碼：</b>${error.response.status}</p>` : ''}
          <hr style="margin: 12px 0; border: none; border-top: 1px solid #eee;">
          <p style="color: #909399; font-size: 13px;">
            <i class="fas fa-info-circle"></i> 如果出現 IllegalArgumentException，表示後端不支援該結果類型。<br>
            請確認後端已重啟並支援：FIXED, MAINTAINED, UNFIXABLE, OTHER
          </p>
        </div>
      `,
      confirmButtonColor: '#409eff',
      position: 'center',
      heightAuto: false,
    })
  }
}

// 查看工單詳情 (UI 優化版)
const viewTicketDetail = (row) => {
  // 準備變數
  const staffName = row.assignedStaff ? row.assignedStaff.staffName : '未指派'
  const staffColor = row.assignedStaff ? '#409eff' : '#909399' // 藍色或灰色

  // 處理維修結果區塊
  let resultHtml = ''
  if (row.issueStatus === 'RESOLVED' && row.resultType) {
    const rConfig = resultConfig[row.resultType] || { text: row.resultType, icon: '' }
    // 簡單的灰色背景區塊
    resultHtml = `
      <div style="margin-top: 15px; padding: 12px; background: #f4f4f5; border-radius: 8px; border-left: 4px solid #909399;">
        <div style="font-weight: bold; color: #606266; margin-bottom: 4px;">維修結果：${rConfig.text}</div>
        <div style="font-size: 13px; color: #909399;">${row.resolveNote || '無備註'}</div>
      </div>
    `
  }

  Swal.fire({
    // 標題簡潔化
    title: `<div style="display:flex; align-items:center; gap:8px;">
              <span style="font-size: 20px; font-weight:700;">工單 #${row.ticketId}</span>
              <span style="font-size: 14px; font-weight:400; color:#909399;">${row.issueType}</span>
            </div>`,
    html: `
      <div style="text-align: left; padding: 0 10px;">
        <div style="margin-bottom: 16px;">
          <div style="font-size: 12px; color: #909399; margin-bottom: 4px;">問題描述</div>
          <div style="padding: 12px; background: #fff; border: 1px solid #e4e7ed; border-radius: 8px; color: #606266; min-height: 40px;">
            ${row.issueDesc || '無詳細描述'}
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
          <div>
            <div style="font-size: 12px; color: #909399; margin-bottom: 4px;">優先級</div>
            <div style="font-size: 16px; font-weight: 600;">
              ${priorityIcon[row.issuePriority]} ${priorityText[row.issuePriority]}
            </div>
          </div>
          <div>
            <div style="font-size: 12px; color: #909399; margin-bottom: 4px;">目前狀態</div>
            <div style="font-size: 16px; font-weight: 600;">
              ${statusIcon[row.issueStatus]} ${statusText[row.issueStatus]}
            </div>
          </div>
        </div>

        <div style="margin-bottom: 16px; padding-top: 12px; border-top: 1px solid #ebeef5;">
          <div style="font-size: 12px; color: #909399; margin-bottom: 4px;">負責人員</div>
          <div style="display: flex; align-items: center; gap: 8px;">
            <div style="width: 32px; height: 32px; background: ${staffColor}; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-user"></i>
            </div>
            <span style="font-size: 15px; font-weight: 500; color: #303133;">${staffName}</span>
          </div>
        </div>

        ${resultHtml}

        <div style="margin-top: 20px;">
           <button id="btn-view-log" style="width: 100%; padding: 10px; border: 1px dashed #dcdfe6; background: #fff; color: #606266; border-radius: 6px; cursor: pointer; transition: all 0.3s;">
             <i class="fas fa-history mr-1"></i> 查看完整歷程
           </button>
        </div>
      </div>
    `,
    showConfirmButton: false,
    showCloseButton: true,
    width: 450,
    didOpen: () => {
      // 綁定歷程按鈕
      document.getElementById('btn-view-log')?.addEventListener('click', () => {
        Swal.close()
        openLogDialog(row.ticketId)
      })
    },
  })
}

// 地圖小視窗功能
// ====== 修正後的開啟地圖函式 (修復椅子工單座標顯示) ======
const showLocationMap = async (row) => {
  let lat = null
  let lng = null
  let targetName = ''

  console.log('🗺️ 開啟地圖，工單資料:', row)

  // 1. 判斷是機台還是椅子，並取得座標
  if (row.spotId) {
    // 機台工單：優先從 row.rentalSpot 取座標（已經在工單資料裡）
    targetName = row.rentalSpot?.spotName || `機台 #${row.spotId}`
    lat = row.rentalSpot?.latitude
    lng = row.rentalSpot?.longitude

    console.log('📍 機台工單 - rentalSpot 座標:', { lat, lng, spotName: targetName })

    // 如果 rentalSpot 沒有座標，再從 allSpots 找（備援方案）
    if (!lat || !lng) {
      const foundSpot = allSpots.value.find((s) => Number(s.spotId) === Number(row.spotId))
      console.log('🔍 從 allSpots 找機台:', { foundSpot, allSpotsCount: allSpots.value.length })
      if (foundSpot) {
        //  修正原因：後端已修復座標傳輸，此處加入 Number 轉型與 null 檢查作為保險
        const spotLat = Number(foundSpot.latitude)
        const spotLng = Number(foundSpot.longitude)

        if (!isNaN(spotLat) && !isNaN(spotLng) && spotLat !== 0 && spotLng !== 0) {
          lat = spotLat
          lng = spotLng
          targetName = foundSpot.spotName || targetName
        }
      }
    }
  } else if (row.seatsId) {
    // 椅子工單：取得所屬機台的座標
    targetName = row.seat?.seatsName || `椅子 #${row.seatsId}`

    if (row.seat && row.seat.spotId) {
      console.log('🪑 椅子工單 - 所屬機台 ID:', row.seat.spotId)

      // ✅ 直接從 allSpots 找椅子所屬的機台（因為 seat.rentalSpot 通常沒有座標）
      const foundSpot = allSpots.value.find((s) => Number(s.spotId) === Number(row.seat.spotId))
      console.log('🔍 從 allSpots 找椅子所屬機台:', {
        foundSpot: foundSpot
          ? {
              spotId: foundSpot.spotId,
              spotName: foundSpot.spotName,
              lat: foundSpot.latitude,
              lng: foundSpot.longitude,
            }
          : null,
        searchSpotId: row.seat.spotId,
      })

      // ✅ 修正原因：後端已修復座標傳輸，此處加入 Number 轉型與 null 檢查作為保險
      if (foundSpot) {
        const spotLat = Number(foundSpot.latitude)
        const spotLng = Number(foundSpot.longitude)

        // ✅ 檢查座標是否為有效數字（不是 NaN、不是 0、不是 null）
        if (!isNaN(spotLat) && !isNaN(spotLng) && spotLat !== 0 && spotLng !== 0) {
          lat = spotLat
          lng = spotLng
          targetName = `${row.seat.seatsName || '椅子'} (位於 ${foundSpot.spotName || '機台'})`
          console.log('✅ 成功取得椅子所屬機台座標:', { lat, lng, targetName })
        } else {
          console.warn('⚠️ 機台座標無效:', { spotLat, spotLng })
          Swal.fire('無座標資訊', `椅子所屬的機台「${foundSpot.spotName}」未設定有效經緯度`, 'info')
          return
        }
      } else {
        console.warn('⚠️ 找不到椅子所屬機台')
        Swal.fire('無座標資訊', `找不到椅子所屬的機台（ID: ${row.seat.spotId}）`, 'info')
        return
      }
    } else {
      Swal.fire('無法定位', '這張椅子工單找不到所屬的機台資訊', 'warning')
      return
    }
  }

  // 2. 檢查是否有座標
  if (lat && lng) {
    const stationName = targetName

    // Google Maps Embed URL
    const mapUrl = `https://maps.google.com/maps?q=${lat},${lng}&z=15&output=embed`

    // 3. 彈出 Swal 視窗
    await Swal.fire({
      title: `<div style="display: flex; align-items: center; gap: 12px; justify-content: center;">
          <i class="fas fa-map-marker-alt" style="color: #e6a23c; font-size: 24px;"></i>
          <span>${stationName}</span>
        </div>`,
      html: `
          <div style="text-align: center;">
            <div style="margin-bottom: 16px; padding: 12px; background: #f0f9eb; border-radius: 8px; border-left: 4px solid #67c23a;">
              <p style="margin: 0; color: #606266; font-size: 13px;">
                <i class="fas fa-info-circle mr-1" style="color: #67c23a;"></i>
                經度：${lng}° | 緯度：${lat}°
              </p>
            </div>
            <iframe
              src="${mapUrl}"
              width="100%"
              height="300"
              style="border: none; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);"
              allowfullscreen=""
              loading="lazy"
              referrerpolicy="no-referrer-when-downgrade">
            </iframe>
            <p style="margin: 12px 0 0; color: #909399; font-size: 11px;">
              <i class="fas fa-external-link-alt mr-1"></i>
              點擊地圖可在新視窗中開啟 Google Maps
            </p>
          </div>
        `,
      width: '600px',
      showConfirmButton: true,
      confirmButtonText: '<i class="fas fa-times mr-1"></i>關閉',
      confirmButtonColor: '#909399',
      customClass: {
        popup: 'custom-map-popup',
      },
      showClass: { popup: 'animate__animated animate__zoomIn animate__faster' },
      hideClass: { popup: 'animate__animated animate__zoomOut animate__faster' },
    })
  } else {
    console.error('❌ 最終檢查：沒有座標資訊', { lat, lng, targetName })
    Swal.fire('無座標資訊', `無法取得「${targetName}」的經緯度資訊`, 'info')
  }
}

// 切換模式時重新抓資料
watch(
  () => props.historyMode,
  () => {
    fetchTickets()
  },
)

// ====== (載入資料) ======
onMounted(async () => {
  try {
    loading.value = true

    //  同時載入「資產統計」和「機台資料」，工單則透過 fetchTickets 根據模式載入
    const [statsRes, spotsRes] = await Promise.all([
      maintenanceApi.getAssetStats(assetStatsTab.value),
      maintenanceApi.getAllSpots(), // 抓取機台資料供地圖使用
    ])

    // 存入變數
    assetStats.value = statsRes.data || []
    allSpots.value = spotsRes.data || []

    // ✅ 根據 historyMode 載入對應的工單資料
    await fetchTickets()
  } catch (err) {
    console.error('載入初始資料失敗:', err)
    Swal.fire('錯誤', '無法載入資料', 'error')
  } finally {
    loading.value = false
    // ✅ 【關鍵修復】設置頁面可見，否則 v-show="pageVisible" 會隱藏所有內容！
    pageVisible.value = true
  }
})
</script>

<template>
  <div class="ticket-list-container">
    <section class="content-header">
      <div class="container-fluid">
        <transition name="slide-down" appear>
          <div class="page-title-box">
            <div class="title-icon" :class="historyMode ? 'history-mode' : 'active-mode'">
              <i :class="historyMode ? 'fas fa-archive' : 'fas fa-clipboard-list'"></i>
            </div>
            <div class="title-content">
              <h1>{{ historyMode ? '維修歷史檔案' : '維修工單管理' }}</h1>
              <p class="subtitle">
                {{ historyMode ? '查看已完成或取消的工單紀錄' : '管理與追蹤所有維修工單' }}
              </p>
            </div>
            <div class="title-actions">
              <el-button-group>
                <router-link v-if="historyMode" to="/admin/mtif-list">
                  <el-button type="primary" plain class="action-btn">
                    <i class="fas fa-arrow-left mr-2"></i> 返回列表
                  </el-button>
                </router-link>
                <router-link v-if="!historyMode" to="/admin/mtif-history">
                  <el-button type="info" plain class="action-btn">
                    <i class="fas fa-history mr-2"></i> 歷史紀錄
                  </el-button>
                </router-link>
                <router-link v-if="!historyMode" to="/admin/mtif-form">
                  <el-button type="success" class="action-btn add-btn">
                    <i class="fas fa-plus mr-2"></i> 新增工單
                  </el-button>
                </router-link>
              </el-button-group>
            </div>
          </div>
        </transition>

        <!-- 【新增】檢視模式切換（僅在現有工單模式顯示） -->
        <transition name="fade" appear v-if="!historyMode">
          <div class="view-mode-switch mb-3">
            <el-segmented v-model="viewMode" size="large" block>
              <el-segmented-item value="all">
                <span class="segmented-label">
                  <i class="fas fa-list mr-2"></i>
                  全部工單
                </span>
              </el-segmented-item>
              <el-segmented-item value="support">
                <span class="segmented-label">
                  <i class="fas fa-life-ring mr-2"></i>
                  問題回報
                  <el-badge 
                    v-if="supportPendingCount > 0" 
                    :value="supportPendingCount" 
                    type="danger" 
                    class="ml-2"
                  />
                </span>
              </el-segmented-item>
            </el-segmented>
          </div>
        </transition>
      </div>
    </section>

    <section class="content">
      <div class="container-fluid">
        <transition name="zoom-fade" appear>
          <div v-show="pageVisible">
            <el-row :gutter="16" class="mb-4" v-if="!historyMode">
              <el-col :xs="12" :sm="6" :md="6">
                <div class="stat-card total-card">
                  <div class="stat-icon">
                    <i class="fas fa-clipboard-list"></i>
                  </div>
                  <div class="stat-info">
                    <h3>{{ statsCards.total }}</h3>
                    <span>全部工單</span>
                  </div>
                  <div class="stat-wave"></div>
                </div>
              </el-col>
              <el-col :xs="12" :sm="6" :md="6">
                <div class="stat-card urgent-card">
                  <div class="stat-icon pulse">
                    <i class="fas fa-exclamation-triangle"></i>
                  </div>
                  <div class="stat-info">
                    <h3>{{ statsCards.urgent }}</h3>
                    <span>緊急工單</span>
                  </div>
                </div>
              </el-col>
              <el-col :xs="12" :sm="6" :md="6">
                <div class="stat-card progress-card">
                  <div class="stat-icon">
                    <i class="fas fa-tools"></i>
                  </div>
                  <div class="stat-info">
                    <h3>{{ statsCards.inProgress }}</h3>
                    <span>維修中</span>
                  </div>
                </div>
              </el-col>
              <el-col :xs="12" :sm="6" :md="6">
                <div class="stat-card resolved-card">
                  <div class="stat-icon">
                    <i class="fas fa-check-circle"></i>
                  </div>
                  <div class="stat-info">
                    <h3>{{ statsCards.resolved }}</h3>
                    <span>已完成</span>
                  </div>
                </div>
              </el-col>
            </el-row>

            <TicketCharts :tickets="filteredTickets" class="mb-4" />

            <el-card shadow="hover" class="mb-4 asset-stats-card" v-if="!historyMode">
              <template #header>
                <div class="card-header-content">
                  <div class="header-left">
                    <span
                      class="header-icon"
                      style="background: linear-gradient(135deg, #67c23a, #95d475)"
                    >
                      <i class="fas fa-heartbeat"></i>
                    </span>
                    <span class="header-text">資產健康度統計</span>
                    <el-tag type="success" effect="light" size="small" class="ml-2" round
                      >最近 7 天</el-tag
                    >
                  </div>
                  <div class="header-right">
                    <el-radio-group v-model="assetStatsTab" size="small">
                      <el-radio-button value="SPOT"
                        ><i class="fas fa-desktop mr-1"></i> 機台</el-radio-button
                      >
                      <el-radio-button value="SEAT"
                        ><i class="fas fa-chair mr-1"></i> 椅子</el-radio-button
                      >
                    </el-radio-group>
                    <el-button type="info" plain size="small" @click="fetchAssetStats" class="ml-2">
                      <i class="fas fa-sync-alt"></i>
                    </el-button>
                  </div>
                </div>
              </template>

              <el-skeleton :rows="4" animated v-if="assetStatsLoading" />
              <el-empty v-else-if="assetStats.length === 0" description="暫無統計資料" />
              <el-table v-else :data="assetStats" stripe style="width: 100%" max-height="400">
                <el-table-column prop="assetName" label="資產名稱" min-width="150" fixed>
                  <template #default="{ row }">
                    <div style="display: flex; align-items: center; gap: 8px">
                      <i
                        :class="row.assetType === 'SPOT' ? 'fas fa-desktop' : 'fas fa-chair'"
                        :style="{ color: row.assetType === 'SPOT' ? '#409eff' : '#e6a23c' }"
                      ></i>
                      <span>{{ row.assetName || '未知資產#' + row.assetId }}</span>
                    </div>
                  </template>
                </el-table-column>
                <el-table-column label="維修次數" width="100" align="center">
                  <template #default="{ row }">
                    <el-tag
                      :type="row.repairCount > 0 ? 'danger' : 'info'"
                      effect="light"
                      size="small"
                      >{{ row.repairCount || 0 }}</el-tag
                    >
                  </template>
                </el-table-column>
                <el-table-column label="保養次數" width="100" align="center">
                  <template #default="{ row }">
                    <el-tag type="primary" effect="light" size="small">{{
                      row.maintainCount || 0
                    }}</el-tag>
                  </template>
                </el-table-column>
                <el-table-column label="未結案" width="90" align="center">
                  <template #default="{ row }">
                    <el-tag
                      :type="row.openCount > 0 ? 'warning' : 'success'"
                      effect="plain"
                      size="small"
                      >{{ row.openCount || 0 }}</el-tag
                    >
                  </template>
                </el-table-column>
                <el-table-column label="妥善率" width="140" align="center">
                  <template #default="{ row }">
                    <el-progress
                      :percentage="Math.round((row.availability || 0) * 100)"
                      :status="getAvailabilityStatus(row.availability)"
                      :stroke-width="10"
                      style="width: 100px; display: inline-block"
                    />
                    <span style="margin-left: 8px; font-size: 12px; color: #606266">{{
                      formatPercent(row.availability)
                    }}</span>
                  </template>
                </el-table-column>
                <el-table-column label="故障率(/天)" width="110" align="center">
                  <template #default="{ row }">
                    <span
                      :style="{
                        color: row.failureRatePerDay > 0.5 ? '#f56c6c' : '#67c23a',
                        fontWeight: 'bold',
                      }"
                      >{{ formatRate(row.failureRatePerDay) }}</span
                    >
                  </template>
                </el-table-column>
                <el-table-column label="維修率" width="100" align="center">
                  <template #default="{ row }">
                    <el-tag
                      :type="
                        row.repairRate >= 1 ? 'success' : row.repairRate > 0 ? 'warning' : 'info'
                      "
                      effect="plain"
                      size="small"
                      >{{ formatPercent(row.repairRate) }}</el-tag
                    >
                  </template>
                </el-table-column>
                <el-table-column label="停機時間" width="100" align="center">
                  <template #default="{ row }">
                    <span style="color: #909399; font-size: 12px"
                      >{{ row.downtimeMinutes || 0 }} 分鐘</span
                    >
                  </template>
                </el-table-column>
              </el-table>
            </el-card>

            <el-card shadow="hover" class="table-card">
              <template #header>
                <div class="card-header-content">
                  <div class="header-left">
                    <span class="header-icon">
                      <i class="fas fa-table"></i>
                    </span>
                    <span class="header-text">工單列表</span>
                    <el-tag type="primary" effect="light" size="small" class="ml-2" round>
                      {{ filteredTickets.length }} 筆
                    </el-tag>
                  </div>
                </div>
              </template>

              <div class="filter-bar">
                <el-input
                  v-model="filters.keyword"
                  placeholder="搜尋 ID、描述、類型..."
                  prefix-icon="Search"
                  clearable
                  class="filter-input"
                />
                <el-select
                  v-model="filters.priority"
                  placeholder="優先級"
                  clearable
                  class="filter-select"
                >
                  <el-option label="🔵 低" value="LOW" />
                  <el-option label="🟢 普通" value="NORMAL" />
                  <el-option label="🟠 高" value="HIGH" />
                  <el-option label="🔴 緊急" value="URGENT" />
                </el-select>
                <el-select
                  v-model="filters.status"
                  placeholder="狀態"
                  clearable
                  class="filter-select"
                >
                  <el-option
                    v-for="(val, key) in availableStatusOptions"
                    :key="key"
                    :label="`${statusIcon[key]} ${val}`"
                    :value="key"
                  />
                </el-select>
                <el-button type="info" plain @click="fetchTickets" class="refresh-btn">
                  <i class="fas fa-sync-alt"></i>
                </el-button>
              </div>

              <el-skeleton :rows="8" animated v-if="loading" />

              <el-table
                v-else
                :data="paginatedTickets"
                stripe
                highlight-current-row
                style="width: 100%"
                class="custom-table"
                @row-dblclick="viewTicketDetail"
              >
                <el-table-column prop="ticketId" label="ID" width="80" sortable fixed>
                  <template #default="{ row }">
                    <el-tag effect="plain" size="small" class="id-tag">#{{ row.ticketId }}</el-tag>
                  </template>
                </el-table-column>

                <el-table-column label="維修目標" width="180" align="center">
                  <template #default="{ row }">
                    <div v-if="row.seatsId" class="target-cell seat-target">
                      <div class="target-main">
                        <i class="fas fa-chair" style="color: #e6a23c"></i>
                        <!--  改成椅子真名（優先 seatsName，沒有才 fallback #id） -->
                        <span>{{ row.seat?.seatsName || `椅子 #${row.seatsId}` }}</span>
                      </div>
                      <div v-if="row.seat && row.seat.spotId" class="target-station">
                        <span class="station-link" @click="showLocationMap(row)">
                          <i class="fas fa-map-marker-alt mr-1"></i>
                          <!--  改成機台真名：優先 row.rentalSpot.spotName，否則用 allSpots 查 spotName -->
                          {{ getSpotDisplayName(row.seat.spotId, row.rentalSpot) }}
                        </span>
                      </div>
                    </div>
                    <div v-else class="target-cell spot-target">
                      <div class="target-main">
                        <i class="fas fa-desktop" style="color: #409eff"></i>
                        <span>機台 #{{ row.spotId }}</span>
                      </div>
                      <div v-if="row.rentalSpot" class="target-station">
                        <span class="station-link" @click="showLocationMap(row)">
                          <i class="fas fa-map-marker-alt mr-1"></i>
                          {{ row.rentalSpot.spotName }}
                        </span>
                      </div>
                    </div>
                  </template>
                </el-table-column>

                <el-table-column prop="issueType" label="問題類型" width="160">
                  <template #default="{ row }">
                    <div class="type-cell" @click="viewTicketDetail(row)">
                      <i class="fas fa-exclamation-circle type-icon"></i>
                      <span>{{ row.issueType }}</span>
                      <!-- 【新增】問題回報標記 -->
                      <el-tag 
                        v-if="isSupportTicket(row)" 
                        type="warning" 
                        size="small" 
                        effect="plain"
                        style="margin-left: 4px;"
                      >
                        <i class="fas fa-life-ring" style="margin-right: 2px;"></i>
                        回報
                      </el-tag>
                    </div>
                  </template>
                </el-table-column>

                <el-table-column
                  prop="issueDesc"
                  label="描述"
                  min-width="200"
                  show-overflow-tooltip
                >
                  <template #default="{ row }">
                    <span class="desc-cell">{{ row.issueDesc || '-' }}</span>
                  </template>
                </el-table-column>

                <el-table-column prop="issuePriority" label="優先級" width="110" align="center">
                  <template #default="{ row }">
                    <!-- ✅ 【修正】優先級 badge 文字顏色對比度 (深色背景使用白字) -->
                    <el-tag
                      :type="getPriorityTag(row.issuePriority)"
                      effect="dark"
                      round
                      style="border: none; white-space: nowrap; color: white; font-weight: 600"
                    >
                      {{ priorityIcon[row.issuePriority] }} {{ priorityText[row.issuePriority] }}
                    </el-tag>
                  </template>
                </el-table-column>

                <el-table-column label="維修人員" width="120" align="center">
                  <template #default="{ row }">
                    <div v-if="row.assignedStaff">
                      <el-tag effect="plain" type="info" round size="small">
                        <i class="fas fa-user-check mr-1"></i>
                        {{ row.assignedStaff.staffName }}
                      </el-tag>
                    </div>
                    <div v-else>
                      <span style="color: #909399; font-size: 12px">- 未指派 -</span>
                    </div>
                  </template>
                </el-table-column>

                <el-table-column prop="issueStatus" label="狀態" width="130" align="center">
                  <template #default="{ row }">
                    <el-tag :type="getStatusTag(row.issueStatus)" effect="light" class="status-tag">
                      {{ statusIcon[row.issueStatus] }} {{ statusText[row.issueStatus] }}
                    </el-tag>
                  </template>
                </el-table-column>

                <el-table-column label="操作" width="240" align="center" fixed="right">
                  <template #default="{ row }">
                    <div class="action-buttons">
                      <el-tooltip content="查看詳情" placement="top">
                        <el-button
                          type="info"
                          size="small"
                          circle
                          @click="viewTicketDetail(row)"
                          class="action-btn-item"
                        >
                          <i class="fas fa-eye"></i>
                        </el-button>
                      </el-tooltip>

                      <el-tooltip content="查看歷程" placement="top">
                        <el-button
                          type="warning"
                          size="small"
                          circle
                          @click="openLogDialog(row.ticketId)"
                          class="action-btn-item"
                        >
                          <i class="fas fa-history"></i>
                        </el-button>
                      </el-tooltip>

                      <el-tooltip
                        v-if="!historyMode"
                        :content="getEditTooltip(row)"
                        placement="top"
                      >
                        <el-button
                          size="small"
                          circle
                          :disabled="!canEdit(row)"
                          @click="$router.push(`/admin/mtif-form/${row.ticketId}`)"
                          class="action-btn-item"
                        >
                          <i class="fas fa-edit"></i>
                        </el-button>
                      </el-tooltip>

                      <el-tooltip
                        v-if="!historyMode && row.issueStatus === 'ASSIGNED'"
                        content="開始維修"
                        placement="top"
                      >
                        <el-button
                          type="primary"
                          size="small"
                          circle
                          @click="startTicket(row)"
                          class="action-btn-item"
                        >
                          <i class="fas fa-play"></i>
                        </el-button>
                      </el-tooltip>

                      <el-tooltip
                        v-if="!historyMode && row.issueStatus === 'UNDER_MAINTENANCE'"
                        content="結案"
                        placement="top"
                      >
                        <el-button
                          type="success"
                          size="small"
                          circle
                          @click="openResolveDialog(row.ticketId)"
                          class="action-btn-item"
                        >
                          <i class="fas fa-check"></i>
                        </el-button>
                      </el-tooltip>

                      <el-tooltip
                        v-if="!historyMode && !['RESOLVED', 'CANCELLED'].includes(row.issueStatus)"
                        content="取消工單"
                        placement="top"
                      >
                        <el-button
                          type="danger"
                          size="small"
                          circle
                          @click="cancelTicket(row)"
                          class="action-btn-item"
                        >
                          <i class="fas fa-times"></i>
                        </el-button>
                      </el-tooltip>
                    </div>
                  </template>
                </el-table-column>

                <template #empty>
                  <el-empty description="目前沒有相關工單資料">
                    <template #image>
                      <div class="empty-icon"><i class="fas fa-clipboard"></i></div>
                    </template>
                    <router-link to="/admin/mtif-form" v-if="!historyMode">
                      <el-button type="primary"
                        ><i class="fas fa-plus mr-1"></i> 建立第一張工單</el-button
                      >
                    </router-link>
                  </el-empty>
                </template>
              </el-table>

              <div class="pagination-wrapper" v-show="paginationTotal > 0">
                <el-pagination
                  v-model:current-page="currentPage"
                  v-model:page-size="pageSize"
                  :page-sizes="[5, 10, 20, 50]"
                  :total="paginationTotal"
                  layout="total, sizes, prev, pager, next, jumper"
                  background
                />
              </div>
            </el-card>

            <div class="tips-bar mt-3">
              <el-alert type="info" :closable="false" show-icon>
                <template #title>
                  <span>💡 小提示：雙擊表格列可快速查看工單詳情 | 緊急工單會優先置頂顯示</span>
                </template>
              </el-alert>
            </div>
          </div>
        </transition>
      </div>
    </section>

    <el-dialog
      v-model="logDialogVisible"
      :title="`工單 #${currentLogTicketId}｜歷程`"
      width="760px"
      destroy-on-close
      append-to-body
      align-center
    >
      <TicketTimeline v-if="currentLogTicketId" :ticketId="currentLogTicketId" />
    </el-dialog>

    <el-dialog
      v-model="showResolveDialog"
      title=""
      width="500px"
      center
      destroy-on-close
      align-center
      append-to-body
      class="resolve-dialog"
    >
      <template #header>
        <div class="dialog-header">
          <span class="dialog-icon"
            ><i class="fas fa-check-circle" style="color: #67c23a; font-size: 24px"></i
          ></span>
          <span class="dialog-title">工單結案確認</span>
        </div>
      </template>
      <el-form label-position="top" class="resolve-form">
        <el-form-item label="維修結果">
          <div class="result-cards">
            <div
              v-for="(config, key) in resultConfig"
              :key="key"
              class="result-card"
              :class="{ active: resolveForm.resultType === key }"
              :style="{ '--card-color': config.color }"
              @click="resolveForm.resultType = key"
            >
              <span class="result-icon">{{ config.icon }}</span>
              <span class="result-text">{{ config.text }}</span>
            </div>
          </div>
        </el-form-item>
        <el-form-item label="維修備註">
          <el-input
            v-model="resolveForm.resolveNote"
            type="textarea"
            :rows="4"
            placeholder="請填寫維修過程說明、更換零件、保養項目等資訊..."
            show-word-limit
            maxlength="500"
          />
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button @click="showResolveDialog = false" size="large">取消</el-button>
        <el-button type="primary" @click="submitResolve" size="large" class="confirm-btn"
          ><i class="fas fa-check mr-1"></i> 確認結案</el-button
        >
      </template>
    </el-dialog>
  </div>
</template>

<style scoped>
/* 頁面容器 */
.ticket-list-container {
  min-height: 100vh;
  background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
  padding-bottom: 40px;
}

.content-header {
  padding: 20px 1rem;
}

.page-title-box {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 20px 24px;
  background: white;
  border-radius: 16px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  flex-wrap: wrap;
}

.title-icon {
  width: 64px;
  height: 64px;
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  color: white;
  transition: all 0.4s ease;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
}
.title-icon:hover {
  transform: scale(1.1) rotate(10deg);
}
.title-icon.active-mode {
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
}
.title-icon.history-mode {
  background: linear-gradient(135deg, #909399 0%, #c0c4cc 100%);
}

.title-content {
  flex: 1;
  min-width: 200px;
}
.title-content h1 {
  margin: 0;
  font-size: 1.7rem;
  font-weight: 700;
  color: #303133;
}
.title-content .subtitle {
  margin: 6px 0 0;
  font-size: 0.9rem;
  color: #909399;
}

.title-actions {
  display: flex;
  gap: 10px;
}
.action-btn {
  border-radius: 10px;
  font-weight: 500;
  transition: all 0.3s ease;
}
.add-btn {
  background: linear-gradient(135deg, #67c23a 0%, #95d475 100%);
  border: none;
  box-shadow: 0 4px 15px rgba(103, 194, 58, 0.3);
}
.add-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(103, 194, 58, 0.4);
}

/* 【新增】檢視模式切換樣式 */
.view-mode-switch {
  padding: 0 24px;
}

.segmented-label {
  display: flex;
  align-items: center;
  font-weight: 500;
}

:deep(.el-segmented) {
  border-radius: 12px;
  padding: 4px;
  background: white;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
}

:deep(.el-segmented-item) {
  border-radius: 10px;
  padding: 12px 24px;
  transition: all 0.3s ease;
}

:deep(.el-segmented-item--selected) {
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%) !important;
  color: white !important;
  font-weight: 600;
  box-shadow: 0 4px 12px rgba(64, 158, 255, 0.3);
}

:deep(.el-badge__content) {
  animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

@keyframes pulse {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.7;
  }
}

/* 統計卡片 */
.stat-card {
  position: relative;
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 18px;
  background: white;
  border-radius: 14px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
  transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  overflow: hidden;
  margin-bottom: 16px;
}
.stat-card:hover {
  transform: translateY(-6px);
  box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
}
.stat-icon {
  width: 50px;
  height: 50px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  color: white;
  z-index: 1;
}
.stat-icon.pulse {
  animation: pulse 1.5s infinite;
}
@keyframes pulse {
  0%,
  100% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.1);
  }
}
.total-card .stat-icon {
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
}
.urgent-card .stat-icon {
  background: linear-gradient(135deg, #f56c6c 0%, #f89898 100%);
}
.progress-card .stat-icon {
  background: linear-gradient(135deg, #e6a23c 0%, #f3d19e 100%);
}
.resolved-card .stat-icon {
  background: linear-gradient(135deg, #67c23a 0%, #95d475 100%);
}
.stat-info h3 {
  margin: 0;
  font-size: 1.8rem;
  font-weight: 700;
  color: #303133;
}
.stat-info span {
  font-size: 0.85rem;
  color: #909399;
}

/* 表格卡片 */
.table-card {
  border-radius: 16px;
  overflow: hidden;
  border: none;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
}
.card-header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.header-left {
  display: flex;
  align-items: center;
  gap: 10px;
}
.header-icon {
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 16px;
}
.header-text {
  font-weight: 600;
  font-size: 1.1rem;
  color: #303133;
}

/* 篩選區 */
.filter-bar {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin-bottom: 20px;
  padding: 16px;
  background: #f8f9fa;
  border-radius: 12px;
}
.filter-input {
  width: 280px;
}
.filter-input :deep(.el-input__wrapper) {
  border-radius: 10px;
}
.filter-select {
  width: 140px;
}
.filter-select :deep(.el-input__wrapper) {
  border-radius: 10px;
}
.refresh-btn {
  border-radius: 10px;
  transition: all 0.3s ease;
}
.refresh-btn:hover {
  transform: rotate(180deg);
}

/* 表格樣式 */
.custom-table {
  --el-table-header-bg-color: #f8f9fa;
}
.id-tag {
  font-weight: 600;
}

/* 維修目標欄位樣式 */
.target-cell {
  display: flex;
  align-items: center;
  flex-direction: column;
  gap: 2px;
  padding: 6px 10px;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 500;
  transition: all 0.3s ease;
  text-align: center;
}
.seat-target {
  background: linear-gradient(135deg, #f0f9eb 0%, #e1f3d8 100%);
  color: #67c23a;
}
.seat-target:hover {
  box-shadow: 0 2px 8px rgba(103, 194, 58, 0.3);
}
.spot-target {
  background: linear-gradient(135deg, #ecf5ff 0%, #d9ecff 100%);
  color: #409eff;
}
.spot-target:hover {
  box-shadow: 0 2px 8px rgba(64, 158, 255, 0.3);
}
.target-main {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  font-weight: 500;
  color: #303133;
  margin-bottom: 4px;
}
.target-station {
  font-size: 11px;
}
.station-link {
  color: #409eff;
  cursor: pointer;
  padding: 2px 6px;
  border-radius: 4px;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
}
.station-link:hover {
  color: #66b1ff;
  background: #ecf5ff;
  transform: translateY(-1px);
}

.type-cell {
  cursor: pointer;
  transition: color 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 4px 8px;
  border-radius: 6px;
}
.type-cell:hover {
  color: #409eff;
  background: #ecf5ff;
}
.type-icon {
  margin-right: 6px;
  color: #f56c6c;
}
.desc-cell {
  color: #606266;
  font-size: 13px;
}

/* Tag 不換行 */
:deep(.el-tag) {
  white-space: nowrap;
}

.action-buttons {
  display: flex;
  justify-content: center;
  gap: 6px;
  flex-wrap: wrap;
}
.action-btn-item {
  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.action-btn-item:hover {
  transform: scale(1.2);
}

.empty-icon {
  font-size: 64px;
  color: #dcdfe6;
  margin-bottom: 16px;
}
.pagination-wrapper {
  padding: 20px;
  text-align: center;
  border-top: 1px solid #ebeef5;
  background: #fafafa;
  margin-top: 20px;
}
.tips-bar :deep(.el-alert) {
  border-radius: 12px;
}

/* 結案彈窗 */
.resolve-dialog :deep(.el-dialog) {
  border-radius: 16px;
  margin: auto !important; /* ✅ 強制置中，避免偏高問題 */
}
.dialog-header {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}
.dialog-icon {
  font-size: 28px;
}
.dialog-title {
  font-size: 18px;
  font-weight: 600;
  color: #303133;
}
.resolve-form {
  padding: 10px 0;
}
.result-cards {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
}
.result-card {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 14px 10px;
  background: #f5f7fa;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.3s ease;
  border: 2px solid transparent;
}
.result-card:hover {
  background: #ecf5ff;
  transform: translateY(-2px);
}
.result-card.active {
  border-color: var(--card-color);
  background: white;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}
.result-icon {
  font-size: 24px;
  margin-bottom: 6px;
}
.result-text {
  font-size: 12px;
  color: #606266;
  font-weight: 500;
}
.confirm-btn {
  background: linear-gradient(135deg, #67c23a 0%, #95d475 100%);
  border: none;
  border-radius: 10px;
}

/* 過渡動畫 */
.slide-down-enter-active {
  transition: all 0.5s ease-out;
}
.slide-down-leave-active {
  transition: all 0.3s ease-in;
}
.slide-down-enter-from {
  transform: translateY(-30px);
  opacity: 0;
}
.slide-down-leave-to {
  transform: translateY(-20px);
  opacity: 0;
}
.zoom-fade-enter-active {
  transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.zoom-fade-leave-active {
  transition: all 0.3s ease-in;
}
.zoom-fade-enter-from {
  transform: scale(0.95);
  opacity: 0;
}
.zoom-fade-leave-to {
  transform: scale(0.98);
  opacity: 0;
}

/* 輔助類 */
.mr-1 {
  margin-right: 4px;
}
.mr-2 {
  margin-right: 8px;
}
.ml-2 {
  margin-left: 8px;
}
.mb-4 {
  margin-bottom: 1.5rem;
}
.mt-3 {
  margin-top: 1rem;
}
.w-100 {
  width: 100%;
}

:global(.custom-map-popup) {
  border-radius: 16px !important;
  overflow: hidden !important;
}
</style>
</file>

<file path="frontend/src/views/member/AdminHomeView.vue">
<script setup>
/**
 * AdminHomeView.vue：後台首頁入口 (Layout 適配修正版)
 * ------------------------------------------------
 * 1. [Fix] 更名 .content-wrapper -> .dashboard-inner 避免與 AdminLayout 衝突
 * 2. [Fix] 移除 min-height: 100vh，改由內容撐開，適配 AdminLTE 結構
 * 3. [Fix] 粒子特效改為 absolute，限制在內容區塊內
 * 4. [Layout] 模組區塊採用 Grid 分箱設計，確保每個類別獨立顯示
 * ------------------------------------------------
 */
import { ref, onMounted, onUnmounted, computed } from 'vue'
import { useRouter } from 'vue-router'
import { useAdminAuthStore } from '@/stores/adminAuth'
import axios from 'axios'

const router = useRouter()
const adminAuthStore = useAdminAuthStore()

const adminName = computed(() => adminAuthStore.admin?.name || '管理員')

// =======================
// 1. 統計數據狀態
// =======================
const stats = ref({
  totalSpots: 0,
  totalSeats: 0,
  maintenanceCount: 0,
  totalMembers: 0,
  activeRentals: 0,
})

const loading = ref(true)
const currentTime = ref('')
const timeInterval = ref(null)

// =======================
// 2. 圖表設定
// =======================
// (A) 營收趨勢圖
const revenueSeries = ref([])
const revenueOptions = ref({
  chart: {
    type: 'area',
    height: 350,
    toolbar: { show: false },
    fontFamily: 'Helvetica, Arial, sans-serif',
    animations: { enabled: true, easing: 'easeinout', speed: 800 },
    background: 'transparent',
  },
  dataLabels: { enabled: false },
  stroke: { curve: 'smooth', width: 3 },
  xaxis: {
    categories: [],
    axisBorder: { show: false },
    axisTicks: { show: false },
    labels: { style: { colors: '#64748b' } },
  },
  yaxis: { labels: { style: { colors: '#64748b' } } },
  grid: {
    borderColor: '#f1f1f1',
    strokeDashArray: 4,
    padding: { top: 0, right: 0, bottom: 0, left: 10 },
  },
  fill: {
    type: 'gradient',
    gradient: {
      shadeIntensity: 1,
      opacityFrom: 0.6,
      opacityTo: 0.05,
      stops: [0, 90, 100],
    },
  },
  tooltip: { x: { format: 'yyyy-MM-dd' }, theme: 'light' },
  colors: ['#4f46e5'],
})

// (B) 熱門站點排行
const spotSeries = ref([])
const spotOptions = ref({
  chart: {
    type: 'bar',
    height: 350,
    toolbar: { show: false },
    fontFamily: 'Helvetica, Arial, sans-serif',
    background: 'transparent',
  },
  plotOptions: {
    bar: {
      borderRadius: 4,
      horizontal: true,
      barHeight: '55%',
      distributed: true,
    },
  },
  dataLabels: { enabled: false },
  xaxis: {
    categories: [],
    labels: { style: { colors: '#64748b' } },
  },
  yaxis: { labels: { style: { colors: '#64748b', fontSize: '13px', fontWeight: 500 } } },
  grid: { show: false },
  colors: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'],
  legend: { show: false },
})

// =======================
// 3. 時間更新邏輯
// =======================
const updateTime = () => {
  currentTime.value = new Date().toLocaleString('zh-TW', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
  })
}

// =======================
// 4. 資料獲取與處理
// =======================
const fetchStats = async () => {
  loading.value = true
  try {
    const [spotsRes, seatsRes, membersRes, rentalsRes, ticketsRes] = await Promise.all([
      axios.get('/api/spot/list'),
      axios.get('/api/seats'),
      axios.get('/api/members'),
      axios.get('/api/rent-details/all'),
      axios.get('/api/maintenance/tickets/active'),
    ])

    // 基礎數據
    stats.value.totalSpots = spotsRes.data?.length || 0
    stats.value.totalSeats = seatsRes.data?.length || 0
    stats.value.maintenanceCount = (ticketsRes.data || []).length
    stats.value.totalMembers = membersRes.data?.length || 0
    stats.value.activeRentals = (rentalsRes.data || []).filter(
      (r) => r.recStatus === '租借中',
    ).length

    // 圖表數據處理
    const rawRentals = rentalsRes.data || []

    // (A) 每日營收
    const dailyMap = {}
    rawRentals.forEach((item) => {
      const dateKey = item.recRentDT2 ? item.recRentDT2.split('T')[0] : 'Unknown'
      const price = item.recPrice || 0
      if (!dailyMap[dateKey]) dailyMap[dateKey] = 0
      dailyMap[dateKey] += price
    })
    const sortedDates = Object.keys(dailyMap).sort()
    const dailyAmounts = sortedDates.map((date) => dailyMap[date])

    revenueOptions.value = { ...revenueOptions.value, xaxis: { categories: sortedDates } }
    revenueSeries.value = [{ name: '當日營收', data: dailyAmounts }]

    // (B) 熱門站點
    const spotCountMap = {}
    rawRentals.forEach((item) => {
      const spotName = item.rentSpotName || '未知站點'
      spotCountMap[spotName] = (spotCountMap[spotName] || 0) + 1
    })
    const sortedSpots = Object.entries(spotCountMap)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 5)

    const topSpotNames = sortedSpots.map((entry) => entry[0])
    const topSpotCounts = sortedSpots.map((entry) => entry[1])

    spotOptions.value = { ...spotOptions.value, xaxis: { categories: topSpotNames } }
    spotSeries.value = [{ name: '租借次數', data: topSpotCounts }]
  } catch (error) {
    console.error('統計載入失敗:', error)
  } finally {
    loading.value = false
  }
}

// =======================
// 5. 模組定義
// =======================
const moduleGroups = [
  {
    title: '場地與座位管理',
    icon: 'fas fa-building',
    modules: [
      {
        name: '據點管理',
        desc: '管理各區域據點',
        icon: 'fas fa-map-marker-alt',
        path: '/admin/spot/list',
      },
      { name: '座位管理', desc: '座位配置與狀態', icon: 'fas fa-chair', path: '/admin/seat/list' },
      {
        name: '據點分析',
        desc: '關鍵統計圖表',
        icon: 'fas fa-chart-line',
        path: '/admin/spot/analyze',
      },
      {
        name: '調度中心',
        desc: '即時監控與調度',
        icon: 'fas fa-broadcast-tower',
        path: '/admin/spot/monitor',
      },
    ],
  },
  {
    title: '會員與權限管理',
    icon: 'fas fa-users-cog',
    modules: [
      { name: '會員列表', desc: '一般會員資料管理', icon: 'fas fa-users', path: '/admin/members' },
      {
        name: '管理員列表',
        desc: '後台權限設定',
        icon: 'fas fa-user-shield',
        path: '/admin/admins',
      },
    ],
  },
  {
    title: '商家與優惠管理',
    icon: 'fas fa-store',
    modules: [
      {
        name: '商家管理',
        desc: '合作商家資料',
        icon: 'fas fa-store-alt',
        path: '/admin/merchants',
      },
      {
        name: '優惠券管理',
        desc: '發放與管理優惠券',
        icon: 'fas fa-ticket-alt',
        path: '/admin/discounts',
      },
      {
        name: '兌換紀錄',
        desc: '點數兌換報表',
        icon: 'fas fa-clipboard-list',
        path: '/admin/redemption-logs',
      },
    ],
  },
  {
    title: '租借與訂單管理',
    icon: 'fas fa-file-invoice-dollar',
    modules: [
      {
        name: '統計圖表',
        desc: '營收與租借分析',
        icon: 'fas fa-chart-pie',
        path: '/admin/rec-chart',
      },
      { name: '訂單管理', desc: '查詢歷史訂單', icon: 'fas fa-list-alt', path: '/admin/rec-rent' },
    ],
  },
  {
    title: '維護與工單管理',
    icon: 'fas fa-tools',
    modules: [
      {
        name: '維護人員管理',
        desc: '人員排班與資料',
        icon: 'fas fa-user-cog',
        path: '/admin/staff-list',
      },
      {
        name: '維修工單管理',
        desc: '追蹤維修進度',
        icon: 'fas fa-wrench',
        path: '/admin/mtif-list',
      },
      {
        name: '定期排程管理',
        desc: '自動化維護排程',
        icon: 'fas fa-calendar-alt',
        path: '/admin/maintenance/schedule',
      },
    ],
  },
]

// =======================
// 6. 生命週期
// =======================
onMounted(() => {
  updateTime()
  timeInterval.value = setInterval(updateTime, 1000)
  fetchStats()
})

onUnmounted(() => {
  if (timeInterval.value) clearInterval(timeInterval.value)
})
</script>

<template>
  <div class="dashboard-container">
    <div class="particles-container">
      <div class="particle" v-for="n in 30" :key="n"></div>
    </div>

    <main class="dashboard-inner fade-in-up">
      <header class="header-section">
        <div class="header-left">
          <h1>{{ adminName }} <span class="wave"></span></h1>
          <p class="subtitle">Take@Seat 營運控制中心</p>
        </div>
        <div class="header-right">
          <div class="time-pill">
            <span class="pulse-dot"></span>
            {{ currentTime }}
          </div>
        </div>
      </header>

      <section class="stats-section">
        <div class="stat-card">
          <div class="icon-circle blue-bg"><i class="fas fa-map-marker-alt"></i></div>
          <div class="stat-content">
            <span class="stat-num">{{ loading ? '...' : stats.totalSpots }}</span>
            <span class="stat-label">營運據點</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="icon-circle purple-bg"><i class="fas fa-chair"></i></div>
          <div class="stat-content">
            <span class="stat-num">{{ loading ? '...' : stats.totalSeats }}</span>
            <span class="stat-label">資產總數</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="icon-circle red-bg"><i class="fas fa-tools"></i></div>
          <div class="stat-content">
            <span class="stat-num">{{ loading ? '...' : stats.maintenanceCount }}</span>
            <span class="stat-label">維護案量</span>
          </div>
          <div class="alert-dot" v-if="stats.maintenanceCount > 0"></div>
        </div>

        <div class="stat-card">
          <div class="icon-circle green-bg"><i class="fas fa-broadcast-tower"></i></div>
          <div class="stat-content">
            <span class="stat-num">{{ loading ? '...' : stats.activeRentals }}</span>
            <span class="stat-label">即時租借</span>
          </div>
        </div>
      </section>

      <section class="charts-section">
        <div class="chart-wrapper">
          <div class="section-header">
            <h3><i class="fas fa-chart-area"></i> 營收趨勢分析</h3>
            <span class="badge-soft">近 7 日</span>
          </div>
          <apexchart
            type="area"
            height="350"
            :options="revenueOptions"
            :series="revenueSeries"
          ></apexchart>
        </div>

        <div class="chart-wrapper">
          <div class="section-header">
            <h3><i class="fas fa-chart-bar"></i> 熱門站點排行</h3>
            <span class="badge-soft">Top 5</span>
          </div>
          <apexchart
            type="bar"
            height="350"
            :options="spotOptions"
            :series="spotSeries"
          ></apexchart>
        </div>
      </section>

      <section class="modules-section">
        <div v-for="(group, gIndex) in moduleGroups" :key="gIndex" class="module-group-box">
          <div class="group-header">
            <i :class="group.icon"></i>
            <span>{{ group.title }}</span>
          </div>

          <div class="module-grid">
            <div
              v-for="(mod, mIndex) in group.modules"
              :key="mIndex"
              class="module-btn"
              @click="router.push(mod.path)"
            >
              <div class="mod-icon">
                <i :class="mod.icon"></i>
              </div>
              <div class="mod-info">
                <h4>{{ mod.name }}</h4>
                <span>{{ mod.desc }}</span>
              </div>
              <i class="fas fa-chevron-right arrow-icon"></i>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>
</template>

<style scoped>
/* =========================================
   1. Layout 適配修正
   ========================================= */
.dashboard-container {
  /* 🔥 移除 min-height: 100vh，因為外層 AdminLayout 已經有高度 */
  width: 100%;
  background-color: #f8fafc; /* 確保有底色 */
  color: #0f172a;
  position: relative;
  /* 給一點內距，讓內容不要貼死邊緣 */
  padding: 1.5rem;
  overflow: hidden; /* 防止內部粒子溢出 */
}

/* ✅ 改名為 dashboard-inner，不再與 AdminLTE 的 content-wrapper 衝突 */
.dashboard-inner {
  position: relative;
  z-index: 2;
  width: 100%;
  margin: 0;
  padding: 0;
}

/* =========================================
   2. 粒子特效 (改為 absolute)
   ========================================= */
.particles-container {
  position: absolute; /* 🔥 改為 absolute，只佔滿 dashboard-container */
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 0;
  overflow: hidden;
}

.particle {
  position: absolute;
  width: 6px;
  height: 6px;
  background: rgba(59, 130, 246, 0.4);
  border-radius: 50%;
  animation: float 20s infinite linear;
  opacity: 0.6;
}

.particle:nth-child(even) {
  background: rgba(16, 185, 129, 0.3);
  width: 8px;
  height: 8px;
  animation-duration: 25s;
}
.particle:nth-child(3n) {
  background: rgba(245, 158, 11, 0.3);
  width: 4px;
  height: 4px;
  animation-duration: 18s;
}

/* 隨機分佈 */
.particle:nth-child(1) {
  top: 10%;
  left: 5%;
}
.particle:nth-child(2) {
  top: 20%;
  left: 85%;
}
.particle:nth-child(3) {
  top: 80%;
  left: 15%;
}
.particle:nth-child(4) {
  top: 50%;
  left: 50%;
}
.particle:nth-child(5) {
  top: 30%;
  left: 10%;
}
.particle:nth-child(6) {
  top: 60%;
  left: 90%;
}
/* ...更多省略 */

@keyframes float {
  0% {
    transform: translateY(0) rotate(0deg);
    opacity: 0.3;
  }
  50% {
    transform: translateY(-100px) rotate(180deg);
    opacity: 0.8;
  }
  100% {
    transform: translateY(0) rotate(360deg);
    opacity: 0.3;
  }
}

/* =========================================
   3. UI 元件
   ========================================= */
.header-section {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2rem;
}

.header-left h1 {
  font-size: 1.75rem;
  font-weight: 800;
  color: #1e293b;
  margin: 0;
}
.subtitle {
  color: #64748b;
  margin-top: 0.25rem;
  font-size: 0.95rem;
}
.time-pill {
  background: white;
  padding: 0.6rem 1.2rem;
  border-radius: 99px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 600;
  color: #475569;
  font-size: 0.9rem;
}
.pulse-dot {
  width: 8px;
  height: 8px;
  background: #22c55e;
  border-radius: 50%;
  box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
  animation: pulse 2s infinite;
}

/* 統計卡片 Grid */
.stats-section {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.stat-card {
  background: white;
  border-radius: 12px;
  padding: 1.5rem;
  box-shadow:
    0 1px 3px 0 rgba(0, 0, 0, 0.05),
    0 1px 2px -1px rgba(0, 0, 0, 0.03);
  display: flex;
  align-items: center;
  gap: 1.25rem;
  transition:
    transform 0.2s,
    box-shadow 0.2s;
  position: relative;
}
.stat-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

.icon-circle {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.4rem;
  flex-shrink: 0;
}
.blue-bg {
  background: #eff6ff;
  color: #3b82f6;
}
.purple-bg {
  background: #f5f3ff;
  color: #8b5cf6;
}
.red-bg {
  background: #fef2f2;
  color: #ef4444;
}
.green-bg {
  background: #f0fdf4;
  color: #22c55e;
}

.stat-content {
  display: flex;
  flex-direction: column;
}
.stat-num {
  font-size: 1.8rem;
  font-weight: 800;
  color: #0f172a;
  line-height: 1.1;
}
.stat-label {
  font-size: 0.9rem;
  color: #64748b;
  margin-top: 2px;
}
.alert-dot {
  position: absolute;
  top: 15px;
  right: 15px;
  width: 8px;
  height: 8px;
  background: #ef4444;
  border-radius: 50%;
  animation: pulse 1s infinite;
}

/* 圖表 Grid */
.charts-section {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.chart-wrapper {
  background: white;
  border-radius: 12px;
  padding: 1.5rem;
  box-shadow:
    0 1px 3px 0 rgba(0, 0, 0, 0.05),
    0 1px 2px -1px rgba(0, 0, 0, 0.03);
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}
.section-header h3 {
  font-size: 1.1rem;
  font-weight: 700;
  color: #334155;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}
.badge-soft {
  background: #f1f5f9;
  color: #64748b;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 600;
}

/* =========================================
   4. 模組區 - 分箱佈局 (Modules)
   ========================================= */
.modules-section {
  display: grid;
  /* 🔥 [關鍵] 大螢幕雙欄，中螢幕單欄 */
  grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
  gap: 1.5rem;
}

/* 這是您要的「獨立 Box」 */
.module-group-box {
  background: white;
  border-radius: 12px;
  padding: 1.5rem;
  box-shadow:
    0 1px 3px 0 rgba(0, 0, 0, 0.05),
    0 1px 2px -1px rgba(0, 0, 0, 0.03);
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.group-header {
  display: flex;
  align-items: center;
  gap: 0.8rem;
  font-size: 1.1rem;
  font-weight: 700;
  color: #334155;
  padding-bottom: 0.8rem;
  border-bottom: 1px solid #f1f5f9;
}
.group-header i {
  color: #3b82f6;
  font-size: 1.2rem;
}

/* 按鈕 Grid */
.module-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 1rem;
}

.module-btn {
  background: #f8fafc;
  border-radius: 10px;
  padding: 1rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 1rem;
  transition: all 0.2s;
  border: 1px solid transparent;
}
.module-btn:hover {
  background: white;
  border-color: #3b82f6;
  box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.1);
  transform: translateY(-2px);
}

.mod-icon {
  width: 40px;
  height: 40px;
  background: white;
  color: #64748b;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.1rem;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
  transition: 0.2s;
}
.module-btn:hover .mod-icon {
  background: #3b82f6;
  color: white;
}

.mod-info {
  flex: 1;
}
.mod-info h4 {
  margin: 0;
  font-size: 0.95rem;
  font-weight: 600;
  color: #1e293b;
}
.mod-info span {
  font-size: 0.75rem;
  color: #94a3b8;
  display: block;
  margin-top: 2px;
}

.arrow-icon {
  font-size: 0.8rem;
  color: #cbd5e1;
  transition: 0.2s;
}
.module-btn:hover .arrow-icon {
  color: #3b82f6;
  transform: translateX(3px);
}

/* 動畫 */
.fade-in-up {
  animation: fadeInUp 0.6s ease-out forwards;
  opacity: 0;
  transform: translateY(15px);
}
@keyframes fadeInUp {
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
@keyframes pulse {
  0% {
    opacity: 1;
  }
  50% {
    opacity: 0.5;
  }
  100% {
    opacity: 1;
  }
}
@keyframes wave-animation {
  0%,
  100% {
    transform: rotate(0deg);
  }
  50% {
    transform: rotate(15deg);
  }
}
.wave {
  display: inline-block;
  animation: wave-animation 2.5s infinite;
  transform-origin: 70% 70%;
}

/* RWD */
@media (max-width: 768px) {
  .charts-section {
    grid-template-columns: 1fr;
  }
  .modules-section {
    grid-template-columns: 1fr;
  }
}
</style>
</file>

<file path="frontend/src/views/member/AdminListView.vue">
<script setup>
import { ref, onMounted, computed } from 'vue'
import { useRouter } from 'vue-router'
import axios from 'axios'
import Swal from 'sweetalert2'
import { useAdminAuthStore } from '@/stores/adminAuth'

const router = useRouter()
const admins = ref([])
const keyword = ref('')
const loading = ref(false)
const authStore = useAdminAuthStore()

const showRoleModal = ref(false)
const adminToEditRole = ref(null)
const selectedRole = ref(1)

// --- 分頁控制 ---
const currentPage = ref(1)
const pageSize = 5

// --- 統計數據邏輯 --- 
const totalAdmins = computed(() => 
  admins.value.filter(a => a.admStatus === 1).length
)
const superAdmins = computed(() => 
  admins.value.filter(a => a.admRole === 9 && a.admStatus === 1).length
)
const normalAdmins = computed(() => 
  admins.value.filter(a => a.admRole === 1 && a.admStatus === 1).length
)

// --- 狀態切換與停權彈窗 ---
const filterStatus = ref(1) // 1: 啟用, 0: 停用
const showBanModal = ref(false)
const banReason = ref('')
const adminToBan = ref(null)

// 取得管理員
const fetchAdmins = async () => {
  loading.value = true
  try {
    const res = await axios.get('http://localhost:8080/admins')
    admins.value = res.data
    currentPage.value = 1
  } catch (error) {
    Swal.fire({
      icon: 'error',
      title: '載入失敗',
      text: '取得管理員資料失敗',
      confirmButtonColor: '#ff4d4f'
    })
  } finally {
    loading.value = false
  }
}

// 過濾與分頁 (狀態過濾)
const filteredAdmins = computed(() => {
  return admins.value.filter(a => a.admStatus === filterStatus.value)
})

const paginatedAdmins = computed(() => {
  const start = (currentPage.value - 1) * pageSize
  return filteredAdmins.value.slice(start, start + pageSize)
})

const totalPages = computed(() => {
  return Math.ceil(filteredAdmins.value.length / pageSize) || 1
})

// 模糊搜尋
const searchAdmins = async () => {
  if (!keyword.value.trim()) {
    fetchAdmins()
    return
  }
  loading.value = true
  try {
    const res = await axios.get('http://localhost:8080/admins/search', {
      params: { keyword: keyword.value.trim() }
    })
    
    if (res.data.length === 0) {
      Swal.fire({
        icon: 'warning',
        title: '找不到資料',
        text: `找不到與「${keyword.value}」相關的管理員`,
        confirmButtonColor: '#f39c12'
      })
    } else {
      admins.value = res.data
      currentPage.value = 1
      Swal.fire({
        icon: 'success',
        title: '搜尋成功',
        text: `找到 ${res.data.length} 筆符合的管理員資料`,
        timer: 1500,
        showConfirmButton: false
      })
    }
  } catch (error) {
    Swal.fire({ 
      icon: 'error', 
      title: '搜尋發生錯誤' 
    })
  } finally {
    loading.value = false
  }
}


// --- 權限檢查邏輯 ---
const checkPermission = (actionCallback) => {
  const role = authStore.admin?.admRole || authStore.admin?.role;
  if (Number(role) === 9) {
    actionCallback();
  } else {
    Swal.fire({
      icon: 'lock',
      title: '權限不足',
      text: '您目前是一般管理員，無法執行此操作。',
      confirmButtonColor: '#ff4d4f'
    });
  }
};

// 停權操作
const openBanModal = (admin) => {
  adminToBan.value = admin
  banReason.value = ''
  showBanModal.value = true
}

const confirmBanAdmin = async () => {
  if (!banReason.value.trim()) {
    Swal.fire({ icon: 'warning', title: '請輸入原因', confirmButtonColor: '#f39c12' })
    return
  }
  try {
    // 假設後端 API 為 /admins/ban，並將狀態改為 0
    await axios.post('http://localhost:8080/admins/ban', {
      admId: adminToBan.value.admId,
      reason: banReason.value
    })
    showBanModal.value = false
    Swal.fire({ icon: 'success', title: '該管理員已停職', timer: 1500, showConfirmButton: false })
    fetchAdmins()
  } catch (error) {
    Swal.fire({ icon: 'error', title: '操作失敗' })
  }
}

// 恢復啟用
const activateAdmin = async (admin) => {
  const result = await Swal.fire({
    title: '確定要重新啟用嗎？',
    text: `將恢復管理員：${admin.admName} 的存取權限`,
    icon: 'question',
    showCancelButton: true,
    confirmButtonColor: '#52c41a',
    cancelButtonColor: '#8c8c8c',
    confirmButtonText: '確定啟用',
    cancelButtonText: '取消'
  })

  if (result.isConfirmed) {
    try {
      await axios.post('http://localhost:8080/admins/activate', { admId: admin.admId })
      Swal.fire({ icon: 'success', title: '已恢復啟用', timer: 1500, showConfirmButton: false })
      fetchAdmins()
    } catch (error) {
      Swal.fire({ icon: 'error', title: '恢復失敗' })
    }
  }
}

const formatDate = (dt) => {
  if (!dt) return ''
  return dt.substring(0, 10).replace(/-/g, '/')
}

const getAvatar = (id) => {
  if (id >= 1 && id <= 10) {
    const fileName = String(id).padStart(2, '0')
    return `/admin/${fileName}.jpg`
  }
  return '/admin/default.png'
}

// 開啟彈窗
const openRoleModal = (admin) => {
  adminToEditRole.value = admin
  selectedRole.value = admin.admRole
  showRoleModal.value = true
}

// 儲存變更並跳出 SweetAlert 確認
const handleUpdateRole = async () => {
  const result = await Swal.fire({
    title: '確定要變更權限嗎？',
    text: `將管理員「${adminToEditRole.value.admName}」的角色變更為：${selectedRole.value === 9 ? '超級管理員' : '一般管理員'}`,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#1890ff',
    cancelButtonColor: '#8c8c8c',
    confirmButtonText: '確定更新',
    cancelButtonText: '取消'
  })

  if (result.isConfirmed) {
    try {
      await axios.post(`http://localhost:8080/admins/${adminToEditRole.value.admId}/role`, {
        admRole: selectedRole.value
      })
      showRoleModal.value = false
      Swal.fire({ icon: 'success', title: '權限已更新', timer: 1500, showConfirmButton: false })
      fetchAdmins() // 重新整理列表
    } catch (error) {
      Swal.fire({ icon: 'error', title: '更新失敗' })
    }
  }
}

onMounted(fetchAdmins)
</script>

<template>
  <div class="admin-main-container">
      <div class="header-info-card">
        <div class="header-icon">
          <i class="fas fa-user-shield"></i>
        </div>
        <div class="header-content">
          <h2>管理員列表</h2>
          <p>管理系統管理員帳號與權限</p>
        </div>
      </div>

      <div class="statistics-row">
        <div class="stat-item blue-left">
          <div class="stat-icon-box bg-blue-icon">
            <i class="fas fa-users"></i>
          </div>
          <div class="stat-data">
            <div class="stat-value">{{ totalAdmins }}</div>
            <div class="stat-label">管理員總數</div>
          </div>
        </div>
        <div class="stat-item red-left">
          <div class="stat-icon-box bg-red-icon">
            <i class="fas fa-crown"></i>
          </div>
          <div class="stat-data">
            <div class="stat-value">{{ superAdmins }}</div>
            <div class="stat-label">超級管理員</div>
          </div>
        </div>
        <div class="stat-item green-left">
          <div class="stat-icon-box bg-green-icon">
            <i class="fas fa-user-tie"></i>
          </div>
          <div class="stat-data">
            <div class="stat-value">{{ normalAdmins }}</div>
            <div class="stat-label">一般管理員</div>
          </div>
        </div>
      </div>

    <div class="search-filter-bar">
      <div class="search-input-group">
        <div class="icon-input-wrap">
          <i class="fas fa-search"></i>
          <input
            v-model="keyword"
            type="text"
            placeholder="搜尋帳號 / 姓名 / Email"
            @keyup.enter="searchAdmins"
          />
        </div>
        <button class="btn-action-search" @click="searchAdmins">
          <i class="fas fa-search"></i> 搜尋
        </button>
        <button class="btn-action-all" @click="fetchAdmins">
          <i class="fas fa-sync-alt"></i> 顯示全部
        </button>
      </div>

      <div class="action-right-group">
        <div class="status-toggle-group">
          <button 
            class="toggle-btn" 
            :class="{ active: filterStatus === 1 }" 
            @click="filterStatus = 1"
          >啟用員工</button>
          <button 
            class="toggle-btn" 
            :class="{ active: filterStatus === 0 }" 
            @click="filterStatus = 0"
          >停職員工</button>
        </div>
        <button class="btn-add-admin" @click="checkPermission(() => router.push('/admin/admins/create'))">
          <i class="fas fa-plus"></i> 新增管理員
        </button>
      </div>
    </div>

    <div class="table-wrapper-card">
      <table class="data-list-table">
        <thead>
          <tr>
            <th class="col-w-id">ID</th>
            <th class="col-w-info">管理員資訊</th>
            <th class="col-w-email">Email</th>
            <th class="col-w-role">權限</th>
            <th class="col-w-date">到職日</th>
            <th class="col-w-date">{{ filterStatus === 1 ? '更新時間' : '停職日' }}</th>
            <th class="col-w-btn">操作</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="a in paginatedAdmins" :key="a.admId">
            <td>{{ a.admId }}</td>
            <td class="align-left">
              <div class="user-info-flex">
                <div class="avatar-box">
                  <img :src="getAvatar(a.admId)" />
                </div>
                <div class="name-account-stack">
                  <span class="full-name">{{ a.admName }}</span>
                  <span class="account-tag">@{{ a.admUsername }}</span>
                </div>
              </div>
            </td>
            <td class="align-left">{{ a.admEmail }}</td>
            <td>
              <span 
                class="role-badge" 
                :class="a.admRole === 9 ? 'role-super' : 'role-normal'"
                @click="checkPermission(() => openRoleModal(a))" 
                style="cursor: pointer;"
              >
                {{ a.admRole === 9 ? '超級管理員' : '一般管理員' }}
                <i class="fas fa-edit" style="font-size: 10px; margin-left: 4px;"></i>
              </span>
            </td>
            <td>{{ formatDate(a.createdAt) }}</td>
            <td>{{ formatDate(a.updatedAt) }}</td>
            <td>
              <div class="op-button-group">
                <template v-if="filterStatus === 1">
                  <button class="btn-op-edit" @click="checkPermission(() => router.push(`/admin/admins/edit/${a.admId}`))">修改</button>
                  <button class="btn-op-stop" @click="checkPermission(() => openBanModal(a))">停職</button>
                </template>
                <template v-else>
                  <button class="btn-box-active" @click="checkPermission(() => activateAdmin(a))">啟用</button>
                </template>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="page-control-footer" v-if="filteredAdmins.length > pageSize">
      <button class="page-nav-btn" :disabled="currentPage === 1" @click="currentPage--">上一頁</button>
      <span class="page-current-info">第 {{ currentPage }} / {{ totalPages }} 頁</span>
      <button class="page-nav-btn" :disabled="currentPage === totalPages" @click="currentPage++">下一頁</button>
    </div>

    <div v-if="showBanModal" class="modal-overlay" @click.self="showBanModal = false">
      <div class="ban-card">
        <div class="ban-header">
          <span>管理員停職處理</span>
          <button class="close-x" @click="showBanModal = false">&times;</button>
        </div>
        <div class="ban-body">
          <label>停職原因 <span class="required">*</span></label>
          <textarea v-model="banReason" placeholder="請詳細輸入停職原因..."></textarea>
          <div class="ban-warning">
            <i class="fas fa-exclamation-triangle"></i> 注意：停職後該帳號將無法登入後台系統。
          </div>
        </div>
        <div class="ban-footer">
          <button class="btn-close-modal" @click="showBanModal = false">取消</button>
          <button class="btn-confirm-ban" @click="confirmBanAdmin">確認停職</button>
        </div>
      </div>
    </div>
  </div>
  <div v-if="showRoleModal" class="modal-overlay" @click.self="showRoleModal = false">
    <div class="ban-card" style="width: 350px;"> <div class="ban-header" style="background: #1890ff;">
        <span>編輯 {{ adminToEditRole.admName }} 的職位</span>
        <button class="close-x" @click="showRoleModal = false">&times;</button>
      </div>
      <div class="ban-body">
        <p style="color: #909399; font-size: 14px; margin-bottom: 15px;">請勾選要指派給此員工的職位：</p>
        <div style="display: flex; flex-direction: column; gap: 12px;">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="radio" v-model="selectedRole" :value="9"> 超級管理員 (ADMIN)
          </label>
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="radio" v-model="selectedRole" :value="1"> 一般管理員 (EMPLOYEE)
          </label>
        </div>
      </div>
      <div class="ban-footer">
        <button class="btn-close-modal" @click="showRoleModal = false">取消</button>
        <button class="btn-confirm-ban" style="background: #1890ff;" @click="handleUpdateRole">儲存變更</button>
      </div>
    </div>
  </div>
</template>

<style scoped>
.admin-main-container {
  padding: 24px;
  background-color: #f5f7fa;
  min-height: 100vh;
}

.header-info-card {
  display: flex;
  align-items: center;
  gap: 16px;
  background-color: #ffffff;
  padding: 20px 24px;
  border-radius: 16px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
  margin-bottom: 24px;
}

.header-icon {
  width: 56px;
  height: 56px;
  background-color: #e8f4ff;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  color: #1890ff;
}

.header-content h2 {
  margin: 0;
  font-size: 22px;
  color: #303133;
}

.header-content p {
  margin: 4px 0 0 0;
  color: #909399;
  font-size: 14px;
}

/* 統計卡片容器：控制三欄等寬 */
.statistics-row {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 20px;
  margin-bottom: 24px;
}

/* 單個統計項目 */
.stat-item {
  background-color: #ffffff;
  border-radius: 16px;
  padding: 20px;
  display: flex;
  align-items: center;
  gap: 16px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
  border-left-width: 5px;
  border-left-style: solid;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.stat-item:hover {
  transform: translateY(-5px);
  box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
}

/* 左側邊框顏色 */
.blue-left { 
  border-left-color: #1890ff; 
}

.red-left { 
  border-left-color: #ff4d4f; 
}

.green-left { 
  border-left-color: #52c41a; 
}

.stat-icon-box {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #ffffff;
  font-size: 20px;
}

.bg-blue-icon { 
  background-color: #1890ff; 
}

.bg-red-icon { 
  background-color: #ff4d4f; 
}

.bg-green-icon { 
  background-color: #52c41a; 
}

.stat-value {
  font-size: 26px;
  font-weight: 700;
  color: #303133;
}

.search-filter-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background-color: #ffffff;
  padding: 16px 20px;
  border-radius: 12px;
  margin-bottom: 24px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

.search-input-group {
  display: flex;
  gap: 12px;
}

.icon-input-wrap {
  position: relative;
}

.icon-input-wrap i {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: #c0c4cc;
}

.icon-input-wrap input {
  padding: 10px 12px 10px 36px;
  border: 1px solid #dcdfe6;
  border-radius: 8px;
  width: 300px;
}

.action-right-group {
  display: flex;
  align-items: center;
  gap: 16px;
}

.status-toggle-group {
  display: flex;
  border: 1px solid #1890ff;
  border-radius: 8px;
  overflow: hidden;
}

.toggle-btn {
  padding: 8px 16px;
  border: none;
  background: white;
  color: #1890ff;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s;
}

.toggle-btn.active {
  background: #1890ff;
  color: white;
}

.btn-action-search,
.btn-action-all,
.btn-add-admin,
.btn-op-edit,
.btn-op-stop,
.btn-box-active,
.page-nav-btn {
  transition: all 0.2s ease;
  cursor: pointer;
  outline: none;
}

.btn-action-search:hover,
.btn-action-all:hover,
.btn-add-admin:hover,
.btn-op-edit:hover,
.btn-op-stop:hover,
.btn-box-active:hover,
.page-nav-btn:hover:not(:disabled), 
.role-badge:hover{
  filter: brightness(1.1);
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.btn-action-search:active,
.btn-add-admin:active,
.btn-op-stop:active {
  transform: scale(0.95);
}

.btn-add-admin {
  background-color: #52c41a;
  color: #ffffff;
  border: none;
  padding: 10px 20px;
  border-radius: 8px;
}

.btn-action-search {
  background-color: #1890ff;
  color: white;
  border: none;
  padding: 0 20px;
  border-radius: 8px;
}

.btn-action-all {
  background-color: #52c41a;
  color: white;
  border: none;
  padding: 0 20px;
  border-radius: 8px;
}

.table-wrapper-card {
  background-color: #ffffff;
  border-radius: 16px;
  padding: 16px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

.data-list-table {
  width: 100%;
  border-collapse: collapse;
}

.data-list-table th {
  background-color: #f8f9fb;
  padding: 16px;
  color: #606266;
  border-bottom: 1px solid #ebeef5;
}

.data-list-table td {
  padding: 16px;
  text-align: left;
  border-bottom: 1px solid #ebeef5;
}

.user-info-flex {
  display: flex;
  align-items: center;
  gap: 12px;
}

.avatar-box img {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  object-fit: cover;
}

.name-account-stack {
  display: flex;
  flex-direction: column;
}

.full-name {
  font-weight: 600;
}

.account-tag {
  font-size: 12px;
  color: #909399;
}

.role-badge {
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  color: white;
  transition: all 0.2s ease;
  cursor: pointer;
}

.role-super {
  background: linear-gradient(135deg, #f56c6c 0%, #ff8e8e 100%);
}

.role-normal {
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
}

.op-button-group {
  display: flex;
  gap: 8px;
}

.btn-op-edit {
  background-color: #1890ff;
  color: white;
  border: none;
  padding: 6px 14px;
  border-radius: 6px;
}

.btn-op-stop {
  background-color: #ff4d4f;
  color: white;
  border: none;
  padding: 6px 14px;
  border-radius: 6px;
}

.btn-box-active {
  background-color: #52c41a;
  color: white;
  border: none;
  padding: 6px 14px;
  border-radius: 6px;
}

.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 2000;
}

.ban-card {
  background: white;
  width: 450px;
  border-radius: 12px;
  overflow: hidden;
}

.ban-header {
  background: #f39c12;
  padding: 15px 20px;
  display: flex;
  justify-content: space-between;
  color: white;
  font-weight: bold;
}

.ban-body {
  padding: 20px;
}

.ban-body textarea {
  width: 100%;
  height: 120px;
  margin-top: 10px;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 4px;
  resize: none;
}

.ban-warning {
  margin-top: 15px;
  background: #fff9db;
  padding: 10px;
  border-radius: 4px;
  font-size: 13px;
  color: #856404;
}

.ban-footer {
  padding: 15px 20px;
  text-align: right;
  border-top: 1px solid #eee;
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

.btn-confirm-ban {
  background: #f44336;
  color: white;
  border: none;
  padding: 8px 20px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s;
}

.btn-confirm-ban:hover {
  background: #d32f2f;
  transform: translateY(-1px);
}

.btn-close-modal {
  padding: 8px 20px;
  background: #909399;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s;
}

.btn-close-modal:hover {
  background: #a6a9ad;
  transform: translateY(-1px);
}

.close-x {
  border: none;
  background: none;
  font-size: 24px;
  cursor: pointer;
  color: #333;
  transition: all 0.2s;
}

.close-x:hover {
  color: #f56c6c;
  transform: rotate(90deg);
}

.required {
  color: red;
}

.page-control-footer {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  gap: 16px;
  margin-top: 24px;
}

.page-nav-btn {
  padding: 8px 16px;
  background-color: #ffffff;
  border: 1px solid #dcdfe6;
  border-radius: 8px;
}
</style>
</file>

<file path="frontend/src/views/rec/RecRentMgnPage.vue">
<script setup>
import { ref } from 'vue'
import axios from 'axios'
import RecRentSearch from '@/components/rec/RecRentSearch.vue'
import RecRentAdd from '@/components/rec/RecRentAdd.vue'
import RecRentEdit from '@/components/rec/RecRentEdit.vue' // 1. 引入 Edit 組件
import Swal from 'sweetalert2'

// --- 1. 狀態定義 ---
const activeView = ref('list') // 'list', 'add', 'edit'
const editingRent = ref(null) // Holds the data for the rent being edited
const searchComponent = ref(null) // Ref to access the search component instance
const API_URL = 'http://localhost:8080/rec-rent'

// --- 2. 核心邏輯 ---

// 新增或更新 (Create / Update)
const handleSaveRent = async (formData) => {
  try {
    // [修正] 依據當前視圖模式決定 HTTP 方法與 URL
    // 避免因為新增時填寫了 recId 而誤判為 PUT 請求
    let method = 'post'
    let url = `${API_URL}/new` // 對應 Controller 的 @PostMapping("/new")

    if (activeView.value === 'edit') {
      method = 'put'
      url = `${API_URL}/${formData.recId}`
    }

    const res = await axios[method](url, formData)
    if (res.status === 200 || res.status === 201) {
      alert(activeView.value === 'edit' ? '更新成功！' : '新增成功！')
      activeView.value = 'list'
      // Use the ref to call the child's method
      if (searchComponent.value) {
        await searchComponent.value.loadRents()
      }
    } else {
      alert('儲存失敗，請檢查輸入資料。')
    }
  } catch (err) {
    console.error('儲存操作失敗:', err)
    alert('儲存失敗，請檢查輸入資料。')
  }
}

// 刪除 (Delete)
const handleDeleteRent = async (id) => {
  // 使用 SweetAlert2 彈出確認對話框，提供更好的使用者體驗
  const result = await Swal.fire({
    title: `確定要刪除訂單 #${id} 嗎?`,
    text: '此操作無法復原！',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    cancelButtonColor: '#3085d6',
    confirmButtonText: '是的，刪除它！',
    cancelButtonText: '取消',
  })

  // 如果使用者沒有確認，則中止操作
  if (!result.isConfirmed) {
    return
  }

  try {
    // 呼叫後端 API 執行刪除，使用標準的 RESTful 風格 URL
    const res = await axios.delete(`${API_URL}/${id}`)
    
    // 檢查回應狀態碼，200 (OK) 或 204 (No Content) 都代表成功
    if (res.status === 200 || res.status === 204) {
      await Swal.fire('已刪除！', `訂單 #${id} 已成功刪除。`, 'success')
      // 如果 searchComponent 存在，則呼叫其方法重新載入訂單列表
      if (searchComponent.value) {
        await searchComponent.value.loadRents()
      }
    } else {
      // 若狀態碼不為成功，顯示錯誤
      Swal.fire('刪除失敗', `發生未預期的錯誤，狀態碼: ${res.status}`, 'error')
    }
  } catch (err) {
    console.error('刪除操作失敗:', err)
    // 處理 API 呼叫的錯誤
    const errorMessage = err.response?.data?.message || err.message || '未知錯誤'
    Swal.fire('刪除失敗', `錯誤: ${errorMessage}`, 'error')
  }
}

// --- 3. 視圖切換邏輯 ---

// 準備編輯資料
const handleEditRent = (rent) => {
  editingRent.value = { ...rent }
  activeView.value = 'edit' // 切換到編輯視圖

  // Scroll to top for better user experience
  setTimeout(() => {
    const mainContent = document.querySelector('.main-content')
    if (mainContent) {
      mainContent.scrollTo({ top: 0, behavior: 'smooth' })
    }
  }, 50)
}

// 切換到新增畫面
const goToAddView = () => {
  editingRent.value = null // Clear any editing data
  activeView.value = 'add' // 切換到新增視圖
}

// 取消並返回列表
const backToList = () => {
  editingRent.value = null // Clear any editing data
  activeView.value = 'list'
}
</script>

<template>
  <div class="rec-rent-container">
    <div class="top-nav">
      <button
        @click="backToList"
        :class="{ active: activeView === 'list' }"
        :disabled="activeView === 'list'"
      >
        訂單查詢
      </button>

      <button
        @click="goToAddView"
        :class="{ active: activeView === 'add' }"
        :disabled="activeView === 'add'"
      >
        新增訂單
      </button>
    </div>

    <div class="main-content">
      <h1>訂單管理系統</h1>

      <div v-if="activeView === 'add'" class="view-section">
        <rec-rent-add @save-rent="handleSaveRent" @cancel="backToList" />
      </div>

      <!--  組件的區塊 -->
      <div v-if="activeView === 'edit'" class="view-section">
        <rec-rent-edit
          :initial-data="editingRent"
          @save-rent="handleSaveRent"
          @cancel="backToList"
        />
      </div>

      <div v-if="activeView === 'list'" class="view-section">
        <rec-rent-search
          ref="searchComponent"
          @edit-rent="handleEditRent"
          @delete-rent="handleDeleteRent"
        />
      </div>
    </div>
  </div>
</template>

<style scoped>
/* ========== 主容器 - 淺色背景 ========== */
.rec-rent-container {
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  width: 100%;
  font-family: 'Microsoft JhengHei', Arial, sans-serif;
  background: linear-gradient(180deg, #f0f5fa 0%, #e8eef5 100%);
}

/* ========== 頂部導航 - 淺色風格 ========== */
.top-nav {
  width: 100%;
  background: white;
  display: flex;
  padding: 12px 20px;
  gap: 10px;
  flex-shrink: 0;
  box-shadow: 0 1px 8px rgba(0, 0, 0, 0.04);
}

.top-nav button {
  background: #409eff;
  color: #ffffff;
  font-size: 14px;
  font-weight: 500;
  padding: 10px 22px;
  margin: 0;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.top-nav button:disabled,
.top-nav button.active {
  background: #67c23a;
  color: #fff;
  font-weight: 600;
  cursor: default;
}

.top-nav button:not(:disabled):hover {
  background: #66b1ff;
  transform: translateY(-1px);
}

/* ========== 主內容區 ========== */
.main-content {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
}

/* ========== 標題區 ========== */
.main-content h1 {
  font-size: 1.5rem;
  font-weight: 700;
  color: #303133;
  margin-bottom: 20px;
}

/* ========== 視圖區塊 ========== */
.view-section {
  display: block;
  background: white;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
  transition: all 0.3s ease;
}

.view-section:hover {
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
}
</style>
</file>

<file path="frontend/src/views/rec/VisitSiteReommandPage.vue">
<script setup>
import { ref, onMounted, computed, watch } from 'vue'

const allData = ref([])
const displayData = ref([]) // 用於顯示和隨機排序的資料
const isLoading = ref(true)
const error = ref(null)

const currentPage = ref(1)
const itemsPerPage = 15

// --- 篩選用的狀態 ---
const searchQuery = ref('') // 綁定輸入框
const appliedSearchQuery = ref('') // 實際應用的搜尋關鍵字
const selectedRegion = ref('') // 空字串代表 '所有地區'
const selectedCategory = ref('all') // [新增] 'all', '景點', '餐廳'

// 從指定的 URL 獲取資料
async function fetchDataFromUrl(url) {
  const response = await fetch(url)
  if (!response.ok) {
    throw new Error(`無法從 ${url} 獲取資料: ${response.status} ${response.statusText}`)
  }
  return await response.json()
}

// 獲取所有景點和餐廳資料
async function fetchAllData() {
  isLoading.value = true
  error.value = null

  try {
    const restaurantUrl =
      'https://tdx.transportdata.tw/api/basic/v2/Tourism/Restaurant?%24top=9999&%24format=JSON'
    const scenicSpotUrl =
      'https://tdx.transportdata.tw/api/basic/v2/Tourism/ScenicSpot?%24top=9999&%24format=JSON'

    const [restaurants, scenicSpots] = await Promise.all([
      fetchDataFromUrl(restaurantUrl),
      fetchDataFromUrl(scenicSpotUrl),
    ])

    const formattedRestaurants = restaurants.map((item) => ({
      id: `res_${item.RestaurantID}`,
      name: item.RestaurantName,
      description: item.Description || '暫無描述',
      pictureUrl: item.Picture?.PictureUrl1,
      address: item.Address || '',
      type: '餐廳',
    }))

    const formattedScenicSpots = scenicSpots.map((item) => ({
      id: `spot_${item.ScenicSpotID}`,
      name: item.ScenicSpotName,
      description: item.DescriptionDetail || '暫無描述',
      pictureUrl: item.Picture?.PictureUrl1,
      address: item.Address || '',
      type: '景點',
    }))

    // 恢復為按名稱排序，作為預設順序
    allData.value = [...formattedRestaurants, ...formattedScenicSpots].sort((a, b) =>
      a.name.localeCompare(b.name),
    )
  } catch (e) {
    error.value = e.message
    console.error(e)
  } finally {
    isLoading.value = false
  }
}

// --- 過濾與排序邏輯 ---

// 固定的台灣縣市列表
const uniqueRegions = [
  '臺北市',
  '新北市',
  '桃園市',
  '臺中市',
  '臺南市',
  '高雄市',
  '基隆市',
  '宜蘭縣',
  '花蓮縣',
  '臺東縣',
  '新竹市',
  '新竹縣',
  '苗栗縣',
  '彰化縣',
  '南投縣',
  '雲林縣',
  '嘉義市',
  '嘉義縣',
  '屏東縣',
  '澎湖縣',
  '金門縣',
  '連江縣',
]

// 根據`appliedSearchQuery`和地區篩選資料
const filteredData = computed(() => {
  let data = allData.value

  if (selectedRegion.value) {
    data = data.filter((item) => item.address.startsWith(selectedRegion.value))
  }

  // [新增] 根據類別篩選
  if (selectedCategory.value !== 'all') {
    data = data.filter((item) => item.type === selectedCategory.value)
  }

  if (appliedSearchQuery.value) {
    const query = appliedSearchQuery.value.toLowerCase()
    data = data.filter(
      (item) =>
        item.name.toLowerCase().includes(query) || item.address.toLowerCase().includes(query),
    )
  }
  return data
})

// 監聽篩選結果，並將其同步到 displayData
watch(
  filteredData,
  (newData) => {
    displayData.value = newData
    currentPage.value = 1 // 篩選變更時，重置頁碼
  },
  { immediate: true },
)

// --- 使用者操作 ---

// 應用搜尋
function applySearch() {
  appliedSearchQuery.value = searchQuery.value
}

// 隨機排序當前顯示的列表
function randomizeOrder() {
  const dataToShuffle = [...displayData.value] // 複製以避免直接修改
  // Fisher-Yates 演算法
  for (let i = dataToShuffle.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1))
    ;[dataToShuffle[i], dataToShuffle[j]] = [dataToShuffle[j], dataToShuffle[i]]
  }
  displayData.value = dataToShuffle
  currentPage.value = 1 // 隨機排序後，回到第一頁
}

// UX 優化: 當使用者清空輸入框時，也自動清空篩選結果
watch(searchQuery, (newValue) => {
  if (newValue === '') {
    applySearch()
  }
})

// --- 分頁邏輯 (依賴 displayData) ---

const totalPages = computed(() => {
  return Math.ceil(displayData.value.length / itemsPerPage)
})

const paginatedData = computed(() => {
  const start = (currentPage.value - 1) * itemsPerPage
  const end = start + itemsPerPage
  return displayData.value.slice(start, end)
})

function nextPage() {
  if (currentPage.value < totalPages.value) {
    currentPage.value++
  }
}

function prevPage() {
  if (currentPage.value > 1) {
    currentPage.value--
  }
}

onMounted(() => {
  fetchAllData()
})
</script>

<template>
  <div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="text-center mb-4">
      <h1 class="display-5">在地特色景點與美食餐廳</h1>
      <!-- Data Source Information -->
      <small class="text-muted">資料來源：交通部運輸資料流通服務平臺 (TDX)</small>
    </div>

    <!-- Main Content Card -->
    <div class="card shadow-sm">
      <div class="card-header bg-light">
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
          <!-- Left Controls: Filter and Randomizer -->
          <div class="d-flex flex-wrap gap-2 align-items-center">
            <select class="form-select form-select-sm" v-model="selectedRegion" style="width: auto">
              <option value="">所有地區</option>
              <option v-for="region in uniqueRegions" :key="region" :value="region">
                {{ region }}
              </option></select
            >&nbsp;&nbsp;&nbsp;&nbsp;

            <!-- [新增] 類別篩選按鈕 -->
            <div class="btn-group btn-group-sm" role="group">
              <button
                type="button"
                class="btn"
                :class="selectedCategory === 'all' ? 'btn-primary' : 'btn-outline-primary'"
                @click="selectedCategory = 'all'"
              >
                全部
              </button>
              <button
                type="button"
                class="btn"
                :class="selectedCategory === '景點' ? 'btn-primary' : 'btn-outline-primary'"
                @click="selectedCategory = '景點'"
              >
                景點
              </button>
              <button
                type="button"
                class="btn"
                :class="selectedCategory === '餐廳' ? 'btn-primary' : 'btn-outline-primary'"
                @click="selectedCategory = '餐廳'"
              >
                餐廳
              </button>
            </div>

            <button class="btn btn-success btn-sm" style="margin: 0 12px" @click="randomizeOrder">
              <i class="fas fa-random me-1"></i> 隨機推薦
            </button>
          </div>

          <!-- Right Controls: Search -->
          <div class="flex-grow-1" style="max-width: 300px">
            <form @submit.prevent="applySearch" class="w-100">
              <div class="input-group input-group-sm">
                <input
                  type="text"
                  class="form-control"
                  placeholder="搜尋名稱或地址..."
                  v-model="searchQuery"
                />
                <button class="btn btn-primary" type="submit" style="margin: 0 12px">
                  <i class="fas fa-search"></i>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
      <div class="card-body">
        <!-- Loading State -->
        <div v-if="isLoading" class="text-center py-5">
          <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3 text-muted">資料載入中，請稍候...</p>
        </div>

        <!-- Error State -->
        <div v-else-if="error" class="alert alert-danger text-center">
          <h4><i class="fas fa-exclamation-triangle me-2"></i>資料載入失敗</h4>
          <p>{{ error }}</p>
          <p class="mb-0">請確認您的網路連線是否正常，或稍後再試。</p>
        </div>

        <!-- No Data State -->
        <div v-else-if="!isLoading && paginatedData.length === 0" class="text-center py-5">
          <i class="fas fa-search-minus fa-3x text-muted mb-3"></i>
          <h4>找不到符合條件的資料</h4>
          <p class="text-muted">請嘗試調整或放寬您的篩選條件。</p>
        </div>

        <!-- Data Grid -->
        <div v-else>
          <div class="row g-4">
            <div v-for="item in paginatedData" :key="item.id" class="col-12 col-md-4 g-4">
              <a
                :href="'https://www.google.com/search?q=' + encodeURIComponent(item.name)"
                target="_blank"
                rel="noopener noreferrer"
                class="text-decoration-none"
              >
                <div class="card h-100 recommendation-card">
                  <img
                    :src="item.pictureUrl || 'https://picsum.photos/320?random=' + item.id"
                    class="card-img-top"
                    :alt="item.name"
                    loading="lazy"
                  />
                  <div class="card-body d-flex flex-column">
                    <h5 class="card-title text-dark">
                      {{ item.name }}
                      <div
                        class="badge ms-2"
                        :class="
                          item.type === '景點' ? 'bg-primary text-white' : 'bg-warning text-dark'
                        "
                      >
                        {{ item.type }}
                      </div>
                    </h5>
                    <p class="card-text text-muted small flex-grow-1">
                      {{ item.description.substring(0, 80)
                      }}{{ item.description.length > 80 ? '...' : '' }}
                    </p>
                    <p class="card-text small text-muted">
                      <i class="fas fa-map-marker-alt me-2"></i>{{ item.address }}
                    </p>
                  </div>
                </div>
              </a>
            </div>
          </div>
        </div>
      </div>
      <div class="card-footer bg-light" v-if="!isLoading && paginatedData.length > 0">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
          <!-- Pagination Controls -->
          <nav aria-label="Page navigation">
            <ul class="pagination pagination-sm m-0">
              <li class="page-item" :class="{ disabled: currentPage === 1 }">
                <a class="page-link" href="#" @click.prevent="prevPage">« 上一頁</a>
              </li>
              <li class="page-item disabled">
                <span class="page-link text-dark">第 {{ currentPage }} / {{ totalPages }} 頁</span>
              </li>
              <li class="page-item" :class="{ disabled: currentPage === totalPages }">
                <a class="page-link" href="#" @click.prevent="nextPage">下一頁 »</a>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </div>
</template>

<style scoped>
.recommendation-card {
  transition:
    transform 0.2s ease-in-out,
    box-shadow 0.2s ease-in-out;
  border: 1px solid #e9ecef;
}

.recommendation-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
}

.card-title .badge {
  font-size: 0.8rem;
  vertical-align: middle;
}

.card-img-top {
  height: 250px;
  object-fit: cover;
  border-bottom: 1px solid #dee2e6;
}

/* Font Awesome Icons (if you are using them) */
@import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css');
</style>
</file>

<file path="frontend/src/views/support/SupportCenterView.vue">
<script setup>
import { ref, computed, onMounted, onUnmounted, nextTick } from 'vue'
import { useRouter } from 'vue-router'
import { faqData } from '@/data/supportFaq'
import { useCozeChat } from '@/composables/maintenance/useCozeChat'

const router = useRouter()

// ==================== BEGIN: Coze OpenAPI  ====================
const {
  loading: cozeLoading, // 是否正在載入
  initialized: cozeInitialized, // 是否已初始化完成
  error: cozeError, // 初始化錯誤訊息
  degraded: cozeDegraded, // 是否處於降級模式
  status: cozeStatus, // 目前狀態
  statusText: cozeStatusText, // 目前狀態說明
  retryCount, // 重試次數
  messages, // 對話訊息列表
  sending, // 正在發送訊息
  initCozeChat, // 初始化函式
  sendMessage, // 發送訊息
  manualRetry, // 手動重試
  clearMessages, // 清除訊息
} = useCozeChat()

// 聊天視窗狀態
const chatOpen = ref(false)
const chatInput = ref('')
const messagesContainer = ref(null)

//導頁使用
const pendingIntent = ref(null)

// 開啟聊天視窗
const openChatWindow = () => {
  chatOpen.value = true
  nextTick(() => scrollToBottom())
}

// 關閉聊天視窗
const closeChatWindow = () => {
  chatOpen.value = false
}

// 發送訊息
const handleSendMessage = async () => {
  if (!chatInput.value.trim() || sending.value) return

  const message = chatInput.value.trim()
  chatInput.value = ''

  await sendMessage(message)
  nextTick(() => scrollToBottom())
}

// Enter 送出
const handleKeydown = (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault()
    handleSendMessage()
  }
}

// 捲動到最新訊息
const scrollToBottom = () => {
  if (messagesContainer.value) {
    messagesContainer.value.scrollTop = messagesContainer.value.scrollHeight
  }
}

// 清除對話
const handleClearChat = () => {
  clearMessages()
}

// 格式化時間
const formatTime = (date) => {
  if (!date) return ''
  const d = new Date(date)
  return d.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' })
}

// Quick Questions 統一走這個方法（避免 template 多行語句爆炸）
const sendQuickQuestion = async (text) => {
  if (sending.value) return
  chatInput.value = text
  await handleSendMessage()
}
// ==================== END: Coze OpenAPI 整合 ====================

// ==================== FAQ 相關狀態 ====================
const searchKeyword = ref('')
const activeCategory = ref(faqData[0]?.category || '')
const activeFaqItems = ref([])

/**
 * 【核心功能】搜尋過濾：同時搜尋標題、內容、標籤、關鍵字
 */
const filteredFaqData = computed(() => {
  const keyword = searchKeyword.value.toLowerCase().trim()

  if (!keyword) {
    const currentCategory = faqData.find((cat) => cat.category === activeCategory.value)
    return currentCategory ? [currentCategory] : []
  }

  return faqData
    .map((category) => ({
      ...category,
      items: category.items.filter((item) => {
        const qMatch = item.q.toLowerCase().includes(keyword)
        const aMatch = item.a.toLowerCase().includes(keyword)
        const tagMatch = item.tags?.some((tag) => tag.toLowerCase().includes(keyword))
        const keywordMatch = item.keywords?.some((kw) => kw.toLowerCase().includes(keyword))
        return qMatch || aMatch || tagMatch || keywordMatch
      }),
    }))
    .filter((cat) => cat.items.length > 0)
})

/**
 * 切換分類
 */
const handleCategoryChange = (category) => {
  activeCategory.value = category
  activeFaqItems.value = []
  searchKeyword.value = ''
}

/**
 * 【導航】前往問題回報頁面
 */
const goToReport = () => {
  router.push('/support/report')
}

/**
 * 【統計】總 FAQ 數量
 */
const totalFaqCount = computed(() => {
  return faqData.reduce((sum, cat) => sum + cat.items.length, 0)
})

// ==================== BEGIN: Coze 狀態標籤配置 ====================
const cozeTagConfig = computed(() => {
  const configs = {
    loading: { type: 'warning', icon: 'fa-spinner fa-spin', text: '初始化中' },
    ready: { type: 'success', icon: 'fa-check-circle', text: '已就緒' },
    degraded: { type: 'danger', icon: 'fa-exclamation-triangle', text: '服務暫時不可用' },
    error: { type: 'danger', icon: 'fa-times-circle', text: '初始化失敗' },
    idle: { type: 'info', icon: 'fa-clock', text: '未啟動' },
  }
  return configs[cozeStatus.value] || configs.idle
})
// ==================== END: Coze 狀態標籤配置 ====================

// ==================== BEGIN: 降級模式按鈕處理 ====================
const handleRetryCoze = async () => {
  await manualRetry()
}

const handleOpenChat = () => {
  if (cozeDegraded.value) {
    // 降級模式下，不執行開啟（UI 會引導到人工客服）
    return
  }
  openChatWindow()
}
// ==================== END: 降級模式按鈕處理 ====================

// ==================== BEGIN: 生命週期 ====================

let navigateHandler = null

onMounted(() => {
  // 延遲 500ms 後初始化，避免阻塞頁面渲染
  setTimeout(() => {
    initCozeChat()
  }, 500)

  // 2) 接收 useCozeChat dispatch 的「導頁事件」（C 方案）
  navigateHandler = (e) => {
    const intent = e?.detail || null
    pendingIntent.value = intent

    // 把 intent 存起來，讓 /support/report 頁面拿來預填
    try {
      sessionStorage.setItem('support_report_intent', JSON.stringify(intent))
    } catch (err) {
      // 失敗也不影響導頁
      console.warn('store intent failed', err)
    }

    //導頁
    router.push('/support/report')
  }

  window.addEventListener('support:navigate-report', navigateHandler)
})

onUnmounted(() => {
  // 關閉聊天視窗
  chatOpen.value = false

  // 移除事件監聽（避免記憶體洩漏 / 重複導頁）
  if (navigateHandler) {
    window.removeEventListener('support:navigate-report', navigateHandler)
    navigateHandler = null
  }
})

// ==================== END: 生命週期 ====================
</script>

<template>
  <div class="support-center-container">
    <!-- Hero 區域 -->
    <section class="hero-section">
      <div class="hero-content">
        <div class="hero-icon">
          <i class="fas fa-life-ring"></i>
        </div>
        <h1 class="hero-title">客服支援中心</h1>
        <p class="hero-subtitle">我們隨時為您提供協助</p>

        <!-- 搜尋框 -->
        <div class="search-wrapper">
          <el-input
            v-model="searchKeyword"
            placeholder="搜尋常見問題、關鍵字..."
            size="large"
            clearable
            class="search-input"
          >
            <template #prefix>
              <i class="fas fa-search"></i>
            </template>
          </el-input>
        </div>

        <div class="hero-stats">
          <span><i class="fas fa-book-open"></i> {{ totalFaqCount }} 個常見問題</span>
          <span><i class="fas fa-clock"></i> 24/7 全天候服務</span>
        </div>
      </div>
    </section>

    <!-- 主要內容區 -->
    <section class="content-section">
      <div class="container-fluid">
        <!-- 分類 Tabs -->
        <div class="category-tabs" v-if="!searchKeyword">
          <div
            v-for="category in faqData"
            :key="category.category"
            class="category-tab"
            :class="{ active: activeCategory === category.category }"
            @click="handleCategoryChange(category.category)"
          >
            <i :class="category.icon" :style="{ color: category.color }"></i>
            <span>{{ category.category }}</span>
            <el-badge :value="category.items.length" type="info" />
          </div>
        </div>

        <!-- 搜尋結果提示 -->
        <div v-if="searchKeyword" class="search-result-hint">
          <i class="fas fa-filter"></i>
          搜尋「<b>{{ searchKeyword }}</b
          >」共找到
          <span class="result-count">{{
            filteredFaqData.reduce((sum, cat) => sum + cat.items.length, 0)
          }}</span>
          筆結果
          <el-button text type="primary" size="small" @click="searchKeyword = ''">
            <i class="fas fa-times"></i> 清除搜尋
          </el-button>
        </div>

        <!-- FAQ 列表 -->
        <div class="faq-list">
          <div
            v-for="category in filteredFaqData"
            :key="category.category"
            class="faq-category-block"
          >
            <!-- 分類標題（僅在搜尋模式顯示） -->
            <div v-if="searchKeyword" class="category-title">
              <i :class="category.icon" :style="{ color: category.color }"></i>
              {{ category.category }}
            </div>

            <!-- FAQ Accordion -->
            <el-collapse v-model="activeFaqItems" accordion>
              <el-collapse-item
                v-for="(item, index) in category.items"
                :key="`${category.category}-${index}`"
                :name="`${category.category}-${index}`"
                class="faq-item"
              >
                <template #title>
                  <div class="faq-question">
                    <i class="fas fa-question-circle"></i>
                    <span v-html="item.q"></span>
                  </div>
                </template>
                <div class="faq-answer" v-html="item.a"></div>
                <div class="faq-tags" v-if="item.tags && item.tags.length">
                  <el-tag
                    v-for="tag in item.tags"
                    :key="tag"
                    size="small"
                    type="info"
                    effect="plain"
                  >
                    {{ tag }}
                  </el-tag>
                </div>
              </el-collapse-item>
            </el-collapse>
          </div>

          <!-- 無結果提示 -->
          <el-empty
            v-if="filteredFaqData.length === 0"
            description="找不到相關問題"
            :image-size="120"
          >
            <template #image>
              <i class="fas fa-search" style="font-size: 80px; color: #dcdfe6"></i>
            </template>
            <el-button type="primary" @click="goToReport">
              <i class="fas fa-exclamation-circle mr-1"></i> 直接回報問題
            </el-button>
          </el-empty>
        </div>

        <!-- CTA 按鈕區 -->
        <div class="cta-section">
          <!-- AI 客服卡片 -->
          <div class="cta-card cta-card-ai" :class="{ 'cta-card-degraded': cozeDegraded }">
            <div class="cta-icon">
              <i class="fas fa-robot"></i>
            </div>
            <div class="cta-content">
              <h3>
                試試 AI 智能客服
                <el-tag :type="cozeTagConfig.type" size="small" effect="dark">
                  <i :class="['fas', cozeTagConfig.icon]"></i> {{ cozeTagConfig.text }}
                </el-tag>
              </h3>

              <!-- 正常狀態提示 -->
              <p v-if="!cozeDegraded && !cozeError">
                即時解答您的疑問，24/7 全天候服務，請點擊右下角聊天圖示開始對話
              </p>

              <!-- 降級狀態提示 -->
              <div v-if="cozeDegraded" class="degraded-notice">
                <p class="degraded-text">
                  <i class="fas fa-exclamation-triangle"></i>
                  Coze 服務暫時不可用（可能是網路問題或服務端維護）
                </p>
                <p class="degraded-hint">您可以嘗試重新連線，或使用下方人工客服管道</p>
                <div class="degraded-actions">
                  <el-button
                    type="warning"
                    size="small"
                    :loading="cozeLoading"
                    @click="handleRetryCoze"
                  >
                    <i class="fas fa-redo mr-1" v-if="!cozeLoading"></i>
                    {{ cozeLoading ? '重試中...' : '重新連線' }}
                    <span v-if="retryCount > 0" class="retry-count">({{ retryCount }}/3)</span>
                  </el-button>
                </div>
              </div>

              <!-- 錯誤狀態提示 -->
              <div v-else-if="cozeError" class="error-notice">
                <p class="error-text">
                  <i class="fas fa-times-circle"></i>
                  初始化失敗：{{ cozeError }}
                </p>
                <el-button
                  type="primary"
                  size="small"
                  :loading="cozeLoading"
                  @click="handleRetryCoze"
                >
                  <i class="fas fa-redo mr-1" v-if="!cozeLoading"></i>
                  重試
                </el-button>
              </div>
            </div>

            <!-- 正常按鈕 -->
            <el-button
              v-if="!cozeDegraded && !cozeError"
              type="success"
              size="large"
              :disabled="!cozeInitialized"
              :loading="cozeLoading"
              @click="handleOpenChat"
            >
              <i class="fas fa-comments mr-2" v-if="!cozeLoading"></i>
              {{ cozeInitialized ? '開始對話' : cozeLoading ? '載入中...' : '初始化中' }}
            </el-button>
          </div>

          <!-- 問題回報卡片（人工客服入口） -->
          <div class="cta-card cta-card-report">
            <div class="cta-icon">
              <i class="fas fa-headset"></i>
            </div>
            <div class="cta-content">
              <h3>
                人工客服協助
                <!-- 降級時強調此入口 -->
                <el-tag v-if="cozeDegraded" type="success" size="small" effect="dark">
                  <i class="fas fa-star"></i> 推薦
                </el-tag>
              </h3>
              <p>
                {{
                  cozeDegraded
                    ? 'AI 客服暫時不可用，請透過此管道聯繫我們，我們會盡快為您處理'
                    : '若以上內容無法解決您的問題，請填寫問題回報表單，我們會盡快為您處理'
                }}
              </p>
            </div>
            <el-button
              :type="cozeDegraded ? 'success' : 'primary'"
              size="large"
              @click="goToReport"
            >
              <i class="fas fa-paper-plane mr-2"></i> 我要回報問題
            </el-button>
          </div>
        </div>

        <!-- 聯繫方式 -->
        <div class="contact-info">
          <div class="contact-item">
            <i class="fas fa-phone"></i>
            <span>客服專線：0968-179-091</span>
          </div>
          <div class="contact-item">
            <i class="fas fa-envelope"></i>
            <span>Email：support@seatrentsys.com</span>
          </div>
          <div class="contact-item">
            <i class="fas fa-clock"></i>
            <span>服務時間：24/7 全天候</span>
          </div>
        </div>
      </div>
    </section>

    <!-- ==================== BEGIN: 自製聊天泡泡 UI（OpenAPI 模式） ==================== -->
    <!-- 右下角浮動聊天按鈕 -->
    <div
      v-if="cozeInitialized && !cozeDegraded && !chatOpen"
      class="chat-fab"
      @click="openChatWindow"
    >
      <i class="fas fa-comments"></i>
      <span class="fab-tooltip">AI 智能客服</span>
    </div>

    <!-- 聊天視窗 -->
    <transition name="chat-slide">
      <div v-if="chatOpen" class="chat-window">
        <!-- 聊天視窗標題列 -->
        <div class="chat-header">
          <div class="chat-header-info">
            <i class="fas fa-robot"></i>
            <span>Take@Seat 智能客服</span>
            <el-tag size="small" type="success" effect="plain">
              <i class="fas fa-circle" style="font-size: 6px; margin-right: 4px"></i>
              線上
            </el-tag>
          </div>
          <div class="chat-header-actions">
            <el-button text circle size="small" @click="handleClearChat" title="清除對話">
              <i class="fas fa-trash-alt"></i>
            </el-button>
            <el-button text circle size="small" @click="closeChatWindow" title="關閉">
              <i class="fas fa-times"></i>
            </el-button>
          </div>
        </div>

        <!-- 聊天訊息區 -->
        <div class="chat-messages" ref="messagesContainer">
          <!-- 歡迎訊息 -->
          <div v-if="messages.length === 0" class="chat-welcome">
            <div class="welcome-icon">
              <i class="fas fa-hand-sparkles"></i>
            </div>
            <h4>您好！我是 AI 智能客服</h4>
            <p>有任何關於座位租賃的問題，歡迎詢問我！</p>
            <div class="quick-questions">
              <el-button size="small" @click="sendQuickQuestion('付款方式有哪些？')">
                付款方式有哪些？
              </el-button>

              <el-button size="small" @click="sendQuickQuestion('如何使用租借功能？')">
                如何使用租借功能？
              </el-button>

              <el-button size="small" @click="sendQuickQuestion('如何換取點數？')">
                如何換取點數？
              </el-button>
            </div>
          </div>

          <!-- 訊息列表 -->
          <div
            v-for="(msg, index) in messages"
            :key="index"
            class="chat-message"
            :class="{
              'message-user': msg.role === 'user',
              'message-assistant': msg.role === 'assistant',
              'message-error': msg.isError,
            }"
          >
            <div class="message-avatar">
              <i :class="msg.role === 'user' ? 'fas fa-user' : 'fas fa-robot'"></i>
            </div>
            <div class="message-content">
              <div class="message-bubble">{{ msg.content }}</div>
              <div class="message-time">{{ formatTime(msg.timestamp) }}</div>
            </div>
          </div>

          <!-- 正在輸入指示器 -->
          <div v-if="sending" class="chat-message message-assistant">
            <div class="message-avatar">
              <i class="fas fa-robot"></i>
            </div>
            <div class="message-content">
              <div class="message-bubble typing-indicator">
                <span></span><span></span><span></span>
              </div>
            </div>
          </div>
        </div>

        <!-- 聊天輸入區 -->
        <div class="chat-input-area">
          <el-input
            v-model="chatInput"
            placeholder="輸入訊息..."
            :disabled="sending"
            @keydown="handleKeydown"
            clearable
          >
            <template #append>
              <el-button
                type="primary"
                :loading="sending"
                :disabled="!chatInput.trim()"
                @click="handleSendMessage"
              >
                <i class="fas fa-paper-plane" v-if="!sending"></i>
              </el-button>
            </template>
          </el-input>
          <div class="chat-input-hint">
            按 Enter 送出 ·
            <a href="#" @click.prevent="goToReport">轉人工客服</a>
          </div>
        </div>
      </div>
    </transition>
    <!-- ==================== END: 自製聊天泡泡 UI ==================== -->
  </div>
</template>

<style scoped>
/* ========== 頁面容器 ========== */
.support-center-container {
  min-height: 100vh;
  background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);

  /*藍色漸層系列（更淡）*/
  --support-brand-1: #d4e3ee;
  --support-brand-2: #c8d9e6;

  /*常用的藍色點綴*/
  --support-accent-1: #60a5fa;
  --support-accent-2: #3b82f6;
}

/* ========== Hero 區域 ========== */
.hero-section {
  background: linear-gradient(135deg, var(--support-brand-1) 0%, var(--support-brand-2) 100%);
  padding: 80px 20px 60px;
  color: white;
  position: relative;
  overflow: hidden;
}

.hero-section::before {
  content: '';
  position: absolute;
  top: -50%;
  right: -10%;
  width: 500px;
  height: 500px;
  background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
  border-radius: 50%;
}

.hero-content {
  max-width: 800px;
  margin: 0 auto;
  text-align: center;
  position: relative;
  z-index: 1;
}

.hero-icon {
  font-size: 64px;
  margin-bottom: 20px;
  animation: float 3s ease-in-out infinite;
}

@keyframes float {
  0%,
  100% {
    transform: translateY(0);
  }
  50% {
    transform: translateY(-10px);
  }
}

.hero-title {
  font-size: 2.5rem;
  font-weight: 800;
  margin: 0 0 10px;
  color: #2c3e50;
  text-shadow: 0 2px 8px rgba(0, 0, 0, 0.15), 0 1px 3px rgba(255, 255, 255, 0.5);
}

.hero-subtitle {
  font-size: 1.1rem;
  font-weight: 600;
  opacity: 1;
  margin-bottom: 30px;
  color: #34495e;
  text-shadow: 0 1px 4px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(255, 255, 255, 0.3);
}

.search-wrapper {
  max-width: 600px;
  margin: 0 auto 20px;
}

.search-input {
  border-radius: 50px;
  overflow: hidden;
}

.search-input :deep(.el-input__wrapper) {
  border-radius: 50px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
  padding: 0 20px;
}

.hero-stats {
  display: flex;
  justify-content: center;
  gap: 30px;
  font-size: 0.9rem;
  font-weight: 600;
  opacity: 1;
  color: #34495e;
  text-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(255, 255, 255, 0.3);
}

.hero-stats span {
  display: flex;
  align-items: center;
  gap: 8px;
}

/* ========== 內容區域 ========== */
.content-section {
  padding: 40px 20px;
}

/* ========== 分類 Tabs ========== */
.category-tabs {
  display: flex;
  gap: 15px;
  justify-content: center;
  max-width: 900px;
  margin: 0 auto 30px;
  overflow-x: auto;
  padding: 0 8px 10px;
  -webkit-overflow-scrollong: touch;
}

.category-tab {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 24px;
  background: white;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
  white-space: nowrap;
  font-weight: 600;
}

.category-tab:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
}

.category-tab.active {
  background: linear-gradient(135deg, rgba(212, 227, 238, 0.3) 0%, rgba(200, 217, 230, 0.3) 100%);
  color: #2c5282;
  border: 2px solid var(--support-brand-2);
  box-shadow: 0 4px 16px rgba(59, 130, 246, 0.2);
  font-weight: 700;
  text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
}

.category-tab.active i {
  color: #2c5282 !important;
}

/* ========== 搜尋結果提示 ========== */
.search-result-hint {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 15px 20px;
  background: #ecf5ff;
  border-radius: 12px;
  margin-bottom: 20px;
  color: #409eff;
  font-size: 14px;
}

.result-count {
  font-weight: 700;
  color: #409eff;
}

/* ========== FAQ 列表 ========== */
.faq-list {
  max-width: 900px;
  margin: 0 auto;
}

.faq-category-block {
  margin-bottom: 30px;
}

.category-title {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 1.2rem;
  font-weight: 600;
  margin-bottom: 15px;
  color: #303133;
}

.faq-item {
  margin-bottom: 10px;
}

.faq-item :deep(.el-collapse-item__header) {
  background: white;
  border-radius: 12px;
  padding: 20px;
  font-size: 15px;
  transition: all 0.3s ease;
}

.faq-item :deep(.el-collapse-item__header:hover) {
  background: #f5f7fa;
  transform: translateX(5px);
}

.faq-item :deep(.el-collapse-item__wrap) {
  border: none;
  background: white;
  border-radius: 0 0 12px 12px;
}

.faq-item :deep(.el-collapse-item__content) {
  padding: 20px;
  border-top: 1px solid #ebeef5;
}

.faq-question {
  display: flex;
  align-items: center;
  gap: 12px;
  color: #303133;
  font-weight: 600;
}

.faq-question i {
  color: #409eff;
  font-size: 18px;
}

.faq-answer {
  color: #606266;
  line-height: 1.8;
}

.faq-answer :deep(ol),
.faq-answer :deep(ul) {
  margin: 10px 0;
}

.faq-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px dashed #ebeef5;
}

/* ========== CTA 區域 ========== */
.cta-section {
  margin: 60px 0 40px;
  max-width: 900px;
  margin-left: auto;
  margin-right: auto;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

.cta-card {
  padding: 40px;
  border-radius: 20px;
  color: white;
  text-align: center;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
  transition: transform 0.3s ease;
}

.cta-card:hover {
  transform: translateY(-5px);
}

.cta-card-ai {
  background: linear-gradient(135deg, #a8dba8 0%, #7ec8e3 100%);
}

.cta-card-ai .cta-content h3 {
  color: #1a4d2e;
  text-shadow:
    0 2px 8px rgba(0, 0, 0, 0.25),
    0 1px 3px rgba(255, 255, 255, 0.3);
}

.cta-card-ai .cta-content p {
  color: #2d5f4f;
  font-weight: 600;
  text-shadow:
    0 1px 4px rgba(0, 0, 0, 0.2),
    0 1px 2px rgba(255, 255, 255, 0.2);
}

/* 降級模式樣式 */
.cta-card-degraded {
  background: linear-gradient(135deg, #909399 0%, #606266 100%);
}

.cta-card-report {
  background: linear-gradient(135deg, var(--support-brand-1) 0%, var(--support-brand-2) 100%);
}

.cta-card-report .cta-content h3 {
  color: #1a3a52;
  text-shadow:
    0 2px 8px rgba(0, 0, 0, 0.25),
    0 1px 3px rgba(255, 255, 255, 0.3);
}

.cta-card-report .cta-content p {
  color: #2c5282;
  font-weight: 600;
  text-shadow:
    0 1px 4px rgba(0, 0, 0, 0.2),
    0 1px 2px rgba(255, 255, 255, 0.2);
}

.cta-icon {
  font-size: 48px;
  margin-bottom: 20px;
}

.cta-content h3 {
  font-size: 1.5rem;
  font-weight: 700;
  margin: 0 0 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  flex-wrap: wrap;
  text-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
}

.cta-content p {
  font-weight: 500;
  opacity: 0.95;
  margin-bottom: 25px;
  font-size: 0.95rem;
  line-height: 1.6;
  text-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.cta-card .el-button {
  background: white;
  border: none;
  font-weight: 700;
  padding: 15px 40px;
  border-radius: 50px;
  transition: all 0.3s ease;
}

.cta-card-ai .el-button {
  color: #67c23a;
}

.cta-card-degraded .el-button {
  color: #606266;
}

.cta-card-report .el-button {
  color: #2c5282;
  font-weight: 700;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

.cta-card .el-button:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
}

/* 降級提示樣式 */
.degraded-notice,
.error-notice {
  background: rgba(255, 255, 255, 0.15);
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 20px;
  text-align: left;
}

.degraded-text,
.error-text {
  display: flex;
  align-items: center;
  gap: 8px;
  margin: 0 0 10px;
  font-weight: 600;
}

.degraded-hint {
  font-size: 0.85rem;
  opacity: 0.9;
  margin: 0 0 15px;
}

.degraded-actions {
  display: flex;
  gap: 10px;
  justify-content: flex-start;
}

.retry-count {
  margin-left: 5px;
  font-size: 0.8em;
  opacity: 0.8;
}

/* ========== 聯繫方式 ========== */
.contact-info {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 30px;
  padding: 30px;
  background: white;
  border-radius: 16px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
  max-width: 900px;
  margin: 0 auto;
}

.contact-item {
  display: flex;
  align-items: center;
  gap: 10px;
  color: #606266;
  font-size: 14px;
}

.contact-item i {
  color: #409eff;
  font-size: 18px;
}

/* ========== 響應式設計 ========== */
@media (max-width: 768px) {
  .hero-title {
    font-size: 1.8rem;
  }

  .category-tabs {
    justify-content: flex-start;
  }

  .cta-section {
    grid-template-columns: 1fr;
  }

  .cta-card {
    padding: 30px 20px;
  }

  .contact-info {
    flex-direction: column;
    align-items: flex-start;
  }
}

/* ========== 輔助類 ========== */
.mr-1 {
  margin-right: 4px;
}
.mr-2 {
  margin-right: 8px;
}

/* ==================== BEGIN: 聊天泡泡 UI 樣式（OpenAPI 模式） ==================== */

/* 右下角浮動按鈕 */
.chat-fab {
  position: fixed;
  bottom: 30px;
  right: 30px;
  width: 60px;
  height: 60px;
  background: linear-gradient(135deg, #67c23a 0%, #409eff 100%);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 4px 20px rgba(64, 158, 255, 0.4);
  transition: all 0.3s ease;
  z-index: 1000;
}

.chat-fab:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 28px rgba(64, 158, 255, 0.5);
}

.chat-fab i {
  font-size: 24px;
  color: white;
}

.chat-fab .fab-tooltip {
  position: absolute;
  right: 70px;
  background: #303133;
  color: white;
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 13px;
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}

.chat-fab:hover .fab-tooltip {
  opacity: 1;
}

/* 聊天視窗 */
.chat-window {
  position: fixed;
  bottom: 30px;
  right: 30px;
  width: 380px;
  height: 550px;
  background: white;
  border-radius: 16px;
  box-shadow: 0 8px 40px rgba(0, 0, 0, 0.15);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  z-index: 1001;
}

/* 聊天視窗動畫 */
.chat-slide-enter-active,
.chat-slide-leave-active {
  transition: all 0.3s ease;
}

.chat-slide-enter-from,
.chat-slide-leave-to {
  opacity: 0;
  transform: translateY(20px) scale(0.95);
}

/* 聊天標題列 */
.chat-header {
  background: linear-gradient(135deg, var(--support-brand-1) 0%, var(--support-brand-2) 100%);
  color: white;
  padding: 16px 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.chat-header-info {
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 700;
  color: #2c3e50;
  text-shadow: 0 1px 3px rgba(0, 0, 0, 0.15), 0 1px 2px rgba(255, 255, 255, 0.3);
}

.chat-header-info i {
  font-size: 20px;
}

.chat-header-actions .el-button {
  color: white;
}

.chat-header-actions .el-button:hover {
  background: rgba(255, 255, 255, 0.2);
}

/* 聊天訊息區 */
.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  background: #f5f7fa;
}

/* 歡迎訊息 */
.chat-welcome {
  text-align: center;
  padding: 30px 20px;
}

.chat-welcome .welcome-icon {
  width: 60px;
  height: 60px;
  background: linear-gradient(135deg, var(--support-brand-1) 0%, var(--support-brand-2) 100%);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 15px;
}

.chat-welcome .welcome-icon i {
  font-size: 28px;
  color: white;
}

.chat-welcome h4 {
  margin: 0 0 8px;
  color: #2c3e50;
  font-weight: 700;
  text-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.chat-welcome p {
  margin: 0 0 20px;
  color: #606266;
  font-size: 14px;
  font-weight: 500;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}

.chat-welcome .quick-questions {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  justify-content: center;
}

.chat-welcome .quick-questions .el-button {
  font-size: 12px;
}

/* 訊息氣泡 */
.chat-message {
  display: flex;
  gap: 10px;
  margin-bottom: 16px;
}

.chat-message.message-user {
  flex-direction: row-reverse;
}

.message-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.message-user .message-avatar {
  background: linear-gradient(135deg, #409eff 0%, #66b1ff 100%);
  color: white;
}

.message-assistant .message-avatar {
  background: linear-gradient(135deg, var(--support-brand-1) 0%, var(--support-brand-2) 100%);
  color: white;
}

.message-content {
  max-width: 70%;
}

.message-bubble {
  padding: 12px 16px;
  border-radius: 16px;
  font-size: 14px;
  line-height: 1.5;
  word-break: break-word;
}

.message-user .message-bubble {
  background: #409eff;
  color: white;
  border-bottom-right-radius: 4px;
}

.message-assistant .message-bubble {
  background: white;
  color: #303133;
  border-bottom-left-radius: 4px;
  box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
}

.message-error .message-bubble {
  background: #fef0f0;
  color: #f56c6c;
}

.message-time {
  font-size: 11px;
  color: #909399;
  margin-top: 4px;
  padding: 0 4px;
}

.message-user .message-time {
  text-align: right;
}

/* 正在輸入指示器 */
.typing-indicator {
  display: flex;
  gap: 4px;
  padding: 12px 16px;
}

.typing-indicator span {
  width: 8px;
  height: 8px;
  background: #c0c4cc;
  border-radius: 50%;
  animation: typing 1.4s infinite ease-in-out;
}

.typing-indicator span:nth-child(1) {
  animation-delay: 0s;
}

.typing-indicator span:nth-child(2) {
  animation-delay: 0.2s;
}

.typing-indicator span:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes typing {
  0%,
  60%,
  100% {
    transform: translateY(0);
  }
  30% {
    transform: translateY(-8px);
  }
}

/* 聊天輸入區 */
.chat-input-area {
  padding: 12px 16px;
  background: white;
  border-top: 1px solid #ebeef5;
}

.chat-input-area .el-input {
  border-radius: 24px;
}

.chat-input-area .el-input :deep(.el-input__wrapper) {
  border-radius: 24px 0 0 24px;
}

.chat-input-area .el-input :deep(.el-input-group__append) {
  border-radius: 0 24px 24px 0;
  padding: 0;
}

.chat-input-area .el-input :deep(.el-input-group__append .el-button) {
  border-radius: 0 24px 24px 0;
  margin: 0;
  height: 100%;
}

.chat-input-hint {
  font-size: 11px;
  color: #909399;
  text-align: center;
  margin-top: 8px;
}

.chat-input-hint a {
  color: #409eff;
  text-decoration: none;
}

.chat-input-hint a:hover {
  text-decoration: underline;
}

/* 響應式 - 手機版 */
@media (max-width: 480px) {
  .chat-window {
    bottom: 0;
    right: 0;
    width: 100%;
    height: 100%;
    border-radius: 0;
  }

  .chat-fab {
    bottom: 20px;
    right: 20px;
  }
}

/* ==================== END: 聊天泡泡 UI 樣式 ==================== */
</style>
</file>

<file path="frontend/src/components/rec/RecRentAdd.vue">
<script setup>
import { ref, onMounted } from 'vue'
import axios from 'axios'


const memberList = ref([])
const spotList = ref([])
const seatList = ref([]) // [新增] 座位列表

// [新增] 下拉選單顯示狀態
const showMemId = ref(false)
const showMemName = ref(false)
const showSpotRentId = ref(false)
const showSpotRentName = ref(false)
const showSpotReturnId = ref(false)
const showSpotReturnName = ref(false)
const showSeatId = ref(false)

const fetchMembers = async () => {
  try {
    const res = await axios.get('http://localhost:8080/api/members')
    memberList.value = res.data
  } catch (err) {
    console.error('無法載入會員列表:', err)
  }
}

const fetchSpots = async () => {
  try {
    const res = await axios.get('http://localhost:8080/spot/list')
    spotList.value = res.data
  } catch (err) {
    console.error('無法載入據點列表:', err)
  }
}

// [新增] 載入座位列表
const fetchSeats = async () => {
  try {
    const res = await axios.get('http://localhost:8080/seats')
    seatList.value = res.data
  } catch (err) {
    console.error('無法載入座位列表:', err)
  }
}

// 1. 定義 emit 事件
const emit = defineEmits(['save-rent', 'cancel'])

// 2. 創建一個空的初始表單物件的函式
const createInitialForm = () => ({
  recSeqId: null,
  // recId: '',
  memId: '',
  memName: '',
  seatsId: '',
  recStatus: '租借中',
  recStatus: '租借中',
  spotIdRent: '',
  spotRentName: '', // [新增] 用於顯示/輸入
  spotIdReturn: '',
  spotReturnName: '', // [新增] 用於顯示/輸入
  recRentDT2: '',
  recReturnDT2: '',
  recViolatInt: 0,
  recNote: '', // [修正] 補上備註欄位的初始化
})

// 3. 使用 ref 來儲存表單資料
const form = ref(createInitialForm())
const formTitle = '新增訂單' // 標題是固定的

// 連動邏輯


// [新增] 過濾邏輯 (Computed)
import { computed } from 'vue'

const filteredMemIds = computed(() => {
  if (!form.value.memId) return memberList.value
  return memberList.value.filter(m => String(m.memId).includes(String(form.value.memId)))
})

const filteredMemNames = computed(() => {
  if (!form.value.memName) return memberList.value
  return memberList.value.filter(m => m.memName.includes(form.value.memName))
})

const filteredSpotRentIds = computed(() => {
  if (!form.value.spotIdRent) return spotList.value
  return spotList.value.filter(s => String(s.spotId).includes(String(form.value.spotIdRent)))
})

const filteredSpotRentNames = computed(() => {
  if (!form.value.spotRentName) return spotList.value
  return spotList.value.filter(s => s.spotName.includes(form.value.spotRentName))
})

const filteredSpotReturnIds = computed(() => {
  if (!form.value.spotIdReturn) return spotList.value
  return spotList.value.filter(s => String(s.spotId).includes(String(form.value.spotIdReturn)))
})

const filteredSpotReturnNames = computed(() => {
  if (!form.value.spotReturnName) return spotList.value
  return spotList.value.filter(s => s.spotName.includes(form.value.spotReturnName))
})

// [新增] 可用座位過濾：需符合「所在站點 = 租借站點」且「狀態 = 可使用(或類似狀態)」
// 若後端座位狀態 definition: '可用', '使用中', '維修中'
const filteredSeats = computed(() => {
  let list = seatList.value
  
  // 1. 先篩選出屬於「目前租借站點」的座位
  // if (form.value.spotIdRent) {
  //   list = list.filter(s => s.spotId == form.value.spotIdRent)
  // }
  
  // 2. 再根據輸入的 seatsId 進行模糊搜尋 (包含 ID, 名稱, 序號)
  if (form.value.seatsId) {
    const term = String(form.value.seatsId).toLowerCase()
    list = list.filter(s => {
      const id = String(s.seatsId).toLowerCase()
      const name = (s.seatsName || '').toLowerCase()
      const serial = (s.serialNumber || '').toLowerCase()
      return id.includes(term) || name.includes(term) || serial.includes(term)
    })
  }
  
  // 3. 過濾掉非「可租借」狀態的座位 (可選)
  list = list.filter(s => s.seatsStatus === '啟用') 
  
  return list
})

// [新增] 選擇處理函式
const selectMember = (member) => {
  form.value.memId = member.memId
  form.value.memName = member.memName
  showMemId.value = false
  showMemName.value = false
}

const selectSpotRent = (spot) => {
  form.value.spotIdRent = spot.spotId
  form.value.spotRentName = spot.spotName
  showSpotRentId.value = false
  showSpotRentName.value = false
}

const selectSpotReturn = (spot) => {
  form.value.spotIdReturn = spot.spotId
  form.value.spotReturnName = spot.spotName
  showSpotReturnId.value = false
  showSpotReturnName.value = false
}

const selectSeat = (seat) => {
  form.value.seatsId = seat.seatsId // 注意型別轉換若需要
  showSeatId.value = false
}

// 延遲隱藏 (避免點擊選項前 input blur 導致選單消失)
const delayHide = (refVar) => {
  setTimeout(() => {
    refVar.value = false
  }, 200)
}

// [新增] 手動切換下拉選單顯示
const toggleDropdown = (refVar) => {
  refVar.value = !refVar.value
}

onMounted(() => {
  fetchMembers()
  fetchSpots()
  fetchSeats()
})

// 4. 清空/重設表單的函式
const resetForm = () => {
  form.value = createInitialForm()
}

// 5. 提交表單的處理函式
const saveRent = () => {
  const dataToSend = {
    ...form.value,
    recRentDT2: form.value.recRentDT2 || null, // 保持 ISO 格式 (含 'T')，後端才能正確解析
    recReturnDT2: form.value.recReturnDT2 || null, // 保持 ISO 格式 (含 'T')
  }
  emit('save-rent', dataToSend)
  // 成功提交後通常會切換視圖，但如果需要留在原頁面，可以取消註解下一行
  // resetForm();
}

// 6. 取消操作 (返回列表)
const handleCancel = () => {
  emit('cancel')
}

// [新增] 一鍵輸入預設值函式
const fillDefaultValues = () => {
  const now = new Date()

  // 封裝格式化邏輯：將 Date 物件轉換為 datetime-local 所需的 YYYY-MM-DDTHH:mm:ss 格式
  const toLocalISOString = (date) => {
    const offset = date.getTimezoneOffset() * 60000
    return new Date(date.getTime() - offset).toISOString().slice(0, 19)
  }

  // 計算昨天 (語意更清楚的寫法)
  const yesterday = new Date(now)
  yesterday.setDate(yesterday.getDate() - 1)
  
  form.value = {
    recSeqId: null,
    // recId: 'TEST-' + Math.floor(Math.random() * 10000), // 隨機產生訂單編號
    memId: 1,
    memName: '測試會員',
    seatsId: '1',
    recStatus: '租借中',
    spotIdRent: 1,
    spotIdReturn: 2,
    recRentDT2: toLocalISOString(yesterday),
    recReturnDT2: toLocalISOString(now),
    recViolatInt: 2,
    recNote: '系統自動帶入測試資料',
  }
}
</script>

<template>
  <div class="view-section form-section active">
    <!-- [修改] 標題區塊加入一鍵輸入按鈕 -->
    <div class="form-header">
      <h2>{{ formTitle }}</h2>
      <button class="btn-warning btn-sm" @click="fillDefaultValues">一鍵輸入</button>
    </div>

    <!-- <div class="form-group">
      <label>訂單編號(recId):</label>
      <input v-model="form.recId" type="text" placeholder="必須..." />
    </div> -->
    <div class="form-group relative">
      <label>會員編號:</label>
      <input
        v-model="form.memId"
        type="number"
        placeholder="必須、數字..."
        required
        @focus="showMemId = true"
        @blur="delayHide(showMemId)"
        @input="showMemId = true"
        @keydown.esc="showMemId = false"
      />
      <span class="toggle-icon" @mousedown.prevent="toggleDropdown(showMemId)">▼</span>
      <ul v-if="showMemId && filteredMemIds.length" class="custom-dropdown">
        <li v-for="m in filteredMemIds" :key="m.memId" @mousedown="selectMember(m)">
          {{ m.memId }} - {{ m.memName }}
        </li>
      </ul>
    </div>
    <div class="form-group relative">
      <label>會員姓名:</label>
      <input
        v-model="form.memName"
        type="text"
        placeholder="或輸入姓名快速搜尋..."
        @focus="showMemName = true"
        @blur="delayHide(showMemName)"
        @input="showMemName = true"
        @keydown.esc="showMemName = false"
      />
      <span class="toggle-icon" @mousedown.prevent="toggleDropdown(showMemName)">▼</span>
      <ul v-if="showMemName && filteredMemNames.length" class="custom-dropdown">
        <li v-for="m in filteredMemNames" :key="m.memId" @mousedown="selectMember(m)">
          {{ m.memId }} - {{ m.memName }}
        </li>
      </ul>
    </div>
    
    <div class="form-group relative">
      <label>座椅編號:</label>
      <input
        v-model="form.seatsId"
        type="text"
        placeholder="必須..."
        required
        @focus="showSeatId = true"
        @blur="delayHide(showSeatId)"
        @input="showSeatId = true"
        @keydown.esc="showSeatId = false"
      />
      <span class="toggle-icon" @mousedown.prevent="toggleDropdown(showSeatId)">▼</span>
       <ul v-if="showSeatId && filteredSeats.length" class="custom-dropdown">
        <li v-for="s in filteredSeats" :key="s.seatsId" @mousedown="selectSeat(s)">
          {{ s.seatsName }} ( {{ s.serialNumber}} )
        </li>
      </ul>
    </div>

    <div class="form-group">
      <label>訂單狀態:</label>
      <select v-model="form.recStatus">
        <option value="租借中">租借中</option>
        <option value="已完成">已完成</option>
        <option value="未歸還">未歸還</option>
        <option value="已取消">已取消</option>
      </select>
    </div>
    
    <div class="form-group relative">
      <label>租借站點編號:</label>
      <input
        v-model="form.spotIdRent"
        type="number"
        placeholder="必須、數字..."
        required
        @focus="showSpotRentId = true"
        @blur="delayHide(showSpotRentId)"
        @input="showSpotRentId = true"
        @keydown.esc="showSpotRentId = false"
      />
      <span class="toggle-icon" @mousedown.prevent="toggleDropdown(showSpotRentId)">▼</span>
      <ul v-if="showSpotRentId && filteredSpotRentIds.length" class="custom-dropdown">
        <li v-for="s in filteredSpotRentIds" :key="s.spotId" @mousedown="selectSpotRent(s)">
          {{ s.spotId }} - {{ s.spotName }}
        </li>
      </ul>
    </div>
    <div class="form-group relative">
      <label>租借站點名稱:</label>
      <input
        v-model="form.spotRentName"
        type="text"
        placeholder="或輸入名稱快速搜尋..."
        @focus="showSpotRentName = true"
        @blur="delayHide(showSpotRentName)"
        @input="showSpotRentName = true"
        @keydown.esc="showSpotRentName = false"
      />
      <span class="toggle-icon" @mousedown.prevent="toggleDropdown(showSpotRentName)">▼</span>
      <ul v-if="showSpotRentName && filteredSpotRentNames.length" class="custom-dropdown">
        <li v-for="s in filteredSpotRentNames" :key="s.spotId" @mousedown="selectSpotRent(s)">
          {{ s.spotName }} ({{ s.spotId }})
        </li>
      </ul>
    </div>
    
    <div class="form-group relative">
      <label>歸還站點編號:</label>
      <input
        v-model="form.spotIdReturn"
        type="number"
        placeholder="數字..."
        @focus="showSpotReturnId = true"
        @blur="delayHide(showSpotReturnId)"
        @input="showSpotReturnId = true"
        @keydown.esc="showSpotReturnId = false"
      />
      <span class="toggle-icon" @mousedown.prevent="toggleDropdown(showSpotReturnId)">▼</span>
       <ul v-if="showSpotReturnId && filteredSpotReturnIds.length" class="custom-dropdown">
        <li v-for="s in filteredSpotReturnIds" :key="s.spotId" @mousedown="selectSpotReturn(s)">
          {{ s.spotId }} - {{ s.spotName }}
        </li>
      </ul>
    </div>
    <div class="form-group relative">
      <label>歸還站點名稱:</label>
      <input
        v-model="form.spotReturnName"
        type="text"
        placeholder="或輸入名稱快速搜尋..."
        @focus="showSpotReturnName = true"
        @blur="delayHide(showSpotReturnName)"
        @input="showSpotReturnName = true"
        @keydown.esc="showSpotReturnName = false"
      />
      <span class="toggle-icon" @mousedown.prevent="toggleDropdown(showSpotReturnName)">▼</span>
       <ul v-if="showSpotReturnName && filteredSpotReturnNames.length" class="custom-dropdown">
        <li v-for="s in filteredSpotReturnNames" :key="s.spotId" @mousedown="selectSpotReturn(s)">
          {{ s.spotName }} ({{ s.spotId }})
        </li>
      </ul>
    </div>
    <div class="form-group">
      <label>租借時間:</label>
      <input v-model="form.recRentDT2" type="datetime-local" step="1" placeholder="必須" required />
    </div>
    <div class="form-group">
      <label>歸還時間:</label>
      <input v-model="form.recReturnDT2" type="datetime-local" step="1" />
    </div>
    <!-- <div class="form-group">
      <label>違規記點:</label>
      <input v-model="form.recViolatInt" type="number" value="0" placeholder="數字..." required />
    </div> -->
    <div class="form-group">
      <label>備註:</label>
      <!-- [修正] 修正綁定錯誤，原本誤綁定到 memName -->
      <input v-model="form.recNote" type="text" placeholder="選填..."/>
    </div>

    <div style="text-align: right">
      <button class="btn-info" @click="resetForm">重設欄位</button>
      <button class="btn-secondary" @click="handleCancel">取消</button>
      <button class="btn-primary" @click="saveRent">儲存訂單</button>
    </div>
  </div>
</template>

<style scoped>
/* ========== 表單區塊 - 淺色風格 ========== */
.form-section {
  background: #f5f7fa;
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 20px;
}

/* ========== 表單標題區塊 ========== */
.form-header {
  display: flex;
  align-items: center;
  justify-content: space-between; /* 標題在左，按鈕在右，若要按鈕緊鄰標題可改為 flex-start 並加 gap */
  border-bottom: 2px solid #e4e7ed;
  margin-bottom: 20px;
  padding-bottom: 10px;
}

.form-header h2 {
  font-size: 1.3rem;
  font-weight: 600;
  color: #303133;
  margin: 0; /* 移除預設邊距，由 header 控制 */
}

/* ========== 表單組 ========== */
.form-group {
  margin-bottom: 14px;
  display: flex;
  align-items: center;
}

.form-group label {
  width: 180px;
  font-weight: 500;
  font-size: 14px;
  color: #606266;
}

.form-group input,
.form-group select {
  padding: 10px 12px;
  flex: 1;
  border: 1px solid #e4e7ed;
  border-radius: 8px;
  font-size: 14px;
  background: #fff;
  transition: all 0.3s ease;
}

.form-group input:focus,
.form-group select:focus {
  border-color: #c0c4cc;
  box-shadow: 0 0 0 2px rgba(64, 158, 255, 0.08);
  outline: none;
}

.form-group input::placeholder {
  color: #c0c4cc;
}

.view-section.active {
  display: block;
}

/* ========== 按鈕樣式 ========== */
button {
  margin-left: 10px;
  padding: 10px 18px;
  cursor: pointer;
  border: none;
  border-radius: 8px;
  font-weight: 500;
  font-size: 14px;
  transition: all 0.3s ease;
}

button:hover {
  transform: translateY(-1px);
}

.btn-primary {
  background: #67c23a;
  color: white;
}

.btn-primary:hover {
  background: #85ce61;
}

.btn-secondary {
  background: #909399;
  color: white;
}

.btn-secondary:hover {
  background: #a6a9ad;
}

.btn-info {
  background: #409eff;
  color: white;
}

.btn-info:hover {
  background: #66b1ff;
}

/* [新增] 小按鈕樣式 */
/* [新增] 自訂下拉選單樣式 */
.relative {
  position: relative;
}

.custom-dropdown {
  position: absolute;
  top: 100%;
  left: 180px; /* 配合 label 寬度 */
  right: 0;
  background: white;
  border: 1px solid #c0c4cc;
  border-radius: 4px;
  max-height: 200px; /* 約顯示 6 筆 */
  overflow-y: auto;
  z-index: 1000;
  box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
  padding: 0;
  margin: 0;
  list-style: none;
}

.custom-dropdown li {
  padding: 8px 12px;
  cursor: pointer;
  color: #606266;
  font-size: 14px;
}

.custom-dropdown li:hover {
  background-color: #f5f7fa;
  color: #409eff;
}

/* [新增] 下拉選單切換圖示 */
.toggle-icon {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  cursor: pointer;
  color: #c0c4cc;
  font-size: 12px;
  transition: color 0.3s;
  padding: 5px; /* 增加點擊範圍 */
}

.toggle-icon:hover {
  color: #409eff;
}
</style>
</file>

<file path="frontend/src/views/ecpay/PaymentViewOrder.vue">
<script setup>
import { ref, onMounted } from 'vue';
import { useRoute } from 'vue-router';
import axios from 'axios';
import Swal from 'sweetalert2';

const route = useRoute();
const isLoading = ref(false);
const recId = ref('');
const returnSpotId=ref('');
const totalFee = ref(0); // [新增] 用於儲存總金額
onMounted(() => {
  // [修改] 從 route.query 獲取訂單ID與金額
  recId.value = route.query.recId;
  totalFee.value = route.query.total;
  returnSpotId.value = route.query.returnSpotId;
  if (!recId.value) {
    Swal.fire('錯誤', '無效的訂單編號', 'error');
  }
});

const handleCheckout = async () => {
  if (!recId.value) return;

  isLoading.value = true;
  try {
    // 1. 準備要送到後端的資料 (Content-Type: application/x-www-form-urlencoded)
    const params = new URLSearchParams();
    params.append('recId', recId.value);
    params.append('amount', totalFee.value);
    params.append('returnSpotId',returnSpotId);
    params.append('baseUrl', window.APP_CONFIG.API_URL);
    // 2. 呼叫後端 API
    const response = await axios.post('http://localhost:8080/api/payment/checkout', params);
    //const response = await axios.post(`${window.APP_CONFIG.API_URL}/api/payment/checkout`, params);
    // 3. 處理後端回傳的 HTML 字串
    const payHtml = response.data;
    if (!payHtml || (typeof payHtml === 'string' && payHtml.includes('Error'))) {
      throw new Error('訂單資訊有誤，無法付款');
    }

    // 3. 建立一個臨時容器但不立即插入頁面
    const div = document.createElement('div');
    div.innerHTML = payHtml;

    // 4. 從容器中尋找表單
    const form = div.querySelector('form');
    if (form) {
      
      div.style.display = 'none'; 
      document.body.appendChild(div);
      form.submit();
    } else {
      // 若回傳的 HTML 中找不到表單，則視為錯誤
      throw new Error('無法解析付款表單，請聯絡客服。');
    }
  } catch (error) {
    console.error('付款啟動失敗', error);
    Swal.fire({
      icon: 'error',
      title: '啟動支付失敗',
      text: error.message || '請檢查網路連線或聯絡客服。',
    });
    // 發生錯誤時，確保 loading 狀態被重置
    isLoading.value = false;
  } finally {
    // 導轉成功時，此組件可能已被銷毀，但為防萬一，短時間後重置按鈕
    setTimeout(() => { 
      // 檢查 isLoading 是否仍為 true，避免覆蓋 catch 中的 false
      if(isLoading.value) isLoading.value = false; 
    }, 3000);
  }
};
</script>

<template>
  <div class="payment-container">
    <div class="payment-card">
      <h2>租借訂單結帳</h2>
      <hr />
      
      <div class="order-info">
        <div class="info-item">
          <span>訂單編號：</span>
          <strong>{{ recId }}</strong>
        </div>
        <!-- [新增] 顯示費用總計 -->
        <div class="info-item">
          <span>費用總計：</span>
          <strong>{{ totalFee }} NTD</strong>
        </div>
        <div class="info-item">
          <span>服務項目：</span>
          <strong>機台/座位租借</strong>
        </div>
        <p class="warning-text">※ 請確認金額後再前往付款</p>
      </div>

      <div class="payment-methods">
        <p>支付平台：</p>
        <label class="method-option">
          <input type="radio" checked /> 
          <span class="radio-label">綠界科技 ECPay 安全支付</span>
        </label>
      </div>

      <button 
        @click="handleCheckout" 
        :disabled="isLoading" 
        class="checkout-btn"
      >
        <span v-if="isLoading" class="loader"></span>
        {{ isLoading ? '導向支付頁面中...' : '前往付款' }}
      </button>

      <p class="note">※ 點擊按鈕後將離開本站，導向至綠界金流加密頁面</p>
    </div>
  </div>
</template>

<style scoped>
.payment-container {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 85vh;
  background-color: #f0f2f5;
}
.payment-card {
  background: white;
  padding: 2.5rem;
  border-radius: 16px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.08);
  width: 100%;
  max-width: 420px;
}
.warning-text {
  font-size: 0.85rem;
  color: #856404;
  background-color: #fff3cd;
  padding: 8px;
  border-radius: 4px;
  margin-top: 10px;
}
.order-info {
  margin: 2rem 0;
}
.info-item {
  display: flex;
  justify-content: space-between;
  margin-bottom: 1rem;
}
.checkout-btn {
  width: 100%;
  padding: 1.2rem;
  background-color: #2a9d8f;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 1.2rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 10px;
}
.checkout-btn:hover {
  background-color: #21867a;
  transform: translateY(-2px);
}
.checkout-btn:disabled {
  background-color: #a8dadc;
  cursor: not-allowed;
}
.loader {
  border: 3px solid #f3f3f3;
  border-top: 3px solid #1d3557;
  border-radius: 50%;
  width: 18px;
  height: 18px;
  animation: spin 1s linear infinite;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
.note {
  font-size: 0.8rem;
  color: #666;
  text-align: center;
  margin-top: 1rem;
}
</style>
</file>

<file path="frontend/src/views/HomeView.vue">
<script setup>
import { ref, onMounted, computed } from 'vue';
import { RouterLink, useRouter } from 'vue-router';
import axios from 'axios';
import Swal from 'sweetalert2';
import { useMemberAuthStore } from '@/stores/memberAuth';

const router = useRouter();
const memberAuthStore = useMemberAuthStore();

// --- 元件狀態 ---
const searchKeyword = ref('');
const isMapVisible = ref(false); // 控制地圖 Modal 顯示
const selectedSpotForMap = ref(null); // 目前點選要導覽的點位
const mapCenter = ref({ lat: 25.033964, lng: 121.564472 }); // 預設台北 101
const mapZoom = ref(12);
const allSpots = ref([]); // 全台所有據點
const isSearchTriggered = ref(false); // 標記是否為搜尋框觸發的彈窗
const isSuggestionsVisible = ref(false); // 管理建議清單顯示

// 熱門標籤
const hotTags = ['台北車站', '信義區', '圖書館', '咖啡廳'];

// 流程步驟
const steps = [
  { icon: 'fas fa-map-marker-alt', title: '尋找座位', desc: '透過地圖快速找到附近的空位' },
  { icon: 'fas fa-calendar-alt', title: '線上預約', desc: '選取心儀座位並完成線上預約' },
  { icon: 'fas fa-coffee', title: '享受時光', desc: '專注工作或放鬆，按時計費' },
];

/**
 * -------------------------------------------
 * 1. 資料獲取邏輯 (Data Fetching)
 * -------------------------------------------
 */

// 熱門點位資料 (由 API 獲取)
const hotSpots = ref([]);

const fetchHotSpots = async () => {
  try {
    const response = await axios.get('http://localhost:8080/api/analyze/hot-spots');
    hotSpots.value = response.data.map(spot => ({
      id: spot.spotId,
      name: spot.spotName,
      status: spot.spotStatus,
      seats: spot.availableSeats,
      lat: spot.latitude,
      lng: spot.longitude,
      // 圖片處理邏輯
      image: spot.spotImage 
        ? (spot.spotImage.startsWith('http') ? spot.spotImage : `http://localhost:8080/${spot.spotImage}`) 
        : `https://images.unsplash.com/photo-1517502884422-41eaead166d4?q=80&w=600&auto=format&fit=crop`
    }));
  } catch (error) {
    console.error('無法取得熱門點位資料:', error);
    // 回退到模擬資料以確保介面不空白
    hotSpots.value = [
      { id: 1, name: '信義誠品閱讀區', status: '營運中', seats: 12, lat: 25.0392, lng: 121.5654, image: 'https://images.unsplash.com/photo-1507842217121-9e962835d771?q=80&w=600&auto=format&fit=crop' },
      { id: 2, name: '大安森林公園共享亭', status: '營運中', seats: 5, lat: 25.0297, lng: 121.5364, image: 'https://images.unsplash.com/photo-1493934558415-9d19f0b2b4d2?q=80&w=600&auto=format&fit=crop' }
    ];
  }
};

const fetchAllSpots = async () => {
  try {
    const response = await axios.get('http://localhost:8080/spot/list-with-seats');
    allSpots.value = response.data.map(spot => ({
      id: spot.spotId,
      name: spot.spotName,
      status: spot.spotStatus,
      lat: parseFloat(spot.latitude),
      lng: parseFloat(spot.longitude),
      seats: spot.availableSeats || 0
    }));
  } catch (error) {
    console.error('無法取得所有據點資料:', error);
  }
};

onMounted(() => {
  fetchHotSpots();
  fetchAllSpots();
});

// 模糊查詢過濾建議
const filteredSuggestions = computed(() => {
  const kw = searchKeyword.value.trim().toLowerCase();
  if (!kw) return [];
  return allSpots.value
    .filter(s => s.name.toLowerCase().includes(kw))
    .slice(0, 5);
});

const handleSearch = () => {
  if (!searchKeyword.value.trim()) return;
  const exactMatch = allSpots.value.find(s => s.name === searchKeyword.value.trim());
  if (exactMatch) {
    handleReserveClick(exactMatch);
  } else {
    // 若非精確匹配，可執行一般搜尋
    console.log('Search:', searchKeyword.value);
  }
};

const handleSelectSuggestion = (spot) => {
  searchKeyword.value = spot.name;
  isSuggestionsVisible.value = false;
  handleReserveClick(spot);
};

const hideSuggestions = () => {
  setTimeout(() => {
    isSuggestionsVisible.value = false;
  }, 200);
};

// 處理 Google Autocomplete 變化
const onPlaceChanged = (place) => {
  if (place && place.geometry && place.geometry.location) {
    const location = place.geometry.location;
    handleSearchLocation(location.lat(), location.lng());
  }
};

const handleSearchLocation = (lat, lng) => {
  isSearchTriggered.value = true;
  selectedSpotForMap.value = null;
  isMapVisible.value = true;
  mapCenter.value = { lat, lng };
  mapZoom.value = 13;
  setTimeout(() => { mapZoom.value = 15; }, 300);
};

/**
 * -------------------------------------------
 * 3. 地圖地圖與定位邏輯 (Map Modal & Zoom)
 * -------------------------------------------
 */

const handleReserveClick = (spot) => {
  isSearchTriggered.value = false;
  selectedSpotForMap.value = spot;
  isMapVisible.value = true;
  
  // 1. 設定該點位中心
  mapCenter.value = { lat: spot.lat, lng: spot.lng };
  mapZoom.value = 13;

  // 2. [WOW 效果] 平滑縮放至該點位
  setTimeout(() => {
    mapZoom.value = 17;
  }, 300);
};

const handleMarkerClick = (spot) => {
  selectedSpotForMap.value = spot;
};

// 前往租借操作頁面 (Rec 模組)
const confirmAndRent = () => {
  if (!selectedSpotForMap.value) return;

  // 檢查是否登入
  if (!memberAuthStore.isLogin) {
    Swal.fire({
      title: '請先登入',
      text: '預約座位需要先登入會員唷！',
      icon: 'info',
      showCancelButton: true,
      confirmButtonText: '前往登入',
      cancelButtonText: '先看看',
      confirmButtonColor: '#4CAF50'
    }).then((result) => {
      if (result.isConfirmed) {
        isMapVisible.value = false;
        router.push({ name: 'login', query: { redirect: `/rent/order?spotId=${selectedSpotForMap.value.id}` } });
      }
    });
    return;
  }

  isMapVisible.value = false;
  router.push({ 
    name: 'rec-rent-user', 
    params: { action: 'order' }, 
    query: { spotId: selectedSpotForMap.value.id } 
  });
};
</script>

<template>
  <div class="home-view-wrapper">
    <!-- 第一屏：Hero Section -->
    <div class="hero-container">
      <div class="hero-bg"></div>
      <div class="hero-overlay"></div>
      <div class="hero-content">
        <h1 class="hero-title animate-up">Take@Seat</h1>
        <p class="hero-subtitle animate-up delay-1">隨時隨地，輕鬆入座</p>
        
        <div class="cta-buttons animate-up delay-2">
          <router-link to="/SearchSpot" class="cta-btn primary">
            開始尋找租借點 <i class="fas fa-arrow-right arrow-icon"></i>
          </router-link>
        </div>

        <div class="quick-search-card animate-up delay-3">
          <div class="search-input-wrapper-container">
            <div class="search-input-wrapper">
              <i class="fas fa-search search-icon"></i>
              <GMapAutocomplete
                @place_changed="onPlaceChanged"
                :options="{
                  fields: ['geometry', 'formatted_address', 'name'],
                  componentRestrictions: { country: 'tw' },
                }"
                style="flex: 1"
              >
                <input 
                  v-model="searchKeyword" 
                  type="text" 
                  placeholder="輸入據點名稱或地點..." 
                  @keyup.enter="handleSearch"
                  @focus="isSuggestionsVisible = true"
                  @blur="hideSuggestions"
                />
              </GMapAutocomplete>
              <button class="search-btn" @click="handleSearch">搜尋</button>
            </div>
            
            <!-- 自定義建議列表 -->
            <ul v-if="isSuggestionsVisible && filteredSuggestions.length > 0" class="search-suggestions">
              <li 
                v-for="spot in filteredSuggestions" 
                :key="spot.id"
                @mousedown="handleSelectSuggestion(spot)"
              >
                <i class="fas fa-chair"></i>
                <span class="spot-name">{{ spot.name }}</span>
                <span class="spot-status">({{ spot.status }})</span>
              </li>
            </ul>
          </div>
          <div class="hot-tags">
            <span>熱門：</span>
            <span v-for="tag in hotTags" :key="tag" class="tag" @click="searchKeyword = tag">{{ tag }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- 第二部分：內容區塊 -->
    <div class="content-section">
      <!-- 簡單三步驟 -->
      <section class="how-it-works">
        <div class="section-header">
          <h2>簡單三步驟</h2>
          <p>輕鬆開啟您的共享空間體驗</p>
        </div>
        <div class="steps-grid">
          <div v-for="(step, index) in steps" :key="index" class="step-item">
            <div class="step-icon">
              <i :class="step.icon"></i>
            </div>
            <h3>{{ step.title }}</h3>
            <p>{{ step.desc }}</p>
          </div>
        </div>
      </section>

      <!-- 熱門點位 -->
      <section class="spot-section">
        <div class="section-header">
          <h2>熱門租借點</h2>
          <p>探索城市中最受歡迎的角落</p>
        </div>
        <div class="spots-grid">
          <div v-for="spot in hotSpots" :key="spot.id" class="spot-card">
            <div class="card-image" :style="{ backgroundImage: `url(${spot.image})` }">
              <span class="status-badge" :class="{ 'full': spot.seats === 0 }">{{ spot.status }}</span>
            </div>
            <div class="card-body">
              <h3>{{ spot.name }}</h3>
              <div class="card-meta">
                <span><i class="fas fa-chair"></i> 剩餘 {{ spot.seats }} 位</span>
                <!-- [修改] 觸發地圖預覽定位邏輯 -->
                <a href="javascript:void(0)" @click="handleReserveClick(spot)" class="card-link">
                  預約 <i class="fas fa-chevron-right"></i>
                </a>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <el-dialog
      v-model="isMapVisible"
      title="確認租借位址"
      width="850px"
      destroy-on-close
      class="map-preview-dialog"
      border-radius="16px"
    >
      <div class="map-preview-body">
        <div class="spot-selector-header">
          <div v-if="selectedSpotForMap" class="spot-info-mini animate-fade">
            <div class="spot-title-row">
              <span class="spot-icon-bg"><i class="fas fa-chair"></i></span>
              <div class="spot-text-content">
                <h4>{{ selectedSpotForMap.name }}</h4>
                <p><i class="fas fa-map-marker-alt"></i> 即將為您跳轉至此點位的租借頁面</p>
              </div>
              <div class="spot-stats-mini">
                <span class="stat-item"><i class="fas fa-couch"></i> {{ selectedSpotForMap.seats }} 位可用</span>
              </div>
            </div>
          </div>
          <div v-else class="spot-info-mini placeholder animate-fade">
            <div class="spot-title-row">
              <span class="spot-icon-bg gray"><i class="fas fa-search-location"></i></span>
              <div class="spot-text-content">
                <h4>請選擇附近的站點</h4>
                <p><i class="fas fa-info-circle"></i> 點擊下方地圖上的標記以選擇租借點</p>
              </div>
            </div>
          </div>
        </div>

        <div class="map-container-wrapper">
          <GMapMap
            :center="mapCenter"
            :zoom="mapZoom"
            :options="{ 
              disableDefaultUI: false, 
              zoomControl: true, 
              mapTypeControl: false,
              streetViewControl: false,
              fullscreenControl: true,
              styles: [
                { featureType: 'poi', elementType: 'labels', stylers: [{ visibility: 'off' }] }
              ]
            }"
            style="width: 100%; height: 450px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);"
          >
            <GMapMarker
              v-for="spot in allSpots"
              :key="spot.id"
              :position="{ lat: spot.lat, lng: spot.lng }"
              :clickable="true"
              @click="handleMarkerClick(spot)"
              :icon="selectedSpotForMap && selectedSpotForMap.id === spot.id 
                ? 'http://maps.google.com/mapfiles/ms/icons/green-dot.png' 
                : 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'"
            >
              <GMapInfoWindow :opened="selectedSpotForMap && selectedSpotForMap.id === spot.id">
                <div class="map-info-window">
                  <h6>{{ spot.name }}</h6>
                  <p>剩餘 {{ spot.seats }} 個座位</p>
                  <span class="badge" :class="spot.status === '營運中' ? 'badge-success' : 'badge-danger'">
                    {{ spot.status }}
                  </span>
                </div>
              </GMapInfoWindow>
            </GMapMarker>
          </GMapMap>
        </div>
      </div>
      <template #footer>
        <div class="dialog-footer">
          <div class="login-hint" v-if="!memberAuthStore.isLogin && selectedSpotForMap">
            <i class="fas fa-lightbulb"></i> 登入後可享受更快速的租借體驗
          </div>
          <el-button @click="isMapVisible = false" round>返回瀏覽</el-button>
          <el-button 
            type="success" 
            @click="confirmAndRent" 
            class="confirm-btn" 
            :disabled="!selectedSpotForMap"
            round 
            block
          >
            {{ selectedSpotForMap ? '確認並開始租借' : '請選擇站點' }} <i class="fas fa-chevron-right ml-2"></i>
          </el-button>
        </div>
      </template>
    </el-dialog>
  </div>
</template>

<style scoped>
.home-view-wrapper { width: 100%; display: flex; flex-direction: column; }
.hero-container { position: relative; height: 100vh; width: 100%; overflow: hidden; display: flex; align-items: center; justify-content: center; background-color: #000; }
.hero-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('https://images.unsplash.com/photo-1497366216548-37526070297c?q=80&w=1920&auto=format&fit=crop'); background-size: cover; background-position: center; z-index: 0; animation: kenBurns 20s ease-in-out infinite alternate; }
.hero-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, rgba(0, 0, 0, 0.3) 0%, rgba(0, 0, 0, 0.6) 100%); z-index: 1; }
.hero-content { position: relative; z-index: 2; color: #ffffff; text-align: center; padding: 20px; }
.hero-title { font-size: 5rem; font-weight: 700; margin-bottom: 1rem; text-shadow: 2px 2px 15px rgba(0, 0, 0, 0.5); letter-spacing: 2px; }
.hero-subtitle { font-size: 1.5rem; font-weight: 300; margin-bottom: 2rem; text-shadow: 1px 1px 10px rgba(0, 0, 0, 0.5); letter-spacing: 1px; opacity: 0.9; }
.cta-buttons { display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; }
.cta-btn { display: inline-flex; align-items: center; justify-content: center; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-size: 1.1rem; font-weight: 500; transition: transform 0.2s ease, box-shadow 0.2s ease; border: 1px solid rgba(255, 255, 255, 0.5); min-width: 160px; }
.cta-btn:hover { transform: translateY(-3px); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); }
.cta-btn.primary { background-color: #4CAF50; color: white; font-size: 1.25rem; padding: 16px 40px; border: none; font-weight: 600; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4); }
.cta-btn.primary:hover { background-color: #45a049; transform: translateY(-5px); box-shadow: 0 8px 25px rgba(76, 175, 80, 0.6); }
.quick-search-card { margin-top: 40px; background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px); padding: 20px 30px; border-radius: 16px; border: 1px solid rgba(255, 255, 255, 0.3); width: 100%; max-width: 600px; margin-left: auto; margin-right: auto; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2); }

.search-input-wrapper-container { position: relative; width: 100%; }
.search-input-wrapper { display: flex; align-items: center; background: white; border-radius: 50px; padding: 5px 5px 5px 20px; margin-bottom: 12px; }
.search-icon { color: #909399; margin-right: 10px; }
.search-input-wrapper input { border: none; outline: none; flex: 1; font-size: 1rem; color: #333; }
.search-btn { background: #4CAF50; color: white; border: none; padding: 10px 24px; border-radius: 50px; cursor: pointer; font-weight: 600; transition: background 0.2s; }
.search-btn:hover { background: #45a049; }

/* 搜尋建議列表 */
.search-suggestions { position: absolute; top: 105%; left: 0; right: 0; background: white; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); list-style: none; padding: 8px 0; margin: 0; z-index: 1000; border: 1px solid #eee; text-align: left; }
.search-suggestions li { padding: 12px 20px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: background 0.2s; color: #333; }
.search-suggestions li:hover { background: #f5f7fa; }
.search-suggestions li i { color: #4CAF50; font-size: 0.9rem; }
.search-suggestions .spot-name { font-weight: 600; flex: 1; }
.search-suggestions .spot-status { font-size: 0.8rem; color: #909399; }

.hot-tags { display: flex; gap: 10px; font-size: 0.9rem; color: rgba(255, 255, 255, 0.9); justify-content: center; flex-wrap: wrap; }
.tag { cursor: pointer; text-decoration: underline; transition: color 0.2s; }
.tag:hover { color: #fff; text-shadow: 0 0 5px rgba(255, 255, 255, 0.5); }

.content-section { background-color: #f9f9f9; padding: 60px 20px; display: flex; flex-direction: column; gap: 80px; }
.section-header { text-align: center; margin-bottom: 40px; }
.section-header h2 { font-size: 2.5rem; color: #333; margin-bottom: 10px; font-weight: 700; }
.section-header p { color: #666; font-size: 1.1rem; }

.steps-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 30px; max-width: 1200px; margin: 0 auto; text-align: center; }
.step-item { padding: 20px; }
.step-icon { width: 80px; height: 80px; background: #e8f5e9; color: #4CAF50; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; margin: 0 auto 20px; transition: transform 0.3s; }
.step-item:hover .step-icon { transform: scale(1.1) rotate(5deg); }
.step-item h3 { font-size: 1.5rem; margin-bottom: 10px; color: #333; }
.step-item p { color: #666; line-height: 1.6; }

.spots-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 30px; max-width: 1200px; margin: 0 auto; width: 100%; }
.spot-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); transition: transform 0.3s, box-shadow 0.3s; }
.spot-card:hover { transform: translateY(-5px); box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1); }
.card-image { height: 200px; background-size: cover; background-position: center; position: relative; }
.status-badge { position: absolute; top: 10px; right: 10px; background: #4CAF50; color: white; padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; font-weight: 600; }
.status-badge.full { background: #f56c6c; }
.card-body { padding: 20px; }
.card-body h3 { margin: 0 0 10px; font-size: 1.2rem; color: #333; }
.card-meta { display: flex; justify-content: space-between; align-items: center; color: #666; font-size: 0.95rem; }
.card-link { color: #4CAF50; text-decoration: none; font-weight: 600; display: flex; align-items: center; gap: 5px; transition: gap 0.2s; }
.card-link:hover { gap: 8px; }

/* 地圖預覽彈窗 */
.map-preview-dialog :deep(.el-dialog__header) { border-bottom: 1px solid #f0f2f5; margin-right: 0; padding-bottom: 20px; }
.map-preview-dialog :deep(.el-dialog__body) { padding: 0; }
.spot-selector-header { padding: 20px 25px; background: #fafafa; }
.spot-info-mini { background: white; padding: 15px 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
.spot-info-mini.placeholder { background: transparent; box-shadow: none; border: 2px dashed #e4e7ed; }
.spot-title-row { display: flex; align-items: center; gap: 15px; }
.spot-icon-bg { width: 45px; height: 45px; background: #e8f5e9; color: #4CAF50; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
.spot-icon-bg.gray { background: #f4f4f5; color: #909399; }
.spot-text-content { flex: 1; }
.spot-info-mini h4 { margin: 0 0 4px; font-size: 1.25rem; color: #2c3e50; font-weight: 700; }
.spot-info-mini p { margin: 0; color: #7f8c8d; font-size: 0.9rem; }
.spot-stats-mini { display: flex; gap: 10px; }
.stat-item { background: #f0f9eb; color: #67c23a; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; }

.map-container-wrapper { padding: 15px 25px 25px; }
.map-info-window { padding: 5px; min-width: 120px; }
.map-info-window h6 { margin: 0 0 5px; font-weight: 700; color: #333; }
.map-info-window p { margin: 0 0 8px; font-size: 0.85rem; color: #666; }
.badge { font-size: 0.75rem; padding: 2px 8px; border-radius: 4px; }
.badge-success { background: #67c23a; color: white; }
.badge-danger { background: #f56c6c; color: white; }

.dialog-footer { display: flex; align-items: center; justify-content: flex-end; gap: 15px; padding: 0 10px; }
.login-hint { font-size: 0.85rem; color: #e6a23c; margin-right: auto; display: flex; align-items: center; gap: 6px; }
.confirm-btn { padding: 12px 30px; font-size: 1.1rem; font-weight: 600; min-width: 200px; box-shadow: 0 4px 12px rgba(103, 194, 58, 0.3); }
.confirm-btn:not(:disabled):hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(103, 194, 58, 0.4); }

.animate-fade { animation: fadeIn 0.4s ease-out; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

@keyframes kenBurns { 0% { transform: scale(1); } 100% { transform: scale(1.15); } }
.animate-up { opacity: 0; transform: translateY(30px); animation: fadeInUp 1s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
.delay-1 { animation-delay: 0.2s; }
.delay-2 { animation-delay: 0.4s; }
.delay-3 { animation-delay: 0.6s; }
@keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
</style>
</file>

<file path="frontend/src/views/maintenance/MaintenanceStaffList.vue">
<script setup>
import { ref, onMounted, computed, watch, nextTick, onBeforeUnmount } from 'vue'
import maintenanceApi from '@/api/modules/maintenance'
import Swal from 'sweetalert2'
import { useRouter } from 'vue-router'
import { usePagination } from '@/composables/maintenance/usePagination'
import { InfoFilled, Right, Delete, Check } from '@element-plus/icons-vue'
// ✅ 【修正】引入統一的人員狀態計算邏輯 (避免重複實作、確保統計卡與列表一致)
import {
  computeStaffStatus,
  computeStaffTaskStats,
  computeOverallStaffStats,
  isCompletedStatus,
} from '@/composables/maintenance/useStaffStatus'

const router = useRouter()
const staffList = ref([])
const searchText = ref('')
const loading = ref(true)
const pageVisible = ref(false)
const sortConfig = ref({ prop: 'staffId', order: 'ascending' })

// ✅ 修正：狀態中文化映射表（不改後端，僅前端顯示轉換）
const STATUS_LABEL = {
  REPORTED: '已回報',
  ASSIGNED: '已指派',
  UNDER_MAINTENANCE: '維修中',
  UNDER_MAINT: '維修中',
  UNDER_MAINTAIN: '保養中',
  IN_PROGRESS: '處理中',
  RESOLVED: '已結案',
  COMPLETED: '已完成',
  CANCELLED: '已取消',
  PENDING: '待處理',
  ON_HOLD: '暫停',
}

// ✅ 修正：安全轉換狀態為中文（找不到則顯示原值或 '-'）
const statusText = (status) => STATUS_LABEL[status] ?? status ?? '-'

// ====== el-table 跑版修正：強制重新計算欄寬 ======
const tableRef = ref(null)

const doLayoutSafe = async () => {
  await nextTick()
  tableRef.value?.doLayout?.()
}

const onResize = () => doLayoutSafe()
window.addEventListener('resize', onResize)
onBeforeUnmount(() => window.removeEventListener('resize', onResize))

// ====== 工單快取（用一次 API 建立 staff 狀態）======
const allTickets = ref([])
const ticketLoading = ref(false)

// ====== 機台與椅子資料快取（用於顯示目標名稱）======
const allSpots = ref([])
const allSeats = ref([])

// ====== 狀態篩選（全部 / 維護中 / 維修中 / 閒置中）======
const statusFilter = ref('ALL') // 'ALL' | 'UNDER_MAINTENANCE' | 'ASSIGNED' | 'IDLE'

// ====== ✅ 【新增】人員詳情視窗狀態 ======
const detailDialogVisible = ref(false)
const detailCurrentView = ref('profile') // 'profile' | 'tasks'
const detailCurrentStaff = ref(null)
const detailCurrentTaskType = ref('') // 'repair-pending' | 'maintenance-pending' | ...

// ====== 轉移工單 Dialog 狀態 ======
const showTransferDialog = ref(false)
const transferForm = ref({
  deleteStaffId: null,
  deleteStaffName: '',
  targetStaffId: null,
})
const transferLoading = ref(false)

// ★ 計算可選接手人員：排除要刪除的人 + 必須啟用中
const availableTargetStaff = computed(() => {
  return staffList.value.filter(
    (s) => s.staffId !== transferForm.value.deleteStaffId && s.isActive === true,
  )
})

// ✅ 【修正】API 資料讀取
const fetchStaff = async () => {
  try {
    loading.value = true
    const res = await maintenanceApi.getAllStaff()
    staffList.value = res.data || []
  } catch {
    // 錯誤已由 http.js 攔截器處理
  } finally {
    loading.value = false
  }
}

const fetchTickets = async () => {
  try {
    ticketLoading.value = true
    const res = await maintenanceApi.getAllTickets()
    allTickets.value = res.data || []
  } catch {
    allTickets.value = []
  } finally {
    ticketLoading.value = false
  }
}

// ✅ 【修正】使用統一的狀態計算函式 (取代原本的重複邏輯)
// 人員任務統計 Map (staffId -> 任務統計)
const staffTicketStatMap = computed(() => {
  const map = new Map()
  staffList.value.forEach((staff) => {
    const stats = computeStaffTaskStats(staff.staffId, allTickets.value)
    map.set(staff.staffId, stats)
  })
  return map
})

// ✅ 【修正】人員即時狀態計算 (統一呼叫 composable)
const getStaffWorkStatus = (staffId) => {
  return computeStaffStatus(staffId, allTickets.value)
}

/** ====== 刪除人員（含防呆轉移邏輯）====== */
const handleDelete = async (row) => {
  const result = await Swal.fire({
    title: '確定要停用此人員嗎？',
    html: `
      <div style="text-align: center;">
        <div style="width: 80px; height: 80px; margin: 0 auto 16px; background: linear-gradient(135deg, #f56c6c 0%, #f89898 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
          <i class="fas fa-user-slash" style="font-size: 36px; color: white;"></i>
        </div>
        <p style="font-size: 16px; margin-bottom: 20px;">即將停用 <b style="color: #f56c6c;">${row.staffName}</b></p>
        
        <div style="text-align: left; margin-bottom: 12px;">
            <label style="font-size: 13px; color: #606266; font-weight: bold; margin-bottom: 4px; display: block;">停用原因 (必選)</label>
            <select id="swal-reason-select" class="swal2-select" style="display: flex; width: 100%; margin: 0; padding: 0.5em; border: 1px solid #d9d9d9; border-radius: 4px;">
                <option value="" disabled selected>請選擇...</option>
                <option value="已終止合作">已終止合作</option>
                <option value="其他">其他原因</option>
            </select>
        </div>

        <div style="text-align: left;">
            <label style="font-size: 13px; color: #606266; font-weight: bold; margin-bottom: 4px; display: block;">詳細備註 (選填)</label>
            <textarea id="swal-reason-note" class="swal2-textarea" placeholder="可在此補充詳細說明..." style="margin: 0; width: 100%; height: 80px; font-size: 14px; border: 1px solid #d9d9d9; box-sizing: border-box;"></textarea>
        </div>
      </div>
    `,
    showCancelButton: true,
    confirmButtonColor: '#f56c6c',
    cancelButtonColor: '#909399',
    confirmButtonText: '<i class="fas fa-user-slash mr-1"></i> 確認並停用',
    cancelButtonText: '取消',
    showClass: { popup: 'animate__animated animate__fadeInDown animate__faster' },
    hideClass: { popup: 'animate__animated animate__fadeOutUp animate__faster' },
    customClass: { popup: 'custom-swal-popup' },
    // 透過 preConfirm 抓取兩個欄位的值
    preConfirm: () => {
      const selectVal = document.getElementById('swal-reason-select').value
      const noteVal = document.getElementById('swal-reason-note').value

      if (!selectVal) {
        Swal.showValidationMessage('請選擇停用原因')
        return false
      }

      // 回傳組合後的物件
      return { selectVal, noteVal }
    },
  })

  if (result.isConfirmed) {
    const { selectVal, noteVal } = result.value

    // 組合最終顯示的字串，例如："已終止合作 (詳細說明...)"
    // 如果沒有備註，就只存選單的值
    const finalReason = noteVal ? `${selectVal}：${noteVal}` : selectVal

    //取得當天日期(格式 YYYY/MM/DD )
    const today = new Date().toLocaleDateString('zh-TW', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
    })

    try {
      loading.value = true

      // --- 組合新的備註字串 (保持與歷史紀錄頁面的格式相容) ---
      const originalNote = row.staffNote || ''
      const newNote = `[停用原因：${finalReason}] [停用日期：${today}] \n${originalNote}`

      // 1. 先更新備註
      await maintenanceApi.updateStaff(row.staffId, {
        ...row,
        staffNote: newNote,
      })

      // 2. 再執行停用
      await maintenanceApi.deleteStaff(row.staffId)

      await fetchStaff()

      await Swal.fire({
        icon: 'success',
        title: '已停用',
        html: `
          <div style="text-align:center;">
            <span><b>${row.staffName}</b> 已移至歷史紀錄</span><br/>
            <span style="color: #909399; font-size: 13px; margin-top: 8px; display: inline-block; background: #f4f4f5; padding: 4px 8px; border-radius: 4px;">
              原因：${selectVal}
            </span>
          </div>
        `,
        timer: 900,
        timerProgressBar: true,
        showConfirmButton: false,
      })
    } catch (error) {
      const errorMsg = error?.response?.data?.message || error?.message || ''

      if (
        errorMsg.includes('未完成') ||
        errorMsg.includes('工單') ||
        error?.response?.status === 400
      ) {
        // 發生轉移需求時
        transferForm.value = {
          deleteStaffId: row.staffId,
          deleteStaffName: row.staffName,
          targetStaffId: null,
        }
        showTransferDialog.value = true

        // 額外提示：剛剛選的原因沒有存成功，轉移後可能需要重新操作(視後端邏輯而定)
      } else {
        Swal.fire('錯誤', '停用失敗，請稍後再試', 'error')
      }
    } finally {
      loading.value = false
    }
  }
}

/** ====== 移除不必要的 showHistoryModal (已改用 el-dialog 內部導覽) ====== */
// 此函式已整合到 handleViewTasks，不再需要

// ✅ 【修正】人員詳情視窗 (改用 el-dialog + 內部導覽)
const viewDetail = async (row) => {
  // 確保 tickets 有資料
  if (!allTickets.value.length && !ticketLoading.value) {
    await fetchTickets()
  }

  detailCurrentStaff.value = row
  detailCurrentView.value = 'profile'
  detailDialogVisible.value = true
}

// 點擊任務卡片 (切換到任務列表 view)
const handleViewTasks = (cardType) => {
  detailCurrentTaskType.value = cardType
  detailCurrentView.value = 'tasks'
}

// 計算任務列表資料 (根據 taskType 篩選)
// ✅【修正#1】任務列表分類也改成嚴格判定，確保「點卡片進去的清單」跟圖卡一致
const detailTaskList = computed(() => {
  if (!detailCurrentStaff.value || !detailCurrentTaskType.value) return []

  const staffId = detailCurrentStaff.value.staffId
  const cardType = detailCurrentTaskType.value
  const matchFn = (t) => t?.assignedStaffId === staffId

  const isDone = (t) => isCompletedStatus(t?.issueStatus)
  const isMaint = (t) => isMaintenanceTicketStrict(t)

  let filtered = []
  switch (cardType) {
    case 'repair-pending':
      filtered = (allTickets.value || []).filter((t) => matchFn(t) && !isMaint(t) && !isDone(t))
      break
    case 'maintenance-pending':
      filtered = (allTickets.value || []).filter((t) => matchFn(t) && isMaint(t) && !isDone(t))
      break
    case 'repair-completed':
      filtered = (allTickets.value || []).filter((t) => matchFn(t) && !isMaint(t) && isDone(t))
      break
    case 'maintenance-completed':
      filtered = (allTickets.value || []).filter((t) => matchFn(t) && isMaint(t) && isDone(t))
      break
    default:
      filtered = (allTickets.value || []).filter((t) => matchFn(t))
  }

  // 排序：最新在上
  const getTime = (t) => new Date(t?.reportedAt || t?.startAt || t?.resolvedAt || 0).getTime()
  filtered.sort((a, b) => getTime(b) - getTime(a))

  return filtered
})

// 任務類型標題對應
const taskTypeTitle = computed(() => {
  const map = {
    'repair-pending': '待修任務',
    'maintenance-pending': '待保養任務',
    'repair-completed': '維修完成',
    'maintenance-completed': '保養完成',
  }
  return map[detailCurrentTaskType.value] || '工單列表'
})

// 任務類型圖示對應
const taskTypeIcon = computed(() => {
  const map = {
    'repair-pending': 'fas fa-wrench',
    'maintenance-pending': 'fas fa-clipboard-list',
    'repair-completed': 'fas fa-check-circle',
    'maintenance-completed': 'fas fa-flag-checkered',
  }
  return map[detailCurrentTaskType.value] || 'fas fa-ticket-alt'
})

// 返回人員詳情
const backToProfile = () => {
  detailCurrentView.value = 'profile'
}

// 關閉詳情視窗
const closeDetailDialog = () => {
  detailDialogVisible.value = false
  detailCurrentView.value = 'profile'
  detailCurrentStaff.value = null
  detailCurrentTaskType.value = ''
}

// 格式化目標標籤
const getTargetLabel = (t) => {
  if (t.seatsId) {
    const seat = allSeats.value.find((s) => s.seatsId === t.seatsId)
    return seat ? `椅子: ${seat.seatsName}` : `椅子 #${t.seatsId}`
  }
  if (t.spotId) {
    const spot = allSpots.value.find((s) => s.spotId === t.spotId)
    return spot ? `機台: ${spot.spotName}` : `機台 #${t.spotId}`
  }
  return '未指定'
}

// ✅【修正#1】嚴格判定保養單：只認 issueType === '保養'
// 避免「檢查 / 例行 / 盤點」之類字眼被誤判成保養
const isMaintenanceTicketStrict = (t) => String(t?.issueType || '').trim() === '保養'

// ✅【修正#1】人員詳情四卡：在 Dialog 內用「嚴格判定」重新算一次
// 這樣就算 composable 判定有問題，詳情圖卡也不會顯示錯
const detailStaffStats = computed(() => {
  const staffId = detailCurrentStaff.value?.staffId
  if (!staffId) {
    return { repairCurrent: 0, maintainCurrent: 0, repairDone: 0, maintainDone: 0 }
  }

  const mine = (allTickets.value || []).filter((t) => t?.assignedStaffId === staffId)

  const current = mine.filter((t) => !isCompletedStatus(t?.issueStatus))
  const done = mine.filter((t) => isCompletedStatus(t?.issueStatus))

  const repairCurrent = current.filter((t) => !isMaintenanceTicketStrict(t)).length
  const maintainCurrent = current.filter((t) => isMaintenanceTicketStrict(t)).length
  const repairDone = done.filter((t) => !isMaintenanceTicketStrict(t)).length
  const maintainDone = done.filter((t) => isMaintenanceTicketStrict(t)).length

  return { repairCurrent, maintainCurrent, repairDone, maintainDone }
})

// ✅ 【移除】舊的 Swal 程式碼片段已清除，改用 el-dialog (見 template 區塊)

const handleAddNew = () => {
  Swal.fire({
    title: '新增維護人員',
    text: '即將前往新增人員表單',
    icon: 'info',
    timer: 600,
    timerProgressBar: true,
    showConfirmButton: false,
    showClass: { popup: 'animate__animated animate__fadeInRight animate__faster' },
  }).then(() => {
    router.push('/admin/staff-form')
  })
}

// ====== 執行轉移並刪除 ======
const handleTransferAndDelete = async () => {
  if (!transferForm.value.targetStaffId) {
    await Swal.fire({
      icon: 'warning',
      title: '請選擇接手人員',
      text: '必須指定一位接手人員來接收未完成的工單',
      confirmButtonColor: '#409eff',
    })
    return
  }

  transferLoading.value = true
  try {
    await maintenanceApi.transferAndDelete(
      transferForm.value.targetStaffId,
      transferForm.value.deleteStaffId,
    )

    showTransferDialog.value = false
    await fetchStaff()

    const targetStaff = staffList.value.find((s) => s.staffId === transferForm.value.targetStaffId)

    await Swal.fire({
      icon: 'success',
      title: '轉移成功！',
      html: `
        <div style="text-align: center;">
          <p>工單已轉移給 <b style="color: #67c23a;">${targetStaff?.staffName || '接手人員'}</b></p>
          <p style="color: #909399; font-size: 13px;"><b>${transferForm.value.deleteStaffName}</b> 已停用</p>
        </div>
      `,
      timer: 2000,
      timerProgressBar: true,
      showConfirmButton: false,
      showClass: { popup: 'animate__animated animate__bounceIn' },
    })
  } catch {
    // 錯誤已由 http.js 攔截器處理
  } finally {
    transferLoading.value = false
  }
}

// 關閉 Dialog
const closeTransferDialog = () => {
  showTransferDialog.value = false
  transferForm.value = {
    deleteStaffId: null,
    deleteStaffName: '',
    targetStaffId: null,
  }
}

/** 先過濾 active，再過濾狀態，再做搜尋 */
const filteredList = computed(() => {
  const key = searchText.value.trim().toLowerCase()

  const activeStaff = staffList.value.filter((s) => s.isActive === true)

  // ✅ 【修正】狀態篩選邏輯 (使用統一的 computeStaffStatus)
  const statusFiltered =
    statusFilter.value === 'ALL'
      ? activeStaff
      : activeStaff.filter((s) => getStaffWorkStatus(s.staffId).key === statusFilter.value)

  if (!key) return statusFiltered
  return statusFiltered.filter(
    (s) =>
      (s.staffName || '').toLowerCase().includes(key) ||
      (s.staffCompany || '').toLowerCase().includes(key) ||
      (s.staffPhone || '').includes(key),
  )
})

// 使用 usePagination composable
const {
  currentPage,
  pageSize,
  paginatedList,
  total: paginationTotal,
  showPagination,
  resetPagination,
} = usePagination(filteredList, { defaultPageSize: 10 })

watch([searchText, statusFilter], () => {
  resetPagination()
  doLayoutSafe()
})

watch([currentPage, pageSize], () => {
  doLayoutSafe()
})

const formatDate = (row, column, cellValue) => {
  if (!cellValue) return '-'
  return new Date(cellValue).toLocaleDateString('zh-TW')
}

// ✅ 【修正】統計卡片數字 (使用統一的狀態計算，確保與列表一致)
const activeCount = computed(() => staffList.value.filter((s) => s.isActive).length)

// 使用統一的 computeOverallStaffStats 計算整體狀態統計
const overallStats = computed(() => {
  const activeStaff = staffList.value.filter((s) => s.isActive)
  return computeOverallStaffStats(activeStaff, allTickets.value)
})

const maintainingCount = computed(() => overallStats.value.underMaintenance)
const assignedCount = computed(() => overallStats.value.assigned)
const idleCount = computed(() => overallStats.value.idle)

// ✅ 讓排程頁建立工單後，人員頁能即時同步圖卡
const onTicketsChanged = async () => {
  await fetchTickets()
}

// ============================================================================
// ✅ 【任務1修正】onMounted 使用 Promise.all 並行載入，提升效能與資料連動性
// ============================================================================
onMounted(async () => {
  try {
    // 【效能優化】同時呼叫四個 API，避免序列等待
    const [staffRes, ticketsRes, spotsRes, seatsRes] = await Promise.all([
      maintenanceApi.getAllStaff(),
      maintenanceApi.getAllTickets(),
      maintenanceApi.getAllSpots(),
      maintenanceApi.getAllSeats(),
    ])
    
    // 【資料連動】同步更新 staffList、allTickets、allSpots、allSeats
    staffList.value = staffRes.data || []
    allTickets.value = ticketsRes.data || []
    allSpots.value = spotsRes.data || []
    allSeats.value = seatsRes.data || []
    
    loading.value = false
    ticketLoading.value = false
  } catch (err) {
    console.error('載入人員或工單資料失敗:', err)
    loading.value = false
    ticketLoading.value = false
  }

  // ✅ 監聽跨頁事件：排程建立工單後會觸發
  window.addEventListener('maintenance:tickets-changed', onTicketsChanged)

  setTimeout(() => {
    pageVisible.value = true
    setTimeout(() => doLayoutSafe(), 150)
  }, 100)
})

onBeforeUnmount(() => {
  window.removeEventListener('maintenance:tickets-changed', onTicketsChanged)
})
</script>

<template>
  <div class="staff-list-container">
    <!-- 頁面標題區 -->
    <section class="content-header">
      <div class="container-fluid">
        <transition name="slide-down" appear>
          <div class="page-title-box">
            <div class="title-icon">
              <i class="fas fa-users-cog"></i>
            </div>
            <div class="title-content">
              <h1>維護人員管理</h1>
              <p class="subtitle">管理系統內的維護人員資料</p>
            </div>
            <div class="title-actions">
              <el-button-group>
                <el-button type="success" @click="handleAddNew" class="action-btn add-btn">
                  <i class="fas fa-user-plus mr-2"></i> 新增人員
                </el-button>
                <el-button
                  type="info"
                  plain
                  @click="router.push('/admin/staff-history')"
                  class="action-btn"
                >
                  <i class="fas fa-history mr-2"></i> 歷史紀錄
                </el-button>
              </el-button-group>
            </div>
          </div>
        </transition>
      </div>
    </section>

    <!-- 主內容區 -->
    <section class="content">
      <div class="container-fluid">
        <transition name="zoom-fade" appear>
          <div v-show="pageVisible">
            <!-- 統計卡片列：新增 3 張狀態卡 -->
            <el-row :gutter="20" class="mb-4">
              <el-col :xs="12" :sm="8" :md="6" :lg="4">
                <div class="stat-card active-card" @click="statusFilter = 'ALL'">
                  <div class="stat-icon pulse-animation">
                    <i class="fas fa-user-check"></i>
                  </div>
                  <div class="stat-info">
                    <h3>{{ activeCount }}</h3>
                    <span>在職人員</span>
                  </div>
                  <div class="stat-bg-icon"><i class="fas fa-users"></i></div>
                </div>
              </el-col>

              <el-col :xs="12" :sm="8" :md="6" :lg="4">
                <div class="stat-card filter-card" @click="statusFilter = 'UNDER_MAINTENANCE'">
                  <div
                    class="stat-icon"
                    style="background: linear-gradient(135deg, #e6a23c 0%, #f3d19e 100%)"
                  >
                    <i class="fas fa-wrench"></i>
                  </div>
                  <div class="stat-info">
                    <h3>{{ maintainingCount }}</h3>
                    <span>維修中</span>
                  </div>
                </div>
              </el-col>

              <el-col :xs="12" :sm="8" :md="6" :lg="4">
                <div class="stat-card filter-card" @click="statusFilter = 'ASSIGNED'">
                  <div
                    class="stat-icon"
                    style="background: linear-gradient(135deg, #409eff 0%, #a0cfff 100%)"
                  >
                    <i class="fas fa-user-check"></i>
                  </div>
                  <div class="stat-info">
                    <h3>{{ assignedCount }}</h3>
                    <span>已指派</span>
                  </div>
                </div>
              </el-col>

              <el-col :xs="12" :sm="8" :md="6" :lg="4">
                <div class="stat-card filter-card" @click="statusFilter = 'IDLE'">
                  <div
                    class="stat-icon"
                    style="background: linear-gradient(135deg, #67c23a 0%, #95d475 100%)"
                  >
                    <i class="fas fa-mug-hot"></i>
                  </div>
                  <div class="stat-info">
                    <h3>{{ idleCount }}</h3>
                    <span>閒置中</span>
                  </div>
                </div>
              </el-col>

              <el-col :xs="12" :sm="8" :md="6" :lg="4">
                <div class="stat-card filter-card">
                  <div
                    class="stat-icon"
                    style="background: linear-gradient(135deg, #909399 0%, #c0c4cc 100%)"
                  >
                    <i class="fas fa-search"></i>
                  </div>
                  <div class="stat-info">
                    <h3>{{ filteredList.length }}</h3>
                    <span>搜尋結果</span>
                  </div>
                </div>
              </el-col>
            </el-row>

            <!-- 資料表格卡片 -->
            <el-card shadow="hover" class="table-card">
              <template #header>
                <div class="card-header-content">
                  <div class="header-left">
                    <span class="header-icon">
                      <i class="fas fa-list-ul"></i>
                    </span>
                    <span class="header-text">人員名單</span>

                    <!-- 狀態 filter pills -->
                    <div class="ml-2" style="display: flex; gap: 6px; flex-wrap: wrap">
                      <el-tag
                        :effect="statusFilter === 'ALL' ? 'dark' : 'plain'"
                        type="info"
                        round
                        @click="statusFilter = 'ALL'"
                        style="cursor: pointer"
                      >
                        全部
                      </el-tag>
                      <el-tag
                        :effect="statusFilter === 'UNDER_MAINTENANCE' ? 'dark' : 'plain'"
                        type="warning"
                        round
                        @click="statusFilter = 'UNDER_MAINTENANCE'"
                        style="cursor: pointer"
                      >
                        維修中
                      </el-tag>

                      <el-tag
                        :effect="statusFilter === 'ASSIGNED' ? 'dark' : 'plain'"
                        type="primary"
                        round
                        @click="statusFilter = 'ASSIGNED'"
                        style="cursor: pointer"
                      >
                        已指派
                      </el-tag>

                      <el-tag
                        :effect="statusFilter === 'IDLE' ? 'dark' : 'plain'"
                        type="success"
                        round
                        @click="statusFilter = 'IDLE'"
                        style="cursor: pointer"
                      >
                        閒置中
                      </el-tag>
                    </div>

                    <el-tag type="success" effect="light" size="small" class="ml-2" round>
                      <i class="fas fa-circle" style="font-size: 6px; margin-right: 4px"></i>
                      {{ filteredList.length }} 位
                    </el-tag>
                  </div>

                  <div class="header-right">
                    <el-input
                      v-model="searchText"
                      placeholder="搜尋姓名、公司、電話..."
                      prefix-icon="Search"
                      clearable
                      class="search-input"
                    >
                      <template #append>
                        <el-button
                          icon="Refresh"
                          @click="
                            () => {
                              fetchStaff()
                              fetchTickets()
                            }
                          "
                        />
                      </template>
                    </el-input>
                  </div>
                </div>
              </template>

              <!-- 骨架屏載入 -->
              <div v-if="loading" class="loading-skeleton">
                <el-skeleton :rows="6" animated />
              </div>

              <!-- 資料表格 -->
              <el-table
                ref="tableRef"
                v-else
                :data="paginatedList"
                stripe
                highlight-current-row
                class="custom-table"
                style="width: 100%"
                table-layout="fixed"
                :header-cell-style="{ boxSizing: 'border-box' }"
                :cell-style="{ boxSizing: 'border-box' }"
                @row-dblclick="viewDetail"
              >
                <el-table-column prop="staffId" label="ID" width="70" align="center" sortable>
                  <template #default="{ row }">
                    <el-tag effect="plain" size="small">#{{ row.staffId }}</el-tag>
                  </template>
                </el-table-column>

                <el-table-column prop="staffName" label="姓名" width="160" sortable>
                  <template #default="{ row }">
                    <div class="name-cell" @click="viewDetail(row)">
                      <div class="name-avatar">
                        {{ row.staffName?.charAt(0) || '?' }}
                      </div>
                      <div class="name-info">
                        <span class="name-text">{{ row.staffName }}</span>
                        <span class="status-dot active"></span>
                      </div>
                    </div>
                  </template>
                </el-table-column>

                <!-- ✅ 新增欄位：目前狀態 -->
                <el-table-column label="目前狀態" width="120" align="center">
                  <template #default="{ row }">
                    <el-tag :type="getStaffWorkStatus(row.staffId).tagType" effect="light" round>
                      <i
                        :class="getStaffWorkStatus(row.staffId).icon"
                        style="margin-right: 6px"
                      ></i>
                      {{ getStaffWorkStatus(row.staffId).text }}
                    </el-tag>
                  </template>
                </el-table-column>

                <el-table-column prop="staffCompany" label="所屬公司" min-width="160">
                  <template #default="{ row }">
                    <div v-if="row.staffCompany" class="company-cell">
                      <i class="fas fa-building company-icon"></i>
                      <span>{{ row.staffCompany }}</span>
                    </div>
                    <span v-else class="text-muted">未填寫</span>
                  </template>
                </el-table-column>

                <el-table-column prop="staffPhone" label="聯絡電話" width="150">
                  <template #default="{ row }">
                    <div v-if="row.staffPhone" class="phone-cell">
                      <i class="fas fa-phone phone-icon"></i>
                      <span>{{ row.staffPhone }}</span>
                    </div>
                    <span v-else class="text-muted">-</span>
                  </template>
                </el-table-column>

                <el-table-column prop="staffEmail" label="Email" min-width="200">
                  <template #default="{ row }">
                    <el-tooltip v-if="row.staffEmail" :content="row.staffEmail" placement="top">
                      <div class="email-cell">
                        <i class="fas fa-envelope email-icon"></i>
                        <span>{{ row.staffEmail }}</span>
                      </div>
                    </el-tooltip>
                    <span v-else class="text-muted">-</span>
                  </template>
                </el-table-column>

                <el-table-column
                  prop="staffNote"
                  label="備註"
                  min-width="120"
                  show-overflow-tooltip
                >
                  <template #default="{ row }">
                    <span v-if="row.staffNote" class="note-cell">{{ row.staffNote }}</span>
                    <span v-else class="text-muted">-</span>
                  </template>
                </el-table-column>

                <el-table-column
                  prop="createdAt"
                  label="建立日期"
                  width="120"
                  :formatter="formatDate"
                />

                <el-table-column label="操作" width="180" align="center">
                  <template #default="{ row }">
                    <div class="action-buttons">
                      <el-tooltip content="查看詳情" placement="top">
                        <el-button
                          type="info"
                          size="small"
                          circle
                          @click="viewDetail(row)"
                          class="action-btn-item"
                        >
                          <i class="fas fa-eye"></i>
                        </el-button>
                      </el-tooltip>
                      <el-tooltip content="編輯資料" placement="top">
                        <el-button
                          type="primary"
                          size="small"
                          circle
                          @click="router.push(`/admin/staff-form/${row.staffId}`)"
                          class="action-btn-item"
                        >
                          <i class="fas fa-edit"></i>
                        </el-button>
                      </el-tooltip>
                      <el-tooltip content="停用人員" placement="top">
                        <el-button
                          type="danger"
                          size="small"
                          circle
                          @click="handleDelete(row)"
                          class="action-btn-item"
                        >
                          <i class="fas fa-user-slash"></i>
                        </el-button>
                      </el-tooltip>
                    </div>
                  </template>
                </el-table-column>

                <template #empty>
                  <el-empty
                    :description="
                      statusFilter === 'ALL' && !searchText
                        ? '目前沒有人員資料'
                        : '沒有符合條件的人員'
                    "
                  >
                    <template #image>
                      <div class="empty-icon">
                        <i class="fas fa-users-slash"></i>
                      </div>
                    </template>

                    <!-- ✅ 只有在「全部」且「完全沒資料」才顯示新增 -->
                    <el-button
                      v-if="statusFilter === 'ALL' && !searchText"
                      type="primary"
                      @click="handleAddNew"
                    >
                      <i class="fas fa-plus mr-1"></i> 新增第一位人員
                    </el-button>
                  </el-empty>
                </template>
              </el-table>

              <div class="pagination-wrapper" v-if="showPagination">
                <el-pagination
                  v-model:current-page="currentPage"
                  v-model:page-size="pageSize"
                  :page-sizes="[5, 10, 20, 50]"
                  :total="paginationTotal"
                  layout="total, sizes, prev, pager, next, jumper"
                  background
                />
              </div>
            </el-card>

            <div class="tips-bar mt-3">
              <el-alert type="info" :closable="false" show-icon>
                <template #title>
                  <span>💡 小提示：雙擊表格列可快速查看人員詳情；詳情四張卡可點進工單歷史</span>
                </template>
              </el-alert>
            </div>
          </div>
        </transition>
      </div>
    </section>

    <!-- ========== 轉移工單並刪除 Dialog ========== -->
    <!-- ✅ 修正：Dialog teleported 防裁切 -->
    <el-dialog
      v-model="showTransferDialog"
      title="轉移工單並刪除人員"
      width="500px"
      :close-on-click-modal="false"
      :close-on-press-escape="!transferLoading"
      @close="closeTransferDialog"
      :teleported="true"
      append-to-body
      :modal-append-to-body="true"
      :align-center="true"
      class="mt-transfer-dialog"
    >
      <div class="transfer-dialog-content">
        <el-alert type="warning" :closable="false" show-icon class="mb-4">
          <template #title>
            <strong>{{ transferForm.deleteStaffName }}</strong> 有未完成的工單
          </template>
          <template #default> 請選擇要將工單轉移給哪位人員後，才能刪除此人員。 </template>
        </el-alert>

        <el-form label-position="top">
          <el-form-item label="選擇接手人員" required>
            <el-select
              v-model="transferForm.targetStaffId"
              placeholder="請選擇接手人員"
              filterable
              style="width: 100%"
              :disabled="transferLoading"
            >
              <el-option
                v-for="staff in availableTargetStaff"
                :key="staff.staffId"
                :label="`${staff.staffName} (${staff.specialization || '未設定專長'})`"
                :value="staff.staffId"
              >
                <div class="transfer-option">
                  <span class="name">{{ staff.staffName }}</span>
                  <el-tag size="small" type="info">{{
                    staff.specialization || '未設定專長'
                  }}</el-tag>
                </div>
              </el-option>
            </el-select>
          </el-form-item>
        </el-form>

        <div class="transfer-preview" v-if="transferForm.targetStaffId">
          <el-divider content-position="left">
            <el-icon><InfoFilled /></el-icon> 操作預覽
          </el-divider>
          <div class="preview-content">
            <p>
              <el-icon color="#E6A23C"><Right /></el-icon>
              <strong>{{ transferForm.deleteStaffName }}</strong> 的所有未完成工單 將轉移給
              <strong>{{
                availableTargetStaff.find((s) => s.staffId === transferForm.targetStaffId)
                  ?.staffName
              }}</strong>
            </p>
            <p>
              <el-icon color="#F56C6C"><Delete /></el-icon>
              然後刪除人員 <strong>{{ transferForm.deleteStaffName }}</strong>
            </p>
          </div>
        </div>
      </div>

      <template #footer>
        <el-button @click="closeTransferDialog" :disabled="transferLoading"> 取消 </el-button>
        <el-button
          type="danger"
          :loading="transferLoading"
          :disabled="!transferForm.targetStaffId"
          @click="handleTransferAndDelete"
        >
          <el-icon v-if="!transferLoading"><Check /></el-icon>
          確認轉移並刪除
        </el-button>
      </template>
    </el-dialog>

    <!-- ========== ✅ 【新增】人員詳情 Dialog (支援內部導覽) ========== -->
    <!-- ✅ 修正：Dialog teleported 防裁切 + 位置居中 -->
    <el-dialog
      v-model="detailDialogVisible"
      :title="detailCurrentView === 'profile' ? '人員詳情' : taskTypeTitle"
      width="720px"
      :close-on-click-modal="false"
      @close="closeDetailDialog"
      :teleported="true"
      append-to-body
      :modal-append-to-body="true"
      :align-center="true"
      top="6vh"
      class="mt-staffDetail-dialog"
    >
      <!-- Profile View -->
      <div v-if="detailCurrentView === 'profile' && detailCurrentStaff" class="mt-staffDetail">
        <!-- ✅ UI 修復：人員基本資訊頭部 - 改用專用 class 避免撞名 -->
        <div class="mt-staffDetail__header">
          <div class="mt-staffDetail__avatar">
            {{ detailCurrentStaff.staffName?.charAt(0) || '?' }}
          </div>
          <div class="mt-staffDetail__info">
            <h3 class="mt-staffDetail__name">{{ detailCurrentStaff.staffName }}</h3>
            <el-tag :type="getStaffWorkStatus(detailCurrentStaff.staffId).tagType" size="small">
              <i :class="getStaffWorkStatus(detailCurrentStaff.staffId).icon" class="mr-1"></i>
              {{ getStaffWorkStatus(detailCurrentStaff.staffId).text }}
            </el-tag>
          </div>
        </div>

        <!-- ✅ UI 修復：任務統計四卡 - 使用 el-row/el-col 確保穩定佈局，避免 class 撞名 -->
        <el-row :gutter="12" class="mt-staffDetail__statGrid">
          <el-col :xs="12" :sm="12" :md="12">
            <div class="mt-statCard mt-statCard--repair" @click="handleViewTasks('repair-pending')">
              <div class="mt-statCard__left">
                <div class="mt-statCard__icon mt-statCard__icon--repair">
                  <i class="fas fa-wrench"></i>
                </div>
                <span class="mt-statCard__label">待修任務</span>
              </div>
              <div class="mt-statCard__value">
                {{ detailStaffStats.repairCurrent }}
              </div>
            </div>
          </el-col>

          <el-col :xs="12" :sm="12" :md="12">
            <div
              class="mt-statCard mt-statCard--maintenance"
              @click="handleViewTasks('maintenance-pending')"
            >
              <div class="mt-statCard__left">
                <div class="mt-statCard__icon mt-statCard__icon--maintenance">
                  <i class="fas fa-clipboard-list"></i>
                </div>
                <span class="mt-statCard__label">待保養</span>
              </div>
              <div class="mt-statCard__value">
                {{ detailStaffStats.maintainCurrent }}
              </div>
            </div>
          </el-col>

          <el-col :xs="12" :sm="12" :md="12">
            <div
              class="mt-statCard mt-statCard--completed"
              @click="handleViewTasks('repair-completed')"
            >
              <div class="mt-statCard__left">
                <div class="mt-statCard__icon mt-statCard__icon--completed">
                  <i class="fas fa-check-circle"></i>
                </div>
                <span class="mt-statCard__label">維修完成</span>
              </div>
              <div class="mt-statCard__value">
                {{ detailStaffStats.repairDone }}
              </div>
            </div>
          </el-col>

          <el-col :xs="12" :sm="12" :md="12">
            <div
              class="mt-statCard mt-statCard--done"
              @click="handleViewTasks('maintenance-completed')"
            >
              <div class="mt-statCard__left">
                <div class="mt-statCard__icon mt-statCard__icon--done">
                  <i class="fas fa-flag-checkered"></i>
                </div>
                <span class="mt-statCard__label">保養完成</span>
              </div>
              <div class="mt-statCard__value">
                {{ detailStaffStats.maintainDone }}
              </div>
            </div>
          </el-col>
        </el-row>

        <!-- ✅ UI 修復：人員資料區 - 優化 descriptions 樣式 -->
        <div class="mt-staffDetail__infoSection">
          <el-descriptions :column="1" border class="mt-staffDetail__descriptions">
            <el-descriptions-item
              label="所屬公司"
              label-align="right"
              label-class-name="mt-desc-label"
            >
              <i class="fas fa-building mr-2" style="color: #409eff"></i>
              {{ detailCurrentStaff.staffCompany || '未填寫' }}
            </el-descriptions-item>
            <el-descriptions-item
              label="聯絡電話"
              label-align="right"
              label-class-name="mt-desc-label"
            >
              <i class="fas fa-phone mr-2" style="color: #67c23a"></i>
              {{ detailCurrentStaff.staffPhone || '-' }}
            </el-descriptions-item>
            <el-descriptions-item
              label="電子郵件"
              label-align="right"
              label-class-name="mt-desc-label"
            >
              <i class="fas fa-envelope mr-2" style="color: #e6a23c"></i>
              {{ detailCurrentStaff.staffEmail || '-' }}
            </el-descriptions-item>
            <el-descriptions-item
              label="備註說明"
              label-align="right"
              label-class-name="mt-desc-label"
            >
              {{ detailCurrentStaff.staffNote || '無備註' }}
            </el-descriptions-item>
            <el-descriptions-item
              label="建立日期"
              label-align="right"
              label-class-name="mt-desc-label"
            >
              {{
                detailCurrentStaff.createdAt
                  ? new Date(detailCurrentStaff.createdAt).toLocaleDateString('zh-TW')
                  : '-'
              }}
            </el-descriptions-item>
          </el-descriptions>
        </div>
      </div>

      <!-- Tasks View -->
      <div v-else-if="detailCurrentView === 'tasks' && detailCurrentStaff" class="mt-taskView">
        <!-- ✅ UI 修復：返回按鈕區 -->
        <div class="mt-taskView__backBtn">
          <el-button @click="backToProfile" type="primary" plain size="small">
            <i class="fas fa-arrow-left mr-1"></i> 返回人員詳情
          </el-button>
        </div>

        <!-- ✅ UI 修復：加分項 - 任務列表標頭 -->
        <div class="mt-taskView__listHeader">
          <div class="mt-taskView__listTitle">
            <i :class="taskTypeIcon" class="mr-2"></i>
            <span>{{ taskTypeTitle }}</span>
          </div>
          <el-tag type="info" size="small" effect="plain">
            共 {{ detailTaskList.length }} 筆
          </el-tag>
        </div>

        <!-- 任務列表 -->
        <div v-if="detailTaskList.length > 0" class="mt-taskView__list">
          <el-table :data="detailTaskList" stripe max-height="400">
            <el-table-column prop="ticketId" label="工單" width="80" align="center">
              <template #default="{ row }">
                <el-tag size="small">#{{ row.ticketId }}</el-tag>
              </template>
            </el-table-column>
            <el-table-column label="目標" width="100">
              <template #default="{ row }">
                {{ getTargetLabel(row) }}
              </template>
            </el-table-column>
            <el-table-column prop="issueDesc" label="描述" min-width="150" show-overflow-tooltip />
            <el-table-column label="狀態" width="100" align="center">
              <template #default="{ row }">
                <!-- ✅ 修正：狀態顯示中文，保留原本的 tag 樣式邏輯 -->
                <el-tag :type="row.issueStatus === 'RESOLVED' ? 'success' : 'info'" size="small">
                  {{ statusText(row.issueStatus) }}
                </el-tag>
              </template>
            </el-table-column>
            <el-table-column label="時間" width="110">
              <template #default="{ row }">
                {{ row.reportedAt ? new Date(row.reportedAt).toLocaleDateString('zh-TW') : '-' }}
              </template>
            </el-table-column>
          </el-table>
        </div>
        <el-empty v-else description="暫無任務記錄" />
      </div>

      <template #footer v-if="detailCurrentView === 'profile'">
        <el-button @click="closeDetailDialog">關閉</el-button>
        <el-button
          type="primary"
          @click="router.push(`/admin/staff-form/${detailCurrentStaff?.staffId}`)"
        >
          <i class="fas fa-edit mr-1"></i> 編輯資料
        </el-button>
      </template>
    </el-dialog>
  </div>
</template>

<style scoped>
.staff-list-container {
  min-height: 100vh;
  background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
  padding-bottom: 40px;
}

.content-header {
  padding: 20px 1rem;
}

.page-title-box {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 20px 24px;
  background: white;
  border-radius: 16px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  flex-wrap: wrap;
}

.title-icon {
  width: 64px;
  height: 64px;
  border-radius: 16px;
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  color: white;
  transition: all 0.4s ease;
  box-shadow: 0 4px 15px rgba(64, 158, 255, 0.3);
}

.title-icon:hover {
  transform: scale(1.1) rotate(10deg);
}

.title-content {
  flex: 1;
  min-width: 200px;
}

.title-content h1 {
  margin: 0;
  font-size: 1.7rem;
  font-weight: 700;
  color: #303133;
  background: linear-gradient(135deg, #303133 0%, #606266 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.title-content .subtitle {
  margin: 6px 0 0;
  font-size: 0.9rem;
  color: #909399;
}

.title-actions {
  display: flex;
  gap: 10px;
}

.action-btn {
  border-radius: 10px;
  font-weight: 500;
  transition: all 0.3s ease;
}

.add-btn {
  background: linear-gradient(135deg, #67c23a 0%, #95d475 100%);
  border: none;
  box-shadow: 0 4px 15px rgba(103, 194, 58, 0.3);
}

.add-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(103, 194, 58, 0.4);
}

/* 統計卡片 */
.stat-card {
  position: relative;
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 20px;
  background: white;
  border-radius: 16px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
  transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  overflow: hidden;
  cursor: pointer;
  margin-bottom: 16px;
}

.stat-card:hover {
  transform: translateY(-6px);
  box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
}

.stat-icon {
  width: 56px;
  height: 56px;
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  color: white;
  z-index: 1;
}

.active-card .stat-icon {
  background: linear-gradient(135deg, #67c23a 0%, #95d475 100%);
}

.filter-card .stat-icon {
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
}

.stat-info {
  z-index: 1;
}

.stat-info h3 {
  margin: 0;
  font-size: 2rem;
  font-weight: 700;
  color: #303133;
}

.stat-info span {
  font-size: 0.85rem;
  color: #909399;
}

.stat-bg-icon {
  position: absolute;
  right: -10px;
  bottom: -10px;
  font-size: 80px;
  color: rgba(0, 0, 0, 0.03);
}

.pulse-animation {
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%,
  100% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.05);
  }
}

/* 表格卡片 */
.table-card {
  border-radius: 16px;
  overflow: hidden;
  border: none;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
}

.card-header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 12px;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 10px;
}

.header-icon {
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 16px;
}

.header-text {
  font-weight: 600;
  font-size: 1.1rem;
  color: #303133;
}

.search-input {
  width: 300px;
}

.search-input :deep(.el-input__wrapper) {
  border-radius: 10px 0 0 10px;
}

.search-input :deep(.el-input-group__append) {
  border-radius: 0 10px 10px 0;
}

/* 表格樣式 */
.custom-table {
  --el-table-header-bg-color: #f8f9fa;
}

/* 避免 scrollbar 有時出現有時消失造成欄寬抖動 */
.custom-table :deep(.el-table__body-wrapper) {
  overflow-y: scroll;
}

/* 保險：讓 header/body 計算一致 */
.custom-table :deep(.el-table__header),
.custom-table :deep(.el-table__body),
.custom-table :deep(th),
.custom-table :deep(td) {
  box-sizing: border-box;
}

.name-cell {
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  padding: 4px;
  border-radius: 8px;
  transition: all 0.3s ease;
}

.name-cell:hover {
  background: #f0f9eb;
}

.name-avatar {
  width: 36px;
  height: 36px;
  background: linear-gradient(135deg, #67c23a 0%, #95d475 100%);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 600;
  font-size: 14px;
  flex-shrink: 0;
}

.name-info {
  display: flex;
  align-items: center;
  gap: 6px;
}

.name-text {
  font-weight: 500;
  color: #303133;
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
}

.status-dot.active {
  background: #67c23a;
  box-shadow: 0 0 6px rgba(103, 194, 58, 0.6);
  animation: blink 2s infinite;
}

@keyframes blink {
  0%,
  100% {
    opacity: 1;
  }
  50% {
    opacity: 0.5;
  }
}

.company-cell,
.phone-cell,
.email-cell {
  display: flex;
  align-items: center;
  gap: 8px;
}

.company-icon {
  color: #409eff;
}
.phone-icon {
  color: #67c23a;
}
.email-icon {
  color: #e6a23c;
}

.email-cell {
  max-width: 180px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.note-cell {
  color: #606266;
  font-size: 13px;
}

/* 操作按鈕 */
.action-buttons {
  display: flex;
  justify-content: center;
  gap: 8px;
}

.action-btn-item {
  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.action-btn-item:hover {
  transform: scale(1.2);
}

/* 空狀態 */
.empty-icon {
  font-size: 64px;
  color: #dcdfe6;
  margin-bottom: 16px;
}

/* 分頁器 */
.pagination-wrapper {
  display: flex;
  justify-content: center;
  padding-top: 20px;
  border-top: 1px solid #ebeef5;
  margin-top: 20px;
}

/* 提示欄 */
.tips-bar :deep(.el-alert) {
  border-radius: 12px;
}

/* 過渡動畫 */
.slide-down-enter-active {
  transition: all 0.5s ease-out;
}
.slide-down-leave-active {
  transition: all 0.3s ease-in;
}
.slide-down-enter-from {
  transform: translateY(-30px);
  opacity: 0;
}
.slide-down-leave-to {
  transform: translateY(-20px);
  opacity: 0;
}

.zoom-fade-enter-active {
  transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.zoom-fade-leave-active {
  transition: all 0.3s ease-in;
}
.zoom-fade-enter-from {
  transform: scale(0.95);
  opacity: 0;
}
.zoom-fade-leave-to {
  transform: scale(0.98);
  opacity: 0;
}

/* 輔助類 */
.text-muted {
  color: #c0c4cc;
}
.mr-1 {
  margin-right: 4px;
}
.mr-2 {
  margin-right: 8px;
}
.ml-2 {
  margin-left: 8px;
}
.mb-4 {
  margin-bottom: 1.5rem;
}
.mt-3 {
  margin-top: 1rem;
}

/* ========== 轉移工單 Dialog 樣式 ========== */
.transfer-dialog-content {
  padding: 0 10px;
}

.transfer-option {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
}

.transfer-option .name {
  font-weight: 500;
}

.transfer-preview {
  background: linear-gradient(135deg, #f5f7fa 0%, #e8eef3 100%);
  border-radius: 8px;
  padding: 12px 16px;
  margin-top: 10px;
}

.transfer-preview .preview-content {
  font-size: 14px;
}

.transfer-preview .preview-content p {
  display: flex;
  align-items: center;
  gap: 6px;
  margin: 8px 0;
  color: #606266;
}

.transfer-preview .preview-content p strong {
  color: #303133;
}

:deep(.el-dialog__header) {
  border-bottom: 1px solid #ebeef5;
  padding-bottom: 15px;
}

:deep(.el-dialog__footer) {
  border-top: 1px solid #ebeef5;
  padding-top: 15px;
}

/* ========== ✅ 【新增】人員詳情 Dialog 樣式 ========== */
/* ✅ UI 修復：使用 mt- 前綴避免與 AdminLTE 全域 CSS 撞名 */

/* 詳情容器 */
.mt-staffDetail {
  padding: 0;
}

/* 人員頭部資訊卡 */
.mt-staffDetail__header {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 20px;
  background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
  border-radius: 12px;
  margin-bottom: 20px;
}

.mt-staffDetail__avatar {
  width: 64px;
  height: 64px;
  border-radius: 16px;
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 26px;
  font-weight: 800;
  box-shadow: 0 4px 15px rgba(64, 158, 255, 0.3);
  flex-shrink: 0;
}

.mt-staffDetail__info {
  flex: 1;
}

.mt-staffDetail__name {
  margin: 0 0 10px 0;
  font-size: 20px;
  font-weight: 700;
  color: #303133;
  line-height: 1.2;
}

/* ✅ UI 修復：統計卡片 Grid - 使用 BEM 命名避免撞名 */
.mt-staffDetail__statGrid {
  margin-bottom: 24px;
}

/* 單張統計卡 */
.mt-statCard {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 18px 20px;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
  border: 1px solid rgba(0, 0, 0, 0.04);
  height: 100%;
  min-height: 88px;
}

.mt-statCard:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
}

.mt-statCard:active {
  transform: translateY(-1px);
}

/* 左側：icon + 標籤 */
.mt-statCard__left {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.mt-statCard__icon {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  color: white;
  flex-shrink: 0;
}

.mt-statCard__icon--repair {
  background: linear-gradient(135deg, #f6b26b 0%, #f9cf9d 100%);
}

.mt-statCard__icon--maintenance {
  background: linear-gradient(135deg, #6aa8ff 0%, #91bfff 100%);
}

.mt-statCard__icon--completed {
  background: linear-gradient(135deg, #79d7a7 0%, #a3e4c1 100%);
}

.mt-statCard__icon--done {
  background: linear-gradient(135deg, #a0a6ad 0%, #c4c8cd 100%);
}

.mt-statCard__label {
  font-size: 13px;
  color: #606266;
  font-weight: 500;
  line-height: 1.2;
}

/* 右側：大數字 */
.mt-statCard__value {
  font-size: 32px;
  font-weight: 900;
  color: #303133;
  line-height: 1;
  margin-left: 12px;
}

/* 不同類型卡片背景色 */
.mt-statCard--repair {
  background: linear-gradient(135deg, #fff9f0 0%, #fef6ed 100%);
}

.mt-statCard--maintenance {
  background: linear-gradient(135deg, #f0f7ff 0%, #e6f2ff 100%);
}

.mt-statCard--completed {
  background: linear-gradient(135deg, #f0fdf4 0%, #e6faf0 100%);
}

.mt-statCard--done {
  background: linear-gradient(135deg, #f5f7fa 0%, #eef1f5 100%);
}

/* ✅ UI 修復：人員資料區 - 優化 descriptions 樣式 */
.mt-staffDetail__infoSection {
  margin-top: 0;
}

.mt-staffDetail__descriptions :deep(.el-descriptions__label) {
  width: 100px;
  font-weight: 600;
  color: #606266;
  background-color: #fafafa;
}

.mt-staffDetail__descriptions :deep(.el-descriptions__content) {
  color: #303133;
}

.mt-staffDetail__descriptions :deep(.el-descriptions__cell) {
  padding: 12px 16px;
}

/* ✅ UI 修復：Tasks View 樣式 */
.mt-taskView {
  padding: 0;
}

.mt-taskView__backBtn {
  margin-bottom: 16px;
}

.mt-taskView__listHeader {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 18px;
  background: linear-gradient(135deg, #f8f9fa 0%, #f0f2f5 100%);
  border-radius: 10px;
  margin-bottom: 16px;
  border: 1px solid #e4e7ed;
}

.mt-taskView__listTitle {
  display: flex;
  align-items: center;
  font-size: 15px;
  font-weight: 600;
  color: #303133;
}

.mt-taskView__list {
  margin-top: 0;
}

/* ✅ UI 修復：響應式設計 - 手機單欄或兩欄 */
@media (max-width: 576px) {
  .mt-staffDetail__header {
    flex-direction: column;
    text-align: center;
    padding: 16px;
  }

  .mt-staffDetail__avatar {
    width: 56px;
    height: 56px;
    font-size: 22px;
  }

  .mt-staffDetail__name {
    font-size: 18px;
  }

  .mt-statCard {
    padding: 14px 16px;
    min-height: 80px;
  }

  .mt-statCard__icon {
    width: 36px;
    height: 36px;
    font-size: 16px;
  }

  .mt-statCard__label {
    font-size: 12px;
  }

  .mt-statCard__value {
    font-size: 26px;
  }

  .mt-taskView__listHeader {
    padding: 12px 14px;
  }

  .mt-taskView__listTitle {
    font-size: 14px;
  }
}

/* ✅ 修正：Dialog 內部可滾動防超出視窗被裁切 */
:deep(.mt-staffDetail-dialog .el-dialog__body) {
  max-height: calc(100vh - 220px);
  overflow-y: auto;
  overflow-x: hidden;
}

:deep(.mt-transfer-dialog .el-dialog__body) {
  max-height: calc(100vh - 200px);
  overflow-y: auto;
  overflow-x: hidden;
}

/* ========== 舊的詳情樣式（已棄用，保留以防回溯需要）========== */
.detail-profile-header {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 16px;
  background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
  border-radius: 12px;
  margin-bottom: 20px;
}

.detail-profile-header .avatar {
  width: 60px;
  height: 60px;
  border-radius: 16px;
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 24px;
  font-weight: 800;
  box-shadow: 0 4px 15px rgba(64, 158, 255, 0.3);
}

.detail-profile-header .info h3 {
  margin: 0 0 8px 0;
  font-size: 18px;
  font-weight: 700;
  color: #303133;
}

.detail-task-cards {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 20px;
}

.detail-task-cards .task-card {
  padding: 16px;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  border: 1px solid rgba(255, 255, 255, 0.7);
}

.detail-task-cards .task-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.detail-task-cards .task-card.repair-pending {
  background: linear-gradient(135deg, #f6b26b 0%, #f9e0c7 100%);
  color: #1f2d3d;
}

.detail-task-cards .task-card.maintenance-pending {
  background: linear-gradient(135deg, #6aa8ff 0%, #d6e9ff 100%);
  color: #1f2d3d;
}

.detail-task-cards .task-card.repair-completed {
  background: linear-gradient(135deg, #79d7a7 0%, #e4f7ea 100%);
  color: #1f2d3d;
}

.detail-task-cards .task-card.maintenance-completed {
  background: linear-gradient(135deg, #aeb4bb 0%, #eef0f2 100%);
  color: #1f2d3d;
}

.detail-task-cards .task-card .card-header {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  opacity: 0.85;
  margin-bottom: 8px;
}

.detail-task-cards .task-card .card-value {
  font-size: 28px;
  font-weight: 900;
}

.detail-info-section {
  margin-top: 16px;
}

.detail-back-btn {
  margin-bottom: 16px;
}

.detail-task-list {
  margin-top: 12px;
}
</style>
</file>

<file path="frontend/src/views/spot/SpotForm.vue">
<template>
  <div class="spot-form-container">
    <!-- ========== Header 區域 ========== -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row align-items-center">
          <div class="col-sm-6">
            <div class="page-title-box">
              <div class="title-icon" :class="isEditMode ? 'edit-mode' : 'add-mode'">
                <i :class="isEditMode ? 'fas fa-edit' : 'fas fa-plus-circle'"></i>
              </div>
              <div class="title-content">
                <h1>{{ isEditMode ? '編輯據點' : '新增據點' }}</h1>
                <p class="subtitle">{{ isEditMode ? '修改據點資訊' : '建立新的營業據點' }}</p>
              </div>
            </div>
          </div>
          <div class="col-sm-6 text-right">
            <el-button @click="goBack">
              <i class="fas fa-arrow-left mr-1"></i> 返回列表
            </el-button>
          </div>
        </div>
      </div>
    </section>

    <section class="content">
      <div class="container-fluid">
        <transition name="zoom-fade" appear>
          <el-card shadow="hover" class="form-card">
            <el-form
              v-if="isEditMode && spotDataForView"
              :model="spotDataForView"
              label-width="120px"
              label-position="top"
              class="view-section"
              disabled
            >
              <div class="form-section">
                <div class="section-header">
                  <i class="fas fa-eye"></i>
                  <span>目前資料預覽</span>
                </div>
                <el-row :gutter="20">
                  <el-col :span="12">
                    <el-form-item label="據點代碼">
                      <el-input v-model="spotDataForView.spotCode" />
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="據點名稱">
                      <el-input v-model="spotDataForView.spotName" />
                    </el-form-item>
                  </el-col>
                </el-row>
              </div>
            </el-form>
            <!-- 1. 綁定 formRef (用於JS控制驗證) 與 rules (驗證規則物件) -->
            <el-form
              ref="formRef"
              :rules="rules"
              :model="formData"
              label-width="120px"
              label-position="top"
              class="modern-form"
              @submit.prevent="submitForm"
            >
              <!-- ========== 基本資料區 ========== -->
              <div class="form-section">
                <div class="section-header">
                  <i class="fas fa-info-circle"></i>
                  <span>編輯資料</span>
                </div>

                <el-row :gutter="20">
                  <el-col :span="12">
                    <!-- [修改說明] 2. 設定 prop="spotCode"，對應 rules 中的 key，驗證才會生效 -->
                    <el-form-item label="據點代碼 (Code)" prop="spotCode" required>
                      <el-input v-model="formData.spotCode" placeholder="例如: TP001" clearable>
                        <template #prefix><i class="fas fa-barcode"></i></template>
                      </el-input>
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <!-- [修改說明] 2. 設定 prop="spotName" -->
                    <el-form-item label="據點名稱 (Name)" prop="spotName" required>
                      <el-input v-model="formData.spotName" placeholder="例如: 台北車站店" clearable>
                        <template #prefix><i class="fas fa-store"></i></template>
                        <template #append>
                          <el-button @click="geocodeByName" :loading="geoLoading" title="依名稱搜尋座標"><i class="fas fa-search-location"></i></el-button>
                        </template>
                      </el-input>
                    </el-form-item>
                  </el-col>
                </el-row>

                <!--地址（Autocomplete + Enter geocode） -->
                <el-form-item label="地址 (Address)" prop="spotAddress">
  <el-input
    ref="addrElInputRef"
    v-model="formData.spotAddress"
    placeholder="請輸入地址"
    @keyup.enter="geocodeAddress({ force: true })"
  />
</el-form-item>

                <!-- 經緯度 -->
                <el-row :gutter="12">
                  <el-col :span="12">
                    <el-form-item label="緯度 Latitude" prop="latitude">
                      <el-input-number
                        v-model="formData.latitude"
                        :precision="7"
                        :step="0.000001"
                        style="width: 100%"
                        @change="manualOverride.lat = true"
                      />
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="經度 Longitude" prop="longitude">
                      <el-input-number
                        v-model="formData.longitude"
                        :precision="7"
                        :step="0.000001"
                        style="width: 100%"
                        @change="manualOverride.lng = true"
                      />
                    </el-form-item>
                  </el-col>
                </el-row>

                <div style="display:flex; gap:10px; margin-bottom: 12px;">
                  <el-button type="primary" :loading="geoLoading" @click="geocodeAddress({ force: true })">
                    依地址帶入經緯度
                  </el-button>
                  <el-button @click="manualOverride.lat=false; manualOverride.lng=false">
                    允許自動覆蓋
                  </el-button>
                </div>

                <!-- [新增] 地圖預覽與精確度提示 -->
                <div class="map-preview-container" v-if="formData.latitude && formData.longitude">
                  <div class="precision-info mb-2" v-if="geoPrecision">
                    <el-tag :type="getPrecisionTagType(geoPrecision)" effect="dark">
                      <i class="fas fa-crosshairs mr-1"></i>
                      定位精確度: {{ formatPrecision(geoPrecision) }}
                    </el-tag>
                    <span class="text-muted text-xs ml-2"><i class="fas fa-info-circle"></i> 若位置有偏差，可直接拖曳地圖上的紅色標記進行修正</span>
                  </div>
                  
                  <GMapMap
                    :center="{lat: formData.latitude, lng: formData.longitude}"
                    :zoom="16"
                    style="width: 100%; height: 350px; border-radius: 8px; border: 1px solid #dcdfe6;"
                  >
                    <GMapMarker
                      :position="{lat: formData.latitude, lng: formData.longitude}"
                      :draggable="true"
                      @dragend="onMarkerDragEnd"
                    />
                  </GMapMap>
                </div>

                <el-alert
                  v-if="geoError"
                  :title="geoError"
                  type="warning"
                  show-icon
                  :closable="false"
                  style="margin-bottom: 12px;"
                />

                <el-row :gutter="20">
                  <el-col :span="8">
                    <el-form-item label="所屬商家 (Merchant)">
                      <el-select
                        v-model="formData.merchantId"
                        placeholder="請選擇商家 (可留空)"
                        clearable
                        filterable
                        style="width: 100%"
                      >
                        <template #prefix><i class="fas fa-building"></i></template>
                        <el-option
                          v-for="item in merchantOptions"
                          :key="item.merchantId"
                          :label="item.merchantName"
                          :value="item.merchantId"
                        >
                          <span style="float: left">{{ item.merchantName }}</span>
                          <span style="float: right; color: #8492a6; font-size: 13px">ID: {{ item.merchantId }}</span>
                        </el-option>
                      </el-select>
                    </el-form-item>
                  </el-col>
                </el-row>

                <el-form-item label="描述 (Description)">
                  <el-input
                    v-model="formData.spotDescription"
                    type="textarea"
                    :rows="3"
                    placeholder="請輸入據點描述..."
                  />  
                </el-form-item>

                <el-row :gutter="20">
                  <el-col :span="12">
                    <el-form-item label="狀態">
                      <el-select v-model="formData.spotStatus" style="width: 100%">
                        <el-option label="營運中" value="營運中">
                          <i class="fas fa-check-circle text-success mr-2"></i> 營運中
                        </el-option>
                        <el-option label="維修中" value="維修中">
                          <i class="fas fa-tools text-warning mr-2"></i> 維修中
                        </el-option>
                        <el-option label="停用" value="停用">
                          <i class="fas fa-ban text-danger mr-2"></i> 停用
                        </el-option>
                      </el-select>
                    </el-form-item>
                  </el-col>
                </el-row>
              </div>

              <!-- ========== 圖片上傳區 (整合原有功能) ========== -->
              <div class="form-section">
                <div class="section-header">
                  <i class="fas fa-image"></i>
                  <span>據點圖片</span>
                </div>

                <el-form-item>
                  <div v-if="previewUrl" class="preview-section">
                    <div class="preview-header">
                      <p class="preview-title">圖片預覽：</p>
                      <el-button type="danger" size="small" @click="deleteImage" :loading="isUploading">
                        <i class="fas fa-trash mr-1"></i> 刪除圖片
                      </el-button>
                    </div>
                    <img :src="previewUrl" alt="預覽圖片" class="preview-image" />
                  </div>

                  <div v-else class="image-upload-area">
                    <input
                      type="file"
                      @change="handleFileChange"
                      accept="image/jpeg,image/jpg,image/png,image/gif,image/webp"
                      class="file-input"
                      id="image-upload"
                    />
                    <label for="image-upload" class="upload-label">
                      <i class="fas fa-cloud-upload-alt"></i>
                      <span>點擊或拖曳上傳圖片</span>
                      <span class="upload-hint">支援 JPG, PNG, GIF, WebP (最大 5MB)</span>
                    </label>
                  </div>

                  <div v-if="isUploading" class="uploading-hint">
                    <i class="el-icon-loading"></i> 上傳中...
                  </div>
                </el-form-item>
              </div>

              <div class="form-actions">
                <el-button @click="goBack" class="back-btn">
                  <i class="fas fa-times mr-1"></i> 取消
                </el-button>
                <el-button type="primary" @click="submitForm" :loading="isSubmitting" class="submit-btn">
                  <i class="fas fa-save mr-1"></i> {{ isSubmitting ? '處理中...' : '儲存資料' }}
                </el-button>
              </div>
            </el-form>
          </el-card>
        </transition>
      </div>
    </section>
  </div>
</template>

<script setup>
import { ref, onMounted, computed, reactive, watch, nextTick, onUnmounted } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import axios from 'axios'
import Swal from 'sweetalert2'
import { useGoogleMaps } from '@/composables/spot/useGoogleMaps'

defineOptions({ name: 'SpotForm' })

const route = useRoute()
const router = useRouter()

//  後端 Controller 是 /spot（沒有 /api）
const API_BASE = '/spot'
const MERCHANT_API_BASE = '/spot/merchants'

// 3. 定義 formRef 變數，對應 template 中的 ref="formRef"
const formRef = ref(null)

// 4. 定義驗證規則：必填 (required: true) 與 觸發時機 (trigger: 'blur' 失焦時)
const rules = {
  spotCode: [{ required: true, message: '請輸入據點代碼', trigger: 'blur' }],
  spotName: [{ required: true, message: '請輸入據點名稱', trigger: 'blur' }],
  spotAddress: [{ required: true, message: '請輸入地址', trigger: 'change' }],
}

// ========== Geo（地址 → 經緯度）狀態 ==========
// [關鍵] 手動鎖定旗標。當使用者手動修改經緯度或拖曳地圖標記時，
// 此旗標會設為 true，用來防止 `watch` 自動觸發的 geocodeAddress 覆蓋掉手動輸入。
const manualOverride = reactive({ lat: false, lng: false })

// ========== 狀態定義 ==========
const isEditMode = computed(() => !!route.params.id)
const isSubmitting = ref(false)
const selectedFile = ref(null)
const previewUrl = ref('')
const spotDataForView = ref(null) // [新增] 用於顯示的原始資料
const isUploading = ref(false)
const merchantOptions = ref([])

// ========== 表單資料模型 ==========
const formData = ref({
  spotCode: '',
  spotName: '',
  spotAddress: '',
  latitude: null,
  longitude: null,
  merchantId: '',
  spotDescription: '',
  spotStatus: '營運中',
  spotImage: '',
})

/**
 * [核心] 引入並使用 useGoogleMaps Composable。
 * 將所有地圖相關的狀態 (geoLoading) 和方法 (geocodeByName) 解構出來，直接在 template 和 script 中使用。
 */
const {
  geoLoading,
  geoError,
  geoPrecision,
  gmapAutoRef,
  addrElInputRef,
  initPlacesAutocomplete ,
  syncAddressToNativeInput,
  onPlaceChangedForForm,
  geocodeAddress,
  geocodeByName,
  onMarkerDragEnd,
  formatPrecision,
  getPrecisionTagType
} = useGoogleMaps(formData, manualOverride)

/**
 * [途徑 A-2 的觸發點] 監聽地址輸入框的變化。
 * 使用 setTimeout 實現防抖 (Debounce) 機制：
 * - 當使用者連續輸入時，會不斷清除舊的計時器。
 * - 直到使用者停止輸入 700 毫秒後，才會真正執行 geocodeAddress。
 * - 這樣可以避免在打字過程中發送大量不必要的 API 請求。
 */
let geoTimer = null
watch(
  () => formData.value.spotAddress,
  (v) => {
    geoError.value = ''
    if (!v || v.trim().length < 6) return
    clearTimeout(geoTimer)
    geoTimer = setTimeout(() => {
      geocodeAddress({ force: false })
    }, 700)
  },
)

// [優化] 元件銷毀時清除計時器，避免在頁面切換後，計時器依然執行，導致非預期的行為或記憶體洩漏。
onUnmounted(() => {
  if (geoTimer) clearTimeout(geoTimer)
})

// ========== 取得商家列表 ==========
const fetchMerchants = async () => {
  try {
    const res = await axios.get(MERCHANT_API_BASE)
    merchantOptions.value = res.data
  } catch (error) {
    console.error('無法取得商家列表:', error)
  }
}

// ========== 初始化：編輯模式載入資料 ==========
onMounted(async () => {
  // [初始化步驟 1] 等待 Vue 將模板渲染成真實的 DOM。
  // 這是必要的，因為 initPlacesAutocomplete 需要抓取 <el-input> 內部的 <input> 元素。
  await nextTick()
  // [初始化步驟 2] 呼叫 Composable 中的初始化函式，將 Google Autocomplete 綁定到地址輸入框。
  await initPlacesAutocomplete()

  // 載入商家選項
  await fetchMerchants()

  // 如果是編輯模式，則從後端載入既有資料。
  if (isEditMode.value) {
    try {
      const res = await axios.get(`${API_BASE}/${route.params.id}`)
      console.log('api回傳值 res.data =', res.data)
      console.log('api回傳 spotAddress =', res.data?.spotAddress)

      formData.value = { ...formData.value, ...res.data }
      spotDataForView.value = { ...res.data } // [新增] 將原始資料存入顯示用的 ref

      manualOverride.lat = false
      manualOverride.lng = false
      geoPrecision.value = '' // 既有資料不確定精確度，先留空

      if (formData.value.spotImage) {
        previewUrl.value = `http://localhost:8080/${formData.value.spotImage}`
      }

      // [關鍵] 載入資料後，呼叫 Composable 中的同步函式。
      // 確保從 API 取得的地址能夠正確顯示在被 Google 腳本控制的輸入框中。
      syncAddressToNativeInput()
    } catch (err) {
      console.error('載入失敗', err)
      Swal.fire({
        title: '載入失敗',
        html: '<div style="display:flex;flex-direction:column;align-items:center;"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#f56c6c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg><p style="margin-top:12px;">無法載入據點資料</p></div>',
        confirmButtonColor: '#409eff',
        confirmButtonText: '確定',
      })
    }
  }
})

// ========== 處理檔案選擇 ==========
const handleFileChange = async (event) => {
  const file = event.target.files[0]
  if (!file) return

  if (!file.type.startsWith('image/')) {
    Swal.fire({
      icon: 'error',
      title: '檔案類型錯誤',
      text: '只能上傳圖片檔案 (jpg, png, gif)',
      confirmButtonColor: '#409eff',
    })
    return
  }

  if (file.size > 5 * 1024 * 1024) {
    Swal.fire({
      icon: 'error',
      title: '檔案過大',
      text: '圖片大小不能超過 5MB',
      confirmButtonColor: '#409eff',
    })
    return
  }

  selectedFile.value = file
  previewUrl.value = URL.createObjectURL(file)

  if (isEditMode.value) {
    await uploadImage()
  }
}

// ========== 上傳圖片到後端 ==========
const uploadImage = async () => {
  if (!selectedFile.value) return

  isUploading.value = true
  const formDataUpload = new FormData()
  formDataUpload.append('image', selectedFile.value)

  try {
    const res = await axios.post(`${API_BASE}/${route.params.id}/upload-image`, formDataUpload, {
      headers: { 'Content-Type': 'multipart/form-data' },
    })

    formData.value.spotImage = res.data.filePath
    previewUrl.value = `http://localhost:8080${res.data.imageUrl}`

    Swal.fire({
      icon: 'success',
      title: '上傳成功',
      text: '圖片已成功上傳',
      timer: 1500,
      showConfirmButton: false,
    })
  } catch (error) {
    console.error('上傳失敗:', error)
    Swal.fire({
      icon: 'error',
      title: '上傳失敗',
      text: error.response?.data?.message || '圖片上傳失敗',
      confirmButtonColor: '#409eff',
    })
  } finally {
    isUploading.value = false
  }
}

// ========== 刪除圖片 ==========
const deleteImage = async () => {
  const result = await Swal.fire({
    title: '確定要刪除圖片嗎？',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#f56c6c',
    cancelButtonColor: '#909399',
    confirmButtonText: '刪除',
    cancelButtonText: '取消',
  })

  if (!result.isConfirmed) return

  if (isEditMode.value && formData.value.spotImage) {
    try {
      await axios.delete(`${API_BASE}/${route.params.id}/image`)
      formData.value.spotImage = ''
      previewUrl.value = ''
      selectedFile.value = null

      Swal.fire({
        icon: 'success',
        title: '已刪除',
        text: '圖片已成功刪除',
        timer: 1500,
        showConfirmButton: false,
      })
    } catch (error) {
      Swal.fire({
        icon: 'error',
        title: '刪除失敗',
        text: error.response?.data?.message || '無法刪除圖片',
        confirmButtonColor: '#409eff',
      })
    }
  } else {
    previewUrl.value = ''
    selectedFile.value = null
    formData.value.spotImage = ''
  }
}

// ========== 提交表單 ==========
const submitForm = async () => {
  //  5. 確保 formRef 已掛載
  if (!formRef.value) return
  
  try {
    //  6. 執行表單驗證，若驗證失敗會拋出錯誤並跳到 catch 區塊，阻止後續 API 呼叫
    await formRef.value.validate()
  } catch (error) {
    Swal.fire({ icon: 'warning', title: '資料不完整', text: '請檢查必填欄位是否已填寫' })
    return
  }

  isSubmitting.value = true
  try {
    const payload = {
      spotCode: formData.value.spotCode,
      spotName: formData.value.spotName,
      spotAddress: formData.value.spotAddress,
      latitude:
        formData.value.latitude === '' || formData.value.latitude === null || formData.value.latitude === undefined
          ? null
          : Number(formData.value.latitude),
      longitude:
        formData.value.longitude === '' || formData.value.longitude === null || formData.value.longitude === undefined
          ? null
          : Number(formData.value.longitude),
      spotDescription: formData.value.spotDescription,
      spotStatus: formData.value.spotStatus,
      spotImage: formData.value.spotImage,
      merchantId:
        formData.value.merchantId === '' || formData.value.merchantId === null || formData.value.merchantId === undefined
          ? null
          : Number(formData.value.merchantId),
    }

    if (isEditMode.value) {
      payload.spotId = Number(route.params.id)
      await axios.put(`${API_BASE}/${route.params.id}`, payload)

      await Swal.fire({
        title: '更新成功',
        html: '<div style="display:flex;flex-direction:column;align-items:center;"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#67c23a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg><p style="margin-top:12px;">據點資料已成功更新</p></div>',
        confirmButtonColor: '#409eff',
        confirmButtonText: '確定',
      })
    } else {
      const res = await axios.post(`${API_BASE}`, payload)

      if (selectedFile.value && res.data?.spotId) {
        const spotId = res.data.spotId
        const formDataUpload = new FormData()
        formDataUpload.append('image', selectedFile.value)

        await axios.post(`${API_BASE}/${spotId}/upload-image`, formDataUpload, {
          headers: { 'Content-Type': 'multipart/form-data' },
        })
      }

      await Swal.fire({
        title: '新增成功',
        html: '<div style="display:flex;flex-direction:column;align-items:center;"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#67c23a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg><p style="margin-top:12px;">據點資料已成功新增</p></div>',
        confirmButtonColor: '#409eff',
        confirmButtonText: '確定',
      })
    }

    router.push({ name: 'spot-list' })
  } catch (error) {
    console.error('儲存錯誤:', error)
    const msg = error.response?.data?.message || error.message || '儲存失敗，請檢查輸入資料或後端連線'
    Swal.fire({
      title: '操作失敗',
      html: `<div style="display:flex;flex-direction:column;align-items:center;"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#f56c6c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg><p style="margin-top:12px;">${msg}</p></div>`,
      confirmButtonColor: '#409eff',
      confirmButtonText: '確定',
    })
  } finally {
    isSubmitting.value = false
  }
}

const goBack = () => router.back()
</script>

<style scoped>
/* ========== 頁面容器 ========== */
.spot-form-container {
  padding: 20px;
  background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
  min-height: 100vh;
}

.view-section {
  background-color: #f9fafb;
  padding: 20px;
  border-radius: 8px;
  margin-bottom: 30px;
}
/* ========== 頁面標題區 ========== */
.page-title-box {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 16px 24px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
}

.title-icon {
  width: 56px;
  height: 56px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  color: white;
  transition: transform 0.3s ease;
}

.title-icon:hover {
  transform: scale(1.1) rotate(5deg);
}

.add-mode {
  background: linear-gradient(135deg, #67c23a 0%, #95d475 100%);
}

.edit-mode {
  background: linear-gradient(135deg, #e6a23c 0%, #f3d19e 100%);
}

.title-content h1 {
  margin: 0;
  font-size: 1.5rem;
  font-weight: 600;
  color: #303133;
}

.title-content .subtitle {
  margin: 4px 0 0;
  font-size: 0.875rem;
  color: #909399;
}

/* ========== 表單卡片 ========== */
.form-card {
  border-radius: 12px;
  max-width: 900px;
  margin: 0 auto;
}

.form-section {
  margin-bottom: 32px;
}

.section-header {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 1.1rem;
  font-weight: 600;
  color: #409eff;
  margin-bottom: 20px;
  padding-bottom: 12px;
  border-bottom: 2px solid #409eff;
}

.map-preview-container {
  margin-bottom: 20px;
}

/* ========== 圖片上傳 ========== */
.image-upload-area {
  border: 2px dashed #dcdfe6;
  border-radius: 12px;
  padding: 40px;
  text-align: center;
  transition: all 0.3s ease;
  cursor: pointer;
}

.image-upload-area:hover {
  border-color: #409eff;
  background: rgba(64, 158, 255, 0.05);
}

.file-input {
  display: none;
}

.upload-label {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  color: #909399;
}

.upload-label i {
  font-size: 48px;
  color: #c0c4cc;
}

.upload-hint {
  font-size: 12px;
  color: #c0c4cc;
  margin-top: 4px;
}

.preview-section {
  margin-top: 16px;
}

.preview-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.preview-title {
  color: #909399;
  font-size: 14px;
  margin: 0;
}

.preview-image {
  max-width: 100%;
  max-height: 300px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  display: block;
  margin: 0 auto;
}

.uploading-hint {
  text-align: center;
  color: #409eff;
  font-size: 14px;
  margin-top: 12px;
}

/* ========== 按鈕區 ========== */
.form-actions {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  padding-top: 24px;
  margin-top: 24px;
  border-top: 1px solid #ebeef5;
}

.submit-btn {
  min-width: 140px;
  border-radius: 10px;
  font-weight: 600;
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
  border: none;
  transition: all 0.3s ease;
}

.submit-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(64, 158, 255, 0.4);
}

.back-btn {
  min-width: 100px;
  border-radius: 10px;
}

/* ========== 動畫效果 ========== */
.zoom-fade-enter-active {
  transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.zoom-fade-leave-active {
  transition: all 0.3s ease-in;
}

.zoom-fade-enter-from {
  transform: scale(0.9);
  opacity: 0;
}

.zoom-fade-leave-to {
  transform: scale(0.95);
  opacity: 0;
}

/* ========== 工具類 ========== */
.mr-1 { margin-right: 4px; }
.mr-2 { margin-right: 8px; }
.text-success { color: #67c23a; }
.text-warning { color: #e6a23c; }
.text-danger { color: #f56c6c; }

@media (max-width: 768px) {
  .page-title-box {
    flex-direction: column;
    text-align: center;
    gap: 12px;
  }
}
</style>
</file>

<file path="frontend/src/views/member/MemberProfileView.vue">
<script setup>
import { ref, onMounted } from 'vue'
import axios from 'axios'

import { useMemberAuthStore } from '@/stores/memberAuth'

import RecRentUserRecord from '@/components/rec/RecRentUserRecord.vue'

import Swal from 'sweetalert2'

const memberAuth = useMemberAuthStore()
const member = ref(null)
const form = ref({})
const isEdit = ref(false)
const errorMsg = ref('')

// 租借狀態相關
const activeRent = ref(null) // 進行中的租借訂單
const rentSpotName = ref('') // 租借站點的名稱
const isLoadingRentStatus = ref(true) // 租借狀態的讀取狀態

// [新增] 控制歷史紀錄顯示
const showHistory = ref(false)
const toggleHistory = () => {
  showHistory.value = !showHistory.value
}

const originForm = ref({})

const fetchProfile = async () => {
  try {
    const res = await axios.get('http://localhost:8080/member/profile', {
      withCredentials: true,
    })

    const m = res.data
    member.value = m

    // 一定要 trim，避免空白 bug
    form.value = {
      memName: m.memName?.trim() || '',
      memPhone: m.memPhone?.trim() || '',
      memEmail: m.memEmail?.trim() || '',
      memInvoice: m.memInvoice?.trim() || '',
    }
    memberAuth.setMemberLogin(m) // 更新 Pinia store

    // 取得個人資料後，接著取得租借狀態
    await fetchRentalStatus()
  } catch (e) {
    errorMsg.value = '尚未登入'
  }
}

// 查詢租借狀態
const fetchRentalStatus = async () => {
  isLoadingRentStatus.value = true
  try {
    const memId = memberAuth.member?.memId
    if (!memId) {
      activeRent.value = null
      return
    }

    // 查詢會員的租借紀錄，目的是為了找到進行中訂單的 ID
    const rentListRes = await axios.get(`http://localhost:8080/rec-rent?memId=${memId}`)
    const basicRentInfo = rentListRes.data.find((rent) => rent.recStatus === '租借中')

    // 如果找到進行中的訂單
    if (basicRentInfo && basicRentInfo.recId) {
      try {
        // 使用訂單 ID 去查詢完整的、包含站點名稱的詳細資訊
        const detailsRes = await axios.get(
          `http://localhost:8080/api/rent-details/${basicRentInfo.recId}`,
        )
        const currentRentDetails = detailsRes.data

        if (currentRentDetails) {
          activeRent.value = currentRentDetails
          // 直接從回傳的詳細資料中取得站點名稱
          rentSpotName.value = currentRentDetails.spotNameRent || '未知站點'
        } else {
          activeRent.value = null // 如果詳細資料查無，也當作沒有
        }
      } catch (detailsError) {
        console.error(`查詢訂單詳細資訊 ${basicRentInfo.recId} 失敗:`, detailsError)
        // Fallback: 即使詳細資料查詢失敗，仍然顯示基本資訊
        activeRent.value = basicRentInfo
        rentSpotName.value = '站點資料讀取失敗'
      }
    } else {
      // 如果連基本訂單都找不到，則確認無租借中訂單
      activeRent.value = null
    }
  } catch (error) {
    console.error('查詢租借狀態失敗:', error)
    activeRent.value = null
  } finally {
    isLoadingRentStatus.value = false
  }
}

onMounted(fetchProfile)

const formatDate = (dt) => {
  if (!dt) return ''
  return dt.substring(0, 10).replace(/-/g, '-')
}

// [新增] 格式化日期時間的函式
const formatDateTime = (dt) => {
  if (!dt) return ''
  const date = new Date(dt)
  return date
    .toLocaleString('zh-TW', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: false,
    })
    .replace(/\//g, '-')
}

const startEdit = () => {
  originForm.value = { ...form.value }
  isEdit.value = true
}

const cancelEdit = () => {
  isEdit.value = false
  fetchProfile()
}

const saveEdit = async () => {
  // 密碼格式初步檢查 (前端擋路)
  const passwordRegex = /^(?=.*[A-Za-z])[A-Za-z\d!@#$%^&*()_+=\[\]{}:;"'<>,.?/\-]{6,}$/
  if (form.value.memPassword && !passwordRegex.test(form.value.memPassword)) {
    Swal.fire('格式錯誤', '密碼必須至少 6 碼且包含 1 個英文字母', 'error')
    return
  }

  const phoneRegex = /^09\d{8}$/
  if (!phoneRegex.test(form.value.memPhone.trim())) {
    Swal.fire('格式錯誤', '手機號碼請輸入 09 開頭的 10 碼數字', 'error')
    return
  }

  // Email 格式：標準電子郵件，結尾需為 .com
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]*com$/
  if (!emailRegex.test(form.value.memEmail.trim())) {
    Swal.fire('格式錯誤', 'Email 格式不正確（需包含 @ 且以 .com 結尾）', 'error')
    return
  }

  // 發票載具：/ 開頭，後接 7 碼大寫英文或數字
  const invoiceRegex = /^\/[A-Z0-9]{7}$/
  if (form.value.memInvoice && !invoiceRegex.test(form.value.memInvoice.trim())) {
    Swal.fire('格式錯誤', '發票載具格式錯誤（應為 / 開頭加上 7 碼大寫英數）', 'error')
    return
  }

  // 二次確認彈窗
  const confirmResult = await Swal.fire({
    title: '確定要變更資料嗎？',
    text: '修改後將會立即生效',
    icon: 'question',
    showCancelButton: true,
    confirmButtonColor: '#22c55e',
    cancelButtonColor: '#9ca3af',
    confirmButtonText: '確定更新',
    cancelButtonText: '取消',
  })

  if (!confirmResult.isConfirmed) return

  try {
    // 修正這裡的路徑與方法
    const res = await axios.post(
      // 1. 改回 post
      'http://localhost:8080/api/members/update', // 2. 指向正確的後端路徑
      {
        memId: member.value.memId, // 3. 務必傳送 memId，否則後端 findById 會找不到人
        memName: form.value.memName.trim(),
        memPhone: form.value.memPhone.trim(),
        memEmail: form.value.memEmail.trim(),
        memInvoice: form.value.memInvoice.trim(),
        memPassword: form.value.memPassword,
        memUsername: member.value.memUsername, // 建議也帶上，確保資料完整
      },
      { withCredentials: true },
    )

    // 4. 注意：後端回傳的是 "會員修改成功"，這裡要對齊字串
    if (res.data === '會員修改成功') {
      Swal.fire({
        title: '編輯成功',
        text: '您的資料已同步',
        icon: 'success',
        timer: 1500,
        showConfirmButton: false,
      })

      isEdit.value = false
      fetchProfile()
    } else {
      Swal.fire('更新失敗', res.data, 'error')
    }
  } catch (e) {
    Swal.fire('系統錯誤', '無法連接至伺服器', 'error')
    form.value = { ...originForm.value }
  }
}
</script>

<template>
  <div class="profile-page">
    <div v-if="errorMsg">{{ errorMsg }}</div>

    <div v-if="member">
      <!-- 頭像 + 名稱 -->
      <div class="profile-header">
        <div class="avatar">
          <img
            class="member-photo"
            :src="member.memImage ? `/members/${member.memImage}` : '/members/default.png'"
            @error="(e) => (e.target.src = '/members/default.png')"
            alt="會員頭像"
          />
          <div v-if="isEdit" class="photo-edit-hint">
            <span>📷</span>
          </div>
        </div>
        <div class="name">{{ member.memName }}</div>
      </div>

      <!-- 操作按鈕 -->
      <div class="actions">
        <template v-if="!isEdit">
          <button @click="toggleHistory" class="btn btn-info">
            {{ showHistory ? '隱藏訂單歷史' : '查看訂單歷史資訊' }}
          </button>
          <button class="edit-btn" @click="startEdit">編輯資料</button>
        </template>
        <template v-else>
          <button class="save-btn" @click="saveEdit">儲存變更</button>
          <button class="cancel-btn" @click="cancelEdit">取消</button>
        </template>
      </div>

      <!-- 資料卡片 -->
      <div class="profile-card">
        <div class="row">
          <label>帳號</label>
          <div class="value">{{ member.memUsername }}</div>
        </div>

        <div class="row">
          <label>密碼</label>
          <input
            :type="isEdit ? 'password' : 'text'"
            class="value-input"
            v-model="form.memPassword"
            :placeholder="isEdit ? '輸入新密碼以修改' : '********'"
            :readonly="!isEdit"
          />
        </div>

        <div class="row">
          <label>姓名</label>
          <input class="value-input" v-model="form.memName" :readonly="!isEdit" />
        </div>

        <div class="row">
          <label>手機</label>
          <input class="value-input" v-model="form.memPhone" :readonly="!isEdit" />
        </div>

        <div class="row">
          <label>Email</label>
          <input class="value-input" v-model="form.memEmail" :readonly="!isEdit" />
        </div>

        <!-- 會員點數（唯讀） -->
        <div class="row">
          <label>會員點數</label>
          <div class="value">
            {{ member.memPoints }}
          </div>
        </div>

        <!-- 租借狀態 -->
        <div class="row">
          <label>租借狀態</label>
          <div class="value">
            <!-- 讀取中 -->
            <div v-if="isLoadingRentStatus" class="placeholder">讀取中...</div>
            <!-- 有租借中訂單 -->
            <div v-else-if="activeRent" class="rent-details">
              <div>
                <strong>狀態:</strong> <span class="status-active">{{ activeRent.recStatus }}</span>
              </div>
              <div><strong>訂單編號:</strong> {{ activeRent.recId }}</div>
              <div><strong>租借站點:</strong> {{ activeRent.rentSpotName }}</div>
              <div><strong>租借時間:</strong> {{ formatDateTime(activeRent.recRentDT2) }}</div>
            </div>
            <!-- 無租借中訂單 -->
            <div v-else class="placeholder">目前沒有租借中的訂單</div>
          </div>
        </div>

        <div class="row">
          <label>發票載具</label>
          <input class="value-input" v-model="form.memInvoice" :readonly="!isEdit" />
        </div>

        <div class="row">
          <label>註冊日期</label>
          <div class="value">{{ formatDate(member.createdAt) }}</div>
        </div>
      </div>

      <!-- [新增] 訂單歷史紀錄 -->
      <div v-if="showHistory" class="history-container mt-4">
        <RecRentUserRecord />
      </div>
    </div>
  </div>
</template>

<style scoped>
/* 整體 */
.profile-page {
  max-width: 920px;
  width: 100%;
  margin: 0 auto;
  padding: 40px 20px 0; /*  小螢幕不貼邊（左右 20） */
  box-sizing: border-box;

  /*  可留可不留：留著也不會壞，未來更好做版面控制 */
  display: flex;
  flex-direction: column;
}

/* 頭像 */
.profile-header {
  text-align: center;
  margin-bottom: 20px;
}

.avatar {
  width: 120px; /* 稍微加大一點比較好看 */
  height: 120px;
  border-radius: 50%;
  background: #f0f2f5;
  margin: 0 auto 15px;
  position: relative; /* 為了定位編輯圖示 */
  overflow: hidden; /* 確保圖片超出圓圈會被裁切 */
  border: 4px solid #fff;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.member-photo {
  width: 100%;
  height: 100%;
  object-fit: cover; /* 關鍵：保持比例填充 */
  display: block;
}

/* [新增] 編輯模式的半透明遮罩 */
.photo-edit-hint {
  position: absolute;
  bottom: 0;
  width: 100%;
  background: rgba(0, 0, 0, 0.4);
  color: white;
  padding: 4px 0;
  font-size: 14px;
  cursor: pointer;
}

.name {
  font-size: 20px;
  font-weight: bold;
}

/* 按鈕 */
.actions {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  margin-bottom: 12px;
}

.edit-btn {
  background: #c9a46a;
  color: #fff;
}

.save-btn {
  background: #22c55e;
  color: #fff;
}

.cancel-btn {
  background: #9ca3af;
  color: #fff;
}

.actions button {
  padding: 6px 14px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

/* 卡片 */
.profile-card {
  background: #fff;
  border-radius: 12px;
  width: auto;
  margin: 0 20px 0 20px;
  padding: 20px 20px 5px 20px;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.08);
  margin-bottom: 30px;
}

.row {
  display: flex;
  padding: 4px 0;
  font-size: larger;
  border-bottom: 1px solid #eee;
}

.row:last-child {
  border-bottom: none;
  font-size: larger;
}

label {
  width: 120px;
  color: #666;
}

/* input / 顯示共用 */
.value,
.value-input {
  flex: 1;
  font-size: large;
}

.value-input {
  border: none;
  background: transparent;
}

.value-input:read-only {
  pointer-events: none;
}

.value-input:not(:read-only) {
  border: 1px solid #ccc;
  padding: 6px 8px;
  border-radius: 6px;
  background: #fff;
}

/* 編輯資料 */
.edit-btn:hover {
  background: #b8935a;
}

/* 儲存變更 */
.save-btn:hover {
  background: #16a34a;
}

/* 取消 */
.cancel-btn:hover {
  background: #6b7280;
}

/* 通用 hover 手感 */
.actions button:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
}

.placeholder {
  color: #9ca3af;
  font-style: italic;
}

.rent-details > div {
  padding: 2px 0;
}

.status-active {
  background-color: #28a745; /* 綠色背景 */
  color: white;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 0.9em;
}
</style>
</file>

<file path="frontend/src/components/rec/RecRentUserOrder.vue">
<script setup>
import { ref, computed, watch, onMounted } from 'vue'
import axios from 'axios'
import { useRouter } from 'vue-router'
import { useMemberAuthStore } from '@/stores/memberAuth'

// --- Computed properties from store ---
// --- Props ---
const props = defineProps({
  spotId: {
    type: String,
    required: true,
  },
})

// --- Pinia Store ---
const memberAuthStore = useMemberAuthStore()
const router = useRouter()

// --- Computed properties from store ---
const isLoggedIn = computed(() => memberAuthStore.isLogin && !!memberAuthStore.member?.memId)
const memberId = computed(() => memberAuthStore.member?.memId)
const memberName = computed(() => memberAuthStore.member?.memName || '訪客')
const memberUserName = computed(() => memberAuthStore.member?.memUsername || '訪客')
console.log(isLoggedIn.value)

// --- 狀態定義 ---
const spotInfo = ref(null) // 儲存傳入 spotId 的站點資訊
const seats = ref([])
const selectedSeat = ref(null)
const isLoading = ref({
  spot: false,
  seats: false,
  rent: false,
})
const errorMessage = ref('')

// 對話框狀態
const showTermsModal = ref(false)
const agreedToTerms = ref(false)
// --- Lifecycle ---
onMounted(async () => {
  // 如果進入頁面時發現是登入狀態但沒有 ID，導回登入頁
  if (memberAuthStore.isLogin && !memberId.value) {
    console.warn('訂單頁面偵測到資料遺失，自動導向登入頁')
    memberAuthStore.clearMemberLogin() // 確保清除異常狀態
    router.push('/login')
    return
  }

  // 檢查是否有未完成的訂單 (recStatus === '租借中')
  if (memberAuthStore.isLogin && memberId.value) {
    try {
      const res = await axios.get(`http://localhost:8080/rec-rent?memId=${memberId.value}`)
      const hasActiveRent = res.data.some(
        (rent) => rent.recStatus === '租借中' || rent.recStatus === '未付款',
      )

      if (hasActiveRent) {
        alert('您尚有未完成的租借訂單。\n請先完成歸還或洽詢客服人員。')
        router.push({ name: 'rec-rent-user', params: { action: 'record' } })
      }
    } catch (error) {
      console.error('檢查租借狀態失敗:', error)
    }
  }
})
// --- API 呼叫 ---

const loadSpotInfo = async (spotId) => {
  if (!spotId) return
  isLoading.value.spot = true
  spotInfo.value = null // 重置舊資料
  try {
    // API 端點 `/spot/{id}`
    const response = await axios.get(`/spot/${spotId}`)
    spotInfo.value = response.data
  } catch (error) {
    console.error(`載入站點 ${spotId} 資訊失敗:`, error)
    errorMessage.value = '無法載入站點資料。'
  } finally {
    isLoading.value.spot = false
  }
}

const loadSeats = async (spotId) => {
  if (!spotId) return
  isLoading.value.seats = true
  seats.value = []
  selectedSeat.value = null
  try {
    const response = await axios.get(`http://localhost:8080/seats/search?spotId=${spotId}`)
    // 根據需求，只顯示狀態為"啟用"的座位
    seats.value = response.data.filter((seat) => seat.seatsStatus === '啟用')
  } catch (error) {
    console.error(`載入 ${spotId} 的座位失敗:`, error)
    errorMessage.value = '無法載入該站點的座位資訊。'
  } finally {
    isLoading.value.seats = false
  }
}

// --- 核心邏輯 ---

const openTermsModal = () => {
  if (isReadyToRent.value) {
    showTermsModal.value = true
  }
}

const closeModal = () => {
  showTermsModal.value = false
  agreedToTerms.value = false // 關閉時重置勾選
}

const proceedWithRent = async () => {
  // 檢查是否同意條款
  if (!agreedToTerms.value) {
    alert('請同意使用條款。')
    return
  }
  // 檢查所有步驟是否完成
  if (!isReadyToRent.value) {
    alert('請完成所有租借步驟。')
    return
  }

  // 防呆檢查：確保會員 ID 存在 (防止登入狀態異常導致 memId 為空)
  if (!memberAuthStore.member?.memId) {
    console.warn('無法獲取會員資訊(memId遺失)，自動導向登入頁')
    memberAuthStore.clearMemberLogin()
    router.push({ name: 'login', query: { redirect: router.currentRoute.value.fullPath } })
    return
  }

  //Date()轉換LocalDateTime()
  const d = new Date()
  const localDate = new Date(d.getTime() - d.getTimezoneOffset() * 60000).toISOString().slice(0, -1)
  // 根據使用者要求組合新的訂單資料
  const newOrderData = {
    memId: memberAuthStore.member.memId, // 直接從 Pinia Store 獲取 USERID
    seatsId: selectedSeat.value.seatsId,
    spotIdRent: parseInt(props.spotId), // 從 props 取得 spotId
    recRentDT2: localDate, // 紀錄當下時間 (ISO 8601 格式)
    recStatus: '租借中',
    recPrice: 0, // 價格或費率可由後端根據座位類型和站點決定
    recRequestPay: 0, // 因為無需確認付款，所以請求付款金額為 0
    recPayment: 0, // 同上，實際付款為 0
    recPayBy: '尚未付款', //
    recInvoice: '', // 歸還時生成發票號碼
    recCarrier: memberAuthStore.member.memInvoice,
    recViolatInt: 0, //
  }

  isLoading.value.rent = true
  errorMessage.value = '' // 清除舊的錯誤訊息

  try {
    const response = await axios.post('http://localhost:8080/rec-rent/new', newOrderData)

    if (response.status === 201 || response.status === 200) {
      console.log('訂單成功產生:', response.data)
      alert(
        `租借成功！\n訂單ID：${response.data.recSeqId}\n站點：${spotInfo.value.spotName}\n座位：${selectedSeat.value.seatsId}`,
      )
      // 重置流程，也許導航到使用者訂單頁面
      selectedSeat.value = null
      agreedToTerms.value = false
      router.push({ name: 'rec-rent-user', params: { action: 'record' } })
    } else {
      errorMessage.value = `租借失敗，伺服器回應狀態碼: ${response.status}`
    }
  } catch (error) {
    console.error('租借請求失敗:', error)
    const apiError = error.response?.data?.message || error.message
    errorMessage.value = `租借請求失敗: ${apiError}`
    alert(`租借失敗: ${apiError}`) // 直接彈出錯誤給使用者
  } finally {
    isLoading.value.rent = false
    closeModal() // 無論成功失敗都關閉對話框
  }
}

// --- (翌帆2026-1-31新增 客服回報用)【新增】處理問題回報：導向 /support/report 並帶入 query 參數 ---
const handleReportIssue = () => {
  const spotId = null //
  const seatId = null // 地圖頁目前沒有特定 seatId，可依需求擴充
  const recId = null // 地圖頁目前沒有 recId

  const query = {}
  if (spotId) query.spotId = spotId
  if (seatId) query.seatId = seatId
  if (recId) query.recId = recId

  router.push({ path: '/support/report', query })
}

// --- Computed ---

const isStep1Completed = computed(() => !!selectedSeat.value)
const step1Class = computed(() => (isStep1Completed.value ? 'status-completed' : 'status-pending'))

const isReadyToRent = computed(() => isStep1Completed.value && isLoggedIn.value)

// --- Watchers & Lifecycle ---
watch(
  () => props.spotId,
  (newSpotId) => {
    if (newSpotId) {
      errorMessage.value = ''
      loadSpotInfo(newSpotId)
      loadSeats(newSpotId)
    }
  },
  { immediate: true },
)
</script>

<template>
  <div class="user-order-container">
    <div class="card">
      <h1 class="card-header">即時座位租借</h1>

      <!-- 會員資訊顯示區塊 -->
      <div class="card-body user-info-section">
        <div v-if="isLoggedIn">
          <h5><i class="fas fa-user-check"></i> 會員資訊</h5>
          <h5 class="mb-0">
            歡迎， <strong>{{ memberName }}</strong> (UID:
            {{ memberUserName }})，請確認您的租借資訊:<br /><br />
          </h5>
        </div>
        <div v-else class="alert alert-warning">
          <h5><i class="fas fa-exclamation-triangle"></i></h5>
          <p class="mb-0">請先登入以進行租借。</p>
        </div>
      </div>

      <div v-if="errorMessage" class="alert alert-danger m-3">{{ errorMessage }}</div>

      <!-- 站點資訊-->
      <div class="card-body">
        <h2><i class="fas fa-store"></i> 租借站點</h2>
        <div v-if="isLoading.spot" class="text-center">
          <span class="spinner-border spinner-border-sm"></span> 正在載入站點資訊...
        </div>
        <div v-else-if="spotInfo">
          <h4>{{ spotInfo.spotName }}</h4>
          <p class="text-muted">{{ spotInfo.spotAddress }}</p>
        </div>
      </div>

      <!-- 步驟一: 選擇座位 -->
      <div class="card-body" :class="step1Class">
        <fieldset :disabled="!isLoggedIn || !spotInfo">
          <h2><i class="fas fa-chair"></i> 請選擇座椅</h2>
          <div v-if="isLoading.seats" class="text-center">
            <span class="spinner-border spinner-border-sm"></span> 正在載入座位...
          </div>
          <div v-else-if="seats.length > 0" class="form-group">
            <label for="seat-select">請選擇座椅：</label>
            <select id="seat-select" class="form-control" v-model="selectedSeat">
              <option :value="null" disabled>-- 請選擇一個座椅 --</option>
              <option v-for="seat in seats" :key="seat.seatsId" :value="seat">
                座椅編號: {{ seat.seatsId }} &nbsp;&nbsp;&nbsp; 類型: {{ seat.seatsName }}
              </option>
            </select>
          </div>
          <div v-else-if="spotInfo" class="alert alert-warning">
            此站點目前無可用座位。
            <br />
            <router-link to="/SearchSpot" class="btn btn-primary mt-2"
              >返回地圖重新選擇</router-link
            >
          </div>
        </fieldset>
      </div>

      <!-- 步驟二: 確認租借 -->
      <div class="card-body">
        <fieldset :disabled="!isStep1Completed || !isLoggedIn">
          <h2><i class="fas fa-check-circle"></i> 確認使用條款後租借</h2>
          <p>請確認您的選擇，點擊下方按鈕以同意使用條款並完成租借。</p>
          <h4>
            費率說明:<br />
            前半小時 45 NTD，半小時後 30 NTD / 30 min
          </h4>
          <br />
          <div class="d-flex justify-content-between align-items-center">
            <button
              @click="openTermsModal"
              class="btn btn-success btn-lg"
              :disabled="!isReadyToRent"
            >
              {{ isReadyToRent ? '閱讀使用條款後租借' : '請先完成前置步驟' }}
            </button>
            <button class="btn btn-warning fw-bold" @click="handleReportIssue">
              <i class="fas fa-exclamation-circle"></i> 我有訂單問題!
            </button>
          </div>
        </fieldset>
      </div>
    </div>

    <!-- 使用條款 Modal -->
    <div v-if="showTermsModal" class="modal-backdrop fade show" style="width: 600px"></div>
    <div
      class="modal fade"
      :class="{ show: showTermsModal }"
      :style="{ display: showTermsModal ? 'block' : 'none' }"
      tabindex="-1"
      role="dialog"
    >
      <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">【重要租借告知】</h5>
            <button type="button" class="btn-close" @click="closeModal"></button>
          </div>
          <div class="modal-body">
            <span>在您點擊租借前，請先確認以下租借及使用注意事項：</span><br /><br />
            <span style="font-weight: bolder">計費方式：</span>
            <span>前 30 分鐘 NT$45，之後每 30 分鐘 NT$30</span><br />
            <span>(不足 30 分鐘以 30 分鐘計)。 </span><br />
            <span style="font-weight: bolder">安全承諾：</span>
            <span style="color: red">座椅載重上限為 85kg，僅供椅坐，禁止危險動作或超載。</span
            ><br />
            <span>超過限制或不當使用導致之損害由使用者自負。</span><br />
            <span style="font-weight: bolder">檢查設備：</span>
            <span>使用前請檢查結構，如有異常請於 10分鐘內回報。</span><br />
            <span style="font-weight: bolder">正確歸還：</span>
            <span>務必確認App顯示「租借結束訂單」，否則將持續計費。</span><br />
            <span style="font-weight: bolder">賠償責任： </span>
            <span>若設備遺失或人為損毀，最高需負擔賠償金 NT$1500。</span><br />
            <span style="font-weight: bolder">服務細則： </span>
            <span>閱讀並同意上述條款視同接受我們的詳細服務細則。</span>
            <hr />
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                id="terms-agree"
                v-model="agreedToTerms"
              />
              <label class="form-check-label" for="terms-agree">
                我已閱讀並同意以上使用條款。
              </label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" @click="closeModal">取消</button>
            <button
              type="button"
              class="btn btn-primary"
              :disabled="!agreedToTerms || isLoading.rent"
              @click="proceedWithRent"
            >
              <span v-if="isLoading.rent" class="spinner-border spinner-border-sm"></span>
              確認租借
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<style scoped>
@import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css');

.user-order-container {
  padding: 0px;
  max-width: 600px;
  margin: auto;
  font-family: 'Microsoft JhengHei', sans-serif;
}
.card {
  border: 1px solid #ddd;
  border-radius: 8px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  overflow: hidden;
  transition: background-color 0.5s ease;
}
.card-header {
  background-color: #007bff;
  color: rgb(0, 0, 0);
  padding: 15px 20px;
  margin: 0;
  text-align: center;
}
.card-body {
  padding: 20px;
  border-bottom: 1px solid #eee;
  transition: background-color 0.3s ease-in-out;
}
.card-body:last-child {
  border-bottom: none;
}
.user-info-section {
  background-color: #e9ecef;
}

.status-pending {
  color: black;
  background-color: #ffffff;
}
.status-completed {
  background-color: #c1ffbe;
}

fieldset:disabled {
  opacity: 0.5;
  pointer-events: none;
}
h2 {
  color: #333;
  border-bottom: 2px solid #007bff;
  padding-bottom: 10px;
  margin-bottom: 20px;
}
.form-group {
  margin-bottom: 1rem;
}
.form-control {
  display: block;
  width: 100%;
  padding: 0.375rem 0.75rem;
  font-size: 1rem;
  line-height: 1.5;
  color: #495057;
  background-color: #fff;
  background-clip: padding-box;
  border: 1px solid #ced4da;
  border-radius: 0.25rem;
  transition:
    border-color 0.15s ease-in-out,
    box-shadow 0.15s ease-in-out;
}
.btn {
  font-size: 1rem;
  padding: 10px 15px;
  border-radius: 5px;
  cursor: pointer;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  border: none;
}
.btn-primary {
  color: #fff;
  background-color: #007bff;
}
.btn-success {
  color: #fff;
  background-color: #28a745;
}
.btn:disabled {
  opacity: 0.65;
  cursor: not-allowed;
}
.btn-lg {
  padding: 15px 25px;
  font-size: 1.25rem;
}
.alert {
  padding: 15px;
  margin-bottom: 20px;
  border: 1px solid transparent;
  border-radius: 4px;
}
.alert-danger {
  color: #721c24;
  background-color: #f8d7da;
  border-color: #f5c6cb;
}
.alert-info {
  color: #0c5460;
  background-color: #d1ecf1;
  border-color: #bee5eb;
}
.alert-warning {
  color: #856404;
  background-color: #fff3cd;
  border-color: #ffeeba;
}
.m-3 {
  margin: 1rem;
}
.mt-3 {
  margin-top: 1rem;
}
.text-muted {
  color: #6c757d !important;
}
.text-center {
  text-align: center;
}

.spinner-border-sm {
  width: 1rem;
  height: 1rem;
  border-width: 0.2em;
}
.spinner-border {
  display: inline-block;
  width: 2rem;
  height: 2rem;
  vertical-align: text-bottom;
  border: 0.25em solid currentColor;
  border-right-color: transparent;
  border-radius: 50%;
  -webkit-animation: spinner-border 0.75s linear infinite;
  animation: spinner-border 0.75s linear infinite;
}
@keyframes spinner-border {
  to {
    transform: rotate(360deg);
  }
}
/* Modal styles */
.modal-backdrop {
  position: fixed;
  top: 0;
  left: 0;
  z-index: 1050;
  width: 100vw;
  height: 100vh;
  background-color: #000;
  opacity: 0.5;
}
.modal.show {
  display: block;
}
.modal {
  z-index: 1055;
}
</style>
</file>

<file path="frontend/src/views/member/MemberListView.vue">
<script setup>
import { ref, onMounted, computed } from 'vue'
import { useRouter } from 'vue-router'
import axios from 'axios'
import Swal from 'sweetalert2'
import { useAdminAuthStore } from '@/stores/adminAuth'

import { Bar, Line } from 'vue-chartjs'
import { 
  Chart as ChartJS, Title, Tooltip, Legend, BarElement, 
  CategoryScale, LinearScale, PointElement, LineElement 
} from 'chart.js'

ChartJS.register(Title, Tooltip, Legend, BarElement, CategoryScale, LinearScale, PointElement, LineElement)

const router = useRouter()
const members = ref([])
const keyword = ref('')
const loading = ref(false)
const authStore = useAdminAuthStore()

// --- 分頁控制 ---
const currentPage = ref(1)
const pageSize = 6 

// --- 彈窗控制 ---
const showModal = ref(false)
const selectedMember = ref(null)

// --- 狀態切換與停權彈窗 ---
const filterStatus = ref(1) // 1: 啟用, 0: 停用
const showBanModal = ref(false)
const banReason = ref('')
const memberToBan = ref(null)

// 取得會員
const fetchMembers = async () => {
  loading.value = true
  try {
    const res = await axios.get('http://localhost:8080/api/members')
    members.value = res.data
    currentPage.value = 1 
  } catch (error) {
    Swal.fire({
      icon: 'error',
      title: '載入失敗',
      text: '取得會員資料失敗',
      confirmButtonColor: '#f56c6c'
    })
  } finally {
    loading.value = false
  }
}

// 過濾與分頁
const filteredMembers = computed(() => {
  return members.value.filter(m => m.memStatus === filterStatus.value)
})

const paginatedMembers = computed(() => {
  const start = (currentPage.value - 1) * pageSize
  return filteredMembers.value.slice(start, start + pageSize)
})

const totalPages = computed(() => {
  return Math.ceil(filteredMembers.value.length / pageSize) || 1
})

const openMemberDetail = (member) => {
  selectedMember.value = member
  showModal.value = true
}

// 模糊搜尋 (完全保留原邏輯與樣式)
const searchMembers = async () => {
  // 如果關鍵字為空，顯示全部資料
  if (!keyword.value.trim()) {
    fetchMembers()
    return
  }

  loading.value = true
  try {
    const res = await axios.get('http://localhost:8080/api/members/search', {
      params: { keyword: keyword.value.trim() }
    })

    members.value = res.data
    currentPage.value = 1 // 搜尋後回到第一頁

    // --- 完整還原：顯示搜尋結果提示 ---
    if (res.data.length === 0) {
      Swal.fire({
        icon: 'warning',
        title: '查無結果',
        text: `找不到包含「${keyword.value.trim()}」的會員資料`,
        confirmButtonText: '確定',
        confirmButtonColor: '#e6a23c'
      })
    } else {
      Swal.fire({
        icon: 'success',
        title: '搜尋成功',
        text: `找到 ${res.data.length} 筆符合的會員資料`,
        timer: 1500,
        showConfirmButton: false
      })
    }
  } catch (error) {
    // --- 完整還原：搜尋失敗提示 ---
    Swal.fire({
      icon: 'error',
      title: '搜尋失敗',
      text: error.response?.data?.message || '搜尋過程發生錯誤，請稍後再試',
      confirmButtonText: '確定',
      confirmButtonColor: '#f56c6c'
    })
  } finally {
    loading.value = false
  }
}

// 停權邏輯
const openBanModal = (member) => {
  memberToBan.value = member
  banReason.value = ''
  showBanModal.value = true
}

const confirmBanMember = async () => {
  if (!banReason.value.trim()) {
    Swal.fire({ icon: 'warning', title: '請輸入原因', confirmButtonColor: '#e6a23c' })
    return
  }
  try {
    await axios.post('http://localhost:8080/api/members/ban', {
      memId: memberToBan.value.memId,
      reason: banReason.value
    })
    showBanModal.value = false
    Swal.fire({ icon: 'success', title: '該會員已移至停權區', timer: 1500, showConfirmButton: false })
    fetchMembers()
  } catch (error) {
    Swal.fire({ icon: 'error', title: '操作失敗' })
  }
}

// 恢復啟用 (加回 SweetAlert 確認)
const activateMember = async (member) => {
  const result = await Swal.fire({
    title: '確定要重新啟用嗎？',
    text: `即將恢復會員：${member.memName} 的權限`,
    icon: 'question',
    showCancelButton: true,
    confirmButtonColor: '#67c23a',
    cancelButtonColor: '#909399',
    confirmButtonText: '確定啟用',
    cancelButtonText: '取消'
  })

  if (result.isConfirmed) {
    try {
      await axios.post('http://localhost:8080/api/members/activate', { memId: member.memId })
      Swal.fire({ icon: 'success', title: '已重新啟用', timer: 1500, showConfirmButton: false })
      fetchMembers()
    } catch (error) {
      Swal.fire({ icon: 'error', title: '恢復失敗' })
    }
  }
}

const formatDateOnly = (dt) => {
  if (!dt) return ''
  return dt.substring(0, 10).replace(/-/g, '/')
}

const clearSearch = () => {
  keyword.value = ''
  fetchMembers()
}

const checkPermission = (actionCallback) => {
  const role = authStore.admin?.role; 
  if (authStore.isLogin && Number(role) === 9) {
    actionCallback();
  } else {
    Swal.fire({
      icon: 'lock',
      title: '權限不足',
      text: '您目前的身分是一般管理員，無法執行此操作。',
      confirmButtonColor: '#f56c6c'
    });
  }
};

// --- 統計邏輯：點數級距 ---
const pointStats = computed(() => {
  const dist = { '0-100': 0, '101-500': 0, '501-1000': 0, '1000+': 0 }
  members.value.forEach(m => {
    if (m.memPoints <= 100) dist['0-100']++
    else if (m.memPoints <= 500) dist['101-500']++
    else if (m.memPoints <= 1000) dist['501-1000']++
    else dist['1000+']++
  })
  return dist
})

// --- 統計邏輯：註冊趨勢 ---
const registrationStats = computed(() => {
  const counts = {}
  members.value.forEach(m => {
    if (m.createdAt) {
      const date = m.createdAt.substring(0, 10)
      counts[date] = (counts[date] || 0) + 1
    }
  })
  const sortedDates = Object.keys(counts).sort()
  return {
    labels: sortedDates,
    data: sortedDates.map(d => counts[d])
  }
})

// --- 圖表數據配置 ---
const lineChartData = computed(() => ({
  labels: registrationStats.value.labels,
  datasets: [{
    label: '每日新註冊人數',
    data: registrationStats.value.data,
    borderColor: '#409eff',
    backgroundColor: 'rgba(64, 158, 255, 0.1)',
    tension: 0.4,
    fill: true
  }]
}))

const barChartData = computed(() => ({
  labels: Object.keys(pointStats.value),
  datasets: [{
    label: '會員人數',
    data: Object.values(pointStats.value),
    backgroundColor: ['#95d475', '#409eff', '#f89898', '#eebe77']
  }]
}))

// --- CSV 匯出邏輯 ---
const exportToCSV = () => {
  if (members.value.length === 0) {
    Swal.fire('提示', '目前無資料可導出', 'info');
    return;
  }

  // 定義標題列
  const headers = ['會員ID', '帳號', '姓名', 'Email', '手機', '點數', '註冊日期'];

  // 處理資料內容
  const rows = members.value.map(m => [
    `\t${m.memId}`,
    `\t${m.memUsername}`,
    `\t${m.memName}`,
    m.memEmail,
    `\t${m.memPhone}`, // 加 \t 解決 9.1E+08 (科學記號)
    m.memPoints,
    `\t${m.createdAt?.substring(0, 10)}` // 加 \t 解決 #### 並格式化日期
  ]);

  // 轉成 CSV 字串，並用逗號分隔
  const csvContent = [
    headers.join(','),
    ...rows.map(row => row.join(','))
  ].join('\n');

  // 加上 BOM (\uFEFF) 解決 Excel 開啟中文亂碼問題
  const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `會員名單_${new Date().toLocaleDateString()}.csv`;
  link.click();
  URL.revokeObjectURL(url);
};

onMounted(fetchMembers)
</script>

<template>
  <div class="member-page">
    <h2 class="title"><i class="fas fa-users"></i> 會員列表</h2>

    <div class="dashboard-grid">
      <div class="chart-card">
        <div class="chart-header">
          <span class="chart-title"><i class="fas fa-chart-line"></i> 註冊成長趨勢</span>
          <button class="btn-csv" @click="exportToCSV">
            <i class="fas fa-file-download"></i> 匯出報表 (CSV)
          </button>
        </div>
        <div class="chart-body">
          <Line :data="lineChartData" :options="chartOptions" />
        </div>
      </div>

      <div class="chart-card">
        <div class="chart-header">
          <span class="chart-title"><i class="fas fa-chart-pie"></i> 會員點數級距</span>
        </div>
        <div class="chart-body">
          <Bar :data="barChartData" :options="chartOptions" />
        </div>
      </div>
    </div>

    <div class="toolbar">
      <div class="search-bar">
        <div class="search-input-wrapper">
          <i class="fas fa-search search-icon"></i>
          <input
            v-model="keyword"
            type="text"
            placeholder="搜尋：帳號 / 姓名 / Email / 手機"
            @keyup.enter="searchMembers"
            :disabled="loading"
          />
          <button v-if="keyword" class="clear-btn" @click="clearSearch">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <button class="btn-search" @click="searchMembers" :disabled="loading">
          <i class="fas fa-search"></i> 搜尋
        </button>
        <button class="btn-refresh" @click="fetchMembers" :disabled="loading">
          <i class="fas fa-sync-alt"></i> 顯示全部
        </button>
      </div>
      <div class="create-bar">
        <div class="status-toggle-group">
          <button 
            class="toggle-btn" 
            :class="{ active: filterStatus === 1 }" 
            @click="filterStatus = 1"
          >啟用會員</button>
          <button 
            class="toggle-btn" 
            :class="{ active: filterStatus === 0 }" 
            @click="filterStatus = 0"
          >停用會員</button>
        </div>
        <button class="btn-create" @click="checkPermission(() => router.push('/admin/members/create'))">
          <i class="fas fa-user-plus"></i> 新增會員
        </button>
      </div>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th class="col-id">ID</th>
            <th class="col-info">會員資訊</th>
            <th class="col-points">點數</th>
            <th class="col-date">{{ filterStatus === 1 ? '註冊日期' : '停用日期' }}</th>
            <th class="col-status">狀態</th>
            <th class="col-action">操作</th>
          </tr>
        </thead>
        <tbody>
          <tr 
            v-for="m in paginatedMembers" 
            :key="m.memId" 
            :class="{ 'row-active': selectedMember?.memId === m.memId && showModal }"
          >
            <td class="col-id id-link-cell" @click="openMemberDetail(m)">{{ m.memId }}</td>
            <td class="col-info">
              <div class="info-cell">
                <div class="list-avatar-wrap">
                  <img :src="m.memImage ? '/members/' + m.memImage : '/members/default.png'" />
                </div>
                <div class="user-text">
                  <span class="user-name">{{ m.memName }}</span>
                  <span class="user-phone">{{ m.memPhone }}</span>
                </div>
              </div>
            </td>
            <td class="col-points"><span class="points-val">{{ m.memPoints }}</span></td>
            <td class="col-date">
              {{ filterStatus === 1 ? formatDateOnly(m.createdAt) : formatDateOnly(m.updatedAt) }}
            </td>
            <td class="col-status">
              <span class="status-badge" :class="m.memStatus === 1 ? 'status-active' : 'status-inactive'">
                {{ m.memStatus === 1 ? '啟用' : '停用' }}
              </span>
            </td>
            <td class="col-action">
              <div class="action-btns">
                <button 
                  v-if="filterStatus === 1" 
                  class="btn-box-edit" 
                  @click="checkPermission(() => router.push(`/admin/members/edit/${m.memId}`))"
                >修改</button>
                
                <button 
                  v-if="m.memStatus === 1"
                  class="btn-box-del" 
                  @click="checkPermission(() => openBanModal(m))"
                >停權</button>
                
                <button 
                  v-else
                  class="btn-box-active" 
                  @click="checkPermission(() => activateMember(m))"
                >啟用</button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="pagination-bar" v-if="filteredMembers.length > pageSize">
      <button class="btn-page" :disabled="currentPage === 1" @click="currentPage--">上一頁</button>
      <span class="page-info">第 {{ currentPage }} / {{ totalPages }} 頁</span>
      <button class="btn-page" :disabled="currentPage === totalPages" @click="currentPage++">下一頁</button>
    </div>

    <div v-if="showBanModal" class="modal-overlay" @click.self="showBanModal = false">
      <div class="ban-card">
        <div class="ban-header">
          <span>停權會員</span>
          <button class="close-x" @click="showBanModal = false">&times;</button>
        </div>
        <div class="ban-body">
          <label>停權原因 <span class="required">*</span></label>
          <textarea v-model="banReason" placeholder="請輸入停權原因..."></textarea>
          <div class="ban-warning">
            <i class="fas fa-exclamation-triangle"></i>
            注意：停權後該會員將無法使用服務，直到重新啟用為止。
          </div>
        </div>
        <div class="ban-footer">
          <button class="btn-close-modal" @click="showBanModal = false">取消</button>
          <button class="btn-confirm-ban" @click="confirmBanMember">確認停權</button>
        </div>
      </div>
    </div>

    <div v-if="showModal && selectedMember" class="modal-overlay" @click.self="showModal = false">
      <div class="compact-card">
        <div class="card-header">
          <h3><i class="fas fa-id-card"></i> 會員詳細資訊</h3>
          <button class="close-x" @click="showModal = false">&times;</button>
        </div>
        <div class="card-body">
          <div class="compact-sidebar">
            <div class="mini-avatar">
              <img :src="selectedMember.memImage ? `/members/${selectedMember.memImage}` : '/members/default.png'" />
            </div>
            <h4 class="sidebar-name">{{ selectedMember.memName }}</h4>
            <span class="sidebar-user">@{{ selectedMember.memUsername }}</span>
          </div>
          <div class="compact-main">
            <div class="data-section">
              <h5 class="section-title">個人資訊</h5>
              <div class="mini-grid">
                <div class="grid-item">
                  <label>會員 ID</label>
                  <span>{{ selectedMember.memId }}</span>
                </div>
                <div class="grid-item">
                  <label>聯絡電話</label>
                  <span>{{ selectedMember.memPhone || '未提供' }}</span>
                </div>
                <div class="grid-item">
                  <label>電子信箱</label>
                  <span>{{ selectedMember.memEmail }}</span>
                </div>
                <div class="grid-item">
                  <label>發票載具</label>
                  <span class="text-blue">{{ selectedMember.memInvoice || '未提供' }}</span>
                </div>
                <div class="grid-item">
                  <label>目前點數</label>
                  <span class="text-green">{{ selectedMember.memPoints }}</span>
                </div>
              </div>
            </div>
            <div class="data-section">
              <h5 class="section-title">系統資訊</h5>
              <div class="mini-grid">
                <div class="grid-item">
                  <label>註冊日期</label>
                  <span>{{ formatDateOnly(selectedMember.createdAt) }}</span>
                </div>
                <div class="grid-item">
                  <label>帳號狀態</label>
                  <span :class="selectedMember.memStatus === 1 ? 'status-text-active' : 'status-text-inactive'">
                    {{ selectedMember.memStatus === 1 ? '啟用' : '停用' }}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="card-footer">
          <button class="btn-close-modal" @click="showModal = false">關閉視窗</button>
        </div>
      </div>
    </div>
  </div>
</template>

<style scoped>
.member-page {
  min-height: 100vh;
  background-color: #f0f5fa;
  padding: 20px;
}

.title {
  font-size: 1.5rem;
  font-weight: 700;
  color: #303133;
  margin-bottom: 20px;
}

.toolbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding: 16px 20px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
}

.search-bar {
  display: flex;
  gap: 10px;
}

.search-input-wrapper {
  position: relative;
  width: 350px;
}

.search-icon {
  position: absolute;
  left: 14px;
  top: 50%;
  transform: translateY(-50%);
  color: #c0c4cc;
}

.search-input-wrapper input {
  width: 100%;
  padding: 10px 40px;
  border: 1px solid #e4e7ed;
  border-radius: 8px;
  background: #f5f7fa;
  transition: border-color 0.3s;
}

.search-input-wrapper input:focus {
  border-color: #409eff;
  outline: none;
}

.clear-btn {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: #909399;
  cursor: pointer;
}

.btn-search {
  padding: 10px 18px;
  background: #409eff;
  color: white;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.btn-search:hover {
  background: #66b1ff;
  transform: translateY(-2px);
  box-shadow: 0 4px 10px rgba(64, 158, 255, 0.3);
}

.btn-refresh {
  padding: 10px 18px;
  background: #67c23a;
  color: white;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.btn-refresh:hover {
  background: #85ce61;
  transform: translateY(-2px);
  box-shadow: 0 4px 10px rgba(103, 194, 58, 0.3);
}

.create-bar {
  display: flex;
  align-items: center;
  gap: 15px;
}

.status-toggle-group {
  display: flex;
  border: 1px solid #409eff;
  border-radius: 6px;
  overflow: hidden;
}

.toggle-btn {
  padding: 8px 16px;
  border: none;
  background: white;
  color: #409eff;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s;
}

.toggle-btn.active {
  background: #409eff;
  color: white;
}

.btn-create {
  padding: 10px 20px;
  background: #67c23a;
  color: white;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.btn-create:hover {
  background: #85ce61;
  transform: translateY(-2px);
  box-shadow: 0 4px 10px rgba(103, 194, 58, 0.3);
}

.table-container {
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
}

table {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
}

th, td {
  padding: 16px 12px;
  text-align: center;
  border-bottom: 1px solid #ebeef5;
}

th {
  background: #f5f7fa;
  color: #606266;
  font-weight: 600;
}

.col-id {
  width: 70px;
}

.col-info {
  width: 280px;
  text-align: left !important;
  padding-left: 20px;
}

.col-points {
  width: 100px;
}

.col-date {
  width: 150px;
}

.col-status {
  width: 100px;
}

.col-action {
  width: 160px;
}

.info-cell {
  display: flex;
  align-items: center;
  gap: 12px;
}

.list-avatar-wrap img {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
  border: 1px solid #eee;
}

.user-text {
  display: flex;
  flex-direction: column;
}

.user-name {
  font-weight: 600;
  color: #303133;
}

.user-phone {
  font-size: 12px;
  color: #909399;
}

.id-link-cell {
  color: #409eff;
  font-weight: 600;
  cursor: pointer;
  text-decoration: underline;
}

.points-val {
  color: #f59e0b;
  font-weight: bold;
}

.status-badge {
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 12px;
}

.status-active {
  background: #f0f9ff;
  color: #409eff;
  border: 1px solid #b3d8ff;
}

.status-inactive {
  background: #fef0f0;
  color: #f56c6c;
  border: 1px solid #fbc4c4;
}

.action-btns {
  display: flex;
  justify-content: center;
  gap: 8px;
}

.btn-box-edit {
  background-color: #409eff;
  color: white;
  padding: 6px 12px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  transition: all 0.3s;
}

.btn-box-edit:hover {
  background-color: #66b1ff;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(64, 158, 255, 0.3);
}

.btn-box-del {
  background-color: #f56c6c;
  color: white;
  padding: 6px 12px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  transition: all 0.3s;
}

.btn-box-del:hover {
  background-color: #f78989;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(245, 108, 108, 0.3);
}

.btn-box-active {
  background-color: #67c23a;
  color: white;
  padding: 6px 12px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  transition: all 0.3s;
}

.btn-box-active:hover {
  background-color: #85ce61;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(103, 194, 58, 0.3);
}

.pagination-bar {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  gap: 20px;
  margin-top: 25px;
}

.btn-page {
  padding: 8px 16px;
  background: white;
  border: 1px solid #dcdfe6;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.btn-page:not(:disabled):hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 10px rgba(64, 158, 255, 0.2);
}

.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 2000;
}

.ban-card {
  background: white;
  width: 450px;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 10px 25px rgba(0,0,0,0.2);
}

.ban-header {
  background: #ffc107;
  padding: 15px 20px;
  display: flex;
  justify-content: space-between;
  font-weight: bold;
  align-items: center;
}

.ban-body {
  padding: 20px;
}

.ban-body textarea {
  width: 100%;
  height: 120px;
  margin-top: 10px;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 4px;
  resize: none;
}

.ban-warning {
  margin-top: 15px;
  background: #fff9db;
  padding: 10px;
  border-radius: 4px;
  font-size: 13px;
  color: #856404;
}

.ban-footer {
  padding: 15px 20px;
  text-align: right;
  border-top: 1px solid #eee;
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

.btn-confirm-ban {
  background: #f44336;
  color: white;
  border: none;
  padding: 8px 20px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s;
}

.btn-confirm-ban:hover {
  background: #d32f2f;
  transform: translateY(-1px);
}

.compact-card {
  background: white;
  width: 600px;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 10px 25px rgba(0,0,0,0.2);
}

.card-header {
  padding: 15px 20px;
  border-bottom: 1px solid #eee;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.card-body {
  display: flex;
}

.compact-sidebar {
  width: 180px;
  background: #f9f9f9;
  padding: 25px 15px;
  display: flex;
  flex-direction: column;
  align-items: center;
  border-right: 1px solid #eee;
}

.mini-avatar img {
  width: 70px;
  height: 70px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid #409eff;
}

.sidebar-name {
  margin-top: 10px;
  font-size: 1.1rem;
}

.sidebar-user {
  font-size: 12px;
  color: #999;
}

.compact-main {
  flex: 1;
  padding: 20px;
}

.data-section {
  margin-bottom: 20px;
}

.section-title {
  border-left: 3px solid #409eff;
  padding-left: 8px;
  margin-bottom: 12px;
  font-size: 14px;
  font-weight: 600;
}

.mini-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
}

.grid-item {
  display: flex;
  flex-direction: column;
}

.grid-item label {
  font-size: 11px;
  color: #bbb;
  margin-bottom: 4px;
}

.text-green {
  color: #67c23a;
  font-weight: bold;
}

.text-blue {
  color: #409eff;
  font-weight: bold;
}

.status-text-active {
  color: #409eff;
}

.status-text-inactive {
  color: #f56c6c;
}

.card-footer {
  padding: 15px 20px;
  text-align: right;
  border-top: 1px solid #eee;
}

.btn-close-modal {
  padding: 8px 20px;
  background: #909399;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s;
}

.btn-close-modal:hover {
  background: #a6a9ad;
  transform: translateY(-1px);
}

.close-x {
  position: absolute;
  top: 15px;         /* 距離頂部高度 */
  right: 20px;
  border: none;
  background: none;
  font-size: 24px;
  cursor: pointer;
  color: #333;
  transition: all 0.2s;
}

.close-x:hover {
  color: #f56c6c;
  transform: rotate(90deg);
}

.required {
  color: red;
}

.row-active {
  background-color: #ecf5ff !important; /* 淡淡的藍色選中感 */
  transition: background-color 0.3s;
}

.row-active .id-link-cell {
  color: #66b1ff;
  text-shadow: 0 0 2px rgba(64, 158, 255, 0.2);
}

.dashboard-grid {
  display: grid;
  grid-template-columns: 1.6fr 1fr; /* 左寬右窄 */
  gap: 20px;
  margin-bottom: 20px;
}

.chart-card {
  background: white;
  border-radius: 12px;
  padding: 16px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
}

.chart-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.chart-title {
  font-weight: 600;
  color: #606266;
  font-size: 14px;
}

.chart-body {
  height: 230px; /* 固定高度，避免表格被推太遠 */
}

.btn-csv {
  padding: 6px 12px;
  background-color: #f0f9ff;
  color: #409eff;
  border: 1px solid #d9ecff;
  border-radius: 6px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.3s;
}

.btn-csv:hover {
  background-color: #409eff;
  color: white;
}

/* 讓圖表變垂直排列 */
@media (max-width: 1024px) {
  .dashboard-grid {
    grid-template-columns: 1fr;
  }
}
</style>
</file>

<file path="frontend/src/components/rec/RecRentUserComplete.vue">
<script setup>
import { ref, onMounted, computed, watch } from 'vue'
import axios from 'axios'
import { useRouter, useRoute } from 'vue-router'
import { useMemberAuthStore } from '@/stores/memberAuth'

// --- Pinia Store ---
const memberAuthStore = useMemberAuthStore()
const router = useRouter()
const route = useRoute()

// --- Computed properties from store ---
const isLoggedIn = computed(() => memberAuthStore.isLogin && !!memberAuthStore.member?.memId)
const memberId = computed(() => memberAuthStore.member?.memId)
const memberName = computed(() => memberAuthStore.member?.memName || '訪客')
const memberUserName = computed(() => memberAuthStore.member?.memUsername || '訪客')

// --- 狀態定義 ---
const seats = ref([])
const selectedSpot = ref(null)
const activeRent = ref(null) // [新增] 儲存目前進行中的訂單
const selectedSeat = ref(null)
const isLoading = ref({
  spot: false,
  seats: false,
  rent: false,
})
const errorMessage = ref('')

// 對話框狀態
const showTermsModal = ref(false)
const agreedToTerms = ref(false)

// --- API 呼叫 ---
const loadSpotInfo = async (spotId) => {
  if (!spotId) return
  isLoading.value.spot = true
  try {
    const response = await axios.get(`http://localhost:8080/spot/${spotId}`)
    selectedSpot.value = response.data
  } catch (error) {
    console.error(`載入站點 ${spotId} 失敗:`, error)
    errorMessage.value = '無法載入站點資料。'
  } finally {
    isLoading.value.spot = false
  }
}

// --- 核心邏輯 ---
const goToSearchSpot = () => {
  router.push('/SearchSpot')
}

// [步驟二] 導向至 ECpay 付款頁面
// Note: 這個方法應該在後端訂單資料更新後 (recStatus設為'未付款') 才被呼叫
const goToPayment = () => {
  if (!isReadyToRent.value) return

  const recId = activeRent.value?.recId
  if (!recId) {
    errorMessage.value = '無法找到訂單ID，無法進行付款。'
    console.error('訂單物件缺少 recId:', activeRent.value)
    return
  }

  router.push({
    name: 'payment-order',
    returnSpotId: selectedSpot.value?.spotId,
    query: {
      recId: recId,
      total: rentCalculation.value.totalFee,
    },
  })
}

const openTermsModal = () => {
  if (isReadyToRent.value) {
    showTermsModal.value = true
  }
}
const closeModal = () => {
  showTermsModal.value = false
  agreedToTerms.value = false // 關閉時重置勾選
}

// --- 問題回報處理 ---
const handleReport = () => {
  const rent = activeRent.value
  // 準備攜帶至回報頁面的資料
  const reportData = {
    orderId: rent?.recSeqId, // 訂單 ID
    memberId: memberAuthStore.member?.memId, // 使用者 ID
    spotId: selectedSpot.value?.spotId || rent?.spotIdRent, // 站點 ID
  }
  // TODO: REPORT - 暫時以 Alert 代替實際路由跳轉
  alert(
    `TODO: REPORT\n準備前往問題回報頁面\n訂單ID: ${reportData.orderId}\n會員ID: ${reportData.memberId}\n站點ID: ${reportData.spotId}`,
  )
}

// [步驟一] 點擊付款後，先更新後端訂單資料
// 將歸還站點(spotIdReturn)與費用(recPayment)寫入，並將狀態更新為'未付款'
// 成功後才會導向至付款頁面
const proceedWithRent = async () => {
  // 防呆檢查：確保會員 ID 存在
  if (!memberAuthStore.member?.memId) {
    console.warn('無法獲取會員資訊(memId遺失)，自動導向登入頁')
    memberAuthStore.clearMemberLogin()
    router.push({
      name: 'login',
      query: { redirect: router.currentRoute.value.fullPath },
    })
    return
  }

  // 準備更新資料：先將歸還資訊寫入，狀態設為「未付款」
  // 這樣後端 PaymentApiController 在付款成功後，才能讀取到 spotIdReturn 並執行座位更新
  const rentalData = {
    recStatus: '未付款', // 標記狀態，等待金流更新為「已完成」
    recInvoice: generateInvoiceNumber(), // [修正] 預設發票號碼
    spotIdReturn: selectedSpot.value?.spotId, // [修正] 使用 Optional Chaining 避免報錯
    recPayment: rentCalculation.value.totalFee,
  }

  // [新增] 防呆檢查：如果沒有抓到站點 ID，禁止送出並報錯
  console.log('準備送出歸還更新資料:', rentalData)
  if (!rentalData.spotIdReturn) {
    alert('系統錯誤：無法讀取歸還站點 ID (spotIdReturn)，請重新選擇站點或聯繫管理員。')
    console.error('錯誤：selectedSpot 物件內容:', selectedSpot.value)
    return
  }

  isLoading.value.rent = true
  try {
    // [修正] 使用 PUT 方法呼叫 /rec-rent/{recId} 進行更新
    const recId = activeRent.value.recId
    if (!recId) throw new Error('找不到訂單編號')

    // [修正] 將 spotIdReturn 同時放在 URL Query String 中，確保後端一定能收到
    const response = await axios.put(
      `http://localhost:8080/rec-rent/${recId}?spotIdReturn=${rentalData.spotIdReturn}`,
      rentalData,
    )

    if (response.status === 200) {
      // 資料更新成功後，呼叫 goToPayment 進入付款流程
      // 注意：這裡不需要再 router.push，因為 goToPayment 會處理
      activeRent.value = response.data // 更新本地資料
      goToPayment()
    } else {
      errorMessage.value = '歸還失敗，請稍後再試。'
    }
  } catch (error) {
    console.error('歸還請求失敗:', error)
    errorMessage.value = `歸還失敗: ${error.response?.data?.message || error.message}`
  } finally {
    isLoading.value.rent = false
    closeModal()
  }
}

// --- Computed ---

const isStep1Completed = computed(() => !!selectedSpot.value)

const step1Class = computed(() => (isStep1Completed.value ? 'status-completed' : 'status-pending'))

const isReadyToRent = computed(() => isStep1Completed.value && isLoggedIn.value)

// --- [新增] 費用與時間計算 ---
const rentCalculation = computed(() => {
  if (!activeRent.value) {
    return { rentTime: '-', returnTime: '-', duration: 0, totalFee: 0 }
  }

  // 1. 取得時間
  const rentDate = new Date(activeRent.value.recRentDT || activeRent.value.recRentDT2)
  const returnDate = new Date() // 當下時間

  // 2. 計算使用時間 (分鐘)
  const diffMs = returnDate - rentDate
  const durationMinutes = Math.floor(diffMs / (1000 * 60))

  // 3. 計算費用: 使用時間/30 取整後 + 20
  // 註：若您的費率是 "每30分鐘30元"，公式應為 Math.floor(durationMinutes / 30) * 30 + 20
  // 這裡依照您的指示 "使用時間/30 取整後+20" 實作
  const totalFee = Math.floor(durationMinutes / 30) * 30 + 45

  // 4. 格式化時間顯示 (YYYY/MM/DD HH:mm:ss)
  const formatTime = (date) => {
    return date.toLocaleString('zh-TW', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: false,
    })
  }

  return {
    rentTime: formatTime(rentDate),
    returnTime: formatTime(returnDate),
    duration: durationMinutes,
    totalFee: totalFee > 0 ? totalFee : 20, // 確保最低費用
  }
})
// 生成發票號碼 (格式: 兩位大寫英文 - 八位數字)
const generateInvoiceNumber = () => {
  // 產生兩個隨機大寫英文字母 (ASCII 65-90)
  const letters =
    String.fromCharCode(65 + Math.floor(Math.random() * 26)) +
    String.fromCharCode(65 + Math.floor(Math.random() * 26))
  // 產生八位隨機數字，不足補零
  const numbers = Math.floor(Math.random() * 100000000)
    .toString()
    .padStart(8, '0')
  return `${letters}-${numbers}`
}
// --- 測試功能：快速歸還 --- 在訂單問題前的BTN
// const handleQuickReturnTest = async () => {
//   if (!activeRent.value) return
//   if (!confirm(`[測試功能] 確定要強制歸還訂單 ${activeRent.value.recId} 嗎？`)) return
//   //Date()轉換LocalDateTime()
//   const d = new Date()
//   const localDate = new Date(d.getTime() - d.getTimezoneOffset() * 60000).toISOString().slice(0, -1)
//   try {
//     const testReturnData = {
//       memId: memberId.value,
//       seatsId: activeRent.value.seatsId,
//       spotIdRent: activeRent.value.spotIdRent,
//       spotIdReturn: selectedSpot.value?.spotId, // 若未選站點則使用原站點
//       recRentDT2: activeRent.value.recRentDT2 || activeRent.value.recRentDT,
//       recReturnDT2: localDate, //轉換LocalDateTime()
//       recUsageDT2: rentCalculation.value.duration,
//       recStatus: '已完成',
//       recPrice: rentCalculation.value.totalFee, // 價格或費率可由後端根據座位類型和站點決定
//       recRequestPay: 0, // 因為無需確認付款，所以請求付款金額為 0
//       recPayment: 0, // 同上，實際付款為 0
//       recPayBy: '信用卡', //
//       recInvoice: generateInvoiceNumber(), // 歸還時生成發票號碼
//       recCarrier: memberAuthStore.member.memInvoice,
//       recViolatInt: 0, //
//     }
//     // [修改] 增加訂單ID的回退(fallback)機制與防呆，避免產生 undefined 的 API 請求
//     const updateId = activeRent.value.recId //|| activeRent.value.recId
//     if (!updateId) {
//       alert('錯誤：無法找到訂單 ID，無法完成測試歸還。')
//       console.error('訂單物件:', activeRent.value)
//       return
//     }
//     await axios.put(`http://localhost:8080/rec-rent/${updateId}`, testReturnData)
//     alert('測試歸還成功，將導向紀錄頁面。')
//     router.push({ name: 'rec-rent-user', params: { action: 'record' } })
//   } catch (error) {
//     console.error('測試歸還失敗:', error)
//     alert('測試歸還失敗，請檢查後端或網路。')
//   }
// }

// --- (翌帆2026-1-31新增 客服回報用)【新增】處理問題回報：導向 /support/report 並帶入 query 參數 ---
const handleReportIssue = () => {
  const spotId = null //
  const seatId = null // 地圖頁目前沒有特定 seatId，可依需求擴充
  const recId = null // 地圖頁目前沒有 recId

  const query = {}
  if (spotId) query.spotId = spotId
  if (seatId) query.seatId = seatId
  if (recId) query.recId = recId

  router.push({ path: '/support/report', query })
}
// --- Watchers ---
watch(selectedSpot, (newSpot) => {
  if (newSpot) {
    // 歸還時可能不需要重載座位，或者需要載入正在使用的座位
    // loadSeats(newSpot.spotId);
  } else {
    seats.value = []
    selectedSeat.value = null
  }
})

var recId="";

onMounted(async () => {
  // Debug: 確認進入頁面時的狀態
  console.log('會員ID:', memberId.value, '登入狀態:', memberAuthStore.isLogin)

  // 如果進入頁面時發現是登入狀態但沒有 ID，導回登入頁
  if (memberAuthStore.isLogin && !memberId.value) {
    console.warn('歸還頁面偵測到資料遺失，自動導向登入頁')
    memberAuthStore.clearMemberLogin() // 確保清除異常狀態
    router.push({
      name: 'login',
      query: { redirect: router.currentRoute.value.fullPath },
    })
    return
  }

  // 檢查是否有進行中的訂單 (recStatus === '租借中')
  if (memberAuthStore.isLogin && memberId.value) {
    try {
      const res = await axios.get(`http://localhost:8080/rec-rent?memId=${memberId.value}`)
      // [修改] 找到該筆訂單並存入 activeRent
      const foundRent = res.data.find(
        (rent) => rent.recStatus === '租借中' || rent.recStatus === '未付款',
      )

      if (!foundRent) {
        alert('您目前沒有租借中的訂單，無法進行歸還。\n將為您導向至租借紀錄頁面。')
        router.push({ name: 'rec-rent-user', params: { action: 'record' } })
        return
      } else {
        // // --- DEBUG --- 印出找到的訂單物件，以確認 recSeqId 屬性是否存在及其值
        // console.log('訂單Id 為:', foundRent?.recId)
        // console.log('seatsId 為:', foundRent?.seatsId)
        // console.log('spotReturnId 為:', memberAuthStore.selectedSpotId)
        activeRent.value = foundRent
        recId=activeRent.value.recId;
  
      }
    } catch (error) {
      console.error('檢查租借狀態失敗:', error)
    }
  }

  // 載入指定的站點資訊 (從 Pinia 或 URL 參數)
  const spotId = memberAuthStore.selectedSpotId || route.query.spotId
  if (spotId) {
    loadSpotInfo(spotId)
  }
})
</script>

<template>
  <div class="user-order-container">
    <div class="card">
      <h2 class="card-header">歸還座位並結算</h2>

      <!-- 會員資訊顯示區塊 -->
      <div class="card-body user-info-section">
        <div v-if="isLoggedIn">
          <h5 class="mb-0">
            您好: <strong>{{ memberName }}</strong> (UID: {{ memberUserName }})，請確認您的歸還資訊:<br><br>
          <strong>訂單編號: {{ recId }}</strong>
          </h5>
        </div>
        <div v-else class="alert alert-warning">
          <h5><i class="fas fa-exclamation-triangle"></i> 訪客你好</h5>
          <p class="mb-0">請先登入以進行歸還結算。</p>
        </div>
      </div>

      <div v-if="errorMessage" class="alert alert-danger m-3">{{ errorMessage }}</div>

      <!-- 步驟一: 選擇歸還站點 -->
      <div class="card-body" :class="step1Class">
        <h2><i class="fas fa-store"></i> 步驟一：確認歸還站點</h2>
        <fieldset :disabled="!isLoggedIn">
          <div v-if="isLoading.spot" class="text-center">
            <span class="spinner-border spinner-border-sm"></span> 正在載入站點資訊...
          </div>
          <div v-else-if="selectedSpot" class="d-flex justify-content-between align-items-center">
            <div>
              <h4 class="mb-1">{{ selectedSpot.spotName }}</h4>
              <p class="text-muted mb-0">
                <i class="fas fa-map-marker-alt"></i> {{ selectedSpot.spotAddress }}
              </p>
            </div>
            <button class="btn btn-primary fw-bold" @click="goToSearchSpot">
              <i class="fas fa-exchange-alt"></i> 重新選擇站點
            </button>
          </div>
          <div v-else class="alert alert-warning d-flex justify-content-between align-items-center">
            <span>尚未選擇歸還站點，請先至地圖選擇。</span>
            <button class="btn btn-primary" @click="goToSearchSpot">前往地圖</button>
          </div>
        </fieldset>
      </div>

      <!-- 步驟2: 確認費用與付款 -->
      <div class="card-body">
        <fieldset :disabled="!isStep1Completed || !isLoggedIn">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="mb-0"><i class="fas fa-credit-card"></i> 步驟二：確認使用資訊</h2>
          </div>
          <h5>租借時間: {{ rentCalculation.rentTime }}</h5>
          <h5>歸還時間: {{ rentCalculation.returnTime }}</h5>
          <h5>使用時間: {{ rentCalculation.duration }} 分鐘</h5>
          <h5>費率:前半小時 45 NTD，半小時後 30 NTD / 30 min</h5>
          <hr />
          <h3>費用總計: {{ rentCalculation.totalFee }} NTD</h3>
          <div class="d-flex justify-content-between align-items-center">
            <button
              @click="proceedWithRent"
              class="btn btn-success btn-lg"
              :disabled="!isReadyToRent"
            >
              {{ isReadyToRent ? '前往付款' : '請完成歸還步驟' }}
            </button>
            <div>
              <!-- <button class="btn btn-outline-danger fw-bold me-2" @click="handleQuickReturnTest">
                <i class="fas fa-bug"></i> 測試歸還
              </button> -->
              <button class="btn btn-warning fw-bold" @click="handleReportIssue">
                <i class="fas fa-exclamation-circle"></i> 我有訂單問題!
              </button>
            </div>
          </div>
        </fieldset>
      </div>
    </div>
  </div>
</template>
<style scoped>
@import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css');

.user-order-container {
  padding: 20px;
  max-width: 800px;
  margin: auto;
  font-family: 'Microsoft JhengHei', sans-serif;
}
.card {
  border: 1px solid #ddd;
  border-radius: 8px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  overflow: hidden;
  transition: background-color 0.5s ease;
}
.card-header {
  background-color: #28a745;
  color: white;
  padding: 15px 20px;
  margin: 0;
  text-align: center;
}
.card-body {
  padding: 20px;
  border-bottom: 1px solid #eee;
  transition: background-color 0.3s ease-in-out;
}
.user-info-section {
  background-color: #e9ecef;
}
.card-body:last-child {
  border-bottom: none;
}

.status-pending {
  color: black;
  background-color: #ffffff;
}
.status-completed {
  background-color: #c1ffbe;
}

fieldset:disabled {
  opacity: 0.5;
  pointer-events: none;
}
h2 {
  color: #333;
  border-bottom: 2px solid #28a745;
  padding-bottom: 10px;
  margin-bottom: 20px;
}
.form-group {
  margin-bottom: 1rem;
}
.form-control {
  display: block;
  width: 100%;
  padding: 0.375rem 0.75rem;
  font-size: 1rem;
  line-height: 1.5;
  color: #495057;
  background-color: #fff;
  background-clip: padding-box;
  border: 1px solid #ced4da;
  border-radius: 0.25rem;
  transition:
    border-color 0.15s ease-in-out,
    box-shadow 0.15s ease-in-out;
}
.btn {
  font-size: 1rem;
  padding: 10px 15px;
  border-radius: 5px;
  cursor: pointer;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  border: none;
}
.btn-primary {
  color: #fff;
  background-color: #007bff;
}
.btn-success {
  color: #fff;
  background-color: #28a745;
}
.btn:disabled {
  opacity: 0.65;
  cursor: not-allowed;
}
.btn-lg {
  padding: 15px 25px;
  font-size: 1.25rem;
}
.alert {
  padding: 15px;
  margin-bottom: 20px;
  border: 1px solid transparent;
  border-radius: 4px;
}
.alert-danger {
  color: #721c24;
  background-color: #f8d7da;
  border-color: #f5c6cb;
}
.alert-info {
  color: #0c5460;
  background-color: #d1ecf1;
  border-color: #bee5eb;
}
.alert-warning {
  color: #856404;
  background-color: #fff3cd;
  border-color: #ffeeba;
}
.m-3 {
  margin: 1rem;
}
.mt-3 {
  margin-top: 1rem;
}
.text-muted {
  color: #6c757d !important;
}
.text-center {
  text-align: center;
}

.spinner-border-sm {
  width: 1rem;
  height: 1rem;
  border-width: 0.2em;
}
.spinner-border {
  display: inline-block;
  width: 2rem;
  height: 2rem;
  vertical-align: text-bottom;
  border: 0.25em solid currentColor;
  border-right-color: transparent;
  border-radius: 50%;
  -webkit-animation: spinner-border 0.75s linear infinite;
  animation: spinner-border 0.75s linear infinite;
}
@keyframes spinner-border {
  to {
    transform: rotate(360deg);
  }
}
/* Modal styles */
.modal-backdrop {
  position: fixed;
  top: 0;
  left: 0;
  z-index: 1050;
  width: 100vw;
  height: 100vh;
  background-color: #000;
  opacity: 0.5;
}
.modal.show {
  display: block;
}
.modal {
  z-index: 1055;
}
</style>
</file>

<file path="frontend/src/views/rec/RecRentMgnChartPage.vue">
<script setup>
// --- 0. Import ---
import { ref, onMounted, shallowRef } from 'vue'
import * as echarts from 'echarts'
import {
  getDailyOrderStats,
  getHourlyOrderStats,
  getOrderStatusStats,
  getRentalDurationStats,
} from '@/api/modules/rec'
import { ElMessage } from 'element-plus'

// --- 1. 狀態定義 ---

// 圖表實例，使用 shallowRef 避免不必要的深度響應
const dailyChartInstance = shallowRef(null)
const pieChartInstance = shallowRef(null)
const durationChartInstance = shallowRef(null)
const hourlyChartInstance = shallowRef(null)

// 圖表容器的 DOM 引用
const dailyChartContainer = ref(null)
const pieChartContainer = ref(null)
const durationChartContainer = ref(null)
const hourlyChartContainer = ref(null)

// 預設日期範圍 (最近六個月)
const defaultEndDate = new Date()
const defaultStartDate = new Date()
defaultStartDate.setMonth(defaultStartDate.getMonth() - 6)

// 用於日期選擇器的響應式變數
const startDate = ref(defaultStartDate)
const endDate = ref(defaultEndDate)

// --- 2. 核心邏輯 ---

/**
 * 格式化日期為 YYYY-MM-DD
 */
const formatDate = (date) => {
  if (!date) return ''
  const year = date.getFullYear()
  const month = (date.getMonth() + 1).toString().padStart(2, '0')
  const day = date.getDate().toString().padStart(2, '0')
  return `${year}-${month}-${day}`
}

/**
 * 繪製每日訂單與累計趨勢圖
 */
const drawDailyOrdersChart = async (start, end) => {
  const response = await getDailyOrderStats(start, end)
  const chartData = response.data

  // 準備每日數據
  const dailyLabels = chartData.map((item) => item.date)
  const dailyValues = chartData.map((item) => item.count)

  // 計算累計數據
  const cumulativeValues = dailyValues.reduce((acc, val) => {
    acc.push((acc.length > 0 ? acc[acc.length - 1] : 0) + val)
    return acc
  }, [])

  const options = {
    title: { text: '每日訂單數量與累計趨勢', left: 'center', top: '1', padding: '' },
    tooltip: {
      trigger: 'axis',
      axisPointer: { type: 'line' },
    },
    grid: { left: '1%', right: '1%', bottom: '9%', containLabel: true },
    legend: { data: ['日訂單', '累計訂單'], top: 'bottom' },
    xAxis: [{ type: 'category', data: dailyLabels, axisTick: { alignWithLabel: true } }],
    yAxis: [
      {
        type: 'value',
        name: '每日',
        axisLabel: { color: '#E0583A', formatter: '{value} 筆' },
        max: '50',
        nameTextStyle: { align: 'right', color: '#E0583A' },
      },
      {
        type: 'value',
        name: '累計',
        axisLabel: { color: '#188df0', formatter: '{value} 筆' },
        nameTextStyle: { align: 'left', color: '#188df0' },
      },
    ],
    series: [
      {
        name: '日訂單',
        type: 'line',
        color: '#E0583A',
        yAxisIndex: 0,
        data: dailyValues,
        smooth: false,
        // 直接在圖上顯示標籤
        label: {
          show: true,
          position: 'top',
        },
      },
      {
        name: '累計訂單',
        type: 'bar',
        yAxisIndex: 1,
        data: cumulativeValues,
        itemStyle: {
          color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
            { offset: 1, color: '#83bff6' },
            { offset: 0, color: '#188df0' },
          ]),
        },

        // 直接在圖上顯示標籤
        label: {
          show: true,
          position: 'top',
        },
      },
    ],
    dataZoom: [{ show: 'true', type: 'inside', start: 0, end: 100 }],
  }

  if (!dailyChartInstance.value) {
    dailyChartInstance.value = echarts.init(dailyChartContainer.value)
  }
  dailyChartInstance.value.setOption(options)
}

/**
 * 繪製每小時訂單分佈圖
 */
const drawHourlyOrdersChart = async (start, end) => {
  const response = await getHourlyOrderStats(start, end)
  const chartData = response.data

  // 初始化24小時數據
  const hourlyData = Array(24).fill(0)
  chartData.forEach((item) => {
    hourlyData[item.hour] = item.count
  })
  const hourlyLabels = Array.from({ length: 24 }, (_, i) => `${i}:00`)

  const options = {
    title: { text: '訂單時段分佈 (0-23點)', left: 'center', top: '0' },
    tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
    grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
    xAxis: [{ type: 'category', data: hourlyLabels, name: '小時' }],
    yAxis: [{ type: 'value', name: '訂單數量' }],
    series: [
      {
        name: '訂單數',
        type: 'bar',
        data: hourlyData,
        itemStyle: {
          color: '#3ba272',
        },
        // 直接在圖上顯示標籤
        label: {
          show: true,
          position: 'top',
        },
      },
    ],
    dataZoom: [{ type: 'inside', start: 0, end: 100 }],
  }

  if (!hourlyChartInstance.value) {
    hourlyChartInstance.value = echarts.init(hourlyChartContainer.value)
  }
  hourlyChartInstance.value.setOption(options)
}

/**
 * 繪製訂單狀態圓餅圖
 */
const drawOrderStatusPieChart = async (start, end) => {
  const response = await getOrderStatusStats(start, end)
  const chartData = response.data.map((item) => ({
    name: item.status,
    value: item.count,
  }))

  const options = {
    title: { text: '訂單狀態比例', left: 'center', top: '0' },
    tooltip: { trigger: 'item', formatter: '{a} <br/>{b} : {c} ({d}%)' },
    legend: { orient: 'vertical', left: 'left', data: chartData.map((item) => item.name) },
    series: [
      {
        name: '訂單狀態',
        type: 'pie',
        radius: '75%',
        center: ['50%', '55%'],
        data: chartData,
        emphasis: {
          itemStyle: {
            shadowBlur: 10,
            shadowOffsetX: 0,
            shadowColor: 'rgba(0, 0, 0, 0.5)',
          },
        },
        // 直接在圖上顯示標籤
        label: {
          show: true,
          formatter: '{b} {c}筆: {d}% ', // 格式: 名稱: 百分比%
          position: 'outside',
        },
        labelLine: {
          show: true,
        },
      },
    ],
  }

  if (!pieChartInstance.value) {
    pieChartInstance.value = echarts.init(pieChartContainer.value)
  }
  pieChartInstance.value.setOption(options)
}

/**
 * 繪製租借時長分佈長條圖
 */
const drawRentalDurationChart = async (start, end) => {
  const response = await getRentalDurationStats(start, end)
  const chartData = response.data

  // 處理數據
  const durationLabels = chartData.map((item) => {
    const lower = item.intervalGroup * 0.5
    const upper = (item.intervalGroup + 1) * 0.5
    return `${lower}~${upper} hr`
  })
  const durationValues = chartData.map((item) => item.count)

  const options = {
    title: { text: '訂單租借時長分佈 (半小時區間)', left: 'center', top: '0' },
    tooltip: {
      trigger: 'axis',
      axisPointer: { type: 'line' },
    },
    grid: {
      left: '3%',
      right: '4%',
      bottom: '3%',
      containLabel: true,
      splitLine: { interval: 'auto' },
    },
    xAxis: { type: 'category', data: durationLabels, name: '租借時長' },
    yAxis: { type: 'value', name: '訂單數量' },
    series: [
      {
        name: '訂單數',
        data: durationValues,
        type: 'bar',
        itemStyle: {
          color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
            { offset: 1, color: '#83bff6' },
            { offset: 0, color: '#188df0' },
          ]),
        },
        // 直接在圖上顯示標籤
        label: {
          show: true,
          position: 'top',
        },
      },
    ],
    dataZoom: [{ type: 'inside', start: 0, end: 100 }],
  }

  if (!durationChartInstance.value) {
    durationChartInstance.value = echarts.init(durationChartContainer.value)
  }
  durationChartInstance.value.setOption(options)
}

/**
 * 獲取後端數據並繪製所有圖表
 */
const fetchAllCharts = async () => {
  if (!startDate.value || !endDate.value) {
    ElMessage.warning('請選擇開始與結束日期')
    return
  }

  const loading = ElMessage({ message: '正在載入圖表數據...', type: 'info', duration: 0 })
  const formattedStart = formatDate(startDate.value)
  const formattedEnd = formatDate(endDate.value)

  try {
    // 並行獲取所有圖表數據
    await Promise.all([
      drawOrderStatusPieChart(formattedStart, formattedEnd),
      drawRentalDurationChart(formattedStart, formattedEnd),
      drawDailyOrdersChart(formattedStart, formattedEnd),
      drawHourlyOrdersChart(formattedStart, formattedEnd),
    ])
  } catch (error) {
    console.error('獲取圖表數據失敗:', error)
    ElMessage.error('載入圖表數據失敗，請稍後再試')
  } finally {
    loading.close()
  }
}

/**
 * 快速設定日期範圍並自動查詢
 * @param {number} months - 往前推算的月份數
 */
const setQuickDateRange = (months) => {
  const end = new Date()
  const start = new Date()
  start.setMonth(start.getMonth() - months)
  startDate.value = start
  endDate.value = end
  fetchAllCharts()
}

// --- 3. 生命週期 & 事件監聽 ---

// 組件掛載後，自動載入預設範圍的圖表
onMounted(() => {
  fetchAllCharts()
})

// 監聽窗口大小變化，重置圖表
window.addEventListener('resize', () => {
  ;[dailyChartInstance, hourlyChartInstance, pieChartInstance, durationChartInstance].forEach(
    (instance) => {
      if (instance.value) {
        instance.value.resize()
      }
    },
  )
})
</script>

<template>
  <div class="chart-page">
    <h3 style="text-align: center">訂單統計圖表</h3>
    <!-- 頂部控制項 -->
    <el-card class="box-card">
      <div class="controls-container">
        <el-form :inline="true" :model="{ startDate, endDate }">
          <el-form-item>
            <el-button-group>
              <el-button @click="setQuickDateRange(12)">近1年</el-button>
              <el-button @click="setQuickDateRange(36)">近3年</el-button>
              <el-button @click="setQuickDateRange(60)">近5年</el-button>
            </el-button-group>
            
          </el-form-item>
          <el-form-item label="選擇開始日期">
            <el-date-picker
              v-model="startDate"
              type="date"
              placeholder="選擇開始日期"
              style="width: 150px"
            />
          </el-form-item>
          <el-form-item label="選擇結束日期">
            <el-date-picker
              v-model="endDate"
              type="date"
              placeholder="選擇結束日期"
              style="width: 150px"
            /> </el-form-item
          ><el-form-item>
            <el-button type="primary" @click="fetchAllCharts" >查詢</el-button>
          </el-form-item>
        </el-form>
      </div>
    </el-card>

    <!-- 圖表容器 -->
    <el-row :gutter="20">
      <!-- 每日訂單與累計趨勢圖 -->
      <el-col :span="12">
        <el-card class="box-card chart-container-card">
          <div ref="dailyChartContainer" style="width: 100%; height: 300px"></div>
        </el-card>
      </el-col>
      <!-- 每小時訂單分佈圖 -->
      <el-col :span="12">
        <el-card class="box-card chart-container-card">
          <div ref="hourlyChartContainer" style="width: 100%; height: 300px"></div>
        </el-card>
      </el-col>
    </el-row>

    <el-row :gutter="20">
      <!-- 訂單狀態比例圖 -->
      <el-col :span="12">
        <el-card class="box-card chart-container-card">
          <div ref="pieChartContainer" style="width: 100%; height: 300px"></div>
        </el-card>
      </el-col>
      <!-- 租借時長分佈圖 -->
      <el-col :span="12">
        <el-card class="box-card chart-container-card">
          <div ref="durationChartContainer" style="width: 100%; height: 300px"></div>
        </el-card>
      </el-col>
    </el-row>
  </div>
</template>

<style scoped>
.chart-page {
  padding: 10px;
}
.box-card {
  margin-bottom: 10px;
}
.controls-container {
  /* 使用 Flexbox 排版 */
  display: flex;
  /* 水平置中表單 */
  justify-content: center;
  /* 允許內容換行 */
  flex-wrap: wrap;padding-top: 10px;
}
</style>
</file>

<file path="frontend/src/components/rec/RecRentSearch.vue">
<script setup>
import { ref, reactive, onMounted, computed, watch } from 'vue'
import axios from 'axios'
import Swal from 'sweetalert2'

const API_URL = 'http://localhost:8080/rec-rent'

const rentList = ref([])
const searchCriteria = reactive({
  recSeqId: '',

  recId: '',
  memId: '',
  memName: '',
  recStatus: '',
  spotId: '',
  spotName: '',
  startDate: '',
  endDate: '',
  recPayment: '',
  recNote: '',
  serialNumber: '',
})

// 分頁相關狀態
const currentPage = ref(1)
const pageSize = ref(25)

// 計算總頁數
const totalPages = computed(() => {
  return Math.ceil(rentList.value.length / pageSize.value) || 1
})

// 計算當前頁面顯示的資料
const paginatedList = computed(() => {
  const start = (currentPage.value - 1) * pageSize.value
  const end = start + pageSize.value
  return rentList.value.slice(start, end)
})

// 監聽列表變更，重置回第一頁
watch(rentList, () => {
  currentPage.value = 1
})

// 監聽每頁筆數變更，重置回第一頁
watch(pageSize, () => {
  currentPage.value = 1
})

const emit = defineEmits(['edit-rent', 'delete-rent'])

const loadRents = async () => {
  try {
    const params = new URLSearchParams()
    if (searchCriteria.recSeqId) params.append('recSeqId', searchCriteria.recSeqId)
    if (searchCriteria.recId) params.append('recId', searchCriteria.recId)
    if (searchCriteria.memId) params.append('memId', searchCriteria.memId)
    if (searchCriteria.memName) params.append('memName', searchCriteria.memName)
    if (searchCriteria.recStatus) params.append('recStatus', searchCriteria.recStatus)
    if (searchCriteria.spotId) params.append('spotId', searchCriteria.spotId)
    if (searchCriteria.spotName) params.append('spotName', searchCriteria.spotName)
    if (searchCriteria.startDate) params.append('startDate', searchCriteria.startDate)
    if (searchCriteria.endDate) params.append('endDate', searchCriteria.endDate)
    if (searchCriteria.recVio) params.append('recPayment', searchCriteria.recPayment)
    if (searchCriteria.recPayment) params.append('recPayment', searchCriteria.recPayment)
    if (searchCriteria.recNote) params.append('recNote', searchCriteria.recNote)
    if (searchCriteria.serialNumber) params.append('serialNumber', searchCriteria.serialNumber)

    const queryString = params.toString()
    const requestUrl = queryString ? `${API_URL}?${queryString}` : API_URL

    const res = await axios.get(requestUrl)
    // 將搜尋結果依照 recId 由大到小排序 (最新到最舊)
    rentList.value = res.data
  } catch (err) {
    console.error('載入失敗:', err)
    alert('無法載入資料，請確認後端伺服器是否已啟動.\n錯誤: ' + err.message)
  }
}

const clearSearch = () => {
  for (const key in searchCriteria) {
    searchCriteria[key] = ''
  }
  loadRents()
}

const editRent = (rent) => {
  emit('edit-rent', rent)
}

const deleteRent = (id) => {
  emit('delete-rent', id)
}

// 切換頁面
const goToPage = (page) => {
  if (page >= 1 && page <= totalPages.value) {
    currentPage.value = page
  }
}

onMounted(loadRents)

// 匯出 CSV 格式
const exportToCsv = () => {
  if (rentList.value.length === 0) {
    alert('沒有可匯出的資料。')
    return
  }

  // 定義 CSV 檔案的表頭
  const headers = [
    '訂單狀態',    '訂單編號',    '會員編號',    '會員姓名',
    '座椅編號',    '租借點編號',    '租借點名稱',    '歸還點編號',
    '歸還點名稱',    '租借時間',    '歸還時間',    '費用',    '備註',
  ]
  // 將每一筆訂單資料轉換為 CSV 的一列
  const rows = rentList.value.map((rent) =>
    [
      `"${rent.recStatus || ''}"`,
      `"${rent.recId || ''}"`,
      `"${rent.memId || ''}"`,
      `"${rent.memName || ''}"`,
      `"${rent.seatsId || ''}"`,
      `"${rent.spotIdRent || ''}"`,
      `"${rent.rentSpotName || ''}"`,
      `"${rent.spotIdReturn || ''}"`,
      `"${rent.returnSpotName || ''}"`,
      `"${rent.recRentDT2 ? rent.recRentDT2.replace('T', ' ') : ''}"`,
      `"${rent.recReturnDT2 ? rent.recReturnDT2.replace('T', ' ') : ''}"`,
      `"${rent.recPayment || ''}"`,
      `"${rent.recNote || ''}"`,
    ].join(','),
  )

  // 組合表頭和所有列，並添加 BOM 以確保 Excel 能正確讀取 UTF-8
  const csvContent = '\uFEFF' + [headers.join(','), ...rows].join('\n')
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' })
  const link = document.createElement('a')
  link.href = URL.createObjectURL(blob)
  link.setAttribute('download', 'rent_data.csv')
  document.body.appendChild(link)
  // 模擬點擊以下載檔案
  link.click()
  // 釋放記憶體
  document.body.removeChild(link)
  URL.revokeObjectURL(link.href)
}

// 匯出 JSON 格式
const exportToJson = () => {
  if (rentList.value.length === 0) {
    alert('沒有可匯出的資料。')
    return
  }

  // 將資料轉換為格式化的 JSON 字串
  const jsonContent = JSON.stringify(rentList.value, null, 2)
  const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' })
  const link = document.createElement('a')
  link.href = URL.createObjectURL(blob)
  link.download = 'rent_data.json'
  // 模擬點擊以下載檔案
  link.click()
  // 釋放記憶體
  URL.revokeObjectURL(link.href)
}

// Expose the loadRents method to the parent component
defineExpose({
  loadRents,
})

// [新增] 顯示完整備註的彈窗函式
const showFullNote = (note) => {
  Swal.fire({
    title: '備註-詳細內容',
    text: note,
    confirmButtonText: '點擊任意處或點此關閉',
    confirmButtonColor: '#409eff',
    allowOutsideClick: true, // 允許點擊遮罩層(外部)關閉
  })
}
</script>

<template>
  <div class="rec-rent-search-wrapper">
    <!-- 搜尋表單 -->
    <div class="search-form-container">
      <div class="search-form">
        <div class="form-group-search">
          <label>訂單編號:</label>
          <input
            v-model="searchCriteria.recId"
            type="text"
            placeholder="依訂單編號"
            @keyup.enter="loadRents"
          />
        </div>
        <div class="form-group-search">
          <label>會員編號:</label>
          <input
            v-model="searchCriteria.memId"
            type="text"
            placeholder="依會員編號"
            @keyup.enter="loadRents"
          />
        </div>
        <div class="form-group-search">
          <label>會員姓名:</label>
          <input
            v-model="searchCriteria.memName"
            type="text"
            placeholder="依會員姓名(模糊)"
            @keyup.enter="loadRents"
          />
        </div>
        <div class="form-group-search">
          <label>訂單狀態:</label>
          <select v-model="searchCriteria.recStatus" @keyup.enter="loadRents">
            <option value="">所有狀態</option>
            <option value="租借中">租借中</option>
            <option value="已完成">已完成</option>
            <option value="未歸還">未歸還</option>
            <option value="已取消">已取消</option>
          </select>
        </div>
        <div class="form-group-search">
          <label>站點編號:</label>
          <input
            v-model="searchCriteria.spotId"
            type="text"
            placeholder="依站點編號"
            @keyup.enter="loadRents"
          />
        </div>
        <div class="form-group-search">
          <label>站點名稱:</label>
          <input
            v-model="searchCriteria.spotName"
            type="text"
            placeholder="依站點名稱(模糊)"
            @keyup.enter="loadRents"
          />
        </div>
        <div class="form-group-search">
        <label>開始日期:</label>
        <input v-model="searchCriteria.startDate" type="date" />
      </div>
      <div class="form-group-search">
        <label>結束日期:</label>
        <input v-model="searchCriteria.endDate" type="date" />
      </div>
      </div>
    </div>
    <div class="view-section active">
      <div class="search-actions">
        <button class="btn-primary" @click="loadRents" style="min-width: 135px; margin: 0 0 0 10px">
          搜尋
        </button>
        <button class="btn-secondary" @click="clearSearch">清除</button>
        <button class="btn-success" @click="loadRents">更新</button>
        <select v-model="pageSize" class="page-size-select">
          <option :value="25">每頁顯示筆數</option>
          <option :value="25">25 筆/頁</option>
          <option :value="50">50 筆/頁</option>
          <option :value="100">100 筆/頁</option>
          <option :value="200">200 筆/頁</option>
        </select>
        <!-- 匯出按鈕 -->
        <button class="btn-info" @click="exportToCsv" style="margin-left: auto">匯出 CSV</button>
        <button class="btn-info" @click="exportToJson">匯出 JSON</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>訂單狀態</th>
            <th>訂單編號</th>
            <th>會員編號</th>
            <th>會員姓名</th>
            <th>座椅編號</th>
            <th>租借點名稱</th>
            <th>-編號</th>
            <th>租借時間</th>
            <th>歸還點名稱</th>
            <th>-編號</th>
            <th>歸還時間</th>
            <th>費用</th>
            <th>備註</th>
            <th width="150">操作</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="(rent, index) in paginatedList" :key="rent.recId || index">
            <td>{{ rent.recStatus }}</td>
            <td>
              <span v-if="rent.recId">{{ rent.recId }}</span>
              <span v-else style="color: gray">處理中...</span>
            </td>
            <td>{{ rent.memId }}</td>
            <td>{{ rent.memName }}</td>
            <td>SN-20260{{ rent.seatsId ? String(rent.seatsId).padStart(4, '0') : '' }}</td>
            <td>{{ rent.rentSpotName }}</td>
            <td>{{ rent.spotIdRent }}</td>
            <td>{{ rent.recRentDT2 ? rent.recRentDT2.replace('T', ' ') : '' }}</td>
            <td>{{ rent.returnSpotName }}</td>
            <td>{{ rent.spotIdReturn }}</td>
            <td>{{ rent.recReturnDT2 ? rent.recReturnDT2.replace('T', ' ') : '' }}</td>
            <td>{{ rent.recPayment }}</td>
            <td>
              <!-- [修改] 判斷備註長度，若超過 5 字元則截斷並顯示可點擊的 ... -->
              <span v-if="rent.recNote && rent.recNote.length > 5">
                {{ rent.recNote.substring(0, 5)
                }}<span class="note-more" @click="showFullNote(rent.recNote)" title="點擊查看完整內容"
                  >...</span
                >
              </span>
              <span v-else>{{ rent.recNote }}</span>
            </td>
            <td>
              <button class="btn-warning" @click="editRent(rent)">編輯</button><span>/</span>
              <button class="btn-danger ml-1" @click="deleteRent(rent.recId)">刪除</button>
            </td>
          </tr>
          <tr v-if="rentList.length === 0">
            <td colspan="12" class="text-center">暫無資料或查無結果</td>
          </tr>
        </tbody>
      </table>

      <!-- 分頁資訊列 (保留在底部) -->
      <div class="pagination-info-bar" v-if="rentList.length > 0">
        <span>第</span>
        <select v-model="currentPage" class="page-select">
          <option v-for="p in totalPages" :key="p" :value="p">{{ p }}</option>
        </select>
        <span>頁 / 共 {{ totalPages }} 頁 (共 {{ rentList.length }} 筆)</span>
      </div>

      <!-- 懸浮導航按鈕 (固定在視窗兩側) -->
      <Teleport to="body">
        <div class="floating-nav left" v-if="rentList.length > 0">
          <button class="btn-float" :disabled="currentPage === 1" @click="goToPage(1)">首頁</button>
          <button class="btn-float" :disabled="currentPage === 1" @click="goToPage(currentPage - 1)">
            上頁
          </button>
        </div>

        <div class="floating-nav right" v-if="rentList.length > 0">
          <button
            class="btn-float"
            :disabled="currentPage === totalPages"
            @click="goToPage(currentPage + 1)"
          >
            下頁
          </button>
          <button
            class="btn-float"
            :disabled="currentPage === totalPages"
            @click="goToPage(totalPages)"
          >
            末頁
          </button>
        </div>
      </Teleport>
    </div>
  </div>
</template>

<style scoped>
/* ========== 搜尋表單區 - 淺色風格 ========== */
.search-form-container {
  background: #f5f7fa;
  padding: 8px 10px;
  border-radius: 10px;
  margin-bottom: 5px;
}

.search-form {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: 8px;
  align-items: end;
}

.form-group-search {
  display: flex;
  flex-direction: column;
}

.form-group-search label {
  font-weight: 500;
  margin-bottom: 3px;
  font-size: 14px;
  color: #606266;
}

.form-group-search input,
.form-group-search select {
  padding: 3px 10px;
  border: 1px solid #e4e7ed;
  border-radius: 8px;
  font-size: 14px;
  background: #fff;
  transition: all 0.3s ease;
}

.form-group-search input:focus,
.form-group-search select:focus {
  border-color: #c0c4cc;
  box-shadow: 0 0 0 2px rgba(64, 158, 255, 0.08);
  outline: none;
}

.form-group-search input::placeholder {
  color: #c0c4cc;
}

.search-actions {
  display: flex;
  padding: 0px;
  justify-content: flex-start;
  gap: 8px;
  margin-bottom: 10px;
}

/* [新增] 設定操作區按鈕的最小寬度，讓按鈕整齊一致 */
.search-actions button {
  min-width: 65px;
}

.page-size-select {
  padding: 5px 8px;
  border: 1px solid #dcdfe6;
  border-radius: 8px;
  font-size: 14px;
  color: #606266;
  cursor: pointer;
}

/* ========== 表格 - 淺色風格 ========== */
table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  margin-top: 8px;
  background: rgb(255, 255, 255);
  font-size: 15px;
  overflow: hidden;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
  border-right: 1px solid #000000;
}

th,
td {
  border-bottom: 1px solid #ffffff;
  border-left: 1px solid #000000;
  padding: 4px 2px;
  text-align: center;
  white-space: nowrap;
}

th {
  background: #f5f7fa;
  color: #606266;
  font-weight: 600;
  font-size: 14px;
}

tbody tr {
  transition: background-color 0.2s ease;
}

tbody tr:hover {
  background-color: #f1f1f1;
}

tbody tr:nth-child(even) {
  background-color: #e4e4e4;
}

tbody tr:nth-child(even):hover {
  background-color: #cccccc;
}

.text-center {
  text-align: center;
  color: #909399;
  padding: 40px !important;
}

.view-section.active {
  color: #000000;
  padding: 0;
  display: block;
}

/* ========== 按鈕樣式 ========== */
button {
  padding: 5px 8px;
  cursor: pointer;
  border: none;
  border-radius: 8px;
  font-weight: 500;
  font-size: 17px;
  transition: all 0.3s ease;
}

button:hover {
  transform: translateY(-1px);
}

.btn-primary {
  background: #409eff;
  color: white;
}

.btn-primary:hover {
  background: #66b1ff;
}

.btn-secondary {
  background: #909399;
  color: white;
}

.btn-secondary:hover {
  background: #a6a9ad;
}

/* [新增] 補上 btn-success (綠色按鈕) 的樣式 */
.btn-success {
  background: #67c23a;
  color: white;
}

.btn-success:hover {
  background: #85ce61;
}

.btn-info {
  background: #17a2b8;
  color: white;
}

.btn-info:hover {
  background: #1ab5cf;
}

/* ========== 圓形操作按鈕 ========== */
.btn-danger {
  width: auto;
  height: auto;
  padding: 2px 8px;
  background: #f56c6c;
  color: white;
  border-radius: 4px;
  font-size: 12px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.btn-danger:hover {
  background: #f89898;
  transform: scale(1.1);
}

.btn-warning {
  width: auto;
  height: auto;
  padding: 2px 8px;
  background: #409eff;
  color: #ffffff;
  border-radius: 4px;
  font-size: 12px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.btn-warning:hover {
  background: #66b1ff;
  transform: scale(1.1);
}

.ml-1 {
  margin-left: 1px;
}

/* ========== 標題樣式 ========== */
h2 {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 1.3rem;
  font-weight: 600;
  color: #303133;
  margin-bottom: 10px;
}

h2 button {
  padding: 6px 12px;
  font-size: 12px;
}

/* ========== 分頁樣式 ========== */
.pagination-info-bar {
  display: flex;
  justify-content: center;
  align-items: center;
  margin-top: 20px;
  padding: 10px;
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  font-size: 14px;
  color: #606266;
  gap: 8px;
}

.page-select {
  padding: 4px 8px;
  border: 1px solid #dcdfe6;
  border-radius: 4px;
  background: white;
}

/* 懸浮按鈕容器 */
.floating-nav {
  position: fixed;
  top: 50%;
  transform: translateY(-50%);
  z-index: 3000;
  display: flex;
  flex-direction: column;
  gap: 15px;
  transition: left 0.3s ease-in-out;
  /* 配合側邊欄動畫平滑移動 */
}

.floating-nav.left {
  left: 253px;
}

.floating-nav.right {
  right: 2px;
}

/* 針對 AdminLTE 側邊欄的響應式調整 (Desktop) */
@media (min-width: 992px) {
  /* 當側邊欄展開時 (預設) - 避開 250px 的側邊欄 */
  :global(body:not(.sidebar-collapse)) .floating-nav.left {
    left: 255px;
  }

  /* 當側邊欄收合時 (sidebar-collapse) - 避開約 73px 的小側邊欄 */
  :global(body.sidebar-collapse) .floating-nav.left {
    left: 80px;
  }
}

/* 懸浮按鈕本體 */
.btn-float {
  padding: 3px 7px;
  background: rgba(64, 158, 255, 0.9);
  color: white;
  border: none;
  border-radius: 30px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  font-weight: bold;
  transition: all 0.3s ease;
}

.btn-float:hover:not(:disabled) {
  background: #66b1ff;
  transform: scale(1.1);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
}

.btn-float:disabled {
  background: #c0c4cc;
  color: #c0c4cc;
  color: #fff;
  opacity: 0.6;
  cursor: not-allowed;
  box-shadow: none;
}

/* [新增] 點擊查看更多的樣式 */
.note-more {
  color: #409eff;
  cursor: pointer;
  font-weight: bold;
  margin-left: 2px;
}
.note-more:hover {
  text-decoration: underline;
}
</style>
</file>

<file path="frontend/src/components/rec/RecRentUserRecord.vue">
<script setup>
import { ref, onMounted, computed } from 'vue'
import axios from 'axios'
import { useMemberAuthStore } from '@/stores/memberAuth'
import { useRouter } from 'vue-router' // 【新增】引入 router

// --- Pinia Store ---
const memberAuthStore = useMemberAuthStore()

// --- Router ---
const router = useRouter() // 【新增】初始化 router

// --- 狀態定義 ---
const rents = ref([])
const isLoading = ref(false)
const errorMessage = ref('')

// --- 分頁狀態 ---
const currentPage = ref(1)
const itemsPerPage = 10 // 每頁顯示10筆

// --- Computed Properties ---
const totalPages = computed(() => {
  if (!rents.value) return 1
  return Math.ceil(rents.value.length / itemsPerPage)
})

const paginatedRents = computed(() => {
  if (!rents.value) return []
  const startIndex = (currentPage.value - 1) * itemsPerPage
  const endIndex = startIndex + itemsPerPage
  return rents.value.slice(startIndex, endIndex)
})

// --- 核心邏輯 ---
const loadUserRents = async () => {
  const memId = memberAuthStore.member?.memId

  // 防呆：未登入不執行查詢
  if (!memId) {
    errorMessage.value = '請先登入會員以查看紀錄'
    return
  }

  isLoading.value = true
  errorMessage.value = ''

  try {
    // 呼叫後端 API 查詢該會員的訂單 (假設後端支援 memId 參數過濾)
    const response = await axios.get(`http://localhost:8080/rec-rent?memId=${memId}`)
    let data = response.data

    // --- 排序邏輯 ---
    // 1. recStatus = "租借中" 的紀錄排在最上面
    // 2. 其餘紀錄依照租借時間 (recRentDT2) 倒序排列 (新的在前)
    data.sort((a, b) => {
      const isActiveA = a.recStatus === '租借中'
      const isActiveB = b.recStatus === '租借中'

      if (isActiveA && !isActiveB) return -1 // a 排前
      if (!isActiveA && isActiveB) return 1 // b 排前

      // 若狀態權重相同，比較時間 (倒序)
      const dateA = new Date(a.recRentDT2).getTime()
      const dateB = new Date(b.recRentDT2).getTime()
      return dateB - dateA
    })

    rents.value = data
    currentPage.value = 1 // 載入新資料時，重置回第一頁
  } catch (error) {
    console.error('載入租借紀錄失敗:', error)
    errorMessage.value = '無法載入租借紀錄，請確認網路連線或稍後再試。'
  } finally {
    isLoading.value = false
  }
}

// --- 【修改】問題回報處理：導向 /support/report 並帶入 query 參數 ---
const handleReport = (rent) => {
  const query = {}
  if (rent.recSeqId) query.recId = rent.recSeqId // 訂單 ID
  if (rent.spotIdRent) query.spotId = rent.spotIdRent // 站點 ID
  if (rent.seatsId) query.seatId = rent.seatsId // 座位 ID

  router.push({ path: '/support/report', query })
}

// --- 分頁方法 ---
const nextPage = () => {
  if (currentPage.value < totalPages.value) {
    currentPage.value++
  }
}

const prevPage = () => {
  if (currentPage.value > 1) {
    currentPage.value--
  }
}

const goToPage = (page) => {
  if (page >= 1 && page <= totalPages.value) {
    currentPage.value = page
  }
}

// --- Helper Functions ---
const getStatusClass = (status) => {
  // 根據訂單狀態回傳對應的 BS class
  if (status === '租借中') {
    return 'bg-success'
  }
  if (status === '未付款') {
    return 'bg-warning'
  }
  return 'bg-secondary'
}

// --- (翌帆2026-1-31新增 客服回報用)【新增】處理問題回報：導向 /support/report 並帶入 query 參數 ---
const handleReportIssue = () => {
  const spotId = null //
  const seatId = null // 地圖頁目前沒有特定 seatId，可依需求擴充
  const recId = null // 地圖頁目前沒有 recId

  const query = {}
  if (spotId) query.spotId = spotId
  if (seatId) query.seatId = seatId
  if (recId) query.recId = recId

  router.push({ path: '/support/report', query })
}

// --- Lifecycle ---
onMounted(() => {
  if (memberAuthStore.isLogin) {
    loadUserRents()
  }
})
</script>

<template>
  <div class="record-container">
    <h2 class="section-title"><i class="fas fa-history"></i> 我的租借紀錄</h2>

    <!-- 載入中 -->
    <div v-if="isLoading" class="text-center my-5">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-2">載入中...</p>
    </div>

    <!-- 錯誤訊息 -->
    <div v-else-if="errorMessage" class="alert alert-danger">
      {{ errorMessage }}
    </div>

    <!-- 無資料 -->
    <div v-else-if="rents.length === 0" class="alert alert-info">目前沒有租借紀錄。</div>

    <!-- 列表顯示 -->
    <div v-else>
      <div class="list-group">
        <div
          v-for="rent in paginatedRents"
          :key="rent.recSeqId"
          class="list-group-item mb-3 shadow-sm"
          :class="{ 'border-active': rent.recStatus === '租借中' || rent.recStatus === '未付款' }"
        >
          <div class="d-flex w-100 justify-content-between align-items-center header-row">
            <h5 class="mb-1">
              <span class="badge" :class="getStatusClass(rent.recStatus)">
                {{ rent.recStatus }}
              </span>
              <span class="ms-2 title-text">訂單編號: {{ rent.recId || rent.recSeqId }}</span>
            </h5>
            <span style="margin: 0 60px"> </span>
           
            <span></span> <span style="margin: 0 40px"> </span>
            <h5 class="mb-0 text-primary fw-bold">
              <button class="btn btn-sm btn-outline-warning" @click="handleReportIssue">
                <i class="fas fa-exclamation-circle"></i> 問題回報
              </button>
            </h5>
          </div>

          <div class="row mt-2">
             <span class="ms-2 title-text"> </span>
            <div class="col-md-6">
              <p class="mb-1">
                <strong>發票號碼:</strong> {{ rent.recInvoice  }}
              </p>
              <p class="mb-1">
                <strong>租借站點:</strong> {{ rent.rentSpotName || rent.spotIdRent }}
              </p>
              <p class="mb-1">
                <strong>歸還站點:</strong> {{ rent.returnSpotName || rent.spotIdReturn || '-' }}
              </p>
            </div>
            <div class="col-md-6">
              <p class="mb-1">
                <strong>座椅編號:</strong> SN-2026{{ rent.seatsId || '-' }}
              </p>
              <p class="mb-1">
                <strong>租借時間:</strong> {{ rent.recRentDT2?.replace('T', ' ') || '-' }}
              </p>
              <p class="mb-1">
                <strong>歸還時間:</strong> {{ rent.recReturnDT2?.replace('T', ' ') || '-' }}
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Pagination Controls -->
      <nav v-if="totalPages > 1" aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center flex-wrap">
          <li class="page-item" :class="{ disabled: currentPage === 1 }">
            <a class="page-link" href="#" @click.prevent="prevPage">&laquo;</a>
          </li>
          <li
            v-for="page in totalPages"
            :key="page"
            class="page-item"
            :class="{ active: currentPage === page }"
          >
            <a class="page-link" href="#" @click.prevent="goToPage(page)">{{ page }}</a>
          </li>
          <li class="page-item" :class="{ disabled: currentPage === totalPages }">
            <a class="page-link" href="#" @click.prevent="nextPage">&raquo;</a>
          </li>
        </ul>
      </nav>
    </div>
  </div>
</template>

<style scoped>
.record-container {
  padding: 10px;
  max-width: max-content;
  margin: 0 auto;
}
.section-title {
  color: #333;
  border-bottom: 2px solid #007bff;
  padding-bottom: 10px;
  margin-bottom: 20px;
}
.list-group-item {
  border: 1px solid #ddd;
  border-radius: 8px !important;
  transition: transform 0.2s;
}
.list-group-item:hover {
  transform: translateY(-2px);
}
/* 租借中狀態的特殊樣式 (左側綠色邊條) */
.border-active {
  border-left: 5px solid #28a745 !important;
  background-color: #f9fff9;
}
.badge {
  padding: 0.5em 0.7em;
  border-radius: 0.25rem;
  color: white;
}
.bg-success {
  background-color: #28a745;
}
.bg-secondary {
  background-color: #6c757d;
}
.bg-warning {
  background-color: #ffc107;
  color: #212529; /* 深色文字以確保可讀性 */
}
.text-primary {
  color: #007bff !important;
}
.text-muted {
  color: #6c757d !important;
}

/* Pagination Styles */
.page-item .page-link {
  color: #007bff;
  margin: 0 2px; /* 增加按鈕間距 */
  border-radius: 4px; /* 圓角 */
}
.page-item.active .page-link {
  background-color: #007bff;
  border-color: #007bff;
  color: white;
  z-index: 2;
}
.page-item.disabled .page-link {
  color: #6c757d;
  background-color: #fff;
  border-color: #dee2e6;
}
.pagination {
  padding-left: 0;
  list-style: none;
}
</style>
</file>

<file path="frontend/src/views/rec/RecRentUserSearchPage.vue">
<script setup>
import { ref, onMounted, nextTick, computed } from 'vue'
import { LocationFilled, Camera, Aim } from '@element-plus/icons-vue'
import { Html5Qrcode } from 'html5-qrcode'
import axios from 'axios'
import { useRouter } from 'vue-router'
import { useMemberAuthStore } from '@/stores/memberAuth'
import { useAdminAuthStore } from '@/stores/adminAuth'

// --- Computed properties from store ---
// --- Props ---
const props = defineProps({
  spotId: {
    type: String,
    required: false,
    default: '',
  },
})

// --- Pinia Store ---
const memberAuthStore = useMemberAuthStore()
const adminAuthStore = useAdminAuthStore()

// --- Computed properties from store ---
const isLoggedIn = computed(() => memberAuthStore.isLogin && !!memberAuthStore.member?.memId)
const memberId = computed(() => memberAuthStore.member?.memId)
const memberName = computed(() => memberAuthStore.member?.memName || '訪客')

// --- 路由與狀態管理 ---
const router = useRouter()

// --- 1. 組態設定 ---
const center = ref({ lat: 24.973875, lng: 121.382025 })
const zoom = ref(10)
const backendApiUrl = 'http://localhost:8080/spot/list'
// 地圖選項設定 (啟用 Google Maps 的完整 UI 控制項)
const mapOptions = {
  zoomControl: true,
  mapTypeControl: true,
  streetViewControl: true,
  fullscreenControl: true,
  rotateControl: true,
}

// --- 2. 狀態定義 ---
const spots = ref([])
const error = ref(null)
// 用於存放搜尋結果的地圖標記位置
const searchResultMarker = ref(null)
// 用於雙向綁定搜尋框的輸入文字
const searchQuery = ref('')
const infoWindow = ref({
  position: null,
  opened: false,
  isSearchResult: false,
  isLoadingCounts: false, // 新增：用於追蹤數量是否載入中
  spot: null,
  title: '',
})

// --- QR Code 掃描相關邏輯 ---
const isScanning = ref(false)
let html5QrCode = null

const startScan = () => {
  isScanning.value = true
  nextTick(() => {
    // 確保 DOM 元素已渲染
    html5QrCode = new Html5Qrcode('reader')
    const config = { fps: 10, qrbox: { width: 250, height: 250 } }

    // 優先使用後置鏡頭
    html5QrCode
      .start({ facingMode: 'environment' }, config, onScanSuccess, (errorMessage) => {
        // 掃描過程中的錯誤通常忽略，避免 log 洗版
      })
      .catch((err) => {
        console.error('啟動鏡頭失敗', err)
        alert('無法啟動鏡頭，請確認您使用的是 HTTPS 連線並已授權相機權限。')
        isScanning.value = false
      })
  })
}

const onScanSuccess = (decodedText, decodedResult) => {
  console.log(`掃描成功: ${decodedText}`, decodedResult)
  searchQuery.value = decodedText // 將結果填入搜尋框
  stopScan()
  performSearch() // 自動執行搜尋
}

const stopScan = () => {
  if (html5QrCode) {
    html5QrCode
      .stop()
      .then(() => {
        html5QrCode.clear()
        isScanning.value = false
      })
      .catch((err) => console.error('停止掃描失敗', err))
  } else {
    isScanning.value = false
  }
}

// --- 3. 核心邏輯 ---

// 根據站點狀態生成帶有顏色的地圖圖示
const getMarkerIcon = (status) => {
  const color = status === '營運中' ? 'green' : 'gray'
  const svg = `
<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" fill="${color}" class="bi bi-lightbulb-fill" viewBox="0 0 16 16">
  <path d="M2 6a6 6 0 1 1 10.174 4.31c-.203.196-.359.4-.453.619l-.762 1.769A.5.5 0 0 1 10.5 13h-5a.5.5 0 0 1-.46-.302l-.761-1.77a2 2 0 0 0-.453-.618A5.98 5.98 0 0 1 2 6m3 8.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1l-.224.447a1 1 0 0 1-.894.553H6.618a1 1 0 0 1-.894-.553L5.5 15a.5.5 0 0 1-.5-.5"/>
</svg>
 `
  return {
    url: `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(svg)}`,
    scaledSize: { width: 32, height: 32 },
  }
}

// 統一的地圖更新函式，用於聚焦與縮放
const updateMapLocation = (location) => {
  if (!location) return
  center.value = {
    lat: location.lat(),
    lng: location.lng(),
  }
  zoom.value = 15
}

// // 定位使用者位置 (高精準度)
// const locateUser = () => {
//   if (navigator.geolocation) {
//     navigator.geolocation.getCurrentPosition(
//       (position) => {
//         center.value = {
//           lat: position.coords.latitude,
//           lng: position.coords.longitude,
//         }
//         zoom.value = 15 // 定位成功後放大
//       },
//       (err) => {
//         console.warn(`無使用者地理位置: ${err.message}`)
//         // 可以選擇顯示錯誤提示，例如使用 Element Plus 的 ElMessage
//         alert('無法取得您的位置，請確認瀏覽器權限或 GPS 設定。')
//       },
//       {
//         enableHighAccuracy: true, // 要求高精準度 (GPS)
//         timeout: 5000, // 超時時間
//         maximumAge: 0, // 不使用快取
//       },
//     )
//   } else {
//     alert('此瀏覽器不支援地理位置功能。')
//   }
// }

// 處理從 GMapAutocomplete 選擇一個地點
const onPlaceChanged = (place) => {
  if (place && place.geometry && place.geometry.location) {
    const location = place.geometry.location
    updateMapLocation(location)
    searchResultMarker.value = location.toJSON()
    searchQuery.value = place.formatted_address // 將選擇的地點地址同步回輸入框

    infoWindow.value.opened = false
    nextTick(() => {
      infoWindow.value = {
        position: location.toJSON(),
        opened: true,
        isSearchResult: true,
        spot: null,
        title: place.formatted_address,
      }
    })
  }
}

// 執行地理編碼搜尋 (將地址文字轉換為座標)
const performSearch = () => {
  const query = searchQuery.value // 直接從狀態獲取查詢字串
  if (!query) return

  const geocoder = new google.maps.Geocoder()
  geocoder.geocode({ address: query }, (results, status) => {
    if (status === 'OK' && results[0]) {
      const place = results[0]
      const location = place.geometry.location
      updateMapLocation(location)
      searchResultMarker.value = location.toJSON()

      infoWindow.value.opened = false
      nextTick(() => {
        infoWindow.value = {
          position: location.toJSON(),
          opened: true,
          isSearchResult: true,
          spot: null,
          title: place.formatted_address,
        }
      })
    } else {
      console.warn(`Geocode 失敗，原因: ${status}`)
      alert('找不到指定的地點，請嘗試輸入更詳細的地址。')
    }
  })
}

// 從後端 API 獲取所有站點資料
const fetchSpots = async () => {
  try {
    const response = await axios.get(backendApiUrl)
    // 將後端資料轉換為地圖標記所需的格式
    const spotsData = response.data.map((spot) => ({
      id: spot.spotId,
      name: spot.spotName,
      status: spot.spotStatus,
      position: {
        lat: parseFloat(spot.latitude),
        lng: parseFloat(spot.longitude),
      },
      // 注意：seatCount 和 returnCount 在這裡不再預先載入
    }))
    spots.value = spotsData
  } catch (err) {
    console.error('無法獲取租借站點資料:', err)
    error.value = '無法載入租借站點資料，請稍後再試。'
  }
}

// 開啟一個站點的資訊視窗，並動態獲取數量
const openInfoWindowForSpot = async (spot) => {
  searchResultMarker.value = null // 清除搜尋結果的標記
  infoWindow.value.opened = false

  // 立即顯示基本資訊
  await nextTick()
  infoWindow.value = {
    position: spot.position,
    opened: true,
    isSearchResult: false,
    spot: { ...spot, seatCount: null, returnCount: null }, // 初始設定為 null
    title: spot.name,
    isLoadingCounts: true, // 開始載入
  }

  // 如果站點不在營運中，則不查詢數量
  if (spot.status !== '營運中') {
    infoWindow.value.spot.seatCount = 0
    infoWindow.value.spot.returnCount = 0 // 假設非營運中就沒有可還
    infoWindow.value.isLoadingCounts = false
    return
  }

  // 動態獲取可租借數量
  try {
    const countResponse = await axios.get(
      `http://localhost:8080/seats/count-by-spot?spotId=${spot.id}`,
    )
    const seatCount = countResponse.data
    // 更新 infoWindow 中的 spot 物件
    if (infoWindow.value.spot && infoWindow.value.spot.id === spot.id) {
      infoWindow.value.spot.seatCount = seatCount
      infoWindow.value.spot.returnCount = 20 - seatCount // 假設總數為 20
    }
  } catch (err) {
    console.error(`無法獲取站點 ${spot.id} 的座位數:`, err)
    if (infoWindow.value.spot && infoWindow.value.spot.id === spot.id) {
      infoWindow.value.spot.seatCount = 'N/A' // 發生錯誤時顯示 N/A
      infoWindow.value.spot.returnCount = 'N/A'
    }
  } finally {
    if (infoWindow.value.spot && infoWindow.value.spot.id === spot.id) {
      infoWindow.value.isLoadingCounts = false // 載入完成
    }
  }
}

// 關閉資訊視窗
const closeInfoWindow = () => {
  infoWindow.value.opened = false
  searchResultMarker.value = null // 同時清除搜尋結果的標記
}

// 處理導航至租借或歸還頁面
const handleNavigation = (action) => {
  const spotId = infoWindow.value.spot?.id
  let routeParams = { name: 'rec-rent-user', params: { action } }

  if (action === 'order' && spotId) {
    routeParams.query = { spotId }
  }

  // --- [新增] 將站點 ID 寫入 Pinia，確保切換頁面時能讀取 ---
  if (spotId) {
    memberAuthStore.setSpotId(spotId)
  }

  // --- 統一導航邏輯 ---
  // 1. 檢查是否處於「假登入」狀態 (isLogin=true 但 memId 遺失)
  if (memberAuthStore.isLogin && !memberAuthStore.member?.memId) {
    console.warn('偵測到登入狀態異常(無會員ID)，執行強制登出並重導向')
    memberAuthStore.clearMemberLogin()
    const redirectPath = router.resolve(routeParams).path
    router.push({ name: 'login', query: { redirect: redirectPath } })
    return
  }

  // 2. 正常狀態判斷
  if (memberAuthStore.isLogin || adminAuthStore.isLogin) {
    console.log('準備導向 Store 中的會員ID:', memberAuthStore.member?.memId)
    router.push(routeParams)
  } else {
    const redirectPath = router.resolve(routeParams).path
    router.push({ name: 'login', query: { redirect: redirectPath } })
  }
}

// --- (翌帆2026-1-31新增 客服回報用)【新增】處理問題回報：導向 /support/report 並帶入 query 參數 ---
const handleReportIssue = () => {
  const spotId = infoWindow.value.spot?.id
  const seatId = null // 地圖頁目前沒有特定 seatId，可依需求擴充
  const recId = null // 地圖頁目前沒有 recId

  const query = {}
  if (spotId) query.spotId = spotId
  if (seatId) query.seatId = seatId
  if (recId) query.recId = recId

  router.push({ path: '/support/report', query })
}

// Vue 組件掛載時執行的初始化
onMounted(() => {
  fetchSpots()
  fetchSpots()
  //locateUser() // 初始化時嘗試定位
})
</script>

<template>
  <div class="map-container-wrapper">
    <!-- 地點搜尋列 -->
    <!-- <button class="search-button scan-btn" @click="startScan" title="掃描 QR Code">
      <el-icon :size="20"><Camera /></el-icon>
    </button> -->
    <div class="search-bar-container">
      <GMapAutocomplete
        @place_changed="onPlaceChanged"
        :options="{
          fields: ['geometry', 'formatted_address', 'name'],
          componentRestrictions: { country: 'tw' },
        }"
      >
        <input
          type="text"
          class="search-input"
          placeholder="搜尋地點..."
          v-model="searchQuery"
          @keyup.enter="performSearch"
        />
      </GMapAutocomplete>

      <button class="search-button" @click="performSearch" title="搜尋">
        <el-icon :size="20"><LocationFilled /></el-icon>
      </button>

      <!-- [新增] 定位按鈕
      <button class="search-button locate-btn" @click="locateUser" title="定位我的位置">
        <el-icon :size="20"><Aim /></el-icon>
      </button> -->
    </div>

    <div v-if="error" class="error-message">{{ error }}</div>

    <GMapMap
      v-if="!error"
      :center="center"
      :zoom="zoom"
      :options="mapOptions"
      class="map"
      map-id="d2fc83863651fe9c90d73c8a"
    >
      <!-- 渲染站點標記 -->
      <GMapMarker
        v-for="spot in spots"
        :key="spot.id"
        :position="spot.position"
        :title="spot.name"
        :clickable="true"
        :icon="getMarkerIcon(spot.status)"
        @click="openInfoWindowForSpot(spot)"
      />
      <!-- 渲染搜尋結果標記 -->
      <GMapMarker v-if="searchResultMarker" :key="'search-result'" :position="searchResultMarker" />

      <GMapInfoWindow
        :opened="infoWindow.opened"
        :position="infoWindow.position"
        :options="{ pixelOffset: { width: 0, height: -35 }, headerDisabled: true }"
        @closeclick="closeInfoWindow"
      >
        <div class="info-window-content">
          <!-- 顯示站點資訊 -->
          <div v-if="infoWindow.spot">
            <span
              ><h5>{{ infoWindow.title }}</h5></span
            >
            <!-- <strong>ID:</strong> {{ infoWindow.spot.id }}-->
            <strong>狀態: {{ infoWindow.spot.status }}</strong>

            <!-- 當數量載入中時顯示讀取訊息 -->
            <div v-if="infoWindow.isLoadingCounts" class="loading-text">查詢中...</div>
            <!-- 載入完成後顯示數量與按鈕 -->
            <div v-else style="font-size: 15 px">
              <span style="color: darkgreen">
                <strong>可租借數量:</strong> {{ infoWindow.spot.seatCount }}</span
              >
              <span> | </span>
              <span style="color: darkblue"
                ><strong>可歸還數量:</strong> {{ infoWindow.spot.returnCount }}</span
              >
              <div class="button-group">
                <button
                  @click="handleNavigation('order')"
                  class="btn btn-success"
                  :disabled="infoWindow.spot.status !== '營運中' || infoWindow.spot.seatCount <= 0"
                  :class="{
                    'btn-disabled':
                      infoWindow.spot.status !== '營運中' || infoWindow.spot.seatCount <= 0,
                  }"
                >
                  租借
                </button>
                <button
                  @click="handleNavigation('complete')"
                  class="btn btn-primary"
                  :disabled="
                    infoWindow.spot.status !== '營運中' || infoWindow.spot.returnCount <= 0
                  "
                  :class="{
                    'btn-disabled':
                      infoWindow.spot.status !== '營運中' || infoWindow.spot.returnCount <= 0,
                  }"
                >
                  歸還
                </button>
                <button @click="handleReportIssue" class="btn btn-issue">
                  回報 <br />
                  問題
                </button>
              </div>
            </div>
          </div>
          <!-- 顯示搜尋結果 -->
          <div v-else-if="infoWindow.isSearchResult">
            <h4>{{ infoWindow.title }}</h4>
            <a
              v-if="infoWindow.position"
              :href="`https://www.google.com/maps/search/?api=1&query=${infoWindow.position.lat},${infoWindow.position.lng}`"
              target="_blank"
              rel="noopener noreferrer"
              class="map-link"
            >
              在 Google 地圖中查看
            </a>
          </div>
        </div>
      </GMapInfoWindow>
    </GMapMap>

    <!-- QR Code 掃描遮罩層 -->
    <div v-if="isScanning" class="scanner-overlay">
      <div class="scanner-container">
        <div id="reader" width="100%"></div>
        <button class="btn btn-primary close-scan-btn" @click="stopScan">關閉掃描</button>
      </div>
    </div>
  </div>
</template>

<style scoped>
.map-container-wrapper {
  width: 100%;
  height: 100%;
  position: relative;
}
.map {
  width: 100%;
  height: 100%;
}
.error-message {
  color: red;
  padding: 20px;
  text-align: center;
}
.info-window-content {
  padding: 0px;
  min-height: 50px;
  min-width: 150px;
  /* overflow: unset; */
}
.info-window-content h4,
.info-window-content p {
  margin: 1px 0;
}

/* 在 Google 地圖中查看的連結樣式 */
.info-window-content .map-link {
  display: block;
  margin-top: 3px;
  font-weight: 400;
  text-decoration: none;
  color: #007bff;
}
.info-window-content .map-link:hover {
  text-decoration: underline;
}
.loading-text {
  padding: 10px;
  text-align: center;
  color: #666;
}
.button-group {
  margin-top: 15px;
  display: flex;
  justify-content: space-around;
}
.btn {
  display: inline-block;
  font-weight: 500;
  text-align: center;
  white-space: nowrap;
  vertical-align: middle;
  user-select: none;
  border: 1px solid transparent;
  margin: 0.3rem;
  padding: 0.15rem 0.45rem;
  font-size: 1.5rem;
  line-height: 1.5;
  border-radius: 0.25rem;
  cursor: pointer;
  text-decoration: none; /* Add this to make router-link look like a button */
}
.btn-success {
  color: #fff;
  background-color: #28a745;
  border-color: #28a745;
}
.btn-primary {
  color: #fff;
  background-color: #007bff;
  border-color: #007bff;
}
.btn-issue {
  font-size: medium;
  color: #fff;
  background-color: #cf820e;
  border-color: #cf820e;
}

/* 當按鈕被禁用時的樣式 */
.btn-disabled {
  background-color: #6b6b6b;
  border-color: #6b6b6b;
  cursor: not-allowed;
}

/* --- 新增/修改的搜尋列樣式 --- */
.search-bar-container {
  position: absolute;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  width: 275px;
  height: 45px;
  z-index: 10;
  background-color: white;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
  display: flex;
  align-items: center;
  padding: 0 12px;
}

.search-bar-container :deep(.search-input) {
  flex-grow: 12;
  width: 130%;
  height: 68px;
  border: none;
  outline: none;
  font-size: 2.2rem;
  background-color: transparent;
}

/* 這是 GMapAutocomplete 元件的包裝器，我們讓它填滿空間 */
:deep(.pac-container) {
  z-index: 1051 !important; /* 確保建議清單顯示在其他元素之上 */
}

.search-button {
  height: 33px;
  margin-left: 8px;
  padding: 8px;
  border: none;
  background-color: #007bff;
  color: white;
  border-radius: 7px;
  cursor: pointer;
  font-size: 1.9rem;
  flex-shrink: 0;
  display: flex;
  align-items: center;
}
.scan-btn {
  background-color: #6c757d; /* 灰色區分 */
  margin-left: 5px;
}

/* [新增] 定位按鈕樣式 */
.locate-btn {
  background-color: #28a745; /* 綠色 */
}
.locate-btn:hover {
  background-color: #218838;
}

.search-button:hover {
  background-color: #0056b3;
}

/* 掃描介面樣式 */
.scanner-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background-color: rgba(0, 0, 0, 0.8);
  z-index: 9999;
  display: flex;
  justify-content: center;
  align-items: center;
}

.scanner-container {
  width: 90%;
  max-width: 500px;
  background: white;
  padding: 20px;
  border-radius: 10px;
  text-align: center;
}

.close-scan-btn {
  margin-top: 15px;
  width: 100%;
  font-size: 1.2rem;
}
</style>
</file>

<file path="frontend/src/layouts/AdminLayout.vue">
<script setup>
/**
 * AdminLayout.vue：AdminLTE 3 後台版型
 * [修正] 移除 lang="ts" 與型別標註，轉換為純 JS 寫法
 * [新增] 整合 SweetAlert2 登出確認
 * [新增] 下拉選單導航設計
 * [新增] Sidebar 收合/展開功能（Click Toggle + Hover Expand 模式）
 */
import { ref, onMounted, onBeforeUnmount, computed, watch } from 'vue'
import { useRouter, useRoute, RouterLink, RouterView } from 'vue-router'
// 1. 引入 SweetAlert2
import Swal from 'sweetalert2'
import { useAdminAuthStore } from '@/stores/adminAuth'

import AdminInfoModal from '@/views/member/AdminInfoModal.vue'

const adminAuthStore = useAdminAuthStore()

const router = useRouter()
const route = useRoute()

// 展開的選單群組
const expandedGroups = ref([''])

// AdminLTE 3 必備的 Body Class
const bodyClasses = ['hold-transition', 'layout-fixed']

// 需要移除的 sidebar 收合 class（這些會導致 icon-only）
const sidebarCollapseClasses = ['sidebar-collapse', 'sidebar-closed', 'sidebar-mini']

// 側邊欄狀態（性能優化：避免重複操作DOM）
const sidebarInitialized = ref(false)

const showProfileModal = ref(false)

// ========== Sidebar 狀態管理 (Single Source of Truth) ==========
// 模式：'click' = 點擊切換模式, 'hover' = 懸停展開模式
const sidebarMode = ref('click')
// 是否收合（true = 只顯示 icon）
const isCollapsed = ref(true)
// 是否被固定展開（hover 模式下的 pin 功能）
const isPinned = ref(false)
// 是否正在 hover 中
const isHovering = ref(false)
// Hover 延遲計時器
let hoverEnterTimer = null
let hoverLeaveTimer = null
// 延遲時間配置
const HOVER_ENTER_DELAY = 80
const HOVER_LEAVE_DELAY = 180

/**
 * 計算 sidebar 是否應該展開
 * - click 模式：由 isCollapsed 控制
 * - hover 模式：isPinned 或 isHovering 時展開
 */
const shouldExpand = computed(() => {
  if (sidebarMode.value === 'click') {
    return !isCollapsed.value
  }
  // hover 模式
  return isPinned.value || isHovering.value
})

/**
 * 同步 body class 與狀態
 */
const syncBodyClass = () => {
  if (shouldExpand.value) {
    document.body.classList.remove('sidebar-collapse')
    document.body.classList.add('sidebar-open')
  } else {
    document.body.classList.add('sidebar-collapse')
    document.body.classList.remove('sidebar-open')
  }
}

// 監聽 shouldExpand 變化，同步 body class
watch(shouldExpand, () => {
  syncBodyClass()
})

/**
 * 切換 Sidebar 收合狀態（漢堡按鈕）
 */
const toggleSidebar = () => {
  if (sidebarMode.value === 'click') {
    isCollapsed.value = !isCollapsed.value
  } else {
    // hover 模式下，漢堡按鈕用於 pin/unpin
    isPinned.value = !isPinned.value
  }
}

/**
 * 切換 Sidebar 模式
 */
const toggleMode = () => {
  sidebarMode.value = sidebarMode.value === 'click' ? 'hover' : 'click'
  // 切換模式時重置狀態
  isPinned.value = false
  isHovering.value = false
  if (sidebarMode.value === 'click') {
    isCollapsed.value = true
  }
}

/**
 * Hover 進入處理
 */
const handleMouseEnter = () => {
  if (sidebarMode.value !== 'hover') return
  if (isPinned.value) return // 已固定，不處理

  clearTimeout(hoverLeaveTimer)
  hoverEnterTimer = setTimeout(() => {
    isHovering.value = true
  }, HOVER_ENTER_DELAY)
}

/**
 * Hover 離開處理
 */
const handleMouseLeave = () => {
  if (sidebarMode.value !== 'hover') return
  if (isPinned.value) return // 已固定，不處理

  clearTimeout(hoverEnterTimer)
  hoverLeaveTimer = setTimeout(() => {
    isHovering.value = false
  }, HOVER_LEAVE_DELAY)
}

const formattedAdminData = computed(() => {
  const raw = adminAuthStore.admin || {}
  return {
    // 這裡的 Key (左邊) 必須呼應 Modal 裡的變數
    admId: raw.admId || raw.id, // Modal 用 adminData.admId
    admName: raw.admName || raw.name, // Modal 用 adminData.admName
    admUsername: raw.admUsername || raw.username, // Modal 用 adminData.admUsername
    admEmail: raw.admEmail || raw.email, // Modal 用 adminData.admEmail
    admRole: raw.admRole || raw.role, // Modal 用 adminData.admRole
    createdAt: raw.createdAt || raw.admCreatedAt, // Modal 用 formatDate(adminData.createdAt)
  }
})

const currentAdminAvatar = computed(() => {
  const adminId = adminAuthStore.admin?.admId || adminAuthStore.admin?.id
  if (adminId >= 1 && adminId <= 10) {
    const fileName = String(adminId).padStart(2, '0')
    return `/admin/${fileName}.jpg`
  }
  return '/admin/default.png'
})

// 選單群組定義
const menuGroups = [
  {
    id: 'spot',
    title: '場地與座位',
    icon: 'fas fa-building',
    items: [
      {
        path: '/admin/spot/list',
        icon: 'fas fa-map-marker-alt',
        title: '據點管理',
        prefix: '/admin/spot/list',
      },
      { path: '/admin/seat/list', icon: 'fas fa-chair', title: '座位管理', prefix: '/admin/seat' },
      {
        path: '/admin/spot/analyze',
        icon: 'fas fa-chart-bar',
        title: '據點分析',
        prefix: '/admin/spot/analyze',
      },
      {
        path: '/admin/spot/monitor',
        icon: 'fas fa-broadcast-tower',
        title: '調度中心',
        prefix: '/admin/spot/monitor',
      },
    ],
  },
  {
    id: 'member',
    title: '會員與權限',
    icon: 'fas fa-users-cog',
    items: [
      { path: '/admin/members', icon: 'fas fa-users', title: '會員列表', prefix: '/admin/members' },
      {
        path: '/admin/admins',
        icon: 'fas fa-user-cog',
        title: '管理員列表',
        prefix: '/admin/admins',
      },
    ],
  },
  {
    id: 'merchant',
    title: '商家與優惠',
    icon: 'fas fa-store-alt',
    items: [
      {
        path: '/admin/merchants',
        icon: 'fas fa-store',
        title: '商家管理',
        prefix: '/admin/merchants',
      },
      {
        path: '/admin/discounts',
        icon: 'fas fa-ticket-alt',
        title: '優惠券管理',
        prefix: '/admin/discounts',
      },
      {
        path: '/admin/redemption-logs',
        icon: 'fas fa-chart-bar',
        title: '兌換紀錄報表',
        prefix: '/admin/redemption',
      },
      {
        path: '/admin/sponsors',
        icon: 'fas fa-chart-bar',
        title: '贊助紀錄報表',
        prefix: '/admin/sponsors',
      },
    ],
  },
  {
    id: 'order',
    title: '租借與訂單',
    icon: 'fas fa-clipboard-list',
    items: [
      {
        path: '/admin/rec-rent',
        icon: 'fas fa-file-invoice',
        title: '訂單管理',
        prefix: '/admin/rec-rent',
      },
      {
        path: '/admin/rec-chart',
        icon: 'fas fa-file-invoice',
        title: '統計圖表',
        prefix: '/admin/rec-chart',
      },
    ],
  },
  {
    id: 'maintenance',
    title: '維護與工單',
    icon: 'fas fa-tools',
    items: [
      {
        path: '/admin/staff-list',
        icon: 'fas fa-user-shield',
        title: '維護人員管理',
        prefix: '/admin/staff',
      },
      {
        path: '/admin/mtif-list',
        icon: 'fas fa-wrench',
        title: '維修工單管理',
        prefix: '/admin/mtif',
      },
      {
        path: '/admin/maintenance/schedule',
        icon: 'fas fa-calendar-check',
        title: '定期排程管理',
        prefix: '/admin/maintenance/schedule',
      },
    ],
  },
]

onMounted(() => {
  // 性能優化：避免重複DOM操作
  if (sidebarInitialized.value) return

  // 加入必要的 layout class
  document.body.classList.add(...bodyClasses)

  // ✅ 預設收合（關閉）- 同步初始狀態到 body class
  syncBodyClass()

  // 延遲移除 hold-transition（避免初始化閃爍）
  requestAnimationFrame(() => {
    document.body.classList.remove('hold-transition')
    sidebarInitialized.value = true
  })

  // 攔截 AdminLTE 原生的 pushmenu 點擊，改用自己的邏輯
  const pushmenuBtn = document.querySelector('[data-widget="pushmenu"]')
  if (pushmenuBtn) {
    pushmenuBtn.addEventListener('click', handlePushmenuClick)
  }

  const savedAdmin = localStorage.getItem('admin')
  if (savedAdmin) {
    adminAuthStore.setAdmin(JSON.parse(savedAdmin))
  }
})

/**
 * 攔截 AdminLTE pushmenu 點擊事件
 */
const handlePushmenuClick = (e) => {
  e.preventDefault()
  e.stopPropagation()
  toggleSidebar()
}

onBeforeUnmount(() => {
  // 性能優化：只在已初始化時清理
  if (!sidebarInitialized.value) return

  document.body.classList.remove(...bodyClasses)
  // 清除 sidebar 狀態 class，避免 SPA 殘留
  document.body.classList.remove('sidebar-open')
  sidebarCollapseClasses.forEach((cls) => {
    document.body.classList.remove(cls)
  })

  // 清理 hover 計時器
  clearTimeout(hoverEnterTimer)
  clearTimeout(hoverLeaveTimer)

  // 移除 pushmenu 事件監聽
  const pushmenuBtn = document.querySelector('[data-widget="pushmenu"]')
  if (pushmenuBtn) {
    pushmenuBtn.removeEventListener('click', handlePushmenuClick)
  }

  sidebarInitialized.value = false
})

/**
 * 判斷目前路由是否屬於某個功能組
 */
const isActiveGroup = (prefix) => {
  return route.path.startsWith(prefix)
}

/**
 * 判斷群組是否有活動項目
 */
const isGroupActive = (group) => {
  return group.items.some((item) => route.path.startsWith(item.prefix))
}

/**
 * 切換群組展開狀態
 */
const toggleGroup = (groupId) => {
  const index = expandedGroups.value.indexOf(groupId)
  if (index > -1) {
    expandedGroups.value.splice(index, 1)
  } else {
    expandedGroups.value.push(groupId)
  }
}

/**
 * 判斷群組是否展開
 */
const isGroupExpanded = (groupId) => {
  return expandedGroups.value.includes(groupId)
}

/**
 * 登出功能 (SweetAlert2 版)
 */
const logout = async () => {
  // 2. 跳出確認視窗
  const result = await Swal.fire({
    title: '確定要登出嗎？',
    text: '登出後將無法存取後台頁面',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33', // 紅色按鈕表示警告
    cancelButtonColor: '#3085d6',
    confirmButtonText: '登出',
    cancelButtonText: '取消',
  })

  // 3. 使用者按了「確定」
  if (!result.isConfirmed) return

  // 統一清除 localStorage（跟 main.js / router 守衛一致）
  localStorage.removeItem('token')
  localStorage.removeItem('admin')

  // 清除 Pinia 管理員狀態（若有此方法）
  if (typeof adminAuthStore.clearAdmin === 'function') {
    adminAuthStore.clearAdmin()
  }

  // 顯示成功訊息並跳轉
  await Swal.fire({
    title: '已登出！',
    text: '登出成功!',
    icon: 'success',
    timer: 1500,
    showConfirmButton: false,
  })

  router.push('/login')
}
</script>

<template>
  <div class="wrapper">
    <!-- 頂部導航欄 -->
    <nav class="main-header navbar navbar-expand navbar-white navbar-light border-bottom">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a
            class="nav-link"
            data-widget="pushmenu"
            href="#"
            role="button"
            :title="sidebarMode === 'hover' ? (isPinned ? '取消固定' : '固定展開') : '切換選單'"
          >
            <i
              class="fas"
              :class="sidebarMode === 'hover' && isPinned ? 'fa-thumbtack' : 'fa-bars'"
            ></i>
          </a>
        </li>
        <li class="nav-item d-none d-sm-inline-block">
          <RouterLink to="/admin" class="nav-link">
            <i class="fas fa-home me-1"></i> 後台首頁
          </RouterLink>
        </li>
        <li class="nav-item d-none d-sm-inline-block">
          <RouterLink to="/" class="nav-link">
            <i class="fas fa-external-link-alt me-1"></i> 前台首頁
          </RouterLink>
        </li>
        <!-- 模式切換按鈕 -->
        <li class="nav-item d-none d-sm-inline-block">
          <a
            class="nav-link"
            href="#"
            @click.prevent="toggleMode"
            :title="sidebarMode === 'click' ? '切換為 Hover 模式' : '切換為 Click 模式'"
          >
            <i
              class="fas"
              :class="sidebarMode === 'click' ? 'fa-mouse-pointer' : 'fa-hand-pointer'"
            ></i>
            <span class="ml-1">{{ sidebarMode === 'click' ? 'Click' : 'Hover' }}</span>
          </a>
        </li>
      </ul>

      <ul class="navbar-nav ml-auto">
        <li class="nav-item">
          <a class="nav-link text-danger fw-bold" href="#" @click.prevent="logout">
            <i class="fas fa-sign-out-alt"></i> 登出
          </a>
        </li>
      </ul>
    </nav>

    <!-- 側邊欄 -->
    <aside
      class="main-sidebar sidebar-dark-primary elevation-2"
      @mouseenter="handleMouseEnter"
      @mouseleave="handleMouseLeave"
    >
      <!-- 品牌 Logo -->
      <RouterLink to="/admin" class="brand-link">
        <div class="brand-icon">
          <i class="fas fa-chair"></i>
        </div>
        <span class="brand-text">Take@Seat</span>
      </RouterLink>

      <div class="sidebar">
        <!-- 管理員資訊卡片 -->
        <div class="user-card" @click="showProfileModal = true" style="cursor: pointer">
          <div class="user-avatar">
            <img :src="currentAdminAvatar" class="sidebar-avatar-img" />
          </div>
          <div class="user-info">
            <span class="user-name">{{ adminAuthStore.admin.name || '管理員' }}</span>
            <span class="user-role">
              <i class="fas fa-shield-alt"></i>
              {{ adminAuthStore.admin.role === 9 ? '超級管理員' : '一般管理員' }}
            </span>
          </div>
        </div>

        <!-- 導航選單 -->
        <nav class="sidebar-nav">
          <!-- 選單群組 -->
          <div class="nav-section">
            <div
              v-for="group in menuGroups"
              :key="group.id"
              class="menu-group"
              :class="{
                'is-active': isGroupActive(group),
                'is-expanded': isGroupExpanded(group.id),
              }"
            >
              <!-- 群組標題 -->
              <div class="group-header" @click="toggleGroup(group.id)">
                <div class="group-icon">
                  <i :class="group.icon"></i>
                </div>
                <span class="group-title">{{ group.title }}</span>
                <div class="group-arrow">
                  <i class="fas fa-chevron-down"></i>
                </div>
              </div>

              <!-- 群組項目 -->
              <transition name="slide">
                <div class="group-items" v-show="isGroupExpanded(group.id)">
                  <RouterLink
                    v-for="item in group.items"
                    :key="item.path"
                    :to="item.path"
                    class="menu-item"
                    :class="{ active: isActiveGroup(item.prefix) }"
                  >
                    <i :class="item.icon"></i>
                    <span>{{ item.title }}</span>
                  </RouterLink>
                </div>
              </transition>
            </div>
          </div>
        </nav>
      </div>
    </aside>

    <!-- 主要內容區 -->
    <div class="content-wrapper">
      <section class="content py-3">
        <div class="container-fluid">
          <RouterView />
        </div>
      </section>
    </div>
    <AdminInfoModal
      :show="showProfileModal"
      :adminData="formattedAdminData"
      @close="showProfileModal = false"
    />
  </div>
</template>

<style scoped>
/* ========== 品牌區域 ========== */
.brand-link {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 16px 20px !important;
  background: linear-gradient(135deg, #9db8d4 0%, #8fa8c8 100%) !important;
  border-bottom: 1px solid rgba(255, 255, 255, 0.25);
  text-decoration: none;
  transition: background 0.2s ease;
  will-change: background;
}

.brand-link:hover {
  background: linear-gradient(135deg, #8fa8c8 0%, #8199bc 100%) !important;
}

.brand-icon {
  width: 36px;
  height: 36px;
  background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 19px;
  transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  will-change: transform;
}

.brand-link:hover .brand-icon {
  transform: scale(1.1) rotate(5deg);
}

.brand-text {
  color: white !important;
  font-size: 1.1rem;
  font-weight: 600;
  letter-spacing: 0.5px;
}

/* ========== 側邊欄整體 ========== */
.main-sidebar {
  background: linear-gradient(180deg, #bdddff 0%, #96b5d4 100%) !important;
  width: 250px !important; /* 展開寬度 */
  min-width: 250px !important;
  overflow: hidden !important;
  transition:
    width 0.3s ease,
    min-width 0.3s ease !important;
  will-change: width, min-width;
}

.sidebar {
  padding: 0 !important;
  display: flex;
  flex-direction: column;
  height: calc(100vh - 70px);
  overflow: visible;
  width: 250px; /* 固定內部寬度，避免文字換行 */
}

/* ========== 用戶卡片 ========== */
.user-card {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px;
  margin: 12px 12px;
  background: rgba(255, 255, 255, 0.25);
  border-radius: 8px;
  border: 1px solid rgba(255, 255, 255, 0.35);
  transition:
    background 0.2s ease,
    box-shadow 0.2s ease;
  will-change: background, box-shadow;
}

.user-card:hover {
  background: rgba(255, 255, 255, 0.35);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.user-avatar {
  width: 42px;
  height: 42px;
  background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 20px;
}

.user-info {
  display: flex;
  flex-direction: column;
}

.user-name {
  color: #1e293b;
  font-weight: 600;
  font-size: 0.9rem;
}

.user-role {
  color: #475569;
  font-size: 0.75rem;
  margin-top: 2px;
  display: flex;
  align-items: center;
  gap: 4px;
}

.user-role i {
  font-size: 10px;
  color: #60a5fa;
}

/* ========== 導航區域 ========== */
.sidebar-nav {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 0 12px;
  scroll-behavior: smooth;
  /* 性能優化：固定高度避免計算 */
  contain: layout style paint;
}

.nav-section {
  margin-bottom: 12px;
}

/* ========== 選單群組 ========== */
.menu-group {
  margin-bottom: 2px;
  border-radius: 10px;
  overflow: hidden;
  /* 移除hover transform，避免layout shift */
}

.menu-group.is-active .group-header {
  background: rgba(76, 133, 248, 0.25);
}

.group-header {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 4px 4px;
  cursor: pointer;
  transition: background 0.15s ease;
  border-radius: 12px;
  position: relative;
  will-change: background;
}

.group-header:hover {
  background: rgba(255, 255, 255, 0.15);
}

.group-icon {
  width: 32px;
  height: 32px;
  background: rgba(255, 255, 255, 0.3);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #1e293b;
  font-size: 18px;
  transition: background 0.15s ease;
  will-change: background;
}

.group-header:hover .group-icon {
  background: rgba(255, 255, 255, 0.4);
  transform: scale(1.1) rotate(5deg);
}

.menu-group.is-active .group-icon {
  background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
  color: white;
  box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
}

.group-title {
  flex: 1;
  color: #1e293b;
  font-size: 0.92rem;
  font-weight: 600;
}

.group-arrow {
  color: #64748b;
  font-size: 18px;
  transition: transform 0.3s ease;
}

.menu-group.is-expanded .group-arrow {
  transform: rotate(180deg);
}

/* ========== 群組項目 ========== */
.group-items {
  padding: 0px 0 0px 0;
  background: rgba(5, 0, 0, 0.1);
  border-radius: 0 0 10px 10px;
  overflow: hidden;
  will-change: max-height, opacity;
  transform-origin: top;
  /* 性能優化：避免submenu影響外層容器 */
  contain: layout;
}

.menu-item {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 5px 1px 5px 55px;
  color: #ffffff;
  text-decoration: none;
  font-size: 0.9rem;
  font-weight: 500;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
}

.menu-item::before {
  content: '';
  position: absolute;
  left: 40px;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: #19365e;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.menu-item:hover {
  color: #000000;
  font-weight: 900;
}

.menu-item:hover::before {
  background: #1d4ed8;
  transform: scale(1.5);
  box-shadow: 0 0 10px rgba(29, 78, 216, 0.6);
}

.menu-item.active {
  color: #000000;
  background: rgba(55, 121, 255, 0.25);
  font-weight: 700;
}

.menu-item.active::before {
  background: #0173ff;
  box-shadow: 0 0 8px rgba(96, 165, 250, 0.5);
}

.menu-item i {
  width: 18px;
  text-align: center;
  font-size: 13px;
}

/* ========== 展開動畫（性能優化版） ========== */
.slide-enter-active {
  transition:
    max-height 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94),
    opacity 0.25s ease-out;
  overflow: hidden;
  will-change: max-height, opacity;
}

.slide-leave-active {
  transition:
    max-height 0.25s cubic-bezier(0.55, 0.06, 0.68, 0.19),
    opacity 0.2s ease-in;
  overflow: hidden;
  will-change: max-height, opacity;
}

.slide-enter-from {
  max-height: 0 !important;
  opacity: 0;
}

.slide-enter-to {
  max-height: 400px !important;
  opacity: 1;
}

.slide-leave-from {
  max-height: 400px !important;
  opacity: 1;
}

.slide-leave-to {
  max-height: 0 !important;
  opacity: 0;
}

/* ========== 頂部導航欄 ========== */
.main-header .navbar-nav .nav-link {
  padding: 8px 12px;
  font-size: 0.9rem;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

/* 漢堡按鈕動態效果（簡化版） */
.main-header .navbar-nav .nav-link[data-widget='pushmenu'] {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  transition: color 0.15s ease;
}

.main-header .navbar-nav .nav-link[data-widget='pushmenu']:active {
  color: #1d4ed8;
}

.main-header .navbar-nav .nav-link[data-widget='pushmenu']:hover {
  color: #3b82f6;
}

.main-header .navbar-text {
  color: #1e3a5f;
  font-weight: 500;
  font-size: 0.9rem;
}

/* ========== 滾動條美化 - 增強可見度 ========== */
.sidebar-nav::-webkit-scrollbar {
  width: 8px;
}

.sidebar-nav::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.15);
  border-radius: 4px;
}

.sidebar-nav::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.4);
  border-radius: 4px;
  border: 2px solid transparent;
  background-clip: padding-box;
}

.sidebar-nav::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.6);
  border: 2px solid transparent;
  background-clip: padding-box;
}

/* Firefox scrollbar */
.sidebar-nav {
  scrollbar-width: thin;
  scrollbar-color: rgba(255, 255, 255, 0.4) rgba(255, 255, 255, 0.15);
}

/* AdminLTE 主內容區：統一由AdminLTE JS管理動畫 */
.content-wrapper {
  will-change: transform;
}

.sidebar-avatar-img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 10px; /* 跟原本 .user-avatar 的圓角一致 */
}

/* 頂部導航欄微型頭像樣式 */
.nav-avatar-mini {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  object-fit: cover;
  margin-right: 8px;
  border: 1px solid #ddd;
}

/* ========== Sidebar 收合狀態樣式 ========== */
/* 定義需要隱藏的文字元素的過渡動畫 */
.brand-text,
.user-info,
.group-title,
.group-arrow,
.menu-item span {
  transition:
    opacity 0.25s ease,
    transform 0.25s ease,
    width 0.25s ease;
  white-space: nowrap;
  overflow: hidden;
}

/* 用戶卡片收合過渡 */
.user-card {
  transition:
    background 0.2s ease,
    box-shadow 0.2s ease,
    padding 0.25s ease,
    margin 0.25s ease;
}
</style>

<!-- 非 scoped 樣式：處理 body.sidebar-collapse 狀態 -->
<style>
/* ========== Sidebar 收合狀態 (body.sidebar-collapse) ========== */
/* 收合寬度：72px */
body.sidebar-collapse .main-sidebar {
  width: 72px !important;
  min-width: 72px !important;
}

/* 隱藏品牌文字 */
body.sidebar-collapse .brand-text {
  opacity: 0;
  width: 0;
  overflow: hidden;
  display: none;
}

/* 品牌區域收合時置中 */
body.sidebar-collapse .brand-link {
  justify-content: center;
  padding: 16px 12px !important;
}

/* 隱藏用戶資訊 */
body.sidebar-collapse .user-info {
  opacity: 0;
  width: 0;
  overflow: hidden;
  display: none;
}

/* 用戶卡片收合時置中 */
body.sidebar-collapse .user-card {
  justify-content: center;
  padding: 8px;
  margin: 12px 8px;
}

/* 隱藏群組標題 */
body.sidebar-collapse .group-title {
  opacity: 0;
  width: 0;
  overflow: hidden;
  display: none;
}

/* 隱藏群組箭頭 */
body.sidebar-collapse .group-arrow {
  opacity: 0;
  width: 0;
  overflow: hidden;
  display: none;
}

/* 群組標題收合時置中 */
body.sidebar-collapse .group-header {
  justify-content: center;
  padding: 8px;
}

/* 隱藏選單項目文字 */
body.sidebar-collapse .menu-item span {
  opacity: 0;
  width: 0;
  overflow: hidden;
  display: none;
}

/* 選單項目收合時調整 */
body.sidebar-collapse .menu-item {
  justify-content: center;
  padding: 10px 8px;
}

/* 隱藏選單項目前的圓點 */
body.sidebar-collapse .menu-item::before {
  display: none;
}

/* 群組項目收合時隱藏（因為只顯示 icon，子項目不需要展開） */
body.sidebar-collapse .group-items {
  display: none !important;
}

/* 側邊欄內部固定寬度 */
body.sidebar-collapse .sidebar {
  width: 72px;
}

/* 導航區域收合時調整 padding */
body.sidebar-collapse .sidebar-nav {
  padding: 0 4px;
}

/* content-wrapper 收合時的 margin 調整 */
body.sidebar-collapse .content-wrapper {
  margin-left: 72px !important;
}

body.sidebar-open .menu-item::before {
  display: block;
}
</style>
</file>

<file path="frontend/src/router/index.js">
import { createRouter, createWebHistory } from 'vue-router'
import Swal from 'sweetalert2'

/**
 * ==========================================
 * 1. 靜態導入元件 (Static Imports)
 * ==========================================
 */
import LoginView from '@/views/member/LoginView.vue' // 登入頁
import AdminLayout from '@/layouts/AdminLayout.vue' // 後臺主框架 (包含側邊欄與 Header)
import AdminHomeView from '@/views/member/AdminHomeView.vue' // 後臺首頁(儀表板)
import MemberListView from '@/views/member/MemberListView.vue' // 會員列表
import MemberEditView from '@/views/member/MemberEditView.vue' // 會員編輯
import MemberCreateView from '@/views/member/MemberCreateView.vue' // 會員新增
import PaymentView from '@/views/ecpay/PaymentView.vue' // 綠界付款頁
import AdminListView from '@/views/member/AdminListView.vue' // 管理員列表
import AdminCreateView from '@/views/member/AdminCreateView.vue' // 管理員新增
import AdminEditView from '@/views/member/AdminEditView.vue' // 管理員編輯
import MemberLayout from '@/layouts/MemberLayout.vue' // 會員主框架
import MemberProfileView from '@/views/member/MemberProfileView.vue' // 會員個人資料頁
import AuthLayout from '@/layouts/AuthLayout.vue' // 認證相關頁面框架
import MainLayout from '@/layouts/MainLayout.vue' // 前台主框架
import HomeView from '@/views/HomeView.vue' // 前台首頁

/**
 * ==========================================
 * 2. 懶加載導入 (Dynamic Imports)
 * ==========================================
 */
const MerchantList = () => import('@/views/merchantAndCoupon/MerchantList.vue') // 商家列表
const DiscountList = () => import('@/views/merchantAndCoupon/DiscountList.vue') // 優惠券列表
const RedemptionLogList = () => import('@/views/merchantAndCoupon/RedemptionLogList.vue') // 新增：後台紀錄
const CouponMall = () => import('@/views/merchantAndCoupon/CouponMallView.vue') // 新增：前台商城
const SnakeGame = () => import('@/views/game/SnakeGame.vue') // 貪食蛇遊戲

// 定義路由表
const routes = [
  // --- 登入頁面 ---
  {
    path: '/login',
    name: 'login',
    component: LoginView,
  },

  // ==========================================
  // [新增] 前台使用者頁面 (不套用後台側邊欄)
  // ==========================================
  {
    path: '/',
    name: 'entrance',
    component: MainLayout,
    children: [
      {
        path: '',
        name: 'home',
        component: HomeView,
      },

      // 會員頁面
      {
        path: 'profile',
        name: 'member-profile',
        component: MemberProfileView,
      },

      // 租借頁面
      {
        path: 'rent/:action?',
        name: 'rec-rent-user',
        component: () => import('@/views/rec/RecRentUserPage.vue'),
      },
      {
        path: 'SearchSpot',
        name: 'SearchSpot',
        component: () => import('@/views/rec/RecRentUserSearchPage.vue'),
      },
      {
        path: 'VisitSiteReommand',
        name: 'VisitSiteReommand',
        component: () => import('@/views/rec/VisitSiteReommandPage.vue'),
      },

      // 將 'rec-rent-record' 路由重定向至帶有 action 參數的標準租借路由
      {
        path: 'recordRoute',
        name: 'rec-rent-record',
        redirect: { name: 'rec-rent-user', params: { action: 'record' } },
      },

      {
        path: 'payment/order',
        name: 'payment-order',
        component: () => import('@/views/ecpay/PaymentViewOrder.vue'),
      },
      {
        path: 'claims',
        name: 'claims',
        component: () => import('@/views/rec/RightsClaimPage.vue'),
      },

      // --- 新增：優惠券商城 ---
      {
        path: '/mall',
        name: 'coupon-mall',
        component: CouponMall,
      },

      // --- 新增：前台貪食蛇遊戲 ---
      {
        path: '/snake',
        name: 'snake-game',
        component: SnakeGame,
      },
      {
        path: '/redemption-history',
        name: 'redemption-history',
        component: () => import('@/views/merchantAndCoupon/RedemptionHistory.vue'),
      },
      {
        path: '/sponsor',
        name: 'sponsor',
        component: () => import('@/views/ecpay/SponsorView.vue'),
      },
      {
        path: '/payment-success',
        name: 'payment-success',
        component: () => import('@/views/ecpay/PaymentSuccessView.vue'),
      },

      // 訂單確認與付款頁
      {
        path: '/payment-checkout/:recId',
        name: 'payment-checkout',
        component: () => import('@/views/ecpay/PaymentView.vue'),
      },

      // ==========================================
      // (翌帆2026-1-31)【新增】客服支援模組 (Support)
      // ==========================================
      {
        path: '/support',
        name: 'support-center',
        component: () => import('@/views/support/SupportCenterView.vue'),
      },
      {
        path: '/support/report',
        name: 'support-report-entry',
        component: () => import('@/views/support/ReportEntryView.vue'),
      },
      {
        path: '/support/report/damage',
        name: 'support-report-damage',
        component: () => import('@/views/support/ReportDamageView.vue'),
      },
      {
        path: '/support/report/manual',
        name: 'support-report-manual',
        component: () => import('@/views/support/ReportManualView.vue'),
      },
    ],
  },

  // 註冊會員
  {
    path: '/register',
    component: AuthLayout,
    children: [
      {
        path: '',
        component: () => import('@/views/member/Register.vue'),
      },
    ],
  },

  /**
   * ==========================================
   * 3. 管理後臺嵌套路由 (Nested Routes)
   * 網址前綴統一為 /admin
   * ==========================================
   */
  {
    path: '/admin',
    component: AdminLayout,
    children: [
      // 管理後臺首頁
      {
        path: '',
        name: 'admin-home',
        component: AdminHomeView,
      },

      // 據點與座位管理 (Spot & Seat)
      {
        path: 'spot/list',
        name: 'spot-list',
        component: () => import('@/views/spot/SpotList.vue'),
      },

      // 據點新增與編輯共用同一個元件
      {
        path: 'spot/add',
        name: 'spot-add',
        component: () => import('@/views/spot/SpotForm.vue'),
      },

      // 據點編輯
      {
        path: 'spot/edit/:id',
        name: 'spot-edit',
        component: () => import('@/views/spot/SpotForm.vue'),
      },

      // 據點詳細資訊
      {
        path: 'spot/view/:id', // 網址: /admin/spot/view/1
        name: 'spot-view',
        component: () => import('@/views/spot/SpotOne.vue'),
      },
      // 據點統計儀表板
      {
        path: 'spot/analyze',
        name: 'spot-analyze',
        component: () => import('@/views/spot/SpotAnalyze.vue'),
      },
      {
        path: 'spot/monitor',
        name: 'dispatch-monitor',
        component: () => import('@/views/spot/DispatchMonitor.vue'),
      },
      // ==========================================
      // [整合] 座位管理模組 (Seat)
      // ==========================================
      // 座位管理

      {
        path: 'seat/list',
        name: 'seat-list',
        component: () => import('@/views/spot/SeatList.vue'),
      },

      // 座位新增與編輯共用同一個元件
      {
        path: 'seat/insert',
        name: 'seat-insert',
        component: () => import('@/views/spot/SeatForm.vue'),
      },

      // 座位編輯
      {
        path: 'seat/edit/:id',
        name: 'seat-edit',
        component: () => import('@/views/spot/SeatForm.vue'),
      },

      // 座位詳細資訊
      {
        path: 'seat/view/:id',
        name: 'seat-view',
        component: () => import('@/views/spot/SeatOne.vue'),
      },

      // [核心功能] 商家與優惠券管理
      {
        path: 'merchants',
        name: 'merchants',
        component: MerchantList,
      },

      // 優惠券管理
      {
        path: 'discounts',
        name: 'discounts',
        component: DiscountList,
        alias: 'coupons',
      },
      // --- 新增：兌換紀錄報表 ---
      {
        path: 'redemption-logs',
        name: 'admin-redemption-logs',
        component: RedemptionLogList,
      },

      // [新增] 後台貪食蛇遊戲
      {
        path: 'snake-game',
        name: 'admin-snake-game',
        component: SnakeGame,
      },
      {
        path: 'sponsors',
        name: 'admin-sponsors',
        component: () => import('@/views/ecpay/SponsorLog.vue'),
      },

      // [核心功能] 會員管理
      {
        path: 'members',
        name: 'member-list',
        component: MemberListView,
      },

      // 會員編輯
      {
        path: 'members/edit/:id',
        name: 'member-edit',
        component: MemberEditView,
      },

      // 會員新增
      {
        path: 'members/create',
        name: 'member-create',
        component: MemberCreateView,
      },

      // [核心功能] 管理員管理
      {
        path: 'admins',
        name: 'admin-list',
        component: AdminListView,
      },

      // 管理員新增
      {
        path: 'admins/create',
        name: 'admin-create',
        component: AdminCreateView,
      },

      // 管理員編輯
      {
        path: 'admins/edit/:id',
        name: 'admin-edit',
        component: AdminEditView,
      },

      // [功能] 租借訂單管理
      {
        path: 'rec-rent',
        name: 'rec-rent',
        component: () => import('@/views/rec/RecRentMgnPage.vue'),
      },
      {
        path: 'rec-chart',
        name: 'rec-chart',
        component: () => import('@/views/rec/RecRentMgnChartPage.vue'),
      },

      // [功能] 維修管理 (Maintenance)
      {
        path: 'staff-list',
        name: 'staff-list',
        component: () => import('@/views/maintenance/MaintenanceStaffList.vue'),
      },

      // 維修人員表單 (新增/編輯)
      {
        path: 'staff-form/:id?',
        name: 'staff-form',
        component: () => import('@/views/maintenance/MaintenanceStaffForm.vue'),
      },

      // 維修人員歷史紀錄
      {
        path: 'staff-history',
        name: 'staff-history',
        component: () => import('@/views/maintenance/MaintenanceStaffHistory.vue'),
      },

      // 維修工單列表與表單
      {
        path: 'mtif-list',
        name: 'mtif-list',
        component: () => import('@/views/maintenance/MtifList.vue'),
        props: { historyMode: false },
      },

      // 維修工單歷史紀錄
      {
        path: 'mtif-history',
        name: 'mtif-history',
        component: () => import('@/views/maintenance/MtifList.vue'),
        props: { historyMode: true },
      },

      // 維修工單表單 (新增/編輯)
      {
        path: 'mtif-form/:id?',
        name: 'mtif-form',
        component: () => import('@/views/maintenance/MtifForm.vue'),
      },

      // --- Schedule (排程) ---
      {
        path: 'maintenance/schedule',
        name: 'schedule-list',
        component: () => import('@/views/maintenance/ScheduleList.vue'),
      },

      // 排程表單 (新增/編輯)
      {
        path: 'maintenance/schedule/create',
        name: 'schedule-create',
        component: () => import('@/views/maintenance/ScheduleForm.vue'),
      },

      // 排程編輯
      {
        path: 'maintenance/schedule/edit/:id',
        name: 'schedule-edit',
        component: () => import('@/views/maintenance/ScheduleForm.vue'),
      },
    ],
  },

  // ==========================================
  // 4. 路由守衛與轉址 (Redirects)
  // ==========================================

  {
    path: '/:pathMatch(.*)*',
    redirect: '/',
  },
]

const router = createRouter({
  history: createWebHistory(import.meta.env.BASE_URL),
  routes,
})

/**
 * ==========================================
 * 全域路由守衛：後台登入驗證（統一 localStorage）
 * ==========================================
 */
router.beforeEach((to, from, next) => {
  // 1. 如果不是去後台，直接放行
  if (!to.path.startsWith('/admin')) {
    next()
    return
  }

  // 2. 取得 localStorage 資料
  const token = localStorage.getItem('token')
  const adminJson = localStorage.getItem('admin')

  // Debug 用：如果進不去，請按 F12 看 Console
  console.log('路由守衛檢查:', { path: to.path, hasToken: !!token, hasAdmin: !!adminJson })

  // 3. 判斷是否有管理員身分
  if (adminJson) {
    // 只要有 admin 資料就讓它進去 (Token 視後端攔截器而定)
    next()
  } else {
    // 沒資料才跳警告
    Swal.fire({
      icon: 'warning',
      title: '請先登入',
      text: '管理員帳號已過期或尚未登入。',
      confirmButtonText: '去登入',
      allowOutsideClick: false,
    }).then(() => {
      next('/login')
    })
  }
})

export default router
</file>

<file path="frontend/src/layouts/MainLayout.vue">
<script setup>
import { ref, computed } from 'vue'
import { useMemberAuthStore } from '@/stores/memberAuth'
import { useAdminAuthStore } from '@/stores/adminAuth'
import { useRouter } from 'vue-router'

const router = useRouter()

// --- 版面狀態 ---
const isSidebarCollapsed = ref(false)

//切換側邊欄收合狀態
const toggleSidebar = () => {
  isSidebarCollapsed.value = !isSidebarCollapsed.value
}

const memberAuthStore = useMemberAuthStore()
const adminAuthStore = useAdminAuthStore()

/**
 * UID 顯示邏輯：
 * - 管理員優先
 * - 再來會員
 * - 都沒有就尚未登入
 */
const displayUID = computed(() => {
  if (adminAuthStore.isLogin) {
    return adminAuthStore.admin?.username || ''
  }
  if (memberAuthStore.isLogin) {
    return memberAuthStore.member?.memUsername || ''
  }
  return null
})

/**
 * 產品化：點擊 UID 的導頁策略
 * - 未登入：不動作（也可改成導去 /login）
 * - 管理員登入：導去 /admin
 * - 會員登入：導去 /profile
 */
const handleUidClick = () => {
  if (!displayUID.value) {
    router.push('/login')
    return
  }

  if (adminAuthStore.isLogin) {
    router.push('/admin')
    return
  }

  // member
  router.push('/profile')
}

/**
 *  產品化：讓游標跟可點性一致
 */
const uidClickable = computed(() => true)
const uidCursor = computed(() => (uidClickable.value ? 'pointer' : 'default'))

/**
 * 登出：
 * - 清空 Pinia（會員 / 管理員）
 * - 清空 localStorage
 * - 停留在首頁
 */
const logout = () => {
  // 清空 Pinia
  memberAuthStore.clearMemberLogin()
  adminAuthStore.clearAdmin()

  // 清空 localStorage
  localStorage.removeItem('member_user')
  localStorage.removeItem('admin')
  localStorage.removeItem('token')

  // 留在首頁（刷新一次確保畫面同步）
  window.location.href = '/'
}
</script>

<template>
  <div class="app-layout">
    <div class="page-wrapper" :class="{ 'sidebar-collapsed': isSidebarCollapsed }">
      <!-- 側邊欄 -->
      <aside class="sidebar">
        <!-- 收合功能選單 -->
        <ul class="menu-list">
          <li class="menu-item" @click="router.push('/')">
            <div class="member-info">
              <span class="icon-wrapper">
                <el-icon><House /></el-icon>
              </span>
              <span class="menu-text">Take@Seat</span>
            </div>
          </li>

          <!--未登入才顯示「會員登入」 -->
          <li class="menu-item" v-if="!memberAuthStore.isLogin && !adminAuthStore.isLogin">
            <router-link to="/login" class="member-info">
              <span class="icon-wrapper">
                <el-icon><Avatar /></el-icon>
              </span>
              <span class="menu-text">請先登入</span>
            </router-link>
          </li>
          <li class="menu-item">
            <div
              class="member-info"
              @click="handleUidClick"
              :style="{
                cursor: uidCursor,
                width: '100%',
              }"
              :aria-disabled="!uidClickable"
            >
              <span class="icon-wrapper" style="font-size: 130%; font-weight: 400">UID: </span>
              <span class="menu-text">
                <span v-if="displayUID">{{ displayUID }}</span>
                <span v-else> 歡迎使用 </span>
              </span>
            </div>
          </li>

          <li class="menu-item" @click="router.push('/SearchSpot')">
            <span class="icon-wrapper">
              <el-icon><Pointer /></el-icon>
            </span>
            <span class="menu-text">@Seat借還</span>
          </li>

          <li class="menu-item" @click="router.push('/mall')">
            <span class="icon-wrapper">
              <el-icon><Ticket /></el-icon>
            </span>
            <span class="menu-text">商家優惠</span>
          </li>

          <li class="menu-item" @click="router.push('/snake')">
            <span class="icon-wrapper">
              <el-icon><SwitchFilled /></el-icon>
            </span>
            <span class="menu-text">小遊戲</span>
          </li>
          <li class="menu-item" v-if="memberAuthStore.isLogin">
            <router-link to="/redemption-history" class="member-info">
              <span class="icon-wrapper">
                <el-icon><List /></el-icon>
              </span>
              <span class="menu-text">兌換紀錄</span>
            </router-link>
          </li>

          <li class="menu-item" @click="router.push('/VisitSiteReommand')">
            <span class="icon-wrapper">
              <el-icon><MapLocation /></el-icon>
            </span>
            <span class="menu-text">美食景點</span>
          </li>
          <li class="menu-item" @click="router.push('/support')">
            <span class="icon-wrapper">
              <el-icon><Phone /></el-icon>
            </span>
            <span class="menu-text">客服支援</span>
          </li>

          <li class="menu-item">
            <router-link to="/sponsor" class="member-info">
              <span class="icon-wrapper">
                <el-icon><StarFilled /></el-icon>
              </span>
              <span class="menu-text">支持我們</span>
            </router-link>
          </li>
          <li class="menu-item" @click="logout">
            <span class="icon-wrapper">
              <el-icon><TopLeft /></el-icon>
            </span>
            <span class="menu-text">登出</span>
          </li>
        </ul>
        <!--管理員快捷入口-->
        <div class="menu-admin" v-if="adminAuthStore.isLogin">
          <router-link to="/admin" class="member-info">
            <span class="icon-wrapper">
              <el-icon><Tools /></el-icon>
            </span>
            <span class="menu-text">後台管理</span>
          </router-link>
        </div>

        <!--收合按鈕 -->
        <div class="sidebar-footer">
          <button
            @click="toggleSidebar"
            class="toggle-btn"
            :title="isSidebarCollapsed ? '展開' : '收合'"
          >
            <el-icon>
              <DArrowLeft v-if="!isSidebarCollapsed" />
              <DArrowRight v-if="isSidebarCollapsed" />
            </el-icon>
          </button>
        </div>
      </aside>

      <!-- 右側主內容容器 -->
      <main class="main-content-area">
        <router-view />
      </main>
    </div>

    <!-- Footer -->
    <footer class="main-footer">
      <div class="footer-links">
        <a href="/claims">隱私權政策</a> | <a href="#">個資告知書</a> | <a href="#">使用條款</a> |
        <a href="#">服務條款</a> | © 2026 Have@Seat及其關係企業版權所有。
      </div>
      <div class="footer-copyright">
        Have@Seat其等之標誌以及本網站中其他Have@Seat產品及服務名稱及標誌，皆為Have@Seat Inc.
        之商標或註冊商標。本網站中提及之其他公司名稱、產品名稱、服務名稱及標誌，分別為其所有權人之商標。
      </div>
    </footer>
  </div>
</template>

<style scoped>
/* --- 0. App Layout --- */
.app-layout {
  display: flex;
  flex-direction:column;
  height:100vh;
  width: 100%;
  background-color: #ffffff;
}

/* --- 1. CSS 變數 --- */
:root {
  --sidebar-width-expanded: 200px;
  --sidebar-width-collapsed: 80px;
}
/* --- 4. 主內容容器 --- */
.main-content-area {
  flex-grow: 1;
  width: 100%;
  position: relative;
  display: flex;
  flex-direction: column;
  overflow-y: auto; /* 當內容超出時，顯示滾動條，避免內容溢出覆蓋頁尾 */
}
/* --- 2. 主佈局 --- */
.page-wrapper {
  display: flex;
  flex: 1; /* 取代 height: 100vh，使其能自動伸展 */
  width: 100%;
  overflow: hidden; /* 確保子元素滾動，而不是此容器滾動 */
}

/* --- 3. 側邊欄 --- */
.sidebar {
  width: var(--sidebar-width-expanded);
  background-color: #c4f7c4;
  border-right: 1px solid #dee2e6;
  transition: width 0.2s ease;
  flex-shrink: 0;
  display: flex;
  overflow-y: auto;
  flex-direction: column;
  height: auto;
}

.page-wrapper.sidebar-collapsed .sidebar {
  width: var(--sidebar-width-collapsed);
  overflow-y: auto;
}

/* 通用圖示容器樣式 */
.icon-wrapper {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 15px;
  height: 10px;
  font-size: 30px; /* for SVG size */
  color: #2e2e2e;
  flex-shrink: 0;
}

.member-info {
  display: flex;
  align-items: center;
  gap: 20px;
  text-decoration: none;
  color: inherit;
}

/* 功能選單 (可隱藏) */
.menu-list {
  list-style: none;
  padding: 0;
  margin: 3px 0;
  flex-grow: 1;
  overflow-y: auto;
  overflow-x: hidden; /* 新增：防止水平滾動條 */
}

.menu-item {
  display: flex;
  align-items: center;
  padding: 10px 12px;
  gap: 17px;
  cursor: pointer;
  white-space: nowrap;
  transition: background-color 0.2s;
}

.menu-item:hover,
.menu-admin:hover {
  background-color: #f5f7fa;
}

.menu-admin {
  display: flex;
  align-items: center;
  padding: 12px 15px;
  gap: 20px;
  cursor: pointer;
  white-space: nowrap;
  transition: background-color 0.2s;
}
.menu-text {
  font-size: 20px;
  font-family: fantasy;
  opacity: 1;
  transition:
    opacity 0.2s ease,
    width 0.2s ease;
  user-select: none;
  pointer-events: none;
}

.member-info:active {
  background-color: transparent !important;
}

.page-wrapper.sidebar-collapsed .menu-text {
  opacity: 0;
  width: 0;
}

/* 側邊欄頁腳 (收合按鈕) */
.sidebar-footer {
  padding: 3px;
  margin-top: auto; /* 將按鈕推到底部 */
  border-top: 1px solid #e9ecef;
}

.toggle-btn {
  width: 90%;
  background-color: #f5f7fa;
  border: 1px solid #dcdfe6;
  border-radius: 12px;
  cursor: pointer;
  padding: 5px;
  font-size: 28px;
  line-height: 1;
  color: #404142;
  display: flex;
  justify-content: center;
  align-items: center;
  transition:
    background-color 0.2s,
    color 0.2s;
}

.toggle-btn:hover {
  background-color: #ecf5ff;
  color: #409eff;
}

/* --- 5. Footer --- */
.main-footer {
  flex-shrink: 0;
  background-color: #ffffff;
  padding: 0;
  border-top: 1px solid #ffffff;
  color: #6c757d;
  font-size: 0.8rem;
  text-align: center;
   flex-direction: column;
  margin:0%;
}

.footer-links {
  margin-bottom: 1px;
}

.footer-links a {
  color: #6c757d;
  text-decoration: none;
  margin: 0 1px;
}

.footer-links a:hover {
  text-decoration: underline;
}

.footer-copyright {
  line-height: 1.5;
}
</style>
</file>

<file path="frontend/public/config.js">
//本地網址開放測試
window.APP_CONFIG = {
  // 👇 每次 Tunnel 重開，只要將後端Tunnel放進來這一行
  API_URL: 'https://transaction-shell-routines-colored.trycloudflare.com',
}

//第一次 必須在終端機 輸入winget install --id Cloudflare.cloudflared 輸入Y
//Tunnel網址為隨機生成，每次需重新複製
//cloudflared tunnel --url http://localhost:8080
</file>

</files>
