This file is a merged representation of a subset of the codebase, containing specifically included files and files not matching ignore patterns, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Only files matching these patterns are included: frontend/src/**/maintenance/**, frontend/src/**/fix/**, frontend/src/router/**
- Files matching these patterns are excluded: **/*.map, **/*.min.js, **/*.min.css, **/node_modules/**, **/dist/**, **/target/**, **/vendor/**, **/public/vendor/**, **/logs/**, **/*.log, **/*.svg, **/*.png, **/*.jpg, **/*.ico, AI_good/**
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
frontend/src/components/maintenance/MaintenancePageHeader.vue
frontend/src/components/maintenance/ScheduleCalendar.vue
frontend/src/components/maintenance/StatCard.vue
frontend/src/components/maintenance/TicketCharts.vue
frontend/src/components/maintenance/TicketTimeline.vue
frontend/src/composables/maintenance/useCozeChat.js
frontend/src/composables/maintenance/useMaintenanceStaffForm.js
frontend/src/composables/maintenance/usePagination.js
frontend/src/composables/maintenance/useScheduleConfig.js
frontend/src/composables/maintenance/useStaffStatus.js
frontend/src/composables/maintenance/useTicketConfig.js
frontend/src/router/index.js
frontend/src/views/maintenance/MaintenanceStaffForm.vue
frontend/src/views/maintenance/MaintenanceStaffHistory.vue
frontend/src/views/maintenance/MaintenanceStaffList.vue
frontend/src/views/maintenance/MtifForm.vue
frontend/src/views/maintenance/MtifList.vue
frontend/src/views/maintenance/ScheduleForm.vue
frontend/src/views/maintenance/ScheduleList.vue
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="frontend/src/components/maintenance/MaintenancePageHeader.vue">
<script setup>
import { computed } from 'vue'

// å®šç¾©å¤–éƒ¨å‚³å…¥çš„åƒæ•¸
const props = defineProps({
  title: {
    type: String,
    required: true,
  },
  subtitle: {
    type: String,
    default: '',
  },
  // é è¨­åœ–ç¤º
  icon: {
    type: String,
    default: 'fas fa-cube',
  },
  // æ¨¡å¼ï¼š'add' (æ–°å¢-ç¶ è‰²) | 'edit' (ç·¨è¼¯-æ©˜è‰²) | 'view' (æª¢è¦–/åˆ—è¡¨-è—è‰²)
  mode: {
    type: String,
    default: 'view',
  },
})

// æ ¹æ“šæ¨¡å¼æ±ºå®š Icon çš„ CSS class
const iconClass = computed(() => {
  switch (props.mode) {
    case 'add':
      return 'add-mode'
    case 'edit':
      return 'edit-mode'
    default:
      return 'view-mode' // é è¨­è—è‰²
  }
})
</script>

<template>
  <div class="page-title-box">
    <div class="title-icon" :class="iconClass">
      <i :class="icon"></i>
    </div>
    <div class="title-content">
      <h1>{{ title }}</h1>
      <p v-if="subtitle" class="subtitle">
        {{ subtitle }}
      </p>
    </div>
  </div>
</template>

<style scoped>
.page-title-box {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 16px 24px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
}

.title-icon {
  width: 56px;
  height: 56px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  color: white;
  transition: transform 0.3s ease;
}

.title-icon:hover {
  transform: scale(1.1) rotate(5deg);
}

/* é¡è‰²å®šç¾© */
.add-mode {
  background: linear-gradient(135deg, #67c23a 0%, #95d475 100%);
}

.edit-mode {
  background: linear-gradient(135deg, #e6a23c 0%, #f3d19e 100%);
}

.view-mode {
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
}

.title-content h1 {
  margin: 0;
  font-size: 1.5rem;
  font-weight: 600;
  color: #303133;
}

.title-content .subtitle {
  margin: 4px 0 0;
  font-size: 0.875rem;
  color: #909399;
}
</style>
</file>

<file path="frontend/src/components/maintenance/StatCard.vue">
<script setup>
/**
 * çµ±è¨ˆå¡ç‰‡å…ƒä»¶
 * ç”¨æ–¼é¡¯ç¤ºæ•¸æ“šçµ±è¨ˆï¼Œå¯è‡ªè¨‚åœ–ç¤ºã€æ•¸å€¼ã€æ¨™ç±¤å’Œæ¨£å¼
 */
defineProps({
  // åœ–ç¤º class (FontAwesome)
  icon: {
    type: String,
    default: 'fas fa-chart-bar',
  },
  // é¡¯ç¤ºçš„æ•¸å€¼
  value: {
    type: [String, Number],
    required: true,
  },
  // æ¨™ç±¤èªªæ˜
  label: {
    type: String,
    required: true,
  },
  // å¡ç‰‡è®Šé«”æ¨£å¼ï¼š'primary' | 'success' | 'warning' | 'danger' | 'info'
  variant: {
    type: String,
    default: 'primary',
  },
  // æ˜¯å¦å•Ÿç”¨è„ˆè¡å‹•ç•«
  pulse: {
    type: Boolean,
    default: false,
  },
  // æ˜¯å¦å¯é»æ“Š
  clickable: {
    type: Boolean,
    default: false,
  },
  // èƒŒæ™¯è£é£¾åœ–ç¤º (å¯é¸)
  bgIcon: {
    type: String,
    default: '',
  },
})

// é»æ“Šäº‹ä»¶
const emit = defineEmits(['click'])

const handleClick = () => {
  emit('click')
}
</script>

<template>
  <div 
    class="stat-card" 
    :class="[`${variant}-card`, { clickable }]"
    @click="handleClick"
  >
    <div class="stat-icon" :class="{ pulse }">
      <i :class="icon"></i>
    </div>
    <div class="stat-info">
      <h3>{{ value }}</h3>
      <span>{{ label }}</span>
    </div>
    <!-- èƒŒæ™¯è£é£¾åœ–ç¤º -->
    <div v-if="bgIcon" class="stat-bg-icon">
      <i :class="bgIcon"></i>
    </div>
  </div>
</template>

<style scoped>
.stat-card {
  position: relative;
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 18px;
  background: white;
  border-radius: 14px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
  transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  overflow: hidden;
}

.stat-card.clickable {
  cursor: pointer;
}

.stat-card:hover {
  transform: translateY(-6px);
  box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
}

.stat-icon {
  width: 50px;
  height: 50px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  color: white;
  z-index: 1;
  flex-shrink: 0;
}

.stat-icon.pulse {
  animation: pulse 1.5s infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

/* è®Šé«”æ¨£å¼ */
.primary-card .stat-icon {
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
}

.success-card .stat-icon {
  background: linear-gradient(135deg, #67c23a 0%, #95d475 100%);
}

.warning-card .stat-icon {
  background: linear-gradient(135deg, #e6a23c 0%, #f3d19e 100%);
}

.danger-card .stat-icon {
  background: linear-gradient(135deg, #f56c6c 0%, #f89898 100%);
}

.info-card .stat-icon {
  background: linear-gradient(135deg, #909399 0%, #c0c4cc 100%);
}

.stat-info {
  z-index: 1;
  min-width: 0;
}

.stat-info h3 {
  margin: 0;
  font-size: 1.8rem;
  font-weight: 700;
  color: #303133;
  line-height: 1.2;
}

.stat-info span {
  font-size: 0.85rem;
  color: #909399;
  white-space: nowrap;
}

/* èƒŒæ™¯è£é£¾åœ–ç¤º */
.stat-bg-icon {
  position: absolute;
  right: -10px;
  bottom: -10px;
  font-size: 80px;
  color: rgba(0, 0, 0, 0.03);
  z-index: 0;
}
</style>
</file>

<file path="frontend/src/components/maintenance/TicketCharts.vue">
<template>
  <el-row :gutter="20" class="charts-container" v-show="hasData">
    <!-- ç‹€æ…‹åˆ†ä½ˆåœ– -->
    <el-col :md="8" :sm="24">
      <el-card shadow="hover" class="chart-card">
        <template #header>
          <div class="chart-header">
            <span class="chart-icon status-icon">
              <i class="fas fa-chart-pie"></i>
            </span>
            <b>ç‹€æ…‹åˆ†ä½ˆ</b>
          </div>
        </template>
        <div ref="statusChartRef" class="chart-container"></div>
      </el-card>
    </el-col>

    <!-- å„ªå…ˆç´šä½”æ¯”åœ– -->
    <el-col :md="8" :sm="24">
      <el-card shadow="hover" class="chart-card">
        <template #header>
          <div class="chart-header">
            <span class="chart-icon priority-icon">
              <i class="fas fa-flag"></i>
            </span>
            <b>å„ªå…ˆç´šä½”æ¯”</b>
          </div>
        </template>
        <div ref="priorityChartRef" class="chart-container"></div>
      </el-card>
    </el-col>

    <!-- æ•…éšœé¡å‹çµ±è¨ˆåœ– -->
    <el-col :md="8" :sm="24">
      <el-card shadow="hover" class="chart-card">
        <template #header>
          <div class="chart-header">
            <span class="chart-icon type-icon">
              <i class="fas fa-tools"></i>
            </span>
            <b>å‰äº”å¤§æ•…éšœé¡å‹</b>
          </div>
        </template>
        <div ref="typeChartRef" class="chart-container"></div>
      </el-card>
    </el-col>
  </el-row>
</template>

<script setup>
import { ref, computed, watch, onMounted, onBeforeUnmount, nextTick } from 'vue'
import ApexCharts from 'apexcharts'
import { useTicketConfig } from '@/composables/maintenance/useTicketConfig'

const props = defineProps({
  /** å·¥å–®è³‡æ–™é™£åˆ— */
  tickets: {
    type: Array,
    default: () => [],
  },
})

const { statusConfig, priorityConfig } = useTicketConfig()

// --- åœ–è¡¨ DOM åƒç…§ ---
const statusChartRef = ref(null)
const priorityChartRef = ref(null)
const typeChartRef = ref(null)

// --- åœ–è¡¨å¯¦ä¾‹ ---
let statusChart = null
let priorityChart = null
let typeChart = null

// --- æ˜¯å¦æœ‰è³‡æ–™ ---
const hasData = computed(() => props.tickets.length > 0)

// --- è¨ˆç®—åœ–è¡¨æ•¸æ“š ---
const chartData = computed(() => {
  const data = props.tickets

  // ç‹€æ…‹çµ±è¨ˆ
  const statusCount = {}
  data.forEach((t) => {
    statusCount[t.issueStatus] = (statusCount[t.issueStatus] || 0) + 1
  })

  // å„ªå…ˆç´šçµ±è¨ˆ
  const priorityCount = { LOW: 0, NORMAL: 0, HIGH: 0, URGENT: 0 }
  data.forEach((t) => {
    if (priorityCount[t.issuePriority] !== undefined) {
      priorityCount[t.issuePriority]++
    }
  })

  // æ•…éšœé¡å‹çµ±è¨ˆ (å‰5å)
  const typeCount = {}
  data.forEach((t) => {
    typeCount[t.issueType] = (typeCount[t.issueType] || 0) + 1
  })
  const sortedTypes = Object.entries(typeCount)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 5)

  return { statusCount, priorityCount, sortedTypes }
})

// --- åœ–è¡¨é…ç½®å·¥å»  ---
const createStatusChartOptions = (statusCount) => ({
  series: Object.values(statusCount),
  labels: Object.keys(statusCount).map((k) => statusConfig[k]?.text || k),
  chart: {
    type: 'donut',
    height: 280,
    toolbar: { show: false },
    animations: {
      enabled: true,
      easing: 'easeinout',
      speed: 800,
      animateGradually: { enabled: true, delay: 150 },
      dynamicAnimation: { enabled: true, speed: 350 },
    },
  },
  colors: ['#17a2b8', '#007bff', '#ffc107', '#28a745', '#6c757d'],
  dataLabels: { enabled: false },
  legend: { position: 'bottom', fontSize: '13px' },
  plotOptions: {
    pie: {
      donut: {
        size: '65%',
        labels: {
          show: true,
          total: {
            show: true,
            label: 'ç¸½è¨ˆ',
            fontSize: '14px',
            fontWeight: 600,
            color: '#909399',
          },
        },
      },
    },
  },
  stroke: { width: 2, colors: ['#fff'] },
  tooltip: {
    y: { formatter: (val) => `${val} ä»¶` },
  },
})

const createPriorityChartOptions = (priorityCount) => ({
  series: [priorityCount.LOW, priorityCount.NORMAL, priorityCount.HIGH, priorityCount.URGENT],
  labels: [
    `${priorityConfig.LOW.icon} ä½`,
    `${priorityConfig.NORMAL.icon} æ™®é€š`,
    `${priorityConfig.HIGH.icon} é«˜`,
    `${priorityConfig.URGENT.icon} ç·Šæ€¥`,
  ],
  chart: {
    type: 'pie',
    height: 280,
    toolbar: { show: false },
    animations: {
      enabled: true,
      easing: 'easeinout',
      speed: 800,
    },
  },
  colors: ['#909399', '#67c23a', '#e6a23c', '#f56c6c'],
  legend: { position: 'bottom', fontSize: '13px' },
  stroke: { width: 2, colors: ['#fff'] },
  tooltip: {
    y: { formatter: (val) => `${val} ä»¶` },
  },
})

const createTypeChartOptions = (sortedTypes) => ({
  series: [{ name: 'ä»¶æ•¸', data: sortedTypes.map((i) => i[1]) }],
  chart: {
    type: 'bar',
    height: 280,
    toolbar: { show: false },
    animations: {
      enabled: true,
      easing: 'easeinout',
      speed: 800,
    },
  },
  xaxis: {
    categories: sortedTypes.map((i) => i[0]),
    labels: { style: { fontSize: '12px' } },
  },
  plotOptions: {
    bar: {
      borderRadius: 8,
      horizontal: true,
      distributed: true,
      dataLabels: { position: 'center' },
    },
  },
  colors: ['#409eff', '#67c23a', '#e6a23c', '#f56c6c', '#909399'],
  dataLabels: {
    enabled: true,
    formatter: (val) => `${val} ä»¶`,
    style: { fontSize: '12px', colors: ['#fff'] },
  },
  tooltip: {
    y: { formatter: (val) => `${val} ä»¶` },
  },
})

// --- æ¸²æŸ“åœ–è¡¨ ---
const renderCharts = () => {
  if (!hasData.value) return

  if (!statusChartRef.value || !priorityChartRef.value || !typeChartRef.value) return

  const { statusCount, priorityCount, sortedTypes } = chartData.value

  const statusOptions = createStatusChartOptions(statusCount)
  const priorityOptions = createPriorityChartOptions(priorityCount)
  const typeOptions = createTypeChartOptions(sortedTypes)

  // æ›´æ–°æˆ–å»ºç«‹åœ–è¡¨
  if (statusChart) {
    statusChart.updateOptions(statusOptions)
    priorityChart.updateOptions(priorityOptions)
    typeChart.updateOptions(typeOptions)
  } else {
    if (statusChartRef.value) {
      statusChart = new ApexCharts(statusChartRef.value, statusOptions)
      statusChart.render()
    }
    if (priorityChartRef.value) {
      priorityChart = new ApexCharts(priorityChartRef.value, priorityOptions)
      priorityChart.render()
    }
    if (typeChartRef.value) {
      typeChart = new ApexCharts(typeChartRef.value, typeOptions)
      typeChart.render()
    }
  }
}

// --- éŠ·æ¯€åœ–è¡¨ ---
const destroyCharts = () => {
  if (statusChart) {
    statusChart.destroy()
    statusChart = null
  }
  if (priorityChart) {
    priorityChart.destroy()
    priorityChart = null
  }
  if (typeChart) {
    typeChart.destroy()
    typeChart = null
  }
}

// --- ç›£è½è³‡æ–™è®ŠåŒ–é‡æ–°æ¸²æŸ“ ---
watch(
  () => props.tickets,
  () => {
    setTimeout(() => {
      nextTick(() => renderCharts())
    }, 100)
  },
  { deep: true },
)

// --- ç”Ÿå‘½é€±æœŸ ---
onMounted(() => {
  nextTick(() => renderCharts())
})

onBeforeUnmount(() => {
  destroyCharts()
})

// æš´éœ²æ–¹æ³•ä¾›å¤–éƒ¨èª¿ç”¨
defineExpose({
  renderCharts,
  destroyCharts,
})
</script>

<style scoped>
.charts-container {
  margin-bottom: 20px;
}

.chart-card {
  border-radius: 16px;
  overflow: hidden;
  border: none;
  min-height: 360px;
  margin-bottom: 16px;
  transition: all 0.3s ease;
  background: linear-gradient(145deg, #ffffff 0%, #fafbfc 100%);
}

.chart-card:hover {
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
  transform: translateY(-2px);
}

.chart-header {
  display: flex;
  align-items: center;
  gap: 10px;
}

.chart-icon {
  width: 32px;
  height: 32px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 14px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.status-icon {
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
}

.priority-icon {
  background: linear-gradient(135deg, #e6a23c 0%, #f3d19e 100%);
}

.type-icon {
  background: linear-gradient(135deg, #67c23a 0%, #95d475 100%);
}

.chart-container {
  min-height: 280px;
}

/* éŸ¿æ‡‰å¼èª¿æ•´ */
@media (max-width: 768px) {
  .chart-card {
    min-height: 320px;
  }

  .chart-container {
    min-height: 240px;
  }
}
</style>
</file>

<file path="frontend/src/components/maintenance/TicketTimeline.vue">
<template>
  <div class="ticket-timeline-container">
    <div class="timeline-header">
      <h3>
        <i class="fas fa-history"></i>
        å·¥å–®æ­·ç¨‹è¨˜éŒ„
      </h3>
      <el-button size="small" @click="fetchLogs" :loading="loading" circle>
        <i class="fas fa-sync-alt"></i>
      </el-button>
    </div>

    <div v-if="loading" class="loading-skeleton">
      <el-skeleton :rows="5" animated />
    </div>

    <el-empty v-else-if="logs.length === 0" description="å°šç„¡æ­·ç¨‹è¨˜éŒ„" :image-size="120" />

    <el-timeline v-else class="timeline-content">
      <el-timeline-item
        v-for="(log, index) in logs"
        :key="log.logId"
        :color="getActionColor(log.action)"
        :icon="getActionIcon(log.action)"
        :size="log.action === 'URGENT' ? 'large' : 'normal'"
        :class="['timeline-item', `animate-delay-${index % 5}`]"
      >
        <el-card shadow="hover" class="log-card" :class="`action-${log.action.toLowerCase()}`">
          <template #header>
            <div class="card-header">
              <span class="action-badge" :class="`badge-${log.action.toLowerCase()}`">
                {{ getActionLabel(log.action) }}
              </span>
              <span class="timestamp">
                <i class="far fa-clock"></i>
                {{ log.createdAt }}
              </span>
            </div>
          </template>

          <div class="card-body">
            <div class="operator">
              <i class="fas fa-user-circle"></i>
              <strong>{{ log.operator || 'ç³»çµ±' }}</strong>
            </div>
            <div v-if="log.comment" class="comment">
              <i class="fas fa-comment-dots"></i>
              {{ formatLogComment(log.comment) }}
            </div>
          </div>
        </el-card>
      </el-timeline-item>
    </el-timeline>
  </div>
</template>

<script setup>
import { ref, onMounted, watch } from 'vue'
import maintenanceApi from '@/api/modules/maintenance'
import { ElMessage } from 'element-plus'
import {
  getPriorityText,
  getStatusText,
  getResultText,
} from '@/composables/maintenance/useTicketConfig'

// ========== Props ==========
const props = defineProps({
  ticketId: {
    type: Number,
    required: true,
  },
})

// ========== State ==========
const logs = ref([])
const loading = ref(false)

// ========== Methods ==========

const fetchLogs = async () => {
  if (!props.ticketId) return

  loading.value = true
  try {
    const response = await maintenanceApi.getTicketLogs(props.ticketId)
    logs.value = response.data
  } catch (error) {
    console.error('å–å¾—æ­·ç¨‹è¨˜éŒ„å¤±æ•—:', error)
    ElMessage.error('è¼‰å…¥æ­·ç¨‹è¨˜éŒ„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦')
  } finally {
    loading.value = false
  }
}

/**
 * æ ¹æ“š action æ±ºå®šé¡è‰² (â˜… åŒ…å« TRANSFERRED)
 */
const getActionColor = (action) => {
  const colorMap = {
    CREATED: '#409EFF', // è—
    ASSIGNED: '#909399', // ç°
    TRANSFERRED: '#8E44AD', // â˜… ç´«è‰² (ç§»è½‰)
    STARTED: '#E6A23C', // æ©˜
    RESOLVED: '#67C23A', // ç¶ 
    CANCELLED: '#F56C6C', // ç´…
    URGENT: '#FF6600', // æ·±æ©˜ (ç·Šæ€¥)
  }
  return colorMap[action] || '#409EFF'
}

/**
 * æ ¹æ“š action æ±ºå®šåœ–ç¤º
 */
const getActionIcon = (action) => {
  const iconMap = {
    CREATED: 'Plus',
    ASSIGNED: 'User',
    TRANSFERRED: 'Refresh', // â˜… ç§»è½‰åœ–ç¤º
    STARTED: 'Tools',
    RESOLVED: 'CircleCheck',
    CANCELLED: 'CircleClose',
    URGENT: 'Warning',
  }
  return iconMap[action] || 'DocumentCopy'
}

/**
 * æ ¹æ“š action é¡¯ç¤ºä¸­æ–‡æ¨™ç±¤
 */
const getActionLabel = (action) => {
  const labelMap = {
    CREATED: 'å»ºç«‹å·¥å–®',
    ASSIGNED: 'æŒ‡æ´¾äººå“¡',
    TRANSFERRED: 'å·¥å–®ç§»è½‰', // â˜… ç§»è½‰æ–‡å­—
    STARTED: 'é–‹å§‹ç¶­ä¿®',
    RESOLVED: 'ç¶­ä¿®å®Œæˆ',
    CANCELLED: 'å–æ¶ˆå·¥å–®',
    URGENT: 'ç·Šæ€¥æ¨™è¨˜',
  }
  return labelMap[action] || action
}

const formatLogComment = (comment) => {
  if (!comment) return '-'
  let formatted = comment
  formatted = formatted.replace(
    /å„ªå…ˆæ¬Š:\s*([A-Z_]+)/g,
    (match, code) => `å„ªå…ˆæ¬Š: ${getPriorityText(code)}`,
  )
  formatted = formatted.replace(
    /ç‹€æ…‹:\s*([A-Z_]+)/g,
    (match, code) => `ç‹€æ…‹: ${getStatusText(code)}`,
  )
  formatted = formatted.replace(
    /çµæœ:\s*([A-Z_]+)/g,
    (match, code) => `çµæœ: ${getResultText(code)}`,
  )
  return formatted
}

defineExpose({ fetchLogs })

onMounted(() => {
  fetchLogs()
})

watch(
  () => props.ticketId,
  () => {
    fetchLogs()
  },
)
</script>

<style scoped>
/* ========== å®¹å™¨åŸºç¤æ¨£å¼ ========== */
.ticket-timeline-container {
  padding: 20px;
  background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
  border-radius: 12px;
  min-height: 400px;
}

.timeline-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 2px solid #dcdfe6;
}

.timeline-header h3 {
  margin: 0;
  font-size: 20px;
  color: #303133;
  font-weight: 600;
}

.timeline-header h3 i {
  margin-right: 8px;
  color: #409eff;
}

.loading-skeleton {
  padding: 20px;
}
.timeline-content {
  padding: 10px 0;
}

/* ========== å¡ç‰‡æ¨£å¼ ========== */
.log-card {
  border-radius: 10px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  border-left: 4px solid transparent;
}

.log-card:hover {
  transform: translateY(-4px) scale(1.02);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12) !important;
}

/* æ ¹æ“š action é¡å‹é¡¯ç¤ºä¸åŒå·¦å´é‚Šæ¡†é¡è‰² */
.log-card.action-created {
  border-left-color: #409eff;
}
.log-card.action-assigned {
  border-left-color: #909399;
}
.log-card.action-transferred {
  border-left-color: #8e44ad;
} /* â˜… ç´«è‰² */
.log-card.action-started {
  border-left-color: #e6a23c;
}
.log-card.action-resolved {
  border-left-color: #67c23a;
}
.log-card.action-cancelled {
  border-left-color: #f56c6c;
}
.log-card.action-urgent {
  border-left-color: #ff6600;
  animation: pulseGlow 2s ease-in-out infinite;
}

/* å¡ç‰‡é ­éƒ¨ */
.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.action-badge {
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 600;
  color: white;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* Badge é¡è‰² */
.badge-created {
  background: linear-gradient(135deg, #409eff, #66b1ff);
}
.badge-assigned {
  background: linear-gradient(135deg, #909399, #b3b8bd);
}
.badge-transferred {
  background: linear-gradient(135deg, #8e44ad, #9b59b6);
} /* â˜… ç´«è‰² */
.badge-started {
  background: linear-gradient(135deg, #e6a23c, #f0bc65);
}
.badge-resolved {
  background: linear-gradient(135deg, #67c23a, #85ce61);
}
.badge-cancelled {
  background: linear-gradient(135deg, #f56c6c, #f89898);
}
.badge-urgent {
  background: linear-gradient(135deg, #ff6600, #ff9933);
  animation: badgePulse 1.5s ease-in-out infinite;
}

.timestamp {
  font-size: 13px;
  color: #909399;
  font-weight: 500;
}
.timestamp i {
  margin-right: 4px;
}

/* å¡ç‰‡å…§å®¹ */
.card-body {
  padding: 12px 0;
}

.operator {
  display: flex;
  align-items: center;
  font-size: 15px;
  color: #303133;
  margin-bottom: 8px;
}
.operator i {
  margin-right: 8px;
  color: #409eff;
  font-size: 18px;
}

.comment {
  margin-top: 10px;
  padding: 10px;
  background: #f4f4f5;
  border-radius: 6px;
  font-size: 14px;
  color: #606266;
  line-height: 1.6;
  display: flex;
  align-items: flex-start;
}
.comment i {
  margin-right: 8px;
  margin-top: 2px;
  color: #909399;
  flex-shrink: 0;
}

/* ========== å‹•ç•«æ•ˆæœ ========== */
@keyframes bounceInRight {
  0% {
    opacity: 0;
    transform: translateX(100px) scale(0.9);
  }
  60% {
    opacity: 1;
    transform: translateX(-10px) scale(1.02);
  }
  80% {
    transform: translateX(5px);
  }
  100% {
    transform: translateX(0) scale(1);
  }
}

.timeline-item {
  animation: bounceInRight 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55) both;
}

.animate-delay-0 {
  animation-delay: 0s;
}
.animate-delay-1 {
  animation-delay: 0.1s;
}
.animate-delay-2 {
  animation-delay: 0.2s;
}
.animate-delay-3 {
  animation-delay: 0.3s;
}
.animate-delay-4 {
  animation-delay: 0.4s;
}

@keyframes pulseGlow {
  0%,
  100% {
    box-shadow: 0 0 5px rgba(255, 102, 0, 0.3);
  }
  50% {
    box-shadow:
      0 0 20px rgba(255, 102, 0, 0.6),
      0 0 30px rgba(255, 102, 0, 0.4);
  }
}

@keyframes badgePulse {
  0%,
  100% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.05);
  }
}

@media (max-width: 768px) {
  .timeline-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
  }
  .card-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }
  .log-card:hover {
    transform: translateY(-2px) scale(1.01);
  }
}
</style>
</file>

<file path="frontend/src/composables/maintenance/useMaintenanceStaffForm.js">
import { ref, reactive, computed, unref } from 'vue'
import Swal from 'sweetalert2'

export function useMaintenanceStaffForm({ staffId, router, maintenanceApi }) {
  // 1. å„ªåŒ–ç·¨è¼¯æ¨¡å¼åˆ¤æ–·ï¼šç¢ºä¿å®ƒæ˜¯æ•¸å­—ä¸”å¤§æ–¼ 0
  const isEdit = computed(() => {
    const id = unref(staffId) // ä»¥é˜²è¬ä¸€å‚³å…¥çš„æ˜¯ ref
    return !isNaN(id) && id > 0
  })

  const formRef = ref(null)
  const loading = ref(false)
  const submitting = ref(false)
  const formVisible = ref(false)

  const form = reactive({
    staffName: '',
    staffCompany: '',
    staffPhone: '',
    staffEmail: '',
    staffNote: '',
    isActive: true,
  })

  const rules = {
    staffName: [{ required: true, message: 'è«‹è¼¸å…¥å§“å', trigger: 'blur' }],
    staffEmail: [{ type: 'email', message: 'Email æ ¼å¼ä¸æ­£ç¢º', trigger: 'blur' }],
  }

  const init = async () => {
    console.log('Init called. isEdit:', isEdit.value) // é™¤éŒ¯ Log

    // è§¸ç™¼é€²å ´å‹•ç•«
    setTimeout(() => {
      formVisible.value = true
      console.log('Form Visible set to true') // é™¤éŒ¯ Log
    }, 100)

    if (!isEdit.value) {
      console.log('Create Mode - Stopping init')
      return
    }

    loading.value = true
    try {
      // é€™è£¡åŸæœ¬ç›´æ¥ç”¨ staffIdï¼Œå»ºè­°ç¢ºä¿å®ƒæ˜¯æ•¸å€¼
      const res = await maintenanceApi.getStaffById(staffId)
      Object.assign(form, res.data)
    } catch (error) {
      console.error('Fetch Error:', error) // æ•æ‰éŒ¯èª¤
      router.push('/admin/staff-list')
    } finally {
      loading.value = false
    }
  }

  const submitForm = async () => {
    if (!formRef.value) return

    await formRef.value.validate(async (valid) => {
      if (!valid) {
        await Swal.fire({
          icon: 'warning',
          title: 'è¡¨å–®é©—è­‰å¤±æ•—',
          text: 'è«‹æª¢æŸ¥å¿…å¡«æ¬„ä½èˆ‡æ ¼å¼',
          confirmButtonText: 'ç¢ºèª',
          showClass: { popup: 'animate__animated animate__shakeX' },
        })
        return
      }

      // ç¢ºèªå½ˆçª—
      const confirmResult = await Swal.fire({
        title: isEdit.value ? 'ç¢ºèªæ›´æ–°ï¼Ÿ' : 'ç¢ºèªæ–°å¢ï¼Ÿ',
        text: isEdit.value ? 'å³å°‡æ›´æ–°æ­¤äººå“¡è³‡æ–™' : 'å³å°‡æ–°å¢ç¶­è­·äººå“¡',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#409eff',
        cancelButtonColor: '#909399',
        confirmButtonText: 'ç¢ºèªé€å‡º',
        cancelButtonText: 'å–æ¶ˆ',
        showClass: { popup: 'animate__animated animate__fadeInDown animate__faster' },
        hideClass: { popup: 'animate__animated animate__fadeOutUp animate__faster' },
      })

      if (!confirmResult.isConfirmed) return

      submitting.value = true
      try {
        if (isEdit.value) {
          await maintenanceApi.updateStaff(staffId, form)
          await Swal.fire({
            icon: 'success',
            title: 'æ›´æ–°æˆåŠŸï¼',
            html: `<span class="text-success">äººå“¡ <b>${form.staffName}</b> è³‡æ–™å·²æ›´æ–°</span>`,
            timer: 2000,
            timerProgressBar: true,
            showConfirmButton: false,
            showClass: { popup: 'animate__animated animate__bounceIn' },
          })
        } else {
          await maintenanceApi.createStaff(form)
          await Swal.fire({
            icon: 'success',
            title: 'æ–°å¢æˆåŠŸï¼',
            html: `<span class="text-success">åŠ å…¥æ–°æˆå“¡ <b>${form.staffName}</b> åŠ å…¥åœ˜éšŠ</span>`,
            timer: 2000,
            timerProgressBar: true,
            showConfirmButton: false,
            showClass: { popup: 'animate__animated animate__tada' },
          })
        }

        router.push('/admin/staff-list')
      } catch {
        // éŒ¯èª¤å·²ç”± http.js æ””æˆªå™¨è™•ç†
      } finally {
        submitting.value = false
      }
    })
  }

  const handleCancel = async () => {
    // ä¿æŒä½ åŸæœ¬çš„ã€Œåˆ¤æ–·æœ‰ç„¡å¡«å¯«ã€æ¢ä»¶
    if (form.staffName || form.staffCompany || form.staffPhone) {
      const result = await Swal.fire({
        title: 'ç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ',
        text: 'æ‚¨å¡«å¯«çš„è³‡æ–™å°‡ä¸æœƒè¢«ä¿å­˜',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#e6a23c',
        cancelButtonColor: '#909399',
        confirmButtonText: 'é›¢é–‹',
        cancelButtonText: 'ç¹¼çºŒç·¨è¼¯',
        showClass: { popup: 'animate__animated animate__fadeIn animate__faster' },
      })
      if (!result.isConfirmed) return
    }
    router.push('/admin/staff-list')
  }

  return {
    // state
    isEdit,
    formRef,
    loading,
    submitting,
    formVisible,
    form,
    rules,

    // actions
    init,
    submitForm,
    handleCancel,
  }
}
</file>

<file path="frontend/src/composables/maintenance/usePagination.js">
/**
 * åˆ†é  Composable
 * æä¾›å‰ç«¯åˆ†é é‚è¼¯ï¼Œå¯åœ¨å¤šå€‹åˆ—è¡¨é é¢å…±ç”¨
 */
import { ref, computed, watch } from 'vue'

/**
 * å»ºç«‹åˆ†é åŠŸèƒ½
 * @param {Ref} sourceList - åŸå§‹è³‡æ–™åˆ—è¡¨ (ref)
 * @param {Object} options - é…ç½®é¸é …
 * @param {number} options.defaultPageSize - é è¨­æ¯é ç­†æ•¸ï¼Œé è¨­ 10
 * @param {Ref} options.searchText - æœå°‹æ–‡å­— (ç•¶è®Šæ›´æ™‚é‡ç½®é ç¢¼)
 * @returns {Object} åˆ†é ç›¸é—œçš„éŸ¿æ‡‰å¼è³‡æ–™å’Œæ–¹æ³•
 */
export function usePagination(sourceList, options = {}) {
  const { defaultPageSize = 10, searchText = null } = options

  // éŸ¿æ‡‰å¼ç‹€æ…‹
  const currentPage = ref(1)
  const pageSize = ref(defaultPageSize)

  // è¨ˆç®—ç¸½é æ•¸
  const totalPages = computed(() => {
    return Math.ceil(sourceList.value.length / pageSize.value)
  })

  // è¨ˆç®—åˆ†é å¾Œçš„åˆ—è¡¨
  const paginatedList = computed(() => {
    const start = (currentPage.value - 1) * pageSize.value
    const end = start + pageSize.value
    return sourceList.value.slice(start, end)
  })

  // è¨ˆç®—ç¸½ç­†æ•¸
  const total = computed(() => sourceList.value.length)

  // æ˜¯å¦æœ‰è³‡æ–™
  const hasData = computed(() => sourceList.value.length > 0)

  // æ˜¯å¦éœ€è¦é¡¯ç¤ºåˆ†é å™¨
  const showPagination = computed(() => sourceList.value.length > pageSize.value)

  // ç•¶æœå°‹æ–‡å­—è®Šæ›´æ™‚ï¼Œé‡ç½®åˆ°ç¬¬ä¸€é 
  if (searchText) {
    watch(searchText, () => {
      currentPage.value = 1
    })
  }

  // ç•¶åŸå§‹åˆ—è¡¨è®Šæ›´æ™‚ï¼Œç¢ºä¿ç•¶å‰é ç¢¼æœ‰æ•ˆ
  watch(sourceList, () => {
    if (currentPage.value > totalPages.value && totalPages.value > 0) {
      currentPage.value = totalPages.value
    }
  })

  // â˜… ä¿®å¾©ï¼šç•¶ pageSize è®Šæ›´æ™‚ï¼Œå¼·åˆ¶å›åˆ°ç¬¬ä¸€é 
  watch(pageSize, () => {
    currentPage.value = 1
  })

  // è·³è½‰åˆ°æŒ‡å®šé 
  const goToPage = (page) => {
    if (page >= 1 && page <= totalPages.value) {
      currentPage.value = page
    }
  }

  // ä¸Šä¸€é 
  const prevPage = () => {
    if (currentPage.value > 1) {
      currentPage.value--
    }
  }

  // ä¸‹ä¸€é 
  const nextPage = () => {
    if (currentPage.value < totalPages.value) {
      currentPage.value++
    }
  }

  // é‡ç½®åˆ†é 
  const resetPagination = () => {
    currentPage.value = 1
  }

  return {
    // éŸ¿æ‡‰å¼ç‹€æ…‹
    currentPage,
    pageSize,
    totalPages,
    total,

    // è¨ˆç®—å±¬æ€§
    paginatedList,
    hasData,
    showPagination,

    // æ–¹æ³•
    goToPage,
    prevPage,
    nextPage,
    resetPagination,
  }
}

export default usePagination
</file>

<file path="frontend/src/composables/maintenance/useScheduleConfig.js">
/**
 * æ’ç¨‹é…ç½® Composable
 * é›†ä¸­ç®¡ç†æ’ç¨‹ç›¸é—œçš„é…ç½®èˆ‡æ ¼å¼åŒ–æ–¹æ³•
 */
import { computed } from 'vue'

export function useScheduleConfig() {
  // ====== æ’ç¨‹é¡å‹é…ç½® ======
  const scheduleTypeConfig = {
    DAILY: {
      text: 'æ¯æ—¥',
      icon: 'fas fa-sun',
      color: '#67c23a',
      tagType: 'success',
      bgColor: 'rgba(103, 194, 58, 0.1)',
    },
    WEEKLY: {
      text: 'æ¯é€±',
      icon: 'fas fa-calendar-week',
      color: '#409eff',
      tagType: '',
      bgColor: 'rgba(64, 158, 255, 0.1)',
    },
    MONTHLY: {
      text: 'æ¯æœˆ',
      icon: 'fas fa-calendar-alt',
      color: '#e6a23c',
      tagType: 'warning',
      bgColor: 'rgba(230, 162, 60, 0.1)',
    },
  }

  // ====== æ˜ŸæœŸé…ç½® ======
  const dayOfWeekConfig = {
    1: { text: 'é€±ä¸€', short: 'ä¸€', color: '#409eff' },
    2: { text: 'é€±äºŒ', short: 'äºŒ', color: '#67c23a' },
    3: { text: 'é€±ä¸‰', short: 'ä¸‰', color: '#e6a23c' },
    4: { text: 'é€±å››', short: 'å››', color: '#f56c6c' },
    5: { text: 'é€±äº”', short: 'äº”', color: '#909399' },
    6: { text: 'é€±å…­', short: 'å…­', color: '#b88230' },
    7: { text: 'é€±æ—¥', short: 'æ—¥', color: '#f56c6c' },
  }

  // ====== å„ªå…ˆç´šé…ç½® ======
  const priorityConfig = {
    LOW: { text: 'ä½', color: '#909399', tagType: 'info' },
    NORMAL: { text: 'ä¸€èˆ¬', color: '#409eff', tagType: '' },
    HIGH: { text: 'é«˜', color: '#e6a23c', tagType: 'warning' },
    URGENT: { text: 'ç·Šæ€¥', color: '#f56c6c', tagType: 'danger' },
  }

  // ====== æ ¼å¼åŒ–æ–¹æ³• ======
  const formatDateTime = (dateStr) => {
    if (!dateStr) return '-'
    const d = new Date(dateStr)
    const pad = (n) => String(n).padStart(2, '0')
    return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`
  }

  const formatDate = (dateStr) => {
    if (!dateStr) return '-'
    const d = new Date(dateStr)
    const pad = (n) => String(n).padStart(2, '0')
    return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`
  }

  const formatTime = (timeStr) => {
    if (!timeStr) return '-'
    return timeStr.substring(0, 5)
  }

  const formatScheduleDetail = (schedule) => {
    const time = formatTime(schedule.executeTime)
    switch (schedule.scheduleType) {
      case 'DAILY':
        return `æ¯å¤© ${time}`
      case 'WEEKLY':
        return `æ¯${dayOfWeekConfig[schedule.dayOfWeek]?.text || '?'} ${time}`
      case 'MONTHLY':
        return `æ¯æœˆ ${schedule.dayOfMonth} è™Ÿ ${time}`
      default:
        return '-'
    }
  }

  // ====== è¨ˆç®—ä¸‹æ¬¡åŸ·è¡Œçš„ç›¸å°æ™‚é–“ ======
  const getRelativeTime = (dateStr) => {
    if (!dateStr) return { text: '-', isOverdue: false }
    const now = new Date()
    const target = new Date(dateStr)
    const diff = target - now

    if (diff < 0) {
      return { text: 'å·²éæœŸ', isOverdue: true }
    }

    const minutes = Math.floor(diff / 60000)
    const hours = Math.floor(minutes / 60)
    const days = Math.floor(hours / 24)

    if (days > 0) {
      return { text: `${days} å¤©å¾Œ`, isOverdue: false }
    } else if (hours > 0) {
      return { text: `${hours} å°æ™‚å¾Œ`, isOverdue: false }
    } else {
      return { text: `${minutes} åˆ†é˜å¾Œ`, isOverdue: false, isSoon: minutes < 30 }
    }
  }

  // ====== å–å¾—æ’ç¨‹çš„æ¨™ç±¤æ¨£å¼ ======
  const getScheduleTypeTag = (type) => scheduleTypeConfig[type] || scheduleTypeConfig.DAILY
  const getPriorityTag = (priority) => priorityConfig[priority] || priorityConfig.NORMAL

  return {
    scheduleTypeConfig,
    dayOfWeekConfig,
    priorityConfig,
    formatDateTime,
    formatDate,
    formatTime,
    formatScheduleDetail,
    getRelativeTime,
    getScheduleTypeTag,
    getPriorityTag,
  }
}
</file>

<file path="frontend/src/components/maintenance/ScheduleCalendar.vue">
<script setup>
import { ref, computed } from 'vue'
import { useScheduleConfig } from '@/composables/maintenance/useScheduleConfig'

const props = defineProps({
  schedules: { type: Array, default: () => [] },
})

const emit = defineEmits(['select-date', 'click-schedule'])
const { scheduleTypeConfig, formatTime } = useScheduleConfig()

const calendarValue = ref(new Date())

// ====== ä¸­æ–‡æ—¥æ›† Headerï¼ˆå–ä»£ el-calendar é è¨­è‹±æ–‡ï¼‰ ======
const weekDaysZh = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­']
const monthNameZh = (date) => `${date.getFullYear()} å¹´ ${date.getMonth() + 1} æœˆ`
const currentMonthText = computed(() => monthNameZh(calendarValue.value))

const goPrevMonth = () => {
  const d = new Date(calendarValue.value)
  d.setMonth(d.getMonth() - 1)
  calendarValue.value = d
}
const goNextMonth = () => {
  const d = new Date(calendarValue.value)
  d.setMonth(d.getMonth() + 1)
  calendarValue.value = d
}
const goToday = () => {
  calendarValue.value = new Date()
}

// æ ¼å¼åŒ–æ—¥æœŸç‚º key
const formatDateKey = (date) => {
  const d = new Date(date)
  return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`
}

// å–å¾—æŸæ—¥æœŸçš„æ’ç¨‹
const getSchedulesForDate = (date) => {
  const dateStr = formatDateKey(date)
  return props.schedules.filter((s) => {
    if (!s.isActive) return false
    const nextDate = formatDateKey(new Date(s.nextExecuteAt))
    return nextDate === dateStr
  })
}

const handleDateClick = (date) => emit('select-date', date)
const handleScheduleClick = (schedule) => emit('click-schedule', schedule)
</script>

<template>
  <div class="schedule-calendar">
    <!-- âœ… è‡ªè¨‚ä¸­æ–‡ Header -->
    <div class="calendar-header-zh">
      <div class="title">{{ currentMonthText }}</div>
      <div class="actions">
        <el-button size="small" @click="goPrevMonth">ä¸Šå€‹æœˆ</el-button>
        <el-button size="small" @click="goToday">ä»Šå¤©</el-button>
        <el-button size="small" @click="goNextMonth">ä¸‹å€‹æœˆ</el-button>
      </div>
    </div>

    <!-- âœ… ä¸­æ–‡æ˜ŸæœŸåˆ— -->
    <div class="week-header-zh">
      <div v-for="d in weekDaysZh" :key="d" class="week-day">{{ d }}</div>
    </div>

    <el-calendar v-model="calendarValue" class="calendar-body">
      <template #date-cell="{ data }">
        <div
          class="calendar-cell"
          :class="{ 'has-schedule': getSchedulesForDate(data.date).length > 0 }"
          @click="handleDateClick(data.date)"
        >
          <div class="date-number">
            {{ data.date.getDate() }}
          </div>

          <!-- æ’ç¨‹æ¨™è¨˜ -->
          <div class="schedule-dots" v-if="getSchedulesForDate(data.date).length > 0">
            <template
              v-for="schedule in getSchedulesForDate(data.date).slice(0, 3)"
              :key="schedule.scheduleId"
            >
              <el-tooltip
                :content="`${schedule.title} - ${formatTime(schedule.executeTime)}`"
                placement="top"
              >
                <div
                  class="schedule-dot"
                  :style="{ backgroundColor: scheduleTypeConfig[schedule.scheduleType]?.color }"
                  @click.stop="handleScheduleClick(schedule)"
                ></div>
              </el-tooltip>
            </template>

            <span v-if="getSchedulesForDate(data.date).length > 3" class="more-count">
              +{{ getSchedulesForDate(data.date).length - 3 }}
            </span>
          </div>
        </div>
      </template>
    </el-calendar>

    <!-- åœ–ä¾‹ -->
    <div class="calendar-legend">
      <span v-for="(config, key) in scheduleTypeConfig" :key="key" class="legend-item">
        <span class="legend-dot" :style="{ backgroundColor: config.color }"></span>
        {{ config.text }}
      </span>
    </div>
  </div>
</template>

<style scoped>
.schedule-calendar {
  border-radius: 12px;
  overflow: hidden;
  background: #fff;
}

/* âœ… ä¸­æ–‡ header */
.calendar-header-zh {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  border-bottom: 1px solid #ebeef5;
}
.calendar-header-zh .title {
  font-size: 16px;
  font-weight: 700;
  color: #303133;
}
.calendar-header-zh .actions {
  display: flex;
  gap: 8px;
}

/* âœ… ä¸­æ–‡æ˜ŸæœŸåˆ— */
.week-header-zh {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  padding: 8px 10px;
  background: #f5f7fa;
  border-bottom: 1px solid #ebeef5;
}
.week-day {
  text-align: center;
  font-size: 12px;
  font-weight: 600;
  color: #606266;
}

/* cell */
.calendar-cell {
  height: 100%;
  padding: 4px;
  cursor: pointer;
  transition: all 0.2s;
  border-radius: 6px;
}
.calendar-cell:hover {
  background: rgba(64, 158, 255, 0.1);
}
.calendar-cell.has-schedule {
  background: rgba(64, 158, 255, 0.05);
}

.date-number {
  font-size: 14px;
  font-weight: 600;
  text-align: center;
  margin-bottom: 4px;
}

.schedule-dots {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 3px;
  flex-wrap: wrap;
}

.schedule-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  cursor: pointer;
  transition: transform 0.2s;
}
.schedule-dot:hover {
  transform: scale(1.3);
}

.more-count {
  font-size: 10px;
  color: #909399;
}

.calendar-legend {
  display: flex;
  justify-content: center;
  gap: 20px;
  padding: 12px;
  background: #f5f7fa;
  border-top: 1px solid #ebeef5;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  color: #606266;
}
.legend-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
}

/* âœ… é—œéµï¼šæŠŠ el-calendar åŸæœ¬è‹±æ–‡ header + è‹±æ–‡æ˜ŸæœŸåˆ—éš±è— */
:deep(.el-calendar__header) {
  display: none !important;
}
:deep(.el-calendar-table thead) {
  display: none !important;
}

/* day cell height */
:deep(.el-calendar-table .el-calendar-day) {
  height: 70px;
  padding: 0;
}
</style>
</file>

<file path="frontend/src/composables/maintenance/useStaffStatus.js">
/**
 * ç¶­è­·äººå“¡ç‹€æ…‹è¨ˆç®—é‚è¼¯ (çµ±ä¸€ä½¿ç”¨ï¼Œé¿å…é‡è¤‡å¯¦ä½œ)
 * 
 * ç”¨é€”ï¼š
 * - æ ¹æ“š maintenanceInformation (tickets) å‹•æ…‹è¨ˆç®—äººå“¡å³æ™‚ç‹€æ…‹
 * - æä¾›çµ±ä¸€çš„ç‹€æ…‹åˆ¤æ–·é‚è¼¯çµ¦ï¼šçµ±è¨ˆå¡ã€äººå“¡åˆ—è¡¨ã€äººå“¡è©³æƒ…å½ˆçª—
 * 
 * ä¿®æ”¹åŸå› ï¼š
 * - åŸæœ¬äººå“¡ç‹€æ…‹æ˜¯éœæ…‹æ¬„ä½ï¼Œæ²’æœ‰æ ¹æ“šå·¥å–®å‹•æ…‹è¨ˆç®—
 * - å°è‡´ã€Œç¶­ä¿®ä¸­ã€ã€ã€Œå·²æŒ‡æ´¾ã€çµ±è¨ˆä¸æº–ç¢º
 * - äººå“¡åˆ—è¡¨ badge èˆ‡å¯¦éš›å·¥å–®ç‹€æ…‹ä¸ä¸€è‡´
 */

/**
 * åˆ¤æ–·å·¥å–®ç‹€æ…‹æ˜¯å¦ç‚ºå·²å®Œæˆ (RESOLVED / CANCELLED)
 * @param {string} status - å·¥å–®ç‹€æ…‹
 * @returns {boolean}
 */
export function isCompletedStatus(status) {
  return status === 'RESOLVED' || status === 'CANCELLED'
}

/**
 * åˆ¤æ–·æ˜¯å¦ç‚ºä¿é¤Šä»»å‹™ (æ ¹æ“šå•é¡Œé¡å‹æˆ–æè¿°é—œéµå­—)
 * @param {string} issueType - å•é¡Œé¡å‹
 * @param {string} issueDesc - å•é¡Œæè¿°
 * @returns {boolean}
 */
export function isMaintenanceTask(issueType, issueDesc) {
  const type = String(issueType || '').trim()
  const desc = String(issueDesc || '').trim()

  if (!type && !desc) return false

  // ä¿é¤Šç›¸é—œé—œéµå­— (æ¶µè“‹æ’ç¨‹è¡¨å–®çš„ issueTypeOptions)
  const keywords = ['ä¿é¤Š', 'ç¶­è­·', 'ä¾‹è¡Œ', 'æª¢æŸ¥', 'æ¸…æ½”', 'æ ¡æ­£', 'å®‰å…¨', 'è€—æ', 'æ›´æ›']

  // æ’ç¨‹è‡ªå‹•ç”¢ç”Ÿçš„ä¿é¤Šä»»å‹™æ¨™è¨˜
  const scheduleMarker = 'ã€æ’ç¨‹è‡ªå‹•ä¿é¤Šã€‘'

  return keywords.some((k) => type.includes(k) || desc.includes(k)) || desc.includes(scheduleMarker)
}

/**
 * è¨ˆç®—äººå“¡å³æ™‚ç‹€æ…‹ (æ ¹æ“šå·¥å–®å‹•æ…‹åˆ¤æ–·)
 * 
 * åˆ¤æ–·å„ªå…ˆç´š (åš´æ ¼éµå®ˆ)ï¼š
 * 1. æœ‰ UNDER_MAINTENANCE â†’ ç¶­ä¿®ä¸­
 * 2. ç„¡ä¸Šè€…ä½†æœ‰ ASSIGNED â†’ å·²æŒ‡æ´¾  
 * 3. å…¶é¤˜ â†’ é–’ç½®ä¸­
 * 
 * @param {number} staffId - äººå“¡ ID
 * @param {Array} tickets - æ‰€æœ‰å·¥å–®åˆ—è¡¨ (maintenanceInformation)
 * @returns {Object} ç‹€æ…‹ç‰©ä»¶ { key, text, tagType, icon }
 */
export function computeStaffStatus(staffId, tickets) {
  // ç¯©é¸æ­¤äººå“¡çš„å·¥å–® (æ’é™¤å·²å®Œæˆçš„)
  const staffTickets = tickets.filter(
    (t) => t.assignedStaffId === staffId && !isCompletedStatus(t.issueStatus)
  )

  // åˆ¤æ–· 1: æœ‰æ­£åœ¨ç¶­ä¿®ä¸­çš„å·¥å–®
  const hasUnderMaintenance = staffTickets.some((t) => t.issueStatus === 'UNDER_MAINTENANCE')
  if (hasUnderMaintenance) {
    return {
      key: 'UNDER_MAINTENANCE',
      text: 'ç¶­ä¿®ä¸­',
      tagType: 'warning',
      icon: 'fas fa-wrench'
    }
  }

  // åˆ¤æ–· 2: æœ‰å·²æŒ‡æ´¾ä½†å°šæœªé–‹å§‹çš„å·¥å–®
  const hasAssigned = staffTickets.some((t) => t.issueStatus === 'ASSIGNED')
  if (hasAssigned) {
    return {
      key: 'ASSIGNED',
      text: 'å·²æŒ‡æ´¾',
      tagType: 'primary',
      icon: 'fas fa-user-check'
    }
  }

  // åˆ¤æ–· 3: é–’ç½®ä¸­ (ç„¡æœªå®Œæˆå·¥å–®)
  return {
    key: 'IDLE',
    text: 'é–’ç½®ä¸­',
    tagType: 'success',
    icon: 'fas fa-mug-hot'
  }
}

/**
 * è¨ˆç®—äººå“¡ä»»å‹™çµ±è¨ˆ (å€åˆ†ç¶­ä¿®/ä¿é¤Šã€æœªå®Œæˆ/å·²å®Œæˆ)
 * 
 * @param {number} staffId - äººå“¡ ID
 * @param {Array} tickets - æ‰€æœ‰å·¥å–®åˆ—è¡¨
 * @returns {Object} çµ±è¨ˆç‰©ä»¶
 *   {
 *     repairCurrent: ç¶­ä¿®ä¸­æ•¸é‡,
 *     maintainCurrent: ä¿é¤Šä¸­æ•¸é‡,
 *     repairAssigned: å¾…ä¿®æ•¸é‡,
 *     maintainAssigned: å¾…ä¿é¤Šæ•¸é‡,
 *     repairDone: ç¶­ä¿®å®Œæˆæ•¸é‡,
 *     maintainDone: ä¿é¤Šå®Œæˆæ•¸é‡
 *   }
 */
export function computeStaffTaskStats(staffId, tickets) {
  const stats = {
    repairCurrent: 0,
    maintainCurrent: 0,
    repairAssigned: 0,
    maintainAssigned: 0,
    repairDone: 0,
    maintainDone: 0
  }

  // ç¯©é¸æ­¤äººå“¡çš„æ‰€æœ‰å·¥å–®
  const staffTickets = tickets.filter((t) => t.assignedStaffId === staffId)

  staffTickets.forEach((t) => {
    const maintenance = isMaintenanceTask(t.issueType, t.issueDesc)
    const status = t.issueStatus
    const done = isCompletedStatus(status)
    const assigned = status === 'ASSIGNED'
    const inProgress = status === 'UNDER_MAINTENANCE'

    if (maintenance) {
      if (inProgress) stats.maintainCurrent++
      else if (assigned) stats.maintainAssigned++
      else if (done) stats.maintainDone++
    } else {
      if (inProgress) stats.repairCurrent++
      else if (assigned) stats.repairAssigned++
      else if (done) stats.repairDone++
    }
  })

  return stats
}

/**
 * è¨ˆç®—æ•´é«”äººå“¡ç‹€æ…‹çµ±è¨ˆ (ç”¨æ–¼çµ±è¨ˆå¡)
 * 
 * @param {Array} staffList - äººå“¡åˆ—è¡¨
 * @param {Array} tickets - æ‰€æœ‰å·¥å–®åˆ—è¡¨
 * @returns {Object} çµ±è¨ˆç‰©ä»¶
 *   {
 *     underMaintenance: ç¶­ä¿®ä¸­äººæ•¸,
 *     assigned: å·²æŒ‡æ´¾äººæ•¸,
 *     idle: é–’ç½®ä¸­äººæ•¸
 *   }
 */
export function computeOverallStaffStats(staffList, tickets) {
  const stats = {
    underMaintenance: 0,
    assigned: 0,
    idle: 0
  }

  staffList.forEach((staff) => {
    const status = computeStaffStatus(staff.staffId, tickets)
    
    if (status.key === 'UNDER_MAINTENANCE') {
      stats.underMaintenance++
    } else if (status.key === 'ASSIGNED') {
      stats.assigned++
    } else {
      stats.idle++
    }
  })

  return stats
}
</file>

<file path="frontend/src/composables/maintenance/useTicketConfig.js">
/**
 * å·¥å–®é…ç½® Composable
 * çµ±ä¸€ç®¡ç†å·¥å–®çš„ç‹€æ…‹ã€å„ªå…ˆç´šç­‰é…ç½®
 */

// ==================== å„ªå…ˆç´šé…ç½® ====================
export const priorityConfig = {
  LOW: {
    color: '#909399',
    bgColor: '#f4f4f5',
    icon: 'ğŸ”µ',
    text: 'ä½å„ªå…ˆ',
    desc: 'å¯ç¨å¾Œè™•ç†',
    tagType: 'info',
  },
  NORMAL: {
    color: '#409eff',
    bgColor: '#ecf5ff',
    icon: 'ğŸŸ¢',
    text: 'æ™®é€š',
    desc: 'æ­£å¸¸æ’ç¨‹è™•ç†',
    tagType: '',
  },
  HIGH: {
    color: '#e6a23c',
    bgColor: '#fdf6ec',
    icon: 'ğŸŸ ',
    text: 'é«˜å„ªå…ˆ',
    desc: 'å„ªå…ˆå®‰æ’è™•ç†',
    tagType: 'warning',
  },
  URGENT: {
    color: '#f56c6c',
    bgColor: '#fef0f0',
    icon: 'ğŸ”´',
    text: 'ç·Šæ€¥',
    desc: 'ç«‹å³è™•ç†',
    tagType: 'danger',
  },
}

// ==================== ç‹€æ…‹é…ç½® ====================
export const statusConfig = {
  REPORTED: {
    text: 'å·²é€šå ±',
    icon: 'ğŸ“‹',
    tagType: 'info',
    color: '#17a2b8',
  },
  ASSIGNED: {
    text: 'å·²æŒ‡æ´¾',
    icon: 'ğŸ‘¤',
    tagType: 'primary',
    color: '#007bff',
  },
  UNDER_MAINTENANCE: {
    text: 'ç¶­ä¿®ä¸­',
    icon: 'ğŸ”§',
    tagType: 'warning',
    color: '#ffc107',
  },
  RESOLVED: {
    text: 'å·²å®Œæˆ',
    icon: 'âœ…',
    tagType: 'success',
    color: '#28a745',
  },
  CANCELLED: {
    text: 'å·²å–æ¶ˆ',
    icon: 'âŒ',
    tagType: 'info',
    color: '#6c757d',
  },
}

// ==================== å•é¡Œé¡å‹é¸é … ====================
export const issueTypeOptions = [
  { value: 'æ¤…å­æå£', icon: 'ğŸª‘' },
  { value: 'æ©Ÿå°æ•…éšœç•°å¸¸', icon: 'ğŸ–¥ï¸' },
  { value: 'ä¿é¤Š', icon: 'ğŸ”§' },
]

// ==================== çµæ¡ˆçµæœé…ç½® ====================
export const resultConfig = {
  FIXED: {
    text: 'å·²ä¿®å¾©',
    icon: 'âœ…',
    color: '#67c23a',
    desc: 'å•é¡Œå·²æˆåŠŸä¿®å¾©',
  },
  MAINTAINED: {
    text: 'å·²ä¿é¤Š',
    icon: 'ğŸ”§',
    color: '#409eff',
    desc: 'ä¿é¤Šä½œæ¥­å·²å®Œæˆ',
  },

  UNFIXABLE: {
    text: 'ç„¡æ³•ä¿®å¾©',
    icon: 'âŒ',
    color: '#f56c6c',
    desc: 'å•é¡Œç„¡æ³•ä¿®å¾©ï¼Œéœ€æ›´æ›è¨­å‚™',
  },
  OTHER: {
    text: 'å…¶ä»–',
    icon: 'ğŸ“‹',
    color: '#e6a23c',
    desc: 'å…¶ä»–æƒ…æ³',
  },
}

// ==================== å·¥å…·å‡½æ•¸ ====================

/**
 * å–å¾—å„ªå…ˆç´šå°æ‡‰çš„ Tag é¡å‹
 * @param {string} priority - å„ªå…ˆç´šä»£ç¢¼
 * @returns {string} Element Plus tag type
 */
export const getPriorityTag = (priority) => {
  return priorityConfig[priority]?.tagType || 'info'
}

/**
 * å–å¾—ç‹€æ…‹å°æ‡‰çš„ Tag é¡å‹
 * @param {string} status - ç‹€æ…‹ä»£ç¢¼
 * @returns {string} Element Plus tag type
 */
export const getStatusTag = (status) => {
  return statusConfig[status]?.tagType || ''
}

/**
 * å–å¾—å„ªå…ˆç´šæ–‡å­—
 * @param {string} priority - å„ªå…ˆç´šä»£ç¢¼
 * @returns {string} å„ªå…ˆç´šæ–‡å­—
 */
export const getPriorityText = (priority) => {
  return priorityConfig[priority]?.text || priority
}

/**
 * å–å¾—ç‹€æ…‹æ–‡å­—
 * @param {string} status - ç‹€æ…‹ä»£ç¢¼
 * @returns {string} ç‹€æ…‹æ–‡å­—
 */
export const getStatusText = (status) => {
  return statusConfig[status]?.text || status
}

/**
 * å–å¾—å„ªå…ˆç´šåœ–ç¤º
 * @param {string} priority - å„ªå…ˆç´šä»£ç¢¼
 * @returns {string} emoji åœ–ç¤º
 */
export const getPriorityIcon = (priority) => {
  return priorityConfig[priority]?.icon || 'â“'
}

/**
 * å–å¾—ç‹€æ…‹åœ–ç¤º
 * @param {string} status - ç‹€æ…‹ä»£ç¢¼
 * @returns {string} emoji åœ–ç¤º
 */
export const getStatusIcon = (status) => {
  return statusConfig[status]?.icon || 'â“'
}

/**
 * å–å¾—çµæ¡ˆçµæœæ–‡å­—
 * @param {string} resultType - çµæ¡ˆçµæœä»£ç¢¼
 * @returns {string} çµæœæ–‡å­— (æ‰¾ä¸åˆ°å‰‡å›å‚³åŸå§‹ä»£ç¢¼)
 */
export const getResultText = (resultType) => {
  if (!resultType) return '-'
  return resultConfig[resultType]?.text || resultType
}

/**
 * å–å¾—çµæ¡ˆçµæœåœ–ç¤º
 * @param {string} resultType - çµæ¡ˆçµæœä»£ç¢¼
 * @returns {string} emoji åœ–ç¤º
 */
export const getResultIcon = (resultType) => {
  return resultConfig[resultType]?.icon || 'â“'
}

// ==================== Composable Hook ====================
export function useTicketConfig() {
  return {
    priorityConfig,
    statusConfig,
    resultConfig,
    issueTypeOptions,
    getPriorityTag,
    getStatusTag,
    getPriorityText,
    getStatusText,
    getPriorityIcon,
    getStatusIcon,
    getResultText,
    getResultIcon,
  }
}

export default useTicketConfig
</file>

<file path="frontend/src/views/maintenance/MaintenanceStaffHistory.vue">
<script setup>
import { ref, onMounted, computed, watch } from 'vue'
import maintenanceApi from '@/api/modules/maintenance'
import Swal from 'sweetalert2'
import { useRouter } from 'vue-router'
import { usePagination } from '@/composables/maintenance/usePagination'

const router = useRouter()
const staffList = ref([])
const searchText = ref('')
const loading = ref(false)
const pageVisible = ref(false)

// æ–°å¢ï¼šæ—¥æœŸæ ¼å¼åŒ–å°å·¥å…·
const formatDate = (dateVal, row = {}) => {
  // å„ªå…ˆé †åºï¼šå‚³å…¥çš„å€¼ > updateTime > updated_at > createTime > createdAt
  // é€™è£¡å‡è¨­å¦‚æœæ²’æœ‰æ›´æ–°æ™‚é–“ï¼Œå¯èƒ½è¦çœ‹å»ºç«‹æ™‚é–“ (ä¾‹å¦‚é€™ç­†æ­·å²è³‡æ–™çš„å»ºç«‹æ™‚é–“)
  const targetDate =
    dateVal || row.updatedAt || row.updateTime || row.updated_at || row.createTime || row.createdAt

  if (!targetDate) return '-'

  const date = new Date(targetDate)
  // æª¢æŸ¥æ˜¯å¦ç‚ºæœ‰æ•ˆæ—¥æœŸ
  if (isNaN(date.getTime())) return '-'

  return date.toLocaleDateString('zh-TW', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
  })
}

// å°ˆé–€å¾å‚™è¨»è£¡æŠ“å‡º [åœç”¨æ—¥æœŸï¼š...] çš„å·¥å…·
const extractDateFromNote = (noteStr) => {
  if (!noteStr) return '-'

  // ä½¿ç”¨æ­£å‰‡è¡¨é”å¼æŠ“å– [åœç”¨æ—¥æœŸï¼šxxxx/xx/xx]
  const match = noteStr.match(/\[åœç”¨æ—¥æœŸï¼š(.*?)\]/)

  if (match && match[1]) {
    return match[1] // å›å‚³æŠ“åˆ°çš„æ—¥æœŸï¼Œä¾‹å¦‚ "2026/01/29"
  }

  return '-' // æ²’æŠ“åˆ°å°±é¡¯ç¤ºæ§“æ§“
}

// âœ… [æ–°å¢] è§£æå‚™è¨»ä¸­çš„æ­·å²ç´€éŒ„ (å°‡å‚™è¨»å­—ä¸²è½‰ç‚ºæ™‚é–“è»¸é™£åˆ—)
const parseHistoryFromNote = (note) => {
  if (!note) return []

  const history = []

  // ä½¿ç”¨æ­£å‰‡è¡¨é”å¼æŠ“å–æ‰€æœ‰ä¸­æ‹¬è™Ÿå…§çš„å…§å®¹ï¼Œä¾‹å¦‚ [åœç”¨æ—¥æœŸï¼š2026/01/29]
  // flag 'g' ä»£è¡¨æŠ“å–å…¨éƒ¨ï¼Œä¸åªæŠ“ç¬¬ä¸€å€‹
  const regex = /\[(.*?)\]/g
  let match

  // è¿´åœˆæ‰¾å‡ºæ‰€æœ‰çš„æ¨™ç±¤
  while ((match = regex.exec(note)) !== null) {
    const content = match[1] // å–å¾—æ‹¬è™Ÿå…§çš„æ–‡å­—

    // é è¨­æ¨£å¼ (ç°è‰²)
    let color = '#909399'
    let iconColor = '#fff'
    let borderColor = '#909399'

    // æ ¹æ“šé—œéµå­—æ±ºå®šé¡è‰²
    if (content.includes('åœç”¨')) {
      color = '#f56c6c' // ç´…è‰²æ–‡å­—
      borderColor = '#f56c6c' // ç´…è‰²åœ“é»
    } else if (content.includes('å¾©è·')) {
      color = '#67c23a' // ç¶ è‰²æ–‡å­—
      borderColor = '#67c23a' // ç¶ è‰²åœ“é»
    }

    history.push({
      content: content,
      color: color,
      borderColor: borderColor,
    })
  }

  // å¦‚æœå¸Œæœ›æœ€æ–°çš„ç´€éŒ„é¡¯ç¤ºåœ¨æœ€ä¸Šé¢ï¼Œå¯ä»¥ä½¿ç”¨ history.reverse()
  return history
}

// å–å¾—å·²åœç”¨ (Inactive) çš„è³‡æ–™
const fetchHistory = async () => {
  try {
    loading.value = true
    const res = await maintenanceApi.getInactiveStaff()
    console.log('APIå›å‚³çš„ç¬¬ä¸€ç­†è³‡æ–™:', res.data[0])
    staffList.value = res.data
  } catch {
    // éŒ¯èª¤å·²ç”± http.js æ””æˆªå™¨è™•ç†
  } finally {
    loading.value = false
  }
}

// å‰ç«¯æœå°‹
const filteredList = computed(() => {
  const key = searchText.value.trim().toLowerCase()
  if (!key) return staffList.value
  return staffList.value.filter(
    (s) =>
      (s.staffName || '').toLowerCase().includes(key) ||
      (s.staffCompany || '').toLowerCase().includes(key),
  )
})

// ä½¿ç”¨ usePagination composable
const {
  currentPage,
  pageSize,
  paginatedList,
  total: paginationTotal,
  showPagination,
  resetPagination,
} = usePagination(filteredList, { defaultPageSize: 10 })

// æœå°‹æ™‚é‡ç½®åˆ†é 
watch(searchText, () => {
  resetPagination()
})

// æŸ¥çœ‹è©³æƒ…å½ˆçª—
// âœ… [ä¿®æ”¹] æŸ¥çœ‹è©³æƒ…å½ˆçª— (åŒ…å«æ™‚é–“è»¸é¡¯ç¤º)
const viewDetail = (row) => {
  // 1. å…ˆæŠ“å‡ºå‚™è¨»åŸå§‹å­—ä¸²
  const noteStr = row.staffNote || ''

  // 2. åˆ©ç”¨å‰›å‰›å¯«çš„å·¥å…·ï¼Œè§£æå‡ºæ­·å²ç´€éŒ„é™£åˆ—
  const historyList = parseHistoryFromNote(noteStr)

  // 3. æº–å‚™åŸå§‹å‚™è¨» (ç§»é™¤æ‰æ‰€æœ‰ [xxx] æ¨™ç±¤ï¼Œåªç•™ç´”æ–‡å­—å‚™è¨»)
  // replace èªæ³•æœƒæŠŠæ‰€æœ‰ä¸­æ‹¬è™Ÿæ¨™ç±¤éƒ½æ´—æ‰
  const originalNote = noteStr.replace(/\[.*?\]/g, '').trim() || 'ç„¡å…¶ä»–è©³ç´°å‚™è¨»'

  // 4. å»ºæ§‹æ™‚é–“è»¸çš„ HTML (å› ç‚º Swal åªèƒ½åƒ HTML å­—ä¸²)
  let timelineHtml = ''

  if (historyList.length > 0) {
    // å¦‚æœæœ‰ç´€éŒ„ï¼Œé–‹å§‹çµ„è£ HTML
    timelineHtml = '<div style="text-align: left; padding: 0 10px; margin-bottom: 20px;">'
    timelineHtml +=
      '<p style="font-size: 13px; color: #606266; font-weight: bold; margin-bottom: 12px;"><i class="fas fa-stream mr-1"></i> ç•°å‹•æ­·ç¨‹</p>'
    timelineHtml +=
      '<ul style="list-style: none; padding: 0; margin: 0; border-left: 2px solid #e4e7ed; margin-left: 8px;">'

    historyList.forEach((item) => {
      timelineHtml += `
        <li style="margin-bottom: 20px; padding-left: 24px; position: relative;">
          <div style="position: absolute; left: -7px; top: 2px; width: 12px; height: 12px; border-radius: 50%; background: #fff; border: 3px solid ${item.borderColor};"></div>
          <div style="font-size: 14px; color: #303133; font-weight: 500;">
            <span style="color: ${item.color}">${item.content}</span>
          </div>
        </li>
      `
    })

    timelineHtml += '</ul></div>'
  } else {
    // å¦‚æœæ²’æœ‰ç´€éŒ„
    timelineHtml = `
      <div style="margin-bottom: 20px; padding: 12px; background: #f4f4f5; border-radius: 8px; color: #909399; font-size: 13px; border: 1px dashed #dcdfe6; text-align: center;">
        <i class="fas fa-info-circle mr-1"></i> å°šç„¡ç•°å‹•ç´€éŒ„
      </div>
    `
  }

  // 5. é¡¯ç¤ºå½ˆçª—
  Swal.fire({
    // æ¨™é¡Œå€ï¼šå§“å + å…¬å¸
    title: `<div style="display:flex; flex-direction:column; align-items:center; padding-bottom: 10px; border-bottom: 1px solid #ebeef5;">
              <span style="font-size: 1.6rem; color: #303133;">${row.staffName}</span>
              <span style="font-size: 0.9rem; color: #909399; font-weight: normal; margin-top: 6px;">
                <i class="fas fa-building mr-1"></i>${row.staffCompany || 'ç„¡å…¬å¸è³‡è¨Š'}
              </span>
            </div>`,
    html: `
      <div style="text-align: left; padding: 15px 5px 0;">
        
        ${timelineHtml}

        <div style="margin-bottom: 16px;">
           <p style="margin: 0 0 8px 0; color: #606266; font-size: 13px; font-weight: bold;">åŸºæœ¬è³‡æ–™</p>
           <div style="padding: 12px; background: #f5f7fa; border-radius: 8px;">
            <p style="margin: 6px 0; font-size: 14px; color: #606266;">
              <i class="fas fa-phone mr-2 text-success" style="width:20px; text-align:center;"></i>
              ${row.staffPhone || 'æœªå¡«å¯«'}
            </p>
            <p style="margin: 6px 0; font-size: 14px; color: #606266;">
              <i class="fas fa-envelope mr-2 text-warning" style="width:20px; text-align:center;"></i>
              ${row.staffEmail || 'æœªå¡«å¯«'}
            </p>
          </div>
        </div>

        <div>
          <p style="margin: 0 0 8px 0; color: #606266; font-size: 13px; font-weight: bold;">
            <i class="fas fa-sticky-note mr-1"></i> å…¶ä»–å‚™è¨»
          </p>
          <div style="padding: 12px; background: #fff; border: 1px solid #dcdfe6; border-radius: 8px; color: #606266; font-size: 14px; line-height: 1.6; white-space: pre-line;">
            ${originalNote}
          </div>
        </div>

      </div>
    `,
    confirmButtonText: 'é—œé–‰',
    confirmButtonColor: '#909399',
    width: 480, // ç¨å¾®åŠ å¯¬ä¸€é»è®“æ™‚é–“è»¸å¥½çœ‹
    showClass: { popup: 'animate__animated animate__fadeInDown animate__faster' },
    hideClass: { popup: 'animate__animated animate__fadeOutUp animate__faster' },
  })
}

// æ¢å¾©äººå“¡åŠŸèƒ½
// ä¿®æ”¹ handleRestore å‡½å¼
const handleRestore = async (row) => {
  const result = await Swal.fire({
    title: 'ç¢ºèªæ¢å¾©äººå“¡ï¼Ÿ',
    html: `<p>å³å°‡æ¢å¾© <b class="text-primary">${row.staffName}</b> çš„åœ¨è·ç‹€æ…‹</p>`,
    icon: 'question',
    showCancelButton: true,
    confirmButtonColor: '#67c23a',
    cancelButtonColor: '#909399',
    confirmButtonText: '<i class="fas fa-undo mr-1"></i> ç¢ºèªæ¢å¾©',
    cancelButtonText: 'å–æ¶ˆ',
    showClass: { popup: 'animate__animated animate__bounceIn' },
  })

  if (result.isConfirmed) {
    try {
      // --- ä¿®æ­£é–‹å§‹ï¼šæ¸…æ´—å‚™è¨» ---
      let cleanNote = row.staffNote || ''
      // 1. ç§»é™¤ [åœç”¨åŸå› ï¼š...] (ä½¿ç”¨æ­£å‰‡è¡¨é”å¼ global æ›¿æ›)
      cleanNote = cleanNote.replace(/\[åœç”¨åŸå› ï¼š.*?\]/g, '')

      // 2. ç§»é™¤ [åœç”¨æ—¥æœŸï¼š...] (ä½¿ç”¨æ­£å‰‡è¡¨é”å¼ global æ›¿æ›)
      cleanNote = cleanNote.replace(/\[åœç”¨æ—¥æœŸï¼š.*?\]/g, '')

      // 3. ç§»é™¤å¤šé¤˜ç©ºç™½è¡Œèˆ‡å‰å¾Œç©ºç™½
      cleanNote = cleanNote.trim()

      // å‚³é€æ¸…æ´—éçš„å‚™è¨» (cleanNote) å›å¾Œç«¯
      await maintenanceApi.updateStaff(row.staffId, {
        ...row,
        isActive: true,
        staffNote: cleanNote,
      })

      await Swal.fire({
        icon: 'success',
        title: 'æ¢å¾©æˆåŠŸï¼',
        html: `<span class="text-success"><b>${row.staffName}</b> å·²æ¢å¾©åœ¨è·ç‹€æ…‹</span>`,
        timer: 1000,
        timerProgressBar: true,
        showConfirmButton: false,
        showClass: { popup: 'animate__animated animate__tada' },
      })
      fetchHistory()
    } catch {
      // éŒ¯èª¤å·²ç”±æ””æˆªå™¨è™•ç†
    }
  }
}

const handleBack = () => {
  router.push('/admin/staff-list')
}

onMounted(() => {
  fetchHistory()
  setTimeout(() => (pageVisible.value = true), 100)
})
</script>

<template>
  <div class="history-container">
    <!-- é é¢æ¨™é¡Œå€ -->
    <section class="content-header">
      <div class="container-fluid">
        <transition name="slide-down" appear>
          <div class="page-title-box">
            <div class="title-icon">
              <i class="fas fa-archive"></i>
            </div>
            <div class="title-content">
              <h1>ç¶­è­·äººå“¡æ­·å²ç´€éŒ„</h1>
              <p class="subtitle">æª¢è¦–å·²é›¢è·æˆ–åœç”¨çš„äººå“¡è³‡æ–™</p>
            </div>
            <div class="title-actions">
              <el-button type="primary" plain @click="handleBack" class="back-btn">
                <i class="fas fa-arrow-left mr-2"></i> è¿”å›åˆ—è¡¨
              </el-button>
            </div>
          </div>
        </transition>
      </div>
    </section>

    <!-- ä¸»å…§å®¹å€ -->
    <section class="content">
      <div class="container-fluid">
        <transition name="zoom-fade" appear>
          <div v-show="pageVisible">
            <!-- çµ±è¨ˆå¡ç‰‡ -->
            <el-row :gutter="20" class="mb-4">
              <el-col :xs="24" :sm="8" :md="6">
                <div class="stat-card archive-card">
                  <div class="stat-icon">
                    <i class="fas fa-user-slash"></i>
                  </div>
                  <div class="stat-info">
                    <h3>{{ staffList.length }}</h3>
                    <span>å·²å°å­˜äººå“¡</span>
                  </div>
                </div>
              </el-col>
              <el-col :xs="24" :sm="8" :md="6">
                <div class="stat-card filter-card">
                  <div class="stat-icon">
                    <i class="fas fa-filter"></i>
                  </div>
                  <div class="stat-info">
                    <h3>{{ filteredList.length }}</h3>
                    <span>ç¯©é¸çµæœ</span>
                  </div>
                </div>
              </el-col>
            </el-row>

            <!-- è³‡æ–™è¡¨æ ¼å¡ç‰‡ -->
            <el-card shadow="hover" class="table-card">
              <template #header>
                <div class="card-header-content">
                  <div class="header-left">
                    <span class="header-icon">
                      <i class="fas fa-history"></i>
                    </span>
                    <span class="header-text">å·²å°å­˜äººå“¡æ¸…å–®</span>
                    <el-tag type="info" effect="plain" size="small" class="ml-2">
                      å…± {{ filteredList.length }} ç­†
                    </el-tag>
                  </div>
                  <div class="header-right">
                    <el-input
                      v-model="searchText"
                      placeholder="æœå°‹å§“åæˆ–å…¬å¸..."
                      prefix-icon="Search"
                      clearable
                      class="search-input"
                    />
                  </div>
                </div>
              </template>

              <!-- éª¨æ¶å± -->
              <el-skeleton :rows="6" animated v-if="loading" />

              <!-- è³‡æ–™è¡¨æ ¼ -->
              <el-table
                v-else
                :data="paginatedList"
                stripe
                highlight-current-row
                style="width: 100%"
                class="custom-table"
                :row-class-name="tableRowClassName"
              >
                <el-table-column prop="staffId" label="ID" width="70" align="center" sortable>
                  <template #default="{ row }">
                    <el-tag effect="plain" size="small" type="info">{{ row.staffId }}</el-tag>
                  </template>
                </el-table-column>

                <el-table-column prop="staffName" label="å§“å" width="140" sortable>
                  <template #default="{ row }">
                    <div class="name-cell">
                      <el-avatar :size="32" class="name-avatar">
                        {{ row.staffName?.charAt(0) || '?' }}
                      </el-avatar>
                      <span class="name-text">{{ row.staffName }}</span>
                    </div>
                  </template>
                </el-table-column>

                <el-table-column prop="staffCompany" label="å…¬å¸" min-width="160" sortable>
                  <template #default="{ row }">
                    <span v-if="row.staffCompany">
                      <i class="fas fa-building mr-1 text-primary"></i>
                      {{ row.staffCompany }}
                    </span>
                    <span v-else class="text-muted">-</span>
                  </template>
                </el-table-column>

                <el-table-column prop="staffPhone" label="é›»è©±" min-width="150">
                  <template #default="{ row }">
                    <span v-if="row.staffPhone">
                      <i class="fas fa-phone mr-1 text-success"></i>
                      {{ row.staffPhone }}
                    </span>
                    <span v-else class="text-muted">-</span>
                  </template>
                </el-table-column>

                <el-table-column
                  prop="staffEmail"
                  label="Email"
                  min-width="200"
                  show-overflow-tooltip
                >
                  <template #default="{ row }">
                    <span class="email-cell">
                      <i class="fas fa-envelope mr-1 text-warning"></i>
                      {{ row.staffEmail }}
                    </span>
                  </template>
                </el-table-column>

                <el-table-column label="åœç”¨æ—¥æœŸ" width="120" sortable prop="updatedAt">
                  <template #default="{ row }">
                    <div style="display: flex; flex-direction: column; align-items: flex-start">
                      <span style="font-size: 13px; color: #606266">
                        <i class="far fa-calendar-alt mr-1 text-muted"></i>
                        {{ extractDateFromNote(row.staffNote) }}
                      </span>
                    </div>
                  </template>
                </el-table-column>

                <el-table-column label="ç‹€æ…‹" width="110" align="center">
                  <template #default>
                    <el-tag type="info" effect="dark" class="status-tag">
                      <i class="fas fa-ban mr-1"></i> å·²é›¢è·
                    </el-tag>
                  </template>
                </el-table-column>

                <el-table-column label="æ“ä½œ" width="160" align="center" fixed="right">
                  <template #default="{ row }">
                    <el-button-group>
                      <el-tooltip content="æŸ¥çœ‹è©³æƒ…" placement="top">
                        <el-button
                          type="info"
                          size="small"
                          circle
                          @click="viewDetail(row)"
                          class="action-btn"
                        >
                          <i class="fas fa-eye"></i>
                        </el-button>
                      </el-tooltip>
                      <el-tooltip content="æ¢å¾©åœ¨è·" placement="top">
                        <el-button
                          type="success"
                          size="small"
                          circle
                          @click="handleRestore(row)"
                          class="action-btn"
                        >
                          <i class="fas fa-undo"></i>
                        </el-button>
                      </el-tooltip>
                    </el-button-group>
                  </template>
                </el-table-column>

                <!-- ç©ºç‹€æ…‹ -->
                <template #empty>
                  <el-empty description="æš«ç„¡æ­·å²è³‡æ–™">
                    <template #image>
                      <div class="empty-icon">
                        <i class="fas fa-inbox"></i>
                      </div>
                    </template>
                    <el-button type="primary" plain @click="handleBack"> è¿”å›äººå“¡åˆ—è¡¨ </el-button>
                  </el-empty>
                </template>
              </el-table>

              <!-- åˆ†é å™¨ -->
              <div class="pagination-wrapper" v-if="showPagination">
                <el-pagination
                  v-model:current-page="currentPage"
                  v-model:page-size="pageSize"
                  :page-sizes="[5, 10, 20, 50]"
                  :total="paginationTotal"
                  layout="total, sizes, prev, pager, next, jumper"
                  background
                />
              </div>
            </el-card>
          </div>
        </transition>
      </div>
    </section>
  </div>
</template>

<style scoped>
.history-container {
  min-height: 100vh;
  background: linear-gradient(135deg, #f0f2f5 0%, #e2e6ea 100%);
  padding-bottom: 40px;
}

.content-header {
  padding: 20px 1rem;
}

.page-title-box {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 20px 24px;
  background: white;
  border-radius: 16px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
}

.title-icon {
  width: 60px;
  height: 60px;
  border-radius: 14px;
  background: linear-gradient(135deg, #909399 0%, #c0c4cc 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 26px;
  color: white;
  transition: all 0.3s ease;
}

.title-icon:hover {
  transform: scale(1.1) rotate(-5deg);
}

.title-content {
  flex: 1;
}

.title-content h1 {
  margin: 0;
  font-size: 1.6rem;
  font-weight: 700;
  color: #303133;
}

.title-content .subtitle {
  margin: 6px 0 0;
  font-size: 0.9rem;
  color: #909399;
}

.title-actions .back-btn {
  border-radius: 10px;
  font-weight: 500;
  transition: all 0.3s ease;
}

.title-actions .back-btn:hover {
  transform: translateX(-5px);
}

/* çµ±è¨ˆå¡ç‰‡ */
.stat-card {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 20px;
  background: white;
  border-radius: 14px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
  transition: all 0.3s ease;
  margin-bottom: 16px;
}

.stat-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
}

.stat-icon {
  width: 50px;
  height: 50px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  color: white;
}

.archive-card .stat-icon {
  background: linear-gradient(135deg, #909399 0%, #b1b3b8 100%);
}

.filter-card .stat-icon {
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
}

.stat-info h3 {
  margin: 0;
  font-size: 1.8rem;
  font-weight: 700;
  color: #303133;
}

.stat-info span {
  font-size: 0.85rem;
  color: #909399;
}

/* è¡¨æ ¼å¡ç‰‡ */
.table-card {
  border-radius: 16px;
  overflow: hidden;
  border: none;
}

.card-header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 12px;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 10px;
}

.header-icon {
  width: 36px;
  height: 36px;
  background: linear-gradient(135deg, #909399 0%, #c0c4cc 100%);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 16px;
}

.header-text {
  font-weight: 600;
  font-size: 1.05rem;
  color: #303133;
}

.search-input {
  width: 260px;
}

.search-input :deep(.el-input__wrapper) {
  border-radius: 10px;
}

/* è¡¨æ ¼æ¨£å¼ */
.custom-table {
  --el-table-header-bg-color: #f8f9fa;
}

.name-cell {
  display: flex;
  align-items: center;
  gap: 10px;
}

.name-avatar {
  background: linear-gradient(135deg, #909399 0%, #b1b3b8 100%);
  color: white;
  font-weight: 600;
  flex-shrink: 0;
}

.name-text {
  font-weight: 500;
}

.email-cell {
  display: flex;
  align-items: center;
  width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.status-tag {
  border-radius: 6px;
}

.action-btn {
  transition: all 0.3s ease;
}

.action-btn:hover {
  transform: scale(1.15);
}

/* ç©ºç‹€æ…‹ */
.empty-icon {
  font-size: 60px;
  color: #dcdfe6;
  margin-bottom: 16px;
}

/* åˆ†é  */
.pagination-wrapper {
  display: flex;
  justify-content: center;
  padding-top: 20px;
  border-top: 1px solid #ebeef5;
  margin-top: 20px;
}

/* éæ¸¡å‹•ç•« */
.slide-down-enter-active {
  transition: all 0.5s ease-out;
}
.slide-down-leave-active {
  transition: all 0.3s ease-in;
}
.slide-down-enter-from {
  transform: translateY(-30px);
  opacity: 0;
}
.slide-down-leave-to {
  transform: translateY(-20px);
  opacity: 0;
}

.zoom-fade-enter-active {
  transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.zoom-fade-leave-active {
  transition: all 0.3s ease-in;
}
.zoom-fade-enter-from {
  transform: scale(0.95);
  opacity: 0;
}
.zoom-fade-leave-to {
  transform: scale(0.98);
  opacity: 0;
}

/* è¼”åŠ©é¡ */
.text-muted {
  color: #c0c4cc;
}
.text-primary {
  color: #409eff;
}
.text-success {
  color: #67c23a;
}
.text-warning {
  color: #e6a23c;
}
.mr-1 {
  margin-right: 4px;
}
.mr-2 {
  margin-right: 8px;
}
.ml-2 {
  margin-left: 8px;
}
.mb-4 {
  margin-bottom: 1.5rem;
}
</style>
</file>

<file path="frontend/src/composables/maintenance/useCozeChat.js">
import { ref, computed } from 'vue'
import supportApi from '@/api/modules/support'
import { useMemberAuthStore } from '@/stores/memberAuth'

/**
 * Coze OpenAPI èŠå¤© Composable
 *
 * ã€é‡æ§‹èªªæ˜ã€‘2026-02-01
 * - å®Œå…¨ç§»é™¤ WebSDK / chatapp æ•´åˆï¼ˆå·²ç¢ºèª 502 TLB å•é¡Œï¼‰
 * - æ”¹ç”¨ Coze OpenAPIï¼ˆé€éå¾Œç«¯ Proxyï¼‰
 * - å‰ç«¯è‡ªè£½èŠå¤© UIï¼Œä¸ä¾è³´ SDK
 *
 * ã€åŠŸèƒ½ã€‘
 * 1. é€éå¾Œç«¯ Proxy èˆ‡ Coze OpenAPI é€šè¨Š
 * 2. ç®¡ç†å°è©±æ­·å²ï¼ˆæœ¬åœ°ï¼‰
 * 3. é™ç´š UI ç‹€æ…‹ç®¡ç†
 * 4. é‡è©¦æ©Ÿåˆ¶ï¼ˆæŒ‡æ•¸é€€é¿ï¼‰
 */
export function useCozeChat() {
  const memberAuthStore = useMemberAuthStore()

  // ==================== BEGIN: ç‹€æ…‹å®šç¾© ====================
  const loading = ref(false)
  const initialized = ref(false)
  const error = ref(null)
  const degraded = ref(false) // é™ç´šæ¨¡å¼ï¼ˆAPI ä¸å¯ç”¨ï¼‰
  const retryCount = ref(0)
  const maxRetries = 3

  // èŠå¤©ç›¸é—œç‹€æ…‹
  const messages = ref([]) // { role: 'user'|'assistant', content: string, timestamp: Date }
  const conversationId = ref(null)
  const sending = ref(false) // æ­£åœ¨ç™¼é€è¨Šæ¯
  // ==================== END: ç‹€æ…‹å®šç¾© ====================

  // ==================== BEGIN: è¨ˆç®—å±¬æ€§ ====================
  const status = computed(() => {
    if (loading.value) return 'loading'
    if (degraded.value) return 'degraded'
    if (initialized.value) return 'ready'
    if (error.value) return 'error'
    return 'idle'
  })

  const statusText = computed(() => {
    const statusMap = {
      loading: 'åˆå§‹åŒ–ä¸­...',
      degraded: 'æœå‹™æš«æ™‚ä¸å¯ç”¨',
      ready: 'å·²å°±ç·’',
      error: 'åˆå§‹åŒ–å¤±æ•—',
      idle: 'æœªå•Ÿå‹•',
    }
    return statusMap[status.value] || 'æœªçŸ¥ç‹€æ…‹'
  })
  // ==================== END: è¨ˆç®—å±¬æ€§ ====================

  // ==================== BEGIN: å·¥å…·å‡½æ•¸ ====================
  const getRetryDelay = (attempt) => {
    const delays = [300, 800, 1500]
    return delays[Math.min(attempt, delays.length - 1)]
  }

  const sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms))

  const getUserId = () => {
    if (memberAuthStore.isLogin && memberAuthStore.member?.memId) {
      return `member_${memberAuthStore.member.memId}`
    }
    const storageKey = 'support_user_id'
    let userId = localStorage.getItem(storageKey)
    if (!userId) {
      userId = crypto.randomUUID
        ? crypto.randomUUID()
        : `guest_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
      localStorage.setItem(storageKey, userId)
    }
    return userId
  }

  const logDiagnostic = (level, message, data = {}) => {
    const timestamp = new Date().toISOString()
    const safeData = { ...data }
    delete safeData.token
    delete safeData.pat

    if (level === 'error') {
      console.error(`[Coze OpenAPI] ${message}`, safeData)
    } else if (level === 'warn') {
      console.warn(`[Coze OpenAPI] ${message}`, safeData)
    } else {
      console.log(`[Coze OpenAPI] ${message}`, safeData)
    }
  }

  /**
   * å¾ AI å›è¦†ä¸­æ“·å–çµæ§‹åŒ– intentï¼ˆJSONï¼‰
   * - æ‰¾ ```json ... ``` å€å¡Š
   * - parse JSON
   * - å›å‚³ï¼š{ cleanText, intent }
   */

  const extractIntentFromReply = (rawText) => {
    if (!rawText) {
      return { cleanText: rawText, intent: null }
    }

    const jsonBlockRegex = /```json\s*([\s\S]*?)\s*```/i
    const match = rawText.match(jsonBlockRegex)

    if (!match) {
      return { cleanText: rawText, intent: null }
    }

    let intent = null
    try {
      intent = JSON.parse(match[1])
    } catch (e) {
      logDiagnostic('warn', 'JSON intent è§£æå¤±æ•—ï¼Œå·²å¿½ç•¥', { error: e.message })
    }

    // æŠŠ JSON å€å¡Šå¾é¡¯ç¤ºæ–‡å­—ä¸­ç§»é™¤
    const cleanText = rawText.replace(jsonBlockRegex, '').trim()

    return { cleanText, intent }
  }

  // ==================== END: å·¥å…·å‡½æ•¸ ====================

  // ==================== BEGIN: åˆå§‹åŒ–ï¼ˆæª¢æŸ¥ API ç‹€æ…‹ï¼‰ ====================
  const initCozeChat = async () => {
    if (initialized.value) {
      logDiagnostic('info', 'å·²åˆå§‹åŒ–ï¼Œè·³é')
      return { success: true, cached: true }
    }

    loading.value = true
    error.value = null
    degraded.value = false

    try {
      logDiagnostic('info', 'æª¢æŸ¥ Coze OpenAPI ç‹€æ…‹...')

      const response = await supportApi.checkCozeStatus()
      const statusData = response.data

      if (statusData.available) {
        initialized.value = true
        logDiagnostic('info', 'âœ… OpenAPI å¯ç”¨', { mode: statusData.mode })
        return { success: true, mode: 'openapi' }
      } else {
        // API ä¸å¯ç”¨ï¼Œé€²å…¥é™ç´šæ¨¡å¼
        degraded.value = true
        error.value = statusData.message || 'API ä¸å¯ç”¨'
        logDiagnostic('warn', 'âš ï¸ OpenAPI ä¸å¯ç”¨ï¼Œé€²å…¥é™ç´šæ¨¡å¼', {
          status: statusData.status,
          message: statusData.message,
        })
        return { success: false, degraded: true, error: statusData.message }
      }
    } catch (err) {
      error.value = err.message || 'ç„¡æ³•é€£ç·šè‡³ä¼ºæœå™¨'
      degraded.value = true
      logDiagnostic('error', 'âŒ åˆå§‹åŒ–å¤±æ•—', { error: err.message })
      return { success: false, error: err.message, degraded: true }
    } finally {
      loading.value = false
    }
  }
  // ==================== END: åˆå§‹åŒ– ====================

  // ==================== BEGIN: ç™¼é€è¨Šæ¯ ====================
  const sendMessage = async (messageText) => {
    if (!messageText || !messageText.trim()) {
      return { success: false, error: 'è¨Šæ¯ä¸å¯ç‚ºç©º' }
    }

    if (degraded.value) {
      return { success: false, error: 'æœå‹™æš«æ™‚ä¸å¯ç”¨' }
    }

    sending.value = true
    const userId = getUserId()

    // å…ˆå°‡ä½¿ç”¨è€…è¨Šæ¯åŠ å…¥åˆ—è¡¨
    const userMessage = {
      role: 'user',
      content: messageText.trim(),
      timestamp: new Date(),
    }
    messages.value.push(userMessage)

    try {
      logDiagnostic('info', 'ğŸ“¤ ç™¼é€è¨Šæ¯', { length: messageText.length })

      const response = await supportApi.sendChatMessage({
        message: messageText.trim(),
        userId: userId,
        conversationId: conversationId.value,
      })

      const result = response.data

      if (result.success) {
        // å„²å­˜ conversationId ä¾›å¾ŒçºŒå°è©±ä½¿ç”¨
        if (result.conversationId) {
          conversationId.value = result.conversationId
        }

        // åŠ å…¥ AI å›è¦†

        //è§£æintent
        const { cleanText, intent } = extractIntentFromReply(result.replyText)

        //åŠ å…¥ä¹¾æ·¨AIå›è¦†(è®“ä½¿ç”¨è€…çœ‹ä¸åˆ°JSON)
        messages.value.push({
          role: 'assistant',
          content: cleanText || 'ï¼ˆç„¡å›è¦†ï¼‰',
          timestamp: new Date(),
        })

        logDiagnostic('info', 'âœ… æ”¶åˆ°å›è¦†', {
          conversationId: result.conversationId,
          replyLength: result.replyText?.length,
        })

        retryCount.value = 0 // æˆåŠŸå¾Œé‡ç½®é‡è©¦è¨ˆæ•¸
        return { success: true, reply: result.replyText }
      } else {
        // API å›å‚³éŒ¯èª¤
        const errorMsg = result.error || 'ç™¼é€å¤±æ•—'
        logDiagnostic('warn', 'âš ï¸ API å›å‚³éŒ¯èª¤', { error: errorMsg })

        // åŠ å…¥éŒ¯èª¤è¨Šæ¯
        messages.value.push({
          role: 'assistant',
          content: `âš ï¸ ${errorMsg}`,
          timestamp: new Date(),
          isError: true,
        })

        return { success: false, error: errorMsg }
      }
    } catch (err) {
      const errorMsg = err.response?.data?.error || err.message || 'ç¶²è·¯éŒ¯èª¤'
      const isBusinessError = err.response?.data?.isBusinessError === true
      const status = err.response?.status

      logDiagnostic('error', 'âŒ ç™¼é€å¤±æ•—', { error: errorMsg, status, isBusinessError })

      // ==================== BEGIN: ä¿®æ­£é‡è©¦é‚è¼¯ ====================
      // åªæœ‰ 502/503/504/408 æ‰é‡è©¦ï¼Œ400/409 æ¥­å‹™éŒ¯èª¤ä¸é‡è©¦
      const shouldRetryStatus = [502, 503, 504, 408]
      const canRetry =
        !isBusinessError && shouldRetryStatus.includes(status) && retryCount.value < maxRetries

      if (canRetry) {
        retryCount.value++
        const delay = getRetryDelay(retryCount.value - 1)
        logDiagnostic('info', `é‡è©¦ ${retryCount.value}/${maxRetries}ï¼Œå»¶é² ${delay}ms`)

        // ç§»é™¤å‰›åŠ å…¥çš„ä½¿ç”¨è€…è¨Šæ¯ï¼ˆé‡è©¦æ™‚æœƒé‡æ–°åŠ å…¥ï¼‰
        messages.value.pop()

        await sleep(delay)
        return await sendMessage(messageText)
      }
      // ==================== END: ä¿®æ­£é‡è©¦é‚è¼¯ ====================

      // åŠ å…¥éŒ¯èª¤è¨Šæ¯
      messages.value.push({
        role: 'assistant',
        content: `âš ï¸ ${errorMsg}`,
        timestamp: new Date(),
        isError: true,
      })

      // åªæœ‰é€£ç·šéŒ¯èª¤æ‰é€²å…¥é™ç´šæ¨¡å¼ï¼Œæ¥­å‹™éŒ¯èª¤ä¸é€²å…¥
      if (!isBusinessError && retryCount.value >= maxRetries) {
        degraded.value = true
        logDiagnostic('warn', 'é‡è©¦æ¬¡æ•¸å·²é”ä¸Šé™ï¼Œé€²å…¥é™ç´šæ¨¡å¼')
      }

      return { success: false, error: errorMsg }
    } finally {
      sending.value = false
    }
  }
  // ==================== END: ç™¼é€è¨Šæ¯ ====================

  // ==================== BEGIN: æ‰‹å‹•é‡è©¦ ====================
  const manualRetry = async () => {
    retryCount.value = 0
    degraded.value = false
    error.value = null
    initialized.value = false

    return await initCozeChat()
  }
  // ==================== END: æ‰‹å‹•é‡è©¦ ====================

  // ==================== BEGIN: æ¸…é™¤å°è©± ====================
  const clearMessages = () => {
    messages.value = []
    conversationId.value = null
    logDiagnostic('info', 'å°è©±å·²æ¸…é™¤')
  }
  // ==================== END: æ¸…é™¤å°è©± ====================

  // ==================== BEGIN: éŠ·æ¯€ ====================
  const destroy = () => {
    messages.value = []
    conversationId.value = null
    initialized.value = false
    degraded.value = false
    error.value = null
    retryCount.value = 0
  }
  // ==================== END: éŠ·æ¯€ ====================

  return {
    // ç‹€æ…‹
    loading,
    initialized,
    error,
    degraded,
    retryCount,
    status,
    statusText,
    messages,
    conversationId,
    sending,

    // æ–¹æ³•
    initCozeChat,
    sendMessage,
    manualRetry,
    clearMessages,
    destroy,
  }
}
</file>

<file path="frontend/src/views/maintenance/MaintenanceStaffForm.vue">
<script setup>
import { ref, onMounted, reactive, computed } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { ElMessageBox, ElMessage } from 'element-plus' // æ”¹ç”¨ Element Plus å…ƒä»¶
import maintenanceApi from '@/api/modules/maintenance'
import MaintenancePageHeader from '@/components/maintenance/MaintenancePageHeader.vue'

const route = useRoute()
const router = useRouter()
const staffId = Number(route.params.id)
const isEdit = computed(() => !isNaN(staffId) && staffId > 0)

const formRef = ref(null)
const loading = ref(false)
const submitting = ref(false)
// ç§»é™¤ formVisible èˆ‡ setTimeoutï¼Œæ”¹ç”¨ CSS å‹•ç•«åŸç”Ÿçš„ appear

const form = reactive({
  staffName: '',
  staffCompany: '',
  staffPhone: '',
  staffEmail: '',
  staffNote: '',
  isActive: true,
})

const rules = {
  staffName: [{ required: true, message: 'è«‹è¼¸å…¥å§“å', trigger: 'blur' }],
  staffEmail: [{ type: 'email', message: 'Email æ ¼å¼ä¸æ­£ç¢º', trigger: 'blur' }],
}

onMounted(async () => {
  if (isEdit.value) {
    loading.value = true
    try {
      const res = await maintenanceApi.getStaffById(staffId)
      // ç¢ºä¿ API å›å‚³çš„è³‡æ–™èƒ½æ­£ç¢ºæ˜ å°„
      Object.assign(form, res.data || res)
    } catch (error) {
      console.error('ç²å–è³‡æ–™å¤±æ•—:', error)
      ElMessage.error('ç„¡æ³•è¼‰å…¥äººå“¡è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦')
      router.push('/admin/staff-list')
    } finally {
      loading.value = false
    }
  }
})

const submitForm = async () => {
  if (!formRef.value) return

  await formRef.value.validate(async (valid) => {
    if (valid) {
      // 1. ç¢ºèªè¦–çª— (ä½¿ç”¨ Element Plus)
      try {
        await ElMessageBox.confirm(
          isEdit.value ? 'å³å°‡æ›´æ–°æ­¤äººå“¡è³‡æ–™ï¼Œç¢ºå®šå—ï¼Ÿ' : 'å³å°‡æ–°å¢ç¶­è­·äººå“¡ï¼Œç¢ºå®šå—ï¼Ÿ',
          isEdit.value ? 'ç¢ºèªæ›´æ–°' : 'ç¢ºèªæ–°å¢',
          {
            confirmButtonText: 'ç¢ºèªé€å‡º',
            cancelButtonText: 'å†æƒ³æƒ³',
            type: 'warning',
            draggable: true,
          },
        )
      } catch {
        // ä½¿ç”¨è€…é»æ“Šå–æ¶ˆ
        return
      }

      // 2. åŸ·è¡Œé€å‡º
      submitting.value = true
      try {
        if (isEdit.value) {
          await maintenanceApi.updateStaff(staffId, form)
          ElMessage.success({
            message: `æ›´æ–°æˆåŠŸï¼äººå“¡ ${form.staffName} è³‡æ–™å·²æ›´æ–°`,
            duration: 2000,
          })
        } else {
          await maintenanceApi.createStaff(form)
          ElMessage.success({
            message: `æ–°å¢æˆåŠŸï¼æ­¡è¿ ${form.staffName} åŠ å…¥åœ˜éšŠ`,
            duration: 2000,
          })
        }
        router.push('/admin/staff-list')
      } catch (error) {
        // éŒ¯èª¤é€šå¸¸ç”± http.js æ””æˆªå™¨è™•ç†ï¼Œé€™è£¡åšå‚™ç”¨
        console.error(error)
      } finally {
        submitting.value = false
      }
    } else {
      // é©—è­‰å¤±æ•—æç¤º
      ElMessage.warning('è¡¨å–®é©—è­‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥å¿…å¡«æ¬„ä½')
    }
  })
}

//ä¸€éµå¸¶å…¥(Demoç”¨)
const handleDemoFill = () => {
  form.staffName = 'æ±Ÿå°é­š'
  form.staffCompany = 'å°é­šç§‘æŠ€è‚¡ä»½æœ‰é™å…¬å¸'
  form.staffPhone = '0988-123-456'
  form.staffEmail = 'swagsnail860701@gmail.com'
  form.staffNote = 'è³‡æ·±ç¶­è­·å·¥ç¨‹å¸«ï¼Œè² è²¬åŒ—å€æ©Ÿå°ç¶­ä¿®ï¼Œé€±ä¸€è‡³é€±äº” 09:00~18:00 å¯è¯ç¹«ã€‚'
  form.isActive = true

  // æç¤ºä¸€ä¸‹ä½¿ç”¨è€…
  ElMessage.success('å·²å¸¶å…¥æ¸¬è©¦è³‡æ–™ï¼')
}

const handleCancel = async () => {
  // å¦‚æœæœ‰å¡«å¯«å…§å®¹ï¼Œé›¢é–‹å‰ç¢ºèª
  if (form.staffName || form.staffCompany || form.staffPhone) {
    try {
      await ElMessageBox.confirm('æ‚¨å¡«å¯«çš„è³‡æ–™å°‡ä¸æœƒè¢«ä¿å­˜ï¼Œç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ', 'ç¢ºèªé›¢é–‹', {
        confirmButtonText: 'é›¢é–‹',
        cancelButtonText: 'ç¹¼çºŒç·¨è¼¯',
        type: 'warning',
      })
    } catch {
      return
    }
  }
  router.push('/admin/staff-list')
}
</script>

<template>
  <div class="staff-form-container">
    <section class="content-header">
      <div class="container-fluid">
        <transition name="slide-fade" appear>
          <MaintenancePageHeader
            :title="isEdit ? 'ç·¨è¼¯äººå“¡è³‡æ–™' : 'æ–°å¢ç¶­è­·äººå“¡'"
            :subtitle="isEdit ? 'ä¿®æ”¹ç¾æœ‰äººå“¡çš„è©³ç´°è³‡è¨Š' : 'å»ºç«‹æ–°çš„ç¶­è­·äººå“¡æª”æ¡ˆ'"
            :icon="isEdit ? 'fas fa-user-edit' : 'fas fa-user-plus'"
            :mode="isEdit ? 'edit' : 'add'"
          />
        </transition>
      </div>
    </section>

    <section class="content">
      <div class="container-fluid d-flex justify-content-center">
        <transition name="zoom-fade" appear>
          <el-card
            shadow="hover"
            class="form-card"
            v-loading="loading"
            element-loading-text="è¼‰å…¥ä¸­..."
          >
            <template #header>
              <div class="card-header-content">
                <div class="header-left">
                  <span class="header-icon">
                    <i class="fas fa-id-card"></i>
                  </span>
                  <span class="header-text">åŸºæœ¬è³‡æ–™</span>
                  <el-tag v-if="isEdit" type="warning" effect="plain" size="small" class="ml-2">
                    ç·¨è¼¯æ¨¡å¼
                  </el-tag>
                  <el-tag v-else type="success" effect="plain" size="small" class="ml-2">
                    æ–°å¢æ¨¡å¼
                  </el-tag>
                </div>

                <el-button class="cancel-btn" text type="info" @click="handleCancel">
                  <i class="fas fa-times mr-1"></i> å–æ¶ˆ
                </el-button>
              </div>
            </template>

            <el-form
              ref="formRef"
              :model="form"
              :rules="rules"
              label-width="100px"
              label-position="top"
              status-icon
              class="staff-form"
            >
              <el-form-item label="å§“å" prop="staffName" class="form-item-animated">
                <template #label>
                  <span class="custom-label">
                    <i class="fas fa-user label-icon"></i> å§“å
                    <span class="required-star">*</span>
                  </span>
                </template>
                <el-input
                  v-model="form.staffName"
                  placeholder="è«‹è¼¸å…¥ç¶­è­·äººå“¡å§“å"
                  prefix-icon="User"
                  clearable
                  size="large"
                  class="custom-input"
                />
              </el-form-item>

              <el-form-item label="å…¬å¸" prop="staffCompany" class="form-item-animated">
                <template #label>
                  <span class="custom-label">
                    <i class="fas fa-building label-icon"></i> æ‰€å±¬å…¬å¸
                  </span>
                </template>
                <el-input
                  v-model="form.staffCompany"
                  placeholder="è«‹è¼¸å…¥æ‰€å±¬å…¬å¸åç¨±"
                  prefix-icon="OfficeBuilding"
                  clearable
                  size="large"
                  class="custom-input"
                />
              </el-form-item>

              <el-row :gutter="20">
                <el-col :span="12">
                  <el-form-item label="é›»è©±" prop="staffPhone" class="form-item-animated">
                    <template #label>
                      <span class="custom-label">
                        <i class="fas fa-phone label-icon"></i> è¯çµ¡é›»è©±
                      </span>
                    </template>
                    <el-input
                      v-model="form.staffPhone"
                      placeholder="09xx-xxx-xxx"
                      prefix-icon="Phone"
                      clearable
                      size="large"
                      class="custom-input"
                    />
                  </el-form-item>
                </el-col>
                <el-col :span="12">
                  <el-form-item label="Email" prop="staffEmail" class="form-item-animated">
                    <template #label>
                      <span class="custom-label">
                        <i class="fas fa-envelope label-icon"></i> é›»å­éƒµä»¶
                      </span>
                    </template>
                    <el-input
                      v-model="form.staffEmail"
                      placeholder="example@mail.com"
                      prefix-icon="Message"
                      clearable
                      size="large"
                      class="custom-input"
                    />
                  </el-form-item>
                </el-col>
              </el-row>

              <el-form-item label="å‚™è¨»" prop="staffNote" class="form-item-animated">
                <template #label>
                  <span class="custom-label">
                    <i class="fas fa-sticky-note label-icon"></i> å‚™è¨»èªªæ˜
                  </span>
                </template>
                <el-input
                  v-model="form.staffNote"
                  type="textarea"
                  :rows="4"
                  placeholder="å¯å¡«å¯«å°ˆé•·ã€è² è²¬å€åŸŸç­‰è£œå……è³‡è¨Š..."
                  show-word-limit
                  maxlength="500"
                  class="custom-textarea"
                />
              </el-form-item>

              <transition name="fade-slide">
                <el-form-item v-if="isEdit" label="ç‹€æ…‹" prop="isActive" class="status-switch-item">
                  <template #label>
                    <span class="custom-label">
                      <i class="fas fa-toggle-on label-icon"></i> äººå“¡ç‹€æ…‹
                    </span>
                  </template>
                  <div class="status-switch-wrapper">
                    <el-switch
                      v-model="form.isActive"
                      active-text="åœ¨è·"
                      inactive-text="åœç”¨"
                      :active-icon="''"
                      :inactive-icon="''"
                      inline-prompt
                      style="--el-switch-on-color: #67c23a; --el-switch-off-color: #f56c6c"
                      size="large"
                    />
                    <el-tag
                      :type="form.isActive ? 'success' : 'danger'"
                      effect="light"
                      class="status-tag ml-3"
                    >
                      <i :class="form.isActive ? 'fas fa-check-circle' : 'fas fa-ban'"></i>
                      {{ form.isActive ? 'ç›®å‰ç‚ºåœ¨è·ç‹€æ…‹' : 'ç›®å‰ç‚ºåœç”¨ç‹€æ…‹' }}
                    </el-tag>
                  </div>
                </el-form-item>
              </transition>

              <el-divider>
                <i class="fas fa-paper-plane"></i>
              </el-divider>

              <el-form-item class="form-actions">
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    width: 100%;
                    align-items: center;
                  "
                >
                  <div class="left-actions">
                    <el-button
                      type="primary"
                      @click="submitForm"
                      :loading="submitting"
                      size="large"
                      class="submit-btn"
                    >
                      <i class="fas fa-save mr-2" v-if="!submitting"></i>
                      <span>{{ submitting ? 'è™•ç†ä¸­...' : isEdit ? 'æ›´æ–°è³‡æ–™' : 'ç¢ºèªæ–°å¢' }}</span>
                    </el-button>

                    <el-button @click="handleCancel" size="large" class="back-btn ml-3">
                      <i class="fas fa-arrow-left mr-2"></i> è¿”å›åˆ—è¡¨
                    </el-button>
                  </div>

                  <div class="right-actions">
                    <el-button
                      type="warning"
                      link
                      @click="handleDemoFill"
                      style="opacity: 0.6; transition: opacity 0.3s"
                      onmouseover="this.style.opacity=1"
                      onmouseout="this.style.opacity=0.6"
                    >
                      <i class="fas fa-magic mr-1"></i> ä¸€éµå¸¶å…¥
                    </el-button>
                  </div>
                </div>
              </el-form-item>
            </el-form>
          </el-card>
        </transition>
      </div>
    </section>
  </div>
</template>

<style scoped>
.staff-form-container {
  min-height: 100vh;
  background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
  padding-bottom: 40px;
}

.content-header {
  padding: 20px 1rem;
}

/* PageHeader çš„æ¨£å¼å·²ç§»è‡³å…ƒä»¶ä¸­ï¼Œæ­¤è™•åˆªé™¤ */

/* è¡¨å–®å¡ç‰‡ */
.form-card {
  width: 100%;
  max-width: 700px;
  border-radius: 16px;
  overflow: hidden;
  border: none;
  transition: all 0.3s ease;
}

.form-card:hover {
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
}

.card-header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 8px;
}

.header-icon {
  width: 32px;
  height: 32px;
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 14px;
}

.header-text {
  font-weight: 600;
  font-size: 1rem;
  color: #303133;
}

.cancel-btn {
  transition: all 0.3s ease;
}

.cancel-btn:hover {
  transform: translateX(3px);
}

/* è¡¨å–®æ¨£å¼ */
.staff-form {
  padding: 10px 20px;
}

.custom-label {
  display: flex;
  align-items: center;
  gap: 6px;
  font-weight: 500;
  color: #606266;
}

.label-icon {
  color: #409eff;
  font-size: 14px;
}

.required-star {
  color: #f56c6c;
  margin-left: 2px;
}

.form-item-animated {
  animation: fadeInUp 0.5s ease forwards;
  opacity: 0;
}

.form-item-animated:nth-child(1) {
  animation-delay: 0.1s;
}
.form-item-animated:nth-child(2) {
  animation-delay: 0.15s;
}
.form-item-animated:nth-child(3) {
  animation-delay: 0.2s;
}
.form-item-animated:nth-child(4) {
  animation-delay: 0.25s;
}
.form-item-animated:nth-child(5) {
  animation-delay: 0.3s;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.custom-input :deep(.el-input__wrapper) {
  border-radius: 10px;
  transition: all 0.3s ease;
}

.custom-input :deep(.el-input__wrapper):hover {
  box-shadow: 0 0 0 1px #409eff inset;
}

.custom-input :deep(.el-input__wrapper.is-focus) {
  box-shadow: 0 0 0 2px rgba(64, 158, 255, 0.3) inset;
}

.custom-textarea :deep(.el-textarea__inner) {
  border-radius: 10px;
  transition: all 0.3s ease;
}

.custom-textarea :deep(.el-textarea__inner):hover {
  box-shadow: 0 0 0 1px #409eff inset;
}

/* ç‹€æ…‹åˆ‡æ› */
.status-switch-wrapper {
  display: flex;
  align-items: center;
  padding: 12px 16px;
  background: #f5f7fa;
  border-radius: 10px;
}

.status-tag {
  display: flex;
  align-items: center;
  gap: 6px;
}

/* æŒ‰éˆ•å€ */
.form-actions {
  margin-top: 20px;
}

.submit-btn {
  min-width: 140px;
  border-radius: 10px;
  font-weight: 600;
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
  border: none;
  transition: all 0.3s ease;
}

.submit-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(64, 158, 255, 0.4);
}

.back-btn {
  min-width: 120px;
  border-radius: 10px;
  transition: all 0.3s ease;
}

.back-btn:hover {
  transform: translateX(-3px);
}

/* éæ¸¡å‹•ç•« */
.slide-fade-enter-active {
  transition: all 0.4s ease-out;
}
.slide-fade-leave-active {
  transition: all 0.3s ease-in;
}
.slide-fade-enter-from {
  transform: translateX(-20px);
  opacity: 0;
}
.slide-fade-leave-to {
  transform: translateX(20px);
  opacity: 0;
}

.zoom-fade-enter-active {
  transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.zoom-fade-leave-active {
  transition: all 0.3s ease-in;
}
.zoom-fade-enter-from {
  transform: scale(0.9);
  opacity: 0;
}
.zoom-fade-leave-to {
  transform: scale(0.95);
  opacity: 0;
}

.fade-slide-enter-active,
.fade-slide-leave-active {
  transition: all 0.3s ease;
}
.fade-slide-enter-from,
.fade-slide-leave-to {
  opacity: 0;
  transform: translateY(-10px);
}

/* Element Plus åˆ†éš”ç·š */
:deep(.el-divider__text) {
  background: white;
  color: #c0c4cc;
}
</style>
</file>

<file path="frontend/src/views/maintenance/MtifForm.vue">
<script setup>
import { ref, onMounted, reactive, computed, watch } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import maintenanceApi from '@/api/modules/maintenance'
import Swal from 'sweetalert2'
import { useTicketConfig } from '@/composables/maintenance/useTicketConfig'
import TicketTimeline from '@/components/maintenance/TicketTimeline.vue'
import { ElMessage } from 'element-plus'

const route = useRoute()
const router = useRouter()
const ticketId = computed(() => Number(route.params.id))
const isEdit = computed(() => !isNaN(ticketId.value) && ticketId.value > 0)

const formRef = ref(null)
const timelineRef = ref(null)
const loading = ref(false)
const submitting = ref(false)
const formVisible = ref(false)
const activeStep = ref(0)

// ============ åœ–ç‰‡é™„ä»¶ç›¸é—œ ============
const uploadRef = ref(null) // el-upload ref
const attachments = ref([]) // å·²ä¸Šå‚³çš„é™„ä»¶æ¸…å–®
const fileList = ref([]) // å¾…ä¸Šå‚³çš„æª”æ¡ˆæ¸…å–®ï¼ˆæ–°å¢æ¨¡å¼æš«å­˜ï¼‰
const attachmentNote = ref('') // é™„ä»¶å‚™è¨»
const uploadingAttachments = ref(false) // ä¸Šå‚³ä¸­ç‹€æ…‹
const showAttachmentSection = ref(false) // æ˜¯å¦é¡¯ç¤ºé™„ä»¶å€å¡Šï¼ˆç·¨è¼¯æ¨¡å¼ç«‹å³é¡¯ç¤ºï¼Œæ–°å¢æ¨¡å¼åœ¨å»ºå–®å¾Œé¡¯ç¤ºï¼‰

// å…è¨±çš„åœ–ç‰‡é¡å‹
const ALLOWED_IMAGE_TYPES = ['image/jpeg', 'image/png', 'image/webp']
const MAX_FILE_SIZE = 5 * 1024 * 1024 // 5MB
const MAX_FILE_COUNT = 5

// ç¶­ä¿®ç›®æ¨™é¡å‹ï¼š'spot' (æ©Ÿå°) æˆ– 'seat' (æ¤…å­)
const targetType = ref('spot')

const form = reactive({
  spotId: null,
  seatsId: null, // æ–°å¢ï¼šæ¤…å­ ID
  issueType: '',
  issueDesc: '',
  issuePriority: 'NORMAL',
  assignedStaffId: null,
})

const staffOptions = ref([])
const spotOptions = ref([])
const seatOptions = ref([]) // æ–°å¢ï¼šæ¤…å­é¸é …

const STAFF_UI_STATUS = Object.freeze({
  IDLE: 'IDLE',
  ASSIGNED: 'ASSIGNED',
  MAINTENANCE: 'MAINTENANCE',
  MAINTAINING: 'MAINTAINING',
})

const staffUiStatusMap = ref({}) // { [staffId]: STAFF_UI_STATUS.* }

const getStaffUiTag = (staff) => {
  const st = staffUiStatusMap.value?.[staff.staffId] || STAFF_UI_STATUS.IDLE
  if (st === STAFF_UI_STATUS.MAINTAINING) return { type: 'danger', text: 'ä¿é¤Šä¸­' }
  if (st === STAFF_UI_STATUS.MAINTENANCE) return { type: 'warning', text: 'ç¶­ä¿®ä¸­' }
  if (st === STAFF_UI_STATUS.ASSIGNED) return { type: 'primary', text: 'å·²æŒ‡æ´¾' }
  return { type: 'success', text: 'ç©ºé–’ä¸­' }
}

// å–å¾—é€²è¡Œä¸­å·¥å–®ï¼šå„ªå…ˆç”¨ active ç«¯é»ï¼›è‹¥åªæœ‰ allï¼Œå°±å‰ç«¯éæ¿¾
const fetchActiveTicketsForStaffStatus = async () => {
  const tryCalls = [
    () => maintenanceApi.getActiveTickets?.(),
    () => maintenanceApi.getTicketsActive?.(),
    () => maintenanceApi.getAllTickets?.(),
    () => maintenanceApi.getTicketsAll?.(),
  ]

  for (const call of tryCalls) {
    try {
      const res = await call()
      if (Array.isArray(res?.data)) return res.data
    } catch (e) {
      // ignore
    }
  }
  return []
}

const refreshStaffStatusTags = async () => {
  if (!Array.isArray(staffOptions.value) || staffOptions.value.length === 0) return

  const tickets = await fetchActiveTicketsForStaffStatus()

  // åªçœ‹æœƒå½±éŸ¿äººå“¡ç‹€æ…‹çš„ã€Œé€²è¡Œä¸­ã€ç‹€æ…‹
  const active = (tickets || []).filter((t) => {
    const s = String(t?.issueStatus || '')
      .trim()
      .toUpperCase()
    return s === 'ASSIGNED' || s === 'UNDER_MAINTENANCE'
  })

  // å„ªå…ˆç´šï¼šä¿é¤Šä¸­ > ç¶­ä¿®ä¸­ > å·²æŒ‡æ´¾ > ç©ºé–’ä¸­
  const map = {}
  const priority = {
    [STAFF_UI_STATUS.IDLE]: 0,
    [STAFF_UI_STATUS.ASSIGNED]: 1,
    [STAFF_UI_STATUS.MAINTENANCE]: 2,
    [STAFF_UI_STATUS.MAINTAINING]: 3,
  }
  const setIfHigher = (staffId, next) => {
    if (!staffId) return
    const cur = map[staffId] || STAFF_UI_STATUS.IDLE
    if (priority[next] > priority[cur]) map[staffId] = next
  }

  // defaultï¼šå•Ÿç”¨äººå“¡å…ˆç•¶ç©ºé–’
  for (const s of staffOptions.value) {
    if (s?.staffId != null && s.isActive === true) map[s.staffId] = STAFF_UI_STATUS.IDLE
  }

  for (const t of active) {
    const staffId = t.assignedStaffId
    if (!staffId) continue

    const issueStatus = String(t.issueStatus || '')
      .trim()
      .toUpperCase()
    const issueType = String(t.issueType || '').trim()

    if (issueType === 'ä¿é¤Š') {
      // ä¿é¤Šä¸­ï¼šåªè¦æ˜¯ä¿é¤Šå·¥å–®ä¸”å·²æŒ‡æ´¾/é€²è¡Œä¸­
      setIfHigher(staffId, STAFF_UI_STATUS.MAINTAINING)
    } else if (issueStatus === 'UNDER_MAINTENANCE') {
      setIfHigher(staffId, STAFF_UI_STATUS.MAINTENANCE)
    } else if (issueStatus === 'ASSIGNED') {
      setIfHigher(staffId, STAFF_UI_STATUS.ASSIGNED)
    }
  }

  staffUiStatusMap.value = map
}
// ========= [æ–°å¢çµæŸ] =========

// â˜… Bug3 ä¿®å¾©ï¼šè¨˜éŒ„ç·¨è¼¯æ™‚åŸå§‹çš„ assignedStaffIdï¼Œç”¨æ–¼åˆ¤æ–·æ˜¯å¦æœ‰è®Šæ›´
const originalAssignedStaffId = ref(null)

// â˜… Bug3 ä¿®å¾©ï¼šå®šç¾©å¯ç·¨è¼¯çš„ç‹€æ…‹
const EDITABLE_STATUSES = ['REPORTED', 'ASSIGNED']

// åŸä¾†å®šç¾©çš„ issueTypeOptions
// const { issueTypeOptions: sharedIssueTypes } = useTicketConfig()
// const issueTypeOptions = sharedIssueTypes

//ä¿®æ”¹ï¼šä½¿ç”¨ computed éæ¿¾æ‰ "ä¿é¤Š"
const { issueTypeOptions: sharedIssueTypes } = useTicketConfig()

const issueTypeOptions = computed(() => {
  // å‡è¨­ sharedIssueTypes æ˜¯ä¸€å€‹ Ref é™£åˆ—
  // éæ¿¾æ¢ä»¶ï¼švalue ä¸ç­‰æ–¼ 'ä¿é¤Š' (æˆ–æ˜¯çœ‹æ‚¨çš„ config è£¡æ˜¯ç”¨ key é‚„æ˜¯ valueï¼Œé€šå¸¸æ˜¯ value)
  return (sharedIssueTypes.value || sharedIssueTypes).filter((t) => t.value !== 'ä¿é¤Š')
})

// å„ªå…ˆç´šé…ç½®ï¼ˆæ“´å±•ç‰ˆï¼Œå«æè¿°ï¼‰
const priorityConfig = {
  LOW: { color: '#909399', bgColor: '#f4f4f5', icon: 'ğŸ”µ', text: 'ä½å„ªå…ˆ', desc: 'å¯ç¨å¾Œè™•ç†' },
  NORMAL: { color: '#409eff', bgColor: '#ecf5ff', icon: 'ğŸŸ¢', text: 'æ™®é€š', desc: 'æ­£å¸¸æ’ç¨‹è™•ç†' },
  HIGH: { color: '#e6a23c', bgColor: '#fdf6ec', icon: 'ğŸŸ ', text: 'é«˜å„ªå…ˆ', desc: 'å„ªå…ˆå®‰æ’è™•ç†' },
  URGENT: { color: '#f56c6c', bgColor: '#fef0f0', icon: 'ğŸ”´', text: 'ç·Šæ€¥', desc: 'ç«‹å³è™•ç†' },
}

// é©—è­‰è¦å‰‡
const rules = computed(() => ({
  spotId:
    targetType.value === 'spot'
      ? [{ required: true, message: 'è«‹é¸æ“‡ä¸€å€‹æ©Ÿå°', trigger: 'change' }]
      : [],
  seatsId:
    targetType.value === 'seat'
      ? [{ required: true, message: 'è«‹é¸æ“‡ä¸€å¼µæ¤…å­', trigger: 'change' }]
      : [],
  issueType: [{ required: true, message: 'è«‹è¼¸å…¥æˆ–é¸æ“‡å•é¡Œé¡å‹', trigger: 'blur' }],
  issuePriority: [{ required: true, message: 'è«‹é¸æ“‡å„ªå…ˆç´š', trigger: 'change' }],
}))

// è¨ˆç®—è¡¨å–®å®Œæˆåº¦
const formProgress = computed(() => {
  let filled = 0
  if (targetType.value === 'spot' ? form.spotId : form.seatsId) filled++
  if (form.issueType) filled++
  if (form.issueDesc) filled++
  if (form.assignedStaffId) filled++
  return Math.round((filled / 4) * 100)
})

// ç›£è½è¡¨å–®è®ŠåŒ–ï¼Œè‡ªå‹•æ›´æ–°æ­¥é©ŸæŒ‡ç¤º
watch(
  () => (targetType.value === 'spot' ? form.spotId : form.seatsId),
  (val) => {
    if (val && activeStep.value === 0) activeStep.value = 1
  },
)
watch(
  () => form.issueType,
  (val) => {
    if (val && activeStep.value === 1) activeStep.value = 2
  },
)

// åˆ‡æ›ç¶­ä¿®é¡å‹æ™‚ï¼Œæ¸…ç©ºå·²é¸æ“‡çš„ç›®æ¨™
watch(targetType, (newType) => {
  if (newType === 'spot') {
    form.seatsId = null
  } else {
    form.spotId = null
  }
})

onMounted(async () => {
  setTimeout(() => (formVisible.value = true), 100)

  loading.value = true
  try {
    // â˜… Bug3 ä¿®å¾©ï¼šå…ˆè®€å–å·¥å–®è³‡æ–™ï¼Œæª¢æŸ¥ç‹€æ…‹æ˜¯å¦å¯ç·¨è¼¯
    if (isEdit.value) {
      const ticketRes = await maintenanceApi.getTicketById(ticketId.value)
      const ticketData = ticketRes.data

      // â˜… å•é¡ŒAä¿®å¾©ï¼šä½¿ç”¨æ­£ç¢ºçš„æ¬„ä½åç¨± issueStatus
      if (!EDITABLE_STATUSES.includes(ticketData.issueStatus)) {
        await Swal.fire({
          icon: 'warning', // â˜… (2B) æ”¹ç‚º warningï¼Œä¸æ˜¯ç³»çµ±éŒ¯èª¤
          title: 'ç„¡æ³•ç·¨è¼¯',
          html: `
            <p style="color: #909399;">æ­¤å·¥å–®ç‹€æ…‹ç‚ºã€Œ<b>${ticketData.issueStatus}</b>ã€ï¼Œä¸å…è¨±ç·¨è¼¯</p>
            <p style="color: #f56c6c; font-size: 13px; margin-top: 10px;">å¯ç·¨è¼¯ç‹€æ…‹ï¼šREPORTED, ASSIGNED</p>
          `,
          confirmButtonText: 'è¿”å›åˆ—è¡¨',
        })
        router.push({ name: 'mtif-list' })
        return
      }

      // â˜… Bug3 ä¿®å¾©ï¼šè¨˜éŒ„åŸå§‹ assignedStaffId
      originalAssignedStaffId.value = ticketData.assignedStaffId

      // è¼‰å…¥å…¶ä»–è³‡æ–™
      const [spotRes, staffRes, seatRes] = await Promise.all([
        maintenanceApi.getAllSpots().catch(() => ({ data: [] })),
        maintenanceApi.getAllStaff().catch(() => ({ data: [] })), // ç·¨è¼¯æ™‚ç”¨ getAllStaff
        maintenanceApi.getAllSeats().catch(() => ({ data: [] })),
      ])

      spotOptions.value = Array.isArray(spotRes.data) ? spotRes.data : []
      staffOptions.value = staffRes.data || []
      await refreshStaffStatusTags()
      seatOptions.value = seatRes.data || []

      // â˜… å¦‚æœåŸå§‹äººå“¡å·²åœç”¨ï¼Œè¦ä¿ç•™ä¸¦é¡¯ç¤ºç‚º disabled
      if (ticketData.assignedStaffId) {
        const assignedStaff = staffOptions.value.find(
          (s) => s.staffId === ticketData.assignedStaffId,
        )
        if (assignedStaff && !assignedStaff.isActive) {
          assignedStaff.staffName = assignedStaff.staffName + ' (å·²åœç”¨)'
          assignedStaff.disabled = true
        }
      }

      // è³¦å€¼è¡¨å–®
      Object.assign(form, ticketData)
      // æ ¹æ“šè³‡æ–™åˆ¤æ–·ç¶­ä¿®é¡å‹
      if (ticketData.seatsId) {
        targetType.value = 'seat'
      } else {
        targetType.value = 'spot'
      }
      activeStep.value = 3

      // === [ç·¨è¼¯æ¨¡å¼] è¼‰å…¥é™„ä»¶æ¸…å–® ===
      showAttachmentSection.value = true
      await loadAttachments(ticketId.value)
    } else {
      // â˜… Bug2 ä¿®å¾©ï¼šå»ºç«‹æ™‚åªè¼‰å…¥å•Ÿç”¨äººå“¡
      const [spotRes, staffRes, seatRes] = await Promise.all([
        maintenanceApi.getAllSpots().catch(() => ({ data: [] })),
        maintenanceApi.getActiveStaff().catch(() => ({ data: [] })), // â˜… æ”¹ç”¨ getActiveStaff
        maintenanceApi.getAllSeats().catch(() => ({ data: [] })),
      ])

      spotOptions.value = Array.isArray(spotRes.data) ? spotRes.data : []
      staffOptions.value = staffRes.data || []
      await refreshStaffStatusTags()
      seatOptions.value = seatRes.data || []

      if (spotOptions.value.length > 0) form.spotId = spotOptions.value[0].spotId
    }
  } catch (error) {
    console.error('Failed to load form data:', error)
    Swal.fire('éŒ¯èª¤', 'è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error')
    router.push({ name: 'mtif-list' })
  } finally {
    loading.value = false
  }
})

const selectIssueType = (type) => {
  form.issueType = type.value
}

// ============ åœ–ç‰‡é™„ä»¶åŠŸèƒ½ ============

/**
 * è¼‰å…¥å·¥å–®é™„ä»¶æ¸…å–®
 */
const loadAttachments = async (ticketIdValue) => {
  try {
    const res = await maintenanceApi.getTicketAttachments(ticketIdValue)
    attachments.value = res.data || []
  } catch (error) {
    console.error('è¼‰å…¥é™„ä»¶å¤±æ•—:', error)
  }
}

/**
 * æª”æ¡ˆä¸Šå‚³å‰æª¢æŸ¥
 */
const beforeUpload = (file) => {
  // æª¢æŸ¥æª”æ¡ˆé¡å‹
  if (!ALLOWED_IMAGE_TYPES.includes(file.type)) {
    ElMessage.error(`ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼ï¼š${file.name}ï¼ˆåƒ…å…è¨± JPG, PNG, WEBPï¼‰`)
    return false
  }

  // æª¢æŸ¥æª”æ¡ˆå¤§å°
  if (file.size > MAX_FILE_SIZE) {
    ElMessage.error(`æª”æ¡ˆéå¤§ï¼š${file.name}ï¼ˆæœ€å¤§ 5MBï¼‰`)
    return false
  }

  // æª¢æŸ¥æ•¸é‡é™åˆ¶
  const currentCount = isEdit.value ? attachments.value.length : fileList.value.length
  if (currentCount >= MAX_FILE_COUNT) {
    ElMessage.error(`æœ€å¤šåªèƒ½ä¸Šå‚³ ${MAX_FILE_COUNT} å¼µåœ–ç‰‡`)
    return false
  }

  return true
}

/**
 * æª”æ¡ˆé¸æ“‡è®Šæ›´ï¼ˆæ–°å¢æ¨¡å¼ï¼šæš«å­˜åˆ° fileListï¼‰
 */
const handleFileChange = (file, uploadFileList) => {
  if (isEdit.value) {
    // ç·¨è¼¯æ¨¡å¼ï¼šç›´æ¥ä¸Šå‚³
    uploadAttachmentsToServer([file.raw])
  } else {
    // æ–°å¢æ¨¡å¼ï¼šæš«å­˜åˆ° fileList
    fileList.value = uploadFileList
  }
}

/**
 * ç§»é™¤æª”æ¡ˆï¼ˆæ–°å¢æ¨¡å¼ï¼šå¾ fileList ç§»é™¤ï¼‰
 */
const handleRemoveFile = (file) => {
  const index = fileList.value.findIndex(f => f.uid === file.uid)
  if (index > -1) {
    fileList.value.splice(index, 1)
  }
}

/**
 * ä¸Šå‚³é™„ä»¶åˆ°ä¼ºæœå™¨
 */
const uploadAttachmentsToServer = async (files) => {
  if (!files || files.length === 0) return

  uploadingAttachments.value = true
  try {
    const res = await maintenanceApi.uploadTicketAttachments(
      ticketId.value,
      files,
      attachmentNote.value || null
    )

    ElMessage.success(`æˆåŠŸä¸Šå‚³ ${res.data.length} å¼µåœ–ç‰‡`)
    
    // é‡æ–°è¼‰å…¥é™„ä»¶æ¸…å–®
    await loadAttachments(ticketId.value)
    
    // æ¸…ç©ºå‚™è¨»èˆ‡ fileList
    attachmentNote.value = ''
    fileList.value = []
    
    // æ¸…ç©º el-upload çš„ fileList
    if (uploadRef.value) {
      uploadRef.value.clearFiles()
    }
  } catch (error) {
    console.error('ä¸Šå‚³é™„ä»¶å¤±æ•—:', error)
    const errorMsg = error?.response?.data?.message || 'ä¸Šå‚³å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦'
    ElMessage.error(errorMsg)
  } finally {
    uploadingAttachments.value = false
  }
}

/**
 * åˆªé™¤é™„ä»¶
 */
const deleteAttachment = async (attachment) => {
  const result = await Swal.fire({
    title: 'ç¢ºèªåˆªé™¤åœ–ç‰‡ï¼Ÿ',
    text: `å°‡åˆªé™¤åœ–ç‰‡ï¼š${attachment.originalName}`,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#f56c6c',
    cancelButtonColor: '#909399',
    confirmButtonText: '<i class="fas fa-trash-alt mr-1"></i> ç¢ºèªåˆªé™¤',
    cancelButtonText: 'å–æ¶ˆ',
  })

  if (!result.isConfirmed) return

  try {
    await maintenanceApi.deleteTicketAttachment(attachment.attachmentId)
    ElMessage.success('åœ–ç‰‡å·²åˆªé™¤')
    
    // é‡æ–°è¼‰å…¥é™„ä»¶æ¸…å–®
    await loadAttachments(ticketId.value)
  } catch (error) {
    console.error('åˆªé™¤é™„ä»¶å¤±æ•—:', error)
    const errorMsg = error?.response?.data?.message || 'åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦'
    Swal.fire('éŒ¯èª¤', errorMsg, 'error')
  }
}

/**
 * é è¦½åœ–ç‰‡
 */
const previewImage = (attachment) => {
  Swal.fire({
    imageUrl: `http://localhost:8080${attachment.publicUrl}`,
    imageAlt: attachment.originalName,
    showCloseButton: true,
    showConfirmButton: false,
    width: 'auto',
  })
}

const submit = async () => {
  if (!formRef.value) return

  await formRef.value.validate(async (valid) => {
    if (valid) {
      // 1. å–å¾—é¸ä¸­çš„äººå“¡åç¨± (ç‚ºäº†é¡¯ç¤ºç¢ºèªçª—)
      const selectedStaff = staffOptions.value.find((s) => s.staffId === form.assignedStaffId)

      // 2. é¡¯ç¤ºç¢ºèªè¦–çª—
      const confirmResult = await Swal.fire({
        title: isEdit.value ? 'ç¢ºèªæ›´æ–°å·¥å–®ï¼Ÿ' : 'ç¢ºèªå»ºç«‹å·¥å–®ï¼Ÿ',
        html: `
          <div style="text-align: left; padding: 10px 0;">
            <div style="display: grid; gap: 12px;">
              <div style="padding: 12px; background: #f5f7fa; border-radius: 10px;">
                <p style="margin: 0 0 8px; color: #909399; font-size: 12px;">å•é¡Œé¡å‹</p>
                <p style="margin: 0; font-size: 16px; font-weight: 600;">${form.issueType}</p>
              </div>
              <div style="padding: 12px; background: ${priorityConfig[form.issuePriority].bgColor}; border-radius: 10px; border-left: 4px solid ${priorityConfig[form.issuePriority].color};">
                <p style="margin: 0 0 8px; color: #909399; font-size: 12px;">å„ªå…ˆç´š</p>
                <p style="margin: 0; font-size: 16px; font-weight: 600; color: ${priorityConfig[form.issuePriority].color};">
                   ${priorityConfig[form.issuePriority].icon} ${priorityConfig[form.issuePriority].text}
                </p>
              </div>
              ${
                selectedStaff
                  ? `
              <div style="padding: 12px; background: #f0f9eb; border-radius: 10px;">
                <p style="margin: 0 0 8px; color: #909399; font-size: 12px;">æŒ‡æ´¾äººå“¡</p>
                <p style="margin: 0; font-size: 16px; font-weight: 600; color: #67c23a;">
                  <i class="fas fa-user-check mr-1"></i> ${selectedStaff.staffName}
                </p>
              </div>
              `
                  : ''
              }
            </div>
          </div>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#409eff',
        cancelButtonColor: '#909399',
        confirmButtonText: '<i class="fas fa-paper-plane mr-1"></i> ç¢ºèªé€å‡º',
        cancelButtonText: 'å†æª¢æŸ¥ä¸€ä¸‹',
      })

      if (!confirmResult.isConfirmed) return

      submitting.value = true
      try {
        // â˜… é—œéµä¿®æ­£ï¼šè³‡æ–™æ¸…æ´—ï¼ˆå®Œæ•´ç‰ˆï¼‰
        // å»ºç«‹ä¸€å€‹ä¹¾æ·¨çš„ç‰©ä»¶ï¼ŒåªåŒ…å«å¾Œç«¯éœ€è¦çš„æ¬„ä½
        const submitData = {
          spotId: form.spotId,
          seatsId: form.seatsId,
          issueType: form.issueType,
          issueDesc: form.issueDesc,
          issuePriority: form.issuePriority,
          assignedStaffId: form.assignedStaffId,
        }

        // æ ¹æ“šç¶­ä¿®é¡å‹æ¸…é™¤ä¸éœ€è¦çš„æ¬„ä½
        if (targetType.value === 'spot') {
          submitData.seatsId = null
        } else if (targetType.value === 'seat') {
          submitData.spotId = null
        }

        if (isEdit.value) {
          // === [æ›´æ–°æ¨¡å¼] ===
          // â˜… å•é¡Œ3ä¿®å¾©ï¼šå¾Œç«¯ updateTicket å·²ç¶“è™•ç† assignedStaffId çš„æ›´æ–°èˆ‡ Log ç´€éŒ„
          // ä¸éœ€è¦é¡å¤–å‘¼å« assignStaff APIï¼Œå®Œå…¨ä¾è³´ updateTicket å³å¯
          await maintenanceApi.updateTicket(ticketId.value, submitData)

          await Swal.fire({
            icon: 'success',
            title: 'æ›´æ–°æˆåŠŸï¼',
            text: 'å·¥å–®è³‡æ–™å·²æ›´æ–°',
            timer: 1200,
            showConfirmButton: false,
          })

          // ç·¨è¼¯æ¨¡å¼ä¸è·³è½‰ï¼Œç•™åœ¨ç•¶å‰é é¢ï¼ˆå¯ç¹¼çºŒç®¡ç†é™„ä»¶ï¼‰
        } else {
          // === [æ–°å¢æ¨¡å¼] ===
          const createRes = await maintenanceApi.createTicket(submitData)
          const newTicketId = createRes.data?.ticketId

          await Swal.fire({
            icon: 'success',
            title: 'å»ºç«‹æˆåŠŸï¼',
            text: 'æ–°å·¥å–®å·²å»ºç«‹',
            timer: 1500,
            showConfirmButton: false,
          })

          // å¦‚æœæœ‰é¸æ“‡æª”æ¡ˆï¼Œä¸Šå‚³é™„ä»¶
          if (fileList.value.length > 0 && newTicketId) {
            try {
              const files = fileList.value.map(f => f.raw)
              await maintenanceApi.uploadTicketAttachments(
                newTicketId,
                files,
                attachmentNote.value || null
              )
              ElMessage.success(`æˆåŠŸä¸Šå‚³ ${files.length} å¼µåœ–ç‰‡`)
            } catch (error) {
              console.error('ä¸Šå‚³é™„ä»¶å¤±æ•—:', error)
              ElMessage.warning('å·¥å–®å·²å»ºç«‹ï¼Œä½†é™„ä»¶ä¸Šå‚³å¤±æ•—')
            }
          }

          // è·³è½‰å›åˆ—è¡¨é 
          router.push({ name: 'mtif-list' })
        }
      } catch (error) {
        console.error('Submit failed:', error)
        // â˜… Bug3 ä¿®å¾©ï¼šé¡¯ç¤ºå¾Œç«¯å›å‚³çš„éŒ¯èª¤è¨Šæ¯
        const errorMsg = error?.response?.data?.message || 'æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦'
        Swal.fire('éŒ¯èª¤', errorMsg, 'error')
      } finally {
        submitting.value = false
      }
    }
  })
}

// âœ… DEMO å°ˆç”¨ï¼šä¸€éµå¸¶å…¥æ•…éšœå·¥å–®
const handleDemoFill = () => {
  // 1. è¨­å®šç‚ºæ©Ÿå°æ¨¡å¼
  targetType.value = 'spot'

  // 2. 2. è‡ªå‹•é¸å–ç¬¬ä¸€å€‹ "ç‡Ÿé‹ä¸­" çš„æ©Ÿå° (ä¿®æ­£é‚è¼¯ï¼šè·³éç¶­ä¿®ä¸­æ©Ÿå°)
  if (spotOptions.value && spotOptions.value.length > 0) {
    // å–å¾—ç¬¬ä¸€å€‹ç‡Ÿé‹ä¸­æ©Ÿå°
    const availableSpot = spotOptions.value.find((s) => s.spotStatus === 'ç‡Ÿé‹ä¸­')

    // å¦‚æœæ‰¾åˆ°ï¼Œå¸¶å…¥ï¼›å¦å‰‡é¡¯ç¤ºæç¤º
    if (availableSpot) {
      form.spotId = availableSpot.spotId
    } else {
      // å¦‚æœå…¨éƒ¨éƒ½åœ¨ç¶­ä¿®ä¸­ï¼Œé¡¯ç¤ºæç¤º
      Swal.fire({
        icon: 'warning',
        title: 'ç„¡å¯é¸æ“‡çš„æ©Ÿå°',
        text: 'ç›®å‰æ‰€æœ‰æ©Ÿå°çš†åœ¨ç¶­ä¿®ä¸­',
        toast: true,
        position: 'top-end',
        timer: 900,
      })
      return // çµ‚æ­¢
    }
  }

  // 3. å¡«å¯«æ•…éšœæƒ…å¢ƒ
  form.issueType = 'æ©Ÿå°æ•…éšœç•°å¸¸' // ç¢ºä¿é€™å€‹æ–‡å­—è·ŸæŒ‰éˆ•ä¸Šçš„ value ä¸€æ¨£
  form.issueDesc = 'æ©Ÿå°é‹ä½œæ™‚ç™¼å‡ºç•°éŸ³ï¼Œä¸”è¢å¹•ç•«é¢é–ƒçˆï¼Œç›®å‰å·²å…ˆæš«åœä½¿ç”¨ï¼Œè«‹ç›¡å¿«æ´¾äººå“¡ä¾†åšæª¢æŸ¥ã€‚'
  form.issuePriority = 'HIGH' // è¨­å®šç‚ºé«˜å„ªå…ˆ

  // 4. (é¸å¡«) æŒ‡æ´¾çµ¦ç¬¬ä¸€å€‹å•Ÿç”¨çš„äººå“¡
  const activeStaff = staffOptions.value.find((s) => s.isActive)
  if (activeStaff) {
    form.assignedStaffId = activeStaff.staffId
  }

  // 5. æç¤º
  Swal.fire({
    icon: 'success',
    title: 'æ–°å¢è³‡æ–™æˆåŠŸ',
    text: 'è³‡æ–™å·²å¸¶å…¥',
    timer: 1500,
    showConfirmButton: false,
    toast: true,
    position: 'top-end',
  })
}

const handleCancel = async () => {
  if (form.issueType || form.issueDesc) {
    const result = await Swal.fire({
      title: 'ç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ',
      text: 'æ‚¨å¡«å¯«çš„å·¥å–®è³‡æ–™å°‡ä¸æœƒè¢«ä¿å­˜',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#e6a23c',
      cancelButtonColor: '#909399',
      confirmButtonText: 'é›¢é–‹',
      cancelButtonText: 'ç¹¼çºŒç·¨è¼¯',
      showClass: { popup: 'animate__animated animate__fadeIn animate__faster' },
    })
    if (!result.isConfirmed) return
  }
  router.push('/admin/mtif-list')
}
</script>

<template>
  <div class="ticket-form-container">
    <!-- é é¢æ¨™é¡Œå€ -->
    <section class="content-header">
      <div class="container-fluid">
        <transition name="slide-fade" appear>
          <div class="page-title-box">
            <div class="title-icon" :class="isEdit ? 'edit-mode' : 'add-mode'">
              <i :class="isEdit ? 'fas fa-ticket-alt' : 'fas fa-plus-circle'"></i>
            </div>
            <div class="title-content">
              <h1>{{ isEdit ? 'ç·¨è¼¯ç¶­ä¿®å·¥å–®' : 'å»ºç«‹æ–°å·¥å–®' }}</h1>
              <p class="subtitle">
                {{ isEdit ? 'ä¿®æ”¹ç¾æœ‰å·¥å–®è³‡è¨Š' : 'å¡«å¯«å•é¡Œè©³æƒ…ä»¥å»ºç«‹ç¶­ä¿®å·¥å–®' }}
              </p>
            </div>
            <div class="title-progress" v-if="!isEdit">
              <div class="progress-ring">
                <el-progress
                  type="circle"
                  :percentage="formProgress"
                  :width="60"
                  :stroke-width="6"
                  :color="formProgress === 100 ? '#67c23a' : '#409eff'"
                />
              </div>
              <span class="progress-text">å®Œæˆåº¦</span>
            </div>
          </div>
        </transition>
      </div>
    </section>

    <!-- è¡¨å–®ä¸»é«” -->
    <section class="content">
      <div class="container-fluid d-flex justify-content-center">
        <transition name="zoom-fade" appear>
          <el-card
            v-show="formVisible"
            shadow="hover"
            class="form-card"
            v-loading="loading"
            element-loading-text="è¼‰å…¥ä¸­..."
          >
            <template #header>
              <div class="card-header-content">
                <div class="header-left">
                  <span class="header-icon">
                    <i class="fas fa-clipboard-list"></i>
                  </span>
                  <span class="header-text">å·¥å–®è³‡è¨Š</span>
                  <el-tag v-if="isEdit" type="warning" effect="plain" size="small" class="ml-2">
                    #{{ ticketId }}
                  </el-tag>
                </div>
                <el-button class="cancel-btn" text type="info" @click="handleCancel">
                  <i class="fas fa-times mr-1"></i> å–æ¶ˆ
                </el-button>
              </div>
            </template>

            <!-- æ­¥é©ŸæŒ‡ç¤ºå™¨ -->
            <div class="steps-indicator" v-if="!isEdit">
              <el-steps :active="activeStep" finish-status="success" simple>
                <el-step title="é¸æ“‡å ´åœ°" icon="Location" />
                <el-step title="å•é¡Œæè¿°" icon="Edit" />
                <el-step title="è¨­å®šå„ªå…ˆç´š" icon="Flag" />
                <el-step title="æŒ‡æ´¾äººå“¡" icon="User" />
              </el-steps>
            </div>

            <el-form
              ref="formRef"
              :model="form"
              :rules="rules"
              label-position="top"
              status-icon
              class="ticket-form"
            >
              <!-- ç¶­ä¿®ç›®æ¨™é¡å‹åˆ‡æ› -->
              <el-form-item class="form-item-animated">
                <template #label>
                  <span class="custom-label">
                    <i class="fas fa-wrench label-icon"></i> ç¶­ä¿®ç›®æ¨™
                    <span class="required-star">*</span>
                  </span>
                </template>
                <div class="target-type-switch">
                  <div
                    class="target-type-option"
                    :class="{ active: targetType === 'spot' }"
                    @click="targetType = 'spot'"
                  >
                    <i class="fas fa-desktop"></i>
                    <span>æ©Ÿå°</span>
                  </div>
                  <div
                    class="target-type-option"
                    :class="{ active: targetType === 'seat' }"
                    @click="targetType = 'seat'"
                  >
                    <i class="fas fa-chair"></i>
                    <span>æ¤…å­</span>
                  </div>
                </div>
              </el-form-item>

              <!-- æ©Ÿå°é¸æ“‡ (ç•¶ targetType === 'spot') -->
              <el-form-item
                v-if="targetType === 'spot'"
                label="å ´åœ°é¸æ“‡"
                prop="spotId"
                class="form-item-animated"
              >
                <template #label>
                  <span class="custom-label">
                    <i class="fas fa-desktop label-icon"></i> é¸æ“‡æ©Ÿå°
                    <span class="required-star">*</span>
                  </span>
                </template>
                <el-select
                  v-model="form.spotId"
                  placeholder="è«‹é¸æ“‡æˆ–æœå°‹æ©Ÿå°..."
                  class="w-100"
                  filterable
                  :disabled="isEdit"
                  size="large"
                  popper-class="mt-spot-select-popper"
                >
                  <template #prefix>
                    <i class="fas fa-search"></i>
                  </template>

                  <el-option
                    v-for="spot in spotOptions"
                    :key="spot.spotId"
                    :label="`${spot.spotCode || spot.spotId} - ${spot.spotName} (${spot.spotStatus || 'æœªçŸ¥'})`"
                    :value="spot.spotId"
                    :disabled="spot.spotStatus && spot.spotStatus !== 'ç‡Ÿé‹ä¸­'"
                    style="height: auto; padding: 2px 8px"
                  >
                    <div class="spot-option" style="padding: 2px 0">
                      <span class="spot-code">{{ spot.spotCode || spot.spotId }}</span>
                      <span class="spot-name">{{ spot.spotName }}</span>

                      <el-tag
                        :type="
                          !spot.spotStatus || spot.spotStatus === 'ç‡Ÿé‹ä¸­' ? 'success' : 'danger'
                        "
                        size="small"
                        effect="plain"
                        style="margin-left: 8px"
                      >
                        {{ spot.spotStatus || 'æœªçŸ¥' }}
                      </el-tag>
                    </div>
                  </el-option>
                </el-select>
                <small v-if="spotOptions.length === 0" class="text-warning">
                  <i class="fas fa-exclamation-triangle mr-1"></i> ç„¡å¯ç”¨æ©Ÿå°è³‡æ–™
                </small>
              </el-form-item>

              <!-- æ¤…å­é¸æ“‡ (ç•¶ targetType === 'seat') -->
              <el-form-item
                v-if="targetType === 'seat'"
                label="æ¤…å­é¸æ“‡"
                prop="seatsId"
                class="form-item-animated"
              >
                <template #label>
                  <span class="custom-label">
                    <i class="fas fa-chair label-icon"></i> é¸æ“‡æ¤…å­
                    <span class="required-star">*</span>
                  </span>
                </template>
                <el-select
                  v-model="form.seatsId"
                  placeholder="è«‹é¸æ“‡æˆ–æœå°‹æ¤…å­..."
                  class="w-100"
                  filterable
                  :disabled="isEdit"
                  size="large"
                >
                  <template #prefix>
                    <i class="fas fa-search"></i>
                  </template>
                  <el-option
                    v-for="seat in seatOptions"
                    :key="seat.seatsId"
                    :label="`${seat.seatsName || seat.seatsId} (${seat.seatsType || 'ä¸€èˆ¬'})`"
                    :value="seat.seatsId"
                  >
                    <div class="seat-option">
                      <span class="seat-icon">ğŸª‘</span>
                      <div class="seat-info">
                        <span class="seat-name">{{
                          seat.seatsName || `æ¤…å­ #${seat.seatsId}`
                        }}</span>
                        <span class="seat-type"
                          >{{ seat.seatsType || 'ä¸€èˆ¬åº§æ¤…' }} Â·
                          {{ seat.seatsStatus || 'æ­£å¸¸' }}</span
                        >
                      </div>
                    </div>
                  </el-option>
                </el-select>
                <small v-if="seatOptions.length === 0" class="text-warning">
                  <i class="fas fa-exclamation-triangle mr-1"></i> ç„¡å¯ç”¨æ¤…å­è³‡æ–™
                </small>
              </el-form-item>

              <!-- å•é¡Œé¡å‹ -->
              <el-form-item label="å•é¡Œé¡å‹" prop="issueType" class="form-item-animated">
                <template #label>
                  <span class="custom-label">
                    <i class="fas fa-exclamation-circle label-icon"></i> å•é¡Œé¡å‹
                    <span class="required-star">*</span>
                  </span>
                </template>

                <!-- å¿«é€Ÿé¸æ“‡å€ -->
                <div class="quick-select-grid">
                  <div
                    v-for="type in issueTypeOptions"
                    :key="type.value"
                    class="quick-select-item"
                    :class="{ active: form.issueType === type.value }"
                    @click="selectIssueType(type)"
                  >
                    <span class="item-icon">{{ type.icon }}</span>
                    <span class="item-text">{{ type.value }}</span>
                  </div>
                </div>

                <el-input
                  v-model="form.issueType"
                  placeholder="æˆ–è‡ªè¡Œè¼¸å…¥å•é¡Œé¡å‹..."
                  size="large"
                  class="mt-2"
                  clearable
                />
              </el-form-item>

              <!-- è©³ç´°æè¿° -->
              <el-form-item label="è©³ç´°æè¿°" prop="issueDesc" class="form-item-animated">
                <template #label>
                  <span class="custom-label">
                    <i class="fas fa-align-left label-icon"></i> è©³ç´°æè¿°
                  </span>
                </template>
                <el-input
                  v-model="form.issueDesc"
                  type="textarea"
                  :rows="4"
                  placeholder="è«‹è©³ç´°æè¿°å•é¡Œç‹€æ³ï¼Œä¾‹å¦‚ï¼šæ•…éšœä½ç½®ã€ç™¼ç”Ÿæ™‚é–“ã€åš´é‡ç¨‹åº¦ç­‰..."
                  show-word-limit
                  maxlength="1000"
                  class="custom-textarea"
                />
              </el-form-item>

              <!-- å„ªå…ˆç´šé¸æ“‡ -->
              <el-form-item label="å„ªå…ˆç´š" prop="issuePriority" class="form-item-animated">
                <template #label>
                  <span class="custom-label">
                    <i class="fas fa-flag label-icon"></i> å„ªå…ˆç´š
                    <span class="required-star">*</span>
                  </span>
                </template>
                <div class="priority-cards">
                  <div
                    v-for="(config, key) in priorityConfig"
                    :key="key"
                    class="priority-card"
                    :class="{ active: form.issuePriority === key }"
                    :style="{
                      '--card-color': config.color,
                      '--card-bg': config.bgColor,
                    }"
                    @click="form.issuePriority = key"
                  >
                    <span class="priority-icon">{{ config.icon }}</span>
                    <span class="priority-text">{{ config.text }}</span>
                    <span class="priority-desc">{{ config.desc }}</span>
                  </div>
                </div>
              </el-form-item>

              <!-- æŒ‡æ´¾ç¶­ä¿®å“¡ -->
              <el-form-item label="æŒ‡æ´¾ç¶­ä¿®å“¡" prop="assignedStaffId" class="form-item-animated">
                <template #label>
                  <span class="custom-label">
                    <i class="fas fa-user-cog label-icon"></i> æŒ‡æ´¾ç¶­ä¿®å“¡
                    <el-tag type="info" size="small" class="ml-2">é¸å¡«</el-tag>
                  </span>
                </template>
                <el-select
                  popper-class="mt-staff-select-popper"
                  v-model="form.assignedStaffId"
                  placeholder="æš«ä¸æŒ‡æ´¾ï¼Œç¨å¾Œå¯ç·¨è¼¯"
                  class="w-100"
                  filterable
                  clearable
                  size="large"
                >
                  <!-- â˜… å•é¡Œ2ä¿®å¾©ï¼šéæ¿¾åªé¡¯ç¤ºå•Ÿç”¨äººå“¡ï¼Œæˆ–ç•¶å‰å·¥å–®å·²æŒ‡æ´¾çš„äººå“¡ï¼ˆå³ä½¿å·²åœç”¨ï¼‰ -->
                  <el-option
                    v-for="s in staffOptions.filter(
                      (staff) =>
                        staff.isActive === true || staff.staffId === originalAssignedStaffId,
                    )"
                    :key="s.staffId"
                    :label="`${s.staffName}${s.isActive === false ? ' (å·²åœç”¨)' : ''} (${s.staffCompany || 'å¤–éƒ¨'})`"
                    :value="s.staffId"
                    :disabled="s.isActive === false && s.staffId !== form.assignedStaffId"
                  >
                    <!-- âœ…ã€ä¿®æ­£#3ã€‘æ”¹æˆå·¦å³å…©æ¬„ï¼šå·¦é‚Šå§“åå…¬å¸ã€å³é‚Šé¡¯ç¤ºç‹€æ…‹ -->
                    <div class="staff-option">
                      <div class="staff-left">
                        <div
                          class="staff-avatar"
                          :style="{ opacity: s.isActive === false ? 0.5 : 1 }"
                        >
                          {{ s.staffName?.charAt(0) }}
                        </div>

                        <div class="staff-info">
                          <span
                            class="staff-name"
                            :style="{ color: s.isActive === false ? '#909399' : '' }"
                          >
                            {{ s.staffName }}
                            <el-tag
                              v-if="s.isActive === false"
                              type="info"
                              size="small"
                              class="ml-1"
                              >å·²åœç”¨</el-tag
                            >
                          </span>
                          <span class="staff-company">{{ s.staffCompany || 'å¤–éƒ¨äººå“¡' }}</span>
                        </div>
                      </div>

                      <!-- ã€ä¿®æ­£#3ã€‘é¡¯ç¤ºï¼šå·²æŒ‡æ´¾ / ç¶­ä¿®ä¸­ / ä¿é¤Šä¸­ / ç©ºé–’ä¸­ -->
                      <div class="staff-right">
                        <el-tag
                          :type="getStaffUiTag(s).type"
                          size="small"
                          effect="plain"
                          :disable-transitions="true"
                        >
                          {{ getStaffUiTag(s).text }}
                        </el-tag>
                      </div>
                    </div>
                  </el-option>
                </el-select>
              </el-form-item>

              <!-- ============ åœ–ç‰‡é™„ä»¶å€å¡Š ============ -->
              <el-form-item 
                v-if="isEdit" 
                label="åœ–ç‰‡é™„ä»¶" 
                class="form-item-animated"
              >
                <template #label>
                  <span class="custom-label">
                    <i class="fas fa-images label-icon"></i> åœ–ç‰‡é™„ä»¶
                    <el-tag type="info" size="small" class="ml-2">é¸å¡«</el-tag>
                  </span>
                </template>

                <!-- ä¸Šå‚³å€ -->
                <div class="attachment-upload-area">
                  <el-upload
                    ref="uploadRef"
                    :auto-upload="false"
                    :on-change="handleFileChange"
                    :on-remove="handleRemoveFile"
                    :before-upload="beforeUpload"
                    :file-list="fileList"
                    accept="image/jpeg,image/png,image/webp"
                    list-type="picture-card"
                    :limit="MAX_FILE_COUNT"
                    :disabled="uploadingAttachments"
                  >
                    <template #default>
                      <div class="upload-trigger">
                        <i class="fas fa-plus"></i>
                        <div class="upload-text">é¸æ“‡åœ–ç‰‡</div>
                      </div>
                    </template>
                    <template #tip>
                      <div class="el-upload__tip">
                        <i class="fas fa-info-circle"></i>
                        æ”¯æ´ JPGã€PNGã€WEBP æ ¼å¼ï¼Œå–®å¼µæœ€å¤§ 5MBï¼Œæœ€å¤š {{ MAX_FILE_COUNT }} å¼µ
                      </div>
                    </template>
                  </el-upload>

                  <!-- å‚™è¨»è¼¸å…¥ -->
                  <el-input
                    v-if="fileList.length > 0"
                    v-model="attachmentNote"
                    placeholder="é¸å¡«ï¼šç‚ºé€™æ‰¹åœ–ç‰‡åŠ ä¸Šå‚™è¨»..."
                    class="mt-2"
                    clearable
                    maxlength="200"
                    show-word-limit
                  />

                  <!-- ç«‹å³ä¸Šå‚³æŒ‰éˆ•ï¼ˆç·¨è¼¯æ¨¡å¼ï¼‰ -->
                  <el-button
                    v-if="isEdit && fileList.length > 0"
                    type="primary"
                    :loading="uploadingAttachments"
                    @click="uploadAttachmentsToServer(fileList.map(f => f.raw))"
                    class="mt-2"
                  >
                    <i class="fas fa-upload mr-1"></i>
                    {{ uploadingAttachments ? 'ä¸Šå‚³ä¸­...' : 'ç«‹å³ä¸Šå‚³' }}
                  </el-button>
                </div>

                <!-- å·²ä¸Šå‚³çš„é™„ä»¶æ¸…å–® -->
                <div v-if="attachments.length > 0" class="attachments-list mt-3">
                  <el-divider content-position="left">
                    <span style="color: #909399; font-size: 13px;">
                      <i class="fas fa-paperclip mr-1"></i>
                      å·²ä¸Šå‚³é™„ä»¶ ({{ attachments.length }})
                    </span>
                  </el-divider>

                  <div class="attachments-grid">
                    <div 
                      v-for="att in attachments" 
                      :key="att.attachmentId" 
                      class="attachment-item"
                    >
                      <!-- åœ–ç‰‡é è¦½ -->
                      <div class="attachment-preview" @click="previewImage(att)">
                        <img 
                          :src="`http://localhost:8080${att.publicUrl}`" 
                          :alt="att.originalName"
                          @error="$event.target.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2YwZjBmMCIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgZm9udC1zaXplPSIxNCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iIGZpbGw9IiM5OTkiPu+/ve+/ve+/vTwvdGV4dD48L3N2Zz4='"
                        />
                        <div class="preview-overlay">
                          <i class="fas fa-search-plus"></i>
                        </div>
                      </div>

                      <!-- é™„ä»¶è³‡è¨Š -->
                      <div class="attachment-info">
                        <div class="attachment-name" :title="att.originalName">
                          {{ att.originalName }}
                        </div>
                        <div class="attachment-meta">
                          <span class="meta-item">
                            <i class="fas fa-clock"></i>
                            {{ att.createdAt }}
                          </span>
                          <span class="meta-item">
                            <i class="fas fa-hdd"></i>
                            {{ (att.fileSize / 1024).toFixed(1) }} KB
                          </span>
                        </div>
                        <div v-if="att.note" class="attachment-note">
                          <i class="fas fa-comment-dots"></i>
                          {{ att.note }}
                        </div>
                      </div>

                      <!-- åˆªé™¤æŒ‰éˆ• -->
                      <el-button
                        type="danger"
                        size="small"
                        circle
                        class="delete-btn"
                        @click="deleteAttachment(att)"
                        :title="`åˆªé™¤ ${att.originalName}`"
                      >
                        <i class="fas fa-trash-alt"></i>
                      </el-button>
                    </div>
                  </div>
                </div>
              </el-form-item>

              <!-- æ–°å¢æ¨¡å¼ï¼šæç¤ºå¯åœ¨å»ºç«‹å¾Œä¸Šå‚³é™„ä»¶ -->
              <el-form-item 
                v-else 
                label="åœ–ç‰‡é™„ä»¶" 
                class="form-item-animated"
              >
                <template #label>
                  <span class="custom-label">
                    <i class="fas fa-images label-icon"></i> åœ–ç‰‡é™„ä»¶
                    <el-tag type="info" size="small" class="ml-2">é¸å¡«</el-tag>
                  </span>
                </template>

                <!-- æ–°å¢æ¨¡å¼çš„ä¸Šå‚³å€ -->
                <div class="attachment-upload-area">
                  <el-upload
                    ref="uploadRef"
                    :auto-upload="false"
                    :on-change="handleFileChange"
                    :on-remove="handleRemoveFile"
                    :before-upload="beforeUpload"
                    :file-list="fileList"
                    accept="image/jpeg,image/png,image/webp"
                    list-type="picture-card"
                    :limit="MAX_FILE_COUNT"
                  >
                    <template #default>
                      <div class="upload-trigger">
                        <i class="fas fa-plus"></i>
                        <div class="upload-text">é¸æ“‡åœ–ç‰‡</div>
                      </div>
                    </template>
                    <template #tip>
                      <div class="el-upload__tip">
                        <i class="fas fa-info-circle"></i>
                        å»ºç«‹å·¥å–®å¾Œå°‡è‡ªå‹•ä¸Šå‚³æ‰€é¸åœ–ç‰‡ï¼ˆæ”¯æ´ JPGã€PNGã€WEBPï¼Œå–®å¼µæœ€å¤§ 5MBï¼‰
                      </div>
                    </template>
                  </el-upload>

                  <!-- å‚™è¨»è¼¸å…¥ -->
                  <el-input
                    v-if="fileList.length > 0"
                    v-model="attachmentNote"
                    placeholder="é¸å¡«ï¼šç‚ºé€™æ‰¹åœ–ç‰‡åŠ ä¸Šå‚™è¨»..."
                    class="mt-2"
                    clearable
                    maxlength="200"
                    show-word-limit
                  />
                </div>
              </el-form-item>

              <!-- åˆ†éš”ç·š -->
              <el-divider>
                <i class="fas fa-paper-plane"></i>
              </el-divider>

              <!-- æŒ‰éˆ•å€ -->
              <el-form-item class="form-actions">
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    width: 100%;
                    align-items: center;
                  "
                >
                  <div class="left-buttons">
                    <el-button
                      type="primary"
                      @click="submit"
                      :loading="submitting"
                      size="large"
                      class="submit-btn"
                    >
                      <i class="fas fa-paper-plane mr-2" v-if="!submitting"></i>
                      <span>{{ submitting ? 'è™•ç†ä¸­...' : isEdit ? 'æ›´æ–°å·¥å–®' : 'å»ºç«‹å·¥å–®' }}</span>
                    </el-button>

                    <el-button @click="handleCancel" size="large" class="back-btn ml-3">
                      <i class="fas fa-arrow-left mr-2"></i> è¿”å›åˆ—è¡¨
                    </el-button>
                  </div>

                  <div class="right-buttons">
                    <el-button
                      type="warning"
                      link
                      @click="handleDemoFill"
                      style="opacity: 0.5; font-weight: normal"
                      onmouseover="this.style.opacity=1"
                      onmouseout="this.style.opacity=0.5"
                    >
                      <i class="fas fa-magic mr-1"></i> ä¸€éµå¸¶å…¥
                    </el-button>
                  </div>
                </div>
              </el-form-item>
            </el-form>
          </el-card>
        </transition>
      </div>
    </section>
  </div>
  <!-- ç¶­ä¿®æ­·ç¨‹ç´€éŒ„ -->
  <div class="page-container">
    <el-card v-if="ticketId" class="mt-4" shadow="hover">
      <template #header>
        <div class="card-header">
          <span>ç¶­ä¿®æ­·ç¨‹ç´€éŒ„</span>
        </div>
      </template>
      <TicketTimeline ref="timelineRef" :ticketId="ticketId" />
    </el-card>
  </div>
</template>

<style scoped>
.ticket-form-container {
  min-height: 100vh;
  background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
  padding-bottom: 40px;
}

/* ============ åœ–ç‰‡é™„ä»¶æ¨£å¼ ============ */
.attachment-upload-area {
  width: 100%;
}

.upload-trigger {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 8px;
  color: #8c939d;
  font-size: 14px;
}

.upload-trigger i {
  font-size: 28px;
}

.upload-text {
  font-size: 12px;
}

:deep(.el-upload__tip) {
  color: #909399;
  font-size: 12px;
  margin-top: 8px;
  line-height: 1.5;
}

.attachments-list {
  padding: 16px;
  background: #f9fafb;
  border-radius: 8px;
  border: 1px solid #e4e7ed;
}

.attachments-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 16px;
}

.attachment-item {
  position: relative;
  background: white;
  border-radius: 8px;
  overflow: hidden;
  border: 1px solid #e4e7ed;
  transition: all 0.3s ease;
}

.attachment-item:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  transform: translateY(-2px);
}

.attachment-preview {
  position: relative;
  width: 100%;
  height: 180px;
  cursor: pointer;
  overflow: hidden;
  background: #f5f7fa;
}

.attachment-preview img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.3s ease;
}

.attachment-item:hover .attachment-preview img {
  transform: scale(1.05);
}

.preview-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.attachment-preview:hover .preview-overlay {
  opacity: 1;
}

.preview-overlay i {
  font-size: 32px;
  color: white;
}

.attachment-info {
  padding: 12px;
}

.attachment-name {
  font-size: 14px;
  font-weight: 600;
  color: #303133;
  margin-bottom: 8px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.attachment-meta {
  display: flex;
  gap: 12px;
  font-size: 12px;
  color: #909399;
  margin-bottom: 6px;
}

.meta-item {
  display: flex;
  align-items: center;
  gap: 4px;
}

.attachment-note {
  font-size: 12px;
  color: #606266;
  background: #f0f9ff;
  padding: 6px 8px;
  border-radius: 4px;
  border-left: 3px solid #409eff;
  margin-top: 8px;
  line-height: 1.4;
}

.attachment-note i {
  color: #409eff;
  margin-right: 4px;
}

.delete-btn {
  position: absolute;
  top: 8px;
  right: 8px;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.attachment-item:hover .delete-btn {
  opacity: 1;
}

.content-header {
  padding: 20px 1rem;
}

.page-title-box {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 20px 24px;
  background: white;
  border-radius: 16px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
}

.title-icon {
  width: 60px;
  height: 60px;
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 26px;
  color: white;
  transition: transform 0.3s ease;
}

.title-icon:hover {
  transform: scale(1.1) rotate(5deg);
}

.title-icon.add-mode {
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
}

.title-icon.edit-mode {
  background: linear-gradient(135deg, #e6a23c 0%, #f3d19e 100%);
}

.title-content {
  flex: 1;
}

.title-content h1 {
  margin: 0;
  font-size: 1.6rem;
  font-weight: 700;
  color: #303133;
}

.title-content .subtitle {
  margin: 6px 0 0;
  font-size: 0.9rem;
  color: #909399;
}

.title-progress {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}

.progress-text {
  font-size: 12px;
  color: #909399;
}

/* è¡¨å–®å¡ç‰‡ */
.form-card {
  width: 100%;
  max-width: 800px;
  border-radius: 16px;
  overflow: hidden;
  border: none;
  transition: all 0.3s ease;
}

.form-card:hover {
  box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
}

.card-header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 10px;
}

.header-icon {
  width: 36px;
  height: 36px;
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 16px;
}

.header-text {
  font-weight: 600;
  font-size: 1.1rem;
  color: #303133;
}

/* æ­¥é©ŸæŒ‡ç¤ºå™¨ */
.steps-indicator {
  padding: 16px 0 24px;
  border-bottom: 1px dashed #ebeef5;
  margin-bottom: 20px;
}

/* è¡¨å–®æ¨£å¼ */
.ticket-form {
  padding: 10px 20px;
}

.custom-label {
  display: flex;
  align-items: center;
  gap: 6px;
  font-weight: 500;
  color: #606266;
}

.label-icon {
  color: #409eff;
  font-size: 14px;
}

.required-star {
  color: #f56c6c;
  margin-left: 2px;
}

.form-item-animated {
  animation: fadeInUp 0.5s ease forwards;
  opacity: 0;
}

.form-item-animated:nth-child(1) {
  animation-delay: 0.1s;
}
.form-item-animated:nth-child(2) {
  animation-delay: 0.15s;
}
.form-item-animated:nth-child(3) {
  animation-delay: 0.2s;
}
.form-item-animated:nth-child(4) {
  animation-delay: 0.25s;
}
.form-item-animated:nth-child(5) {
  animation-delay: 0.3s;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* å ´åœ°é¸é …æ¨£å¼ */
.spot-option {
  display: flex;
  align-items: center;
  gap: 10px;
}

.spot-code {
  background: #409eff;
  color: white;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 600;
}

.spot-name {
  color: #606266;
}

/* ç¶­ä¿®ç›®æ¨™é¡å‹åˆ‡æ› */
.target-type-switch {
  display: flex;
  gap: 16px;
  width: 100%;
}

.target-type-option {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 10px;
  padding: 20px;
  background: #f5f7fa;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  border: 2px solid transparent;
}

.target-type-option:hover {
  background: #ecf5ff;
  transform: translateY(-2px);
}

.target-type-option.active {
  background: linear-gradient(135deg, #ecf5ff 0%, #e6f4ff 100%);
  border-color: #409eff;
  box-shadow: 0 4px 15px rgba(64, 158, 255, 0.2);
}

.target-type-option i {
  font-size: 28px;
  color: #909399;
  transition: all 0.3s ease;
}

.target-type-option.active i {
  color: #409eff;
  transform: scale(1.1);
}

.target-type-option span {
  font-weight: 600;
  font-size: 14px;
  color: #606266;
}

.target-type-option.active span {
  color: #409eff;
}

/* æ¤…å­é¸é …æ¨£å¼ */
.seat-option {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 4px 0;
}

.seat-icon {
  font-size: 20px;
}

.seat-info {
  display: flex;
  flex-direction: column;
}

.seat-name {
  font-weight: 500;
  color: #303133;
}

.seat-type {
  font-size: 12px;
  color: #909399;
}

/* å¿«é€Ÿé¸æ“‡å€ - æ©«æ’è¨­è¨ˆ */
.quick-select-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
}

.quick-select-item {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 8px;
  padding: 12px 20px;
  background: #f5f7fa;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.3s ease;
  border: 2px solid transparent;
  flex-shrink: 0;
}

.quick-select-item:hover {
  background: #ecf5ff;
  transform: translateY(-2px);
}

.quick-select-item.active {
  background: #ecf5ff;
  border-color: #409eff;
}

.item-icon {
  font-size: 22px;
}

.item-text {
  font-size: 14px;
  color: #606266;
  font-weight: 500;
  white-space: nowrap;
}

/* å„ªå…ˆç´šå¡ç‰‡ */
.priority-cards {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
}

@media (max-width: 768px) {
  .priority-cards {
    grid-template-columns: repeat(2, 1fr);
  }
}

.priority-card {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 16px 12px;
  background: var(--card-bg);
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  border: 2px solid transparent;
}

.priority-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
}

.priority-card.active {
  border-color: var(--card-color);
  transform: scale(1.05);
}

.priority-icon {
  font-size: 28px;
  margin-bottom: 8px;
}

.priority-text {
  font-weight: 600;
  color: var(--card-color);
  margin-bottom: 4px;
}

.priority-desc {
  font-size: 11px;
  color: #909399;
  text-align: center;
}

/* ç¶­ä¿®å“¡é¸é … */
/* ç¶­ä¿®å“¡é¸é …ï¼šå·¦å³ä½ˆå±€ + è¶³å¤ é«˜åº¦ï¼Œé¿å…å…¬å¸æ–‡å­—è¢«è“‹ */
.staff-option {
  display: flex;
  align-items: center;
  justify-content: space-between; /* å³å´ç•™çµ¦ç‹€æ…‹ tag */
  gap: 12px;
  padding: 8px 6px;
  height: auto !important;
  line-height: 1.4;
}

/* å·¦å´ç¾¤çµ„ï¼ˆé ­åƒ + æ–‡å­—ï¼‰ */
.staff-left {
  display: flex;
  align-items: center;
  gap: 10px;
  min-width: 0; /* âœ… å…è¨±æ–‡å­—çœç•¥ */
  flex: 1;
}

.staff-avatar {
  width: 36px;
  height: 36px;
  background: linear-gradient(135deg, #67c23a 0%, #95d475 100%);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 600;
  font-size: 14px;
  flex-shrink: 0;
  box-shadow: 0 2px 6px rgba(103, 194, 58, 0.2);
}

.staff-info {
  display: flex;
  flex-direction: column;
  justify-content: center;
  min-width: 0; /*  å…è¨±çœç•¥ */
  overflow: hidden;
}

.staff-name {
  font-weight: 600;
  font-size: 14px;
  color: #303133;
  line-height: 1.25;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.staff-company {
  font-size: 12px;
  color: #909399;
  line-height: 1.2;
  margin-top: 3px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* å³å´ç‹€æ…‹ tag */
.staff-right {
  flex-shrink: 0;
  margin-left: 10px;
}

/* æŒ‰éˆ•å€ */
.form-actions {
  margin-top: 20px;
}

.submit-btn {
  min-width: 160px;
  border-radius: 12px;
  font-weight: 600;
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
  border: none;
  transition: all 0.3s ease;
}

.submit-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(64, 158, 255, 0.4);
}

.back-btn {
  min-width: 120px;
  border-radius: 12px;
  transition: all 0.3s ease;
}

.back-btn:hover {
  transform: translateX(-3px);
}

/* éæ¸¡å‹•ç•« */
.slide-fade-enter-active {
  transition: all 0.4s ease-out;
}
.slide-fade-leave-active {
  transition: all 0.3s ease-in;
}
.slide-fade-enter-from {
  transform: translateX(-20px);
  opacity: 0;
}
.slide-fade-leave-to {
  transform: translateX(20px);
  opacity: 0;
}

.zoom-fade-enter-active {
  transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.zoom-fade-leave-active {
  transition: all 0.3s ease-in;
}
.zoom-fade-enter-from {
  transform: scale(0.9);
  opacity: 0;
}
.zoom-fade-leave-to {
  transform: scale(0.95);
  opacity: 0;
}

/* è¼”åŠ©é¡ */
.w-100 {
  width: 100%;
}
.mt-2 {
  margin-top: 8px;
}
.ml-2 {
  margin-left: 8px;
}
.mr-1 {
  margin-right: 4px;
}
.mr-2 {
  margin-right: 8px;
}
.text-warning {
  color: #e6a23c;
}

:deep(.el-divider__text) {
  background: white;
  color: #c0c4cc;
}

.custom-textarea :deep(.el-textarea__inner) {
  border-radius: 10px;
}

/* ã€ä¿®æ­£#2ã€‘æ©Ÿå°é¸å–®ï¼šç¸®å°ä¸Šä¸‹ paddingï¼Œè®“é–“éš”ä¸è¦å¤ªå¤§ */
:deep(.mt-spot-select-popper .el-select-dropdown__item) {
  height: auto !important;
  line-height: 1.2 !important;
  padding-top: 4px !important;
  padding-bottom: 4px !important;
}

/* ã€ä¿®æ­£#3ã€‘ç¶­ä¿®å“¡é¸å–®ï¼šä¿ç•™è¼ƒèˆ’é©çš„é«˜åº¦ï¼Œé¿å…å…©è¡Œæ–‡å­—è¢«è“‹åˆ° */
:deep(.mt-staff-select-popper .el-select-dropdown__item) {
  height: auto !important;
  line-height: 1.4 !important;
  padding-top: 10px !important;
  padding-bottom: 10px !important;
}
</style>
</file>

<file path="frontend/src/views/maintenance/ScheduleForm.vue">
<script setup>
import { ref, reactive, computed, onMounted, watch } from 'vue'
import { useRouter, useRoute } from 'vue-router'
import maintenanceApi from '@/api/modules/maintenance'
import Swal from 'sweetalert2'
import { useScheduleConfig } from '@/composables/maintenance/useScheduleConfig'
import { Setting, Aim, Clock, User, Check } from '@element-plus/icons-vue'

const router = useRouter()
const route = useRoute()
const { scheduleTypeConfig, priorityConfig, formatScheduleDetail } = useScheduleConfig()

// ====== ç·¨è¼¯æ¨¡å¼åˆ¤æ–· ======
const isEdit = computed(() => !!route.params.id)
const pageTitle = computed(() => (isEdit.value ? 'ç·¨è¼¯æ’ç¨‹' : 'æ–°å¢æ’ç¨‹'))

// FIX: é©—è­‰ route param id æ˜¯å¦ç‚ºæœ‰æ•ˆæ•¸å­—ï¼ˆé˜²æ­¢å­—ä¸² ID å¦‚ DEMO_xxx é€²å…¥ç·¨è¼¯é ï¼‰
const isValidRouteId = computed(() => {
  if (!route.params.id) return true // æ–°å¢æ¨¡å¼ä¸éœ€é©—è­‰
  const id = route.params.id
  return /^\d+$/.test(id) // å¿…é ˆæ˜¯ç´”æ•¸å­—
})

// ====== æ­¥é©Ÿæ§åˆ¶ ======
const currentStep = ref(0)
const steps = [
  { title: 'åŸºæœ¬è³‡è¨Š', icon: Setting },
  { title: 'ç›®æ¨™è¨­å®š', icon: Aim },
  { title: 'æ’ç¨‹è¨­å®š', icon: Clock },
  { title: 'æŒ‡æ´¾äººå“¡', icon: User },
  { title: 'ç¢ºèªé€å‡º', icon: Check },
]

// ====== è¡¨å–®è³‡æ–™ ======
const formRef = ref(null)
const loading = ref(false)
const submitting = ref(false)

const form = reactive({
  title: '',
  targetType: 'SPOT',
  targetId: null,
  scheduleType: 'DAILY',
  dayOfWeek: null,
  dayOfMonth: null,
  executeTime: '09:00:00',
  issueType: '',
  issuePriority: 'NORMAL',
  assignedStaffId: null,
  isActive: true,
})

// ====== ä¸‹æ‹‰é¸é …è³‡æ–™ ======
const spotOptions = ref([])
const seatOptions = ref([])
const staffOptions = ref([])

// ====== é…ç½®é¸é … ======
const scheduleTypeOptions = [
  { label: 'æ¯æ—¥', value: 'DAILY', desc: 'æ¯å¤©å›ºå®šæ™‚é–“åŸ·è¡Œ', icon: 'fas fa-sun' },
  { label: 'æ¯é€±', value: 'WEEKLY', desc: 'æ¯é€±å›ºå®šæ˜ŸæœŸåŸ·è¡Œ', icon: 'fas fa-calendar-week' },
  { label: 'æ¯æœˆ', value: 'MONTHLY', desc: 'æ¯æœˆå›ºå®šæ—¥æœŸåŸ·è¡Œ', icon: 'fas fa-calendar-alt' },
]

const dayOfWeekOptions = [
  { label: 'é€±ä¸€', value: 1 },
  { label: 'é€±äºŒ', value: 2 },
  { label: 'é€±ä¸‰', value: 3 },
  { label: 'é€±å››', value: 4 },
  { label: 'é€±äº”', value: 5 },
  { label: 'é€±å…­', value: 6 },
  { label: 'é€±æ—¥', value: 7 },
]

const priorityOptions = [
  { label: 'ä½', value: 'LOW' },
  { label: 'ä¸€èˆ¬', value: 'NORMAL' },
  { label: 'é«˜', value: 'HIGH' },
  { label: 'ç·Šæ€¥', value: 'URGENT' },
]

const issueTypeOptions = ['ä¾‹è¡Œä¿é¤Š', 'æ¸…æ½”ç¶­è­·', 'é›¶ä»¶æª¢æŸ¥', 'ç³»çµ±æ ¡æ­£', 'å®‰å…¨æª¢æ¸¬', 'è€—ææ›´æ›']

// ====== è¡¨å–®é©—è­‰è¦å‰‡ ======
const rules = reactive({
  title: [
    { required: true, message: 'è«‹è¼¸å…¥æ’ç¨‹æ¨™é¡Œ', trigger: 'blur' },
    { min: 2, max: 100, message: 'æ¨™é¡Œé•·åº¦ç‚º 2-100 å­—', trigger: 'blur' },
  ],
  targetType: [{ required: true, message: 'è«‹é¸æ“‡ç›®æ¨™é¡å‹', trigger: 'change' }],
  targetId: [{ required: true, message: 'è«‹é¸æ“‡ç›®æ¨™', trigger: 'change' }],
  scheduleType: [{ required: true, message: 'è«‹é¸æ“‡æ’ç¨‹é¡å‹', trigger: 'change' }],
  dayOfWeek: [{ required: true, message: 'è«‹é¸æ“‡æ˜ŸæœŸå¹¾', trigger: 'change' }],
  dayOfMonth: [{ required: true, message: 'è«‹è¼¸å…¥æ—¥æœŸ', trigger: 'blur' }],
  executeTime: [{ required: true, message: 'è«‹é¸æ“‡åŸ·è¡Œæ™‚é–“', trigger: 'change' }],
  issueType: [{ required: true, message: 'è«‹é¸æ“‡å•é¡Œé¡å‹', trigger: 'change' }],
  issuePriority: [{ required: true, message: 'è«‹é¸æ“‡å„ªå…ˆç´š', trigger: 'change' }],
})

// ====== å‹•æ…‹é©—è­‰è¦å‰‡ ======
const dynamicRules = computed(() => {
  const baseRules = { ...rules }
  if (form.scheduleType === 'DAILY') {
    delete baseRules.dayOfWeek
    delete baseRules.dayOfMonth
  } else if (form.scheduleType === 'WEEKLY') {
    delete baseRules.dayOfMonth
  } else if (form.scheduleType === 'MONTHLY') {
    delete baseRules.dayOfWeek
  }
  return baseRules
})

// ====== è¼‰å…¥é¸é …è³‡æ–™ ======
const loadOptions = async () => {
  try {
    loading.value = true
    const [spotsRes, seatsRes, staffRes] = await Promise.all([
      maintenanceApi.getAllSpots(),
      maintenanceApi.getAllSeats(),
      maintenanceApi.getAllStaff(),
    ])
    spotOptions.value = spotsRes.data || []
    seatOptions.value = seatsRes.data || []
    staffOptions.value = (staffRes.data || []).filter((s) => s.isActive)
  } catch {
    // handled by http.js
  } finally {
    loading.value = false
  }
}

// ====== è¼‰å…¥ç·¨è¼¯è³‡æ–™ ======
const loadSchedule = async () => {
  if (!isEdit.value) return
  try {
    loading.value = true
    const res = await maintenanceApi.getScheduleById(route.params.id)
    const data = res.data
    Object.assign(form, {
      title: data.title,
      targetType: data.targetType,
      targetId: data.targetId,
      scheduleType: data.scheduleType,
      dayOfWeek: data.dayOfWeek,
      dayOfMonth: data.dayOfMonth,
      executeTime: data.executeTime,
      issueType: data.issueType,
      issuePriority: data.issuePriority,
      assignedStaffId: data.assignedStaffId,
      isActive: data.isActive,
    })
  } catch {
    router.push('/admin/maintenance/schedule')
  } finally {
    loading.value = false
  }
}

// ====== ç›£è½è®Šæ›´ ======
watch(
  () => form.targetType,
  () => {
    form.targetId = null
  },
)
watch(
  () => form.scheduleType,
  (newType) => {
    if (newType === 'DAILY') {
      form.dayOfWeek = null
      form.dayOfMonth = null
    } else if (newType === 'WEEKLY') {
      form.dayOfMonth = null
    } else if (newType === 'MONTHLY') {
      form.dayOfWeek = null
    }
  },
)

// ====== æ­¥é©Ÿé©—è­‰ ======
const validateCurrentStep = async () => {
  const fieldsMap = {
    0: ['title', 'issueType', 'issuePriority'],
    1: ['targetType', 'targetId'],
    2: [
      'scheduleType',
      'executeTime',
      ...(form.scheduleType === 'WEEKLY' ? ['dayOfWeek'] : []),
      ...(form.scheduleType === 'MONTHLY' ? ['dayOfMonth'] : []),
    ],
    3: [],
    4: [],
  }
  const fields = fieldsMap[currentStep.value]
  if (!fields.length) return true

  try {
    await formRef.value.validateField(fields)
    return true
  } catch {
    return false
  }
}

const nextStep = async () => {
  if (await validateCurrentStep()) {
    currentStep.value = Math.min(currentStep.value + 1, steps.length - 1)
  }
}
const prevStep = () => {
  currentStep.value = Math.max(currentStep.value - 1, 0)
}

// ====== æäº¤è¡¨å–® ======
const handleSubmit = async () => {
  try {
    await formRef.value.validate()
  } catch {
    Swal.fire({
      icon: 'warning',
      title: 'è«‹æª¢æŸ¥è¡¨å–®',
      text: 'æœ‰å¿…å¡«æ¬„ä½å°šæœªå¡«å¯«',
      confirmButtonColor: '#409eff',
    })
    return
  }

  submitting.value = true
  try {
    const payload = { ...form }
    if (isEdit.value) {
      await maintenanceApi.updateSchedule(route.params.id, payload)
      await Swal.fire({
        icon: 'success',
        title: 'æ›´æ–°æˆåŠŸï¼',
        timer: 1500,
        showConfirmButton: false,
      })
    } else {
      await maintenanceApi.createSchedule(payload)
      await Swal.fire({
        icon: 'success',
        title: 'å»ºç«‹æˆåŠŸï¼',
        timer: 1500,
        showConfirmButton: false,
      })
    }
    router.push('/admin/maintenance/schedule')
  } finally {
    submitting.value = false
  }
}

const handleCancel = () => router.push('/admin/maintenance/schedule')

// ====== å–å¾—ç›®æ¨™åç¨± ======
const getTargetName = computed(() => {
  if (!form.targetId) return '-'
  if (form.targetType === 'SPOT') {
    const spot = spotOptions.value.find((s) => s.spotId === form.targetId)
    return spot?.spotName || spot?.spotCode || `æ©Ÿå° #${form.targetId}`
  } else {
    const seat = seatOptions.value.find((s) => s.seatsId === form.targetId)
    return seat?.seatsName || seat?.serialNumber || `æ¤…å­ #${form.targetId}`
  }
})

const getStaffName = computed(() => {
  if (!form.assignedStaffId) return '(ä¸æŒ‡æ´¾)'
  const staff = staffOptions.value.find((s) => s.staffId === form.assignedStaffId)
  return staff?.staffName || `äººå“¡ #${form.assignedStaffId}`
})

onMounted(async () => {
  // FIX: ç·¨è¼¯æ¨¡å¼ä¸‹ï¼Œæª¢æŸ¥ route.params.id æ˜¯å¦ç‚ºæœ‰æ•ˆæ•¸å­—
  // é˜²æ­¢ä½¿ç”¨è€…æ‰‹å‹•è¼¸å…¥ URL å¸¶å…¥éæ•¸å­— IDï¼ˆå¦‚ DEMO_xxxï¼‰å°è‡´å¾Œç«¯ 400/500 éŒ¯èª¤
  if (isEdit.value && !isValidRouteId.value) {
    await Swal.fire({
      icon: 'error',
      title: 'æ’ç¨‹ ID ç•°å¸¸',
      html: '<p>ç„¡æ³•è®€å–æ­¤æ’ç¨‹è³‡æ–™ã€‚</p><p style="color:#909399;font-size:13px;">è«‹è¿”å›åˆ—è¡¨é é¢ã€‚</p>',
      confirmButtonColor: '#f56c6c',
    })
    router.replace('/admin/maintenance/schedule')
    return
  }

  await loadOptions()
  await loadSchedule()
})
</script>

<template>
  <div class="schedule-form-container">
    <section class="content-header">
      <div class="container-fluid">
        <div class="row align-items-center">
          <div class="col-sm-6">
            <h1 class="page-title">
              <i
                :class="isEdit ? 'fas fa-edit' : 'fas fa-plus-circle'"
                class="mr-2"
                style="color: #409eff"
              ></i>
              {{ pageTitle }}
            </h1>
          </div>
          <div class="col-sm-6 text-right">
            <el-button @click="handleCancel">
              <i class="fas fa-arrow-left mr-1"></i> è¿”å›åˆ—è¡¨
            </el-button>
          </div>
        </div>
      </div>
    </section>

    <section class="content">
      <div class="container-fluid">
        <el-card shadow="hover" class="form-card" v-loading="loading">
          <el-steps :active="currentStep" finish-status="success" align-center class="mb-6">
            <el-step v-for="(step, idx) in steps" :key="idx" :title="step.title">
              <template #icon
                ><el-icon><component :is="step.icon" /></el-icon
              ></template>
            </el-step>
          </el-steps>

          <el-form
            ref="formRef"
            :model="form"
            :rules="dynamicRules"
            label-width="100px"
            label-position="top"
          >
            <!-- Step 0 -->
            <div v-show="currentStep === 0" class="step-content">
              <div class="step-header">
                <i class="fas fa-info-circle"></i>
                <span>å¡«å¯«æ’ç¨‹åŸºæœ¬è³‡è¨Š</span>
              </div>

              <el-form-item label="æ’ç¨‹æ¨™é¡Œ" prop="title">
                <el-input
                  v-model="form.title"
                  placeholder="ä¾‹å¦‚ï¼šæ¯æ—¥æ©Ÿå°æ¸…æ½”"
                  maxlength="100"
                  show-word-limit
                  clearable
                >
                  <template #prefix><i class="fas fa-tag"></i></template>
                </el-input>
              </el-form-item>

              <el-row :gutter="20">
                <el-col :span="12">
                  <el-form-item label="å•é¡Œé¡å‹" prop="issueType">
                    <el-select
                      v-model="form.issueType"
                      placeholder="é¸æ“‡æˆ–è¼¸å…¥"
                      filterable
                      allow-create
                      style="width: 100%"
                    >
                      <el-option
                        v-for="type in issueTypeOptions"
                        :key="type"
                        :label="type"
                        :value="type"
                      />
                    </el-select>
                  </el-form-item>
                </el-col>

                <el-col :span="12">
                  <el-form-item label="å„ªå…ˆç´š" prop="issuePriority">
                    <el-radio-group v-model="form.issuePriority" class="priority-radio">
                      <el-radio-button
                        v-for="opt in priorityOptions"
                        :key="opt.value"
                        :value="opt.value"
                        :data-priority="opt.value"
                      >
                        {{ opt.label }}
                      </el-radio-button>
                    </el-radio-group>
                  </el-form-item>
                </el-col>
              </el-row>

              <el-form-item label="å•Ÿç”¨ç‹€æ…‹">
                <el-switch
                  v-model="form.isActive"
                  active-text="å•Ÿç”¨"
                  inactive-text="åœç”¨"
                  active-color="#67c23a"
                  inline-prompt
                />
              </el-form-item>
            </div>

            <!-- Step 1 -->
            <div v-show="currentStep === 1" class="step-content">
              <div class="step-header">
                <i class="fas fa-crosshairs"></i>
                <span>é¸æ“‡ç¶­è­·ç›®æ¨™</span>
              </div>

              <el-form-item label="ç›®æ¨™é¡å‹" prop="targetType">
                <div class="target-type-cards">
                  <div
                    class="target-card"
                    :class="{ active: form.targetType === 'SPOT' }"
                    @click="form.targetType = 'SPOT'"
                  >
                    <i class="fas fa-desktop"></i>
                    <span>æ©Ÿå°</span>
                    <small>ç¶­è­·æ“šé»è¨­å‚™</small>
                  </div>
                  <div
                    class="target-card"
                    :class="{ active: form.targetType === 'SEAT' }"
                    @click="form.targetType = 'SEAT'"
                  >
                    <i class="fas fa-chair"></i>
                    <span>æ¤…å­</span>
                    <small>ç¶­è­·åº§æ¤…è¨­å‚™</small>
                  </div>
                </div>
              </el-form-item>

              <el-form-item label="é¸æ“‡ç›®æ¨™" prop="targetId">
                <el-select
                  v-if="form.targetType === 'SPOT'"
                  v-model="form.targetId"
                  placeholder="æœå°‹ä¸¦é¸æ“‡æ©Ÿå°"
                  filterable
                  style="width: 100%"
                >
                  <el-option
                    v-for="spot in spotOptions"
                    :key="spot.spotId"
                    :label="`${spot.spotName || spot.spotCode || 'æ©Ÿå°'} (ID: ${spot.spotId})`"
                    :value="spot.spotId"
                  >
                    <div class="option-item">
                      <i class="fas fa-desktop mr-2"></i
                      >{{ spot.spotName || spot.spotCode || 'æ©Ÿå°' }}
                      <el-tag size="small" class="ml-2">ID: {{ spot.spotId }}</el-tag>
                    </div>
                  </el-option>
                </el-select>

                <el-select
                  v-else
                  v-model="form.targetId"
                  placeholder="æœå°‹ä¸¦é¸æ“‡æ¤…å­"
                  filterable
                  style="width: 100%"
                >
                  <el-option
                    v-for="seat in seatOptions"
                    :key="seat.seatsId"
                    :label="`${seat.seatsName || seat.serialNumber || 'æ¤…å­'} (ID: ${seat.seatsId})`"
                    :value="seat.seatsId"
                  >
                    <div class="option-item">
                      <i class="fas fa-chair mr-2"></i
                      >{{ seat.seatsName || seat.serialNumber || 'æ¤…å­' }}
                      <el-tag size="small" class="ml-2">ID: {{ seat.seatsId }}</el-tag>
                    </div>
                  </el-option>
                </el-select>
              </el-form-item>
            </div>

            <!-- Step 2 -->
            <div v-show="currentStep === 2" class="step-content">
              <div class="step-header">
                <i class="fas fa-clock"></i>
                <span>è¨­å®šåŸ·è¡Œé »ç‡</span>
              </div>

              <el-form-item label="æ’ç¨‹é¡å‹" prop="scheduleType">
                <div class="schedule-type-cards">
                  <div
                    v-for="opt in scheduleTypeOptions"
                    :key="opt.value"
                    class="schedule-card"
                    :class="{ active: form.scheduleType === opt.value }"
                    @click="form.scheduleType = opt.value"
                  >
                    <i :class="opt.icon"></i>
                    <span>{{ opt.label }}</span>
                    <small>{{ opt.desc }}</small>
                  </div>
                </div>
              </el-form-item>

              <el-row :gutter="20">
                <el-col :span="12" v-if="form.scheduleType === 'WEEKLY'">
                  <el-form-item label="æ˜ŸæœŸå¹¾" prop="dayOfWeek">
                    <el-select v-model="form.dayOfWeek" placeholder="é¸æ“‡æ˜ŸæœŸ" style="width: 100%">
                      <el-option
                        v-for="opt in dayOfWeekOptions"
                        :key="opt.value"
                        :label="opt.label"
                        :value="opt.value"
                      />
                    </el-select>
                  </el-form-item>
                </el-col>

                <el-col :span="12" v-if="form.scheduleType === 'MONTHLY'">
                  <el-form-item label="æ¯æœˆå¹¾è™Ÿ" prop="dayOfMonth">
                    <el-input-number
                      v-model="form.dayOfMonth"
                      :min="1"
                      :max="31"
                      style="width: 100%"
                    />
                  </el-form-item>
                </el-col>

                <el-col :span="12">
                  <el-form-item label="åŸ·è¡Œæ™‚é–“" prop="executeTime">
                    <el-time-picker
                      v-model="form.executeTime"
                      format="HH:mm"
                      value-format="HH:mm:ss"
                      placeholder="é¸æ“‡æ™‚é–“"
                      style="width: 100%"
                    />
                  </el-form-item>
                </el-col>
              </el-row>

              <el-alert type="info" :closable="false" show-icon class="mt-4">
                <template #title>
                  <span v-if="form.executeTime">é è¦½ï¼š{{ formatScheduleDetail(form) }}</span>
                  <span v-else>è«‹é¸æ“‡åŸ·è¡Œæ™‚é–“</span>
                </template>
              </el-alert>
            </div>

            <!-- Step 3 -->
            <div v-show="currentStep === 3" class="step-content">
              <div class="step-header">
                <i class="fas fa-user-cog"></i>
                <span>æŒ‡æ´¾ç¶­è­·äººå“¡ (é¸å¡«)</span>
              </div>

              <el-form-item label="ç¶­è­·äººå“¡">
                <el-select
                  v-model="form.assignedStaffId"
                  placeholder="é¸æ“‡äººå“¡æˆ–ç•™ç©º"
                  clearable
                  filterable
                  style="width: 100%"
                >
                  <el-option
                    v-for="staff in staffOptions"
                    :key="staff.staffId"
                    :label="`${staff.staffName} (${staff.specialization || 'æœªè¨­å®šå°ˆé•·'})`"
                    :value="staff.staffId"
                  >
                    <div class="option-item">
                      <el-avatar :size="24" class="mr-2">{{
                        staff.staffName?.charAt(0)
                      }}</el-avatar>
                      {{ staff.staffName }}
                      <el-tag size="small" type="info" class="ml-2">{{
                        staff.specialization || 'æœªè¨­å®š'
                      }}</el-tag>
                    </div>
                  </el-option>
                </el-select>
              </el-form-item>

              <el-alert type="warning" :closable="false" show-icon>
                <template #title>æç¤º</template>
                <template #default
                  >è‹¥ä¸æŒ‡æ´¾ï¼Œå·¥å–®å»ºç«‹å¾Œç‹€æ…‹ç‚ºã€Œå·²å›å ±ã€ï¼›è‹¥æŒ‡æ´¾å‰‡ç‚ºã€Œå·²æŒ‡æ´¾ã€</template
                >
              </el-alert>
            </div>

            <!-- Step 4 -->
            <div v-show="currentStep === 4" class="step-content">
              <div class="step-header">
                <i class="fas fa-check-circle"></i>
                <span>ç¢ºèªæ’ç¨‹è³‡è¨Š</span>
              </div>

              <el-descriptions :column="2" border class="summary-desc">
                <el-descriptions-item label="æ’ç¨‹æ¨™é¡Œ" :span="2">
                  <strong>{{ form.title || '-' }}</strong>
                </el-descriptions-item>

                <el-descriptions-item label="å•é¡Œé¡å‹">{{
                  form.issueType || '-'
                }}</el-descriptions-item>
                <el-descriptions-item label="å„ªå…ˆç´š">
                  <el-tag :type="priorityConfig[form.issuePriority]?.tagType" size="small">
                    {{ priorityConfig[form.issuePriority]?.text }}
                  </el-tag>
                </el-descriptions-item>

                <el-descriptions-item label="ç›®æ¨™é¡å‹">
                  <el-tag :type="form.targetType === 'SPOT' ? 'primary' : 'warning'" size="small">
                    {{ form.targetType === 'SPOT' ? 'æ©Ÿå°' : 'æ¤…å­' }}
                  </el-tag>
                </el-descriptions-item>

                <el-descriptions-item label="ç›®æ¨™åç¨±">{{ getTargetName }}</el-descriptions-item>

                <el-descriptions-item label="åŸ·è¡Œé »ç‡" :span="2">
                  <el-tag :type="scheduleTypeConfig[form.scheduleType]?.tagType" effect="plain">
                    <i :class="scheduleTypeConfig[form.scheduleType]?.icon" class="mr-1"></i>
                    {{ formatScheduleDetail(form) }}
                  </el-tag>
                </el-descriptions-item>

                <el-descriptions-item label="æŒ‡æ´¾äººå“¡">{{ getStaffName }}</el-descriptions-item>
                <el-descriptions-item label="å•Ÿç”¨ç‹€æ…‹">
                  <el-tag :type="form.isActive ? 'success' : 'info'" size="small">
                    {{ form.isActive ? 'å•Ÿç”¨' : 'åœç”¨' }}
                  </el-tag>
                </el-descriptions-item>
              </el-descriptions>
            </div>

            <!-- Buttons -->
            <div class="form-actions">
              <el-button @click="handleCancel">å–æ¶ˆ</el-button>
              <div class="action-right">
                <el-button v-if="currentStep > 0" @click="prevStep">
                  <i class="fas fa-chevron-left mr-1"></i> ä¸Šä¸€æ­¥
                </el-button>

                <el-button v-if="currentStep < steps.length - 1" type="primary" @click="nextStep">
                  ä¸‹ä¸€æ­¥ <i class="fas fa-chevron-right ml-1"></i>
                </el-button>

                <el-button v-else type="success" :loading="submitting" @click="handleSubmit">
                  <i class="fas fa-save mr-1"></i> {{ isEdit ? 'å„²å­˜è®Šæ›´' : 'å»ºç«‹æ’ç¨‹' }}
                </el-button>
              </div>
            </div>
          </el-form>
        </el-card>
      </div>
    </section>
  </div>
</template>

<style scoped>
.schedule-form-container {
  padding: 20px;
}

.page-title {
  font-size: 1.6rem;
  font-weight: 600;
  color: #303133;
  display: flex;
  align-items: center;
  margin: 0;
}

.form-card {
  border-radius: 12px;
  max-width: 800px;
  margin: 0 auto;
}

.mb-6 {
  margin-bottom: 2rem;
}
.step-content {
  min-height: 300px;
}

.step-header {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 1.1rem;
  font-weight: 600;
  color: #409eff;
  margin-bottom: 24px;
  padding-bottom: 12px;
  border-bottom: 2px solid #409eff;
}

/* ç›®æ¨™/æ’ç¨‹å¡ç‰‡ */
.target-type-cards,
.schedule-type-cards {
  display: flex;
  gap: 16px;
}
.target-card,
.schedule-card {
  flex: 1;
  padding: 20px;
  border: 2px solid #e4e7ed;
  border-radius: 12px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s;
}
.target-card:hover,
.schedule-card:hover {
  border-color: #409eff;
  background: rgba(64, 158, 255, 0.05);
}
.target-card.active,
.schedule-card.active {
  border-color: #409eff;
  background: rgba(64, 158, 255, 0.1);
  box-shadow: 0 0 0 3px rgba(64, 158, 255, 0.2);
}
.target-card i,
.schedule-card i {
  font-size: 2rem;
  color: #409eff;
  display: block;
  margin-bottom: 8px;
}
.target-card span,
.schedule-card span {
  font-size: 1rem;
  font-weight: 600;
  display: block;
}
.target-card small,
.schedule-card small {
  font-size: 12px;
  color: #909399;
  display: block;
  margin-top: 4px;
}

.option-item {
  display: flex;
  align-items: center;
}

/* âœ… å„ªå…ˆç´š Radioï¼šä¿®æ­£æ–‡å­—è¢«åƒæ‰ + ä¸åŒé¡è‰² */
.priority-radio {
  width: 100%;
}
.priority-radio :deep(.el-radio-button) {
  flex: 1;
}
.priority-radio :deep(.el-radio-button__inner) {
  width: 100%;
}

.priority-radio :deep(.el-radio-button__original-radio:checked + .el-radio-button__inner) {
  color: #fff !important;
  border-color: transparent !important;
}

/* âœ… ä¾ä¸åŒå„ªå…ˆç´šä¸Šè‰² */
.priority-radio :deep([data-priority='LOW'].is-active .el-radio-button__inner) {
  background: #909399 !important;
}
.priority-radio :deep([data-priority='NORMAL'].is-active .el-radio-button__inner) {
  background: #409eff !important;
}
.priority-radio :deep([data-priority='HIGH'].is-active .el-radio-button__inner) {
  background: #e6a23c !important;
}
.priority-radio :deep([data-priority='URGENT'].is-active .el-radio-button__inner) {
  background: #f56c6c !important;
}

.summary-desc {
  margin-top: 16px;
}
.summary-desc :deep(.el-descriptions__label) {
  width: 100px;
  font-weight: 500;
}

.form-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-top: 24px;
  margin-top: 24px;
  border-top: 1px solid #ebeef5;
}
.action-right {
  display: flex;
  gap: 12px;
}

.mr-1 {
  margin-right: 4px;
}
.mr-2 {
  margin-right: 8px;
}
.ml-1 {
  margin-left: 4px;
}
.ml-2 {
  margin-left: 8px;
}
.mt-4 {
  margin-top: 1rem;
}
</style>
</file>

<file path="frontend/src/views/maintenance/ScheduleList.vue">
<script setup>
import { ref, onMounted, computed, watch } from 'vue'
import { useRouter } from 'vue-router'
import maintenanceApi from '@/api/modules/maintenance'
import Swal from 'sweetalert2'
import { usePagination } from '@/composables/maintenance/usePagination'
import { useScheduleConfig } from '@/composables/maintenance/useScheduleConfig'
import ScheduleCalendar from '@/components/maintenance/ScheduleCalendar.vue'
import { Calendar, List, Clock } from '@element-plus/icons-vue'

const router = useRouter()
const { scheduleTypeConfig, formatDateTime, formatScheduleDetail, getRelativeTime } =
  useScheduleConfig()

// ====== è³‡æ–™ç‹€æ…‹ ======
const schedules = ref([])
const loading = ref(true)
const pageVisible = ref(false)
const searchText = ref('')
const viewMode = ref('table') // 'table' | 'calendar'

// ====== å½ˆçª—æ§åˆ¶ ======
const showHistoryDialog = ref(false)
const showDeletedDialog = ref(false)
const historyTickets = ref([])
const deletedSchedules = ref([])
const dialogLoading = ref(false)

const historySpots = ref([])
const historySeats = ref([])

const statusMap = {
  ASSIGNED: 'å·²æŒ‡æ´¾',
  PENDING: 'å¾…è™•ç†',
  In_Progress: 'è™•ç†ä¸­',
  IN_PROGRESS: 'è™•ç†ä¸­',
  RESOLVED: 'å·²å®Œæˆ',
  COMPLETED: 'å·²å®Œæˆ',
  CLOSED: 'å·²çµæ¡ˆ',
  CANCELLED: 'å·²å–æ¶ˆ',
}

// ====== API è³‡æ–™è®€å– ======
const fetchSchedules = async () => {
  try {
    loading.value = true
    const res = await maintenanceApi.getAllSchedules()
    schedules.value = res.data
  } catch {
    // éŒ¯èª¤å·²ç”± http.js æ””æˆªå™¨è™•ç†
  } finally {
    loading.value = false
    setTimeout(() => (pageVisible.value = true), 100)
  }
}

// ====== çµ±è¨ˆæ•¸æ“š ======
const stats = computed(() => {
  const active = schedules.value.filter((s) => s.isActive)
  const daily = active.filter((s) => s.scheduleType === 'DAILY').length
  const weekly = active.filter((s) => s.scheduleType === 'WEEKLY').length
  const monthly = active.filter((s) => s.scheduleType === 'MONTHLY').length

  // å³å°‡åŸ·è¡Œï¼ˆ24å°æ™‚å…§ï¼‰
  const now = new Date()
  const tomorrow = new Date(now.getTime() + 24 * 60 * 60 * 1000)
  const upcoming = active.filter((s) => {
    const next = new Date(s.nextExecuteAt)
    return next >= now && next <= tomorrow
  }).length

  return { total: active.length, daily, weekly, monthly, upcoming }
})

// ====== å³å°‡åŸ·è¡Œçš„æ’ç¨‹ (Timeline ç”¨) ======
const upcomingSchedules = computed(() => {
  const now = new Date()
  return schedules.value
    .filter((s) => s.isActive && new Date(s.nextExecuteAt) >= now)
    .sort((a, b) => new Date(a.nextExecuteAt) - new Date(b.nextExecuteAt))
    .slice(0, 5)
})

// ====== ç¯©é¸é‚è¼¯ï¼ˆâœ… å¼·åŒ–æœå°‹æ¬„ä½ï¼‰ ======
const filteredList = computed(() => {
  const key = searchText.value.trim().toLowerCase()
  const list = schedules.value.filter((s) => s.isActive === true)

  if (!key) return list

  return list.filter((s) => {
    const idHit = String(s.scheduleId).includes(key)
    const titleHit = (s.title || '').toLowerCase().includes(key)
    const issueTypeHit = (s.issueType || '').toLowerCase().includes(key)
    const targetTypeHit = (s.targetType || '').toLowerCase().includes(key)
    const staffHit = (s.assignedStaffName || '').toLowerCase().includes(key)
    const scheduleTypeHit = (s.scheduleType || '').toLowerCase().includes(key)

    return idHit || titleHit || issueTypeHit || targetTypeHit || staffHit || scheduleTypeHit
  })
})

// ====== åˆ†é  ======
const { currentPage, pageSize, paginatedList, total, resetPagination } = usePagination(
  filteredList,
  10,
)

watch(searchText, () => resetPagination())

// ====== æ¥­å‹™é‚è¼¯ ======
const handleCreate = () => router.push('/admin/maintenance/schedule/create')
// FIX: åˆ¤æ–· scheduleId æ˜¯å¦ç‚ºæœ‰æ•ˆæ•¸å­—ï¼ˆéæ¿¾æ­·å²éºç•™çš„å­—ä¸² IDï¼‰
const isValidScheduleId = (scheduleId) => {
  return (
    typeof scheduleId === 'number' || (typeof scheduleId === 'string' && /^\d+$/.test(scheduleId))
  )
}

const handleEdit = (row) => {
  // ã€å¥å£¯æ€§ä¿è­·ã€‘è‹¥ scheduleId ä¸æ˜¯æœ‰æ•ˆæ•¸å­—ï¼Œç¦æ­¢ç·¨è¼¯
  if (!isValidScheduleId(row.scheduleId)) {
    Swal.fire({
      icon: 'warning',
      title: 'ç„¡æ³•ç·¨è¼¯',
      text: 'æ­¤æ’ç¨‹ ID ç•°å¸¸ï¼Œè«‹åˆªé™¤å¾Œé‡æ–°å»ºç«‹',
      confirmButtonColor: '#409eff',
    })
    return
  }
  router.push(`/admin/maintenance/schedule/edit/${row.scheduleId}`)
}

// ============================================================================
// âœ… ã€ä»»å‹™äºŒã€‘å®Œæ•´ Demo Workflowï¼ˆåºåˆ—åŸ·è¡Œï¼‰ï¼š
//    Step 1: å…ˆå»ºç«‹æ’ç¨‹ â†’ Step 2: å–å¾— scheduleId â†’ Step 3: å»ºç«‹é—œè¯å·¥å–®
// ç¬¦åˆå¾Œç«¯é©—è­‰ï¼štargetType ä½¿ç”¨å–®æ•¸ 'SPOT' æˆ– 'SEAT'ï¼ŒID æ¬„ä½ç”¨è¤‡æ•¸ seatsId
// ============================================================================
const handleCreateDemoSchedules = async () => {
  // ã€é˜²æ­¢é‡è¤‡é»æ“Šã€‘é–‹å•Ÿ Loading
  loading.value = true

  try {
    // ========== Step 1: å–å¾—çœŸå¯¦è³‡æ–™ï¼ˆæ•ˆèƒ½å„ªåŒ–ï¼šPromise.all ä¸¦è¡Œè«‹æ±‚ï¼‰==========
    const [spotsRes, seatsRes, staffRes] = await Promise.all([
      maintenanceApi.getAllSpots(),
      maintenanceApi.getAllSeats(),
      maintenanceApi.getAllStaff(),
    ])

    const spots = spotsRes.data || []
    const seats = seatsRes.data || []
    const staffs = staffRes.data || []

    // ã€é˜²å‘†æª¢æŸ¥ã€‘å¦‚æœå®Œå…¨æ²’æœ‰è¨­å‚™ï¼Œç„¡æ³•å»ºç«‹
    if (spots.length === 0 && seats.length === 0) {
      Swal.fire('ç„¡æ³•å»ºç«‹', 'ç³»çµ±ä¸­æ²’æœ‰ä»»ä½•æ©Ÿå°æˆ–æ¤…å­å¯ä¾›ç¶å®š', 'warning')
      return
    }

    // ========== Step 2: æ±ºå®šç›®æ¨™é¡å‹èˆ‡ç‰©ä»¶ ==========
    //  å¾Œç«¯ Enum åš´æ ¼æª¢æŸ¥ï¼štargetType å¿…é ˆæ˜¯å–®æ•¸ 'SPOT' æˆ– 'SEAT'
    let targetType = 'SPOT'
    if (seats.length > 0 && spots.length > 0) {
      targetType = Math.random() > 0.5 ? 'SPOT' : 'SEAT'
    } else if (seats.length > 0) {
      targetType = 'SEAT'
    } else if (spots.length > 0) {
      targetType = 'SPOT'
    }

    const targetList = targetType === 'SPOT' ? spots : seats
    const randomTarget = targetList[Math.floor(Math.random() * targetList.length)]

    //  æ¬„ä½å‘½åé™·é˜±ï¼šå¾Œç«¯ DB ç”¨ seatsId (è¤‡æ•¸)ï¼Œä½† targetType ç”¨ SEAT (å–®æ•¸)
    const realTargetId = targetType === 'SPOT' ? randomTarget.spotId : randomTarget.seatsId
    const targetName = randomTarget.spotName || randomTarget.seatsName || 'è¨­å‚™'

    // ========== Step 3: éš¨æ©ŸæŒ‡æ´¾å“¡å·¥ï¼ˆåªé¸ Activeï¼‰==========
    const activeStaffs = staffs.filter((s) => s.isActive)
    const randomStaff =
      activeStaffs.length > 0 ? activeStaffs[Math.floor(Math.random() * activeStaffs.length)] : null

    // ========== Step 4: æº–å‚™æ’ç¨‹åƒæ•¸ ==========
    const scheduleTypes = ['DAILY', 'WEEKLY', 'MONTHLY']
    const randomScheduleType = scheduleTypes[Math.floor(Math.random() * scheduleTypes.length)]

    // âœ… å¿…é ˆå®šç¾© executeTimeStr é¿å…å ±éŒ¯
    const executeTimeStr = '10:00:00'

    // ========== Step 5: å»ºç«‹æ’ç¨‹ Payload ==========
    const schedulePayload = {
      title: `${targetName} å®šæœŸä¿é¤Š`,
      scheduleType: randomScheduleType,
      issueType: 'ä¾‹è¡Œä¿é¤Š',
      issuePriority: 'NORMAL',
      isActive: true,
      executeTime: executeTimeStr,

      // âš ï¸ é‡è¦ï¼šå‚³çµ¦å¾Œç«¯çš„ targetType æ˜¯å–®æ•¸ 'SEAT'
      targetType: targetType,

      // âš ï¸ é€šç”¨é©—è­‰æ¬„ä½ï¼štargetId å¿…å¡«
      targetId: realTargetId,

      // âš ï¸ æ¬„ä½å°æ‡‰ï¼šæ ¹æ“š targetType å¡«å…¥å°æ‡‰çš„ ID æ¬„ä½
      // è‹¥ targetType ç‚º 'SEAT'ï¼ŒID å¡«å…¥ seatsId (è¤‡æ•¸) æ¬„ä½
      spotId: targetType === 'SPOT' ? realTargetId : null,
      seatsId: targetType === 'SEAT' ? realTargetId : null,

      assignedStaffId: randomStaff ? randomStaff.staffId : null,

      // é »ç‡åƒæ•¸ï¼ˆæ ¹æ“š scheduleType æ±ºå®šï¼‰
      dayOfWeek: randomScheduleType === 'WEEKLY' ? Math.floor(Math.random() * 7) + 1 : null,
      dayOfMonth: randomScheduleType === 'MONTHLY' ? Math.floor(Math.random() * 28) + 1 : null,
    }

    // ========== Step 6: ã€åºåˆ—åŸ·è¡Œã€‘å…ˆå»ºç«‹æ’ç¨‹ï¼Œå–å¾— scheduleId ==========
    // âœ… ä¿®å¾©æ­·å²ç´€éŒ„æ¶ˆå¤±å•é¡Œï¼šå¿…é ˆå…ˆå»ºç«‹æ’ç¨‹ï¼Œå†ç”¨å›å‚³çš„ scheduleId å»ºç«‹å·¥å–®
    const scheduleRes = await maintenanceApi.createSchedule(schedulePayload)

    // âœ… ç²¾ç¢ºæå– scheduleIdï¼ˆåƒè€ƒ DTO çµæ§‹ï¼‰
    const createdScheduleId = scheduleRes.data?.scheduleId
    console.log(' æ’ç¨‹å»ºç«‹æˆåŠŸï¼ŒscheduleId:', createdScheduleId)

    // ========== Step 7: ã€åºåˆ—åŸ·è¡Œã€‘å»ºç«‹ã€Œå·²å®Œæˆã€å·¥å–®ï¼ˆæ¨¡æ“¬å‰›åšå®Œçš„ä¿é¤Šï¼‰==========

    // ========== Step 8: ã€åºåˆ—åŸ·è¡Œã€‘å»ºç«‹ã€Œå¾…è™•ç†ã€å·¥å–®ï¼ˆæ¨¡æ“¬ä¸‹æ¬¡æ’ç¨‹ä»»å‹™ï¼‰==========
    const pendingTicketPayload = {
      spotId: targetType === 'SPOT' ? realTargetId : null,
      seatsId: targetType === 'SEAT' ? realTargetId : null,

      // âœ… å¸¶å…¥ scheduleIdï¼Œç¢ºä¿æ­·å²ç´€éŒ„èƒ½é—œè¯åˆ°æ’ç¨‹
      scheduleId: createdScheduleId,

      issueType: 'ä¿é¤Š',
      issueDesc: `ä¸‹æ¬¡ä¿é¤Šå–® (æ’ç¨‹ID: ${createdScheduleId})`,
      issuePriority: 'NORMAL',
      issueStatus: 'ASSIGNED', // âœ… å¾…è™•ç†ç‹€æ…‹ï¼ˆå·²æŒ‡æ´¾ï¼‰
      assignedStaffId: randomStaff ? randomStaff.staffId : null,
    }

    // å†å»ºç«‹å¾…è™•ç†å·¥å–®
    await maintenanceApi.createTicket(pendingTicketPayload)
    console.log(' å¾…è™•ç†å·¥å–®å»ºç«‹æˆåŠŸ')

    // ========== Step 9: åˆ·æ–°ç•«é¢ & é€šçŸ¥å…¶ä»–é é¢ ==========
    await fetchSchedules()

    // âœ… è§¸ç™¼è·¨é äº‹ä»¶ï¼Œè®“äººå“¡åˆ—è¡¨é èƒ½å³æ™‚æ›´æ–°çµ±è¨ˆ
    window.dispatchEvent(new CustomEvent('maintenance:tickets-changed'))

    // ========== Step 10: é¡¯ç¤ºæˆåŠŸè¨Šæ¯ï¼ˆæ¢åˆ—å¼èªªæ˜ï¼‰==========
    Swal.fire({
      icon: 'success',
      title: 'å»ºç«‹æˆåŠŸ',
      html: `
        <div style="text-align: left; line-height: 2;">
          <p><i class="fas fa-calendar-check" style="color:#409eff"></i> <b>å·²å»ºç«‹æ’ç¨‹</b>ï¼š${schedulePayload.title}</p>
          <p><i class="fas fa-check-circle" style="color:#67c23a"></i> <b>å·²ç”Ÿæˆå®Œå·¥å–®æ“š</b>ï¼šä¿é¤Šå·²å®Œæˆ</p>
          <p><i class="fas fa-clock" style="color:#e6a23c"></i> <b>å·²é æ’ä¸‹æ¬¡ä»»å‹™</b>ï¼šå¾…è™•ç†ä¿é¤Šå–®</p>
          ${randomStaff ? `<p><i class="fas fa-user" style="color:#909399"></i> <b>æŒ‡æ´¾äººå“¡</b>ï¼š${randomStaff.staffName}</p>` : ''}
          <p style="color:#909399;font-size:12px;margin-top:8px;">(æ’ç¨‹ID: ${createdScheduleId})</p>
        </div>
      `,
      confirmButtonColor: '#409eff',
    })
  } catch (error) {
    console.error('å»ºç«‹æ¸¬è©¦è³‡æ–™å¤±æ•—:', error)
    const msg =
      error.response?.data?.message || error.response?.data?.error || 'å»ºç«‹æ¸¬è©¦è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤'
    Swal.fire('éŒ¯èª¤', msg, 'error')
  } finally {
    loading.value = false
  }
}

// â˜… switchï¼šç¢ºèªæˆåŠŸæ‰åˆ‡æ›
const handleToggleConfirm = async (row) => {
  const action = row.isActive ? 'åœç”¨' : 'å•Ÿç”¨'

  const result = await Swal.fire({
    title: `ç¢ºå®šè¦${action}æ­¤æ’ç¨‹å—ï¼Ÿ`,
    html: `
      <div style="text-align: center;">
        <p>æ’ç¨‹ï¼š<b style="color: ${row.isActive ? '#f56c6c' : '#67c23a'}">${row.title}</b></p>
        <p style="color: #909399; font-size: 13px;">${row.isActive ? 'åœç”¨å¾Œå°‡ä¸æœƒè‡ªå‹•åŸ·è¡Œ' : 'å•Ÿç”¨å¾Œå°‡æ¢å¾©è‡ªå‹•åŸ·è¡Œ'}</p>
      </div>
    `,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: row.isActive ? '#f56c6c' : '#67c23a',
    confirmButtonText: `ç¢ºèª${action}`,
    cancelButtonText: 'å–æ¶ˆ',
  })

  if (!result.isConfirmed) return false

  try {
    await maintenanceApi.toggleSchedule(row.scheduleId)
    await fetchSchedules()

    await Swal.fire({
      icon: 'success',
      title: `å·²${action}`,
      html: row.isActive
        ? '<p style="color: #909399; font-size: 13px;">æ’ç¨‹å·²ç§»è‡³ã€Œå·²åœç”¨ã€æ¸…å–®</p>'
        : '',
      timer: row.isActive ? 900 : 900,
      showConfirmButton: false,
    })
    return true
  } catch (error) {
    console.error('åˆ‡æ›ç‹€æ…‹å¤±æ•—:', error)
    const errorMsg = error?.response?.data?.message || `${action}å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦`
    Swal.fire('éŒ¯èª¤', errorMsg, 'error')
    return false
  }
}

const handleDelete = async (row) => {
  // ã€ä»»å‹™ä¸‰ã€‘å„ªåŒ–åˆªé™¤æç¤º - è­¦å‘Šç”¨æˆ¶æ­¤æ“ä½œå°‡æ°¸ä¹…ç§»é™¤è³‡æ–™
  const result = await Swal.fire({
    title: 'â— ç¢ºå®šè¦åˆªé™¤ï¼Ÿ',
    html: `
      <div style="text-align: left;">
        <p>æ’ç¨‹ï¼š<b style="color:#f56c6c">${row.title}</b></p>
        <hr style="border:none;border-top:1px solid #eee;margin:12px 0;">
        <p style="color:#909399;font-size:13px;">
          <i class="fas fa-exclamation-triangle" style="color:#e6a23c"></i>
          <b>æ³¨æ„ï¼š</b>æ­¤æ“ä½œå°‡æ°¸ä¹…ç§»é™¤è³‡æ–™ï¼Œç„¡æ³•å¾©åŸï¼
        </p>
        <p style="color:#909399;font-size:13px;">
          è‹¥åƒ…éœ€æš«åœæ’ç¨‹ï¼Œè«‹ä½¿ç”¨ã€Œç‹€æ…‹é–‹é—œã€å°‡å…¶åœç”¨ã€‚
        </p>
      </div>
    `,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#f56c6c',
    cancelButtonColor: '#909399',
    confirmButtonText: '<i class="fas fa-trash-alt"></i> ç¢ºèªåˆªé™¤',
    cancelButtonText: 'å–æ¶ˆ',
  })

  if (result.isConfirmed) {
    try {
      await maintenanceApi.deleteSchedule(row.scheduleId)
      await fetchSchedules()
      Swal.fire({ icon: 'success', title: 'å·²åˆªé™¤', timer: 1000, showConfirmButton: false })
    } catch {
      /* handled */
    }
  }
}

// ====== å½ˆçª—é‚è¼¯ ======
const openHistoryDialog = async () => {
  showHistoryDialog.value = true
  dialogLoading.value = true
  try {
    // ç”¨ Promise.all åŒæ™‚æ’ˆå– å·¥å–®ã€æ©Ÿå°ã€æ¤…å­ è³‡æ–™ï¼Œä»¥ä¾¿é¡¯ç¤ºåç¨± (è§£æ±ºå•é¡Œ 3)
    const [ticketsRes, spotsRes, seatsRes] = await Promise.all([
      maintenanceApi.getAllTickets(),
      maintenanceApi.getAllSpots(),
      maintenanceApi.getAllSeats(),
    ])

    historySpots.value = spotsRes.data || []
    historySeats.value = seatsRes.data || []

    // éæ¿¾å‡ºèˆ‡è‡ªå‹•ä¿é¤Šç›¸é—œçš„å·¥å–®
    historyTickets.value = ticketsRes.data.filter(
      (t) => t.issueDesc && t.issueDesc.includes('å·²å®Œæˆä¿é¤Šå–®'), // æˆ–æ˜¯ä¾ç…§æ‚¨çš„ç¯©é¸é‚è¼¯
    )
  } catch (e) {
    console.error(e)
    Swal.fire('éŒ¯èª¤', 'ç„¡æ³•è®€å–æ­·å²ç´€éŒ„', 'error')
  } finally {
    dialogLoading.value = false
  }
}

//  å–å¾—ç›®æ¨™åç¨±çš„è¼”åŠ©å‡½å¼ (è§£æ±ºå•é¡Œ 3)
const getHistoryTargetName = (row) => {
  if (row.spotId) {
    const spot = historySpots.value.find((s) => s.spotId === row.spotId)
    return spot ? `æ©Ÿå°: ${spot.spotName}` : `æ©Ÿå° #${row.spotId}`
  } else if (row.seatsId) {
    const seat = historySeats.value.find((s) => s.seatsId === row.seatsId)
    return seat ? `æ¤…å­: ${seat.seatsName}` : `æ¤…å­ #${row.seatsId}`
  }
  return '-'
}

// ============================================================================
// ã€ä»»å‹™ä¸‰ã€‘å·²åœç”¨æ’ç¨‹ Dialog
// â„¹ï¸ èªªæ˜ï¼šæ­¤è¦–çª—é¡¯ç¤ºçš„æ˜¯ isActive=false çš„ã€Œå·²åœç”¨ã€æ’ç¨‹
//    å¾©åŸåŠŸèƒ½æ˜¯å°‡ isActive åˆ‡æ›å› trueï¼Œä¸¦éå¾è³‡æ–™åº«ä¸­æ¢å¾©å·²åˆªé™¤çš„è³‡æ–™
//    è‹¥è³‡æ–™å·²è¢«ã€ŒçœŸåˆªé™¤ã€ï¼ˆå¾ DB ç§»é™¤ï¼‰ï¼Œå‰‡ç„¡æ³•å¾©åŸ
// ============================================================================
const openDeletedDialog = async () => {
  showDeletedDialog.value = true
  dialogLoading.value = true
  try {
    const res = await maintenanceApi.getAllSchedules()
    deletedSchedules.value = res.data.filter((s) => !s.isActive)
  } catch (e) {
    console.error(e)
  } finally {
    dialogLoading.value = false
  }
}

const handleRestore = async (row) => {
  try {
    await maintenanceApi.toggleSchedule(row.scheduleId)
    Swal.fire({ icon: 'success', title: 'æ’ç¨‹å·²å¾©åŸ', showConfirmButton: false, timer: 1000 })
    await fetchSchedules()
    openDeletedDialog()
  } catch {
    Swal.fire('éŒ¯èª¤', 'å¾©åŸå¤±æ•—', 'error')
  }
}

// ====== æ—¥æ›†é»æ“Šäº‹ä»¶ ======
const handleCalendarScheduleClick = (schedule) => {
  handleEdit(schedule)
}

onMounted(fetchSchedules)
</script>

<template>
  <div class="schedule-list-container">
    <!-- ========== Header ========== -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row align-items-center">
          <div class="col-sm-6">
            <h1 class="page-title">
              <i class="fas fa-calendar-check mr-2" style="color: #409eff"></i>
              å®šæœŸç¶­è­·æ’ç¨‹
            </h1>
          </div>
          <div class="col-sm-6 text-right">
            <el-button-group class="mr-2">
              <el-button type="info" plain @click="openHistoryDialog">
                <i class="fas fa-history mr-1"></i> ä¿é¤Šç´€éŒ„
              </el-button>
              <el-button type="warning" plain @click="openDeletedDialog">
                <i class="fas fa-trash-alt mr-1"></i> å·²åœç”¨
              </el-button>
              <el-button type="success" plain @click="handleCreateDemoSchedules">
                <i class="fas fa-magic mr-1"></i> ä¸€éµå¸¶å…¥
              </el-button>
            </el-button-group>
            <el-button type="primary" @click="handleCreate">
              <i class="fas fa-plus mr-1"></i> æ–°å¢æ’ç¨‹
            </el-button>
          </div>
        </div>
      </div>
    </section>

    <section class="content">
      <div class="container-fluid">
        <transition name="fade-slide" appear>
          <div v-if="pageVisible">
            <!-- ========== çµ±è¨ˆå¡ç‰‡ ========== -->
            <el-row :gutter="16" class="mb-4">
              <el-col :xs="12" :sm="6" :md="4">
                <el-card shadow="hover" class="stat-card stat-total">
                  <el-statistic title="å•Ÿç”¨ä¸­æ’ç¨‹" :value="stats.total">
                    <template #prefix><i class="fas fa-calendar-check"></i></template>
                  </el-statistic>
                </el-card>
              </el-col>
              <el-col :xs="12" :sm="6" :md="4">
                <el-card shadow="hover" class="stat-card stat-upcoming">
                  <el-statistic title="24å°æ™‚å…§åŸ·è¡Œ" :value="stats.upcoming">
                    <template #prefix><i class="fas fa-clock"></i></template>
                  </el-statistic>
                </el-card>
              </el-col>
              <el-col :xs="12" :sm="6" :md="4">
                <el-card shadow="hover" class="stat-card stat-daily">
                  <el-statistic title="æ¯æ—¥æ’ç¨‹" :value="stats.daily">
                    <template #prefix><i class="fas fa-sun"></i></template>
                  </el-statistic>
                </el-card>
              </el-col>
              <el-col :xs="12" :sm="6" :md="4">
                <el-card shadow="hover" class="stat-card stat-weekly">
                  <el-statistic title="æ¯é€±æ’ç¨‹" :value="stats.weekly">
                    <template #prefix><i class="fas fa-calendar-week"></i></template>
                  </el-statistic>
                </el-card>
              </el-col>
              <el-col :xs="12" :sm="6" :md="4">
                <el-card shadow="hover" class="stat-card stat-monthly">
                  <el-statistic title="æ¯æœˆæ’ç¨‹" :value="stats.monthly">
                    <template #prefix><i class="fas fa-calendar-alt"></i></template>
                  </el-statistic>
                </el-card>
              </el-col>
            </el-row>

            <el-row :gutter="16">
              <!-- ========== ä¸»å…§å®¹å€ ========== -->
              <el-col :xs="24" :lg="17">
                <el-card shadow="hover" class="main-card">
                  <!-- å·¥å…·åˆ— -->
                  <div class="toolbar">
                    <el-input
                      v-model="searchText"
                      placeholder="æœå°‹ï¼šæ¨™é¡Œ / é¡å‹ / äººå“¡ / ID / ç›®æ¨™..."
                      clearable
                      prefix-icon="Search"
                      style="width: 320px"
                    />
                    <div class="toolbar-right">
                      <el-radio-group v-model="viewMode" size="small">
                        <el-radio-button value="table">
                          <el-icon><List /></el-icon> åˆ—è¡¨
                        </el-radio-button>
                        <el-radio-button value="calendar">
                          <el-icon><Calendar /></el-icon> æ—¥æ›†
                        </el-radio-button>
                      </el-radio-group>
                      <el-button @click="fetchSchedules" :loading="loading" class="ml-2">
                        <i class="fas fa-sync-alt"></i>
                      </el-button>
                    </div>
                  </div>

                  <!-- åˆ—è¡¨è¦–åœ– -->
                  <div v-show="viewMode === 'table'">
                    <el-table
                      :data="paginatedList"
                      v-loading="loading"
                      stripe
                      style="width: 100%"
                      :header-cell-style="{ background: '#f5f7fa', fontWeight: 'bold' }"
                    >
                      <el-table-column prop="scheduleId" label="ID" width="60" align="center">
                        <template #default="{ row }">
                          <!-- FIX: ä½¿ç”¨ isValidScheduleId åˆ¤æ–·ï¼Œéæ•¸å­— ID æ¨™è¨˜ç‚ºç•°å¸¸ -->
                          <el-tag
                            v-if="!isValidScheduleId(row.scheduleId)"
                            type="danger"
                            size="small"
                            effect="light"
                          >
                            ç•°å¸¸
                          </el-tag>
                          <span v-else>{{ row.scheduleId }}</span>
                        </template>
                      </el-table-column>

                      <el-table-column prop="title" label="æ’ç¨‹æ¨™é¡Œ" min-width="160">
                        <template #default="{ row }">
                          <div class="title-cell">
                            <i
                              :class="scheduleTypeConfig[row.scheduleType]?.icon"
                              :style="{ color: scheduleTypeConfig[row.scheduleType]?.color }"
                              class="mr-2"
                            ></i>
                            <span>{{ row.title }}</span>
                          </div>
                        </template>
                      </el-table-column>

                      <el-table-column label="é »ç‡" width="140" align="center">
                        <template #default="{ row }">
                          <el-tag
                            :type="scheduleTypeConfig[row.scheduleType]?.tagType"
                            size="small"
                            effect="plain"
                          >
                            {{ formatScheduleDetail(row) }}
                          </el-tag>
                        </template>
                      </el-table-column>

                      <el-table-column label="ç›®æ¨™" width="80" align="center">
                        <template #default="{ row }">
                          <el-tag
                            :type="row.targetType === 'SPOT' ? 'primary' : 'warning'"
                            size="small"
                            effect="light"
                          >
                            {{ row.targetType === 'SPOT' ? 'æ©Ÿå°' : 'æ¤…å­' }}
                          </el-tag>
                        </template>
                      </el-table-column>

                      <el-table-column label="è² è²¬äººå“¡" width="110" align="center">
                        <template #default="{ row }">
                          <el-tag
                            v-if="row.assignedStaffId"
                            type="success"
                            size="small"
                            effect="plain"
                          >
                            <i class="fas fa-user mr-1"></i>
                            {{ row.assignedStaffName || `#${row.assignedStaffId}` }}
                          </el-tag>
                          <span v-else style="color: #909399; font-size: 12px">æœªæŒ‡æ´¾</span>
                        </template>
                      </el-table-column>

                      <el-table-column label="ä¸‹æ¬¡åŸ·è¡Œ" width="150">
                        <template #default="{ row }">
                          <div class="next-exec-cell">
                            <span class="datetime">{{ formatDateTime(row.nextExecuteAt) }}</span>
                            <el-tag
                              :type="
                                getRelativeTime(row.nextExecuteAt).isOverdue
                                  ? 'danger'
                                  : getRelativeTime(row.nextExecuteAt).isSoon
                                    ? 'warning'
                                    : 'info'
                              "
                              size="small"
                              effect="plain"
                              class="relative-tag"
                            >
                              {{ getRelativeTime(row.nextExecuteAt).text }}
                            </el-tag>
                          </div>
                        </template>
                      </el-table-column>

                      <el-table-column label="ç‹€æ…‹" width="80" align="center">
                        <template #default="{ row }">
                          <el-switch
                            :model-value="row.isActive"
                            active-color="#67c23a"
                            inactive-color="#dcdfe6"
                            :before-change="() => handleToggleConfirm(row)"
                          />
                        </template>
                      </el-table-column>

                      <el-table-column label="æ“ä½œ" width="100" align="center">
                        <template #default="{ row }">
                          <el-button-group>
                            <!-- FIX: ä½¿ç”¨ isValidScheduleId åˆ¤æ–·ï¼Œéæ•¸å­— ID ç¦ç”¨ç·¨è¼¯ -->
                            <el-tooltip
                              :content="
                                isValidScheduleId(row.scheduleId)
                                  ? 'ç·¨è¼¯æ’ç¨‹'
                                  : 'æ’ç¨‹ ID ç•°å¸¸ï¼Œè«‹åˆªé™¤å¾Œé‡æ–°åŒ¯å…¥'
                              "
                              placement="top"
                            >
                              <el-button
                                size="small"
                                type="primary"
                                @click="handleEdit(row)"
                                :disabled="!isValidScheduleId(row.scheduleId)"
                              >
                                <i class="fas fa-edit"></i>
                              </el-button>
                            </el-tooltip>
                            <el-button size="small" type="danger" @click="handleDelete(row)">
                              <i class="fas fa-trash-alt"></i>
                            </el-button>
                          </el-button-group>
                        </template>
                      </el-table-column>
                    </el-table>

                    <div class="pagination-bar">
                      <el-pagination
                        v-model:current-page="currentPage"
                        v-model:page-size="pageSize"
                        :page-sizes="[10, 20, 50]"
                        :total="total"
                        layout="total, sizes, prev, pager, next"
                        background
                        small
                      />
                    </div>
                  </div>

                  <!-- âœ… æ—¥æ›†è¦–åœ–ï¼šåƒæœå°‹å¾Œ filteredList -->
                  <div v-show="viewMode === 'calendar'">
                    <ScheduleCalendar
                      :schedules="filteredList"
                      @click-schedule="handleCalendarScheduleClick"
                    />
                  </div>
                </el-card>
              </el-col>

              <!-- ========== å´é‚Šæ¬„ï¼šå³å°‡åŸ·è¡Œ ========== -->
              <el-col :xs="24" :lg="7">
                <el-card shadow="hover" class="timeline-card">
                  <template #header>
                    <div class="card-header">
                      <el-icon><Clock /></el-icon>
                      <span>å³å°‡åŸ·è¡Œ</span>
                      <el-badge :value="upcomingSchedules.length" :max="9" class="ml-auto" />
                    </div>
                  </template>

                  <el-timeline v-if="upcomingSchedules.length > 0">
                    <el-timeline-item
                      v-for="schedule in upcomingSchedules"
                      :key="schedule.scheduleId"
                      :color="scheduleTypeConfig[schedule.scheduleType]?.color"
                      :hollow="true"
                    >
                      <div class="timeline-content" @click="handleEdit(schedule)">
                        <div class="timeline-title">{{ schedule.title }}</div>
                        <div class="timeline-meta">
                          <el-tag size="small" effect="plain">
                            {{ schedule.targetType === 'SPOT' ? 'æ©Ÿå°' : 'æ¤…å­' }}
                          </el-tag>
                          <span class="timeline-time">
                            {{ formatDateTime(schedule.nextExecuteAt) }}
                          </span>
                        </div>
                      </div>
                    </el-timeline-item>
                  </el-timeline>

                  <el-empty v-else description="æš«ç„¡å³å°‡åŸ·è¡Œçš„æ’ç¨‹" :image-size="80" />
                </el-card>
              </el-col>
            </el-row>
          </div>
        </transition>
      </div>

      <!-- ========== ä¿é¤Šç´€éŒ„ Dialog ========== -->
      <el-dialog v-model="showHistoryDialog" title="ğŸ“œ ç³»çµ±è‡ªå‹•ä¿é¤Šç´€éŒ„" width="70%" draggable>
        <el-table :data="historyTickets" v-loading="dialogLoading" max-height="400" stripe>
          <el-table-column prop="ticketId" label="ID" width="70" />

          <el-table-column label="ä¿é¤Šç›®æ¨™" min-width="150">
            <template #default="{ row }">
              {{ getHistoryTargetName(row) }}
            </template>
          </el-table-column>

          <el-table-column prop="issueDesc" label="æè¿°" show-overflow-tooltip />

          <el-table-column prop="reportedAt" label="åŸ·è¡Œæ™‚é–“" width="160">
            <template #default="{ row }">{{ formatDateTime(row.reportedAt) }}</template>
          </el-table-column>

          <el-table-column prop="issueStatus" label="ç‹€æ…‹" width="100">
            <template #default="{ row }">
              <el-tag size="small" :type="row.issueStatus === 'RESOLVED' ? 'success' : 'info'">
                {{ statusMap[row.issueStatus] || row.issueStatus }}
              </el-tag>
            </template>
          </el-table-column>
        </el-table>
      </el-dialog>

      <!-- ========== å·²åœç”¨ Dialog ========== -->
      <el-dialog v-model="showDeletedDialog" title="ğŸ—‘ï¸ å·²åœç”¨æ’ç¨‹" width="60%" draggable>
        <el-table :data="deletedSchedules" v-loading="dialogLoading" max-height="400" stripe>
          <el-table-column prop="scheduleId" label="ID" width="70" />
          <el-table-column prop="title" label="æ¨™é¡Œ" />
          <el-table-column label="é¡å‹" width="100">
            <template #default="{ row }">
              <el-tag :type="scheduleTypeConfig[row.scheduleType]?.tagType" size="small">
                {{ scheduleTypeConfig[row.scheduleType]?.text }}
              </el-tag>
            </template>
          </el-table-column>
          <el-table-column label="æ“ä½œ" width="100">
            <template #default="{ row }">
              <el-button size="small" type="success" @click="handleRestore(row)">
                <i class="fas fa-undo mr-1"></i> å¾©åŸ
              </el-button>
            </template>
          </el-table-column>
        </el-table>
      </el-dialog>
    </section>
  </div>
</template>

<style scoped>
.schedule-list-container {
  padding: 20px;
}

.page-title {
  font-size: 1.6rem;
  font-weight: 600;
  color: #303133;
  display: flex;
  align-items: center;
  margin: 0;
}

/* ====== çµ±è¨ˆå¡ç‰‡ ====== */
.stat-card {
  border-radius: 10px;
  text-align: center;
  transition: transform 0.2s;
}
.stat-card:hover {
  transform: translateY(-3px);
}
.stat-total :deep(.el-statistic__head) {
  color: #409eff;
}
.stat-upcoming :deep(.el-statistic__head) {
  color: #f56c6c;
}
.stat-daily :deep(.el-statistic__head) {
  color: #67c23a;
}
.stat-weekly :deep(.el-statistic__head) {
  color: #409eff;
}
.stat-monthly :deep(.el-statistic__head) {
  color: #e6a23c;
}

.stat-card :deep(.el-statistic__content) {
  font-size: 1.8rem;
  font-weight: 700;
}

/* ====== ä¸»å¡ç‰‡ ====== */
.main-card {
  border-radius: 12px;
}

.toolbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  flex-wrap: wrap;
  gap: 12px;
}

.toolbar-right {
  display: flex;
  align-items: center;
}

.title-cell {
  display: flex;
  align-items: center;
  font-weight: 500;
}

.next-exec-cell {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.next-exec-cell .datetime {
  font-size: 12px;
  color: #606266;
}

.next-exec-cell .relative-tag {
  width: fit-content;
}

.pagination-bar {
  display: flex;
  justify-content: flex-end;
  margin-top: 16px;
}

/* ====== Timeline å¡ç‰‡ ====== */
.timeline-card {
  border-radius: 12px;
}

.timeline-card .card-header {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
}

.timeline-content {
  cursor: pointer;
  padding: 8px;
  border-radius: 6px;
  transition: background 0.2s;
}

.timeline-content:hover {
  background: #f5f7fa;
}

.timeline-title {
  font-weight: 500;
  margin-bottom: 6px;
}

.timeline-meta {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  color: #909399;
}

/* ====== å·¥å…·é¡ ====== */
.mr-1 {
  margin-right: 4px;
}
.mr-2 {
  margin-right: 8px;
}
.ml-2 {
  margin-left: 8px;
}
.ml-auto {
  margin-left: auto;
}
.mb-4 {
  margin-bottom: 1rem;
}

/* ====== å‹•ç•« ====== */
.fade-slide-enter-active,
.fade-slide-leave-active {
  transition: all 0.4s ease;
}
.fade-slide-enter-from {
  opacity: 0;
  transform: translateY(20px);
}
</style>

<style>
.swal2-container {
  z-index: 20000 !important;
}
</style>
</file>

<file path="frontend/src/views/maintenance/MtifList.vue">
<script setup>
import { ref, onMounted, computed, reactive, watch } from 'vue'
import maintenanceApi from '@/api/modules/maintenance'
import Swal from 'sweetalert2'
import { useTicketConfig } from '@/composables/maintenance/useTicketConfig'
import { usePagination } from '@/composables/maintenance/usePagination'
import TicketCharts from '@/components/maintenance/TicketCharts.vue'
import TicketTimeline from '@/components/maintenance/TicketTimeline.vue'

// --- Props & Refs ---
const props = defineProps({ historyMode: Boolean })
const tickets = ref([])
const filters = reactive({ keyword: '', priority: '', status: '' })
const loading = ref(false)
const pageVisible = ref(false)
const allSpots = ref([])

// ====== ã€æ–°å¢ã€‘å•é¡Œå›å ±æ¨¡å¼ ======
const viewMode = ref('all') // 'all' | 'support'

// å•é¡Œå›å ±æ¨™è¨˜è¦å‰‡ï¼ˆå¯æ“´å±•ï¼‰
const SUPPORT_TAG_PREFIX = 'SUPPORT_'
const SUPPORT_TAG_DESC = '[REPORT]'

/**
 * ã€æ–°å¢ã€‘åˆ¤æ–·æ˜¯å¦ç‚ºå•é¡Œå›å ±å·¥å–®
 * è¦å‰‡ï¼šissueType ä»¥ SUPPORT_ é–‹é ­ æˆ– issueDesc åŒ…å« [REPORT]
 */
const isSupportTicket = (ticket) => {
  if (!ticket) return false
  const typeMatch = ticket.issueType?.startsWith(SUPPORT_TAG_PREFIX)
  const descMatch = ticket.issueDesc?.includes(SUPPORT_TAG_DESC)
  return typeMatch || descMatch
}

/**
 * ã€æ–°å¢ã€‘å•é¡Œå›å ±æœªè™•ç†æ•¸é‡ï¼ˆç”¨æ–¼ Tab Badgeï¼‰
 */
const supportPendingCount = computed(() => {
  return tickets.value.filter(t => 
    isSupportTicket(t) && t.issueStatus === 'REPORTED'
  ).length
})

// ====== è³‡ç”¢å¥åº·åº¦çµ±è¨ˆ ======
const assetStatsTab = ref('SPOT')
const assetStats = ref([])
const assetStatsLoading = ref(false)

// å–å¾—è³‡ç”¢å¥åº·åº¦çµ±è¨ˆ
const fetchAssetStats = async () => {
  try {
    assetStatsLoading.value = true
    const res = await maintenanceApi.getAssetStats(assetStatsTab.value)
    assetStats.value = res.data || []
  } catch (err) {
    console.error('å–å¾—è³‡ç”¢çµ±è¨ˆå¤±æ•—:', err)
    assetStats.value = []
    Swal.fire({
      icon: 'error',
      title: 'è¼‰å…¥å¤±æ•—',
      text: 'ç„¡æ³•å–å¾—è³‡ç”¢å¥åº·åº¦çµ±è¨ˆ',
      timer: 2000,
      showConfirmButton: false,
    })
  } finally {
    assetStatsLoading.value = false
  }
}

// ç›£è½ tab åˆ‡æ›
watch(assetStatsTab, () => {
  fetchAssetStats()
})

// spotId -> spotName å°ç…§è¡¨ï¼ˆè®“æ¤…å­å·¥å–®å¯é¡¯ç¤ºã€Œæ©Ÿå°çœŸåã€ï¼‰
const spotNameMap = computed(() => {
  const map = new Map()
  for (const s of allSpots.value || []) {
    map.set(Number(s.spotId), s.spotName)
  }
  return map
})

// å–å¾—é¡¯ç¤ºç”¨çš„æ©Ÿå°åç¨±ï¼šå„ªå…ˆ row.rentalSpotï¼Œå…¶æ¬¡ allSpotsï¼Œå† fallback åˆ°ã€Œæ©Ÿå° #idã€
const getSpotDisplayName = (spotId, rentalSpot) => {
  if (rentalSpot?.spotName) return rentalSpot.spotName
  const name = spotNameMap.value.get(Number(spotId))
  return name || `æ©Ÿå° #${spotId}`
}

// æ ¼å¼åŒ–ç™¾åˆ†æ¯”
const formatPercent = (value) => {
  if (value == null || isNaN(value)) return '0.0%'
  return (value * 100).toFixed(1) + '%'
}

// æ ¼å¼åŒ–æ•…éšœç‡
const formatRate = (value) => {
  if (value == null || isNaN(value)) return '0.00'
  return value.toFixed(2)
}

// å–å¾—å¦¥å–„ç‡ç‹€æ…‹é¡è‰²
const getAvailabilityStatus = (value) => {
  if (value >= 0.95) return 'success'
  if (value >= 0.8) return 'warning'
  return 'exception'
}

// æ§åˆ¶ LOG å½ˆçª—çš„è®Šæ•¸
const logDialogVisible = ref(false)
const currentLogTicketId = ref(0)

const openLogDialog = (id) => {
  currentLogTicketId.value = id
  logDialogVisible.value = true
}

// åˆ¤æ–·å·¥å–®æ˜¯å¦å¯ç·¨è¼¯
const EDITABLE_STATUSES = ['REPORTED', 'ASSIGNED']
const canEdit = (row) => EDITABLE_STATUSES.includes(row.issueStatus)

// æç¤ºä¸å¯ç·¨è¼¯åŸå› 
const getEditTooltip = (row) => {
  if (canEdit(row)) {
    return 'ç·¨è¼¯å·¥å–®'
  }
  const statusName = getStatusText(row.issueStatus)
  return `ç‹€æ…‹ç‚ºã€Œ${statusName}ã€ä¸å¯ç·¨è¼¯ï¼ˆåƒ… REPORTED/ASSIGNED å¯ç·¨è¼¯ï¼‰`
}

// æ§åˆ¶çµæ¡ˆå½ˆçª—
const showResolveDialog = ref(false)
const resolveForm = reactive({ ticketId: 0, resultType: 'FIXED', resolveNote: '' })

// ä½¿ç”¨å…±ç”¨ composables
const {
  priorityConfig,
  statusConfig,
  resultConfig,
  getPriorityTag,
  getStatusTag,
  getPriorityText,
  getStatusText,
  getPriorityIcon,
  getStatusIcon,
  getResultText,
  getResultIcon,
} = useTicketConfig()

// å‘å¾Œç›¸å®¹ï¼šä¿ç•™åŸæœ‰è®Šæ•¸åç¨± (ä¾›æ¨¡æ¿ä½¿ç”¨)
const priorityText = Object.fromEntries(Object.entries(priorityConfig).map(([k, v]) => [k, v.text]))
const priorityIcon = Object.fromEntries(Object.entries(priorityConfig).map(([k, v]) => [k, v.icon]))
const statusText = Object.fromEntries(Object.entries(statusConfig).map(([k, v]) => [k, v.text]))
const statusIcon = Object.fromEntries(Object.entries(statusConfig).map(([k, v]) => [k, v.icon]))

// --- API è³‡æ–™è®€å– ---
const fetchTickets = async () => {
  try {
    loading.value = true
    const res = props.historyMode
      ? await maintenanceApi.getHistoryTickets()
      : await maintenanceApi.getActiveTickets()
    tickets.value = res.data
  } catch {
    // éŒ¯èª¤å·²ç”± http.js æ””æˆªå™¨è™•ç†
  } finally {
    loading.value = false
  }
}

// çµ±è¨ˆå¡ç‰‡æ•¸æ“š
const statsCards = computed(() => {
  const total = tickets.value.length
  const urgent = tickets.value.filter((t) => t.issuePriority === 'URGENT').length
  const inProgress = tickets.value.filter((t) => t.issueStatus === 'UNDER_MAINTENANCE').length
  const resolved = tickets.value.filter((t) => t.issueStatus === 'RESOLVED').length
  return { total, urgent, inProgress, resolved }
})

// ç›£è½ç¯©é¸æ¢ä»¶è®Šæ›´ï¼Œé‡ç½®åˆ†é 
watch(
  filters,
  () => {
    resetPagination()
  },
  { deep: true },
)

// â˜… [Fix Issue 1] æ ¹æ“šæ¨¡å¼å‹•æ…‹ç”¢ç”Ÿç‹€æ…‹é¸é …
// å¦‚æœæ˜¯ historyModeï¼Œåªé¡¯ç¤º å·²çµæ¡ˆ/å·²å–æ¶ˆ
// å¦‚æœæ˜¯ activeModeï¼Œåªé¡¯ç¤º å·²é€šå ±/å·²æŒ‡æ´¾/ç¶­ä¿®ä¸­
const availableStatusOptions = computed(() => {
  const allStatuses = statusText
  const filtered = {}

  if (props.historyMode) {
    // æ­·å²æ¨¡å¼ï¼šåªé¡¯ç¤º RESOLVED, CANCELLED
    if (allStatuses['RESOLVED']) filtered['RESOLVED'] = allStatuses['RESOLVED']
    if (allStatuses['CANCELLED']) filtered['CANCELLED'] = allStatuses['CANCELLED']
  } else {
    // ç¾æœ‰æ¨¡å¼ï¼šé¡¯ç¤º REPORTED, ASSIGNED, UNDER_MAINTENANCE
    if (allStatuses['REPORTED']) filtered['REPORTED'] = allStatuses['REPORTED']
    if (allStatuses['ASSIGNED']) filtered['ASSIGNED'] = allStatuses['ASSIGNED']
    if (allStatuses['UNDER_MAINTENANCE'])
      filtered['UNDER_MAINTENANCE'] = allStatuses['UNDER_MAINTENANCE']
  }
  return filtered
})

// --- æ¥­å‹™é‚è¼¯ & æ’åºé‚è¼¯ ---
const filteredTickets = computed(() => {
  // 1. å…ˆé€²è¡Œç¯©é¸
  let list = tickets.value.filter((t) => {
    const k = filters.keyword.toLowerCase()
    const textMatch =
      !k ||
      String(t.ticketId).includes(k) ||
      (t.issueDesc || '').toLowerCase().includes(k) ||
      (t.issueType || '').toLowerCase().includes(k)
    const pMatch = !filters.priority || t.issuePriority === filters.priority
    const sMatch = !filters.status || t.issueStatus === filters.status
    return textMatch && pMatch && sMatch
  })

  // ã€æ–°å¢ã€‘2. æ ¹æ“š viewMode éæ¿¾å•é¡Œå›å ±
  if (viewMode.value === 'support') {
    list = list.filter(t => isSupportTicket(t))
  }

  // 3. é€²è¡Œæ’åºï¼šç·Šæ€¥å·¥å–® (URGENT) ç½®é ‚
  return list.sort((a, b) => {
    // å¦‚æœ a æ˜¯ç·Šæ€¥ï¼Œb ä¸æ˜¯ï¼Œa æ’å‰é¢ (-1)
    if (a.issuePriority === 'URGENT' && b.issuePriority !== 'URGENT') return -1
    // å¦‚æœ b æ˜¯ç·Šæ€¥ï¼Œa ä¸æ˜¯ï¼Œb æ’å‰é¢ (1)
    if (b.issuePriority === 'URGENT' && a.issuePriority !== 'URGENT') return 1

    // å¦‚æœå„ªå…ˆç´šç›¸åŒï¼Œä¾ç…§ ID å€’åº (æ–°çš„åœ¨ä¸Šé¢)
    return b.ticketId - a.ticketId
  })
})

// ä½¿ç”¨ usePagination composable
const {
  currentPage,
  pageSize,
  paginatedList: paginatedTickets,
  total: paginationTotal,
  showPagination,
  resetPagination,
} = usePagination(filteredTickets, { defaultPageSize: 10 })

// é–‹å§‹ç¶­ä¿®
const startTicket = async (row) => {
  const result = await Swal.fire({
    title: 'é–‹å§‹ç¶­ä¿®ï¼Ÿ',
    html: `
      <div style="text-align: center; padding: 10px 0;">
        <div style="font-size: 48px; margin-bottom: 12px;"><i class="fas fa-wrench" style="color: #e6a23c;"></i></div>
        <p>å·¥å–® <b>#${row.ticketId}</b> å³å°‡é€²å…¥ç¶­ä¿®ç‹€æ…‹</p>
        <p style="color: #909399; font-size: 13px;">å•é¡Œé¡å‹ï¼š${row.issueType}</p>
      </div>
    `,
    icon: null,
    showCancelButton: true,
    confirmButtonColor: '#409eff',
    cancelButtonColor: '#909399',
    confirmButtonText: '<i class="fas fa-play mr-1"></i> é–‹å§‹ç¶­ä¿®',
    cancelButtonText: 'ç¨å¾Œå†èªª',
    showClass: { popup: 'animate__animated animate__bounceIn' },
  })

  if (result.isConfirmed) {
    try {
      await maintenanceApi.startTicket(row.ticketId)
      await Swal.fire({
        icon: 'success',
        title: 'ç¶­ä¿®é–‹å§‹ï¼',
        html: '<span class="text-primary">å·¥å–®ç‹€æ…‹å·²æ›´æ–°ç‚ºã€Œç¶­ä¿®ä¸­ã€</span>',
        timer: 1000,
        timerProgressBar: true,
        showConfirmButton: false,
        showClass: { popup: 'animate__animated animate__fadeInUp animate__faster' },
      })
      fetchTickets()
    } catch {
      // éŒ¯èª¤å·²ç”±æ””æˆªå™¨è™•ç†
    }
  }
}

// å–æ¶ˆå·¥å–®
const cancelTicket = async (row) => {
  const { value: reason } = await Swal.fire({
    title: 'å–æ¶ˆå·¥å–®',
    html: `
      <div style="text-align: center; padding: 10px 0;">
        <div style="font-size: 48px; margin-bottom: 12px;"><i class="fas fa-exclamation-triangle" style="color: #f56c6c;"></i></div>
        <p style="margin-bottom: 16px;">å·¥å–® <b>#${row.ticketId}</b> - ${row.issueType}</p>
      </div>
    `,
    input: 'textarea',
    inputPlaceholder: 'è«‹è¼¸å…¥å–æ¶ˆåŸå› ...',
    inputAttributes: { rows: 3 },
    showCancelButton: true,
    confirmButtonColor: '#f56c6c',
    cancelButtonColor: '#909399',
    confirmButtonText: '<i class="fas fa-times mr-1"></i> ç¢ºèªå–æ¶ˆ',
    cancelButtonText: 'è¿”å›',
    showClass: { popup: 'animate__animated animate__fadeInDown animate__faster' },
    inputValidator: (value) => {
      if (!value) return 'è«‹è¼¸å…¥å–æ¶ˆåŸå› ï¼'
    },
  })

  if (reason) {
    try {
      await maintenanceApi.cancelTicket(row.ticketId, reason)
      await Swal.fire({
        icon: 'success',
        title: 'å·¥å–®å·²å–æ¶ˆ',
        timer: 1000,
        timerProgressBar: true,
        showConfirmButton: false,
        showClass: { popup: 'animate__animated animate__bounceIn' },
      })
      fetchTickets()
    } catch {
      // éŒ¯èª¤å·²ç”±æ””æˆªå™¨è™•ç†
    }
  }
}

// é–‹å•Ÿçµæ¡ˆå½ˆçª—
const openResolveDialog = (id) => {
  resolveForm.ticketId = id
  resolveForm.resultType = 'FIXED'
  resolveForm.resolveNote = ''
  showResolveDialog.value = true
}

// é€å‡ºçµæ¡ˆ
const submitResolve = async () => {
  try {
    // âœ… [é™¤éŒ¯ç”¨] åœ¨ç€è¦½å™¨ Console å°å‡ºå‚³é€çš„è³‡æ–™ï¼Œè«‹æŒ‰ F12 æŸ¥çœ‹
    console.log('ğŸ“¤ æº–å‚™çµæ¡ˆï¼Œå‚³é€è³‡æ–™:', {
      ticketId: resolveForm.ticketId,
      resultType: resolveForm.resultType, // å¿…é ˆæ˜¯è‹±æ–‡å¤§å¯« Key (FIXED, MAINTAINED, UNFIXABLE, OTHER)
      resolveNote: resolveForm.resolveNote,
    })

    await maintenanceApi.resolveTicket(
      resolveForm.ticketId,
      resolveForm.resultType, // âœ… ç›´æ¥å‚³é€è‹±æ–‡ Keyï¼Œç”± resultConfig ä¿è­‰æ­£ç¢ºæ€§
      resolveForm.resolveNote,
    )
    showResolveDialog.value = false

    const config = resultConfig[resolveForm.resultType] || {
      text: 'å·²çµæ¡ˆ',
      icon: 'ğŸ‰',
      color: '#67c23a',
    }

    await Swal.fire({
      icon: 'success',
      title: 'çµæ¡ˆæˆåŠŸï¼',
      html: `
        <div style="text-align: center;">
          <div style="font-size: 48px; margin-bottom: 12px;">${config.icon}</div>
          <p>çµæ¡ˆçµæœï¼š<b style="color: ${config.color};">${config.text}</b></p>
        </div>
      `,
      timer: 1200,
      timerProgressBar: true,
      showConfirmButton: false,
      position: 'center',
      heightAuto: false,
      showClass: { popup: 'animate__animated animate__tada' },
    })
    fetchTickets()
  } catch (error) {
    console.error('âŒ çµæ¡ˆå¤±æ•—:', error)
    console.error('âŒ å¾Œç«¯å›å‚³:', error.response?.data)
    console.error('âŒ HTTP ç‹€æ…‹:', error.response?.status)

    // âœ… é¡¯ç¤ºæ›´è©³ç´°çš„éŒ¯èª¤çµ¦ä½¿ç”¨è€…
    const errorMsg =
      error.response?.data?.message ||
      error.response?.data?.error ||
      'å¾Œç«¯ä¸æ¥å—æ­¤çµæœé¡å‹ (Enumä¸åŒ¹é…)'
    await Swal.fire({
      icon: 'error',
      title: 'çµæ¡ˆå¤±æ•—',
      html: `
        <div style="text-align: left; padding: 10px;">
          <p><b>éŒ¯èª¤è¨Šæ¯ï¼š</b>${errorMsg}</p>
          ${error.response?.status ? `<p><b>HTTP ç‹€æ…‹ç¢¼ï¼š</b>${error.response.status}</p>` : ''}
          <hr style="margin: 12px 0; border: none; border-top: 1px solid #eee;">
          <p style="color: #909399; font-size: 13px;">
            <i class="fas fa-info-circle"></i> å¦‚æœå‡ºç¾ IllegalArgumentExceptionï¼Œè¡¨ç¤ºå¾Œç«¯ä¸æ”¯æ´è©²çµæœé¡å‹ã€‚<br>
            è«‹ç¢ºèªå¾Œç«¯å·²é‡å•Ÿä¸¦æ”¯æ´ï¼šFIXED, MAINTAINED, UNFIXABLE, OTHER
          </p>
        </div>
      `,
      confirmButtonColor: '#409eff',
      position: 'center',
      heightAuto: false,
    })
  }
}

// æŸ¥çœ‹å·¥å–®è©³æƒ… (UI å„ªåŒ–ç‰ˆ)
const viewTicketDetail = (row) => {
  // æº–å‚™è®Šæ•¸
  const staffName = row.assignedStaff ? row.assignedStaff.staffName : 'æœªæŒ‡æ´¾'
  const staffColor = row.assignedStaff ? '#409eff' : '#909399' // è—è‰²æˆ–ç°è‰²

  // è™•ç†ç¶­ä¿®çµæœå€å¡Š
  let resultHtml = ''
  if (row.issueStatus === 'RESOLVED' && row.resultType) {
    const rConfig = resultConfig[row.resultType] || { text: row.resultType, icon: '' }
    // ç°¡å–®çš„ç°è‰²èƒŒæ™¯å€å¡Š
    resultHtml = `
      <div style="margin-top: 15px; padding: 12px; background: #f4f4f5; border-radius: 8px; border-left: 4px solid #909399;">
        <div style="font-weight: bold; color: #606266; margin-bottom: 4px;">ç¶­ä¿®çµæœï¼š${rConfig.text}</div>
        <div style="font-size: 13px; color: #909399;">${row.resolveNote || 'ç„¡å‚™è¨»'}</div>
      </div>
    `
  }

  Swal.fire({
    // æ¨™é¡Œç°¡æ½”åŒ–
    title: `<div style="display:flex; align-items:center; gap:8px;">
              <span style="font-size: 20px; font-weight:700;">å·¥å–® #${row.ticketId}</span>
              <span style="font-size: 14px; font-weight:400; color:#909399;">${row.issueType}</span>
            </div>`,
    html: `
      <div style="text-align: left; padding: 0 10px;">
        <div style="margin-bottom: 16px;">
          <div style="font-size: 12px; color: #909399; margin-bottom: 4px;">å•é¡Œæè¿°</div>
          <div style="padding: 12px; background: #fff; border: 1px solid #e4e7ed; border-radius: 8px; color: #606266; min-height: 40px;">
            ${row.issueDesc || 'ç„¡è©³ç´°æè¿°'}
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
          <div>
            <div style="font-size: 12px; color: #909399; margin-bottom: 4px;">å„ªå…ˆç´š</div>
            <div style="font-size: 16px; font-weight: 600;">
              ${priorityIcon[row.issuePriority]} ${priorityText[row.issuePriority]}
            </div>
          </div>
          <div>
            <div style="font-size: 12px; color: #909399; margin-bottom: 4px;">ç›®å‰ç‹€æ…‹</div>
            <div style="font-size: 16px; font-weight: 600;">
              ${statusIcon[row.issueStatus]} ${statusText[row.issueStatus]}
            </div>
          </div>
        </div>

        <div style="margin-bottom: 16px; padding-top: 12px; border-top: 1px solid #ebeef5;">
          <div style="font-size: 12px; color: #909399; margin-bottom: 4px;">è² è²¬äººå“¡</div>
          <div style="display: flex; align-items: center; gap: 8px;">
            <div style="width: 32px; height: 32px; background: ${staffColor}; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-user"></i>
            </div>
            <span style="font-size: 15px; font-weight: 500; color: #303133;">${staffName}</span>
          </div>
        </div>

        ${resultHtml}

        <div style="margin-top: 20px;">
           <button id="btn-view-log" style="width: 100%; padding: 10px; border: 1px dashed #dcdfe6; background: #fff; color: #606266; border-radius: 6px; cursor: pointer; transition: all 0.3s;">
             <i class="fas fa-history mr-1"></i> æŸ¥çœ‹å®Œæ•´æ­·ç¨‹
           </button>
        </div>
      </div>
    `,
    showConfirmButton: false,
    showCloseButton: true,
    width: 450,
    didOpen: () => {
      // ç¶å®šæ­·ç¨‹æŒ‰éˆ•
      document.getElementById('btn-view-log')?.addEventListener('click', () => {
        Swal.close()
        openLogDialog(row.ticketId)
      })
    },
  })
}

// åœ°åœ–å°è¦–çª—åŠŸèƒ½
// ====== ä¿®æ­£å¾Œçš„é–‹å•Ÿåœ°åœ–å‡½å¼ (ä¿®å¾©æ¤…å­å·¥å–®åº§æ¨™é¡¯ç¤º) ======
const showLocationMap = async (row) => {
  let lat = null
  let lng = null
  let targetName = ''

  console.log('ğŸ—ºï¸ é–‹å•Ÿåœ°åœ–ï¼Œå·¥å–®è³‡æ–™:', row)

  // 1. åˆ¤æ–·æ˜¯æ©Ÿå°é‚„æ˜¯æ¤…å­ï¼Œä¸¦å–å¾—åº§æ¨™
  if (row.spotId) {
    // æ©Ÿå°å·¥å–®ï¼šå„ªå…ˆå¾ row.rentalSpot å–åº§æ¨™ï¼ˆå·²ç¶“åœ¨å·¥å–®è³‡æ–™è£¡ï¼‰
    targetName = row.rentalSpot?.spotName || `æ©Ÿå° #${row.spotId}`
    lat = row.rentalSpot?.latitude
    lng = row.rentalSpot?.longitude

    console.log('ğŸ“ æ©Ÿå°å·¥å–® - rentalSpot åº§æ¨™:', { lat, lng, spotName: targetName })

    // å¦‚æœ rentalSpot æ²’æœ‰åº§æ¨™ï¼Œå†å¾ allSpots æ‰¾ï¼ˆå‚™æ´æ–¹æ¡ˆï¼‰
    if (!lat || !lng) {
      const foundSpot = allSpots.value.find((s) => Number(s.spotId) === Number(row.spotId))
      console.log('ğŸ” å¾ allSpots æ‰¾æ©Ÿå°:', { foundSpot, allSpotsCount: allSpots.value.length })
      if (foundSpot) {
        //  ä¿®æ­£åŸå› ï¼šå¾Œç«¯å·²ä¿®å¾©åº§æ¨™å‚³è¼¸ï¼Œæ­¤è™•åŠ å…¥ Number è½‰å‹èˆ‡ null æª¢æŸ¥ä½œç‚ºä¿éšª
        const spotLat = Number(foundSpot.latitude)
        const spotLng = Number(foundSpot.longitude)

        if (!isNaN(spotLat) && !isNaN(spotLng) && spotLat !== 0 && spotLng !== 0) {
          lat = spotLat
          lng = spotLng
          targetName = foundSpot.spotName || targetName
        }
      }
    }
  } else if (row.seatsId) {
    // æ¤…å­å·¥å–®ï¼šå–å¾—æ‰€å±¬æ©Ÿå°çš„åº§æ¨™
    targetName = row.seat?.seatsName || `æ¤…å­ #${row.seatsId}`

    if (row.seat && row.seat.spotId) {
      console.log('ğŸª‘ æ¤…å­å·¥å–® - æ‰€å±¬æ©Ÿå° ID:', row.seat.spotId)

      // âœ… ç›´æ¥å¾ allSpots æ‰¾æ¤…å­æ‰€å±¬çš„æ©Ÿå°ï¼ˆå› ç‚º seat.rentalSpot é€šå¸¸æ²’æœ‰åº§æ¨™ï¼‰
      const foundSpot = allSpots.value.find((s) => Number(s.spotId) === Number(row.seat.spotId))
      console.log('ğŸ” å¾ allSpots æ‰¾æ¤…å­æ‰€å±¬æ©Ÿå°:', {
        foundSpot: foundSpot
          ? {
              spotId: foundSpot.spotId,
              spotName: foundSpot.spotName,
              lat: foundSpot.latitude,
              lng: foundSpot.longitude,
            }
          : null,
        searchSpotId: row.seat.spotId,
      })

      // âœ… ä¿®æ­£åŸå› ï¼šå¾Œç«¯å·²ä¿®å¾©åº§æ¨™å‚³è¼¸ï¼Œæ­¤è™•åŠ å…¥ Number è½‰å‹èˆ‡ null æª¢æŸ¥ä½œç‚ºä¿éšª
      if (foundSpot) {
        const spotLat = Number(foundSpot.latitude)
        const spotLng = Number(foundSpot.longitude)

        // âœ… æª¢æŸ¥åº§æ¨™æ˜¯å¦ç‚ºæœ‰æ•ˆæ•¸å­—ï¼ˆä¸æ˜¯ NaNã€ä¸æ˜¯ 0ã€ä¸æ˜¯ nullï¼‰
        if (!isNaN(spotLat) && !isNaN(spotLng) && spotLat !== 0 && spotLng !== 0) {
          lat = spotLat
          lng = spotLng
          targetName = `${row.seat.seatsName || 'æ¤…å­'} (ä½æ–¼ ${foundSpot.spotName || 'æ©Ÿå°'})`
          console.log('âœ… æˆåŠŸå–å¾—æ¤…å­æ‰€å±¬æ©Ÿå°åº§æ¨™:', { lat, lng, targetName })
        } else {
          console.warn('âš ï¸ æ©Ÿå°åº§æ¨™ç„¡æ•ˆ:', { spotLat, spotLng })
          Swal.fire('ç„¡åº§æ¨™è³‡è¨Š', `æ¤…å­æ‰€å±¬çš„æ©Ÿå°ã€Œ${foundSpot.spotName}ã€æœªè¨­å®šæœ‰æ•ˆç¶“ç·¯åº¦`, 'info')
          return
        }
      } else {
        console.warn('âš ï¸ æ‰¾ä¸åˆ°æ¤…å­æ‰€å±¬æ©Ÿå°')
        Swal.fire('ç„¡åº§æ¨™è³‡è¨Š', `æ‰¾ä¸åˆ°æ¤…å­æ‰€å±¬çš„æ©Ÿå°ï¼ˆID: ${row.seat.spotId}ï¼‰`, 'info')
        return
      }
    } else {
      Swal.fire('ç„¡æ³•å®šä½', 'é€™å¼µæ¤…å­å·¥å–®æ‰¾ä¸åˆ°æ‰€å±¬çš„æ©Ÿå°è³‡è¨Š', 'warning')
      return
    }
  }

  // 2. æª¢æŸ¥æ˜¯å¦æœ‰åº§æ¨™
  if (lat && lng) {
    const stationName = targetName

    // Google Maps Embed URL
    const mapUrl = `https://maps.google.com/maps?q=${lat},${lng}&z=15&output=embed`

    // 3. å½ˆå‡º Swal è¦–çª—
    await Swal.fire({
      title: `<div style="display: flex; align-items: center; gap: 12px; justify-content: center;">
          <i class="fas fa-map-marker-alt" style="color: #e6a23c; font-size: 24px;"></i>
          <span>${stationName}</span>
        </div>`,
      html: `
          <div style="text-align: center;">
            <div style="margin-bottom: 16px; padding: 12px; background: #f0f9eb; border-radius: 8px; border-left: 4px solid #67c23a;">
              <p style="margin: 0; color: #606266; font-size: 13px;">
                <i class="fas fa-info-circle mr-1" style="color: #67c23a;"></i>
                ç¶“åº¦ï¼š${lng}Â° | ç·¯åº¦ï¼š${lat}Â°
              </p>
            </div>
            <iframe
              src="${mapUrl}"
              width="100%"
              height="300"
              style="border: none; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);"
              allowfullscreen=""
              loading="lazy"
              referrerpolicy="no-referrer-when-downgrade">
            </iframe>
            <p style="margin: 12px 0 0; color: #909399; font-size: 11px;">
              <i class="fas fa-external-link-alt mr-1"></i>
              é»æ“Šåœ°åœ–å¯åœ¨æ–°è¦–çª—ä¸­é–‹å•Ÿ Google Maps
            </p>
          </div>
        `,
      width: '600px',
      showConfirmButton: true,
      confirmButtonText: '<i class="fas fa-times mr-1"></i>é—œé–‰',
      confirmButtonColor: '#909399',
      customClass: {
        popup: 'custom-map-popup',
      },
      showClass: { popup: 'animate__animated animate__zoomIn animate__faster' },
      hideClass: { popup: 'animate__animated animate__zoomOut animate__faster' },
    })
  } else {
    console.error('âŒ æœ€çµ‚æª¢æŸ¥ï¼šæ²’æœ‰åº§æ¨™è³‡è¨Š', { lat, lng, targetName })
    Swal.fire('ç„¡åº§æ¨™è³‡è¨Š', `ç„¡æ³•å–å¾—ã€Œ${targetName}ã€çš„ç¶“ç·¯åº¦è³‡è¨Š`, 'info')
  }
}

// åˆ‡æ›æ¨¡å¼æ™‚é‡æ–°æŠ“è³‡æ–™
watch(
  () => props.historyMode,
  () => {
    fetchTickets()
  },
)

// ====== (è¼‰å…¥è³‡æ–™) ======
onMounted(async () => {
  try {
    loading.value = true

    //  åŒæ™‚è¼‰å…¥ã€Œè³‡ç”¢çµ±è¨ˆã€å’Œã€Œæ©Ÿå°è³‡æ–™ã€ï¼Œå·¥å–®å‰‡é€é fetchTickets æ ¹æ“šæ¨¡å¼è¼‰å…¥
    const [statsRes, spotsRes] = await Promise.all([
      maintenanceApi.getAssetStats(assetStatsTab.value),
      maintenanceApi.getAllSpots(), // æŠ“å–æ©Ÿå°è³‡æ–™ä¾›åœ°åœ–ä½¿ç”¨
    ])

    // å­˜å…¥è®Šæ•¸
    assetStats.value = statsRes.data || []
    allSpots.value = spotsRes.data || []

    // âœ… æ ¹æ“š historyMode è¼‰å…¥å°æ‡‰çš„å·¥å–®è³‡æ–™
    await fetchTickets()
  } catch (err) {
    console.error('è¼‰å…¥åˆå§‹è³‡æ–™å¤±æ•—:', err)
    Swal.fire('éŒ¯èª¤', 'ç„¡æ³•è¼‰å…¥è³‡æ–™', 'error')
  } finally {
    loading.value = false
    // âœ… ã€é—œéµä¿®å¾©ã€‘è¨­ç½®é é¢å¯è¦‹ï¼Œå¦å‰‡ v-show="pageVisible" æœƒéš±è—æ‰€æœ‰å…§å®¹ï¼
    pageVisible.value = true
  }
})
</script>

<template>
  <div class="ticket-list-container">
    <section class="content-header">
      <div class="container-fluid">
        <transition name="slide-down" appear>
          <div class="page-title-box">
            <div class="title-icon" :class="historyMode ? 'history-mode' : 'active-mode'">
              <i :class="historyMode ? 'fas fa-archive' : 'fas fa-clipboard-list'"></i>
            </div>
            <div class="title-content">
              <h1>{{ historyMode ? 'ç¶­ä¿®æ­·å²æª”æ¡ˆ' : 'ç¶­ä¿®å·¥å–®ç®¡ç†' }}</h1>
              <p class="subtitle">
                {{ historyMode ? 'æŸ¥çœ‹å·²å®Œæˆæˆ–å–æ¶ˆçš„å·¥å–®ç´€éŒ„' : 'ç®¡ç†èˆ‡è¿½è¹¤æ‰€æœ‰ç¶­ä¿®å·¥å–®' }}
              </p>
            </div>
            <div class="title-actions">
              <el-button-group>
                <router-link v-if="historyMode" to="/admin/mtif-list">
                  <el-button type="primary" plain class="action-btn">
                    <i class="fas fa-arrow-left mr-2"></i> è¿”å›åˆ—è¡¨
                  </el-button>
                </router-link>
                <router-link v-if="!historyMode" to="/admin/mtif-history">
                  <el-button type="info" plain class="action-btn">
                    <i class="fas fa-history mr-2"></i> æ­·å²ç´€éŒ„
                  </el-button>
                </router-link>
                <router-link v-if="!historyMode" to="/admin/mtif-form">
                  <el-button type="success" class="action-btn add-btn">
                    <i class="fas fa-plus mr-2"></i> æ–°å¢å·¥å–®
                  </el-button>
                </router-link>
              </el-button-group>
            </div>
          </div>
        </transition>

        <!-- ã€æ–°å¢ã€‘æª¢è¦–æ¨¡å¼åˆ‡æ›ï¼ˆåƒ…åœ¨ç¾æœ‰å·¥å–®æ¨¡å¼é¡¯ç¤ºï¼‰ -->
        <transition name="fade" appear v-if="!historyMode">
          <div class="view-mode-switch mb-3">
            <el-segmented v-model="viewMode" size="large" block>
              <el-segmented-item value="all">
                <span class="segmented-label">
                  <i class="fas fa-list mr-2"></i>
                  å…¨éƒ¨å·¥å–®
                </span>
              </el-segmented-item>
              <el-segmented-item value="support">
                <span class="segmented-label">
                  <i class="fas fa-life-ring mr-2"></i>
                  å•é¡Œå›å ±
                  <el-badge 
                    v-if="supportPendingCount > 0" 
                    :value="supportPendingCount" 
                    type="danger" 
                    class="ml-2"
                  />
                </span>
              </el-segmented-item>
            </el-segmented>
          </div>
        </transition>
      </div>
    </section>

    <section class="content">
      <div class="container-fluid">
        <transition name="zoom-fade" appear>
          <div v-show="pageVisible">
            <el-row :gutter="16" class="mb-4" v-if="!historyMode">
              <el-col :xs="12" :sm="6" :md="6">
                <div class="stat-card total-card">
                  <div class="stat-icon">
                    <i class="fas fa-clipboard-list"></i>
                  </div>
                  <div class="stat-info">
                    <h3>{{ statsCards.total }}</h3>
                    <span>å…¨éƒ¨å·¥å–®</span>
                  </div>
                  <div class="stat-wave"></div>
                </div>
              </el-col>
              <el-col :xs="12" :sm="6" :md="6">
                <div class="stat-card urgent-card">
                  <div class="stat-icon pulse">
                    <i class="fas fa-exclamation-triangle"></i>
                  </div>
                  <div class="stat-info">
                    <h3>{{ statsCards.urgent }}</h3>
                    <span>ç·Šæ€¥å·¥å–®</span>
                  </div>
                </div>
              </el-col>
              <el-col :xs="12" :sm="6" :md="6">
                <div class="stat-card progress-card">
                  <div class="stat-icon">
                    <i class="fas fa-tools"></i>
                  </div>
                  <div class="stat-info">
                    <h3>{{ statsCards.inProgress }}</h3>
                    <span>ç¶­ä¿®ä¸­</span>
                  </div>
                </div>
              </el-col>
              <el-col :xs="12" :sm="6" :md="6">
                <div class="stat-card resolved-card">
                  <div class="stat-icon">
                    <i class="fas fa-check-circle"></i>
                  </div>
                  <div class="stat-info">
                    <h3>{{ statsCards.resolved }}</h3>
                    <span>å·²å®Œæˆ</span>
                  </div>
                </div>
              </el-col>
            </el-row>

            <TicketCharts :tickets="filteredTickets" class="mb-4" />

            <el-card shadow="hover" class="mb-4 asset-stats-card" v-if="!historyMode">
              <template #header>
                <div class="card-header-content">
                  <div class="header-left">
                    <span
                      class="header-icon"
                      style="background: linear-gradient(135deg, #67c23a, #95d475)"
                    >
                      <i class="fas fa-heartbeat"></i>
                    </span>
                    <span class="header-text">è³‡ç”¢å¥åº·åº¦çµ±è¨ˆ</span>
                    <el-tag type="success" effect="light" size="small" class="ml-2" round
                      >æœ€è¿‘ 7 å¤©</el-tag
                    >
                  </div>
                  <div class="header-right">
                    <el-radio-group v-model="assetStatsTab" size="small">
                      <el-radio-button value="SPOT"
                        ><i class="fas fa-desktop mr-1"></i> æ©Ÿå°</el-radio-button
                      >
                      <el-radio-button value="SEAT"
                        ><i class="fas fa-chair mr-1"></i> æ¤…å­</el-radio-button
                      >
                    </el-radio-group>
                    <el-button type="info" plain size="small" @click="fetchAssetStats" class="ml-2">
                      <i class="fas fa-sync-alt"></i>
                    </el-button>
                  </div>
                </div>
              </template>

              <el-skeleton :rows="4" animated v-if="assetStatsLoading" />
              <el-empty v-else-if="assetStats.length === 0" description="æš«ç„¡çµ±è¨ˆè³‡æ–™" />
              <el-table v-else :data="assetStats" stripe style="width: 100%" max-height="400">
                <el-table-column prop="assetName" label="è³‡ç”¢åç¨±" min-width="150" fixed>
                  <template #default="{ row }">
                    <div style="display: flex; align-items: center; gap: 8px">
                      <i
                        :class="row.assetType === 'SPOT' ? 'fas fa-desktop' : 'fas fa-chair'"
                        :style="{ color: row.assetType === 'SPOT' ? '#409eff' : '#e6a23c' }"
                      ></i>
                      <span>{{ row.assetName || 'æœªçŸ¥è³‡ç”¢#' + row.assetId }}</span>
                    </div>
                  </template>
                </el-table-column>
                <el-table-column label="ç¶­ä¿®æ¬¡æ•¸" width="100" align="center">
                  <template #default="{ row }">
                    <el-tag
                      :type="row.repairCount > 0 ? 'danger' : 'info'"
                      effect="light"
                      size="small"
                      >{{ row.repairCount || 0 }}</el-tag
                    >
                  </template>
                </el-table-column>
                <el-table-column label="ä¿é¤Šæ¬¡æ•¸" width="100" align="center">
                  <template #default="{ row }">
                    <el-tag type="primary" effect="light" size="small">{{
                      row.maintainCount || 0
                    }}</el-tag>
                  </template>
                </el-table-column>
                <el-table-column label="æœªçµæ¡ˆ" width="90" align="center">
                  <template #default="{ row }">
                    <el-tag
                      :type="row.openCount > 0 ? 'warning' : 'success'"
                      effect="plain"
                      size="small"
                      >{{ row.openCount || 0 }}</el-tag
                    >
                  </template>
                </el-table-column>
                <el-table-column label="å¦¥å–„ç‡" width="140" align="center">
                  <template #default="{ row }">
                    <el-progress
                      :percentage="Math.round((row.availability || 0) * 100)"
                      :status="getAvailabilityStatus(row.availability)"
                      :stroke-width="10"
                      style="width: 100px; display: inline-block"
                    />
                    <span style="margin-left: 8px; font-size: 12px; color: #606266">{{
                      formatPercent(row.availability)
                    }}</span>
                  </template>
                </el-table-column>
                <el-table-column label="æ•…éšœç‡(/å¤©)" width="110" align="center">
                  <template #default="{ row }">
                    <span
                      :style="{
                        color: row.failureRatePerDay > 0.5 ? '#f56c6c' : '#67c23a',
                        fontWeight: 'bold',
                      }"
                      >{{ formatRate(row.failureRatePerDay) }}</span
                    >
                  </template>
                </el-table-column>
                <el-table-column label="ç¶­ä¿®ç‡" width="100" align="center">
                  <template #default="{ row }">
                    <el-tag
                      :type="
                        row.repairRate >= 1 ? 'success' : row.repairRate > 0 ? 'warning' : 'info'
                      "
                      effect="plain"
                      size="small"
                      >{{ formatPercent(row.repairRate) }}</el-tag
                    >
                  </template>
                </el-table-column>
                <el-table-column label="åœæ©Ÿæ™‚é–“" width="100" align="center">
                  <template #default="{ row }">
                    <span style="color: #909399; font-size: 12px"
                      >{{ row.downtimeMinutes || 0 }} åˆ†é˜</span
                    >
                  </template>
                </el-table-column>
              </el-table>
            </el-card>

            <el-card shadow="hover" class="table-card">
              <template #header>
                <div class="card-header-content">
                  <div class="header-left">
                    <span class="header-icon">
                      <i class="fas fa-table"></i>
                    </span>
                    <span class="header-text">å·¥å–®åˆ—è¡¨</span>
                    <el-tag type="primary" effect="light" size="small" class="ml-2" round>
                      {{ filteredTickets.length }} ç­†
                    </el-tag>
                  </div>
                </div>
              </template>

              <div class="filter-bar">
                <el-input
                  v-model="filters.keyword"
                  placeholder="æœå°‹ IDã€æè¿°ã€é¡å‹..."
                  prefix-icon="Search"
                  clearable
                  class="filter-input"
                />
                <el-select
                  v-model="filters.priority"
                  placeholder="å„ªå…ˆç´š"
                  clearable
                  class="filter-select"
                >
                  <el-option label="ğŸ”µ ä½" value="LOW" />
                  <el-option label="ğŸŸ¢ æ™®é€š" value="NORMAL" />
                  <el-option label="ğŸŸ  é«˜" value="HIGH" />
                  <el-option label="ğŸ”´ ç·Šæ€¥" value="URGENT" />
                </el-select>
                <el-select
                  v-model="filters.status"
                  placeholder="ç‹€æ…‹"
                  clearable
                  class="filter-select"
                >
                  <el-option
                    v-for="(val, key) in availableStatusOptions"
                    :key="key"
                    :label="`${statusIcon[key]} ${val}`"
                    :value="key"
                  />
                </el-select>
                <el-button type="info" plain @click="fetchTickets" class="refresh-btn">
                  <i class="fas fa-sync-alt"></i>
                </el-button>
              </div>

              <el-skeleton :rows="8" animated v-if="loading" />

              <el-table
                v-else
                :data="paginatedTickets"
                stripe
                highlight-current-row
                style="width: 100%"
                class="custom-table"
                @row-dblclick="viewTicketDetail"
              >
                <el-table-column prop="ticketId" label="ID" width="80" sortable fixed>
                  <template #default="{ row }">
                    <el-tag effect="plain" size="small" class="id-tag">#{{ row.ticketId }}</el-tag>
                  </template>
                </el-table-column>

                <el-table-column label="ç¶­ä¿®ç›®æ¨™" width="180" align="center">
                  <template #default="{ row }">
                    <div v-if="row.seatsId" class="target-cell seat-target">
                      <div class="target-main">
                        <i class="fas fa-chair" style="color: #e6a23c"></i>
                        <!--  æ”¹æˆæ¤…å­çœŸåï¼ˆå„ªå…ˆ seatsNameï¼Œæ²’æœ‰æ‰ fallback #idï¼‰ -->
                        <span>{{ row.seat?.seatsName || `æ¤…å­ #${row.seatsId}` }}</span>
                      </div>
                      <div v-if="row.seat && row.seat.spotId" class="target-station">
                        <span class="station-link" @click="showLocationMap(row)">
                          <i class="fas fa-map-marker-alt mr-1"></i>
                          <!--  æ”¹æˆæ©Ÿå°çœŸåï¼šå„ªå…ˆ row.rentalSpot.spotNameï¼Œå¦å‰‡ç”¨ allSpots æŸ¥ spotName -->
                          {{ getSpotDisplayName(row.seat.spotId, row.rentalSpot) }}
                        </span>
                      </div>
                    </div>
                    <div v-else class="target-cell spot-target">
                      <div class="target-main">
                        <i class="fas fa-desktop" style="color: #409eff"></i>
                        <span>æ©Ÿå° #{{ row.spotId }}</span>
                      </div>
                      <div v-if="row.rentalSpot" class="target-station">
                        <span class="station-link" @click="showLocationMap(row)">
                          <i class="fas fa-map-marker-alt mr-1"></i>
                          {{ row.rentalSpot.spotName }}
                        </span>
                      </div>
                    </div>
                  </template>
                </el-table-column>

                <el-table-column prop="issueType" label="å•é¡Œé¡å‹" width="160">
                  <template #default="{ row }">
                    <div class="type-cell" @click="viewTicketDetail(row)">
                      <i class="fas fa-exclamation-circle type-icon"></i>
                      <span>{{ row.issueType }}</span>
                      <!-- ã€æ–°å¢ã€‘å•é¡Œå›å ±æ¨™è¨˜ -->
                      <el-tag 
                        v-if="isSupportTicket(row)" 
                        type="warning" 
                        size="small" 
                        effect="plain"
                        style="margin-left: 4px;"
                      >
                        <i class="fas fa-life-ring" style="margin-right: 2px;"></i>
                        å›å ±
                      </el-tag>
                    </div>
                  </template>
                </el-table-column>

                <el-table-column
                  prop="issueDesc"
                  label="æè¿°"
                  min-width="200"
                  show-overflow-tooltip
                >
                  <template #default="{ row }">
                    <span class="desc-cell">{{ row.issueDesc || '-' }}</span>
                  </template>
                </el-table-column>

                <el-table-column prop="issuePriority" label="å„ªå…ˆç´š" width="110" align="center">
                  <template #default="{ row }">
                    <!-- âœ… ã€ä¿®æ­£ã€‘å„ªå…ˆç´š badge æ–‡å­—é¡è‰²å°æ¯”åº¦ (æ·±è‰²èƒŒæ™¯ä½¿ç”¨ç™½å­—) -->
                    <el-tag
                      :type="getPriorityTag(row.issuePriority)"
                      effect="dark"
                      round
                      style="border: none; white-space: nowrap; color: white; font-weight: 600"
                    >
                      {{ priorityIcon[row.issuePriority] }} {{ priorityText[row.issuePriority] }}
                    </el-tag>
                  </template>
                </el-table-column>

                <el-table-column label="ç¶­ä¿®äººå“¡" width="120" align="center">
                  <template #default="{ row }">
                    <div v-if="row.assignedStaff">
                      <el-tag effect="plain" type="info" round size="small">
                        <i class="fas fa-user-check mr-1"></i>
                        {{ row.assignedStaff.staffName }}
                      </el-tag>
                    </div>
                    <div v-else>
                      <span style="color: #909399; font-size: 12px">- æœªæŒ‡æ´¾ -</span>
                    </div>
                  </template>
                </el-table-column>

                <el-table-column prop="issueStatus" label="ç‹€æ…‹" width="130" align="center">
                  <template #default="{ row }">
                    <el-tag :type="getStatusTag(row.issueStatus)" effect="light" class="status-tag">
                      {{ statusIcon[row.issueStatus] }} {{ statusText[row.issueStatus] }}
                    </el-tag>
                  </template>
                </el-table-column>

                <el-table-column label="æ“ä½œ" width="240" align="center" fixed="right">
                  <template #default="{ row }">
                    <div class="action-buttons">
                      <el-tooltip content="æŸ¥çœ‹è©³æƒ…" placement="top">
                        <el-button
                          type="info"
                          size="small"
                          circle
                          @click="viewTicketDetail(row)"
                          class="action-btn-item"
                        >
                          <i class="fas fa-eye"></i>
                        </el-button>
                      </el-tooltip>

                      <el-tooltip content="æŸ¥çœ‹æ­·ç¨‹" placement="top">
                        <el-button
                          type="warning"
                          size="small"
                          circle
                          @click="openLogDialog(row.ticketId)"
                          class="action-btn-item"
                        >
                          <i class="fas fa-history"></i>
                        </el-button>
                      </el-tooltip>

                      <el-tooltip
                        v-if="!historyMode"
                        :content="getEditTooltip(row)"
                        placement="top"
                      >
                        <el-button
                          size="small"
                          circle
                          :disabled="!canEdit(row)"
                          @click="$router.push(`/admin/mtif-form/${row.ticketId}`)"
                          class="action-btn-item"
                        >
                          <i class="fas fa-edit"></i>
                        </el-button>
                      </el-tooltip>

                      <el-tooltip
                        v-if="!historyMode && row.issueStatus === 'ASSIGNED'"
                        content="é–‹å§‹ç¶­ä¿®"
                        placement="top"
                      >
                        <el-button
                          type="primary"
                          size="small"
                          circle
                          @click="startTicket(row)"
                          class="action-btn-item"
                        >
                          <i class="fas fa-play"></i>
                        </el-button>
                      </el-tooltip>

                      <el-tooltip
                        v-if="!historyMode && row.issueStatus === 'UNDER_MAINTENANCE'"
                        content="çµæ¡ˆ"
                        placement="top"
                      >
                        <el-button
                          type="success"
                          size="small"
                          circle
                          @click="openResolveDialog(row.ticketId)"
                          class="action-btn-item"
                        >
                          <i class="fas fa-check"></i>
                        </el-button>
                      </el-tooltip>

                      <el-tooltip
                        v-if="!historyMode && !['RESOLVED', 'CANCELLED'].includes(row.issueStatus)"
                        content="å–æ¶ˆå·¥å–®"
                        placement="top"
                      >
                        <el-button
                          type="danger"
                          size="small"
                          circle
                          @click="cancelTicket(row)"
                          class="action-btn-item"
                        >
                          <i class="fas fa-times"></i>
                        </el-button>
                      </el-tooltip>
                    </div>
                  </template>
                </el-table-column>

                <template #empty>
                  <el-empty description="ç›®å‰æ²’æœ‰ç›¸é—œå·¥å–®è³‡æ–™">
                    <template #image>
                      <div class="empty-icon"><i class="fas fa-clipboard"></i></div>
                    </template>
                    <router-link to="/admin/mtif-form" v-if="!historyMode">
                      <el-button type="primary"
                        ><i class="fas fa-plus mr-1"></i> å»ºç«‹ç¬¬ä¸€å¼µå·¥å–®</el-button
                      >
                    </router-link>
                  </el-empty>
                </template>
              </el-table>

              <div class="pagination-wrapper" v-show="paginationTotal > 0">
                <el-pagination
                  v-model:current-page="currentPage"
                  v-model:page-size="pageSize"
                  :page-sizes="[5, 10, 20, 50]"
                  :total="paginationTotal"
                  layout="total, sizes, prev, pager, next, jumper"
                  background
                />
              </div>
            </el-card>

            <div class="tips-bar mt-3">
              <el-alert type="info" :closable="false" show-icon>
                <template #title>
                  <span>ğŸ’¡ å°æç¤ºï¼šé›™æ“Šè¡¨æ ¼åˆ—å¯å¿«é€ŸæŸ¥çœ‹å·¥å–®è©³æƒ… | ç·Šæ€¥å·¥å–®æœƒå„ªå…ˆç½®é ‚é¡¯ç¤º</span>
                </template>
              </el-alert>
            </div>
          </div>
        </transition>
      </div>
    </section>

    <el-dialog
      v-model="logDialogVisible"
      :title="`å·¥å–® #${currentLogTicketId}ï½œæ­·ç¨‹`"
      width="760px"
      destroy-on-close
      append-to-body
      align-center
    >
      <TicketTimeline v-if="currentLogTicketId" :ticketId="currentLogTicketId" />
    </el-dialog>

    <el-dialog
      v-model="showResolveDialog"
      title=""
      width="500px"
      center
      destroy-on-close
      align-center
      append-to-body
      class="resolve-dialog"
    >
      <template #header>
        <div class="dialog-header">
          <span class="dialog-icon"
            ><i class="fas fa-check-circle" style="color: #67c23a; font-size: 24px"></i
          ></span>
          <span class="dialog-title">å·¥å–®çµæ¡ˆç¢ºèª</span>
        </div>
      </template>
      <el-form label-position="top" class="resolve-form">
        <el-form-item label="ç¶­ä¿®çµæœ">
          <div class="result-cards">
            <div
              v-for="(config, key) in resultConfig"
              :key="key"
              class="result-card"
              :class="{ active: resolveForm.resultType === key }"
              :style="{ '--card-color': config.color }"
              @click="resolveForm.resultType = key"
            >
              <span class="result-icon">{{ config.icon }}</span>
              <span class="result-text">{{ config.text }}</span>
            </div>
          </div>
        </el-form-item>
        <el-form-item label="ç¶­ä¿®å‚™è¨»">
          <el-input
            v-model="resolveForm.resolveNote"
            type="textarea"
            :rows="4"
            placeholder="è«‹å¡«å¯«ç¶­ä¿®éç¨‹èªªæ˜ã€æ›´æ›é›¶ä»¶ã€ä¿é¤Šé …ç›®ç­‰è³‡è¨Š..."
            show-word-limit
            maxlength="500"
          />
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button @click="showResolveDialog = false" size="large">å–æ¶ˆ</el-button>
        <el-button type="primary" @click="submitResolve" size="large" class="confirm-btn"
          ><i class="fas fa-check mr-1"></i> ç¢ºèªçµæ¡ˆ</el-button
        >
      </template>
    </el-dialog>
  </div>
</template>

<style scoped>
/* é é¢å®¹å™¨ */
.ticket-list-container {
  min-height: 100vh;
  background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
  padding-bottom: 40px;
}

.content-header {
  padding: 20px 1rem;
}

.page-title-box {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 20px 24px;
  background: white;
  border-radius: 16px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  flex-wrap: wrap;
}

.title-icon {
  width: 64px;
  height: 64px;
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  color: white;
  transition: all 0.4s ease;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
}
.title-icon:hover {
  transform: scale(1.1) rotate(10deg);
}
.title-icon.active-mode {
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
}
.title-icon.history-mode {
  background: linear-gradient(135deg, #909399 0%, #c0c4cc 100%);
}

.title-content {
  flex: 1;
  min-width: 200px;
}
.title-content h1 {
  margin: 0;
  font-size: 1.7rem;
  font-weight: 700;
  color: #303133;
}
.title-content .subtitle {
  margin: 6px 0 0;
  font-size: 0.9rem;
  color: #909399;
}

.title-actions {
  display: flex;
  gap: 10px;
}
.action-btn {
  border-radius: 10px;
  font-weight: 500;
  transition: all 0.3s ease;
}
.add-btn {
  background: linear-gradient(135deg, #67c23a 0%, #95d475 100%);
  border: none;
  box-shadow: 0 4px 15px rgba(103, 194, 58, 0.3);
}
.add-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(103, 194, 58, 0.4);
}

/* ã€æ–°å¢ã€‘æª¢è¦–æ¨¡å¼åˆ‡æ›æ¨£å¼ */
.view-mode-switch {
  padding: 0 24px;
}

.segmented-label {
  display: flex;
  align-items: center;
  font-weight: 500;
}

:deep(.el-segmented) {
  border-radius: 12px;
  padding: 4px;
  background: white;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
}

:deep(.el-segmented-item) {
  border-radius: 10px;
  padding: 12px 24px;
  transition: all 0.3s ease;
}

:deep(.el-segmented-item--selected) {
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%) !important;
  color: white !important;
  font-weight: 600;
  box-shadow: 0 4px 12px rgba(64, 158, 255, 0.3);
}

:deep(.el-badge__content) {
  animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

@keyframes pulse {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.7;
  }
}

/* çµ±è¨ˆå¡ç‰‡ */
.stat-card {
  position: relative;
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 18px;
  background: white;
  border-radius: 14px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
  transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  overflow: hidden;
  margin-bottom: 16px;
}
.stat-card:hover {
  transform: translateY(-6px);
  box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
}
.stat-icon {
  width: 50px;
  height: 50px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  color: white;
  z-index: 1;
}
.stat-icon.pulse {
  animation: pulse 1.5s infinite;
}
@keyframes pulse {
  0%,
  100% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.1);
  }
}
.total-card .stat-icon {
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
}
.urgent-card .stat-icon {
  background: linear-gradient(135deg, #f56c6c 0%, #f89898 100%);
}
.progress-card .stat-icon {
  background: linear-gradient(135deg, #e6a23c 0%, #f3d19e 100%);
}
.resolved-card .stat-icon {
  background: linear-gradient(135deg, #67c23a 0%, #95d475 100%);
}
.stat-info h3 {
  margin: 0;
  font-size: 1.8rem;
  font-weight: 700;
  color: #303133;
}
.stat-info span {
  font-size: 0.85rem;
  color: #909399;
}

/* è¡¨æ ¼å¡ç‰‡ */
.table-card {
  border-radius: 16px;
  overflow: hidden;
  border: none;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
}
.card-header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.header-left {
  display: flex;
  align-items: center;
  gap: 10px;
}
.header-icon {
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 16px;
}
.header-text {
  font-weight: 600;
  font-size: 1.1rem;
  color: #303133;
}

/* ç¯©é¸å€ */
.filter-bar {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin-bottom: 20px;
  padding: 16px;
  background: #f8f9fa;
  border-radius: 12px;
}
.filter-input {
  width: 280px;
}
.filter-input :deep(.el-input__wrapper) {
  border-radius: 10px;
}
.filter-select {
  width: 140px;
}
.filter-select :deep(.el-input__wrapper) {
  border-radius: 10px;
}
.refresh-btn {
  border-radius: 10px;
  transition: all 0.3s ease;
}
.refresh-btn:hover {
  transform: rotate(180deg);
}

/* è¡¨æ ¼æ¨£å¼ */
.custom-table {
  --el-table-header-bg-color: #f8f9fa;
}
.id-tag {
  font-weight: 600;
}

/* ç¶­ä¿®ç›®æ¨™æ¬„ä½æ¨£å¼ */
.target-cell {
  display: flex;
  align-items: center;
  flex-direction: column;
  gap: 2px;
  padding: 6px 10px;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 500;
  transition: all 0.3s ease;
  text-align: center;
}
.seat-target {
  background: linear-gradient(135deg, #f0f9eb 0%, #e1f3d8 100%);
  color: #67c23a;
}
.seat-target:hover {
  box-shadow: 0 2px 8px rgba(103, 194, 58, 0.3);
}
.spot-target {
  background: linear-gradient(135deg, #ecf5ff 0%, #d9ecff 100%);
  color: #409eff;
}
.spot-target:hover {
  box-shadow: 0 2px 8px rgba(64, 158, 255, 0.3);
}
.target-main {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  font-weight: 500;
  color: #303133;
  margin-bottom: 4px;
}
.target-station {
  font-size: 11px;
}
.station-link {
  color: #409eff;
  cursor: pointer;
  padding: 2px 6px;
  border-radius: 4px;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
}
.station-link:hover {
  color: #66b1ff;
  background: #ecf5ff;
  transform: translateY(-1px);
}

.type-cell {
  cursor: pointer;
  transition: color 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 4px 8px;
  border-radius: 6px;
}
.type-cell:hover {
  color: #409eff;
  background: #ecf5ff;
}
.type-icon {
  margin-right: 6px;
  color: #f56c6c;
}
.desc-cell {
  color: #606266;
  font-size: 13px;
}

/* Tag ä¸æ›è¡Œ */
:deep(.el-tag) {
  white-space: nowrap;
}

.action-buttons {
  display: flex;
  justify-content: center;
  gap: 6px;
  flex-wrap: wrap;
}
.action-btn-item {
  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.action-btn-item:hover {
  transform: scale(1.2);
}

.empty-icon {
  font-size: 64px;
  color: #dcdfe6;
  margin-bottom: 16px;
}
.pagination-wrapper {
  padding: 20px;
  text-align: center;
  border-top: 1px solid #ebeef5;
  background: #fafafa;
  margin-top: 20px;
}
.tips-bar :deep(.el-alert) {
  border-radius: 12px;
}

/* çµæ¡ˆå½ˆçª— */
.resolve-dialog :deep(.el-dialog) {
  border-radius: 16px;
  margin: auto !important; /* âœ… å¼·åˆ¶ç½®ä¸­ï¼Œé¿å…åé«˜å•é¡Œ */
}
.dialog-header {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}
.dialog-icon {
  font-size: 28px;
}
.dialog-title {
  font-size: 18px;
  font-weight: 600;
  color: #303133;
}
.resolve-form {
  padding: 10px 0;
}
.result-cards {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
}
.result-card {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 14px 10px;
  background: #f5f7fa;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.3s ease;
  border: 2px solid transparent;
}
.result-card:hover {
  background: #ecf5ff;
  transform: translateY(-2px);
}
.result-card.active {
  border-color: var(--card-color);
  background: white;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}
.result-icon {
  font-size: 24px;
  margin-bottom: 6px;
}
.result-text {
  font-size: 12px;
  color: #606266;
  font-weight: 500;
}
.confirm-btn {
  background: linear-gradient(135deg, #67c23a 0%, #95d475 100%);
  border: none;
  border-radius: 10px;
}

/* éæ¸¡å‹•ç•« */
.slide-down-enter-active {
  transition: all 0.5s ease-out;
}
.slide-down-leave-active {
  transition: all 0.3s ease-in;
}
.slide-down-enter-from {
  transform: translateY(-30px);
  opacity: 0;
}
.slide-down-leave-to {
  transform: translateY(-20px);
  opacity: 0;
}
.zoom-fade-enter-active {
  transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.zoom-fade-leave-active {
  transition: all 0.3s ease-in;
}
.zoom-fade-enter-from {
  transform: scale(0.95);
  opacity: 0;
}
.zoom-fade-leave-to {
  transform: scale(0.98);
  opacity: 0;
}

/* è¼”åŠ©é¡ */
.mr-1 {
  margin-right: 4px;
}
.mr-2 {
  margin-right: 8px;
}
.ml-2 {
  margin-left: 8px;
}
.mb-4 {
  margin-bottom: 1.5rem;
}
.mt-3 {
  margin-top: 1rem;
}
.w-100 {
  width: 100%;
}

:global(.custom-map-popup) {
  border-radius: 16px !important;
  overflow: hidden !important;
}
</style>
</file>

<file path="frontend/src/views/maintenance/MaintenanceStaffList.vue">
<script setup>
import { ref, onMounted, computed, watch, nextTick, onBeforeUnmount } from 'vue'
import maintenanceApi from '@/api/modules/maintenance'
import Swal from 'sweetalert2'
import { useRouter } from 'vue-router'
import { usePagination } from '@/composables/maintenance/usePagination'
import { InfoFilled, Right, Delete, Check } from '@element-plus/icons-vue'
// âœ… ã€ä¿®æ­£ã€‘å¼•å…¥çµ±ä¸€çš„äººå“¡ç‹€æ…‹è¨ˆç®—é‚è¼¯ (é¿å…é‡è¤‡å¯¦ä½œã€ç¢ºä¿çµ±è¨ˆå¡èˆ‡åˆ—è¡¨ä¸€è‡´)
import {
  computeStaffStatus,
  computeStaffTaskStats,
  computeOverallStaffStats,
  isCompletedStatus,
} from '@/composables/maintenance/useStaffStatus'

const router = useRouter()
const staffList = ref([])
const searchText = ref('')
const loading = ref(true)
const pageVisible = ref(false)
const sortConfig = ref({ prop: 'staffId', order: 'ascending' })

// âœ… ä¿®æ­£ï¼šç‹€æ…‹ä¸­æ–‡åŒ–æ˜ å°„è¡¨ï¼ˆä¸æ”¹å¾Œç«¯ï¼Œåƒ…å‰ç«¯é¡¯ç¤ºè½‰æ›ï¼‰
const STATUS_LABEL = {
  REPORTED: 'å·²å›å ±',
  ASSIGNED: 'å·²æŒ‡æ´¾',
  UNDER_MAINTENANCE: 'ç¶­ä¿®ä¸­',
  UNDER_MAINT: 'ç¶­ä¿®ä¸­',
  UNDER_MAINTAIN: 'ä¿é¤Šä¸­',
  IN_PROGRESS: 'è™•ç†ä¸­',
  RESOLVED: 'å·²çµæ¡ˆ',
  COMPLETED: 'å·²å®Œæˆ',
  CANCELLED: 'å·²å–æ¶ˆ',
  PENDING: 'å¾…è™•ç†',
  ON_HOLD: 'æš«åœ',
}

// âœ… ä¿®æ­£ï¼šå®‰å…¨è½‰æ›ç‹€æ…‹ç‚ºä¸­æ–‡ï¼ˆæ‰¾ä¸åˆ°å‰‡é¡¯ç¤ºåŸå€¼æˆ– '-'ï¼‰
const statusText = (status) => STATUS_LABEL[status] ?? status ?? '-'

// ====== el-table è·‘ç‰ˆä¿®æ­£ï¼šå¼·åˆ¶é‡æ–°è¨ˆç®—æ¬„å¯¬ ======
const tableRef = ref(null)

const doLayoutSafe = async () => {
  await nextTick()
  tableRef.value?.doLayout?.()
}

const onResize = () => doLayoutSafe()
window.addEventListener('resize', onResize)
onBeforeUnmount(() => window.removeEventListener('resize', onResize))

// ====== å·¥å–®å¿«å–ï¼ˆç”¨ä¸€æ¬¡ API å»ºç«‹ staff ç‹€æ…‹ï¼‰======
const allTickets = ref([])
const ticketLoading = ref(false)

// ====== æ©Ÿå°èˆ‡æ¤…å­è³‡æ–™å¿«å–ï¼ˆç”¨æ–¼é¡¯ç¤ºç›®æ¨™åç¨±ï¼‰======
const allSpots = ref([])
const allSeats = ref([])

// ====== ç‹€æ…‹ç¯©é¸ï¼ˆå…¨éƒ¨ / ç¶­è­·ä¸­ / ç¶­ä¿®ä¸­ / é–’ç½®ä¸­ï¼‰======
const statusFilter = ref('ALL') // 'ALL' | 'UNDER_MAINTENANCE' | 'ASSIGNED' | 'IDLE'

// ====== âœ… ã€æ–°å¢ã€‘äººå“¡è©³æƒ…è¦–çª—ç‹€æ…‹ ======
const detailDialogVisible = ref(false)
const detailCurrentView = ref('profile') // 'profile' | 'tasks'
const detailCurrentStaff = ref(null)
const detailCurrentTaskType = ref('') // 'repair-pending' | 'maintenance-pending' | ...

// ====== è½‰ç§»å·¥å–® Dialog ç‹€æ…‹ ======
const showTransferDialog = ref(false)
const transferForm = ref({
  deleteStaffId: null,
  deleteStaffName: '',
  targetStaffId: null,
})
const transferLoading = ref(false)

// â˜… è¨ˆç®—å¯é¸æ¥æ‰‹äººå“¡ï¼šæ’é™¤è¦åˆªé™¤çš„äºº + å¿…é ˆå•Ÿç”¨ä¸­
const availableTargetStaff = computed(() => {
  return staffList.value.filter(
    (s) => s.staffId !== transferForm.value.deleteStaffId && s.isActive === true,
  )
})

// âœ… ã€ä¿®æ­£ã€‘API è³‡æ–™è®€å–
const fetchStaff = async () => {
  try {
    loading.value = true
    const res = await maintenanceApi.getAllStaff()
    staffList.value = res.data || []
  } catch {
    // éŒ¯èª¤å·²ç”± http.js æ””æˆªå™¨è™•ç†
  } finally {
    loading.value = false
  }
}

const fetchTickets = async () => {
  try {
    ticketLoading.value = true
    const res = await maintenanceApi.getAllTickets()
    allTickets.value = res.data || []
  } catch {
    allTickets.value = []
  } finally {
    ticketLoading.value = false
  }
}

// âœ… ã€ä¿®æ­£ã€‘ä½¿ç”¨çµ±ä¸€çš„ç‹€æ…‹è¨ˆç®—å‡½å¼ (å–ä»£åŸæœ¬çš„é‡è¤‡é‚è¼¯)
// äººå“¡ä»»å‹™çµ±è¨ˆ Map (staffId -> ä»»å‹™çµ±è¨ˆ)
const staffTicketStatMap = computed(() => {
  const map = new Map()
  staffList.value.forEach((staff) => {
    const stats = computeStaffTaskStats(staff.staffId, allTickets.value)
    map.set(staff.staffId, stats)
  })
  return map
})

// âœ… ã€ä¿®æ­£ã€‘äººå“¡å³æ™‚ç‹€æ…‹è¨ˆç®— (çµ±ä¸€å‘¼å« composable)
const getStaffWorkStatus = (staffId) => {
  return computeStaffStatus(staffId, allTickets.value)
}

/** ====== åˆªé™¤äººå“¡ï¼ˆå«é˜²å‘†è½‰ç§»é‚è¼¯ï¼‰====== */
const handleDelete = async (row) => {
  const result = await Swal.fire({
    title: 'ç¢ºå®šè¦åœç”¨æ­¤äººå“¡å—ï¼Ÿ',
    html: `
      <div style="text-align: center;">
        <div style="width: 80px; height: 80px; margin: 0 auto 16px; background: linear-gradient(135deg, #f56c6c 0%, #f89898 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
          <i class="fas fa-user-slash" style="font-size: 36px; color: white;"></i>
        </div>
        <p style="font-size: 16px; margin-bottom: 20px;">å³å°‡åœç”¨ <b style="color: #f56c6c;">${row.staffName}</b></p>
        
        <div style="text-align: left; margin-bottom: 12px;">
            <label style="font-size: 13px; color: #606266; font-weight: bold; margin-bottom: 4px; display: block;">åœç”¨åŸå›  (å¿…é¸)</label>
            <select id="swal-reason-select" class="swal2-select" style="display: flex; width: 100%; margin: 0; padding: 0.5em; border: 1px solid #d9d9d9; border-radius: 4px;">
                <option value="" disabled selected>è«‹é¸æ“‡...</option>
                <option value="å·²çµ‚æ­¢åˆä½œ">å·²çµ‚æ­¢åˆä½œ</option>
                <option value="å…¶ä»–">å…¶ä»–åŸå› </option>
            </select>
        </div>

        <div style="text-align: left;">
            <label style="font-size: 13px; color: #606266; font-weight: bold; margin-bottom: 4px; display: block;">è©³ç´°å‚™è¨» (é¸å¡«)</label>
            <textarea id="swal-reason-note" class="swal2-textarea" placeholder="å¯åœ¨æ­¤è£œå……è©³ç´°èªªæ˜..." style="margin: 0; width: 100%; height: 80px; font-size: 14px; border: 1px solid #d9d9d9; box-sizing: border-box;"></textarea>
        </div>
      </div>
    `,
    showCancelButton: true,
    confirmButtonColor: '#f56c6c',
    cancelButtonColor: '#909399',
    confirmButtonText: '<i class="fas fa-user-slash mr-1"></i> ç¢ºèªä¸¦åœç”¨',
    cancelButtonText: 'å–æ¶ˆ',
    showClass: { popup: 'animate__animated animate__fadeInDown animate__faster' },
    hideClass: { popup: 'animate__animated animate__fadeOutUp animate__faster' },
    customClass: { popup: 'custom-swal-popup' },
    // é€é preConfirm æŠ“å–å…©å€‹æ¬„ä½çš„å€¼
    preConfirm: () => {
      const selectVal = document.getElementById('swal-reason-select').value
      const noteVal = document.getElementById('swal-reason-note').value

      if (!selectVal) {
        Swal.showValidationMessage('è«‹é¸æ“‡åœç”¨åŸå› ')
        return false
      }

      // å›å‚³çµ„åˆå¾Œçš„ç‰©ä»¶
      return { selectVal, noteVal }
    },
  })

  if (result.isConfirmed) {
    const { selectVal, noteVal } = result.value

    // çµ„åˆæœ€çµ‚é¡¯ç¤ºçš„å­—ä¸²ï¼Œä¾‹å¦‚ï¼š"å·²çµ‚æ­¢åˆä½œ (è©³ç´°èªªæ˜...)"
    // å¦‚æœæ²’æœ‰å‚™è¨»ï¼Œå°±åªå­˜é¸å–®çš„å€¼
    const finalReason = noteVal ? `${selectVal}ï¼š${noteVal}` : selectVal

    //å–å¾—ç•¶å¤©æ—¥æœŸ(æ ¼å¼ YYYY/MM/DD )
    const today = new Date().toLocaleDateString('zh-TW', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
    })

    try {
      loading.value = true

      // --- çµ„åˆæ–°çš„å‚™è¨»å­—ä¸² (ä¿æŒèˆ‡æ­·å²ç´€éŒ„é é¢çš„æ ¼å¼ç›¸å®¹) ---
      const originalNote = row.staffNote || ''
      const newNote = `[åœç”¨åŸå› ï¼š${finalReason}] [åœç”¨æ—¥æœŸï¼š${today}] \n${originalNote}`

      // 1. å…ˆæ›´æ–°å‚™è¨»
      await maintenanceApi.updateStaff(row.staffId, {
        ...row,
        staffNote: newNote,
      })

      // 2. å†åŸ·è¡Œåœç”¨
      await maintenanceApi.deleteStaff(row.staffId)

      await fetchStaff()

      await Swal.fire({
        icon: 'success',
        title: 'å·²åœç”¨',
        html: `
          <div style="text-align:center;">
            <span><b>${row.staffName}</b> å·²ç§»è‡³æ­·å²ç´€éŒ„</span><br/>
            <span style="color: #909399; font-size: 13px; margin-top: 8px; display: inline-block; background: #f4f4f5; padding: 4px 8px; border-radius: 4px;">
              åŸå› ï¼š${selectVal}
            </span>
          </div>
        `,
        timer: 900,
        timerProgressBar: true,
        showConfirmButton: false,
      })
    } catch (error) {
      const errorMsg = error?.response?.data?.message || error?.message || ''

      if (
        errorMsg.includes('æœªå®Œæˆ') ||
        errorMsg.includes('å·¥å–®') ||
        error?.response?.status === 400
      ) {
        // ç™¼ç”Ÿè½‰ç§»éœ€æ±‚æ™‚
        transferForm.value = {
          deleteStaffId: row.staffId,
          deleteStaffName: row.staffName,
          targetStaffId: null,
        }
        showTransferDialog.value = true

        // é¡å¤–æç¤ºï¼šå‰›å‰›é¸çš„åŸå› æ²’æœ‰å­˜æˆåŠŸï¼Œè½‰ç§»å¾Œå¯èƒ½éœ€è¦é‡æ–°æ“ä½œ(è¦–å¾Œç«¯é‚è¼¯è€Œå®š)
      } else {
        Swal.fire('éŒ¯èª¤', 'åœç”¨å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error')
      }
    } finally {
      loading.value = false
    }
  }
}

/** ====== ç§»é™¤ä¸å¿…è¦çš„ showHistoryModal (å·²æ”¹ç”¨ el-dialog å…§éƒ¨å°è¦½) ====== */
// æ­¤å‡½å¼å·²æ•´åˆåˆ° handleViewTasksï¼Œä¸å†éœ€è¦

// âœ… ã€ä¿®æ­£ã€‘äººå“¡è©³æƒ…è¦–çª— (æ”¹ç”¨ el-dialog + å…§éƒ¨å°è¦½)
const viewDetail = async (row) => {
  // ç¢ºä¿ tickets æœ‰è³‡æ–™
  if (!allTickets.value.length && !ticketLoading.value) {
    await fetchTickets()
  }

  detailCurrentStaff.value = row
  detailCurrentView.value = 'profile'
  detailDialogVisible.value = true
}

// é»æ“Šä»»å‹™å¡ç‰‡ (åˆ‡æ›åˆ°ä»»å‹™åˆ—è¡¨ view)
const handleViewTasks = (cardType) => {
  detailCurrentTaskType.value = cardType
  detailCurrentView.value = 'tasks'
}

// è¨ˆç®—ä»»å‹™åˆ—è¡¨è³‡æ–™ (æ ¹æ“š taskType ç¯©é¸)
// âœ…ã€ä¿®æ­£#1ã€‘ä»»å‹™åˆ—è¡¨åˆ†é¡ä¹Ÿæ”¹æˆåš´æ ¼åˆ¤å®šï¼Œç¢ºä¿ã€Œé»å¡ç‰‡é€²å»çš„æ¸…å–®ã€è·Ÿåœ–å¡ä¸€è‡´
const detailTaskList = computed(() => {
  if (!detailCurrentStaff.value || !detailCurrentTaskType.value) return []

  const staffId = detailCurrentStaff.value.staffId
  const cardType = detailCurrentTaskType.value
  const matchFn = (t) => t?.assignedStaffId === staffId

  const isDone = (t) => isCompletedStatus(t?.issueStatus)
  const isMaint = (t) => isMaintenanceTicketStrict(t)

  let filtered = []
  switch (cardType) {
    case 'repair-pending':
      filtered = (allTickets.value || []).filter((t) => matchFn(t) && !isMaint(t) && !isDone(t))
      break
    case 'maintenance-pending':
      filtered = (allTickets.value || []).filter((t) => matchFn(t) && isMaint(t) && !isDone(t))
      break
    case 'repair-completed':
      filtered = (allTickets.value || []).filter((t) => matchFn(t) && !isMaint(t) && isDone(t))
      break
    case 'maintenance-completed':
      filtered = (allTickets.value || []).filter((t) => matchFn(t) && isMaint(t) && isDone(t))
      break
    default:
      filtered = (allTickets.value || []).filter((t) => matchFn(t))
  }

  // æ’åºï¼šæœ€æ–°åœ¨ä¸Š
  const getTime = (t) => new Date(t?.reportedAt || t?.startAt || t?.resolvedAt || 0).getTime()
  filtered.sort((a, b) => getTime(b) - getTime(a))

  return filtered
})

// ä»»å‹™é¡å‹æ¨™é¡Œå°æ‡‰
const taskTypeTitle = computed(() => {
  const map = {
    'repair-pending': 'å¾…ä¿®ä»»å‹™',
    'maintenance-pending': 'å¾…ä¿é¤Šä»»å‹™',
    'repair-completed': 'ç¶­ä¿®å®Œæˆ',
    'maintenance-completed': 'ä¿é¤Šå®Œæˆ',
  }
  return map[detailCurrentTaskType.value] || 'å·¥å–®åˆ—è¡¨'
})

// ä»»å‹™é¡å‹åœ–ç¤ºå°æ‡‰
const taskTypeIcon = computed(() => {
  const map = {
    'repair-pending': 'fas fa-wrench',
    'maintenance-pending': 'fas fa-clipboard-list',
    'repair-completed': 'fas fa-check-circle',
    'maintenance-completed': 'fas fa-flag-checkered',
  }
  return map[detailCurrentTaskType.value] || 'fas fa-ticket-alt'
})

// è¿”å›äººå“¡è©³æƒ…
const backToProfile = () => {
  detailCurrentView.value = 'profile'
}

// é—œé–‰è©³æƒ…è¦–çª—
const closeDetailDialog = () => {
  detailDialogVisible.value = false
  detailCurrentView.value = 'profile'
  detailCurrentStaff.value = null
  detailCurrentTaskType.value = ''
}

// æ ¼å¼åŒ–ç›®æ¨™æ¨™ç±¤
const getTargetLabel = (t) => {
  if (t.seatsId) {
    const seat = allSeats.value.find((s) => s.seatsId === t.seatsId)
    return seat ? `æ¤…å­: ${seat.seatsName}` : `æ¤…å­ #${t.seatsId}`
  }
  if (t.spotId) {
    const spot = allSpots.value.find((s) => s.spotId === t.spotId)
    return spot ? `æ©Ÿå°: ${spot.spotName}` : `æ©Ÿå° #${t.spotId}`
  }
  return 'æœªæŒ‡å®š'
}

// âœ…ã€ä¿®æ­£#1ã€‘åš´æ ¼åˆ¤å®šä¿é¤Šå–®ï¼šåªèª issueType === 'ä¿é¤Š'
// é¿å…ã€Œæª¢æŸ¥ / ä¾‹è¡Œ / ç›¤é»ã€ä¹‹é¡å­—çœ¼è¢«èª¤åˆ¤æˆä¿é¤Š
const isMaintenanceTicketStrict = (t) => String(t?.issueType || '').trim() === 'ä¿é¤Š'

// âœ…ã€ä¿®æ­£#1ã€‘äººå“¡è©³æƒ…å››å¡ï¼šåœ¨ Dialog å…§ç”¨ã€Œåš´æ ¼åˆ¤å®šã€é‡æ–°ç®—ä¸€æ¬¡
// é€™æ¨£å°±ç®— composable åˆ¤å®šæœ‰å•é¡Œï¼Œè©³æƒ…åœ–å¡ä¹Ÿä¸æœƒé¡¯ç¤ºéŒ¯
const detailStaffStats = computed(() => {
  const staffId = detailCurrentStaff.value?.staffId
  if (!staffId) {
    return { repairCurrent: 0, maintainCurrent: 0, repairDone: 0, maintainDone: 0 }
  }

  const mine = (allTickets.value || []).filter((t) => t?.assignedStaffId === staffId)

  const current = mine.filter((t) => !isCompletedStatus(t?.issueStatus))
  const done = mine.filter((t) => isCompletedStatus(t?.issueStatus))

  const repairCurrent = current.filter((t) => !isMaintenanceTicketStrict(t)).length
  const maintainCurrent = current.filter((t) => isMaintenanceTicketStrict(t)).length
  const repairDone = done.filter((t) => !isMaintenanceTicketStrict(t)).length
  const maintainDone = done.filter((t) => isMaintenanceTicketStrict(t)).length

  return { repairCurrent, maintainCurrent, repairDone, maintainDone }
})

// âœ… ã€ç§»é™¤ã€‘èˆŠçš„ Swal ç¨‹å¼ç¢¼ç‰‡æ®µå·²æ¸…é™¤ï¼Œæ”¹ç”¨ el-dialog (è¦‹ template å€å¡Š)

const handleAddNew = () => {
  Swal.fire({
    title: 'æ–°å¢ç¶­è­·äººå“¡',
    text: 'å³å°‡å‰å¾€æ–°å¢äººå“¡è¡¨å–®',
    icon: 'info',
    timer: 600,
    timerProgressBar: true,
    showConfirmButton: false,
    showClass: { popup: 'animate__animated animate__fadeInRight animate__faster' },
  }).then(() => {
    router.push('/admin/staff-form')
  })
}

// ====== åŸ·è¡Œè½‰ç§»ä¸¦åˆªé™¤ ======
const handleTransferAndDelete = async () => {
  if (!transferForm.value.targetStaffId) {
    await Swal.fire({
      icon: 'warning',
      title: 'è«‹é¸æ“‡æ¥æ‰‹äººå“¡',
      text: 'å¿…é ˆæŒ‡å®šä¸€ä½æ¥æ‰‹äººå“¡ä¾†æ¥æ”¶æœªå®Œæˆçš„å·¥å–®',
      confirmButtonColor: '#409eff',
    })
    return
  }

  transferLoading.value = true
  try {
    await maintenanceApi.transferAndDelete(
      transferForm.value.targetStaffId,
      transferForm.value.deleteStaffId,
    )

    showTransferDialog.value = false
    await fetchStaff()

    const targetStaff = staffList.value.find((s) => s.staffId === transferForm.value.targetStaffId)

    await Swal.fire({
      icon: 'success',
      title: 'è½‰ç§»æˆåŠŸï¼',
      html: `
        <div style="text-align: center;">
          <p>å·¥å–®å·²è½‰ç§»çµ¦ <b style="color: #67c23a;">${targetStaff?.staffName || 'æ¥æ‰‹äººå“¡'}</b></p>
          <p style="color: #909399; font-size: 13px;"><b>${transferForm.value.deleteStaffName}</b> å·²åœç”¨</p>
        </div>
      `,
      timer: 2000,
      timerProgressBar: true,
      showConfirmButton: false,
      showClass: { popup: 'animate__animated animate__bounceIn' },
    })
  } catch {
    // éŒ¯èª¤å·²ç”± http.js æ””æˆªå™¨è™•ç†
  } finally {
    transferLoading.value = false
  }
}

// é—œé–‰ Dialog
const closeTransferDialog = () => {
  showTransferDialog.value = false
  transferForm.value = {
    deleteStaffId: null,
    deleteStaffName: '',
    targetStaffId: null,
  }
}

/** å…ˆéæ¿¾ activeï¼Œå†éæ¿¾ç‹€æ…‹ï¼Œå†åšæœå°‹ */
const filteredList = computed(() => {
  const key = searchText.value.trim().toLowerCase()

  const activeStaff = staffList.value.filter((s) => s.isActive === true)

  // âœ… ã€ä¿®æ­£ã€‘ç‹€æ…‹ç¯©é¸é‚è¼¯ (ä½¿ç”¨çµ±ä¸€çš„ computeStaffStatus)
  const statusFiltered =
    statusFilter.value === 'ALL'
      ? activeStaff
      : activeStaff.filter((s) => getStaffWorkStatus(s.staffId).key === statusFilter.value)

  if (!key) return statusFiltered
  return statusFiltered.filter(
    (s) =>
      (s.staffName || '').toLowerCase().includes(key) ||
      (s.staffCompany || '').toLowerCase().includes(key) ||
      (s.staffPhone || '').includes(key),
  )
})

// ä½¿ç”¨ usePagination composable
const {
  currentPage,
  pageSize,
  paginatedList,
  total: paginationTotal,
  showPagination,
  resetPagination,
} = usePagination(filteredList, { defaultPageSize: 10 })

watch([searchText, statusFilter], () => {
  resetPagination()
  doLayoutSafe()
})

watch([currentPage, pageSize], () => {
  doLayoutSafe()
})

const formatDate = (row, column, cellValue) => {
  if (!cellValue) return '-'
  return new Date(cellValue).toLocaleDateString('zh-TW')
}

// âœ… ã€ä¿®æ­£ã€‘çµ±è¨ˆå¡ç‰‡æ•¸å­— (ä½¿ç”¨çµ±ä¸€çš„ç‹€æ…‹è¨ˆç®—ï¼Œç¢ºä¿èˆ‡åˆ—è¡¨ä¸€è‡´)
const activeCount = computed(() => staffList.value.filter((s) => s.isActive).length)

// ä½¿ç”¨çµ±ä¸€çš„ computeOverallStaffStats è¨ˆç®—æ•´é«”ç‹€æ…‹çµ±è¨ˆ
const overallStats = computed(() => {
  const activeStaff = staffList.value.filter((s) => s.isActive)
  return computeOverallStaffStats(activeStaff, allTickets.value)
})

const maintainingCount = computed(() => overallStats.value.underMaintenance)
const assignedCount = computed(() => overallStats.value.assigned)
const idleCount = computed(() => overallStats.value.idle)

// âœ… è®“æ’ç¨‹é å»ºç«‹å·¥å–®å¾Œï¼Œäººå“¡é èƒ½å³æ™‚åŒæ­¥åœ–å¡
const onTicketsChanged = async () => {
  await fetchTickets()
}

// ============================================================================
// âœ… ã€ä»»å‹™1ä¿®æ­£ã€‘onMounted ä½¿ç”¨ Promise.all ä¸¦è¡Œè¼‰å…¥ï¼Œæå‡æ•ˆèƒ½èˆ‡è³‡æ–™é€£å‹•æ€§
// ============================================================================
onMounted(async () => {
  try {
    // ã€æ•ˆèƒ½å„ªåŒ–ã€‘åŒæ™‚å‘¼å«å››å€‹ APIï¼Œé¿å…åºåˆ—ç­‰å¾…
    const [staffRes, ticketsRes, spotsRes, seatsRes] = await Promise.all([
      maintenanceApi.getAllStaff(),
      maintenanceApi.getAllTickets(),
      maintenanceApi.getAllSpots(),
      maintenanceApi.getAllSeats(),
    ])
    
    // ã€è³‡æ–™é€£å‹•ã€‘åŒæ­¥æ›´æ–° staffListã€allTicketsã€allSpotsã€allSeats
    staffList.value = staffRes.data || []
    allTickets.value = ticketsRes.data || []
    allSpots.value = spotsRes.data || []
    allSeats.value = seatsRes.data || []
    
    loading.value = false
    ticketLoading.value = false
  } catch (err) {
    console.error('è¼‰å…¥äººå“¡æˆ–å·¥å–®è³‡æ–™å¤±æ•—:', err)
    loading.value = false
    ticketLoading.value = false
  }

  // âœ… ç›£è½è·¨é äº‹ä»¶ï¼šæ’ç¨‹å»ºç«‹å·¥å–®å¾Œæœƒè§¸ç™¼
  window.addEventListener('maintenance:tickets-changed', onTicketsChanged)

  setTimeout(() => {
    pageVisible.value = true
    setTimeout(() => doLayoutSafe(), 150)
  }, 100)
})

onBeforeUnmount(() => {
  window.removeEventListener('maintenance:tickets-changed', onTicketsChanged)
})
</script>

<template>
  <div class="staff-list-container">
    <!-- é é¢æ¨™é¡Œå€ -->
    <section class="content-header">
      <div class="container-fluid">
        <transition name="slide-down" appear>
          <div class="page-title-box">
            <div class="title-icon">
              <i class="fas fa-users-cog"></i>
            </div>
            <div class="title-content">
              <h1>ç¶­è­·äººå“¡ç®¡ç†</h1>
              <p class="subtitle">ç®¡ç†ç³»çµ±å…§çš„ç¶­è­·äººå“¡è³‡æ–™</p>
            </div>
            <div class="title-actions">
              <el-button-group>
                <el-button type="success" @click="handleAddNew" class="action-btn add-btn">
                  <i class="fas fa-user-plus mr-2"></i> æ–°å¢äººå“¡
                </el-button>
                <el-button
                  type="info"
                  plain
                  @click="router.push('/admin/staff-history')"
                  class="action-btn"
                >
                  <i class="fas fa-history mr-2"></i> æ­·å²ç´€éŒ„
                </el-button>
              </el-button-group>
            </div>
          </div>
        </transition>
      </div>
    </section>

    <!-- ä¸»å…§å®¹å€ -->
    <section class="content">
      <div class="container-fluid">
        <transition name="zoom-fade" appear>
          <div v-show="pageVisible">
            <!-- çµ±è¨ˆå¡ç‰‡åˆ—ï¼šæ–°å¢ 3 å¼µç‹€æ…‹å¡ -->
            <el-row :gutter="20" class="mb-4">
              <el-col :xs="12" :sm="8" :md="6" :lg="4">
                <div class="stat-card active-card" @click="statusFilter = 'ALL'">
                  <div class="stat-icon pulse-animation">
                    <i class="fas fa-user-check"></i>
                  </div>
                  <div class="stat-info">
                    <h3>{{ activeCount }}</h3>
                    <span>åœ¨è·äººå“¡</span>
                  </div>
                  <div class="stat-bg-icon"><i class="fas fa-users"></i></div>
                </div>
              </el-col>

              <el-col :xs="12" :sm="8" :md="6" :lg="4">
                <div class="stat-card filter-card" @click="statusFilter = 'UNDER_MAINTENANCE'">
                  <div
                    class="stat-icon"
                    style="background: linear-gradient(135deg, #e6a23c 0%, #f3d19e 100%)"
                  >
                    <i class="fas fa-wrench"></i>
                  </div>
                  <div class="stat-info">
                    <h3>{{ maintainingCount }}</h3>
                    <span>ç¶­ä¿®ä¸­</span>
                  </div>
                </div>
              </el-col>

              <el-col :xs="12" :sm="8" :md="6" :lg="4">
                <div class="stat-card filter-card" @click="statusFilter = 'ASSIGNED'">
                  <div
                    class="stat-icon"
                    style="background: linear-gradient(135deg, #409eff 0%, #a0cfff 100%)"
                  >
                    <i class="fas fa-user-check"></i>
                  </div>
                  <div class="stat-info">
                    <h3>{{ assignedCount }}</h3>
                    <span>å·²æŒ‡æ´¾</span>
                  </div>
                </div>
              </el-col>

              <el-col :xs="12" :sm="8" :md="6" :lg="4">
                <div class="stat-card filter-card" @click="statusFilter = 'IDLE'">
                  <div
                    class="stat-icon"
                    style="background: linear-gradient(135deg, #67c23a 0%, #95d475 100%)"
                  >
                    <i class="fas fa-mug-hot"></i>
                  </div>
                  <div class="stat-info">
                    <h3>{{ idleCount }}</h3>
                    <span>é–’ç½®ä¸­</span>
                  </div>
                </div>
              </el-col>

              <el-col :xs="12" :sm="8" :md="6" :lg="4">
                <div class="stat-card filter-card">
                  <div
                    class="stat-icon"
                    style="background: linear-gradient(135deg, #909399 0%, #c0c4cc 100%)"
                  >
                    <i class="fas fa-search"></i>
                  </div>
                  <div class="stat-info">
                    <h3>{{ filteredList.length }}</h3>
                    <span>æœå°‹çµæœ</span>
                  </div>
                </div>
              </el-col>
            </el-row>

            <!-- è³‡æ–™è¡¨æ ¼å¡ç‰‡ -->
            <el-card shadow="hover" class="table-card">
              <template #header>
                <div class="card-header-content">
                  <div class="header-left">
                    <span class="header-icon">
                      <i class="fas fa-list-ul"></i>
                    </span>
                    <span class="header-text">äººå“¡åå–®</span>

                    <!-- ç‹€æ…‹ filter pills -->
                    <div class="ml-2" style="display: flex; gap: 6px; flex-wrap: wrap">
                      <el-tag
                        :effect="statusFilter === 'ALL' ? 'dark' : 'plain'"
                        type="info"
                        round
                        @click="statusFilter = 'ALL'"
                        style="cursor: pointer"
                      >
                        å…¨éƒ¨
                      </el-tag>
                      <el-tag
                        :effect="statusFilter === 'UNDER_MAINTENANCE' ? 'dark' : 'plain'"
                        type="warning"
                        round
                        @click="statusFilter = 'UNDER_MAINTENANCE'"
                        style="cursor: pointer"
                      >
                        ç¶­ä¿®ä¸­
                      </el-tag>

                      <el-tag
                        :effect="statusFilter === 'ASSIGNED' ? 'dark' : 'plain'"
                        type="primary"
                        round
                        @click="statusFilter = 'ASSIGNED'"
                        style="cursor: pointer"
                      >
                        å·²æŒ‡æ´¾
                      </el-tag>

                      <el-tag
                        :effect="statusFilter === 'IDLE' ? 'dark' : 'plain'"
                        type="success"
                        round
                        @click="statusFilter = 'IDLE'"
                        style="cursor: pointer"
                      >
                        é–’ç½®ä¸­
                      </el-tag>
                    </div>

                    <el-tag type="success" effect="light" size="small" class="ml-2" round>
                      <i class="fas fa-circle" style="font-size: 6px; margin-right: 4px"></i>
                      {{ filteredList.length }} ä½
                    </el-tag>
                  </div>

                  <div class="header-right">
                    <el-input
                      v-model="searchText"
                      placeholder="æœå°‹å§“åã€å…¬å¸ã€é›»è©±..."
                      prefix-icon="Search"
                      clearable
                      class="search-input"
                    >
                      <template #append>
                        <el-button
                          icon="Refresh"
                          @click="
                            () => {
                              fetchStaff()
                              fetchTickets()
                            }
                          "
                        />
                      </template>
                    </el-input>
                  </div>
                </div>
              </template>

              <!-- éª¨æ¶å±è¼‰å…¥ -->
              <div v-if="loading" class="loading-skeleton">
                <el-skeleton :rows="6" animated />
              </div>

              <!-- è³‡æ–™è¡¨æ ¼ -->
              <el-table
                ref="tableRef"
                v-else
                :data="paginatedList"
                stripe
                highlight-current-row
                class="custom-table"
                style="width: 100%"
                table-layout="fixed"
                :header-cell-style="{ boxSizing: 'border-box' }"
                :cell-style="{ boxSizing: 'border-box' }"
                @row-dblclick="viewDetail"
              >
                <el-table-column prop="staffId" label="ID" width="70" align="center" sortable>
                  <template #default="{ row }">
                    <el-tag effect="plain" size="small">#{{ row.staffId }}</el-tag>
                  </template>
                </el-table-column>

                <el-table-column prop="staffName" label="å§“å" width="160" sortable>
                  <template #default="{ row }">
                    <div class="name-cell" @click="viewDetail(row)">
                      <div class="name-avatar">
                        {{ row.staffName?.charAt(0) || '?' }}
                      </div>
                      <div class="name-info">
                        <span class="name-text">{{ row.staffName }}</span>
                        <span class="status-dot active"></span>
                      </div>
                    </div>
                  </template>
                </el-table-column>

                <!-- âœ… æ–°å¢æ¬„ä½ï¼šç›®å‰ç‹€æ…‹ -->
                <el-table-column label="ç›®å‰ç‹€æ…‹" width="120" align="center">
                  <template #default="{ row }">
                    <el-tag :type="getStaffWorkStatus(row.staffId).tagType" effect="light" round>
                      <i
                        :class="getStaffWorkStatus(row.staffId).icon"
                        style="margin-right: 6px"
                      ></i>
                      {{ getStaffWorkStatus(row.staffId).text }}
                    </el-tag>
                  </template>
                </el-table-column>

                <el-table-column prop="staffCompany" label="æ‰€å±¬å…¬å¸" min-width="160">
                  <template #default="{ row }">
                    <div v-if="row.staffCompany" class="company-cell">
                      <i class="fas fa-building company-icon"></i>
                      <span>{{ row.staffCompany }}</span>
                    </div>
                    <span v-else class="text-muted">æœªå¡«å¯«</span>
                  </template>
                </el-table-column>

                <el-table-column prop="staffPhone" label="è¯çµ¡é›»è©±" width="150">
                  <template #default="{ row }">
                    <div v-if="row.staffPhone" class="phone-cell">
                      <i class="fas fa-phone phone-icon"></i>
                      <span>{{ row.staffPhone }}</span>
                    </div>
                    <span v-else class="text-muted">-</span>
                  </template>
                </el-table-column>

                <el-table-column prop="staffEmail" label="Email" min-width="200">
                  <template #default="{ row }">
                    <el-tooltip v-if="row.staffEmail" :content="row.staffEmail" placement="top">
                      <div class="email-cell">
                        <i class="fas fa-envelope email-icon"></i>
                        <span>{{ row.staffEmail }}</span>
                      </div>
                    </el-tooltip>
                    <span v-else class="text-muted">-</span>
                  </template>
                </el-table-column>

                <el-table-column
                  prop="staffNote"
                  label="å‚™è¨»"
                  min-width="120"
                  show-overflow-tooltip
                >
                  <template #default="{ row }">
                    <span v-if="row.staffNote" class="note-cell">{{ row.staffNote }}</span>
                    <span v-else class="text-muted">-</span>
                  </template>
                </el-table-column>

                <el-table-column
                  prop="createdAt"
                  label="å»ºç«‹æ—¥æœŸ"
                  width="120"
                  :formatter="formatDate"
                />

                <el-table-column label="æ“ä½œ" width="180" align="center">
                  <template #default="{ row }">
                    <div class="action-buttons">
                      <el-tooltip content="æŸ¥çœ‹è©³æƒ…" placement="top">
                        <el-button
                          type="info"
                          size="small"
                          circle
                          @click="viewDetail(row)"
                          class="action-btn-item"
                        >
                          <i class="fas fa-eye"></i>
                        </el-button>
                      </el-tooltip>
                      <el-tooltip content="ç·¨è¼¯è³‡æ–™" placement="top">
                        <el-button
                          type="primary"
                          size="small"
                          circle
                          @click="router.push(`/admin/staff-form/${row.staffId}`)"
                          class="action-btn-item"
                        >
                          <i class="fas fa-edit"></i>
                        </el-button>
                      </el-tooltip>
                      <el-tooltip content="åœç”¨äººå“¡" placement="top">
                        <el-button
                          type="danger"
                          size="small"
                          circle
                          @click="handleDelete(row)"
                          class="action-btn-item"
                        >
                          <i class="fas fa-user-slash"></i>
                        </el-button>
                      </el-tooltip>
                    </div>
                  </template>
                </el-table-column>

                <template #empty>
                  <el-empty
                    :description="
                      statusFilter === 'ALL' && !searchText
                        ? 'ç›®å‰æ²’æœ‰äººå“¡è³‡æ–™'
                        : 'æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„äººå“¡'
                    "
                  >
                    <template #image>
                      <div class="empty-icon">
                        <i class="fas fa-users-slash"></i>
                      </div>
                    </template>

                    <!-- âœ… åªæœ‰åœ¨ã€Œå…¨éƒ¨ã€ä¸”ã€Œå®Œå…¨æ²’è³‡æ–™ã€æ‰é¡¯ç¤ºæ–°å¢ -->
                    <el-button
                      v-if="statusFilter === 'ALL' && !searchText"
                      type="primary"
                      @click="handleAddNew"
                    >
                      <i class="fas fa-plus mr-1"></i> æ–°å¢ç¬¬ä¸€ä½äººå“¡
                    </el-button>
                  </el-empty>
                </template>
              </el-table>

              <div class="pagination-wrapper" v-if="showPagination">
                <el-pagination
                  v-model:current-page="currentPage"
                  v-model:page-size="pageSize"
                  :page-sizes="[5, 10, 20, 50]"
                  :total="paginationTotal"
                  layout="total, sizes, prev, pager, next, jumper"
                  background
                />
              </div>
            </el-card>

            <div class="tips-bar mt-3">
              <el-alert type="info" :closable="false" show-icon>
                <template #title>
                  <span>ğŸ’¡ å°æç¤ºï¼šé›™æ“Šè¡¨æ ¼åˆ—å¯å¿«é€ŸæŸ¥çœ‹äººå“¡è©³æƒ…ï¼›è©³æƒ…å››å¼µå¡å¯é»é€²å·¥å–®æ­·å²</span>
                </template>
              </el-alert>
            </div>
          </div>
        </transition>
      </div>
    </section>

    <!-- ========== è½‰ç§»å·¥å–®ä¸¦åˆªé™¤ Dialog ========== -->
    <!-- âœ… ä¿®æ­£ï¼šDialog teleported é˜²è£åˆ‡ -->
    <el-dialog
      v-model="showTransferDialog"
      title="è½‰ç§»å·¥å–®ä¸¦åˆªé™¤äººå“¡"
      width="500px"
      :close-on-click-modal="false"
      :close-on-press-escape="!transferLoading"
      @close="closeTransferDialog"
      :teleported="true"
      append-to-body
      :modal-append-to-body="true"
      :align-center="true"
      class="mt-transfer-dialog"
    >
      <div class="transfer-dialog-content">
        <el-alert type="warning" :closable="false" show-icon class="mb-4">
          <template #title>
            <strong>{{ transferForm.deleteStaffName }}</strong> æœ‰æœªå®Œæˆçš„å·¥å–®
          </template>
          <template #default> è«‹é¸æ“‡è¦å°‡å·¥å–®è½‰ç§»çµ¦å“ªä½äººå“¡å¾Œï¼Œæ‰èƒ½åˆªé™¤æ­¤äººå“¡ã€‚ </template>
        </el-alert>

        <el-form label-position="top">
          <el-form-item label="é¸æ“‡æ¥æ‰‹äººå“¡" required>
            <el-select
              v-model="transferForm.targetStaffId"
              placeholder="è«‹é¸æ“‡æ¥æ‰‹äººå“¡"
              filterable
              style="width: 100%"
              :disabled="transferLoading"
            >
              <el-option
                v-for="staff in availableTargetStaff"
                :key="staff.staffId"
                :label="`${staff.staffName} (${staff.specialization || 'æœªè¨­å®šå°ˆé•·'})`"
                :value="staff.staffId"
              >
                <div class="transfer-option">
                  <span class="name">{{ staff.staffName }}</span>
                  <el-tag size="small" type="info">{{
                    staff.specialization || 'æœªè¨­å®šå°ˆé•·'
                  }}</el-tag>
                </div>
              </el-option>
            </el-select>
          </el-form-item>
        </el-form>

        <div class="transfer-preview" v-if="transferForm.targetStaffId">
          <el-divider content-position="left">
            <el-icon><InfoFilled /></el-icon> æ“ä½œé è¦½
          </el-divider>
          <div class="preview-content">
            <p>
              <el-icon color="#E6A23C"><Right /></el-icon>
              <strong>{{ transferForm.deleteStaffName }}</strong> çš„æ‰€æœ‰æœªå®Œæˆå·¥å–® å°‡è½‰ç§»çµ¦
              <strong>{{
                availableTargetStaff.find((s) => s.staffId === transferForm.targetStaffId)
                  ?.staffName
              }}</strong>
            </p>
            <p>
              <el-icon color="#F56C6C"><Delete /></el-icon>
              ç„¶å¾Œåˆªé™¤äººå“¡ <strong>{{ transferForm.deleteStaffName }}</strong>
            </p>
          </div>
        </div>
      </div>

      <template #footer>
        <el-button @click="closeTransferDialog" :disabled="transferLoading"> å–æ¶ˆ </el-button>
        <el-button
          type="danger"
          :loading="transferLoading"
          :disabled="!transferForm.targetStaffId"
          @click="handleTransferAndDelete"
        >
          <el-icon v-if="!transferLoading"><Check /></el-icon>
          ç¢ºèªè½‰ç§»ä¸¦åˆªé™¤
        </el-button>
      </template>
    </el-dialog>

    <!-- ========== âœ… ã€æ–°å¢ã€‘äººå“¡è©³æƒ… Dialog (æ”¯æ´å…§éƒ¨å°è¦½) ========== -->
    <!-- âœ… ä¿®æ­£ï¼šDialog teleported é˜²è£åˆ‡ + ä½ç½®å±…ä¸­ -->
    <el-dialog
      v-model="detailDialogVisible"
      :title="detailCurrentView === 'profile' ? 'äººå“¡è©³æƒ…' : taskTypeTitle"
      width="720px"
      :close-on-click-modal="false"
      @close="closeDetailDialog"
      :teleported="true"
      append-to-body
      :modal-append-to-body="true"
      :align-center="true"
      top="6vh"
      class="mt-staffDetail-dialog"
    >
      <!-- Profile View -->
      <div v-if="detailCurrentView === 'profile' && detailCurrentStaff" class="mt-staffDetail">
        <!-- âœ… UI ä¿®å¾©ï¼šäººå“¡åŸºæœ¬è³‡è¨Šé ­éƒ¨ - æ”¹ç”¨å°ˆç”¨ class é¿å…æ’å -->
        <div class="mt-staffDetail__header">
          <div class="mt-staffDetail__avatar">
            {{ detailCurrentStaff.staffName?.charAt(0) || '?' }}
          </div>
          <div class="mt-staffDetail__info">
            <h3 class="mt-staffDetail__name">{{ detailCurrentStaff.staffName }}</h3>
            <el-tag :type="getStaffWorkStatus(detailCurrentStaff.staffId).tagType" size="small">
              <i :class="getStaffWorkStatus(detailCurrentStaff.staffId).icon" class="mr-1"></i>
              {{ getStaffWorkStatus(detailCurrentStaff.staffId).text }}
            </el-tag>
          </div>
        </div>

        <!-- âœ… UI ä¿®å¾©ï¼šä»»å‹™çµ±è¨ˆå››å¡ - ä½¿ç”¨ el-row/el-col ç¢ºä¿ç©©å®šä½ˆå±€ï¼Œé¿å… class æ’å -->
        <el-row :gutter="12" class="mt-staffDetail__statGrid">
          <el-col :xs="12" :sm="12" :md="12">
            <div class="mt-statCard mt-statCard--repair" @click="handleViewTasks('repair-pending')">
              <div class="mt-statCard__left">
                <div class="mt-statCard__icon mt-statCard__icon--repair">
                  <i class="fas fa-wrench"></i>
                </div>
                <span class="mt-statCard__label">å¾…ä¿®ä»»å‹™</span>
              </div>
              <div class="mt-statCard__value">
                {{ detailStaffStats.repairCurrent }}
              </div>
            </div>
          </el-col>

          <el-col :xs="12" :sm="12" :md="12">
            <div
              class="mt-statCard mt-statCard--maintenance"
              @click="handleViewTasks('maintenance-pending')"
            >
              <div class="mt-statCard__left">
                <div class="mt-statCard__icon mt-statCard__icon--maintenance">
                  <i class="fas fa-clipboard-list"></i>
                </div>
                <span class="mt-statCard__label">å¾…ä¿é¤Š</span>
              </div>
              <div class="mt-statCard__value">
                {{ detailStaffStats.maintainCurrent }}
              </div>
            </div>
          </el-col>

          <el-col :xs="12" :sm="12" :md="12">
            <div
              class="mt-statCard mt-statCard--completed"
              @click="handleViewTasks('repair-completed')"
            >
              <div class="mt-statCard__left">
                <div class="mt-statCard__icon mt-statCard__icon--completed">
                  <i class="fas fa-check-circle"></i>
                </div>
                <span class="mt-statCard__label">ç¶­ä¿®å®Œæˆ</span>
              </div>
              <div class="mt-statCard__value">
                {{ detailStaffStats.repairDone }}
              </div>
            </div>
          </el-col>

          <el-col :xs="12" :sm="12" :md="12">
            <div
              class="mt-statCard mt-statCard--done"
              @click="handleViewTasks('maintenance-completed')"
            >
              <div class="mt-statCard__left">
                <div class="mt-statCard__icon mt-statCard__icon--done">
                  <i class="fas fa-flag-checkered"></i>
                </div>
                <span class="mt-statCard__label">ä¿é¤Šå®Œæˆ</span>
              </div>
              <div class="mt-statCard__value">
                {{ detailStaffStats.maintainDone }}
              </div>
            </div>
          </el-col>
        </el-row>

        <!-- âœ… UI ä¿®å¾©ï¼šäººå“¡è³‡æ–™å€ - å„ªåŒ– descriptions æ¨£å¼ -->
        <div class="mt-staffDetail__infoSection">
          <el-descriptions :column="1" border class="mt-staffDetail__descriptions">
            <el-descriptions-item
              label="æ‰€å±¬å…¬å¸"
              label-align="right"
              label-class-name="mt-desc-label"
            >
              <i class="fas fa-building mr-2" style="color: #409eff"></i>
              {{ detailCurrentStaff.staffCompany || 'æœªå¡«å¯«' }}
            </el-descriptions-item>
            <el-descriptions-item
              label="è¯çµ¡é›»è©±"
              label-align="right"
              label-class-name="mt-desc-label"
            >
              <i class="fas fa-phone mr-2" style="color: #67c23a"></i>
              {{ detailCurrentStaff.staffPhone || '-' }}
            </el-descriptions-item>
            <el-descriptions-item
              label="é›»å­éƒµä»¶"
              label-align="right"
              label-class-name="mt-desc-label"
            >
              <i class="fas fa-envelope mr-2" style="color: #e6a23c"></i>
              {{ detailCurrentStaff.staffEmail || '-' }}
            </el-descriptions-item>
            <el-descriptions-item
              label="å‚™è¨»èªªæ˜"
              label-align="right"
              label-class-name="mt-desc-label"
            >
              {{ detailCurrentStaff.staffNote || 'ç„¡å‚™è¨»' }}
            </el-descriptions-item>
            <el-descriptions-item
              label="å»ºç«‹æ—¥æœŸ"
              label-align="right"
              label-class-name="mt-desc-label"
            >
              {{
                detailCurrentStaff.createdAt
                  ? new Date(detailCurrentStaff.createdAt).toLocaleDateString('zh-TW')
                  : '-'
              }}
            </el-descriptions-item>
          </el-descriptions>
        </div>
      </div>

      <!-- Tasks View -->
      <div v-else-if="detailCurrentView === 'tasks' && detailCurrentStaff" class="mt-taskView">
        <!-- âœ… UI ä¿®å¾©ï¼šè¿”å›æŒ‰éˆ•å€ -->
        <div class="mt-taskView__backBtn">
          <el-button @click="backToProfile" type="primary" plain size="small">
            <i class="fas fa-arrow-left mr-1"></i> è¿”å›äººå“¡è©³æƒ…
          </el-button>
        </div>

        <!-- âœ… UI ä¿®å¾©ï¼šåŠ åˆ†é … - ä»»å‹™åˆ—è¡¨æ¨™é ­ -->
        <div class="mt-taskView__listHeader">
          <div class="mt-taskView__listTitle">
            <i :class="taskTypeIcon" class="mr-2"></i>
            <span>{{ taskTypeTitle }}</span>
          </div>
          <el-tag type="info" size="small" effect="plain">
            å…± {{ detailTaskList.length }} ç­†
          </el-tag>
        </div>

        <!-- ä»»å‹™åˆ—è¡¨ -->
        <div v-if="detailTaskList.length > 0" class="mt-taskView__list">
          <el-table :data="detailTaskList" stripe max-height="400">
            <el-table-column prop="ticketId" label="å·¥å–®" width="80" align="center">
              <template #default="{ row }">
                <el-tag size="small">#{{ row.ticketId }}</el-tag>
              </template>
            </el-table-column>
            <el-table-column label="ç›®æ¨™" width="100">
              <template #default="{ row }">
                {{ getTargetLabel(row) }}
              </template>
            </el-table-column>
            <el-table-column prop="issueDesc" label="æè¿°" min-width="150" show-overflow-tooltip />
            <el-table-column label="ç‹€æ…‹" width="100" align="center">
              <template #default="{ row }">
                <!-- âœ… ä¿®æ­£ï¼šç‹€æ…‹é¡¯ç¤ºä¸­æ–‡ï¼Œä¿ç•™åŸæœ¬çš„ tag æ¨£å¼é‚è¼¯ -->
                <el-tag :type="row.issueStatus === 'RESOLVED' ? 'success' : 'info'" size="small">
                  {{ statusText(row.issueStatus) }}
                </el-tag>
              </template>
            </el-table-column>
            <el-table-column label="æ™‚é–“" width="110">
              <template #default="{ row }">
                {{ row.reportedAt ? new Date(row.reportedAt).toLocaleDateString('zh-TW') : '-' }}
              </template>
            </el-table-column>
          </el-table>
        </div>
        <el-empty v-else description="æš«ç„¡ä»»å‹™è¨˜éŒ„" />
      </div>

      <template #footer v-if="detailCurrentView === 'profile'">
        <el-button @click="closeDetailDialog">é—œé–‰</el-button>
        <el-button
          type="primary"
          @click="router.push(`/admin/staff-form/${detailCurrentStaff?.staffId}`)"
        >
          <i class="fas fa-edit mr-1"></i> ç·¨è¼¯è³‡æ–™
        </el-button>
      </template>
    </el-dialog>
  </div>
</template>

<style scoped>
.staff-list-container {
  min-height: 100vh;
  background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
  padding-bottom: 40px;
}

.content-header {
  padding: 20px 1rem;
}

.page-title-box {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 20px 24px;
  background: white;
  border-radius: 16px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  flex-wrap: wrap;
}

.title-icon {
  width: 64px;
  height: 64px;
  border-radius: 16px;
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  color: white;
  transition: all 0.4s ease;
  box-shadow: 0 4px 15px rgba(64, 158, 255, 0.3);
}

.title-icon:hover {
  transform: scale(1.1) rotate(10deg);
}

.title-content {
  flex: 1;
  min-width: 200px;
}

.title-content h1 {
  margin: 0;
  font-size: 1.7rem;
  font-weight: 700;
  color: #303133;
  background: linear-gradient(135deg, #303133 0%, #606266 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.title-content .subtitle {
  margin: 6px 0 0;
  font-size: 0.9rem;
  color: #909399;
}

.title-actions {
  display: flex;
  gap: 10px;
}

.action-btn {
  border-radius: 10px;
  font-weight: 500;
  transition: all 0.3s ease;
}

.add-btn {
  background: linear-gradient(135deg, #67c23a 0%, #95d475 100%);
  border: none;
  box-shadow: 0 4px 15px rgba(103, 194, 58, 0.3);
}

.add-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(103, 194, 58, 0.4);
}

/* çµ±è¨ˆå¡ç‰‡ */
.stat-card {
  position: relative;
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 20px;
  background: white;
  border-radius: 16px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
  transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  overflow: hidden;
  cursor: pointer;
  margin-bottom: 16px;
}

.stat-card:hover {
  transform: translateY(-6px);
  box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
}

.stat-icon {
  width: 56px;
  height: 56px;
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  color: white;
  z-index: 1;
}

.active-card .stat-icon {
  background: linear-gradient(135deg, #67c23a 0%, #95d475 100%);
}

.filter-card .stat-icon {
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
}

.stat-info {
  z-index: 1;
}

.stat-info h3 {
  margin: 0;
  font-size: 2rem;
  font-weight: 700;
  color: #303133;
}

.stat-info span {
  font-size: 0.85rem;
  color: #909399;
}

.stat-bg-icon {
  position: absolute;
  right: -10px;
  bottom: -10px;
  font-size: 80px;
  color: rgba(0, 0, 0, 0.03);
}

.pulse-animation {
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%,
  100% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.05);
  }
}

/* è¡¨æ ¼å¡ç‰‡ */
.table-card {
  border-radius: 16px;
  overflow: hidden;
  border: none;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
}

.card-header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 12px;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 10px;
}

.header-icon {
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 16px;
}

.header-text {
  font-weight: 600;
  font-size: 1.1rem;
  color: #303133;
}

.search-input {
  width: 300px;
}

.search-input :deep(.el-input__wrapper) {
  border-radius: 10px 0 0 10px;
}

.search-input :deep(.el-input-group__append) {
  border-radius: 0 10px 10px 0;
}

/* è¡¨æ ¼æ¨£å¼ */
.custom-table {
  --el-table-header-bg-color: #f8f9fa;
}

/* é¿å… scrollbar æœ‰æ™‚å‡ºç¾æœ‰æ™‚æ¶ˆå¤±é€ æˆæ¬„å¯¬æŠ–å‹• */
.custom-table :deep(.el-table__body-wrapper) {
  overflow-y: scroll;
}

/* ä¿éšªï¼šè®“ header/body è¨ˆç®—ä¸€è‡´ */
.custom-table :deep(.el-table__header),
.custom-table :deep(.el-table__body),
.custom-table :deep(th),
.custom-table :deep(td) {
  box-sizing: border-box;
}

.name-cell {
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  padding: 4px;
  border-radius: 8px;
  transition: all 0.3s ease;
}

.name-cell:hover {
  background: #f0f9eb;
}

.name-avatar {
  width: 36px;
  height: 36px;
  background: linear-gradient(135deg, #67c23a 0%, #95d475 100%);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 600;
  font-size: 14px;
  flex-shrink: 0;
}

.name-info {
  display: flex;
  align-items: center;
  gap: 6px;
}

.name-text {
  font-weight: 500;
  color: #303133;
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
}

.status-dot.active {
  background: #67c23a;
  box-shadow: 0 0 6px rgba(103, 194, 58, 0.6);
  animation: blink 2s infinite;
}

@keyframes blink {
  0%,
  100% {
    opacity: 1;
  }
  50% {
    opacity: 0.5;
  }
}

.company-cell,
.phone-cell,
.email-cell {
  display: flex;
  align-items: center;
  gap: 8px;
}

.company-icon {
  color: #409eff;
}
.phone-icon {
  color: #67c23a;
}
.email-icon {
  color: #e6a23c;
}

.email-cell {
  max-width: 180px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.note-cell {
  color: #606266;
  font-size: 13px;
}

/* æ“ä½œæŒ‰éˆ• */
.action-buttons {
  display: flex;
  justify-content: center;
  gap: 8px;
}

.action-btn-item {
  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.action-btn-item:hover {
  transform: scale(1.2);
}

/* ç©ºç‹€æ…‹ */
.empty-icon {
  font-size: 64px;
  color: #dcdfe6;
  margin-bottom: 16px;
}

/* åˆ†é å™¨ */
.pagination-wrapper {
  display: flex;
  justify-content: center;
  padding-top: 20px;
  border-top: 1px solid #ebeef5;
  margin-top: 20px;
}

/* æç¤ºæ¬„ */
.tips-bar :deep(.el-alert) {
  border-radius: 12px;
}

/* éæ¸¡å‹•ç•« */
.slide-down-enter-active {
  transition: all 0.5s ease-out;
}
.slide-down-leave-active {
  transition: all 0.3s ease-in;
}
.slide-down-enter-from {
  transform: translateY(-30px);
  opacity: 0;
}
.slide-down-leave-to {
  transform: translateY(-20px);
  opacity: 0;
}

.zoom-fade-enter-active {
  transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.zoom-fade-leave-active {
  transition: all 0.3s ease-in;
}
.zoom-fade-enter-from {
  transform: scale(0.95);
  opacity: 0;
}
.zoom-fade-leave-to {
  transform: scale(0.98);
  opacity: 0;
}

/* è¼”åŠ©é¡ */
.text-muted {
  color: #c0c4cc;
}
.mr-1 {
  margin-right: 4px;
}
.mr-2 {
  margin-right: 8px;
}
.ml-2 {
  margin-left: 8px;
}
.mb-4 {
  margin-bottom: 1.5rem;
}
.mt-3 {
  margin-top: 1rem;
}

/* ========== è½‰ç§»å·¥å–® Dialog æ¨£å¼ ========== */
.transfer-dialog-content {
  padding: 0 10px;
}

.transfer-option {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
}

.transfer-option .name {
  font-weight: 500;
}

.transfer-preview {
  background: linear-gradient(135deg, #f5f7fa 0%, #e8eef3 100%);
  border-radius: 8px;
  padding: 12px 16px;
  margin-top: 10px;
}

.transfer-preview .preview-content {
  font-size: 14px;
}

.transfer-preview .preview-content p {
  display: flex;
  align-items: center;
  gap: 6px;
  margin: 8px 0;
  color: #606266;
}

.transfer-preview .preview-content p strong {
  color: #303133;
}

:deep(.el-dialog__header) {
  border-bottom: 1px solid #ebeef5;
  padding-bottom: 15px;
}

:deep(.el-dialog__footer) {
  border-top: 1px solid #ebeef5;
  padding-top: 15px;
}

/* ========== âœ… ã€æ–°å¢ã€‘äººå“¡è©³æƒ… Dialog æ¨£å¼ ========== */
/* âœ… UI ä¿®å¾©ï¼šä½¿ç”¨ mt- å‰ç¶´é¿å…èˆ‡ AdminLTE å…¨åŸŸ CSS æ’å */

/* è©³æƒ…å®¹å™¨ */
.mt-staffDetail {
  padding: 0;
}

/* äººå“¡é ­éƒ¨è³‡è¨Šå¡ */
.mt-staffDetail__header {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 20px;
  background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
  border-radius: 12px;
  margin-bottom: 20px;
}

.mt-staffDetail__avatar {
  width: 64px;
  height: 64px;
  border-radius: 16px;
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 26px;
  font-weight: 800;
  box-shadow: 0 4px 15px rgba(64, 158, 255, 0.3);
  flex-shrink: 0;
}

.mt-staffDetail__info {
  flex: 1;
}

.mt-staffDetail__name {
  margin: 0 0 10px 0;
  font-size: 20px;
  font-weight: 700;
  color: #303133;
  line-height: 1.2;
}

/* âœ… UI ä¿®å¾©ï¼šçµ±è¨ˆå¡ç‰‡ Grid - ä½¿ç”¨ BEM å‘½åé¿å…æ’å */
.mt-staffDetail__statGrid {
  margin-bottom: 24px;
}

/* å–®å¼µçµ±è¨ˆå¡ */
.mt-statCard {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 18px 20px;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
  border: 1px solid rgba(0, 0, 0, 0.04);
  height: 100%;
  min-height: 88px;
}

.mt-statCard:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
}

.mt-statCard:active {
  transform: translateY(-1px);
}

/* å·¦å´ï¼šicon + æ¨™ç±¤ */
.mt-statCard__left {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.mt-statCard__icon {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  color: white;
  flex-shrink: 0;
}

.mt-statCard__icon--repair {
  background: linear-gradient(135deg, #f6b26b 0%, #f9cf9d 100%);
}

.mt-statCard__icon--maintenance {
  background: linear-gradient(135deg, #6aa8ff 0%, #91bfff 100%);
}

.mt-statCard__icon--completed {
  background: linear-gradient(135deg, #79d7a7 0%, #a3e4c1 100%);
}

.mt-statCard__icon--done {
  background: linear-gradient(135deg, #a0a6ad 0%, #c4c8cd 100%);
}

.mt-statCard__label {
  font-size: 13px;
  color: #606266;
  font-weight: 500;
  line-height: 1.2;
}

/* å³å´ï¼šå¤§æ•¸å­— */
.mt-statCard__value {
  font-size: 32px;
  font-weight: 900;
  color: #303133;
  line-height: 1;
  margin-left: 12px;
}

/* ä¸åŒé¡å‹å¡ç‰‡èƒŒæ™¯è‰² */
.mt-statCard--repair {
  background: linear-gradient(135deg, #fff9f0 0%, #fef6ed 100%);
}

.mt-statCard--maintenance {
  background: linear-gradient(135deg, #f0f7ff 0%, #e6f2ff 100%);
}

.mt-statCard--completed {
  background: linear-gradient(135deg, #f0fdf4 0%, #e6faf0 100%);
}

.mt-statCard--done {
  background: linear-gradient(135deg, #f5f7fa 0%, #eef1f5 100%);
}

/* âœ… UI ä¿®å¾©ï¼šäººå“¡è³‡æ–™å€ - å„ªåŒ– descriptions æ¨£å¼ */
.mt-staffDetail__infoSection {
  margin-top: 0;
}

.mt-staffDetail__descriptions :deep(.el-descriptions__label) {
  width: 100px;
  font-weight: 600;
  color: #606266;
  background-color: #fafafa;
}

.mt-staffDetail__descriptions :deep(.el-descriptions__content) {
  color: #303133;
}

.mt-staffDetail__descriptions :deep(.el-descriptions__cell) {
  padding: 12px 16px;
}

/* âœ… UI ä¿®å¾©ï¼šTasks View æ¨£å¼ */
.mt-taskView {
  padding: 0;
}

.mt-taskView__backBtn {
  margin-bottom: 16px;
}

.mt-taskView__listHeader {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 18px;
  background: linear-gradient(135deg, #f8f9fa 0%, #f0f2f5 100%);
  border-radius: 10px;
  margin-bottom: 16px;
  border: 1px solid #e4e7ed;
}

.mt-taskView__listTitle {
  display: flex;
  align-items: center;
  font-size: 15px;
  font-weight: 600;
  color: #303133;
}

.mt-taskView__list {
  margin-top: 0;
}

/* âœ… UI ä¿®å¾©ï¼šéŸ¿æ‡‰å¼è¨­è¨ˆ - æ‰‹æ©Ÿå–®æ¬„æˆ–å…©æ¬„ */
@media (max-width: 576px) {
  .mt-staffDetail__header {
    flex-direction: column;
    text-align: center;
    padding: 16px;
  }

  .mt-staffDetail__avatar {
    width: 56px;
    height: 56px;
    font-size: 22px;
  }

  .mt-staffDetail__name {
    font-size: 18px;
  }

  .mt-statCard {
    padding: 14px 16px;
    min-height: 80px;
  }

  .mt-statCard__icon {
    width: 36px;
    height: 36px;
    font-size: 16px;
  }

  .mt-statCard__label {
    font-size: 12px;
  }

  .mt-statCard__value {
    font-size: 26px;
  }

  .mt-taskView__listHeader {
    padding: 12px 14px;
  }

  .mt-taskView__listTitle {
    font-size: 14px;
  }
}

/* âœ… ä¿®æ­£ï¼šDialog å…§éƒ¨å¯æ»¾å‹•é˜²è¶…å‡ºè¦–çª—è¢«è£åˆ‡ */
:deep(.mt-staffDetail-dialog .el-dialog__body) {
  max-height: calc(100vh - 220px);
  overflow-y: auto;
  overflow-x: hidden;
}

:deep(.mt-transfer-dialog .el-dialog__body) {
  max-height: calc(100vh - 200px);
  overflow-y: auto;
  overflow-x: hidden;
}

/* ========== èˆŠçš„è©³æƒ…æ¨£å¼ï¼ˆå·²æ£„ç”¨ï¼Œä¿ç•™ä»¥é˜²å›æº¯éœ€è¦ï¼‰========== */
.detail-profile-header {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 16px;
  background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
  border-radius: 12px;
  margin-bottom: 20px;
}

.detail-profile-header .avatar {
  width: 60px;
  height: 60px;
  border-radius: 16px;
  background: linear-gradient(135deg, #409eff 0%, #79bbff 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 24px;
  font-weight: 800;
  box-shadow: 0 4px 15px rgba(64, 158, 255, 0.3);
}

.detail-profile-header .info h3 {
  margin: 0 0 8px 0;
  font-size: 18px;
  font-weight: 700;
  color: #303133;
}

.detail-task-cards {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 20px;
}

.detail-task-cards .task-card {
  padding: 16px;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  border: 1px solid rgba(255, 255, 255, 0.7);
}

.detail-task-cards .task-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.detail-task-cards .task-card.repair-pending {
  background: linear-gradient(135deg, #f6b26b 0%, #f9e0c7 100%);
  color: #1f2d3d;
}

.detail-task-cards .task-card.maintenance-pending {
  background: linear-gradient(135deg, #6aa8ff 0%, #d6e9ff 100%);
  color: #1f2d3d;
}

.detail-task-cards .task-card.repair-completed {
  background: linear-gradient(135deg, #79d7a7 0%, #e4f7ea 100%);
  color: #1f2d3d;
}

.detail-task-cards .task-card.maintenance-completed {
  background: linear-gradient(135deg, #aeb4bb 0%, #eef0f2 100%);
  color: #1f2d3d;
}

.detail-task-cards .task-card .card-header {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  opacity: 0.85;
  margin-bottom: 8px;
}

.detail-task-cards .task-card .card-value {
  font-size: 28px;
  font-weight: 900;
}

.detail-info-section {
  margin-top: 16px;
}

.detail-back-btn {
  margin-bottom: 16px;
}

.detail-task-list {
  margin-top: 12px;
}
</style>
</file>

<file path="frontend/src/router/index.js">
import { createRouter, createWebHistory } from 'vue-router'
import Swal from 'sweetalert2'

/**
 * ==========================================
 * 1. éœæ…‹å°å…¥å…ƒä»¶ (Static Imports)
 * ==========================================
 */
import LoginView from '@/views/member/LoginView.vue' // ç™»å…¥é 
import AdminLayout from '@/layouts/AdminLayout.vue' // å¾Œè‡ºä¸»æ¡†æ¶ (åŒ…å«å´é‚Šæ¬„èˆ‡ Header)
import AdminHomeView from '@/views/member/AdminHomeView.vue' // å¾Œè‡ºé¦–é (å„€è¡¨æ¿)
import MemberListView from '@/views/member/MemberListView.vue' // æœƒå“¡åˆ—è¡¨
import MemberEditView from '@/views/member/MemberEditView.vue' // æœƒå“¡ç·¨è¼¯
import MemberCreateView from '@/views/member/MemberCreateView.vue' // æœƒå“¡æ–°å¢
import PaymentView from '@/views/ecpay/PaymentView.vue' // ç¶ ç•Œä»˜æ¬¾é 
import AdminListView from '@/views/member/AdminListView.vue' // ç®¡ç†å“¡åˆ—è¡¨
import AdminCreateView from '@/views/member/AdminCreateView.vue' // ç®¡ç†å“¡æ–°å¢
import AdminEditView from '@/views/member/AdminEditView.vue' // ç®¡ç†å“¡ç·¨è¼¯
import MemberLayout from '@/layouts/MemberLayout.vue' // æœƒå“¡ä¸»æ¡†æ¶
import MemberProfileView from '@/views/member/MemberProfileView.vue' // æœƒå“¡å€‹äººè³‡æ–™é 
import AuthLayout from '@/layouts/AuthLayout.vue' // èªè­‰ç›¸é—œé é¢æ¡†æ¶
import MainLayout from '@/layouts/MainLayout.vue' // å‰å°ä¸»æ¡†æ¶
import HomeView from '@/views/HomeView.vue' // å‰å°é¦–é 

/**
 * ==========================================
 * 2. æ‡¶åŠ è¼‰å°å…¥ (Dynamic Imports)
 * ==========================================
 */
const MerchantList = () => import('@/views/merchantAndCoupon/MerchantList.vue') // å•†å®¶åˆ—è¡¨
const DiscountList = () => import('@/views/merchantAndCoupon/DiscountList.vue') // å„ªæƒ åˆ¸åˆ—è¡¨
const RedemptionLogList = () => import('@/views/merchantAndCoupon/RedemptionLogList.vue') // æ–°å¢ï¼šå¾Œå°ç´€éŒ„
const CouponMall = () => import('@/views/merchantAndCoupon/CouponMallView.vue') // æ–°å¢ï¼šå‰å°å•†åŸ
const SnakeGame = () => import('@/views/game/SnakeGame.vue') // è²ªé£Ÿè›‡éŠæˆ²

// å®šç¾©è·¯ç”±è¡¨
const routes = [
  // --- ç™»å…¥é é¢ ---
  {
    path: '/login',
    name: 'login',
    component: LoginView,
  },

  // ==========================================
  // [æ–°å¢] å‰å°ä½¿ç”¨è€…é é¢ (ä¸å¥—ç”¨å¾Œå°å´é‚Šæ¬„)
  // ==========================================
  {
    path: '/',
    name: 'entrance',
    component: MainLayout,
    children: [
      {
        path: '',
        name: 'home',
        component: HomeView,
      },

      // æœƒå“¡é é¢
      {
        path: 'profile',
        name: 'member-profile',
        component: MemberProfileView,
      },

      // ç§Ÿå€Ÿé é¢
      {
        path: 'rent/:action?',
        name: 'rec-rent-user',
        component: () => import('@/views/rec/RecRentUserPage.vue'),
      },
      {
        path: 'SearchSpot',
        name: 'SearchSpot',
        component: () => import('@/views/rec/RecRentUserSearchPage.vue'),
      },
      {
        path: 'VisitSiteReommand',
        name: 'VisitSiteReommand',
        component: () => import('@/views/rec/VisitSiteReommandPage.vue'),
      },

      // å°‡ 'rec-rent-record' è·¯ç”±é‡å®šå‘è‡³å¸¶æœ‰ action åƒæ•¸çš„æ¨™æº–ç§Ÿå€Ÿè·¯ç”±
      {
        path: 'recordRoute',
        name: 'rec-rent-record',
        redirect: { name: 'rec-rent-user', params: { action: 'record' } },
      },

      {
        path: 'payment/order',
        name: 'payment-order',
        component: () => import('@/views/ecpay/PaymentViewOrder.vue'),
      },
      {
        path: 'claims',
        name: 'claims',
        component: () => import('@/views/rec/RightsClaimPage.vue'),
      },

      // --- æ–°å¢ï¼šå„ªæƒ åˆ¸å•†åŸ ---
      {
        path: '/mall',
        name: 'coupon-mall',
        component: CouponMall,
      },

      // --- æ–°å¢ï¼šå‰å°è²ªé£Ÿè›‡éŠæˆ² ---
      {
        path: '/snake',
        name: 'snake-game',
        component: SnakeGame,
      },
      {
        path: '/redemption-history',
        name: 'redemption-history',
        component: () => import('@/views/merchantAndCoupon/RedemptionHistory.vue'),
      },
      {
        path: '/sponsor',
        name: 'sponsor',
        component: () => import('@/views/ecpay/SponsorView.vue'),
      },
      {
        path: '/payment-success',
        name: 'payment-success',
        component: () => import('@/views/ecpay/PaymentSuccessView.vue'),
      },

      // è¨‚å–®ç¢ºèªèˆ‡ä»˜æ¬¾é 
      {
        path: '/payment-checkout/:recId',
        name: 'payment-checkout',
        component: () => import('@/views/ecpay/PaymentView.vue'),
      },

      // ==========================================
      // (ç¿Œå¸†2026-1-31)ã€æ–°å¢ã€‘å®¢æœæ”¯æ´æ¨¡çµ„ (Support)
      // ==========================================
      {
        path: '/support',
        name: 'support-center',
        component: () => import('@/views/support/SupportCenterView.vue'),
      },
      {
        path: '/support/report',
        name: 'support-report-entry',
        component: () => import('@/views/support/ReportEntryView.vue'),
      },
      {
        path: '/support/report/damage',
        name: 'support-report-damage',
        component: () => import('@/views/support/ReportDamageView.vue'),
      },
      {
        path: '/support/report/manual',
        name: 'support-report-manual',
        component: () => import('@/views/support/ReportManualView.vue'),
      },
    ],
  },

  // è¨»å†Šæœƒå“¡
  {
    path: '/register',
    component: AuthLayout,
    children: [
      {
        path: '',
        component: () => import('@/views/member/Register.vue'),
      },
    ],
  },

  /**
   * ==========================================
   * 3. ç®¡ç†å¾Œè‡ºåµŒå¥—è·¯ç”± (Nested Routes)
   * ç¶²å€å‰ç¶´çµ±ä¸€ç‚º /admin
   * ==========================================
   */
  {
    path: '/admin',
    component: AdminLayout,
    children: [
      // ç®¡ç†å¾Œè‡ºé¦–é 
      {
        path: '',
        name: 'admin-home',
        component: AdminHomeView,
      },

      // æ“šé»èˆ‡åº§ä½ç®¡ç† (Spot & Seat)
      {
        path: 'spot/list',
        name: 'spot-list',
        component: () => import('@/views/spot/SpotList.vue'),
      },

      // æ“šé»æ–°å¢èˆ‡ç·¨è¼¯å…±ç”¨åŒä¸€å€‹å…ƒä»¶
      {
        path: 'spot/add',
        name: 'spot-add',
        component: () => import('@/views/spot/SpotForm.vue'),
      },

      // æ“šé»ç·¨è¼¯
      {
        path: 'spot/edit/:id',
        name: 'spot-edit',
        component: () => import('@/views/spot/SpotForm.vue'),
      },

      // æ“šé»è©³ç´°è³‡è¨Š
      {
        path: 'spot/view/:id', // ç¶²å€: /admin/spot/view/1
        name: 'spot-view',
        component: () => import('@/views/spot/SpotOne.vue'),
      },
      // æ“šé»çµ±è¨ˆå„€è¡¨æ¿
      {
        path: 'spot/analyze',
        name: 'spot-analyze',
        component: () => import('@/views/spot/SpotAnalyze.vue'),
      },
      {
        path: 'spot/monitor',
        name: 'dispatch-monitor',
        component: () => import('@/views/spot/DispatchMonitor.vue'),
      },
      // ==========================================
      // [æ•´åˆ] åº§ä½ç®¡ç†æ¨¡çµ„ (Seat)
      // ==========================================
      // åº§ä½ç®¡ç†

      {
        path: 'seat/list',
        name: 'seat-list',
        component: () => import('@/views/spot/SeatList.vue'),
      },

      // åº§ä½æ–°å¢èˆ‡ç·¨è¼¯å…±ç”¨åŒä¸€å€‹å…ƒä»¶
      {
        path: 'seat/insert',
        name: 'seat-insert',
        component: () => import('@/views/spot/SeatForm.vue'),
      },

      // åº§ä½ç·¨è¼¯
      {
        path: 'seat/edit/:id',
        name: 'seat-edit',
        component: () => import('@/views/spot/SeatForm.vue'),
      },

      // åº§ä½è©³ç´°è³‡è¨Š
      {
        path: 'seat/view/:id',
        name: 'seat-view',
        component: () => import('@/views/spot/SeatOne.vue'),
      },

      // [æ ¸å¿ƒåŠŸèƒ½] å•†å®¶èˆ‡å„ªæƒ åˆ¸ç®¡ç†
      {
        path: 'merchants',
        name: 'merchants',
        component: MerchantList,
      },

      // å„ªæƒ åˆ¸ç®¡ç†
      {
        path: 'discounts',
        name: 'discounts',
        component: DiscountList,
        alias: 'coupons',
      },
      // --- æ–°å¢ï¼šå…Œæ›ç´€éŒ„å ±è¡¨ ---
      {
        path: 'redemption-logs',
        name: 'admin-redemption-logs',
        component: RedemptionLogList,
      },

      // [æ–°å¢] å¾Œå°è²ªé£Ÿè›‡éŠæˆ²
      {
        path: 'snake-game',
        name: 'admin-snake-game',
        component: SnakeGame,
      },
      {
        path: 'sponsors',
        name: 'admin-sponsors',
        component: () => import('@/views/ecpay/SponsorLog.vue'),
      },

      // [æ ¸å¿ƒåŠŸèƒ½] æœƒå“¡ç®¡ç†
      {
        path: 'members',
        name: 'member-list',
        component: MemberListView,
      },

      // æœƒå“¡ç·¨è¼¯
      {
        path: 'members/edit/:id',
        name: 'member-edit',
        component: MemberEditView,
      },

      // æœƒå“¡æ–°å¢
      {
        path: 'members/create',
        name: 'member-create',
        component: MemberCreateView,
      },

      // [æ ¸å¿ƒåŠŸèƒ½] ç®¡ç†å“¡ç®¡ç†
      {
        path: 'admins',
        name: 'admin-list',
        component: AdminListView,
      },

      // ç®¡ç†å“¡æ–°å¢
      {
        path: 'admins/create',
        name: 'admin-create',
        component: AdminCreateView,
      },

      // ç®¡ç†å“¡ç·¨è¼¯
      {
        path: 'admins/edit/:id',
        name: 'admin-edit',
        component: AdminEditView,
      },

      // [åŠŸèƒ½] ç§Ÿå€Ÿè¨‚å–®ç®¡ç†
      {
        path: 'rec-rent',
        name: 'rec-rent',
        component: () => import('@/views/rec/RecRentMgnPage.vue'),
      },
      {
        path: 'rec-chart',
        name: 'rec-chart',
        component: () => import('@/views/rec/RecRentMgnChartPage.vue'),
      },

      // [åŠŸèƒ½] ç¶­ä¿®ç®¡ç† (Maintenance)
      {
        path: 'staff-list',
        name: 'staff-list',
        component: () => import('@/views/maintenance/MaintenanceStaffList.vue'),
      },

      // ç¶­ä¿®äººå“¡è¡¨å–® (æ–°å¢/ç·¨è¼¯)
      {
        path: 'staff-form/:id?',
        name: 'staff-form',
        component: () => import('@/views/maintenance/MaintenanceStaffForm.vue'),
      },

      // ç¶­ä¿®äººå“¡æ­·å²ç´€éŒ„
      {
        path: 'staff-history',
        name: 'staff-history',
        component: () => import('@/views/maintenance/MaintenanceStaffHistory.vue'),
      },

      // ç¶­ä¿®å·¥å–®åˆ—è¡¨èˆ‡è¡¨å–®
      {
        path: 'mtif-list',
        name: 'mtif-list',
        component: () => import('@/views/maintenance/MtifList.vue'),
        props: { historyMode: false },
      },

      // ç¶­ä¿®å·¥å–®æ­·å²ç´€éŒ„
      {
        path: 'mtif-history',
        name: 'mtif-history',
        component: () => import('@/views/maintenance/MtifList.vue'),
        props: { historyMode: true },
      },

      // ç¶­ä¿®å·¥å–®è¡¨å–® (æ–°å¢/ç·¨è¼¯)
      {
        path: 'mtif-form/:id?',
        name: 'mtif-form',
        component: () => import('@/views/maintenance/MtifForm.vue'),
      },

      // --- Schedule (æ’ç¨‹) ---
      {
        path: 'maintenance/schedule',
        name: 'schedule-list',
        component: () => import('@/views/maintenance/ScheduleList.vue'),
      },

      // æ’ç¨‹è¡¨å–® (æ–°å¢/ç·¨è¼¯)
      {
        path: 'maintenance/schedule/create',
        name: 'schedule-create',
        component: () => import('@/views/maintenance/ScheduleForm.vue'),
      },

      // æ’ç¨‹ç·¨è¼¯
      {
        path: 'maintenance/schedule/edit/:id',
        name: 'schedule-edit',
        component: () => import('@/views/maintenance/ScheduleForm.vue'),
      },
    ],
  },

  // ==========================================
  // 4. è·¯ç”±å®ˆè¡›èˆ‡è½‰å€ (Redirects)
  // ==========================================

  {
    path: '/:pathMatch(.*)*',
    redirect: '/',
  },
]

const router = createRouter({
  history: createWebHistory(import.meta.env.BASE_URL),
  routes,
})

/**
 * ==========================================
 * å…¨åŸŸè·¯ç”±å®ˆè¡›ï¼šå¾Œå°ç™»å…¥é©—è­‰ï¼ˆçµ±ä¸€ localStorageï¼‰
 * ==========================================
 */
router.beforeEach((to, from, next) => {
  // 1. å¦‚æœä¸æ˜¯å»å¾Œå°ï¼Œç›´æ¥æ”¾è¡Œ
  if (!to.path.startsWith('/admin')) {
    next()
    return
  }

  // 2. å–å¾— localStorage è³‡æ–™
  const token = localStorage.getItem('token')
  const adminJson = localStorage.getItem('admin')

  // Debug ç”¨ï¼šå¦‚æœé€²ä¸å»ï¼Œè«‹æŒ‰ F12 çœ‹ Console
  console.log('è·¯ç”±å®ˆè¡›æª¢æŸ¥:', { path: to.path, hasToken: !!token, hasAdmin: !!adminJson })

  // 3. åˆ¤æ–·æ˜¯å¦æœ‰ç®¡ç†å“¡èº«åˆ†
  if (adminJson) {
    // åªè¦æœ‰ admin è³‡æ–™å°±è®“å®ƒé€²å» (Token è¦–å¾Œç«¯æ””æˆªå™¨è€Œå®š)
    next()
  } else {
    // æ²’è³‡æ–™æ‰è·³è­¦å‘Š
    Swal.fire({
      icon: 'warning',
      title: 'è«‹å…ˆç™»å…¥',
      text: 'ç®¡ç†å“¡å¸³è™Ÿå·²éæœŸæˆ–å°šæœªç™»å…¥ã€‚',
      confirmButtonText: 'å»ç™»å…¥',
      allowOutsideClick: false,
    }).then(() => {
      next('/login')
    })
  }
})

export default router
</file>

</files>
