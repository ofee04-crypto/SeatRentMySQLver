import { radioListItem } from 'micromark-extension-misc-radio-list-item';
import { gfmTaskListItem } from 'micromark-extension-gfm-task-list-item';
import { gfmTable } from 'micromark-extension-gfm-table';
import { gfmStrikethrough } from 'micromark-extension-gfm-strikethrough';
import { gfmAutolinkLiteral } from 'micromark-extension-gfm-autolink-literal';
import { radioListItemFromMarkdown } from 'mdast-util-radio-list-item';
import { gfmTaskListItemFromMarkdown } from 'mdast-util-gfm-task-list-item';
import { gfmTableFromMarkdown } from 'mdast-util-gfm-table';
import { gfmStrikethroughFromMarkdown } from 'mdast-util-gfm-strikethrough';
import { gfmAutolinkLiteralFromMarkdown } from 'mdast-util-gfm-autolink-literal';
import { fromMarkdown } from 'mdast-util-from-markdown';
import { cloneDeep } from 'lodash-es';
import { autoFix } from './autofix';
import { addIndicator } from './add-indicator';
const extensions = [
    gfmStrikethrough({ singleTilde: false }),
    gfmTable(),
    gfmTaskListItem(),
    radioListItem(),
    gfmAutolinkLiteral(),
];
const mdastExtensions = [
    gfmStrikethroughFromMarkdown(),
    gfmTableFromMarkdown(),
    gfmTaskListItemFromMarkdown(),
    radioListItemFromMarkdown(),
    gfmAutolinkLiteralFromMarkdown(),
];
// eslint-disable-next-line complexity
export const genAst = ({ oldMarkdown, newMarkdown, lastAstRoot, isShowIndicator, }) => {
    var _a, _b, _c, _d;
    let rawAstRoot;
    const offset = ((_d = (_c = (_a = lastAstRoot === null || lastAstRoot === void 0 ? void 0 : lastAstRoot.children) === null || _a === void 0 ? void 0 : _a[((_b = lastAstRoot === null || lastAstRoot === void 0 ? void 0 : lastAstRoot.children) === null || _b === void 0 ? void 0 : _b.length) - 2]) === null || _c === void 0 ? void 0 : _c.position) === null || _d === void 0 ? void 0 : _d.start.offset) || 0;
    if (oldMarkdown === '' ||
        !(lastAstRoot === null || lastAstRoot === void 0 ? void 0 : lastAstRoot.position) ||
        (lastAstRoot === null || lastAstRoot === void 0 ? void 0 : lastAstRoot.children.length) < 2 ||
        offset < 20 ||
        !newMarkdown.startsWith(oldMarkdown)) {
        // markdown 有变化，重新构建
        // markdown 未构建过Ast，重新构建
        // markdown 上次构建的有问题
        rawAstRoot = fromMarkdown(newMarkdown, {
            extensions,
            mdastExtensions,
        });
    }
    else {
        const leftMarkdown = newMarkdown.slice(offset);
        const leftAstChildren = fromMarkdown(leftMarkdown, {
            extensions,
            mdastExtensions,
        }).children;
        leftAstChildren.map(item => {
            var _a;
            if ((_a = item.position) === null || _a === void 0 ? void 0 : _a.start) {
                item.position.start.offset = item.position.start.offset || 0;
                item.position.start.offset += offset;
                item.position.end.offset = item.position.end.offset || 0;
                item.position.end.offset += offset;
            }
        });
        lastAstRoot.children.splice(-2, 2, ...leftAstChildren);
        rawAstRoot = lastAstRoot;
    }
    // 不需要重新定义了
    const fixedAstRoot = cloneDeep(rawAstRoot);
    autoFix(fixedAstRoot);
    const showAstRoot = cloneDeep(fixedAstRoot);
    if (isShowIndicator) {
        addIndicator(showAstRoot);
    }
    return [rawAstRoot, fixedAstRoot, showAstRoot];
};
//# sourceMappingURL=gen-ast.js.map