var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
import { jsx as _jsx, jsxs as _jsxs } from "react/jsx-runtime";
import { useEffect, useRef, useState } from 'react';
import cls from 'classnames';
import { Text } from '@tarojs/components';
import { AudioPlayEvent, logger, PlayAudio, showToast } from "../../../../../utils";
import { DisableContainer } from "../../../../../ui-kit/atomic/disable-container";
import { AudioPlay, IconButton, Spacing, Spinning } from "../../../../../ui-kit";
import { useAudioSpeech } from "../../../../../services";
import { useUiEventStore } from "../../../../../provider/context/chat-store-context";
import { useChatStatusStore, useI18n } from "../../../../../provider";
import { usePersistCallback } from "../../../../../hooks";
import styles from './index.module.less';
const AudioComp = ({ isPlaying, isLoading, svgTheme }) => {
    if (isLoading) {
        return _jsx(Spinning, { size: "small" });
    }
    return _jsx(AudioPlay, { isPlaying: isPlaying, theme: svgTheme });
};
export const CommandAudio = ({ text, isShowText, svgTheme, isNeedHover, className }) => {
    const [isPlaying, setIsPlaying] = useState(false);
    const [isLoading, setIsLoading] = useState(false);
    const refPlayAudio = useRef(null);
    const { audioSpeech } = useAudioSpeech();
    const refPlaying = useRef(false);
    const i18n = useI18n();
    const targetFrameEvent = useUiEventStore(store => store.event);
    const isAudioRecording = useChatStatusStore(store => store.isAudioRecording);
    refPlaying.current = isPlaying;
    const handleError = usePersistCallback(() => {
        showToast({
            content: i18n.t('playVoiceFail'),
            icon: 'error',
        }, targetFrameEvent);
    });
    useEffect(() => {
        if (!isPlaying) {
            return;
        }
        (() => __awaiter(void 0, void 0, void 0, function* () {
            try {
                setIsLoading(true);
                if (!refPlayAudio.current) {
                    refPlayAudio.current = new PlayAudio();
                }
                refPlayAudio.current.on(AudioPlayEvent.STOP, res => {
                    logger.debug('CommandAudio Stop Audio Play', res);
                    if (res.isError) {
                        handleError();
                    }
                    setIsPlaying(false);
                });
                yield refPlayAudio.current.playText(text, audioSpeech);
            }
            catch (error) {
                //如果失败
                handleError();
                setIsPlaying(false);
            }
            setIsLoading(false);
        }))();
        return () => {
            var _a;
            //暂停播放
            (_a = refPlayAudio.current) === null || _a === void 0 ? void 0 : _a.stop();
            setIsLoading(false);
            setIsPlaying(false);
        };
    }, [isPlaying]);
    if (!text) {
        return null;
    }
    return (_jsx(DisableContainer, Object.assign({ disabled: isAudioRecording, className: cls(styles.container, className) }, { children: _jsxs(Spacing, Object.assign({ className: styles.container, width100: true, onClick: () => {
                setIsPlaying(!isPlaying);
            }, gap: 8 }, { children: [_jsx(IconButton, Object.assign({ size: "small", type: "square-hover-btn", hoverTheme: isNeedHover ? 'hover' : 'none' }, { children: _jsx(AudioComp, { isLoading: isLoading, isPlaying: isPlaying, svgTheme: svgTheme }) })), isShowText ? (_jsx(Text, Object.assign({ className: styles.text, numberOfLines: 1, maxLines: 1, overflow: "ellipsis" }, { children: i18n.t('playVoice') }))) : null] })) })));
};
//# sourceMappingURL=index.js.map