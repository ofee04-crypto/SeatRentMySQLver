import { jsx as _jsx, Fragment as _Fragment, jsxs as _jsxs } from "react/jsx-runtime";
import { useState, useMemo, forwardRef, useImperativeHandle, } from 'react';
import cls from 'classnames';
import { View } from '@tarojs/components';
import { isWeb, logger, nanoid } from "../../utils";
import { Spacing } from '../atomic/spacing';
import { DisableContainer } from '../atomic/disable-container';
import { UploadBtn } from './upload-btn';
import { InputType } from './type';
import { Textarea } from './textarea';
import { TaskMessage } from './task-message/indext';
import { SendSwitchBtn } from './send-switch-btn';
import { useTextInputHandle } from './hooks/use-text-input-handle';
import { useMultiModeMessageHandle } from './hooks/use-multi-mode-message-handle';
import { useKeyboardHeightHandle } from './hooks/use-keyborader-height-handle';
import { useAudioMessageHandle } from './hooks/use-audio-message-handle';
import { AudioInput } from './audio-input';
import styles from './index.module.less';
let inputNo = 1000;
export const ChatInput = forwardRef((props, ref) => {
    const { isNeedUpload, disabled = false, inputAdjustDefault = true, onSendFileMessage, onSendAudioMessage, isNeedAudio = false, placeholder = 'Send Message', frameEventTarget, isPcMode, defaultInputType = InputType.Text, } = props;
    const inputId = useMemo(() => `chat-input-${nanoid()}-${inputNo++}`, []);
    const [inputType, setInputType] = useState(defaultInputType);
    const { onRecording, isRecording, isRealAudioInputFocusing } = useAudioMessageHandle(props, {
        inputType,
    });
    const { taskMessage, isShowMultiModeMessage } = useMultiModeMessageHandle(props, {
        inputType,
        setInputType,
        isRecording,
    });
    const { inputValue, setInputValue, focused, setFocused, toSendInputValue, onSendTextMessage, } = useTextInputHandle(props, { inputId, taskMessage });
    const { onKeyBoardHeightChange } = useKeyboardHeightHandle(props);
    useImperativeHandle(ref, () => ({
        setInputValue,
    }), []);
    logger.debug('ChatInput focused', {
        focused,
        inputType,
    });
    return (_jsx(DisableContainer, Object.assign({ className: styles.container }, { children: _jsxs(View, Object.assign({ className: cls(styles['chat-input-container'], {
                [styles.focused]: focused || isRealAudioInputFocusing,
                [styles['audio-recording']]: isRecording,
                [styles['multi-mode-message']]: isShowMultiModeMessage,
            }) }, { children: [isShowMultiModeMessage ? (_jsx(_Fragment, { children: _jsx(TaskMessage, { taskMessage: taskMessage }) })) : null, _jsxs(Spacing, Object.assign({ className: styles['chat-input-content'] }, { children: [inputType === InputType.Voice ? (_jsx(AudioInput, { onSendAudioMessage: onSendAudioMessage, type: isPcMode ? 'primary' : 'default', frameEventTarget: frameEventTarget, isPcMode: isPcMode, disabled: disabled, focused: focused || isRealAudioInputFocusing, onAudioRecording: onRecording })) : (_jsx(Textarea, { id: inputId, focus: focused, placeholder: placeholder, adjustPosition: inputAdjustDefault, value: inputValue, onSendTextMessage: onSendTextMessage, onInputChange: value => {
                                setInputValue(value);
                            }, onFocus: event => {
                                onKeyBoardHeightChange === null || onKeyBoardHeightChange === void 0 ? void 0 : onKeyBoardHeightChange(event.detail.height);
                                setFocused(true);
                            }, onBlur: () => {
                                onKeyBoardHeightChange === null || onKeyBoardHeightChange === void 0 ? void 0 : onKeyBoardHeightChange(0);
                                logger.debug('ChatInput onBlur');
                                setFocused(false);
                            } })), _jsxs(Spacing, Object.assign({ verticalCenter: true, horizontalCenter: true, className: styles['op-container'] }, { children: [isNeedUpload ? (_jsxs(_Fragment, { children: [_jsx(UploadBtn, { onSendFileMessage: onSendFileMessage, frameEventTarget: frameEventTarget, disabled: disabled }), _jsx(View, { className: styles.divider })] })) : null, _jsx(SendSwitchBtn, { inputDisabled: disabled, hasTextToSend: !!toSendInputValue, inputType: inputType, isNeedAudio: isNeedAudio, focused: focused, onSendBtnClick: () => {
                                        onSendTextMessage();
                                    }, onKeyboardClick: () => {
                                        setFocused(false);
                                        setInputType(InputType.Text);
                                        // 需要延迟才能 触发 focus效果
                                        setTimeout(() => {
                                            var _a, _b;
                                            setFocused(true);
                                            if (isWeb) {
                                                // web下无法获取焦点，需要手动添加焦点
                                                (_b = (_a = document
                                                    .getElementById(inputId)) === null || _a === void 0 ? void 0 : _a.querySelector('textarea')) === null || _b === void 0 ? void 0 : _b.focus();
                                            }
                                        }, 100);
                                    }, onMicrophoneClick: () => {
                                        setInputType(InputType.Voice);
                                        setFocused(false);
                                    } })] }))] }))] })) })));
});
//# sourceMappingURL=index.js.map