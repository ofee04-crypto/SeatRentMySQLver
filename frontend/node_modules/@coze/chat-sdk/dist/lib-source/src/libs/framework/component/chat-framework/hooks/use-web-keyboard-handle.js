import { useEffect, useRef } from 'react';
import { isWeb, logger } from "../../../../utils";
import { UIEventType } from "../../../../types";
import { useChatPropsStore, useUiEventStore, } from "../../../../provider/context/chat-store-context";
export const useWebKeyboardHandle = (chatFrameId) => {
    const frameTarget = useUiEventStore(store => store.event);
    const isFrameAutoFocus = useChatPropsStore(store => { var _a, _b, _c; return (_c = (_b = (_a = store.ui) === null || _a === void 0 ? void 0 : _a.chatSlot) === null || _b === void 0 ? void 0 : _b.base) === null || _c === void 0 ? void 0 : _c.isFrameAutoFocus; });
    const refIsFrameAutoFocus = useRef(true);
    refIsFrameAutoFocus.current = isFrameAutoFocus !== null && isFrameAutoFocus !== void 0 ? isFrameAutoFocus : true;
    useEffect(() => {
        if (isWeb && chatFrameId) {
            const el = document.getElementById(chatFrameId);
            let isFocused = false;
            if (el) {
                const onKeyDown = (e) => {
                    logger.debug('Frame Target keydown');
                    frameTarget.trigger(UIEventType.KeyDown, {
                        chatFrameId,
                        code: e.code,
                    });
                };
                const onKeyUp = (e) => {
                    logger.debug('Frame Target keyup', e);
                    frameTarget.trigger(UIEventType.KeyUp, {
                        chatFrameId,
                        code: e.code,
                    });
                };
                const onFocus = () => {
                    logger.debug('Frame Target focus');
                    isFocused = true;
                    frameTarget.trigger(UIEventType.FrameFocus, {
                        chatFrameId,
                    });
                };
                const onBlur = () => {
                    logger.debug('Frame Target  blur');
                    isFocused = false;
                    frameTarget.trigger(UIEventType.FrameBlur, {
                        chatFrameId,
                    });
                };
                const triggerFocus = () => {
                    if (refIsFrameAutoFocus.current === false) {
                        return;
                    }
                    el.focus();
                    // 已经focus了，不会再次出发，因此需要手动触发focus事件
                    if (isFocused) {
                        onFocus === null || onFocus === void 0 ? void 0 : onFocus();
                    }
                };
                el.addEventListener('keydown', onKeyDown);
                el.addEventListener('keyup', onKeyUp);
                el.addEventListener('focus', onFocus);
                el.addEventListener('blur', onBlur);
                frameTarget.on(UIEventType.TriggerFocus, triggerFocus);
                el.setAttribute('tabindex', '-1');
                if (refIsFrameAutoFocus.current !== false) {
                    setTimeout(() => {
                        el.focus();
                    }, 1000);
                }
                return () => {
                    el.removeEventListener('keydown', onKeyDown);
                    el.removeEventListener('keyup', onKeyUp);
                    el.removeEventListener('focus', onFocus);
                    el.removeEventListener('blur', onBlur);
                    frameTarget.off(UIEventType.TriggerFocus, triggerFocus);
                };
            }
        }
    }, [chatFrameId]);
};
//# sourceMappingURL=use-web-keyboard-handle.js.map