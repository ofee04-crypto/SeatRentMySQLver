import { useEffect, useMemo, useRef, useState } from 'react';
import Taro from '@tarojs/taro';
import { isSafari, logger } from "../../../utils";
import { usePersistCallback } from "../../../hooks";
// 底部在流式输出的时候，如果此时滚动到了上边视图中，在safari会有bug，页面会不断网上顶上去，需做hack，仅safari发现该问题
export const useSafariAnchorHack = ({ refAnchorBottom, refScrollEl, }) => {
    const isNeedHack = useMemo(() => {
        const { platform } = Taro.getSystemInfoSync();
        return isSafari && !['ios', 'android'].includes(platform.toLowerCase());
    }, []);
    const [viewEl, setViewEl] = useState();
    const refScrollRecord = useRef([]);
    logger.info('useSafariAnchorHack isNeedHack: ', isNeedHack);
    const onInitViewEl = usePersistCallback((el) => {
        setViewEl(el);
    });
    const getLastElementInfo = usePersistCallback(() => {
        var _a;
        const query = viewEl === null || viewEl === void 0 ? void 0 : viewEl.getElementsByClassName('chat-group-for-query');
        if (!query || query.length === 0) {
            return;
        }
        const lastElement = query[query.length - 1];
        const lastElementInfo = {
            groupId: lastElement.getAttribute('data-group-id'),
            height: lastElement.offsetHeight || 0,
            scrollTop: ((_a = refScrollEl === null || refScrollEl === void 0 ? void 0 : refScrollEl.current) === null || _a === void 0 ? void 0 : _a.scrollTop) || 0,
        };
        if (!(lastElementInfo === null || lastElementInfo === void 0 ? void 0 : lastElementInfo.groupId) || !(lastElementInfo === null || lastElementInfo === void 0 ? void 0 : lastElementInfo.height)) {
            return;
        }
        return lastElementInfo;
    });
    const onCollectScrollInfo = usePersistCallback(() => {
        if (!isNeedHack) {
            return;
        }
        if (!(refAnchorBottom === null || refAnchorBottom === void 0 ? void 0 : refAnchorBottom.current)) {
            return;
        }
        const lastElementInfo = getLastElementInfo();
        if (!lastElementInfo) {
            return;
        }
        const leftData = refScrollRecord.current.filter(item => item.groupId !== lastElementInfo.groupId);
        leftData.unshift(lastElementInfo);
        leftData.splice(5);
        refScrollRecord.current = leftData;
    });
    useEffect(() => {
        if (!isNeedHack) {
            return;
        }
        try {
            if (viewEl) {
                let height = viewEl.offsetHeight;
                const observer = new ResizeObserver(function () {
                    var _a, _b;
                    const oldHeight = height;
                    const newHeight = viewEl.offsetHeight;
                    height = newHeight;
                    if (!(refAnchorBottom === null || refAnchorBottom === void 0 ? void 0 : refAnchorBottom.current)) {
                        return;
                    }
                    if (newHeight !== oldHeight) {
                        if (((_a = refScrollEl === null || refScrollEl === void 0 ? void 0 : refScrollEl.current) === null || _a === void 0 ? void 0 : _a.scrollTop) !== 0) {
                            const newElementInfo = getLastElementInfo();
                            const oldElementInfo = refScrollRecord.current.find(item => item.groupId === (newElementInfo === null || newElementInfo === void 0 ? void 0 : newElementInfo.groupId));
                            if (!oldElementInfo) {
                                return;
                            }
                            const diff = Math.abs(Math.abs(newElementInfo.height - oldElementInfo.height) -
                                Math.abs(newElementInfo.scrollTop - oldElementInfo.scrollTop));
                            if (diff < 5) {
                                return;
                            }
                            (_b = refScrollEl === null || refScrollEl === void 0 ? void 0 : refScrollEl.current) === null || _b === void 0 ? void 0 : _b.scrollBy(0, oldHeight - newHeight);
                        }
                    }
                });
                observer.observe(viewEl);
                return () => {
                    observer.disconnect();
                };
            }
        }
        catch (err) {
            logger.error('useSafariAnchorHack useEffect err: ', err);
        }
    }, [viewEl]);
    return {
        onInitViewEl,
        onCollectScrollInfo,
    };
};
//# sourceMappingURL=use-safari-anchor-hack.js.map