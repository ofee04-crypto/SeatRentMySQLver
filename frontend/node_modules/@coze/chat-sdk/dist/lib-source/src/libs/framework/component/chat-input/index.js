import { jsx as _jsx, jsxs as _jsxs } from "react/jsx-runtime";
import { Fragment, useEffect, useMemo, useRef } from 'react';
import cls from 'classnames';
import { View } from '@tarojs/components';
import { logger, nanoid } from "../../../utils";
import { ChatInput as ChatInputUi, Spacing, } from "../../../ui-kit";
import { useSendMessage } from "../../../services";
import { useChatInputStore, useUiEventStore, } from "../../../provider/context/chat-store-context";
import { useChatPropsStore, useChatStatusStore, useDefaultInputMode, useI18n, useIsMobile, useIsNeedAudioInput, } from "../../../provider";
import { usePersistCallback } from "../../../hooks";
import { useInputAdjust } from './hooks/use-input-adjust';
import { useCommandSlot } from './hooks/use-command-slot';
import styles from './index.module.less';
let chatInputNo = 1;
export const ChatInput = () => {
    var _a, _b;
    const i18n = useI18n();
    const ref = useRef(null);
    const { sendTextMessage, sendFileMessage, sendAudioMessage } = useSendMessage();
    const { input: inputDisableState } = useChatStatusStore(store => store.disableState);
    const uiConfig = useChatPropsStore(store => store.ui);
    const setIsAudioRecording = useChatStatusStore(state => state.setIsAudioRecording);
    const isAudioRecording = useChatStatusStore(store => store.isAudioRecording);
    const taskList = useChatInputStore(store => store.taskList);
    const isNeedAudio = useIsNeedAudioInput();
    const inputType = useDefaultInputMode();
    const inputUiConfig = (_a = uiConfig === null || uiConfig === void 0 ? void 0 : uiConfig.chatSlot) === null || _a === void 0 ? void 0 : _a.input;
    const uploadConfig = (_b = uiConfig === null || uiConfig === void 0 ? void 0 : uiConfig.chatSlot) === null || _b === void 0 ? void 0 : _b.uploadBtn;
    const renderChatInputTopSlot = inputUiConfig === null || inputUiConfig === void 0 ? void 0 : inputUiConfig.renderChatInputTopSlot;
    const inputId = useMemo(() => `chatInput_${nanoid()}_${chatInputNo++}`, []);
    const { changeInputLocation, bottomOffset, inputAdjustDefault } = useInputAdjust(inputId);
    const targetFrameEvent = useUiEventStore(store => store.event);
    const commandSlots = useCommandSlot('inputLeft');
    const isMobile = useIsMobile();
    const onAudioRecording = usePersistCallback((isAudioRecordingNew) => {
        setIsAudioRecording(isAudioRecordingNew);
    });
    const initSetInputValueFunc = useChatInputStore(state => state.initSetInputValueFunc);
    useEffect(() => {
        initSetInputValueFunc((val) => {
            var _a;
            (_a = ref.current) === null || _a === void 0 ? void 0 : _a.setInputValue(val);
        });
    }, []);
    logger.info('ChatInput input info', {
        isNeedAudio,
        inputType,
    });
    logger.debug('ChatInput configInfo:', inputUiConfig, taskList);
    if ((inputUiConfig === null || inputUiConfig === void 0 ? void 0 : inputUiConfig.isNeed) === false) {
        return null;
    }
    return (_jsxs(View, Object.assign({ className: cls(styles.container, {
            [styles['recording-audio']]: isAudioRecording,
        }), id: inputId, style: {
            bottom: `${bottomOffset}px`,
        }, onTouchStart: event => {
            event.stopPropagation();
        } }, { children: [_jsx(View, Object.assign({ className: styles['slot-container'] }, { children: renderChatInputTopSlot === null || renderChatInputTopSlot === void 0 ? void 0 : renderChatInputTopSlot() })), _jsxs(Spacing, Object.assign({ gap: 0, verticalCenter: true, width100: true, style: { overflow: 'visible', paddingTop: 10 } }, { children: [commandSlots.length ? (_jsx(Spacing, Object.assign({ gap: 12, verticalCenter: true, style: {
                            overflow: 'visible',
                            width: isAudioRecording ? 0 : commandSlots.length * 46,
                        }, className: styles['command-container'] }, { children: commandSlots.map((item, index) => (_jsx(Fragment, { children: item }, index))) }))) : null, _jsx(View, Object.assign({ className: styles['input-container'], style: {
                            maxWidth: isAudioRecording
                                ? '100%'
                                : `calc(100% - ${commandSlots.length * 46}px)`,
                        } }, { children: _jsx(ChatInputUi, { ref: ref, isNeedUpload: (uploadConfig === null || uploadConfig === void 0 ? void 0 : uploadConfig.isNeed) !== false, isNeedTaskMessage: inputUiConfig === null || inputUiConfig === void 0 ? void 0 : inputUiConfig.isNeedTaskMessage, disabled: inputDisableState, defaultValue: inputUiConfig === null || inputUiConfig === void 0 ? void 0 : inputUiConfig.defaultText, defaultInputType: inputType, taskList: taskList, isNeedAudio: isNeedAudio || false, placeholder: (inputUiConfig === null || inputUiConfig === void 0 ? void 0 : inputUiConfig.placeholder) || i18n.t('chatInputPlaceholder'), onSendTextMessage: sendTextMessage, onSendFileMessage: sendFileMessage, onSendAudioMessage: sendAudioMessage, onKeyBoardHeightChange: changeInputLocation, inputAdjustDefault: inputAdjustDefault, frameEventTarget: targetFrameEvent, isPcMode: !isMobile, onAudioRecording: onAudioRecording }) }))] }))] })));
};
//# sourceMappingURL=index.js.map