import { jsx as _jsx } from "react/jsx-runtime";
import { memo, useMemo, useRef, } from 'react';
import { Logger } from "../../../utils";
import { Language, } from "../../../types";
import { I18n } from "../../../i18n";
import { Root } from './render/root';
import { useTaskChangeHandle } from './hooks/use-task-change';
import { useSmoothShowMarkdown } from './hooks/use-smooth-show-markdown';
import { useSmoothAstChange } from './hooks/use-smooth-ast-change';
import { useRenderChange } from './hooks/use-render-change';
import { genAst } from './helper/gen-ast';
import { ChatFamePropsProvider } from './context';
const MarkdownRender = ({ markdown, onAstChange, isShowIndicator = false, theme, className, style, }) => {
    const refRaw = useRef('');
    const refAst = useRef();
    const renderAst = useMemo(() => {
        const [rawAstRoot, fixedAstRoot, showAstRoot] = genAst({
            oldMarkdown: refRaw.current,
            newMarkdown: markdown,
            lastAstRoot: refAst.current,
            isShowIndicator,
        });
        refAst.current = rawAstRoot;
        refRaw.current = markdown;
        onAstChange === null || onAstChange === void 0 ? void 0 : onAstChange(fixedAstRoot);
        return showAstRoot;
    }, [markdown, isShowIndicator, onAstChange]);
    return (_jsx(Root, { className: className, style: style, root: renderAst, theme: theme }));
};
const MdStreamOp = ({ theme = 'light', markdown, isSmooth, isFinish, interval = 50, onMarkdownEnd, onRenderMarkdownChange, onImageClick, onTaskChange, language, debug, selectable = true, className, style, imgClassName, imgStyle, taskDisabled, enableHtmlTags = false, enableCodeBy4Space = false, eventCallbacks, }) => {
    const { showMarkdown, isShowIndicator, showMoreByte } = useSmoothShowMarkdown({
        isSmooth,
        interval,
        markdown,
        isFinish,
    });
    const i18n = useMemo(() => new I18n(language || Language.ZH_CN), []);
    const logger = useMemo(() => {
        const loggerNew = new Logger();
        debug && loggerNew.seDebug();
        return loggerNew;
    }, []);
    useRenderChange({
        showMarkdown,
        markdown,
        isFinish,
        onMarkdownEnd,
        onRenderMarkdownChange,
    });
    const { onAstChange } = useSmoothAstChange({
        isSmooth,
        markdown,
        showMoreByte,
        showMarkdownIndex: showMarkdown.length,
        enableHtmlTags,
    });
    const { onTaskChangeHandle } = useTaskChangeHandle({ onTaskChange, logger });
    return (_jsx(ChatFamePropsProvider, Object.assign({ markdown: markdown, onTaskChangeHandle: onTaskChangeHandle, onImageClick: onImageClick, i18n: i18n, eventCallbacks: eventCallbacks, logger: logger, selectable: selectable, taskDisabled: !isFinish || taskDisabled, enableHtmlTags: enableHtmlTags, enableCodeBy4Space: enableCodeBy4Space, imgClassName: imgClassName, imgStyle: imgStyle }, { children: _jsx(MarkdownRender, { theme: theme, markdown: showMarkdown, isShowIndicator: isShowIndicator, onAstChange: onAstChange, className: className, style: style }) })));
};
export const MdStream = memo(MdStreamOp, (prev, next) => {
    if (Object.keys(prev).length !== Object.keys(next).length) {
        return false;
    }
    else {
        return !Object.keys(prev).find(key => {
            if (prev[key] !== next[key]) {
                return true;
            }
            return false;
        });
    }
});
//# sourceMappingURL=index.js.map