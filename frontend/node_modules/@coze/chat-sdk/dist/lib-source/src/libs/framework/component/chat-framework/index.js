var __rest = (this && this.__rest) || function (s, e) {
    var t = {};
    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
        t[p] = s[p];
    if (s != null && typeof Object.getOwnPropertySymbols === "function")
        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {
            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))
                t[p[i]] = s[p[i]];
        }
    return t;
};
import { jsx as _jsx, Fragment as _Fragment, jsxs as _jsxs } from "react/jsx-runtime";
import cls from 'classnames';
import { View } from '@tarojs/components';
import { logger, nanoid } from "../../../utils";
import { Spacing } from "../../../ui-kit";
import { UIEventType } from "../../../types";
import { useChatInit } from "../../../services";
import { ChatFrameProvider, useChatInfoStore, useChatPropsStore, useInitBgInfo, useIsMobile, useThemeType, } from "../../../provider";
import { useWebKeyboardHandle } from './hooks/use-web-keyboard-handle';
import { ChatToast } from '../chat-toast';
import { ChatSlot } from '../chat-slot';
import { ChatModal } from '../chat-modal';
import { ChatLoading } from '../chat-loading';
import { ChatHeader } from '../chat-header';
import { ChatFooter } from '../chat-footer';
import { ChatBackground } from '../chat-background';
import '../../../ui-kit/token/index.css';
import styles from './index.module.less';
import { ChatError } from '../chat-error';
import { useEffect, useMemo } from 'react';
import { eventCenter } from '@tarojs/taro';
const ChatFrameInit = ({ children }) => {
    const { isLoading, error } = useChatInfoStore(store => ({
        isLoading: store.isLoading,
        error: store.error,
    }));
    logger.info('in chat frame init', { isLoading, error });
    const { retryChatInit } = useChatInit();
    if (error) {
        return _jsx(ChatError, { retryChatInit: retryChatInit });
    }
    if (isLoading) {
        return _jsx(ChatLoading, {});
    }
    return _jsx(_Fragment, { children: children });
};
let frameId = 1000;
export const ChatContent = ({ children }) => {
    const bgInfo = useInitBgInfo();
    const chatFrameId = useMemo(() => `chat_frame_${nanoid()}_${frameId++}`, []);
    const isMobile = useIsMobile();
    const themeType = useThemeType();
    const onThemeChange = useChatPropsStore(store => { var _a; return (_a = store.eventCallbacks) === null || _a === void 0 ? void 0 : _a.onThemeChange; });
    const frameworkClassName = useChatPropsStore(store => { var _a; return (_a = store.ui) === null || _a === void 0 ? void 0 : _a.frameworkClassName; });
    const isBgTheme = themeType === 'bg-theme';
    useWebKeyboardHandle(chatFrameId);
    useEffect(() => {
        onThemeChange === null || onThemeChange === void 0 ? void 0 : onThemeChange(themeType);
    }, [themeType]);
    return (_jsxs(Spacing, Object.assign({ vertical: true, className: cls(styles.container, 'light-theme chat-root', {
            'bg-theme': isBgTheme,
            'bg-mobile': isMobile,
        }, frameworkClassName), onClick: () => {
            eventCenter.trigger(UIEventType.FrameClick);
        }, id: chatFrameId }, { children: [isBgTheme ? _jsx(ChatBackground, Object.assign({}, bgInfo)) : null, _jsx(ChatHeader, {}), _jsx(View, Object.assign({ className: styles.chat }, { children: _jsx(ChatFrameInit, { children: children || _jsx(ChatSlot, {}) }) })), _jsx(ChatFooter, {}), _jsx(ChatToast, {}), _jsx(ChatModal, {})] })));
};
export const ChatFramework = (_a) => {
    var { children } = _a, props = __rest(_a, ["children"]);
    logger.info('SdkVersion: 0.1.10-beta.1');
    return (_jsx(ChatFrameProvider, Object.assign({}, props, { children: _jsx(ChatContent, { children: children }) })));
};
//# sourceMappingURL=index.js.map